<!DOCTYPE html>
<html lang="ru" class="dark">
<script>try{var t=localStorage.getItem('pp_theme');if(t)document.documentElement.className=t;}catch(e){}</script>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Management System — Double Diamond</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--bg2:#12121a;--bg3:#1a1a2e;--bg4:#252540;--border:#2a2a45;--text:#e0e0f0;--text2:#8888aa;--accent:#6366f1;--accent2:#818cf8;--green:#22c55e;--yellow:#eab308;--red:#ef4444;--sky:#0ea5e9;--violet:#8b5cf6;--amber:#f59e0b;--emerald:#10b981}
html.light{--bg:#f5f5f8;--bg2:#eeeef2;--bg3:#e4e4ea;--bg4:#d8d8e0;--border:#c8c8d4;--text:#1a1a2e;--text2:#5a5a7a;--accent:#4f46e5;--accent2:#6366f1}
html.light .sidebar{background:#1e1e32;color:#e0e0f0}
html.light .sidebar .nav-item{color:#b0b0cc}
html.light .sidebar .nav-item:hover{background:rgba(255,255,255,.08);color:#e0e0f0}
html.light .sidebar .nav-item.active{background:rgba(99,102,241,.2);color:#818cf8;border-left-color:#818cf8}
.theme-toggle{display:flex;align-items:center;gap:10px;padding:8px 0}
.theme-switch{position:relative;width:44px;height:24px;cursor:pointer}
.theme-switch input{display:none}
.theme-slider{position:absolute;inset:0;background:var(--bg4);border-radius:12px;transition:.2s}
.theme-slider:before{content:'';position:absolute;width:18px;height:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s}
.theme-switch input:checked+.theme-slider{background:var(--accent)}
.theme-switch input:checked+.theme-slider:before{transform:translateX(20px)}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;overflow:hidden;height:100vh}
.app{display:flex;height:100vh}
.sidebar{width:220px;background:var(--bg2);border-right:1px solid var(--border);padding:16px 0 48px;flex-shrink:0;display:flex;flex-direction:column;position:relative}
.sidebar-header{padding:12px 20px;margin-bottom:8px}
.sidebar-header h1{font-size:14px;font-weight:700;color:var(--accent2);letter-spacing:-0.3px}
.sidebar-header p{font-size:10px;color:var(--text2);margin-top:2px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;cursor:pointer;color:var(--text2);font-size:13px;transition:all .15s;border-left:3px solid transparent}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.active{background:var(--bg3);color:var(--accent2);border-left-color:var(--accent)}
.main{flex:1;overflow-y:auto;padding:20px 28px}
.page-title{font-size:20px;font-weight:700;margin-bottom:16px;letter-spacing:-0.5px;display:flex;align-items:center;justify-content:space-between}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
.stat-card .label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.stat-card .value{font-size:24px;font-weight:700;margin-top:2px}
.accent-c{color:var(--accent2)}.green-c{color:var(--green)}.yellow-c{color:var(--yellow)}.red-c{color:var(--red)}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px}
.card-title{font-size:12px;font-weight:600;margin-bottom:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.3px}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:7px 10px;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
td{padding:8px 10px;border-bottom:1px solid var(--border)}
tr.clickable{cursor:pointer;transition:background .15s}
tr.clickable:hover{background:var(--bg3)}
.clickable{cursor:pointer}
.person-card.clickable:hover{border-color:var(--accent2)}
.btn-del{color:var(--red);background:transparent;border:none;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px}
.htip{position:relative;cursor:pointer}.htip:hover>.htip-box{display:block}
.htip-box{display:none;position:absolute;bottom:0;left:50%;transform:translate(-50%,100%);z-index:999;background:var(--bg3);color:var(--text1);padding:6px 10px;border-radius:6px;font-size:10px;white-space:pre-line;min-width:120px;max-width:300px;pointer-events:none;box-shadow:0 2px 8px rgba(0,0,0,.25);border:1px solid var(--border)}
.btn-del:hover{background:rgba(255,60,60,0.15)}
.badge{display:inline-block;padding:2px 10px;border-radius:20px;font-size:11px;font-weight:600}
.b-active{background:rgba(34,197,94,.15);color:var(--green)}
.b-draft{background:rgba(136,136,170,.15);color:var(--text2)}
.b-completed{background:rgba(99,102,241,.15);color:var(--accent2)}
.b-paused{background:rgba(234,179,8,.15);color:var(--yellow)}
.b-bpm{background:rgba(14,165,233,.12);color:var(--sky)}
.b-bpa{background:rgba(139,92,246,.12);color:var(--violet)}
.b-bpi{background:rgba(16,185,129,.12);color:var(--emerald)}
.b-bpo{background:rgba(245,158,11,.12);color:var(--amber)}
.btn{padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent2)}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--bg4)}
.btn-danger{background:rgba(239,68,68,.15);color:var(--red);border:1px solid rgba(239,68,68,.2)}.btn-danger:hover{background:rgba(239,68,68,.25)}
.btn-success{background:rgba(34,197,94,.15);color:var(--green);border:1px solid rgba(34,197,94,.2)}.btn-success:hover{background:rgba(34,197,94,.25)}
.btn-sm{padding:4px 10px;font-size:11px}
.back-btn{display:inline-flex;align-items:center;gap:6px;color:var(--text2);font-size:13px;cursor:pointer;margin-bottom:14px;padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:none}
.back-btn:hover{color:var(--text);border-color:var(--text2)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px)}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:24px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto}
.modal h2{font-size:18px;font-weight:700;margin-bottom:16px}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:12px;color:var(--text2);margin-bottom:4px;font-weight:500}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--accent)}
.form-group textarea{resize:vertical;min-height:60px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:16px;padding-top:14px;border-top:1px solid var(--border)}
.phase-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.phase-card{background:var(--bg3);border-radius:8px;padding:12px;border:1px solid var(--border)}
.phase-card.mining{border-top:3px solid var(--sky)}
.phase-card.assembling{border-top:3px solid var(--violet)}
.phase-card.implementation{border-top:3px solid var(--emerald)}
.phase-card.organization{border-top:3px solid var(--amber)}
/* Phase Group Cards */
.pg-card{background:var(--bg3);border-radius:10px;padding:16px;border:1px solid var(--border);position:relative;transition:all .15s}
.pg-card:hover{border-color:var(--accent);box-shadow:0 2px 12px rgba(0,0,0,.08)}
.pg-card.mining{border-top:3px solid var(--sky)}
.pg-card.assembling{border-top:3px solid var(--violet)}
.pg-card.implementation{border-top:3px solid var(--emerald)}
.pg-card.organization{border-top:3px solid var(--amber)}
.pg-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.pg-title{font-size:14px;font-weight:700}
.pg-dates{font-size:10px;color:var(--text2);margin-bottom:6px}
/* Timeline bar */
.pg-timeline{display:flex;height:22px;background:var(--bg4);border-radius:6px;overflow:hidden;position:relative;margin:8px 0}
.pg-timeline-work{height:100%;transition:width .3s}
.pg-timeline-work.mining{background:rgba(14,165,233,.35)}
.pg-timeline-work.assembling{background:rgba(139,92,246,.35)}
.pg-timeline-work.implementation{background:rgba(16,185,129,.35)}
.pg-timeline-work.organization{background:rgba(245,158,11,.35)}
.pg-timeline-buffer{height:100%;transition:width .3s}
.pg-timeline-buffer.healthy{background:repeating-linear-gradient(45deg,transparent,transparent 3px,rgba(34,197,94,.12) 3px,rgba(34,197,94,.12) 6px)}
.pg-timeline-buffer.warning{background:repeating-linear-gradient(45deg,transparent,transparent 3px,rgba(234,179,8,.2) 3px,rgba(234,179,8,.2) 6px)}
.pg-timeline-buffer.danger{background:repeating-linear-gradient(45deg,transparent,transparent 3px,rgba(239,68,68,.2) 3px,rgba(239,68,68,.2) 6px)}
.pg-timeline-today{position:absolute;top:0;width:2px;height:100%;background:var(--red);z-index:5;transition:left .3s}
.pg-timeline-today::after{content:'▼';position:absolute;top:-10px;left:-4px;font-size:8px;color:var(--red)}
/* Buffer gauge */
.pg-buffer-gauge{height:6px;background:var(--bg4);border-radius:3px;margin:4px 0;overflow:hidden}
.pg-buffer-fill{height:100%;border-radius:3px;transition:width .3s,background .3s}
.pg-buffer-fill.green{background:var(--green)}.pg-buffer-fill.yellow{background:var(--yellow)}.pg-buffer-fill.red{background:var(--red)}.pg-buffer-fill.gray{background:var(--text2);opacity:.3}.pg-buffer-fill.done{background:var(--accent)}
/* Buffer metrics */
.pg-metrics{display:flex;gap:8px;flex-wrap:wrap;font-size:10px;color:var(--text2);margin:4px 0}
.pg-metric{display:flex;align-items:center;gap:3px}
.pg-metric b{color:var(--text);font-weight:600}
/* Phase flow (sub-phases within group) */
.pg-flow{display:flex;align-items:center;gap:4px;margin:6px 0;flex-wrap:wrap}
.pg-flow-item{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--bg2);border:1px solid var(--border)}
.pg-flow-item.completed{background:rgba(34,197,94,.12);color:var(--green);border-color:rgba(34,197,94,.3)}
.pg-flow-item.in_progress{background:rgba(14,165,233,.12);color:var(--sky);border-color:rgba(14,165,233,.3);font-weight:600}
.pg-flow-arrow{font-size:10px;color:var(--text2);opacity:.5}
/* Payment section in phase card */
.pg-payments{margin-top:8px;padding-top:8px;border-top:1px dashed var(--border)}
.pg-pay-item{display:flex;justify-content:space-between;align-items:center;font-size:11px;padding:3px 0}
.pg-pay-status{font-size:9px;padding:1px 6px;border-radius:8px}
.pg-pay-status.PLANNED{background:rgba(14,165,233,.12);color:var(--sky)}
.pg-pay-status.ACCRUED{background:rgba(234,179,8,.15);color:var(--amber)}
.pg-pay-status.PAID{background:rgba(34,197,94,.12);color:var(--green)}
.pg-pay-total{font-size:12px;font-weight:700;color:var(--accent);margin-top:4px;text-align:right}
/* Docs compact */
.pg-docs{margin-top:6px;display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text2)}
.pg-docs-bar{flex:1;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden}
.pg-docs-fill{height:100%;background:var(--green);border-radius:2px;transition:width .3s}
/* Phase grouping mode switcher */
.pg-mode-switch{display:flex;gap:2px;background:var(--bg2);border-radius:6px;padding:2px;margin-bottom:12px}
.pg-mode-btn{padding:4px 12px;font-size:11px;border-radius:4px;cursor:pointer;border:none;background:transparent;color:var(--text2);transition:all .12s}
.pg-mode-btn.active{background:var(--accent);color:#fff;font-weight:600}
.pg-mode-btn:hover:not(.active){background:var(--bg3)}
/* Phase flow layout — vertical with wedges */
.pg-flow-vertical{display:flex;flex-direction:column;gap:0;max-width:800px}
.pg-wedge{display:flex;align-items:center;gap:8px;padding:6px 16px;position:relative}
.pg-wedge::before{content:'';position:absolute;left:24px;top:0;bottom:0;width:2px;background:var(--border)}
.pg-wedge-items{display:flex;flex-wrap:wrap;gap:6px;flex:1;margin-left:16px}
.pg-wedge-pay{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:12px;font-size:10px;border:1px solid var(--border);background:var(--bg2);cursor:default}
.pg-wedge-pay.PAID{background:rgba(34,197,94,.12);border-color:var(--green);color:var(--green)}
.pg-wedge-pay.ACCRUED{background:rgba(99,102,241,.1);border-color:var(--accent);color:var(--accent)}
.pg-wedge-pay.PLANNED{background:var(--bg3);color:var(--text2)}
.pg-wedge-ms{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:12px;font-size:10px;border:1px dashed var(--amber);background:rgba(245,158,11,.08);color:var(--amber);cursor:pointer}
.pg-wedge-ms.DONE{border-style:solid;border-color:var(--green);background:rgba(34,197,94,.08);color:var(--green)}
.pg-wedge-connector{width:12px;height:2px;background:var(--border);flex-shrink:0}
.pg-start-btn{padding:4px 14px;border-radius:6px;background:var(--green);color:#fff;border:none;cursor:pointer;font-size:11px;font-weight:600;transition:all .15s}
.pg-start-btn:hover{filter:brightness(1.1)}
.pg-add-ms-btn{padding:2px 8px;border-radius:10px;background:transparent;border:1px dashed var(--amber);color:var(--amber);font-size:10px;cursor:pointer;transition:all .15s}
.pg-add-ms-btn:hover{background:rgba(245,158,11,.1)}
.pg-add-en-btn{padding:2px 8px;border-radius:10px;background:transparent;border:1px dashed var(--sky);color:var(--sky);font-size:10px;cursor:pointer;transition:all .15s}
.pg-add-en-btn:hover{background:rgba(14,165,233,.1)}
.pg-wedge-ms.enabler{background:rgba(14,165,233,.12)!important;color:var(--sky)!important;border-left:2px solid var(--sky)}
.pg-wedge-del{margin-left:6px;cursor:pointer;opacity:.4;font-weight:700;font-size:12px}
.pg-wedge-del:hover{opacity:1;color:var(--red)}
.filter-chip{padding:4px 10px;border-radius:16px;font-size:11px;cursor:pointer;border:1px solid var(--border);background:var(--bg3);color:var(--text2);transition:all .15s;user-select:none}
.filter-chip:hover{border-color:var(--accent)}
.filter-chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.proj-info-panel{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:14px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
.pi-section{border-left:3px solid var(--accent2);padding-left:10px}
.pi-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.pi-value{font-size:15px;font-weight:700;color:var(--text)}
.cross-kanban{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px}
.cross-kanban-col{flex:1;min-width:180px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:8px}
.cross-kanban-head{font-size:12px;font-weight:700;margin-bottom:8px;padding:4px 6px;border-radius:6px;text-align:center}
.cross-task-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 10px;margin-bottom:6px;cursor:grab;transition:box-shadow .15s,opacity .15s}
.cross-task-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.15)}
.cross-task-card .proj-badge{display:inline-block;font-size:9px;font-weight:700;padding:1px 6px;border-radius:8px;background:var(--accent);color:#fff;margin-bottom:3px}
/* Phase date inputs */
.pg-phase-dates{margin-bottom:8px;border:1px solid var(--border);border-radius:8px;padding:8px 10px;background:var(--bg3)}
.pg-phase-dates-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.pg-phase-dates-head b{font-size:10px;color:var(--text)}
.pg-phase-dates-hint{font-size:9px;color:var(--text2);font-style:italic}
.pg-phase-date-row{display:flex;gap:6px;align-items:center;margin-bottom:4px}
.pg-phase-date-row label{font-size:9px;color:var(--text2);width:44px;flex-shrink:0}
.pg-phase-date-row input[type="date"]{background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:10px;padding:2px 6px;flex:1;max-width:130px;outline:none}
.pg-phase-date-row input[type="date"]:focus{border-color:var(--accent)}
.pg-contract-bounds{font-size:9px;color:var(--text2);margin-bottom:6px;padding:3px 8px;background:rgba(99,102,241,.08);border-radius:4px;display:inline-flex;gap:6px;align-items:center}
/* Triage phase items */
.tri-phase-item{padding:8px 10px;border-radius:8px;background:var(--bg3);margin-bottom:6px;cursor:pointer;border:1px solid transparent;transition:all .15s}
.tri-phase-item:hover{border-color:var(--accent);background:var(--bg4)}
.tri-phase-code{font-size:10px;font-weight:700;color:var(--accent)}
.tri-phase-name{font-size:11px;font-weight:600;margin:2px 0}
.tri-phase-meta{font-size:10px;color:var(--text2);display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.stage-row{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text2);padding:2px 0}
.stage-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.stage-dot.ns{background:var(--bg4);border:1px solid var(--text2)}
.stage-dot.ip{background:var(--green);box-shadow:0 0 6px rgba(34,197,94,.5)}
.stage-dot.done{background:var(--accent2)}
.tab-bar{display:flex;gap:2px;margin-bottom:16px;border-bottom:1px solid var(--border)}
.tab{padding:7px 14px;cursor:pointer;font-size:12px;color:var(--text2);border-bottom:2px solid transparent;margin-bottom:-1px}
.tab:hover{color:var(--text)}.tab.active{color:var(--accent2);border-bottom-color:var(--accent)}
.triage-cols{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.triage-col{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px}
.triage-col h3{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.proj-mini{padding:8px 10px;border-radius:7px;background:var(--bg3);margin-bottom:6px;cursor:pointer;transition:all .15s;border:1px solid transparent}
.proj-mini:hover{border-color:var(--accent);background:var(--bg4)}
.proj-mini .code{font-size:10px;color:var(--accent2);font-weight:600}
.proj-mini .name{font-size:12px;margin-top:1px}
.proj-mini .meta{font-size:10px;color:var(--text2);margin-top:3px}
.person-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.person-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px}
.person-card .p-status{display:inline-block;font-size:10px;padding:1px 7px;border-radius:8px;font-weight:600;margin-left:6px}
.person-card .p-status.active{background:#dcfce7;color:#166534}.person-card .p-status.fired{background:#fee2e2;color:#991b1b}
.person-card .p-dates{display:flex;gap:12px;margin-top:6px;font-size:10px;color:var(--text2)}
.person-card .p-fin{display:flex;gap:12px;margin-top:6px;font-size:11px}
.person-card .p-fin .pf-item{background:var(--bg1);border-radius:6px;padding:3px 8px;font-size:10px}
.person-card .p-fin .pf-label{color:var(--text2);margin-right:4px}
.person-card .p-fin .pf-val{font-weight:600}
.person-card .p-grade{display:inline-block;font-size:10px;padding:1px 6px;border-radius:6px;background:var(--accent2);color:var(--accent);font-weight:600;margin-left:6px}
.people-filters{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.people-filters .pf-btn{border:1px solid var(--border);background:var(--bg2);border-radius:8px;padding:4px 12px;font-size:12px;cursor:pointer;transition:all .15s}
.people-filters .pf-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.people-stats{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.people-stats .ps-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 16px;flex:1;min-width:140px}
.people-stats .ps-label{font-size:10px;color:var(--text2);text-transform:uppercase}
.people-stats .ps-val{font-size:20px;font-weight:700;margin-top:2px}
.paei-bar{display:flex;gap:2px;margin-top:6px}
.paei-bar .paei-axis{flex:1;text-align:center;border-radius:4px;padding:2px 0;font-size:10px;font-weight:700}
.paei-bar .paei-axis.strong{background:#dcfce7;color:#166534}.paei-bar .paei-axis.weak{background:var(--bg1);color:var(--text2)}
.comp-mini{display:flex;gap:2px;margin-top:4px;align-items:flex-end}
.comp-mini .cm-bar{flex:1;border-radius:2px 2px 0 0;min-height:2px;background:var(--accent)}
.comp-radar{position:relative;width:200px;height:200px;margin:0 auto}
.comp-grid{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
.comp-grid .cg-label{font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.comp-grid .cg-dots{display:flex;gap:3px}
.comp-grid .cg-dot{width:14px;height:14px;border-radius:50%;border:1.5px solid var(--border);cursor:pointer;transition:all .15s;font-size:8px;display:flex;align-items:center;justify-content:center}
.comp-grid .cg-dot.filled{background:var(--accent);border-color:var(--accent);color:#fff}
.comp-grid .cg-dot:hover{transform:scale(1.2)}
.paei-edit{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.paei-edit .pe-axis{text-align:center;padding:8px;border-radius:8px;background:var(--bg1)}
.paei-edit .pe-axis label{display:block;font-weight:600;font-size:13px;margin-bottom:4px}
.paei-edit .pe-axis input[type=range]{width:100%}
.paei-edit .pe-axis .pe-val{font-size:18px;font-weight:700}
.person-detail-tabs{display:flex;gap:2px;margin-bottom:12px;border-bottom:2px solid var(--border);padding-bottom:0}
.person-detail-tabs button{border:none;background:none;padding:6px 14px;font-size:12px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;color:var(--text2)}
.person-detail-tabs button.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}
.hyp-cols{display:grid;grid-template-columns:repeat(4,260px);gap:16px;min-width:1100px;overflow-x:auto}
.hyp-col-header{padding:6px 14px;border-radius:7px;font-size:12px;font-weight:600;color:#fff;margin-bottom:10px;text-align:center}
.hyp-node{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;font-size:11px}
.hyp-node-title{font-weight:600;font-size:12px;margin-bottom:3px}
.wts-panel{background:var(--bg2);border-radius:8px;padding:10px 14px;margin-top:8px}
.wts-panel h4{margin:0 0 6px;font-size:12px;color:var(--text2);font-weight:600}
.wts-table{width:100%;font-size:11px;border-collapse:collapse}
.wts-table th{text-align:left;padding:3px 6px;font-weight:600;color:var(--text2);font-size:10px}
.wts-table td{padding:3px 6px;border-top:1px solid var(--border)}
.wts-add{display:flex;gap:6px;align-items:flex-end;margin-top:6px;flex-wrap:wrap}
.wts-badge{display:inline-flex;align-items:center;gap:3px;background:var(--sky);color:#fff;font-size:10px;font-weight:600;padding:2px 7px;border-radius:10px}
.wts-rate{font-size:10px;color:var(--text2);margin-top:3px}
/* ORG CHART */
.oc-tabs{display:flex;gap:2px;margin-bottom:14px;border-bottom:2px solid var(--border)}
.oc-tab{padding:8px 16px;font-size:13px;cursor:pointer;color:var(--text2);border-bottom:2px solid transparent;margin-bottom:-2px;font-weight:500}
.oc-tab.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}
.oc-dept-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-bottom:16px}
.oc-dept{border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--bg1)}
.oc-dept-head{padding:10px 14px;font-weight:600;font-size:13px;display:flex;justify-content:space-between;align-items:center}
.oc-dept-body{padding:8px 10px}
.oc-person{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:6px;margin-bottom:4px;font-size:12px;cursor:grab;border:1px solid transparent;transition:all .15s}
.oc-person:hover{background:var(--bg2);border-color:var(--border)}
.oc-person.dragging{opacity:.5;border-style:dashed}
.oc-person.drag-over{border-color:var(--accent);background:rgba(99,102,241,.08)}
.oc-person .oc-name{font-weight:600;flex:1}
.oc-person .oc-pos{font-size:10px;color:var(--text2)}
.oc-person .oc-grade{font-size:10px;padding:1px 5px;border-radius:8px;font-weight:600}
.oc-person .oc-unpin{font-size:14px;color:var(--text2);cursor:pointer;padding:0 4px;border-radius:4px;opacity:0;transition:opacity .15s;line-height:1;margin-left:4px}
.oc-person:hover .oc-unpin{opacity:.6}
.oc-person .oc-unpin:hover{opacity:1;color:var(--red);background:rgba(239,68,68,.1)}
.oc-person .oc-grade.g-C1{background:#dcfce7;color:#166534}
.oc-person .oc-grade.g-C2{background:#dbeafe;color:#1e40af}
.oc-person .oc-grade.g-C3{background:#fef3c7;color:#92400e}
.oc-person .oc-grade.g-C4{background:#fce7f3;color:#9d174d}
.oc-person .oc-grade.g-C5{background:#f3e8ff;color:#7e22ce}
.oc-sub{margin-left:20px;border-left:2px solid var(--border);padding-left:8px}
.oc-empty{font-size:11px;color:var(--text2);font-style:italic;padding:8px}
.oc-drop-zone{min-height:28px;border:2px dashed var(--border);border-radius:6px;margin:4px 0;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text2);transition:all .15s;padding:4px}
.oc-drop-zone.drag-active{border-color:var(--accent);background:rgba(99,102,241,.05)}
.oc-pyramid{display:flex;flex-direction:column;align-items:center;gap:4px;margin:12px 0}
.oc-pyr-row{display:flex;gap:4px;justify-content:center;flex-wrap:wrap}
.oc-pyr-chip{padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600;text-align:center}
.oc-prod-groups{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
.oc-prod-group{border:1px solid var(--border);border-radius:8px;padding:8px 10px}
.oc-prod-group h4{margin:0 0 6px;font-size:12px;font-weight:600}
/* PROFITABILITY */
.profit-panel{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px}
.profit-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:13px;border-bottom:1px solid var(--border)}
.profit-row:last-child{border-bottom:none}
.profit-row .pr-label{color:var(--text2)}
.profit-row .pr-val{font-weight:700}
.profit-row.pr-total{font-size:14px;padding:8px 0}
.profit-row .pr-neg{color:var(--red)}
.profit-row .pr-pos{color:var(--green)}
.tax-select{display:inline-flex;gap:4px;margin-left:8px}
.tax-btn{padding:4px 10px;font-size:12px;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-weight:500}
.tax-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.oh-table{width:100%;margin-top:8px}
.oh-table th,.oh-table td{padding:5px 8px;font-size:12px}
.oh-add{display:flex;gap:6px;margin-top:6px;align-items:flex-end}
/* RECOMMENDATIONS KANBAN */
.kn-tabs{display:flex;gap:2px;margin-bottom:16px;border-bottom:2px solid var(--border)}
.kn-tab{padding:8px 18px;cursor:pointer;font-size:13px;color:var(--text2);border-bottom:2px solid transparent;margin-bottom:-2px;font-weight:500}
.kn-tab:hover{color:var(--text)}.kn-tab.active{color:var(--accent2);border-bottom-color:var(--accent);font-weight:600}
.kn-tab .kn-count{font-size:10px;background:var(--bg2);padding:1px 6px;border-radius:8px;margin-left:4px}
.cp-card{border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:10px;background:var(--bg1);cursor:pointer;transition:all .15s}
.cp-card:hover{border-color:var(--accent);background:var(--bg2)}
.cp-phases{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.cp-phase{font-size:10px;padding:2px 8px;border-radius:10px;background:rgba(99,102,241,.1);color:var(--accent)}
.cp-meta{display:flex;gap:12px;font-size:11px;color:var(--text2);margin-top:4px;flex-wrap:wrap}
.cp-tracks{font-size:10px;color:var(--text2);margin-top:4px}
.cp-detail{padding:16px}
.cp-detail h3{margin:16px 0 8px;color:var(--accent2);font-size:14px}
.cp-detail table{width:100%;font-size:12px}
.rec-layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:14px}
@media(max-width:900px){.rec-layout{grid-template-columns:1fr}}
.rec-log{max-height:70vh;overflow-y:auto}
.rec-entry{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:8px}
.rec-entry .rec-ts{font-size:10px;color:var(--text2);margin-bottom:4px}
.rec-entry .rec-cat{display:inline-block;padding:1px 6px;border-radius:6px;font-size:10px;font-weight:600;margin-right:4px}
.rec-entry .rec-title{font-size:13px;font-weight:600;margin-bottom:3px}
.rec-entry .rec-desc{font-size:12px;color:var(--text2);line-height:1.4}
.rec-kanban{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.rec-col{background:var(--bg2);border-radius:10px;padding:10px;min-height:120px}
.rec-col-head{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.rec-col-head .rc-count{background:var(--bg4);padding:1px 6px;border-radius:8px;font-size:10px}
.rec-card{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:8px 10px;margin-bottom:6px;cursor:grab;font-size:12px;transition:all .15s}
.rec-card:hover{border-color:var(--accent);background:rgba(99,102,241,.05)}
.rec-card.dragging{opacity:.5;border-style:dashed}
.rec-card.drag-over{border-color:var(--accent);box-shadow:0 0 0 2px rgba(99,102,241,.2)}
.rec-card .rc-cat{font-size:9px;font-weight:600;padding:1px 5px;border-radius:4px;display:inline-block;margin-bottom:3px}
.rc-mgmt{background:#818cf822;color:var(--accent2)}
.rc-data{background:#22c55e22;color:var(--green)}
.rc-process{background:#f59e0b22;color:var(--amber)}
.rc-finance{background:#ef444422;color:var(--red)}
.rc-team{background:#0ea5e922;color:var(--sky)}
.rec-card .rc-title{font-weight:600;margin-bottom:2px}
.rec-card .rc-desc{font-size:11px;color:var(--text2);line-height:1.3}
.rec-card .rc-actions{display:flex;gap:4px;margin-top:4px}
.rc-act-btn{font-size:10px;padding:2px 6px;border-radius:4px;cursor:pointer;border:1px solid var(--border);background:var(--bg2);color:var(--text2)}
.rc-act-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.cap-indicator{background:var(--bg2);border-radius:10px;padding:12px 16px;margin-bottom:16px;border-left:4px solid var(--accent)}
.cap-indicator.over{border-left-color:var(--red);background:#fef2f2}
.cap-indicator .cap-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.cap-indicator .cap-title{font-weight:600;font-size:13px}
.cap-indicator .cap-formula{font-size:10px;color:var(--text2)}
.cap-indicator .cap-bar{height:8px;background:var(--bg3);border-radius:4px;overflow:hidden;margin-bottom:4px}
.cap-indicator .cap-fill{height:100%;border-radius:4px;transition:width .3s}
.cap-indicator .cap-text{font-size:11px;color:var(--text2)}
.cap-indicator .cap-warn{color:var(--red);font-weight:600;font-size:12px;margin-top:4px}
.team-capacity{background:var(--bg2);border-radius:10px;padding:12px 16px;margin-bottom:12px;display:flex;gap:16px;flex-wrap:wrap;align-items:center}
.team-capacity .tc-item{text-align:center}
.team-capacity .tc-label{font-size:10px;color:var(--text2)}
.team-capacity .tc-val{font-size:18px;font-weight:700}
.gantt-wrap{margin:16px 0;border:1px solid var(--border);border-radius:8px;overflow-x:auto;background:var(--bg1)}
.gantt-header{display:flex;border-bottom:1px solid var(--border);background:var(--bg2);position:sticky;top:0;z-index:2}
.gantt-header-label{flex:0 0 180px;padding:6px 10px;font-weight:600;font-size:11px;border-right:1px solid var(--border)}
.gantt-header-dates{display:flex;flex:1;position:relative}
.gantt-header-dates .gh-cell{font-size:9px;text-align:center;padding:4px 0;border-right:1px solid var(--border);color:var(--text2);min-width:32px;box-sizing:border-box}
.gantt-header-dates .gh-cell.gh-month{font-weight:600;font-size:10px;color:var(--text1);background:var(--bg2)}
.gantt-body{position:relative}
.gantt-row{display:flex;border-bottom:1px solid var(--border);min-height:28px;align-items:center}
.gantt-row:hover{background:var(--bg2)}
.gantt-row-label{flex:0 0 180px;padding:4px 10px;font-size:11px;font-weight:500;border-right:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
.gantt-row-label:hover{color:var(--accent)}
.gantt-row-bars{flex:1;position:relative;height:28px}
.gantt-bar{position:absolute;top:4px;height:20px;border-radius:4px;font-size:9px;color:#fff;display:flex;align-items:center;padding:0 4px;cursor:pointer;transition:opacity .15s;min-width:8px;box-sizing:border-box;overflow:hidden;white-space:nowrap}
.gantt-bar:hover{opacity:.85;box-shadow:0 1px 6px rgba(0,0,0,.2)}
.gantt-bar.st-NOT_STARTED{background:#94a3b8}
.gantt-bar.st-IN_PROGRESS{background:var(--accent)}
.gantt-bar.st-COMPLETED{background:var(--emerald)}
.gantt-bar.critical{border:2px solid var(--red);box-shadow:0 0 6px rgba(239,68,68,.35)}
.gantt-bar .gb-text{overflow:hidden;text-overflow:ellipsis}
.gantt-today{position:absolute;top:0;bottom:0;width:2px;background:var(--red);z-index:1;opacity:.5}
.gantt-dep-svg{position:absolute;top:0;left:180px;pointer-events:none;z-index:1}
.gantt-legend{display:flex;gap:12px;margin:8px 0;font-size:11px;flex-wrap:wrap;align-items:center}
.gantt-legend span{display:inline-flex;align-items:center;gap:4px}
.gantt-legend .gl-box{width:14px;height:10px;border-radius:2px}
.edit-track-modal .etm-tabs{display:flex;gap:2px;margin-bottom:12px;border-bottom:2px solid var(--border)}
.edit-track-modal .etm-tab{padding:6px 14px;font-size:12px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;color:var(--text2)}
.edit-track-modal .etm-tab.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}
.dep-table{width:100%;font-size:12px;border-collapse:collapse}
.dep-table th{text-align:left;padding:4px 6px;font-weight:600;font-size:11px;color:var(--text2)}
.dep-table td{padding:4px 6px;border-top:1px solid var(--border)}
.trk-expand{background:var(--bg2);border-radius:8px;padding:12px 16px;margin:4px 0 8px;border-left:3px solid var(--accent)}
.trk-expand h4{margin:0 0 8px;font-size:13px;color:var(--text2);font-weight:600}
.trk-expand .trk-ins-list,.trk-expand .trk-task-list{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.trk-expand .trk-ins-card{background:var(--bg1);border-radius:6px;padding:8px 12px;font-size:12px;border-left:3px solid var(--amber)}
.trk-expand .trk-ins-card .trk-ins-meta{font-size:10px;color:var(--text2);margin-top:2px}
.trk-expand .trk-task-card{background:var(--bg1);border-radius:6px;padding:8px 12px;font-size:12px;display:flex;justify-content:space-between;align-items:center;border-left:3px solid var(--emerald)}
.trk-expand .trk-task-card .trk-task-title{font-weight:500}
.trk-expand .trk-task-card .trk-task-meta{font-size:10px;color:var(--text2)}
.trk-expand .trk-empty{font-size:11px;color:var(--text2);font-style:italic;padding:4px 0}
.trk-row-active{background:var(--bg2) !important}
.trk-row{cursor:pointer;transition:background .15s}
.trk-row:hover{background:var(--bg2)}
.it-container{position:relative}
.it-flow{display:flex;gap:0;overflow-x:auto;padding-bottom:8px;align-items:flex-start}
.it-col{min-width:240px;max-width:280px;flex:0 0 auto}
.it-col-header{padding:8px 14px;border-radius:8px;font-size:12px;font-weight:700;color:#fff;margin-bottom:10px;text-align:center;position:sticky;top:0}
.it-connector{display:flex;align-items:center;min-width:24px;flex:0 0 24px}
.it-connector svg{width:24px;height:40px}
.it-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;font-size:11px;cursor:default;position:relative;transition:box-shadow .15s}
.it-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.08)}
.it-card.selected{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent2)}
.it-card-title{font-weight:700;font-size:12px}
.it-card-sub{font-size:10px;color:var(--text2);margin-top:2px}
.it-card-meta{font-size:10px;color:var(--text2);margin-top:4px}
.it-card-del{position:absolute;top:4px;right:6px;font-size:12px;cursor:pointer;opacity:0;transition:opacity .15s;color:var(--red)}
.it-card:hover .it-card-del{opacity:.6}
.it-card-del:hover{opacity:1!important}
.it-card.pain{border-left:3px solid var(--red)}
.it-card.gain{border-left:3px solid var(--green)}
.it-track-badge{display:inline-block;font-size:9px;padding:1px 6px;border-radius:4px;font-weight:700;margin-left:4px}
.it-track-badge.bpm{background:#dcfce7;color:#166534}
.it-track-badge.bpa{background:#dbeafe;color:#1e40af}
.it-track-badge.bpi{background:#ede9fe;color:#5b21b6}
.it-track-badge.bpo{background:#fef3c7;color:#92400e}
.it-add{border:1px dashed var(--border);border-radius:6px;padding:6px;text-align:center;font-size:11px;color:var(--text2);cursor:pointer;margin-bottom:8px;transition:all .15s}
.it-add:hover{border-color:var(--accent);color:var(--accent);background:var(--accent2)}
.it-inline-form{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap}
.it-inline-form input,.it-inline-form select{font-size:11px;padding:3px 6px;border-radius:4px;border:1px solid var(--border)}
.it-inline-form input{flex:1;min-width:100px}
.it-arrow-link{width:100%;height:20px;display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:10px;opacity:.5}
.it-unlinked{background:var(--accent2);border:1px dashed var(--accent);border-radius:8px;padding:10px;margin-top:8px}
/* ===== Issue Tree v2: dynamic columns ===== */
.it-flow-dynamic{display:flex;gap:0;overflow-x:auto;align-items:flex-start;padding-bottom:12px;position:relative}
.it-col-dynamic{min-width:220px;max-width:280px;flex:0 0 auto;padding:0 4px}
.it-col-dynamic.task-col{min-width:auto;max-width:none;flex:1 0 auto}
.it-col-hdr{padding:6px 10px;border-radius:8px;font-size:11px;font-weight:700;color:#fff;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;gap:4px;position:relative}
.it-col-hdr-left{display:flex;align-items:center;gap:4px}
.it-col-hdr-right{display:flex;gap:3px;align-items:center}
.it-col-add-lr{font-size:9px;padding:1px 5px;cursor:pointer;background:rgba(255,255,255,.2);border-radius:3px;border:none;color:#fff;line-height:1.4}
.it-col-add-lr:hover{background:rgba(255,255,255,.4)}
.it-col-color-inp{width:0;height:0;opacity:0;position:absolute;pointer-events:none}
.it-col-color-dot{width:14px;height:14px;border-radius:50%;cursor:pointer;border:2px solid rgba(255,255,255,.5);flex-shrink:0}
.it-col-del{font-size:10px;cursor:pointer;opacity:.5;padding:0 2px}
.it-col-del:hover{opacity:1}
/* Card v2 */
.it-card-v2{position:relative;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;margin-bottom:6px;cursor:grab;transition:all .15s}
.it-card-v2:hover{border-color:var(--accent);box-shadow:0 2px 8px rgba(0,0,0,.15)}
.it-card-v2 .it-link-btn{position:absolute;top:4px;right:22px;font-size:11px;cursor:pointer;opacity:0;transition:opacity .15s;z-index:1}
.it-card-v2:hover .it-link-btn{opacity:.5}
.it-card-v2 .it-link-btn:hover{opacity:1;color:var(--amber)}
.it-card-v2 .it-card-del{right:4px}
.it-card-v2.focused{border:2px solid var(--amber);box-shadow:0 0 0 3px rgba(245,158,11,.2)}
.it-card-v2.linked{border-color:var(--amber);background:rgba(245,158,11,.06)}
.it-card-v2.dimmed{display:none}
.it-card-v2.link-target{border:2px dashed var(--green);cursor:crosshair}
.it-card-v2.link-target:hover{background:rgba(34,197,94,.08)}
.it-card-v2 .it-link-count{position:absolute;top:3px;right:36px;font-size:8px;background:var(--amber);color:#fff;border-radius:50%;width:14px;height:14px;display:flex;align-items:center;justify-content:center;font-weight:700}
/* Tasks horizontal */
.it-tasks-horiz{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px}
.it-task-subcol{min-width:180px;flex:0 0 200px;background:var(--bg3);border-radius:8px;padding:6px;transition:background .15s}
.it-task-subcol-head{font-size:10px;font-weight:700;margin-bottom:4px;display:flex;justify-content:space-between}
.it-task-subcol .it-card-v2[draggable]{cursor:grab;transition:opacity .15s,box-shadow .15s}
.it-task-subcol .it-card-v2[draggable]:active{cursor:grabbing}
/* Connector between columns */
.it-conn-v2{display:flex;align-items:center;flex-shrink:0;width:20px}
.it-conn-v2 svg{width:20px;height:30px}
.fin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:16px}
.fin-card{background:var(--bg3);border-radius:8px;padding:12px;text-align:center}
.fin-card .val{font-size:20px;font-weight:700;margin-top:3px}
.fin-card .lbl{font-size:10px;color:var(--text2)}
.progress-bar{height:7px;background:var(--bg4);border-radius:4px;overflow:hidden;margin-top:4px}
.progress-fill{height:100%;border-radius:4px}
.buffer-green{background:rgba(34,197,94,.15);color:var(--green)}
.buffer-yellow{background:rgba(234,179,8,.15);color:var(--yellow)}
.buffer-red{background:rgba(239,68,68,.15);color:var(--red)}
.seg-1{background:rgba(239,68,68,.2);color:var(--red);font-weight:700}
.seg-2{background:rgba(234,179,8,.2);color:var(--yellow)}
.seg-3{background:rgba(14,165,233,.15);color:var(--sky)}
.seg-4{background:rgba(34,197,94,.15);color:var(--green)}
.filter-select{background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;padding:5px 10px;cursor:pointer}
.filter-select:focus{outline:none;border-color:var(--accent)}
.project-table th{white-space:nowrap}
.type-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:14px;font-size:11px;margin:2px}
.type-chip .del{cursor:pointer;color:var(--red);font-weight:700;margin-left:4px}

.blocker-item{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:7px;padding:8px 12px;margin-bottom:6px;font-size:12px}
.task-item{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px solid var(--border);font-size:12px}
.empty{text-align:center;padding:30px;color:var(--text2);font-size:13px}
.chip{padding:3px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:14px;font-size:11px;display:inline-block;margin:2px}
.toast{position:fixed;bottom:24px;right:24px;background:var(--green);color:#fff;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:200;animation:slideIn .3s ease}
@keyframes slideIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.inline-edit{background:transparent;border:none;color:var(--text);font-size:inherit;font-weight:inherit;padding:2px 4px;border-radius:4px;width:100%}
.inline-edit:hover{background:var(--bg3)}.inline-edit:focus{background:var(--bg3);outline:1px solid var(--accent)}
.doc-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:12px}
.doc-item .doc-icon{font-size:18px;flex-shrink:0}
.doc-item .doc-info{flex:1}
.doc-item .doc-name{font-weight:600}
.doc-item .doc-meta{font-size:10px;color:var(--text2)}
.doc-item .doc-del{color:var(--red);cursor:pointer;background:none;border:none;font-size:14px;font-weight:700}
.dd-progress{margin-bottom:16px}
.dd-progress-bar{display:flex;gap:3px;margin-top:6px}
.dd-progress-seg{flex:1;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;transition:all .2s}
.dd-progress-seg.done{background:var(--green);color:#fff}
.dd-progress-seg.ip{background:var(--accent);color:#fff}
.dd-progress-seg.ns{background:var(--bg4);color:var(--text2)}
.dd-phase-dur{display:flex;gap:3px;margin-top:4px;flex-wrap:wrap}
.dd-phase-chip{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;background:var(--bg3);color:var(--text2)}
.dd-phase-chip.done{background:var(--green);color:#fff;opacity:.85}
.dd-phase-chip.ip{background:var(--accent);color:#fff;opacity:.85}
.dd-phase-chip .chip-days{font-weight:700}
.stage-dur{font-size:10px;color:var(--text2);margin-left:auto;white-space:nowrap}
.stage-dur.done-dur{color:var(--green)}
.stage-dur.ip-dur{color:var(--accent)}
.phase-stats-bar{display:flex;gap:8px;margin-top:6px;margin-bottom:6px;flex-wrap:wrap}
.phase-stat-chip{display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:8px;font-size:10px;background:var(--bg3);color:var(--text2)}
.phase-stat-chip.accent{background:var(--accent);color:#fff;opacity:.9}
.phase-stat-chip.warn{background:var(--yellow);color:#000;opacity:.9}
.open-tracks-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;background:var(--yellow);color:#000;margin-top:6px}
.buf-panel{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:16px}
.buf-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.buf-title span:first-child{font-size:13px;font-weight:600}
.buf-status{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:700}
.buf-status.ok{background:#16a34a22;color:var(--green)}
.buf-status.warn{background:#eab30822;color:var(--yellow)}
.buf-status.danger{background:#ef444422;color:var(--red)}
.buf-status.overdue{background:var(--red);color:#fff}
.buf-bar-wrap{height:18px;border-radius:9px;background:var(--bg4);overflow:hidden;position:relative;margin-bottom:4px}
.buf-bar-work{height:100%;position:absolute;left:0;top:0;border-radius:9px 0 0 9px}
.buf-bar-buf{height:100%;position:absolute;top:0;opacity:.5;border-radius:0}
.buf-bar-cursor{position:absolute;top:-2px;width:3px;height:22px;background:var(--text);border-radius:2px;z-index:2}
.buf-bar-label{position:absolute;top:1px;font-size:8px;font-weight:700;color:#fff;pointer-events:none;padding:0 4px;line-height:16px}
.buf-stages{margin-top:10px}
.buf-stage-row{display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid var(--border)}
.buf-stage-row:last-child{border-bottom:none}
.buf-stage-name{width:140px;font-size:11px;font-weight:500;flex-shrink:0}
.buf-stage-bar-wrap{flex:1;height:10px;border-radius:5px;background:var(--bg4);overflow:hidden;position:relative}
.buf-stage-fill{height:100%;border-radius:5px;position:absolute;left:0;top:0}
.buf-stage-nums{font-size:10px;color:var(--text2);width:100px;text-align:right;flex-shrink:0}
.buf-legend{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap}
.buf-legend-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text2)}
.buf-legend-dot{width:8px;height:8px;border-radius:50%}
.pnl-mini{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:16px}
.pnl-mini .pnl-row{display:flex;justify-content:space-between;font-size:12px;padding:2px 0}
.pnl-mini .pnl-row.total{border-top:2px solid var(--accent);padding-top:6px;margin-top:4px;font-weight:700}
.pnl-mini .pnl-val{font-weight:600}
.pnl-health{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:700}
.pnl-health.green{background:#16a34a22;color:var(--green)}
.pnl-health.yellow{background:#eab30822;color:var(--yellow)}
.pnl-health.red{background:#ef444422;color:var(--red)}
.pnl-health.gray{background:var(--bg3);color:var(--text2)}
.pnl-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:2px}
.client-view-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;cursor:pointer;transition:all .2s}
.client-view-card:hover{border-color:var(--accent);transform:translateY(-1px)}
.client-view-card .cv-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.client-view-card .cv-name{font-size:15px;font-weight:700}
.client-view-card .cv-industry{font-size:11px;color:var(--text2);padding:2px 8px;background:var(--bg3);border-radius:8px}
.cv-fin-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
.cv-fin-item{text-align:center}
.cv-fin-item .cv-lbl{font-size:9px;color:var(--text2);text-transform:uppercase}
.cv-fin-item .cv-val{font-size:13px;font-weight:700}
.cv-proj-list{margin-top:8px;border-top:1px solid var(--border);padding-top:8px}
.cv-proj-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:11px}
.cv-proj-row:hover{color:var(--accent)}
.client-detail-back{cursor:pointer;color:var(--accent);font-size:13px;margin-bottom:12px;display:inline-block}
.client-detail-back:hover{text-decoration:underline}
.admin-scale{margin-top:8px}
.as-section{display:flex;align-items:stretch;gap:10px;margin-bottom:8px;padding:10px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;transition:all .2s}
.as-section.filled{border-color:var(--green)}
.as-section .as-num{width:28px;height:28px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0}
.as-section.filled .as-num{background:var(--green);color:#fff}
.as-section .as-body{flex:1}
.as-section .as-title{font-weight:600;font-size:13px}
.as-section .as-hint{font-size:10px;color:var(--text2);margin-top:2px}
.as-section .as-auto{font-size:10px;color:var(--green);margin-top:3px}
.as-section .as-notes{margin-top:4px}
.as-section textarea{width:100%;min-height:40px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;padding:6px 8px;resize:vertical}
.as-section textarea:focus{outline:none;border-color:var(--accent)}
.as-overall{display:flex;align-items:center;gap:12px;margin-bottom:14px;padding:10px 14px;background:var(--bg3);border-radius:8px}
.as-overall .as-pct{font-size:24px;font-weight:700;color:var(--accent)}
.as-overall .as-bar{flex:1}
.as-tracks{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.as-track-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;font-size:11px;cursor:pointer;transition:all .15s;border:1px solid var(--border);background:var(--bg4);color:var(--text2)}
.as-track-chip:hover{border-color:var(--accent)}
.as-track-chip.active{background:rgba(99,102,241,.15);border-color:var(--accent);color:var(--accent)}
.as-track-chip.active.bpm{background:rgba(34,197,94,.12);border-color:var(--green);color:var(--green)}
.as-track-chip.active.bpa{background:rgba(14,165,233,.12);border-color:var(--sky);color:var(--sky)}
.as-track-chip.active.bpi{background:rgba(139,92,246,.12);border-color:var(--violet);color:var(--violet)}
.as-track-chip.active.bpo{background:rgba(245,158,11,.12);border-color:var(--amber);color:var(--amber)}
.as-track-chip .chip-x{font-weight:700;margin-left:2px;font-size:12px}
.as-goal-cards{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.as-goal-card{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg2);border:1.5px solid var(--accent);border-radius:8px;position:relative}
.as-goal-card .as-gc-icon{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--sky));display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:700;flex-shrink:0}
.as-goal-card .as-gc-body{flex:1;min-width:0}
.as-goal-card .as-gc-title{font-weight:700;font-size:13px;color:var(--text)}
.as-goal-card .as-gc-desc{font-size:10px;color:var(--text2);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.as-goal-card .as-gc-type{font-size:9px;padding:1px 6px;border-radius:10px;background:rgba(99,102,241,.12);color:var(--accent);font-weight:600;white-space:nowrap}
.as-goal-card .as-gc-del{position:absolute;top:4px;right:6px;cursor:pointer;color:var(--text2);font-size:12px;opacity:.5;transition:opacity .15s}
.as-goal-card .as-gc-del:hover{opacity:1;color:var(--red)}
.as-goal-add-inline{margin-top:6px;display:flex;gap:4px;align-items:center}
.as-goal-add-inline input{flex:1;padding:5px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px}
.as-goal-add-inline input:focus{outline:none;border-color:var(--accent)}
.as-goal-add-inline select{padding:5px 6px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px}
.it-subgoal-list{margin-top:4px;padding-left:10px;border-left:2px solid var(--accent)}
.it-subgoal{padding:4px 8px;background:var(--bg2);border-radius:6px;font-size:11px;margin-bottom:3px;display:flex;justify-content:space-between;align-items:center}
.it-subgoal .sg-title{font-weight:600}
.it-subgoal .sg-del{cursor:pointer;opacity:.4;font-size:10px}
.it-subgoal .sg-del:hover{opacity:1;color:var(--red)}
.it-sg-add{font-size:10px;color:var(--accent);cursor:pointer;padding:2px 8px;opacity:.7}
.it-sg-add:hover{opacity:1}
.doc-filter-bar{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px}
.doc-filter-chip{padding:3px 10px;border-radius:14px;font-size:11px;cursor:pointer;border:1px solid var(--border);background:var(--bg4);color:var(--text2);transition:all .15s}
.doc-filter-chip:hover{border-color:var(--accent)}
.doc-filter-chip.active{background:rgba(99,102,241,.15);border-color:var(--accent);color:var(--accent);font-weight:600}
.doc-embed-wrap{margin-top:6px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--bg2)}
.doc-embed-wrap iframe{width:100%;height:400px;border:none}
.doc-embed-toggle{font-size:10px;color:var(--accent);cursor:pointer;margin-top:2px;display:inline-flex;align-items:center;gap:3px}
.doc-embed-toggle:hover{text-decoration:underline}
.doc-upload-zone{border:2px dashed var(--border);border-radius:8px;padding:16px;text-align:center;cursor:pointer;color:var(--text2);font-size:12px;transition:all .15s;margin-bottom:8px}
.doc-upload-zone:hover,.doc-upload-zone.drag-over{border-color:var(--accent);background:rgba(99,102,241,.05);color:var(--accent)}
.doc-upload-zone .upload-icon{font-size:24px;margin-bottom:4px}
.bpm-exp-grid{display:grid;grid-template-columns:1fr auto;gap:2px 8px;align-items:center;margin-top:6px}
.bpm-exp-row{display:contents}
.bpm-exp-name{font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bpm-exp-levels{display:flex;gap:2px}
.bpm-exp-btn{padding:2px 7px;border-radius:10px;font-size:9px;cursor:pointer;border:1px solid var(--border);background:var(--bg4);color:var(--text2);transition:all .12s;white-space:nowrap}
.bpm-exp-btn:hover{border-color:var(--accent)}
.bpm-exp-btn.lv-1{border-color:var(--sky);background:rgba(14,165,233,.12);color:var(--sky);font-weight:600}
.bpm-exp-btn.lv-2{border-color:var(--amber);background:rgba(245,158,11,.12);color:var(--amber);font-weight:600}
.bpm-exp-btn.lv-3{border-color:var(--accent);background:rgba(99,102,241,.12);color:var(--accent);font-weight:600}
.bpm-exp-btn.lv-4{border-color:var(--emerald);background:rgba(34,197,94,.15);color:var(--emerald);font-weight:700}
.comp-need-table{width:100%;border-collapse:collapse;font-size:11px}
.comp-need-table th{text-align:left;padding:6px 8px;background:var(--bg3);font-size:10px;font-weight:600;color:var(--text2);border-bottom:1px solid var(--border)}
.comp-need-table td{padding:5px 8px;border-bottom:1px solid var(--border)}
.comp-need-bar{height:6px;border-radius:3px;background:var(--bg4);position:relative;min-width:60px}
.comp-need-bar .cnb-fill{height:100%;border-radius:3px;transition:width .3s}
.comp-deficit{color:var(--red);font-weight:700;font-size:10px}
.comp-ok{color:var(--green);font-weight:600;font-size:10px}
.comp-partial{color:var(--amber);font-weight:600;font-size:10px}
.bpm-need-card{padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;margin-bottom:6px}
.bpm-need-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.bpm-need-header .bn-code{font-weight:700;font-size:12px}
.bpm-need-header .bn-status{font-size:10px;padding:2px 8px;border-radius:10px}
.bpm-need-persons{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.bpm-need-chip{padding:2px 8px;border-radius:10px;font-size:10px;border:1px solid var(--border)}
.trk-deps-section{margin-top:12px;padding-top:10px;border-top:1px solid var(--border)}
.trk-dep-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.trk-dep-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:8px;font-size:11px;background:var(--bg3);border:1px solid var(--border)}
.trk-dep-chip .tdc-code{font-weight:700}
.trk-dep-chip .tdc-arrow{color:var(--text2);font-size:10px}
.trk-dep-chip.predecessor{border-left:3px solid var(--sky)}
.trk-dep-chip.successor{border-left:3px solid var(--amber)}
.trk-dep-chip.clickable{cursor:pointer;transition:all .12s}
.trk-dep-chip.clickable:hover{border-color:var(--accent);background:var(--bg2)}
.dep-arrow-icon{display:inline-flex;align-items:center;justify-content:center;width:22px;height:18px;border-radius:4px;font-size:12px;font-weight:700;color:var(--accent);flex-shrink:0;background:rgba(99,102,241,.1)}
.dep-arrow-icon.pred{color:#6366f1}
.dep-arrow-icon.succ{color:#22c55e}
.trk-dur-badge{font-size:10px;padding:1px 6px;border-radius:10px;background:rgba(99,102,241,.1);color:var(--accent);font-weight:600;white-space:nowrap}
.trk-params{margin-top:4px;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.trk-param-input{width:48px;padding:2px 4px;border:1px solid var(--border);border-radius:4px;font-size:10px;background:var(--bg2);color:var(--text);text-align:center}
.trk-param-input:focus{outline:none;border-color:var(--accent)}
.trk-param-label{font-size:9px;color:var(--text2)}
.auto-sched-bar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.auto-sched-bar .as-info{font-size:11px;color:var(--text2)}
.trk-date-auto{font-size:9px;color:var(--sky);font-style:italic}
.ph-docs{margin-top:10px;border-top:1px solid var(--border);padding-top:8px}
.ph-docs-title{font-size:10px;color:var(--text2);font-weight:600;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.ph-doc-card{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;margin-bottom:4px;font-size:11px;cursor:pointer;transition:all .15s}
.ph-doc-card:hover{border-color:var(--accent);background:var(--bg3)}
.ph-doc-card.uploaded{border-color:var(--green);background:rgba(34,197,94,.05)}
.ph-doc-card.wip{border-color:var(--yellow);background:rgba(234,179,8,.05)}
.ph-doc-card .doc-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.ph-doc-card .doc-status-dot.s-done{background:var(--green)}
.ph-doc-card .doc-status-dot.s-wip{background:var(--yellow)}
.ph-doc-card .doc-status-dot.s-none{background:var(--bg4);border:1px solid var(--text2)}
.ph-doc-card .doc-label{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ph-doc-card .doc-link{color:var(--accent);font-size:10px;text-decoration:none}
.ph-doc-card .doc-link:hover{text-decoration:underline}
.upload-zone{border:2px dashed var(--border);border-radius:8px;padding:16px;text-align:center;color:var(--text2);font-size:12px;cursor:pointer;transition:all .2s;margin-bottom:10px}
.upload-zone:hover{border-color:var(--accent);color:var(--text)}
.upload-zone.dragging{border-color:var(--green);background:rgba(34,197,94,.05);color:var(--green)}
.phase-docs-pct{font-size:10px;font-weight:600;padding:2px 6px;border-radius:10px;background:var(--bg4)}
.phase-docs-pct.complete{background:rgba(34,197,94,.15);color:var(--green)}
.dash-section{margin-bottom:20px}
.dash-section-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.dash-section-title .subtitle{font-size:11px;font-weight:400;color:var(--text2)}
.kpi-row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:18px}
.kpi-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;position:relative;overflow:hidden}
.kpi-card .kpi-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.kpi-card .kpi-value{font-size:26px;font-weight:800;line-height:1.1}
.kpi-card .kpi-sub{font-size:10px;color:var(--text2);margin-top:4px}
.kpi-card .kpi-bar{position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--bg4)}
.kpi-card .kpi-bar-fill{height:100%}
.dash-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.dash-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.dash-grid-23{display:grid;grid-template-columns:2fr 1fr;gap:14px}
.dash-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px}
.dash-card .dc-title{font-size:12px;font-weight:700;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.seg-bar{display:flex;height:28px;border-radius:6px;overflow:hidden;margin-bottom:8px}
.seg-bar div{display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;transition:width .3s}
.heatmap-row{display:grid;grid-template-columns:100px 1fr 60px 60px 60px 60px 60px;gap:2px;align-items:center;padding:4px 0;border-bottom:1px solid var(--border);font-size:11px;cursor:pointer}
.heatmap-row:hover{background:var(--bg3)}
.heatmap-row .hm-code{font-weight:700;color:var(--accent2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.heatmap-row .hm-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text2);font-size:10px}
.hm-cell{text-align:center;padding:3px 4px;border-radius:4px;font-size:10px;font-weight:600}
.hm-g{background:rgba(34,197,94,.15);color:var(--green)}
.hm-y{background:rgba(234,179,8,.15);color:var(--yellow)}
.hm-r{background:rgba(239,68,68,.15);color:var(--red)}
.hm-b{background:rgba(99,102,241,.1);color:var(--accent2)}
.hm-d{background:var(--bg4);color:var(--text2)}
.risk-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:6px;margin-bottom:4px;font-size:11px;background:var(--bg3);cursor:pointer}
.risk-item:hover{background:var(--bg4)}
.risk-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.team-bar{display:flex;align-items:center;gap:8px;margin-bottom:5px;font-size:11px}
.team-bar .tb-name{width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text2)}
.team-bar .tb-fill{height:14px;border-radius:3px;min-width:2px;transition:width .3s}
.team-bar .tb-count{font-weight:600;font-size:10px;min-width:20px}
.wg-compare{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
.wg-stat{text-align:center}
.wg-stat .wg-val{font-size:22px;font-weight:800}
.wg-stat .wg-lbl{font-size:9px;color:var(--text2);text-transform:uppercase}
.wg-vs{font-size:10px;color:var(--text2);font-weight:700}
.deadline-item{display:flex;justify-content:space-between;align-items:center;padding:5px 8px;border-radius:6px;margin-bottom:3px;font-size:11px;cursor:pointer}
.deadline-item:hover{background:var(--bg3)}
.deadline-item .dl-days{font-weight:700;font-size:10px;padding:2px 8px;border-radius:10px}
.fin-mini{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}
.fin-mini-card{background:var(--bg3);border-radius:8px;padding:10px;text-align:center}
.fin-mini-card .fmc-val{font-size:18px;font-weight:800;margin-top:2px}
.fin-mini-card .fmc-lbl{font-size:9px;color:var(--text2);text-transform:uppercase}
</style>
</head>
<body>
<div id="root"></div>
<script>window.SEED={"projects":[],"clients":[],"persons":[],"phaseTemplates":[{"id":"b17c2387-c3c9-417f-8d24-6132bcc9c0ed","code":"MINING","name":"Добыча (Mining)","track_class":"BPM","order_num":1,"description":null},{"id":"e29020b0-15fb-42ac-80e2-496789235617","code":"ASSEMBLING","name":"Сборка (Assembling)","track_class":"BPA","order_num":2,"description":null},{"id":"5ccd60c8-0936-4bd6-b097-d21438d4745c","code":"IMPLEMENTATION","name":"Внедрение (Implementation)","track_class":"BPI","order_num":3,"description":null},{"id":"aa09c47e-05df-43f3-8826-3e0a98e73f85","code":"ORGANIZATION","name":"Организация (Organization)","track_class":"BPO","order_num":4,"description":null}],"stageTemplates":[{"id":"43e3f9dc-b2ce-4ab0-b473-c0db09aee707","code":"INIT","name":"Инициация","order_num":1},{"id":"0cbc045f-0caf-463d-8120-262f8c8f3f82","code":"PLAN","name":"Планирование","order_num":2},{"id":"d235da38-e4cf-4b7c-8e53-09a58cd35a07","code":"EXEC","name":"Исполнение","order_num":3},{"id":"eaf5b765-e620-4887-83d3-a9f721ab74d6","code":"MON","name":"Мониторинг","order_num":4},{"id":"7bf2edd2-921f-47dc-a2eb-fc9d2c08681f","code":"CLOSE","name":"Закрытие","order_num":5}],"trackTemplates":[{"id":"a2db9985-3650-492a-b5ca-2c0a2517f268","code":"BPM-1","name":"Опросы и интерпретация","track_class":"BPM","domain":"Research","description":"Количественное исследование ЦА через структурированные анкеты и опросы. Выходы: анкеты, массивы данных, интерпретационные таблицы","management_goal":"Валидация гипотез через количественные данные","key_outputs":"Анкеты, массивы опросных данных, интерпретационные таблицы","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"cba34c91-7c8b-4727-bc89-fc8f291f9818","code":"BPM-2","name":"Интервью с сотрудниками (Tier-1 / Tier-2)","track_class":"BPM","domain":"Research","description":"Глубинные интервью с сотрудниками разных уровней. Tier-1: руководители/CEO, Tier-2: операционные сотрудники. Выявление орг. проблем и противоречий","management_goal":"Выявление внутренних проблем, бутылочных горлышек и точек роста","key_outputs":"Материалы интервью, карта орг. проблем, таблица противоречий, SCQA, SI-3","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"b402c21a-77b8-4bb4-9547-0b736d2f071c","code":"BPM-3","name":"Интервью с клиентами и неклиентами","track_class":"BPM","domain":"Research","description":"Глубинное изучение мотивов выбора/невыбора продуктов через интервью с клиентами, бывшими клиентами, клиентами конкурентов. Модели: MEDDPICC, Bain Pyramid, CJM","management_goal":"Выявление драйверов и барьеров покупки, процессов принятия решений","key_outputs":"Репорты интервью, таблица драйверов/барьеров, матрица CL vs NCL, SI4A-SI6","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"c44c13e2-93a3-4ed2-888b-4693faae402f","code":"BPM-4","name":"Анализ БД и Формула прибыли","track_class":"BPM","domain":"Analytics","description":"Полный цикл анализа клиентских и транзакционных данных. Построение Формулы прибыли, выявление рычагов РВИД. RFM-сегментация, когортный анализ","management_goal":"Построение аналитической модели бизнеса и выявление рычагов роста","key_outputs":"Формула прибыли, набор графиков, интерпретация, SI-0, SI-1B, SI-7, SI-8, SI-9","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"7d70bba1-7785-48bb-9308-b595d040e39f","code":"BPM-5","name":"Тайный покупатель (Secret Shopping)","track_class":"BPM","domain":"Research","description":"Проверка качества работы через скрытые визиты/обращения. Три подвида: B2B (5a), B2C офлайн (5b), Digital (5c)","management_goal":"Объективная оценка качества обслуживания и процессов продаж","key_outputs":"Чек-листы, оценки, отчёт mystery shopping, рекомендации","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"d036386e-60de-4dd0-bbed-ea15c165f8c0","code":"BPM-6","name":"Кабинетный анализ (Desk Research)","track_class":"BPM","domain":"Research","description":"Вторичное исследование рынка, конкурентов и индустрии. Анализ открытых данных, публичных отчетов, сайтов конкурентов, отраслевых рейтингов","management_goal":"Формирование внешнего контекста для стратегических решений","key_outputs":"Аналитический отчет, конкурентные позиции, тренды рынка, гипотезы","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"a9d6b4d3-67bb-414f-9f1e-041b3371377f","code":"BPM-7","name":"Анализ рынка (Market-sizing)","track_class":"BPM","domain":"Analytics","description":"Оценка размера рынка PAM/TAM/SAM/SOM (7A) и анализ по продуктам/отраслям/регионам с Porter-like моделью (7B)","management_goal":"Определение потенциала роста и приоритетных сегментов","key_outputs":"Расчёт PAM/TAM/SAM/SOM, карта сегментов, Porter 5 forces, привлекательность сегментов","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"c6bb9955-37a5-48bb-aaee-e2e39c7d0afd","code":"BPM-8","name":"Анализ бизнес-процессов","track_class":"BPM","domain":"Process","description":"Картирование и анализ операционных процессов. Методологии: SIPOC (уровень 1), IDEF0 (уровень 2), BPMN (уровень 3+). Выявление узких мест и возможностей оптимизации","management_goal":"Выявление неэффективностей и точек оптимизации в текущих процессах","key_outputs":"Диаграммы процессов (SIPOC/IDEF0/BPMN), узкие места, гипотезы оптимизации","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"5b8257bb-6b45-4a8e-b907-f2fa871e560c","code":"BPM-9","name":"Анализ компетенций сотрудников","track_class":"BPM","domain":"HR","description":"Оценка компетенций команды, выявление разрывов. Методы: PAEI, OCA. Анализ потребностей в обучении и развитии","management_goal":"Выявление управленческих проблем на уровне людей и компетенций","key_outputs":"Матрица компетенций, карта разрывов, рекомендации по развитию и найму","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"87fe48d6-73f0-4d15-9b45-5116abd2059c","code":"BPM-10","name":"Анализ CRM","track_class":"BPM","domain":"Sales","description":"Анализ системы управления отношениями с клиентами. Оценка качества данных в CRM, анализ воронки продаж, интеграция стратегического и операционного планирования","management_goal":"Оптимизация процессов продаж и работы с клиентами","key_outputs":"Рекомендации по CRM, оптимизация воронки, модели управления","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"4180d497-ef4a-4db9-8329-156de9a38f3f","code":"BPM-11","name":"Анализ ЦМД (целевая модель данных)","track_class":"BPM","domain":"Data","description":"Проектирование и анализ структуры данных. Определение ключевых сущностей, связей, справочников и правил нормализации. Выделен в отдельный процесс в 2026","management_goal":"Обеспечение готовности данных для аналитики и управления","key_outputs":"Схема ЦМД, рекомендации по настройке данных, готовность к аналитике","is_active":1,"parent_track_id":null,"required_models":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":""},{"id":"c8b9b4fc-3074-42de-96b2-781b5c63764a","code":"BPA-1","name":"Сборка презентации (Slide Intent)","track_class":"BPA","domain":null,"parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"204bf2ac-ba00-48cc-bcb4-06157be26f54","code":"BPI-CHANGE","name":"Управление изменениями","track_class":"BPI","domain":"Change","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"047d9775-83d5-4c9e-aef6-a5e45148aebb","code":"BPI-COMM","name":"Коммуникации","track_class":"BPI","domain":"Communication","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"03382a57-df21-49a0-aab6-7a22c23a6815","code":"BPI-DATA","name":"Данные","track_class":"BPI","domain":"Data","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"6e3ac828-52ea-4a62-aeaf-0d55218cdcd6","code":"BPI-HR","name":"Люди и компетенции","track_class":"BPI","domain":"HR","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"dd71c292-5d7f-415a-b373-c73f0cf86304","code":"BPI-IT","name":"ИТ-системы","track_class":"BPI","domain":"IT","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"bd58582e-b3b3-41a8-8cc8-022bbae65c4f","code":"BPI-KPI","name":"Метрики и KPI","track_class":"BPI","domain":"Metrics","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"cca3394e-85df-4c4a-a22d-0eb89b9e3df4","code":"BPI-ORG","name":"Оргструктура","track_class":"BPI","domain":"Organization","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"b37f3898-24c8-4790-af99-9a40fa659523","code":"BPI-PILOT","name":"Пилотирование","track_class":"BPI","domain":"Pilot","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"17686adf-f1fb-4d51-b334-4a0d6140f4ac","code":"BPI-PROC","name":"Процессы","track_class":"BPI","domain":"Process","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"1d1e3022-b098-4a23-bc94-b99b7e4d9a1c","code":"BPI-RISK","name":"Риски","track_class":"BPI","domain":"Risk","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"1109689b-a4ce-45bb-9a7c-88b64e46b1a9","code":"BPI-TRAIN","name":"Обучение","track_class":"BPI","domain":"Training","parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1},{"id":"35bcf228-ce22-4bc9-bedb-6ebfe2a419e9","code":"BPO-1","name":"Передача методологии","track_class":"BPO","domain":null,"parent_track_id":null,"management_goal":null,"required_models":"","key_outputs":"","qc_mechanism":null,"reuse_artifacts":null,"si_references":"","description":null,"is_active":1}],"fullKitComponents":[{"id":"c0407fe0-41d6-4493-95fe-91e5a4d92cc4","code":"FK-01","name":"Устав проекта","description":null,"is_mandatory":1},{"id":"dea637f1-be08-445f-8b22-d4d062d6d44d","code":"FK-02","name":"Карта стейкхолдеров","description":null,"is_mandatory":1},{"id":"6f06143a-b607-4e4f-a814-1c1e4c554420","code":"FK-03","name":"Периметр (scope)","description":null,"is_mandatory":1},{"id":"fc7a7ec4-73eb-4413-8e86-871dc5120d40","code":"FK-04","name":"Административная шкала","description":null,"is_mandatory":1},{"id":"74ac37bc-2031-48f4-aa3c-627eec36440d","code":"FK-05","name":"Дорожная карта","description":null,"is_mandatory":1},{"id":"a6a8ff57-379d-4c1c-b6c8-09a4dbe13306","code":"FK-06","name":"Бюджет и ресурсный план","description":null,"is_mandatory":1},{"id":"086dc0d2-d154-42e0-a42a-acdce35b706d","code":"FK-07","name":"Матрица рисков","description":null,"is_mandatory":0},{"id":"05aaa548-d7f3-4f42-93ae-9f34e1bac164","code":"FK-08","name":"Коммуникационный план","description":null,"is_mandatory":0},{"id":"b7bfe079-f9dd-49fa-921a-514929dba7d7","code":"FK-09","name":"Финансовая модель","description":null,"is_mandatory":1},{"id":"3ac7e1bd-5056-45bf-ab6f-260eb63531ad","code":"FK-10","name":"Гипотезы и ожидания","description":null,"is_mandatory":0}],"processRules":[{"id":"472c848d-6d02-4996-bf61-ee3e4fb6ea6d","code":"RULE-GATE-INIT-PLAN","name":"Gate INIT→PLAN","rule_type":"STAGE_GATE","scope":"STAGE","applicable_phase":null,"applicable_stage":null,"conditions":null,"actions":null,"default_parameters":null,"description":"Все обязательные критерии должны быть выполнены","is_active":1},{"id":"c625beb5-1420-4cbb-a6fa-615583d6c3dd","code":"RULE-SLA-INIT","name":"SLA для INIT","rule_type":"SLA","scope":"STAGE","applicable_phase":null,"applicable_stage":null,"conditions":null,"actions":null,"default_parameters":null,"description":"INIT ≤7 дней target, 10-12 yellow, >12 red/defect","is_active":1},{"id":"1ed7e240-5148-411c-969c-6b1a493bc249","code":"RULE-ADMIN-REVIEW","name":"Ревизия AdminScale","rule_type":"TRACK_SELECTION","scope":"PROJECT","applicable_phase":null,"applicable_stage":null,"conditions":null,"actions":null,"default_parameters":null,"description":"При получении выводов BPM-5 пересмотреть AdminScale","is_active":1}],"knowledgeItems":[],"tags":[],"projectTypes":["Consulting","Old Delivery","New Delivery","Стратсессия","Марстрат","HR","Аудит","Ритейл Аудит","Экспресс-проект"],"recommendations":[{"id":"90d6e1ac-62c9-4011-a2fd-a1b6954f8679","category":"data","title":"Заполнение данных сотрудников","description":"23 сотрудника в системе не имеют заполненных зарплатных показателей и департаментов. Необходимо заполнить salary_monthly и department для корректного расчёта себестоимости проектов и ставки в час.","status":"backlog","created_at":"2026-02-12T15:17:19.637Z","batch_id":"2e6f0f36-d540-4b73-87d3-28b6ec409b5e"},{"id":"d8d56dba-4946-4043-8d9f-a8b31ed54ec3","category":"finance","title":"Установка стоимостей контрактов для 27 проектов","description":"27 из 36 проектов (75%) не имеют установленной стоимости контракта (total_contract_value). Без этого невозможен расчёт маржинальности, P&L и контроль рентабельности портфеля.","status":"backlog","created_at":"2026-02-12T15:17:19.637Z","batch_id":"2e6f0f36-d540-4b73-87d3-28b6ec409b5e"},{"id":"66d8c78e-e63b-42cc-a834-b8fc8711f1d9","category":"data","title":"Внедрение учёта рабочего времени","description":"В системе 0 записей timeEntries и 0 записей weekly_timesheets. При 36 активных проектах невозможно рассчитать фактическую себестоимость без данных о трудозатратах.","status":"backlog","created_at":"2026-02-12T15:17:19.637Z","batch_id":"2e6f0f36-d540-4b73-87d3-28b6ec409b5e"},{"id":"b1321da3-ef7e-4b2b-b850-8833f9cedd5f","category":"finance","title":"Настройка налоговых режимов и накладных расходов","description":"Ни один проект не имеет установленного tax_rate и overheads. Для расчёта грязной и чистой рентабельности укажите режим (0%/11%/22%) и накладные расходы для 9 проектов с выручкой.","status":"backlog","created_at":"2026-02-12T15:17:19.637Z","batch_id":"2e6f0f36-d540-4b73-87d3-28b6ec409b5e"},{"id":"b5875c5a-8598-4865-b0b5-895974969ba3","category":"process","title":"Настройка дат и зависимостей треков","description":"Треки проектов не имеют start_date/end_date — диаграмма Ганта и критическая цепь невозможны. Начните с 5 ключевых проектов и задайте даты по каждому BPM-треку.","status":"backlog","created_at":"2026-02-12T15:17:19.637Z","batch_id":"2e6f0f36-d540-4b73-87d3-28b6ec409b5e"},{"id":"8bad418c-7f99-40d2-a46a-9c455c8a8971","category":"mgmt","title":"Привязка сотрудников к проектам","description":"23 сотрудника (10xC1, 3xC2, 4xC3, 3xC4, 3xC5) не распределены по проектам. Без назначений невозможен контроль загрузки, utilization rate и ёмкость триажа.","status":"backlog","created_at":"2026-02-12T15:17:19.637Z","batch_id":"2e6f0f36-d540-4b73-87d3-28b6ec409b5e"},{"id":"8baa5c87-c3ba-4baf-90ca-de9af3ada774","category":"team","title":"Распределение сотрудников по департаментам","description":"Оргструктура содержит 7 департаментов, но сотрудники не привязаны. Это влияет на расчёт ФОТ Производства и ёмкость триажа. Распределите всех 23 сотрудников.","status":"backlog","created_at":"2026-02-12T15:17:19.637Z","batch_id":"2e6f0f36-d540-4b73-87d3-28b6ec409b5e"}],"kb_budget":[],"overhead_registry":[],"users":[],"notifications":[]};</script>
<!-- SEED patches removed: data now lives only in Supabase -->
<script>
window.onerror=function(msg,url,line,col,err){
  /* Ignore cross-origin "Script error" from CDN scripts (React/Babel) */
  if(msg==='Script error.'||msg==='Script error'||(line===0&&col===0&&!err))return true;
  var d=document.createElement('div');
  d.style.cssText='position:fixed;top:10px;left:10px;right:10px;z-index:99999;padding:20px;background:#fff0f0;border:3px solid red;border-radius:8px;font-family:monospace;font-size:13px;max-height:50vh;overflow:auto;cursor:pointer;';
  d.innerHTML='<h3 style="color:red;margin:0 0 8px">JS Error <span style="font-size:11px;color:#888">(click to dismiss)</span></h3><pre style="white-space:pre-wrap">'+msg+'\nLine: '+line+', Col: '+col+'</pre>'+(err&&err.stack?'<pre style="font-size:10px;color:#888;margin-top:8px">'+err.stack+'</pre>':'');
  d.onclick=function(){d.remove();};
  document.body.appendChild(d);
};
window.addEventListener('unhandledrejection',function(e){
  var d=document.createElement('div');
  d.style.cssText='position:fixed;top:10px;left:10px;right:10px;z-index:99999;padding:20px;background:#fff0f0;border:3px solid red;border-radius:8px;font-family:monospace;font-size:13px;';
  d.innerHTML='<h3 style="color:red;margin:0 0 8px">Unhandled Promise Rejection</h3><pre style="white-space:pre-wrap">'+String(e.reason)+'</pre>';
  document.body.appendChild(d);
});
</script>
<script type="text/babel">
const {useState,useMemo,useCallback,useEffect,useRef}=React;

/* ===== Supabase Config ===== */
const CODE_VERSION='2.1.0';  // Increment on code updates — never affects data
const _SB_URL='https://yiulozjxqsojvfrpxktw.supabase.co';
const _SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpdWxvemp4cXNvanZmcnB4a3R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MTgzNzIsImV4cCI6MjA4NzA5NDM3Mn0.j9ATXmbzhUfuCjqdjtzbmBQKDRw_MuJhxi9r3ssHI0Y';
const _SB_CFG_KEY='pp_supabase_config';
const _getSbCfg=()=>({url:_SB_URL,key:_SB_KEY});
const _saveSbCfg=(url,key)=>{};
const _initSb=()=>{
  try{return window.supabase?window.supabase.createClient(_SB_URL,_SB_KEY):null;}catch(e){console.warn('Supabase init error',e);return null;}
};
let _sb=_initSb();
const uuid=()=>crypto.randomUUID?crypto.randomUUID():'id-'+Math.random().toString(36).substr(2,12)+Date.now().toString(36);
const fmt=n=>n?Number(n).toLocaleString('ru-RU'):'—';
const fmtD=d=>d?new Date(d).toLocaleDateString('ru-RU',{day:'2-digit',month:'short',year:'numeric'}):'—';
const now=()=>new Date().toISOString();
/* УСН+НДС: кнопка 11% → фактическая ставка 10.47% (5/105 от суммы с НДС) */
const _effTax=(rate)=>{const r=Number(rate)||0;return r===11?10.47:r;};
const statusMap={ACTIVE:'b-active',DRAFT:'b-draft',COMPLETED:'b-completed',PAUSED:'b-paused',ON_HOLD:'b-paused',NOT_STARTED:'b-draft',IN_PROGRESS:'b-active',PLANNED:'b-draft',ACCRUED:'b-warning',PAID:'b-active',MISSING:'b-paused'};
const SB=s=><span className={`badge ${statusMap[s]||'b-draft'}`}>{s}</span>;
const TCB=tc=><span className={`badge b-${(tc||'').toLowerCase()}`}>{tc}</span>;
const calcDaysBetween=(d1,d2)=>{if(!d1||!d2)return 0;const a=new Date(d1);const b=new Date(d2);const diff=Math.abs(b-a);return Math.max(1,Math.ceil(diff/(1000*60*60*24)));};
  const calcPhaseDays=(ph)=>{const hd=Number(ph.hold_days)||0;if(ph.status==='COMPLETED'&&ph.started_at&&ph.completed_at)return Math.max(0,calcDaysBetween(ph.started_at,ph.completed_at)-hd);if(ph.status==='IN_PROGRESS'&&ph.started_at)return Math.max(0,calcDaysBetween(ph.started_at,new Date().toISOString())-hd);if(ph.status==='ON_HOLD'&&ph.started_at)return Math.max(0,calcDaysBetween(ph.started_at,ph.hold_started_at||new Date().toISOString())-hd);return 0;};
  const calcStageDays=(st)=>{const hd=Number(st.hold_days)||0;if(st.status==='COMPLETED'&&st.started_at&&st.completed_at)return Math.max(0,calcDaysBetween(st.started_at,st.completed_at)-hd);if(st.status==='IN_PROGRESS'&&st.started_at)return Math.max(0,calcDaysBetween(st.started_at,new Date().toISOString())-hd);if(st.status==='ON_HOLD'&&st.started_at)return Math.max(0,calcDaysBetween(st.started_at,st.hold_started_at||new Date().toISOString())-hd);return 0;};
  const calcPnlHealth=(proj,persons)=>{
    const _allPaymentsSum=(proj.payments||[]).reduce((s,x)=>s+(Number(x.amount)||0),0);
    const _tcv=(proj.project_type==='New Delivery'||proj.project_type==='ФК')?_allPaymentsSum:(Number(proj.total_contract_value)||Number(proj.fixed_price)||0);
    const _paidSum=(proj.payments||[]).filter(pm=>pm.status==='PAID').reduce((s,x)=>s+(Number(x.amount)||0),0);
    const _accruedSum=(proj.payments||[]).filter(pm=>pm.status==='ACCRUED').reduce((s,x)=>s+(Number(x.amount)||0),0);
    const _plannedSum=(proj.payments||[]).reduce((s,x)=>s+(Number(x.amount)||0),0);
    const _factualRev=_paidSum+_accruedSum;
    const rev=_tcv||_factualRev||_plannedSum||0;
    if(rev===0)return {health:"gray",label:"Нет данных",margin:0,marginPct:0,revNet:0,costProd:0,costAll:0,costC5:0,ohTotal:0,grossProfit:0,grossPct:0,dirtyProfit:0,cleanProfit:0,dirtyPct:0,cleanPct:0,paidSum:0,accruedSum:0,plannedSum:0,factualRev:0};
    const tr=_effTax(proj.tax_rate);
    const revNet=Math.round(rev*(1-tr/100));
    const entries=proj.timeEntries||[];
    let costAll=0,costProd=0;
    const _persons=persons||[];
    entries.forEach(te=>{
      const per=_persons.find(x=>x.id===te.person_id);
      if(!per||!per.salary_monthly)return;
      const dt=te.date?new Date(te.date):new Date();
      const dy=dt.getDay();const df=dt.getDate()-dy+(dy===0?-6:1);
      const wk=new Date(dt.getFullYear(),dt.getMonth(),df).toISOString().slice(0,10);
      const we=(per.weekly_timesheets||[]).find(w=>w.week_start===wk);
      const oh=we?we.open_hours:40;
      const rate=oh>0?getPersonSalaryAtDate(per,te.date||new Date().toISOString().slice(0,10))/(oh*4.33):0;
      const cost=rate*(Number(te.hours)||0);
      costAll+=cost;if(per.grade!=="C5")costProd+=cost;
    });
    costAll=Math.round(costAll);costProd=Math.round(costProd);
    const ohTotal=(proj.overheads||[]).reduce((s,x)=>s+(Number(x.amount)||0),0);
    const grossProfit=revNet-ohTotal;
    const dirtyProfit=grossProfit-costProd;
    const costC5=costAll-costProd;
    const cleanProfit=dirtyProfit-costC5;
    const grossPct=revNet>0?Math.round(grossProfit/revNet*100):0;
    const dirtyPct=revNet>0?Math.round(dirtyProfit/revNet*100):0;
    const cleanPct=revNet>0?Math.round(cleanProfit/revNet*100):0;
    let health="green";
    if(dirtyPct<75)health="red";else if(dirtyPct<80)health="yellow";
    const label=health==="green"?"Норма":health==="yellow"?"Внимание":"Низкая";
    return {health,label,revNet,costProd,costAll,costC5,ohTotal,grossProfit,grossPct,dirtyProfit,cleanProfit,dirtyPct,cleanPct,paidSum:_paidSum,accruedSum:_accruedSum,plannedSum:_plannedSum,factualRev:_factualRev};
  };
  const addDays=(d,n)=>{const dt=new Date(d);dt.setDate(dt.getDate()+n);return dt.toISOString().slice(0,10);};

  /* === Phase Revenue Allocation (Old Delivery model) === */
  const calcPhaseRevenue=(proj)=>{
    const payments=(proj.payments||[]).filter(pm=>pm.status==='PAID').sort((a,b)=>(a.tranche_number||0)-(b.tranche_number||0));
    const tr=_effTax(proj.tax_rate);
    let revMA=0,revImpl=0,revOrg=0;
    payments.forEach((pm,i)=>{
      const amt=Math.round((Number(pm.amount)||0)*(1-tr/100));
      if(i===0){revMA+=amt;}
      else if(i===1){revMA+=Math.round(amt/2);revImpl+=Math.round(amt/2);}
      else if(i===2){revImpl+=Math.round(amt/2);revOrg+=Math.round(amt/2);}
      else{revOrg+=amt;}
    });
    return {revMA,revImpl,revOrg};
  };

  /* === Person Efficiency Index === */
  const calcPersonIndex=(person,projects,allPersons)=>{
    if(!person||person.grade==='C5')return null;
    let totalImputed=0,totalBillableHrs=0;
    const getRate=(per,dateStr)=>{
      if(!per||!per.salary_monthly)return 0;
      const dt=dateStr?new Date(dateStr):new Date();
      const dy=dt.getDay();const df=dt.getDate()-dy+(dy===0?-6:1);
      const wk=new Date(dt.getFullYear(),dt.getMonth(),df).toISOString().slice(0,10);
      const we=(per.weekly_timesheets||[]).find(w=>w.week_start===wk);
      const oh=we?we.open_hours:40;
      return oh>0?getPersonSalaryAtDate(per,dateStr||new Date().toISOString().slice(0,10))/(oh*4.33):0;
    };

    projects.forEach(proj=>{
      const phaseRev=calcPhaseRevenue(proj);
      const entries=proj.timeEntries||[];
      const phases=['MINING_ASSEMBLING','IMPLEMENTATION','ORGANISATION'];
      const phData={};
      phases.forEach(ph=>{
        const phEntries=entries.filter(te=>(te.work_phase||'MINING_ASSEMBLING')===ph);
        let hrsNonC5=0,costC5=0;
        phEntries.forEach(te=>{
          const per=allPersons.find(x=>x.id===te.person_id);
          if(!per)return;
          const h=Number(te.hours)||0;
          if(per.grade==='C5'){costC5+=getRate(per,te.date)*h;}
          else{hrsNonC5+=h;}
        });
        const rev=ph==='MINING_ASSEMBLING'?phaseRev.revMA:ph==='IMPLEMENTATION'?phaseRev.revImpl:phaseRev.revOrg;
        const netRev=rev-Math.round(costC5);
        phData[ph]={hrsNonC5,ratePerHr:hrsNonC5>0?netRev/hrsNonC5:0};
      });

      entries.filter(te=>te.person_id===person.id).forEach(te=>{
        const ph=te.work_phase||'MINING_ASSEMBLING';
        const h=Number(te.hours)||0;
        totalImputed+=h*(phData[ph]?.ratePerHr||0);
        totalBillableHrs+=h;
      });
    });

    const wts=person.weekly_timesheets||[];
    const totalOpened=wts.reduce((s,w)=>s+(w.open_hours||0),0);
    const avgOpen=wts.length>0?totalOpened/wts.length:40;
    const hourlyCost=person.salary_monthly&&avgOpen>0?person.salary_monthly/(avgOpen*4.33):0;
    const billableCost=hourlyCost*totalBillableHrs;
    const nonBillableHrs=Math.max(0,totalOpened-totalBillableHrs);
    const totalCostAll=hourlyCost*(totalBillableHrs+nonBillableHrs);
    const idx1=billableCost>0?totalImputed/billableCost:0;
    const idx2=totalCostAll>0?totalImputed/totalCostAll:0;

    return {
      imputed:Math.round(totalImputed),
      billableHrs:totalBillableHrs,
      nonBillableHrs:Math.round(nonBillableHrs),
      hourlyCost:Math.round(hourlyCost),
      billableCost:Math.round(billableCost),
      idx1:Math.round(idx1*100)/100,
      idx2:Math.round(idx2*100)/100,
      avgOpen:Math.round(avgOpen)
    };
  };
  const calcAutoSchedule=(proj)=>{
    const phases=proj.phases||[];
    const tracks=proj.tracks||[];
    if(tracks.length===0)return[];
    const today=new Date();today.setHours(0,0,0,0);
    const todayStr=today.toISOString().slice(0,10);
    const rawStartD=proj.start_date?new Date(proj.start_date):today;
    const startD=rawStartD<today?today:rawStartD;
    const rawEndD=proj.target_end_date?new Date(proj.target_end_date):null;
    const endD=rawEndD&&rawEndD>startD?rawEndD:new Date(startD.getTime()+98*86400000);
    const totalDays=Math.max(1,Math.ceil((endD-startD)/86400000));
    const BUFFER_PCT=0.33;
    // Normative phase durations
    const s1=Math.round(totalDays*0.57);
    const s2=Math.round(totalDays*0.22);
    const s3=totalDays-s1-s2;
    const phaseNorms={MINING:Math.round(s1*0.5),ASSEMBLING:Math.round(s1*0.5),IMPLEMENTATION:s2,ORGANIZATION:s3};
    // Phase date ranges (sequential)
    const phaseRanges={};
    let cursor=startD.toISOString().slice(0,10);
    ['MINING','ASSEMBLING','IMPLEMENTATION','ORGANIZATION'].forEach(code=>{
      const dur=phaseNorms[code]||Math.round(totalDays/4);
      const phStart=cursor;
      const phEnd=addDays(phStart,dur-1);
      const workEnd=addDays(phStart,Math.round(dur*(1-BUFFER_PCT))-1);
      phaseRanges[code]={start:phStart,end:phEnd,workEnd,dur};
      cursor=addDays(phEnd,1);
    });
    // Map track_class → phase_code
    const classToPhase={'BPM':'MINING','BPA':'ASSEMBLING','BPI':'IMPLEMENTATION','BPO':'ORGANIZATION'};
    // Build results
    const results=[];
    // Sort tracks: those without predecessors first, then with
    const getPredsOf=(t)=>(t.dependencies||[]).map(d=>d.target_track_id).filter(Boolean);
    /* All deps treated as finish→start (predecessor must finish before successor starts) */
    // Topological sort
    const scheduled={};
    const visit=(t)=>{
      if(scheduled[t.id])return;
      const preds=getPredsOf(t);
      preds.forEach(pid=>{const pt=tracks.find(x=>x.id===pid);if(pt&&!scheduled[pt.id])visit(pt);});
      const phCode=classToPhase[(t.track_class||'').toUpperCase()]||'MINING';
      const range=phaseRanges[phCode];
      if(!range){scheduled[t.id]={start:proj.start_date,end:proj.start_date};return;}
      let trackStart=range.start;
      let trackEnd=range.end; // late finish with buffer
      // If has predecessor, start from predecessor end + 1
      if(preds.length>0){
        let maxPredEnd=range.start;
        preds.forEach(pid=>{
          const sch=scheduled[pid];
          if(sch&&sch.end>maxPredEnd)maxPredEnd=sch.end;
          // Also check existing dates
          const pt=tracks.find(x=>x.id===pid);
          if(pt&&pt.end_date&&pt.end_date>maxPredEnd)maxPredEnd=pt.end_date;
        });
        trackStart=addDays(maxPredEnd,1);
        // If predecessor pushes us beyond phase, clamp but still show
        if(trackStart>range.end)trackStart=range.end;
      }
      // End = start + track duration (capped at phase late finish)
      const dur=calcTrackDuration(t);
      trackEnd=addDays(trackStart,dur-1);
      // Cap at phase late finish
      if(trackEnd>range.end)trackEnd=range.end;
      // If start > end (edge case), fix
      if(trackStart>trackEnd)trackEnd=trackStart;
      scheduled[t.id]={start:trackStart,end:trackEnd};
      results.push({trackId:t.id,start_date:trackStart,end_date:trackEnd,phaseCode:phCode,auto:true});
    };
    tracks.forEach(t=>visit(t));
    return results;
  };
  const calcProjectBuffer=(proj)=>{
    const phases=proj.phases||[];
    const startD=proj.start_date?new Date(proj.start_date):null;
    const endD=proj.target_end_date?new Date(proj.target_end_date):null;
    const totalDays=startD&&endD?Math.max(1,Math.ceil((endD-startD)/(86400000))):98;
    const totalWeeks=totalDays/7;
    const BUFFER_PCT=0.33;
    // Normative split: Mining+Assembling=57%, Implementation=22%, Organization=21%
    const stage1Norm=Math.round(totalDays*0.57);
    const stage2Norm=Math.round(totalDays*0.22);
    const stage3Norm=totalDays-stage1Norm-stage2Norm;
    const norms={MINING:Math.round(stage1Norm*0.5),ASSEMBLING:Math.round(stage1Norm*0.5),IMPLEMENTATION:stage2Norm,ORGANIZATION:stage3Norm};
    const buffers={MINING:Math.round(Math.max(0,norms.MINING-7)*BUFFER_PCT),ASSEMBLING:Math.round(Math.max(0,norms.ASSEMBLING-7)*BUFFER_PCT),IMPLEMENTATION:Math.round(stage2Norm*BUFFER_PCT),ORGANIZATION:Math.round(stage3Norm*BUFFER_PCT)};
    const workDays={MINING:norms.MINING-buffers.MINING,ASSEMBLING:norms.ASSEMBLING-buffers.ASSEMBLING,IMPLEMENTATION:norms.IMPLEMENTATION-buffers.IMPLEMENTATION,ORGANIZATION:norms.ORGANIZATION-buffers.ORGANIZATION};
    // Per-stage normative: INIT+PLAN=2 days for Mining(7d), 1d each for others
    const stageNorms=(phCode,stCode,phNormDays)=>{
      const phWork=phNormDays*(1-BUFFER_PCT);
      if(phCode==="MINING"){if(stCode==="INIT")return 6;if(stCode==="PLAN")return 1;const rem=phWork-7;return Math.max(1,Math.round(rem/3));}
      if(stCode==="INIT"||stCode==="PLAN")return 1;
      const rem=phWork-2;return Math.max(1,Math.round(rem/3));
    };
    const today=new Date();
    const elapsedDays=startD?Math.max(0,Math.ceil((today-startD)/86400000)):0;
    const remainingDays=Math.max(0,totalDays-elapsedDays);
    // Compute actual days spent per phase
    const phaseResults=phases.map(ph=>{
      const code=ph.phase_code;
      const normD=norms[code]||Math.round(totalDays/4);
      const bufD=buffers[code]||Math.round(normD*BUFFER_PCT);
      const workD=normD-bufD;
      const actualD=calcPhaseDays(ph);
      const overWork=Math.max(0,actualD-workD);
      const bufUsed=Math.min(overWork,bufD);
      const bufRemain=bufD-bufUsed;
      const overdue=Math.max(0,actualD-normD);
      const stageResults=(ph.stages||[]).map(st=>{
        const sNorm=stageNorms(code,st.stage_code,normD);
        const sActual=calcStageDays(st);
        const sBuf=Math.round(sNorm*BUFFER_PCT);
        const sWork=sNorm-sBuf;
        return {code:st.stage_code,name:st.stage_name,status:st.status,norm:sNorm,actual:sActual,work:sWork,buffer:sBuf,overdue:Math.max(0,sActual-sNorm)};
      });
      return {code,name:ph.phase_name,status:ph.status,norm:normD,work:workD,buffer:bufD,actual:actualD,bufUsed,bufRemain,overdue,stages:stageResults};
    });
    // Total buffer consumption
    const totalBuf=phaseResults.reduce((s,r)=>s+r.buffer,0);
    const totalBufUsed=phaseResults.reduce((s,r)=>s+r.bufUsed,0);
    const totalBufRemain=totalBuf-totalBufUsed;
    const totalOverdue=phaseResults.reduce((s,r)=>s+r.overdue,0);
    const totalActual=phaseResults.reduce((s,r)=>s+r.actual,0);
    const bufPct=totalBuf>0?Math.round(totalBufUsed/totalBuf*100):0;
    let health="ok";
    if(bufPct>66)health="danger";else if(bufPct>33)health="warn";
    if(totalOverdue>0)health="overdue";
    return {totalDays,totalWeeks:Math.round(totalWeeks*10)/10,elapsedDays,remainingDays,totalBuf,totalBufUsed,totalBufRemain,totalOverdue,totalActual,bufPct,health,phases:phaseResults,BUFFER_PCT};
  };

  /* === Milestones (Этапы реализации) for Old Delivery === */
  const calcProjectMilestones=(proj)=>{
    if(proj.project_type!=='Old Delivery')return[];
    const phases=proj.phases||[];
    const payments=(proj.payments||[]).filter(pm=>!pm.prior_year);
    const totalTranches=payments.length;

    const phByCode=(code)=>phases.find(ph=>ph.phase_code===code);
    const phCompleted=(code)=>{const ph=phByCode(code);return ph&&ph.status==='COMPLETED';};
    const phEndDate=(code)=>{const ph=phByCode(code);return ph?(ph.actual_end||ph.period_end||''):''};

    /* Find payment linked to a milestone's phases */
    const findPayment=(phaseCodes,fallbackTranche)=>{
      /* 1. By phase_id linking */
      const phaseIds=phaseCodes.map(c=>{const ph=phByCode(c);return ph?ph.id:null;}).filter(Boolean);
      let pm=payments.find(p=>p.phase_id&&phaseIds.includes(p.phase_id));
      if(pm)return pm;
      /* 2. Fallback by tranche_number */
      if(fallbackTranche)pm=payments.find(p=>p.tranche_number===fallbackTranche);
      return pm||null;
    };

    const milestoneStatus=(allPhasesCompleted,payment)=>{
      if(!payment)return allPhasesCompleted?'DELIVERED':'PLANNED';
      if(allPhasesCompleted&&payment.status==='PAID')return'PAID';
      if(allPhasesCompleted&&(payment.status==='ACCRUED'||payment.status==='PAID'))return'DELIVERED';
      return'PLANNED';
    };

    const buildMs=(name,codes,fallbackTr)=>{
      const allDone=codes.every(c=>phCompleted(c));
      const pm=findPayment(codes,fallbackTr);
      const st=milestoneStatus(allDone,pm);
      const lastPhaseEnd=codes.map(c=>phEndDate(c)).filter(Boolean).sort().pop()||'';
      const deliveredDate=st==='DELIVERED'||st==='PAID'?
        [lastPhaseEnd,pm?.accrued_date||''].filter(Boolean).sort().pop()||'':'';
      const paidDate=st==='PAID'?(pm?.actual_date||pm?.accrued_date||''):'';
      return{name,phases:codes,phasesCompleted:allDone,
        payment:pm?{amount:Number(pm.amount)||0,status:pm.status,planned_date:pm.planned_date||'',accrued_date:pm.accrued_date||'',actual_date:pm.actual_date||''}:null,
        planned_month:pm?.planned_date?.slice(0,7)||'',
        delivered_date:deliveredDate,paid_date:paidDate,status:st};
    };

    const result=[];

    /* Milestone 1: Mining & Assembling — always present for Old Delivery */
    result.push(buildMs('Добыча и Сборка',['MINING','ASSEMBLING'],2));

    if(totalTranches>3){
      /* 4+ tranches: separate milestones for Impl and Org */
      result.push(buildMs('Внедрение',['IMPLEMENTATION'],3));
      result.push(buildMs('Организация',['ORGANIZATION'],4));
    }else if(totalTranches===3){
      /* 3 tranches: tranche #3 covers both Impl + Org as one combined milestone */
      result.push(buildMs('Внедрение и Организация',['IMPLEMENTATION','ORGANIZATION'],3));
    }
    /* If <=2 tranches, only milestone 1 exists */

    return result;
  };

    /* === ATS-based phase date calculation === */
    const autoCalcPhaseDatesFromATS=(proj)=>{
      if(!proj.ats_date||!proj.start_date)return null;
      const ats=new Date(proj.ats_date);
      const start=new Date(proj.start_date);
      const addDays=(d,n)=>{const r=new Date(d);r.setDate(r.getDate()+n);return r;};
      const fmtISO=d=>d.toISOString().slice(0,10);
      const assemblyEnd=ats;
      const assemblyStart=addDays(ats,-7);
      const miningEnd=addDays(assemblyStart,-1);
      const miningStart=start;
      const miningTotalDays=Math.max(0,Math.ceil((miningEnd-miningStart)/(1000*60*60*24)));
      const initPlanDays=7;/* normative INIT+PLAN */
      const miningRemaining=Math.max(0,miningTotalDays-initPlanDays);
      const miningBuffer=Math.round(miningRemaining/3);
      const miningWork=miningRemaining-miningBuffer;
      return {mining:{start:fmtISO(miningStart),end:fmtISO(miningEnd),totalDays:miningTotalDays,initPlan:initPlanDays,work:miningWork,buffer:miningBuffer},assembling:{start:fmtISO(assemblyStart),end:fmtISO(assemblyEnd),totalDays:7}};
    };
    const syncPhaseDatesFromATS=(proj)=>{
      const calc=autoCalcPhaseDatesFromATS(proj);
      if(!calc)return proj;
      const phases=(proj.phases||[]).map(ph=>{
        const code=(ph.phase_code||'').toUpperCase();
        if(code==='MINING')return {...ph,period_start:calc.mining.start,period_end:calc.mining.end};
        if(code==='ASSEMBLING')return {...ph,period_start:calc.assembling.start,period_end:calc.assembling.end};
        return ph;
      });
      return {...proj,phases};
    };
  const phCls=c=>{if(!c)return '';const u=c.toUpperCase();return u.includes('MINING')||u.includes('BPM')?'mining':u.includes('ASSEMBL')||u.includes('BPA')?'assembling':u.includes('IMPL')||u.includes('BPI')?'implementation':'organization';};

const PHASE_DOC_TEMPLATES={
  MINING:[
    {key:'brief',name:'Бриф / Запрос клиента',required:true},
    {key:'org_table',name:'Орг. таблица',required:true},
    {key:'interview_guide',name:'Гайд интервью',required:true},
    {key:'questionnaire',name:'Анкеты / Опросники',required:false},
    {key:'scqa',name:'SCQA',required:true},
    {key:'data_request',name:'Запрос данных',required:false}
  ],
  ASSEMBLING:[
    {key:'analytics_report',name:'Аналитический отчёт',required:true},
    {key:'problem_map',name:'Карта проблем',required:true},
    {key:'cjm',name:'CJM / Портреты',required:false},
    {key:'positioning',name:'Позиционирование / Стратегия',required:true},
    {key:'storyline',name:'Сторилайн',required:true},
    {key:'storyboard',name:'Сториборд',required:false}
  ],
  IMPLEMENTATION:[
    {key:'roadmap',name:'Дорожная карта',required:true},
    {key:'action_plan',name:'Action Plan',required:true},
    {key:'tz',name:'ТЗ / Спецификация',required:false},
    {key:'prototype',name:'Прототип / Макеты',required:false},
    {key:'finmodel',name:'Финмодель',required:false},
    {key:'reglament',name:'Регламенты / Стандарты',required:false}
  ],
  ORGANIZATION:[
    {key:'final_pres',name:'Финальная презентация',required:true},
    {key:'act',name:'Акт выполненных работ',required:true},
    {key:'training',name:'Обучающие материалы',required:false},
    {key:'handover',name:'Передаточный пакет',required:true},
    {key:'case_study',name:'Кейс для портфолио',required:false},
    {key:'feedback',name:'Обратная связь клиента',required:false}
  ]
};
const getPhaseDocsState=(p,phaseCode)=>{
  const templates=PHASE_DOC_TEMPLATES[phaseCode]||[];
  const saved=(p.phase_docs||{})[phaseCode]||{};
  return templates.map(t=>{
    const doc=saved[t.key]||{};
    return {...t,status:doc.status||'NOT_STARTED',url:doc.url||'',notes:doc.notes||'',file_name:doc.file_name||'',uploaded_at:doc.uploaded_at||''};
  });
};
const ADMIN_SCALE_SECTIONS=[
  {key:'goal',num:1,title:'Цель',hint:'Бизнес-цели проекта',autoCheck:p=>(p.hypothesisBoard?.goals||[]).length>0,autoLabel:g=>{const gl=g.hypothesisBoard?.goals||[];return gl.length>0?gl.map(x=>x.title).join(', '):'Нет целей'}},
  {key:'purpose',num:2,title:'Замысел',hint:'Ключевой замысел и ценность для клиента',autoCheck:p=>!!(p.notes||p.description||'').trim(),autoLabel:p=>'Из описания проекта'},
  {key:'policy',num:3,title:'Политика',hint:'Организационные правила и стандарты',autoCheck:()=>false,autoLabel:()=>''},
  {key:'plans',num:4,title:'Планы',hint:'Стадии и фазы работ',autoCheck:p=>(p.phases||[]).length>0,autoLabel:p=>{const ph=p.phases||[];const done=ph.filter(x=>x.status==='COMPLETED').length;return 'Фаз: '+ph.length+', завершено: '+done;}},
  {key:'programs',num:5,title:'Программы',hint:'Треки BPM и проверки гипотез',autoCheck:p=>(p.tracks||[]).length>0,autoLabel:p=>{const bpm=(p.tracks||[]).filter(t=>(t.track_class||'').toUpperCase()==='BPM').length;return 'Треков: '+(p.tracks||[]).length+', BPM: '+bpm;}},
  {key:'tasks',num:6,title:'Задачи',hint:'Список задач и действий',autoCheck:p=>(p.tasks||[]).length>0,autoLabel:p=>{const done=(p.tasks||[]).filter(t=>t.status==='DONE'||t.status==='COMPLETED').length;return 'Задач: '+(p.tasks||[]).length+', выполнено: '+done;}},
  {key:'vfp',num:7,title:'ЦКП',hint:'Ценный конечный продукт (Definition of Done)',autoCheck:()=>false,autoLabel:()=>''},
  {key:'ideal',num:8,title:'Идеальная картина',hint:'Целевое состояние после проекта',autoCheck:()=>false,autoLabel:()=>''},
  {key:'stats',num:9,title:'Статистики',hint:'Опережающие и запаздывающие метрики',autoCheck:p=>(p.hypothesisBoard?.goals||[]).some(g=>(g.metrics||[]).length>0),autoLabel:p=>{const mc=(p.hypothesisBoard?.goals||[]).reduce((s,g)=>s+(g.metrics||[]).length,0);return 'Метрик: '+mc;}}
];
const COMPETENCY_MODEL=[
{key:'data_analysis',name:'Сбор и анализ данных',short:'Данные'},
{key:'communication',name:'Коммуникация',short:'Комм.'},
{key:'presentations',name:'Создание презентаций',short:'През.'},
{key:'models',name:'Работа с моделями',short:'Модели'},
{key:'speaking',name:'Выступление',short:'Выст.'},
{key:'project_mgmt',name:'Работа с проектами',short:'Проекты'},
{key:'leadership',name:'Лидерство',short:'Лидер.'},
{key:'consulting',name:'Консультирование клиентов',short:'Конс.'}
];
const BPM_EXP_LEVELS=[{key:0,label:'—',short:'—'},{key:1,label:'Учусь',short:'Уч'},{key:2,label:'Новичок',short:'Нов'},{key:3,label:'Профи',short:'Про'},{key:4,label:'Эксперт',short:'Эксп'}];
/* DEP_TYPES removed — simple predecessor/successor model */
const TRACK_NORM_DAYS={
  'BPM-1':{base:7,paramLabel:null,calc:()=>7},
  'BPM-2':{base:null,paramLabel:'Интервью',paramDefault:10,calc:(n)=>Math.ceil((n||10)*1/2)},
  'BPM-3':{base:null,paramLabel:'Интервью',paramDefault:8,calc:(n)=>Math.ceil((n||8)*1/4)},
  'BPM-4':{base:7,paramLabel:null,calc:()=>7},
  'BPM-5':{base:5,paramLabel:null,calc:()=>5},
  'BPM-6':{base:2,paramLabel:null,calc:()=>2},
  'BPM-7':{base:2,paramLabel:null,calc:()=>2},
  'BPM-8':{base:2,paramLabel:null,calc:()=>2},
  'BPM-9':{base:2,paramLabel:null,calc:()=>2},
  'BPM-10':{base:2,paramLabel:null,calc:()=>2},
  'BPM-11':{base:2,paramLabel:null,calc:()=>2},
  'BPA-1':{base:7,paramLabel:null,calc:()=>7},
  'BPI-CHANGE':{base:14,paramLabel:null,calc:()=>14},
  'BPI-COMM':{base:7,paramLabel:null,calc:()=>7},
  'BPI-DATA':{base:7,paramLabel:null,calc:()=>7},
  'BPI-HR':{base:7,paramLabel:null,calc:()=>7},
  'BPI-IT':{base:10,paramLabel:null,calc:()=>10},
  'BPI-KPI':{base:5,paramLabel:null,calc:()=>5},
  'BPI-ORG':{base:7,paramLabel:null,calc:()=>7},
  'BPI-PILOT':{base:14,paramLabel:null,calc:()=>14},
  'BPI-PROC':{base:7,paramLabel:null,calc:()=>7},
  'BPI-RISK':{base:3,paramLabel:null,calc:()=>3},
  'BPI-TRAIN':{base:5,paramLabel:null,calc:()=>5},
  'BPO-1':{base:5,paramLabel:null,calc:()=>5}
};
const calcTrackDuration=(t)=>{const norm=TRACK_NORM_DAYS[t.track_code];if(!norm)return t.norm_days||3;if(norm.paramLabel&&t.track_param){return norm.calc(Number(t.track_param));}return norm.calc();};
const TRACK_COMP_MAP={
  'BPM-1':{data_analysis:5,communication:4,presentations:2},
  'BPM-2':{communication:6,data_analysis:3,consulting:4},
  'BPM-3':{communication:6,consulting:5,data_analysis:3},
  'BPM-4':{data_analysis:6,models:4},
  'BPM-5':{communication:4,consulting:3,data_analysis:3},
  'BPM-6':{data_analysis:5,models:3},
  'BPM-7':{data_analysis:6,models:5},
  'BPM-8':{models:5,data_analysis:4,project_mgmt:3},
  'BPM-9':{communication:4,consulting:3,data_analysis:3,leadership:2},
  'BPM-10':{data_analysis:5,models:3},
  'BPM-11':{data_analysis:5,models:4},
  'BPA-1':{presentations:6,data_analysis:3,communication:4,models:3},
  'BPI-CHANGE':{leadership:5,communication:5,consulting:4,project_mgmt:4},
  'BPI-COMM':{communication:6,presentations:4,speaking:4},
  'BPI-DATA':{data_analysis:6,models:4},
  'BPI-HR':{leadership:4,communication:4,consulting:3},
  'BPI-IT':{models:4,data_analysis:3,project_mgmt:3},
  'BPI-KPI':{data_analysis:5,models:5,project_mgmt:3},
  'BPI-ORG':{leadership:5,models:4,consulting:3},
  'BPI-PILOT':{project_mgmt:5,communication:3,consulting:3},
  'BPI-PROC':{models:5,project_mgmt:4,data_analysis:3},
  'BPI-RISK':{data_analysis:4,models:4,project_mgmt:3},
  'BPI-TRAIN':{speaking:5,presentations:4,communication:4},
  'BPO-1':{consulting:5,communication:5,presentations:4,speaking:4,leadership:3}
};
const COMP_LEVELS=['2 мес.','6 мес.','1 год','2 года','5 лет','10 лет','10+ лет'];
const PAEI_AXES=[{key:'p',label:'P',name:'Producer',color:'#22c55e'},{key:'a',label:'A',name:'Administrator',color:'#3b82f6'},{key:'e',label:'E',name:'Entrepreneur',color:'#f59e0b'},{key:'i',label:'I',name:'Integrator',color:'#ef4444'}];
const HR_SECTIONS=[{key:'Найм',icon:'🎯',color:'#0ea5e9'},{key:'Удержание',icon:'🤝',color:'#8b5cf6'},{key:'Скорость потока частиц',icon:'⚡',color:'#f59e0b'},{key:'Работа с техникой',icon:'🖥️',color:'#64748b'}];
const SALES_SECTIONS=[{key:'Обработка заявок и КП',icon:'📝',color:'#0284c7'},{key:'Контент и дистрибуция',icon:'📣',color:'#7c3aed'},{key:'ABM',icon:'🎯',color:'#db2777'},{key:'Работа с партнёрами',icon:'🤝',color:'#059669'},{key:'Вводные услуги',icon:'🚀',color:'#ea580c'}];
const calcPaeiCode=(p)=>{const axes=PAEI_AXES.map(ax=>{const v=(p.paei||{})[ax.key]||0;return v>=6?ax.label.toUpperCase():v>=3?ax.label.toLowerCase():'-';});return axes.join('');};
const calcCompAvg=(p)=>{const c=p.competencies||{};const vals=COMPETENCY_MODEL.map(cm=>c[cm.key]||0).filter(v=>v>0);return vals.length?Math.round(vals.reduce((s,v)=>s+v,0)/vals.length*10)/10:0;};

const calcAdminScale=(p)=>{
  const as=p.admin_scale||{};
  const sections=ADMIN_SCALE_SECTIONS.map(s=>{
    const hasNotes=!!(as[s.key]||'').trim();
    const autoFilled=s.autoCheck(p);
    const filled=hasNotes||autoFilled;
    return {...s,hasNotes,autoFilled,filled,notes:as[s.key]||'',autoText:autoFilled?s.autoLabel(p):''};
  });
  const filledCount=sections.filter(s=>s.filled).length;
  const pct=Math.round(filledCount/sections.length*100);
  return {sections,filledCount,total:sections.length,pct};
};
const _calcNdEnd=(start,n,isQ)=>{if(!start||!n||Number(n)<=0)return '';const d=new Date(start);d.setMonth(d.getMonth()+(isQ?3:1)*Number(n));d.setDate(d.getDate()-1);return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');};
/* Next ND period end: month-based offsets */
const getNextNDPeriodEnd=(proj)=>{
  if(proj.project_type!=='New Delivery'||!proj.nd_period_start)return null;
  const ps=new Date(proj.nd_period_start);const isQ=(proj.nd_payment_period||'quarterly')==='quarterly';
  const n=Number(proj.nd_num_periods)||0;const ms=isQ?3:1;
  const today=new Date();today.setHours(0,0,0,0);
  for(let i=0;i<n;i++){const pe=new Date(ps);pe.setMonth(pe.getMonth()+(i+1)*ms);pe.setDate(pe.getDate()-1);if(pe>=today)return pe;}
  return null;
};
const calcTriage=(p)=>{const curPhase=(p.phases||[]).find(ph=>ph.status==='IN_PROGRESS');const targetEnd=p.target_end_date||p.end_date||'';const ndEnd=getNextNDPeriodEnd(p);const endDate=ndEnd||( targetEnd?new Date(targetEnd):null);const today=new Date();const daysRemaining=endDate?Math.ceil((endDate-today)/(1000*60*60*24)):null;let urgency=null;if(p._urgency){urgency=Number(p._urgency);}else if(daysRemaining!==null){urgency=daysRemaining<=20?3:daysRemaining>=60?1:2;}const bpmCount=(p.tracks||[]).filter(t=>(t.track_class||'').toUpperCase()==='BPM').length;const scale=p._scale?Number(p._scale):(bpmCount>=10?3:bpmCount>=5?2:1);const costPer=(Number(p.total_contract_value)||Number(p.contract_value)||0)/3;const cost=p._cost?Number(p._cost):(costPer>550000?3:costPer===550000?2:costPer>0?1:null);const complexity=p._complexity||p.complexity||null;const priorityGD=p._priority||p.priority_gd||null;const vals=[];if(urgency!==null)vals.push({v:urgency,w:1.5});if(scale)vals.push({v:scale,w:1});if(cost!==null)vals.push({v:cost,w:1});if(complexity)vals.push({v:complexity,w:1});if(priorityGD)vals.push({v:priorityGD,w:1});const totalWeight=vals.reduce((s,x)=>s+x.w,0);const totalScore=totalWeight>0?vals.reduce((s,x)=>s+x.v*x.w,0)/totalWeight:0;let segment=null;if(p.project_type==='New Delivery'){segment=1;}else if(daysRemaining!==null&&totalScore>0){if(daysRemaining<=30&&totalScore>2.2)segment=1;else if(daysRemaining<=30&&totalScore<=2.2)segment=2;else if(daysRemaining>30&&totalScore>2.2)segment=3;else segment=4;}let bufferColor='green';if(daysRemaining!==null){if(daysRemaining<=0)bufferColor='red';else if(daysRemaining<=20)bufferColor='red';else if(daysRemaining<=30)bufferColor='yellow';}const curStage=curPhase?(curPhase.stages||[]).find(s=>s.status==='IN_PROGRESS'):null;return{daysRemaining,urgency,scale,cost,complexity,priorityGD,totalScore:Math.round(totalScore*10)/10,segment,bufferColor,currentPhase:curPhase?curPhase.phase_name:'—',currentStage:curStage?curStage.stage_name:'—'};};

/* ===== PHASE GROUPING & BUFFER ===== */
const getPhaseGroups=(proj)=>{
  const phases=proj.phases||[];
  const mode=proj.phase_grouping||'DD3';
  if(proj.project_type==='ФК'||proj.project_type==='New Delivery'){
    /* ФК and ND: each phase is its own group */
    return phases.map(ph=>({id:ph.id,group_name:ph.phase_name,phase_codes:[ph.phase_code],phases:[ph],color:phCls(ph.phase_code),period_start:ph.period_start,period_end:ph.period_end,status:ph.status,started_at:ph.started_at,completed_at:ph.completed_at}));
  }
  /* Old Delivery / DD */
  const mining=phases.find(ph=>(ph.phase_code||'').toUpperCase()==='MINING');
  const assembling=phases.find(ph=>(ph.phase_code||'').toUpperCase()==='ASSEMBLING');
  const implementation=phases.find(ph=>(ph.phase_code||'').toUpperCase()==='IMPLEMENTATION');
  const organization=phases.find(ph=>(ph.phase_code||'').toUpperCase()==='ORGANIZATION');
  const _minMax=(arr)=>{
    const starts=arr.filter(p=>p&&p.period_start).map(p=>p.period_start);
    const ends=arr.filter(p=>p&&p.period_end).map(p=>p.period_end);
    return {period_start:starts.length?starts.sort()[0]:'',period_end:ends.length?ends.sort().pop():''};
  };
  const _grpStatus=(arr)=>{
    const phs=arr.filter(Boolean);
    if(phs.some(p=>p.status==='IN_PROGRESS'))return 'IN_PROGRESS';
    if(phs.every(p=>p.status==='COMPLETED'))return 'COMPLETED';
    return 'NOT_STARTED';
  };
  const _grpStarted=(arr)=>{const phs=arr.filter(Boolean);const ss=phs.map(p=>p.started_at).filter(Boolean);return ss.length?ss.sort()[0]:null;};
  const _grpCompleted=(arr)=>{const phs=arr.filter(Boolean);if(!phs.every(p=>p.status==='COMPLETED'))return null;const cs=phs.map(p=>p.completed_at).filter(Boolean);return cs.length?cs.sort().pop():null;};

  if(mode==='DD4'){
    return [mining,assembling,implementation,organization].filter(Boolean).map(ph=>({id:ph.id,group_name:ph.phase_name,phase_codes:[ph.phase_code],phases:[ph],color:phCls(ph.phase_code),period_start:ph.period_start,period_end:ph.period_end,status:ph.status,started_at:ph.started_at,completed_at:ph.completed_at}));
  }
  if(mode==='DD2'){
    const g1Arr=[mining,assembling].filter(Boolean);
    const g2Arr=[implementation,organization].filter(Boolean);
    const g1Dates=_minMax(g1Arr);const g2Dates=_minMax(g2Arr);
    return [
      {id:'grp_ms',group_name:'Добыча и Сборка',phase_codes:['MINING','ASSEMBLING'],phases:g1Arr,color:'mining',...g1Dates,status:_grpStatus(g1Arr),started_at:_grpStarted(g1Arr),completed_at:_grpCompleted(g1Arr)},
      {id:'grp_io',group_name:'Внедрение и Организация',phase_codes:['IMPLEMENTATION','ORGANIZATION'],phases:g2Arr,color:'implementation',...g2Dates,status:_grpStatus(g2Arr),started_at:_grpStarted(g2Arr),completed_at:_grpCompleted(g2Arr)}
    ].filter(g=>g.phases.length>0);
  }
  /* DD3 — default */
  const g1Arr=[mining,assembling].filter(Boolean);
  const g1Dates=_minMax(g1Arr);
  const groups=[
    {id:'grp_ms',group_name:'Добыча и Сборка',phase_codes:['MINING','ASSEMBLING'],phases:g1Arr,color:'mining',...g1Dates,status:_grpStatus(g1Arr),started_at:_grpStarted(g1Arr),completed_at:_grpCompleted(g1Arr)}
  ];
  if(implementation)groups.push({id:implementation.id,group_name:'Внедрение',phase_codes:['IMPLEMENTATION'],phases:[implementation],color:'implementation',period_start:implementation.period_start,period_end:implementation.period_end,status:implementation.status,started_at:implementation.started_at,completed_at:implementation.completed_at});
  if(organization)groups.push({id:organization.id,group_name:'Организация',phase_codes:['ORGANIZATION'],phases:[organization],color:'organization',period_start:organization.period_start,period_end:organization.period_end,status:organization.status,started_at:organization.started_at,completed_at:organization.completed_at});
  return groups.filter(g=>g.phases.length>0);
};

const calcPhaseBuffer=(group,today)=>{
  if(!today)today=new Date();
  const ps=group.period_start?new Date(group.period_start):null;
  const pe=group.period_end?new Date(group.period_end):null;
  if(!ps||!pe)return {totalDays:0,bufferDays:0,workDays:0,workEndDate:null,daysElapsed:0,daysRemaining:null,bufferConsumed:0,bufferPct:0,health:'gray',progressPct:0,isOverdue:false};
  const totalDays=Math.max(1,Math.ceil((pe-ps)/864e5));
  const bufferDays=Math.round(totalDays*0.33);
  const workDays=totalDays-bufferDays;
  const workEnd=new Date(ps);workEnd.setDate(workEnd.getDate()+workDays);
  const daysElapsed=(group.status==='ON_HOLD'&&group.phases)?Math.max(0,group.phases.reduce((s,ph)=>s+calcPhaseDays(ph),0)):Math.ceil((today-ps)/864e5);
  const daysRemaining=Math.ceil((pe-today)/864e5);
  let bufferConsumed=0;
  if(today>workEnd)bufferConsumed=Math.ceil((today-workEnd)/864e5);
  const bufferPct=bufferDays>0?Math.min(Math.round(bufferConsumed/bufferDays*100),999):0;
  let health='green';
  if(group.status==='COMPLETED')health='done';
  else if(group.status==='ON_HOLD')health='yellow';
  else if(group.status==='NOT_STARTED')health='gray';
  else if(daysRemaining<=0)health='red';
  else if(bufferPct>66)health='red';
  else if(bufferPct>0)health='yellow';
  const progressPct=totalDays>0?Math.min(Math.round(daysElapsed/totalDays*100),100):0;
  return {totalDays,bufferDays,workDays,workEndDate:workEnd,daysElapsed,daysRemaining,bufferConsumed,bufferPct,health,progressPct,isOverdue:daysRemaining!==null&&daysRemaining<0};
};

const calcPhaseTriage=(group,proj)=>{
  const buf=calcPhaseBuffer(group);
  let urgency=1;
  if(buf.daysRemaining!==null){
    if(buf.daysRemaining<=0)urgency=3;
    else if(buf.daysRemaining<=20)urgency=3;
    else if(buf.daysRemaining<=30)urgency=2;
  }
  const bpmCount=(proj.tracks||[]).filter(t=>(t.track_class||'').toUpperCase()==='BPM').length;
  const scale=proj._scale?Number(proj._scale):(bpmCount>=10?3:bpmCount>=5?2:1);
  const costPer=(Number(proj.total_contract_value)||Number(proj.contract_value)||0)/3;
  const cost=proj._cost?Number(proj._cost):(costPer>550000?3:costPer===550000?2:costPer>0?1:null);
  const complexity=proj._complexity||proj.complexity||null;
  const priorityGD=proj._priority||proj.priority_gd||null;
  const vals=[{v:urgency,w:1.5}];
  if(scale)vals.push({v:scale,w:1});if(cost!==null)vals.push({v:cost,w:1});
  if(complexity)vals.push({v:Number(complexity),w:1});if(priorityGD)vals.push({v:Number(priorityGD),w:1});
  const tw=vals.reduce((s,x)=>s+x.w,0);const ts=tw>0?vals.reduce((s,x)=>s+x.v*x.w,0)/tw:0;
  let segment=null;
  if(buf.daysRemaining!==null&&ts>0){
    if(buf.daysRemaining<=30&&ts>2.2)segment=1;
    else if(buf.daysRemaining<=30&&ts<=2.2)segment=2;
    else if(buf.daysRemaining>30&&ts>2.2)segment=3;
    else segment=4;
  }
  return {...buf,urgency,scale,cost,complexity,priorityGD,totalScore:Math.round(ts*10)/10,segment,groupName:group.group_name,groupId:group.id};
};

const NAV=[
  {id:'dashboard',icon:'📊',label:'Дашборд'},
  {id:'projects',icon:'📁',label:'Проекты'},
  {id:'triage',icon:'🎯',label:'Триаж'},
  {id:'people',icon:'👥',label:'Команда'},
  {id:'knowledge',icon:'📚',label:'Знания'},
  {id:'finance_machine',icon:'💰',label:'Фин. машина'},
  {id:'sales_marketing',icon:'📈',label:'Продажи'},
  {id:'clients',icon:'👥',label:'Клиенты'},
  {id:'chat',icon:'💬',label:'Чат'},
  {id:'settings',icon:'⚙️',label:'Настройки'},
  {id:'test',icon:'🧪',label:'Тест'},
];
const COUNTRIES=['Россия','Беларусь','Казахстан','Узбекистан','Кыргызстан','Таджикистан','Евросоюз','ОАЭ'];
const getPersonDepts=p=>{if(p.departments&&p.departments.length>0)return p.departments;return p.department?[p.department]:[];};
const _getUserRoles=u=>{if(u.roles&&Array.isArray(u.roles)&&u.roles.length>0)return u.roles;return u.role?[u.role]:['user'];};
const _hasRole=(u,r)=>_getUserRoles(u).includes(r);
const _isFinanceOrPartner=u=>_hasRole(u,'finance')||_hasRole(u,'partner')||_hasRole(u,'admin');
const getPersonDeptSalary=p=>{const d=getPersonDepts(p);return d.length>1?Math.round((p.salary_monthly||0)/d.length):(p.salary_monthly||0);};
const getPersonSalaryAtDate=(p,d)=>{const sh=(p.salary_history||[]).filter(h=>h.effective_date&&h.effective_date<=d).sort((a,b)=>(b.effective_date||'').localeCompare(a.effective_date||''));return sh.length>0?(Number(sh[0].amount)||0):(Number(p.salary_monthly)||0);};
const getPersonMonthSalary=(p,ym)=>{const yr=+ym.slice(0,4),mo=+ym.slice(5,7),dm=new Date(yr,mo,0).getDate();const ms=ym+'-01',me=ym+'-'+String(dm).padStart(2,'0');if((p.hire_date||'')>me)return 0;if(p.fire_date&&p.fire_date<ms)return 0;let wS=1,wE=dm;if((p.hire_date||'')>=ms&&p.hire_date<=me)wS=+p.hire_date.slice(8,10);if(p.fire_date&&p.fire_date>=ms&&p.fire_date<=me)wE=Math.min(wE,+p.fire_date.slice(8,10));if(wE<wS)return 0;const sh=(p.salary_history||[]).filter(h=>h.effective_date).slice().sort((a,b)=>(a.effective_date||'').localeCompare(b.effective_date||''));const wsD=ym+'-'+String(wS).padStart(2,'0');let sal;if(sh.length===0){sal=Number(p.salary_monthly)||0;}else{const bef=sh.filter(h=>h.effective_date<=wsD);sal=bef.length>0?Number(bef[bef.length-1].amount)||0:Number(p.salary_monthly)||0;}const wsDE=ym+'-'+String(wE).padStart(2,'0');const within=sh.filter(h=>h.effective_date>wsD&&h.effective_date<=wsDE);if(within.length===0)return sal*(wE-wS+1)/dm;let total=0,pD=wS;for(const ch of within){const d2=+ch.effective_date.slice(8,10);total+=sal*(d2-pD)/dm;sal=Number(ch.amount)||0;pD=d2;}total+=sal*(wE-pD+1)/dm;return total;};

function Modal({children,onClose}){return <div className="modal-overlay" onClick={e=>{if(e.target===e.currentTarget)onClose()}}><div className="modal">{children}</div></div>;}

/* Helper: sanitize data — convert unexpected objects in leaf fields to strings */
const _LEAF_FIELDS=new Set(["name","code","status","description","comment","notes","source","date","month","rg","category","cls","format","responsible","label","type","amount","amount_plan","amount_fact","cf_type","tax_rate","salary_monthly","grade","department","hire_date","fire_date","email","phone","planned_date","actual_date","expected_week_monday","payment_date","title","country","city","address","inn","contact_person","contact_email","contact_phone","payment_type","accrued_date","nd_period_start","nd_period_end","nd_payment_period"]);
function _sanitizeObj(obj){
  if(!obj||typeof obj!=="object"||Array.isArray(obj))return obj;
  const out={};
  for(const k of Object.keys(obj)){
    const v=obj[k];
    if(v===null||v===undefined){out[k]=v;}
    else if(Array.isArray(v)){out[k]=v.map(item=>typeof item==="object"&&item!==null&&!Array.isArray(item)?_sanitizeObj(item):item);}
    else if(typeof v==="object"&&_LEAF_FIELDS.has(k)){out[k]=String(v.name||v.value||v.label||v.start||v.text||JSON.stringify(v));}
    else if(typeof v==="object"){out[k]=_sanitizeObj(v);}
    else{out[k]=v;}
  }
  return out;
}
function _sanitize(d){
  if(!d||typeof d!=="object")return d;
  const result={...d};
  ["projects","clients","persons","overhead_registry","kb_budget","recommendations","knowledgeItems","crm_deals","icf_deals","staging_deals"].forEach(key=>{
    if(Array.isArray(result[key])){result[key]=result[key].map(item=>_sanitizeObj(item));}
  });
  return result;
}

function useStore(){
  const LS_KEY='pp_portfolio_data_v2';
  const [data,setData]=useState(()=>{
    try{
      const saved=localStorage.getItem(LS_KEY);
      if(saved){
        const parsed=JSON.parse(saved);
        if(parsed.projects&&parsed.persons){
          const s=window.SEED;
          parsed.phaseTemplates=s.phaseTemplates||parsed.phaseTemplates||[];
          parsed.stageTemplates=s.stageTemplates||parsed.stageTemplates||[];
          parsed.trackTemplates=s.trackTemplates||parsed.trackTemplates||[];
          parsed.projectTypes=['Old Delivery','New Delivery','ФК'];
          if(!parsed.persons.length&&s.persons.length)parsed.persons=s.persons; /* SEED persons now empty — this is a no-op safety fallback */
          // Merge new SEED persons not in LS (skip deleted ones)
          const lsIds=new Set(parsed.persons.map(p=>p.id));
          const delIds=new Set(parsed._deletedPersonIds||[]);
          (s.persons||[]).forEach(sp=>{if(!lsIds.has(sp.id)&&!delIds.has(sp.id))parsed.persons.push(sp);});
          /* clean SEED remnant fields + fix planned_date copied from due_date */
          const _seedPm={};(s.projects||[]).forEach(pr=>{(pr.payments||[]).forEach(pm=>{_seedPm[pm.id]=pm;});});
          parsed.projects.forEach(pr=>{(pr.payments||[]).forEach(pm=>{
            const sp=_seedPm[pm.id];
            if(sp&&sp.due_date&&pm.planned_date===sp.due_date){delete pm.planned_date;}
            delete pm.due_date;delete pm.paid_at;delete pm.project_id;
          });});
          /* auto-fix ND projects: end_date + contract_value + tranches */
          parsed.projects.filter(pr=>pr.project_type==='New Delivery').forEach(pr=>{
            const _n=Number(pr.nd_num_periods)||0,_isQ=(pr.nd_payment_period||'quarterly')==='quarterly',_c=Number(pr.nd_period_cost)||0;
            if(pr.nd_period_start&&_n>0)pr.nd_period_end=_calcNdEnd(pr.nd_period_start,_n,_isQ);
            if(_c>0&&_n>0)pr.total_contract_value=_c*_n;
            if(_c>0&&_n>0&&pr.nd_period_start&&!(pr.payments||[]).some(pm=>pm.status==='PLANNED')){
              const ms=_isQ?3:1;pr.payments=pr.payments||[];
              for(let i=0;i<_n;i++){const d=new Date(pr.nd_period_start);d.setMonth(d.getMonth()+i*ms);pr.payments.push({id:uuid(),tranche_number:i+1,amount:_c,planned_date:d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'),actual_date:'',accrued_date:'',status:'PLANNED',description:_isQ?'Квартал '+(i+1):'Месяц '+(i+1),prior_year:false,payment_type:'PLANNED',expected_week_monday:''});}
            }
          });
          /* ── Migration: PP-### → readable tickers ── */
          if(!parsed._ppMigrated){
            const _ppMap={'PP-001':'X5TR','PP-002':'AVPK','PP-003':'SYMM','PP-004':'OLSO','PP-005':'MRAD','PP-006':'OKHA','PP-007':'ARVD','PP-008':'SLEG','PP-009':'TRMX','PP-010':'BONU','PP-011':'FRTP','PP-012':'GBUK','PP-013':'AGRO','PP-014':'BKNG','PP-015':'LMED','PP-016':'DZRT','PP-017':'BPMD','PP-018':'SKSP','PP-019':'ANDA','PP-020':'TPOT','PP-021':'075G','PP-022':'PRKP','PP-023':'ABIS','PP-024':'OZEU','PP-025':'MNET','PP-026':'COSY','PP-027':'PLZL','PP-028':'TRHR','PP-029':'WOOS','PP-030':'TPRO','PP-031':'SVAV','PP-032':'MKRS','PP-033':'TNCT','PP-034':'EVRG','PP-035':'FTF2','PP-036':'MRAV'};
            (parsed.projects||[]).forEach(pr=>{if(_ppMap[pr.code])pr.code=_ppMap[pr.code];});
            parsed._ppMigrated=true;
            console.log('Migration PP→tickers applied');
          }
          /* ── Migration: 20% НДС для клиентов из Казахстана ── */
          if(!parsed._kzTax20Applied){
            const kzClientIds=new Set((parsed.clients||[]).filter(c=>c.country==='Казахстан').map(c=>c.id));
            let count=0;
            (parsed.projects||[]).forEach(pr=>{
              const isKz=kzClientIds.has(pr.client_id)||(pr.country==='Казахстан');
              if(isKz&&(pr.tax_rate||0)!==20){pr.tax_rate=20;count++;}
            });
            parsed._kzTax20Applied=true;
            if(count>0)console.log('[Migration] Applied 20% tax to '+count+' Kazakhstan projects');
          }
          /* ── Миграция: загрузка сделок из Notion CRM ── */
          if(!parsed._notionCrmSeeded){
            const _nid=()=>'ns_'+Math.random().toString(36).slice(2,10);
            const _ns=new Date().toISOString();
            const NOTION_DEALS=[
              {id:_nid(),name:'Медикал СПА',contract:1500000,first_payment:500000,notion_stage:'Дожим',request_type:'Продажи основных',priority:'Средний',responsible:'Сергей Худовеков',notion_id:'2a3b21994da780ea',created_at:_ns},
              {id:_nid(),name:'Midex Capital',contract:1500000,first_payment:500000,notion_stage:'Дожим',request_type:'Продажи основных',priority:'Средний',responsible:'Георгий',notion_id:'2afb21994da78133',created_at:_ns},
              {id:_nid(),name:'Salus Legal',contract:1600000,first_payment:290000,notion_stage:'Выиграно в прошл. периоды',request_type:'Продажи основных',priority:'Высокий',responsible:'Илья Балахнин',notion_id:'29fb21994da78041',created_at:_ns},
              {id:_nid(),name:'ЛАТИТУДО',contract:1800000,first_payment:600000,notion_stage:'Выиграно в прошл. периоды',request_type:'Продажи основных',priority:'Средний',responsible:'Георгий, Илья Балахнин',notion_id:'2b0b21994da7813c',created_at:_ns},
              {id:_nid(),name:'Данила Замотин (АБМ)',contract:0,first_payment:0,notion_stage:'SQL требуется прогрев',request_type:'Продажи основных',priority:'Низкий',responsible:'Илья Балахнин',notion_id:'2b2b21994da7801c',created_at:_ns},
              {id:_nid(),name:'Евгений Яблонский (Тайле)',contract:0,first_payment:0,notion_stage:'SQL требуется прогрев',request_type:'Продажи основных',priority:'Низкий',responsible:'Илья Балахнин',notion_id:'2d3b21994da7802d',created_at:_ns},
              {id:_nid(),name:'iSpot',contract:0,first_payment:0,notion_stage:'SQL требуется прогрев',request_type:'Продажи основных',priority:'',responsible:'Илья Балахнин',notion_id:'2c6b21994da78087',created_at:_ns},
              {id:_nid(),name:'Тачки',contract:0,first_payment:0,notion_stage:'',request_type:'Продажи основных',priority:'',responsible:'',notion_id:'29fb21994da78093',created_at:_ns},
              {id:_nid(),name:'ЭМИС КИП',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'29fb21994da78016',created_at:_ns},
              {id:_nid(),name:'Богачев Мясной Двор',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'10eafd52432144db',created_at:_ns},
              {id:_nid(),name:'Plaut Consulting LLC',contract:0,first_payment:0,notion_stage:'',request_type:'Продажи основных',priority:'',responsible:'',notion_id:'2b9b21994da78030',created_at:_ns},
              {id:_nid(),name:'ФЦК. Договор на 30млн (допродажа)',contract:30000000,first_payment:0,notion_stage:'',request_type:'Допродажи',priority:'',responsible:'',notion_id:'2f1b21994da78050',created_at:_ns},
              {id:_nid(),name:'Астана Уним',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2a2b21994da780f6',created_at:_ns},
              {id:_nid(),name:'Лента: бренд работодателя (тендер)',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2a2b21994da780eb62',created_at:_ns},
              {id:_nid(),name:'МедАспект',contract:0,first_payment:0,notion_stage:'',request_type:'Продажи основных',priority:'',responsible:'',notion_id:'2a2b21994da780ee',created_at:_ns},
              {id:_nid(),name:'Рокада поддержка',contract:0,first_payment:0,notion_stage:'',request_type:'Допродажи',priority:'',responsible:'',notion_id:'29fb21994da780c8',created_at:_ns},
              {id:_nid(),name:'Radisson Обучение 2 дня',contract:0,first_payment:0,notion_stage:'',request_type:'Продажи сессий',priority:'',responsible:'',notion_id:'2a5b21994da7812b',created_at:_ns},
              {id:_nid(),name:'ФортеПьяно марстрат+ПЛ',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2a8b21994da780c6',created_at:_ns},
              {id:_nid(),name:'Моссетка',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2eab21994da78061',created_at:_ns},
              {id:_nid(),name:'Мед Эксперт',contract:650000,first_payment:150000,notion_stage:'',request_type:'Продажи основных',priority:'',responsible:'',notion_id:'2acb21994da78032',created_at:_ns},
              {id:_nid(),name:'НПФ Экология',contract:0,first_payment:0,notion_stage:'',request_type:'Продажи основных',priority:'',responsible:'',notion_id:'2afb21994da780d3',created_at:_ns},
              {id:_nid(),name:'ОртоЛайт',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'29fb21994da780aa',created_at:_ns},
              {id:_nid(),name:'Surf',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'29fb21994da780da',created_at:_ns},
              {id:_nid(),name:'ФЦК / Сахалин',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2aeb21994da780d6',created_at:_ns},
              {id:_nid(),name:'Токарные технологии',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2a7b21994da7801f',created_at:_ns},
              {id:_nid(),name:'Росатом',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2aeb21994da78081',created_at:_ns},
              {id:_nid(),name:'VASTECO Владимир',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2d4b21994da78077',created_at:_ns},
              {id:_nid(),name:'РУССМАРКЕТ / Алина Абдулова',contract:2500000,first_payment:833000,notion_stage:'Устное Да',request_type:'Продажи основных',priority:'Высокий',responsible:'Илья Балахнин',notion_id:'2aab21994da7801a',created_at:_ns},
              {id:_nid(),name:'Дарина',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2b0b21994da78092',created_at:_ns},
              {id:_nid(),name:'Альфамедэкс',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2bfb21994da78024',created_at:_ns},
              {id:_nid(),name:'Чиббис (Сергей Спиро)',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2a6b21994da78091',created_at:_ns},
              {id:_nid(),name:'WOO / ВУУ / сопровождение',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2bcb21994da780ee',created_at:_ns},
              {id:_nid(),name:'Транзитсити: абонентка',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2bcb21994da7808c',created_at:_ns},
              {id:_nid(),name:'X5 Транспорт',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2b0b21994da780d9',created_at:_ns},
              {id:_nid(),name:'S7 Бренд работодателя',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2a2b21994da780ebb2',created_at:_ns},
              {id:_nid(),name:'Гри',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2adb21994da780a6',created_at:_ns},
              {id:_nid(),name:'Клиника Золотое сечение (АБМ)',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2b2b21994da780ca',created_at:_ns},
              {id:_nid(),name:'Далерон GTM',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2a8b21994da780bf',created_at:_ns},
              {id:_nid(),name:'AsterAuto',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2b8b21994da78076',created_at:_ns},
              {id:_nid(),name:'РСО',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2a7b21994da780fc',created_at:_ns},
              {id:_nid(),name:'Прайм финанс',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2b0b21994da780f6',created_at:_ns},
              {id:_nid(),name:'БК-РЕСУРС',contract:2200000,first_payment:734000,notion_stage:'Защита обсуждается',request_type:'Продажи основных',priority:'Низкий',responsible:'',comment:'30.01 направили КП',notion_id:'2f6b21994da7805d',created_at:_ns},
              {id:_nid(),name:'СибТехноСтрой (+4 ч)',contract:2200000,first_payment:734000,notion_stage:'Договор сделан',request_type:'Продажи основных',priority:'Низкий',responsible:'',comment:'12.02 направили КП',notion_id:'303b21994da7805c',created_at:_ns},
              {id:_nid(),name:'Трубошпунт Инжиниринг',contract:1500000,first_payment:500000,notion_stage:'Защита обсуждается',request_type:'Продажи основных',priority:'Средний',responsible:'',comment:'05.02 направили обновлённое КП',notion_id:'2f0b21994da7804c',created_at:_ns},
              {id:_nid(),name:'Глобал имплант: Белый Кролик (допродажа)',contract:1350000,first_payment:450000,notion_stage:'RNG Выиграно',request_type:'Допродажи',priority:'Низкий',responsible:'',comment:'допродажа без КП',notion_id:'2fbb21994da780e6',created_at:_ns},
              {id:_nid(),name:'QUBIQ',contract:900000,first_payment:0,notion_stage:'Защита поставлена',request_type:'Продажи основных',priority:'Низкий',responsible:'',comment:'09.02 договориться о созвоне и защите КП',notion_id:'2f7b21994da7800a',created_at:_ns},
              {id:_nid(),name:'ООО Аюна — Могучая Юлия',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'9b9510b305194200',created_at:_ns},
              {id:_nid(),name:'Алексей Кузнецов - ритейл персонал',contract:1700000,first_payment:533000,notion_stage:'Проиграно RFR',request_type:'Продажи основных',priority:'Высокий',responsible:'Илья Балахнин',notion_id:'2adb21994da78029',created_at:_ns},
              {id:_nid(),name:'Центр Пищевых Технологий - Спартак',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'29fb21994da7805b',created_at:_ns},
              {id:_nid(),name:'Павел Аванесян Логист',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2adb21994da780c0',created_at:_ns},
              {id:_nid(),name:'Денис Мих. напольные покрытия',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2aeb21994da78043',created_at:_ns},
              {id:_nid(),name:'Электрокомплект (+4 ч)',contract:2000000,first_payment:667000,notion_stage:'Защита обсуждается',request_type:'Продажи основных',priority:'Высокий',responsible:'',comment:'05.02 направили КП',notion_id:'2fbb21994da78080',created_at:_ns},
              {id:_nid(),name:'А-Реал Консалтинг (ИКС)',contract:1800000,first_payment:600000,notion_stage:'Защита обсуждается',request_type:'Продажи основных',priority:'Низкий',responsible:'',comment:'29.01 направили КП',notion_id:'2f6b21994da780d3',created_at:_ns},
              {id:_nid(),name:'X5 Transport: сопровождение (допродажа)',contract:0,first_payment:0,notion_stage:'RNG Выявлена потребность',request_type:'Допродажи',priority:'Низкий',responsible:'Георгий',comment:'обсуждаем формат сопровождения',notion_id:'2fbb21994da780cd',created_at:_ns},
              {id:_nid(),name:'МИС: аналитика и стратегия (допродажа)',contract:650000,first_payment:325000,notion_stage:'RNG КП выслано',request_type:'Допродажи',priority:'Низкий',responsible:'',comment:'05.02 направили КП',notion_id:'2fcb21994da78024',created_at:_ns},
              {id:_nid(),name:'Мясной Гурман: CRM',contract:1400000,first_payment:467000,notion_stage:'Договор сделан',request_type:'Продажи основных',priority:'Высокий',responsible:'Георгий',comment:'28.01 направили КП',notion_id:'2eeb21994da78049',created_at:_ns},
              {id:_nid(),name:'Мясной Гурман: маркетинговая стратегия',contract:2300000,first_payment:767000,notion_stage:'Договор сделан',request_type:'Продажи основных',priority:'Высокий',responsible:'',comment:'29.01 направили КП',notion_id:'2f6b21994da7802f',created_at:_ns},
              {id:_nid(),name:'Lumilu (Андрей)',contract:0,first_payment:0,notion_stage:'SQL требуется прогрев',request_type:'Продажи основных',priority:'Средний',responsible:'',comment:'20.01 очная встреча в Алматы',notion_id:'2efb21994da78018',created_at:_ns},
              {id:_nid(),name:'СберСервис',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2b8b21994da78073',created_at:_ns},
              {id:_nid(),name:'Тайская недвижимость',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2edb21994da78012',created_at:_ns},
              {id:_nid(),name:'Арвад: поддержка маркетинга',contract:0,first_payment:0,notion_stage:'',request_type:'Допродажи',priority:'',responsible:'',notion_id:'2fbb21994da780be',created_at:_ns},
              {id:_nid(),name:'ИЗТТ: внедрение CRM (допродажа)',contract:0,first_payment:0,notion_stage:'',request_type:'Допродажи',priority:'',responsible:'',notion_id:'2fbb21994da78062',created_at:_ns},
              {id:_nid(),name:'Нордкор / Nordcore',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2eeb21994da780cc',created_at:_ns},
              {id:_nid(),name:'Аэродорстрой',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2c5b21994da78033',created_at:_ns},
              {id:_nid(),name:'Специальные материалы (Сергей К.)',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2f0b21994da78076',created_at:_ns},
              {id:_nid(),name:'Клиника в Воронеже (Гор)',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2f0b21994da780cc',created_at:_ns},
              {id:_nid(),name:'Термы от Вотони',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2efb21994da7807f',created_at:_ns},
              {id:_nid(),name:'Indeed (Алексей Баранов)',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',notion_id:'2a6b21994da78080',created_at:_ns},
            ];
            parsed.notion_crm_staging=NOTION_DEALS;
            parsed._notionCrmSeeded=true;
            console.log('[Migration] Seeded '+NOTION_DEALS.length+' Notion CRM deals for verification');
          }
          /* v2: обновление данных сделок из Notion (КП выслано + новые) */
          if(!parsed._notionCrmUpdV2&&parsed.notion_crm_staging){
            const UPD={
              '2f6b21994da7805d':{name:'БК-РЕСУРС',contract:2200000,first_payment:734000,notion_stage:'Защита обсуждается',request_type:'Продажи основных',priority:'Низкий',comment:'30.01 направили КП'},
              '303b21994da7805c':{name:'СибТехноСтрой (+4 ч)',contract:2200000,first_payment:734000,notion_stage:'Договор сделан',request_type:'Продажи основных',priority:'Низкий',comment:'12.02 направили КП'},
              '2f0b21994da7804c':{name:'Трубошпунт Инжиниринг',contract:1500000,first_payment:500000,notion_stage:'Защита обсуждается',request_type:'Продажи основных',priority:'Средний',comment:'05.02 направили обновлённое КП'},
              '2fbb21994da780e6':{name:'Глобал имплант: Белый Кролик (допродажа)',contract:1350000,first_payment:450000,notion_stage:'RNG Выиграно',request_type:'Допродажи',priority:'Низкий',comment:'допродажа без КП'},
              '2f7b21994da7800a':{name:'QUBIQ',contract:900000,notion_stage:'Защита поставлена',request_type:'Продажи основных',priority:'Низкий',comment:'09.02 договориться о созвоне и защите КП'},
              '2aab21994da7801a':{contract:2500000,first_payment:833000,notion_stage:'Устное Да',request_type:'Продажи основных',priority:'Высокий',responsible:'Илья Балахнин'},
              '2adb21994da78029':{contract:1700000,first_payment:533000,notion_stage:'Проиграно RFR',request_type:'Продажи основных',priority:'Высокий',responsible:'Илья Балахнин'},
            };
            const st=parsed.notion_crm_staging;
            const existIds=new Set(st.map(d=>d.notion_id));
            st.forEach(d=>{if(d.notion_id&&UPD[d.notion_id]){Object.assign(d,UPD[d.notion_id]);}});
            const _nid2=()=>'ns_'+Math.random().toString(36).slice(2,10);
            const _ns2=new Date().toISOString();
            const NEW_DEALS=[
              {name:'Электрокомплект (+4 ч)',contract:2000000,first_payment:667000,notion_stage:'Защита обсуждается',request_type:'Продажи основных',priority:'Высокий',comment:'05.02 направили КП',notion_id:'2fbb21994da78080'},
              {name:'А-Реал Консалтинг (ИКС)',contract:1800000,first_payment:600000,notion_stage:'Защита обсуждается',request_type:'Продажи основных',priority:'Низкий',comment:'29.01 направили КП',notion_id:'2f6b21994da780d3'},
              {name:'X5 Transport: сопровождение (допродажа)',contract:0,first_payment:0,notion_stage:'RNG Выявлена потребность',request_type:'Допродажи',priority:'Низкий',responsible:'Георгий',comment:'обсуждаем формат сопровождения',notion_id:'2fbb21994da780cd'},
              {name:'МИС: аналитика и стратегия (допродажа)',contract:650000,first_payment:325000,notion_stage:'RNG КП выслано',request_type:'Допродажи',priority:'Низкий',comment:'05.02 направили КП',notion_id:'2fcb21994da78024'},
              {name:'Мясной Гурман: CRM',contract:1400000,first_payment:467000,notion_stage:'Договор сделан',request_type:'Продажи основных',priority:'Высокий',responsible:'Георгий',comment:'28.01 направили КП',notion_id:'2eeb21994da78049'},
              {name:'Мясной Гурман: маркетинговая стратегия',contract:2300000,first_payment:767000,notion_stage:'Договор сделан',request_type:'Продажи основных',priority:'Высокий',comment:'29.01 направили КП',notion_id:'2f6b21994da7802f'},
              {name:'Lumilu (Андрей)',contract:0,first_payment:0,notion_stage:'SQL требуется прогрев',request_type:'Продажи основных',priority:'Средний',comment:'20.01 очная встреча в Алматы',notion_id:'2efb21994da78018'},
              {name:'СберСервис',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',notion_id:'2b8b21994da78073'},
              {name:'Тайская недвижимость',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',notion_id:'2edb21994da78012'},
              {name:'Арвад: поддержка маркетинга',contract:0,first_payment:0,notion_stage:'',request_type:'Допродажи',priority:'',notion_id:'2fbb21994da780be'},
              {name:'ИЗТТ: внедрение CRM (допродажа)',contract:0,first_payment:0,notion_stage:'',request_type:'Допродажи',priority:'',notion_id:'2fbb21994da78062'},
              {name:'Нордкор / Nordcore',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',notion_id:'2eeb21994da780cc'},
              {name:'Аэродорстрой',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',notion_id:'2c5b21994da78033'},
              {name:'Специальные материалы (Сергей К.)',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',notion_id:'2f0b21994da78076'},
              {name:'Клиника в Воронеже (Гор)',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',notion_id:'2f0b21994da780cc'},
              {name:'Термы от Вотони',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',notion_id:'2efb21994da7807f'},
              {name:'Indeed (Алексей Баранов)',contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',notion_id:'2a6b21994da78080'},
            ];
            NEW_DEALS.forEach(nd=>{if(!existIds.has(nd.notion_id)){st.push({id:_nid2(),created_at:_ns2,...nd});}});
            parsed._notionCrmUpdV2=true;
            console.log('[Migration v2] Updated CRM staging: '+Object.keys(UPD).length+' updated, added new deals');
          }
          if(!parsed._fixAdgRepDates2){
            const _shiftMonth=(d)=>{if(!d)return d;const m=d.slice(0,7);const [y,mo]=m.split('-').map(Number);const ny=mo===12?y+1:y;const nm=mo===12?1:mo+1;const pref=ny+'-'+String(nm).padStart(2,'0');if(d.length===7)return pref;return pref+d.slice(7);};
            (parsed.projects||[]).forEach(pr=>{
              if((pr.name||'').includes('Репутац')){
                (pr.payments||[]).forEach(pm=>{
                  const oldPlan=pm.planned_date||'';
                  const wasShifted=!!parsed._fixAdgRepDates;
                  const newPlan=wasShifted?oldPlan:_shiftMonth(oldPlan);
                  if(!wasShifted&&pm.planned_date)pm.planned_date=newPlan;
                  if(pm.expected_week_monday&&!wasShifted)pm.expected_week_monday=_shiftMonth(pm.expected_week_monday);
                  const newMon=newPlan.slice(0,7);
                  if(pm.status==='ACCRUED'){pm.accrued_date=newMon+'-15';}
                  if(pm.status==='PAID'){if(!pm.accrued_date||!(pm.accrued_date||'').startsWith(newMon))pm.accrued_date=newMon+'-15';if(!pm.actual_date||!(pm.actual_date||'').startsWith(newMon))pm.actual_date=newMon+'-15';}
                });
                console.log('[Migration v2] Fixed dates for project: '+pr.name);
              }
            });
            parsed._fixAdgRepDates2=true;
          }
          if(!parsed._fixIutinJan170){
            (parsed.persons||[]).forEach(p=>{
              if((p.name||'').toLowerCase().includes('иутин')){
                (p.salary_history||[]).forEach(sh=>{if(sh.effective_date==='2026-01-01'&&sh.amount===175000)sh.amount=170000;});
                (p.career_events||[]).forEach(ce=>{if(ce.date==='2026-01-01'&&ce.new_salary===175000){ce.new_salary=170000;ce.note=(ce.note||'').replace('175К','170К').replace('255К','250К');}});
              }
            });
            parsed._fixIutinJan170=true;
          }
          /* ── Migration: Seed Стрела ICF deals from Excel import ── */
          if(!parsed._strelaDealsSeeded){
            const _sid=()=>'sd_'+Math.random().toString(36).slice(2,10);
            const _sn=new Date().toISOString();
            const STRELA_DEALS=[
              {date:'2026-01-10',user_name:'Антон Епифанов',company:'Клиники доктора Епифанова',product:'Интенсив Офлайн',cost:0,commission:0,received:0,tax_amount:0,earned:0,seller:'Самостоятельно',pay_system:'Геткурс'},
              {date:'2026-01-10',user_name:'Рустам Тилягулов',company:'Частная практика',product:'Обучение + Интенсив',cost:200000,commission:0,received:200000,tax_amount:0,earned:200000,seller:'Самостоятельно',pay_system:'Карта БИА'},
              {date:'2026-01-11',user_name:'Ксения Коновец',company:'ИП Коновец Ксения Владимировна',product:'Интенсив ZOOM',cost:20000,commission:700,received:19300,tax_amount:1400,earned:17900,seller:'Самостоятельно',pay_system:'Геткурс'},
              {date:'2026-01-13',user_name:'Вероника Батхель',company:'ЕФДОМ',product:'Обучение + Интенсив',cost:200000,commission:0,received:200000,tax_amount:20952,earned:179048,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-13',user_name:'Яна Воскобойник',company:'ООО «АйсИт»',product:'Обучение + Интенсив',cost:200000,commission:0,received:200000,tax_amount:20952,earned:179048,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-14',user_name:'Соловьев Кирилл (кл Татьяна Воропайкина)',company:'Медицинский Центр 21 век',product:'Интенсив ZOOM',cost:20000,commission:0,received:20000,tax_amount:2095,earned:17905,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-16',user_name:'Денис Завалишин',company:'Агентство RFS Ип Завалишин ДМ',product:'Обучение',cost:30000,commission:0,received:30000,tax_amount:3143,earned:26857,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-16',user_name:'Дмитрий Митенков',company:'LEADFACTOR',product:'Интенсив Офлайн',cost:30000,commission:0,received:30000,tax_amount:3143,earned:26857,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-16',user_name:'Сорокин Сергей',company:'ООО Бьюти',product:'Интенсив ZOOM',cost:20000,commission:0,received:20000,tax_amount:2095,earned:17905,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-16',user_name:'Михаил Медведев',company:'Навыки нового времени',product:'Обучение + Интенсив',cost:200000,commission:0,received:200000,tax_amount:20952,earned:179048,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-18',user_name:'Антон Епифанов',company:'Клиники доктора Епифанова',product:'Обучение',cost:75000,commission:2625,received:72375,tax_amount:5250,earned:67125,seller:'Дарья Лавшук',pay_system:'Геткурс'},
              {date:'2026-01-19',user_name:'Дон Виктория',company:'GetGreat Ип Дон ВВ',product:'Интенсив ZOOM',cost:20000,commission:0,received:20000,tax_amount:2095,earned:17905,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-19',user_name:'Андрей Чирва',company:'Poolmann',product:'Интенсив ZOOM',cost:20000,commission:0,received:20000,tax_amount:2095,earned:17905,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-19',user_name:'Шаталов Дмитрий',company:'ИП Бердалинова В М',product:'Обучение + Интенсив',cost:200000,commission:0,received:200000,tax_amount:20952,earned:179048,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-19',user_name:'Азат Туйтуев',company:'Мебель Оригами',product:'Обучение + Интенсив',cost:200000,commission:20000,received:180000,tax_amount:14000,earned:166000,seller:'Дарья Лавшук',pay_system:'Геткурс'},
              {date:'2026-01-20',user_name:'Молкубаева Юлия',company:'Косметологическая клиника Лав',product:'Обучение + Интенсив',cost:200000,commission:0,received:200000,tax_amount:20952,earned:179048,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-21',user_name:'Дмитрий Лукьянов',company:'Кайлер ИП Лукьянов',product:'Обучение(частичная)',cost:110000,commission:0,received:110000,tax_amount:11524,earned:98476,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-21',user_name:'Тимофеев Александр',company:'ООО ПРМ',product:'Обучение + Интенсив',cost:200000,commission:0,received:200000,tax_amount:20952,earned:179048,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-22',user_name:'Илья Шумилов',company:'ООО Новострой',product:'Интенсив Офлайн',cost:30000,commission:0,received:30000,tax_amount:3143,earned:26857,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-22',user_name:'Денис',company:'Интер Авто',product:'Обучение(помодульно)',cost:65000,commission:2275,received:62725,tax_amount:4550,earned:58175,seller:'Дарья Лавшук',pay_system:'Геткурс'},
              {date:'2026-01-23',user_name:'Анна Капитанова',company:'-',product:'Интенсив Офлайн',cost:30000,commission:1050,received:28950,tax_amount:2100,earned:26850,seller:'Самостоятельно',pay_system:'Геткурс'},
              {date:'2026-01-22',user_name:'Максим Панфилов',company:'Data Service OU',product:'Интенсив ZOOM',cost:20000,commission:0,received:20000,tax_amount:0,earned:20000,seller:'Дарья Лавшук',pay_system:'Карта SLO'},
              {date:'2026-01-23',user_name:'Роман Толбатов',company:'ООО «ЦМИК ИН»',product:'Интенсив Офлайн',cost:30000,commission:0,received:30000,tax_amount:3143,earned:26857,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-23',user_name:'Антон Карев',company:'ИП Карев А И',product:'Обучение(частичная)',cost:100000,commission:0,received:100000,tax_amount:10476,earned:89524,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-23',user_name:'Федор Уткин',company:'naBrevno',product:'Обучение + Интенсив',cost:200000,commission:0,received:200000,tax_amount:20952,earned:179048,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-24',user_name:'Колмаков Михаил',company:'Robotmia',product:'Интенсив ZOOM',cost:20000,commission:700,received:19300,tax_amount:1400,earned:17900,seller:'Самостоятельно',pay_system:'Геткурс'},
              {date:'2026-01-24',user_name:'Яна Васильева',company:'Маркетолог',product:'Запись 1-2',cost:10000,commission:350,received:9650,tax_amount:700,earned:8950,seller:'Самостоятельно',pay_system:'Геткурс'},
              {date:'2026-01-25',user_name:'Константин Кротков',company:'-',product:'Запись 1-2',cost:10000,commission:350,received:9650,tax_amount:700,earned:8950,seller:'Самостоятельно',pay_system:'Геткурс'},
              {date:'2026-01-26',user_name:'Дон Виктория',company:'GetGreat Ип Дон ВВ',product:'Обучение',cost:180000,commission:0,received:180000,tax_amount:18857,earned:161143,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-28',user_name:'Сорокин Сергей',company:'ООО Бьюти',product:'Обучение',cost:180000,commission:0,received:180000,tax_amount:18857,earned:161143,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-28',user_name:'Евгений Черушкин',company:'aiWarmUp',product:'Обучение',cost:9900,commission:346,received:9554,tax_amount:693,earned:8860,seller:'Дарья Лавшук',pay_system:'Геткурс'},
              {date:'2026-01-28',user_name:'Денис Завалишин',company:'Агентство RFS Ип Завалишин ДМ',product:'Обучение(частичная)',cost:150000,commission:0,received:150000,tax_amount:15714,earned:134286,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-01-30',user_name:'Ксения Коновец',company:'ИП Коновец Ксения Владимировна',product:'Обучение(помодульно)',cost:55000,commission:0,received:55000,tax_amount:5762,earned:49238,seller:'Дарья Лавшук',pay_system:'ИП БИА/счет Т-банк'},
              {date:'2026-02-02',user_name:'Роман Толбатов',company:'ООО «ЦМИК ИН»',product:'Обучение(помодульно)',cost:40000,commission:0,received:40000,tax_amount:4190,earned:35810,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-02',user_name:'Сушков Владимир Александрович',company:'ООО Три Сада',product:'Обучение(частичная)',cost:200000,commission:0,received:200000,tax_amount:20952,earned:179048,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-03',user_name:'Дмитрий Митенков',company:'ООО Фактор Телеком',product:'Обучение(помодульно)',cost:35000,commission:0,received:35000,tax_amount:3667,earned:31333,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-03',user_name:'Дмитрий Лукьянов',company:'Кайлер ИП Лукьянов',product:'Обучение(частичная)',cost:90000,commission:0,received:90000,tax_amount:9429,earned:80571,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-04',user_name:'Андрей Шарков',company:'ООО Шаги',product:'Обучение(частичная)',cost:10000,commission:0,received:10000,tax_amount:1048,earned:8952,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-05',user_name:'Мария Илюхина',company:'ООО ТК НИКА',product:'Обучение',cost:100000,commission:0,received:100000,tax_amount:10476,earned:89524,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-06',user_name:'Денис Завалишин',company:'Агентство RFS Ип Завалишин ДМ',product:'Обучение(частичная)',cost:20000,commission:0,received:20000,tax_amount:2095,earned:17905,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-06',user_name:'Илья Шумилов',company:'ООО Новострой',product:'Обучение(помодульно)',cost:35000,commission:0,received:35000,tax_amount:3667,earned:31333,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-06',user_name:'Антон Карев',company:'ИП Карев А И',product:'Обучение(частичная)',cost:50000,commission:0,received:50000,tax_amount:5238,earned:44762,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-06',user_name:'Александр Смирнов',company:'ООО Ива Дизайн',product:'Обучение(помодульно)',cost:65000,commission:0,received:65000,tax_amount:6810,earned:58190,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-07',user_name:'Азат Туйтуев',company:'Мебель Оригами',product:'Тариф Индивидуальный',cost:100000,commission:10000,received:90000,tax_amount:7000,earned:83000,seller:'Дарья Лавшук',pay_system:'Геткурс'},
              {date:'2026-02-09',user_name:'Соловьев Кирилл (кл Татьяна Воропайкина)',company:'Медицинский Центр 21 век',product:'Обучение',cost:180000,commission:0,received:180000,tax_amount:18857,earned:161143,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-13',user_name:'Фарид Медведев',company:'ООО Симбилет',product:'Обучение',cost:180000,commission:0,received:180000,tax_amount:18857,earned:161143,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-16',user_name:'Молкубаева Юлия',company:'Косметологическая клиника Лав',product:'Тариф Индивидуальный',cost:100000,commission:0,received:100000,tax_amount:10476,earned:89524,seller:'Дарья Лавшук',pay_system:'ИПБИА'},
              {date:'2026-02-14',user_name:'Антон Карев',company:'ИП Карев А И',product:'Обучение(частичная)',cost:50000,commission:0,received:50000,tax_amount:5238,earned:44762,seller:'Дарья Лавшук',pay_system:'ИПБИА'}
            ];
            const existingDeals=(parsed.icf_deals||[]);
            const newDeals=STRELA_DEALS.map(dl=>({id:_sid(),created_at:_sn,icf_project:'Стрела',tax_rate:0,...dl}));
            parsed.icf_deals=[...existingDeals,...newDeals];
            /* Автосоздание клиентов из компаний Стрелы */
            const _exClN=new Set((parsed.clients||[]).map(c=>c.name.toLowerCase()));
            const _newCl=[];
            STRELA_DEALS.forEach(dl=>{
              if(dl.company&&dl.company!=='-'&&!_exClN.has(dl.company.toLowerCase())){
                _exClN.add(dl.company.toLowerCase());
                _newCl.push({id:_sid(),name:dl.company,industry:'',country:'',created_at:_sn});
              }
            });
            if(_newCl.length>0){parsed.clients=[...(parsed.clients||[]),..._newCl];console.log('[Migration] Created '+_newCl.length+' clients from Стрела deals');}
            /* Привязка company_id */
            const _clM={};(parsed.clients||[]).forEach(c=>{_clM[c.name.toLowerCase()]=c.id;});
            parsed.icf_deals.filter(d=>d.icf_project==='Стрела'&&!d.company_id&&d.company).forEach(d=>{d.company_id=_clM[(d.company||'').toLowerCase()]||'';});
            parsed._strelaDealsSeeded=true;
            console.log('[Migration] Seeded '+STRELA_DEALS.length+' Стрела ICF deals');
          }
          /* === Миграция: stream_number + is_forecast для всех icf_deals === */
          if(!parsed._icfStreamForecast){
            (parsed.icf_deals||[]).forEach(d=>{
              if(d.stream_number===undefined)d.stream_number=1;
              if(d.is_forecast===undefined)d.is_forecast=false;
            });
            parsed._icfStreamForecast=true;
          }
          /* Миграция: записи Муравьева 750К+500К → авансированная прибыль, не ФОТ */
          if(!parsed._icfMuravAdvProfit2){
            (parsed.overhead_registry||[]).forEach(e=>{
              if((e.cf_type||'')==='ICF'&&e.icf_project==='Стрела'){
                const a=Number(e.amount)||0;
                const nm=((e.responsible||'')+(e.comment||'')+(e.category||'')+(e.cls||'')).toLowerCase();
                const isTarget=(a===750000||a===500000)&&(nm.includes('муравь')||nm.includes('андр')||nm.includes('фот')||nm.includes('зарплат')||nm.includes('менедж'));
                if(isTarget){
                  e.category='Авансированная прибыль';e.cls='аванс.прибыль';
                  e.comment=(e.comment?e.comment+' | ':'')+'Авансированная прибыль А.Муравьёва';
                }
              }
            });
            parsed._icfMuravAdvProfit2=true;
          }
          /* Миграция: прогнозная сделка Сушкова 01.03.2026 */
          if(!parsed._migSushkovFore){
            const deals=parsed.icf_deals||[];
            const has=deals.some(d=>d.icf_project==='Стрела'&&!!d.is_forecast&&(d.user_name||'').toLowerCase().includes('сушков'));
            if(!has){
              deals.push({id:'fore-sushkov-mar26',icf_project:'Стрела',stream_number:1,is_forecast:true,date:'2026-03-01',user_name:'Сушков Владимир Александрович',company:'ООО Три Сада',product:'Обучение(частичная)',cost:200000,commission:0,received:200000,tax_rate:6,tax_amount:Math.round(200000*0.1047),earned:200000-Math.round(200000*0.1047),seller:'Дарья Лавшук',pay_system:'ИПБИА'});
            }
            parsed._migSushkovFore=true;
          }
          /* Нормализация metrics_maps links: [[from,to,...]] → [{from,to}] */
          if(!parsed._migMetricsLinksNorm){
            const mm=parsed.metrics_maps||{};
            Object.keys(mm).forEach(k=>{
              if(mm[k]&&mm[k].links){
                mm[k].links=mm[k].links.map(l=>Array.isArray(l)?{from:l[0],to:l[1]}:l);
              }
            });
            parsed.metrics_maps=mm;
            parsed._migMetricsLinksNorm=true;
          }
          return _sanitize(parsed);
        }
      }
    }catch(e){console.warn('LS load error',e);}
    const s=window.SEED;
    /* clean SEED remnant fields from payments */
    (s.projects||[]).forEach(pr=>{(pr.payments||[]).forEach(pm=>{
      delete pm.due_date;delete pm.paid_at;delete pm.project_id;
    });});
    return {projects:s.projects||[],clients:s.clients||[],persons:s.persons||[],phaseTemplates:s.phaseTemplates||[],stageTemplates:s.stageTemplates||[],trackTemplates:s.trackTemplates||[],fullKitComponents:s.fullKitComponents||[],knowledgeItems:s.knowledgeItems||[],tags:s.tags||[],recommendations:s.recommendations||[],kb_budget:s.kb_budget||[],overhead_registry:s.overhead_registry||[],users:s.users||[],projectTypes:['Old Delivery','New Delivery','ФК']};
  });
  const [toast,setToast]=useState(null);
  const showToast=msg=>{setToast(msg);setTimeout(()=>setToast(null),2500);};

  /* ===== Supabase sync ===== */
  const [sbStatus,setSbStatus]=useState(_sb?'loading':'offline'); // 'loading'|'online'|'saving'|'saved'|'offline'|'error'
  const [sbLoaded,setSbLoaded]=useState(!_sb);
  const _sbTimer=useRef(null);
  const _sbSkipSave=useRef(false);

  /* Helper: compute data richness score */
  const _dataScore=(d)=>{if(!d||typeof d!=='object')return 0;return (d.projects||[]).length*10+(d.clients||[]).length*5+(d.persons||[]).length*3+(d.kb_budget||[]).length*4+(d.pnl_overrides||[]).length*3+(d.crm_deals||[]).length*3+(d.overhead_registry||[]).length*2+(d.users||[]).length*2+(d.projects||[]).reduce((s,p)=>(s+(p.payments||[]).length*2+(p.tasks||[]).length+(p.phases||[]).length+(p.project_overheads||[]).length*2+(p.time_entries||[]).length*2+(p.overheads||[]).length+(p.timeEntries||[]).length),0);};

  /* === SYNC MODE: localhost = isolated (localStorage only), online = master (Supabase read+write) === */
  const _isLocalhost=window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1';
  const _syncMode=_isLocalhost?'local':'master';

  /* Load from Supabase on start — ONLY for online (master) */
  useEffect(()=>{
    if(_syncMode==='local'){
      /* Localhost: полностью изолирован, работает только с localStorage */
      console.log('[Sync] Mode: local (localhost) — Supabase disabled, using localStorage only');
      setSbStatus('offline');
      setSbLoaded(true);
      return;
    }
    if(!_sb){setSbStatus('offline');setSbLoaded(true);return;}
    setSbStatus('loading');
    console.log('[Sync] Mode: master (online)');
    _sb.from('app_data').select('payload').eq('id',1).single()
      .then(({data:row,error})=>{
        if(!error&&row&&row.payload&&typeof row.payload==='object'&&Object.keys(row.payload).length>0){
          const sbData=_sanitize(row.payload);
          const lsScore=_dataScore(data);
          const sbScore=_dataScore(sbData);
          console.log('[Sync/Master] localStorage score='+lsScore+', Supabase score='+sbScore);
          /* AUTO-BACKUP before any overwrite */
          try{const bk='pp_backup_'+new Date().toISOString().slice(0,19).replace(/:/g,'-');localStorage.setItem(bk,JSON.stringify(data));console.log('[Sync] Backup saved:',bk);}catch(e){}

          /* Helper: merge arrays by id — union of both sources */
          const _mergeById=(localArr,remoteArr)=>{
            const map=new Map();
            (localArr||[]).forEach(item=>map.set(item.id,item));
            (remoteArr||[]).forEach(item=>{if(!map.has(item.id))map.set(item.id,item);});
            return Array.from(map.values());
          };
          if(sbScore>lsScore){
            _sbSkipSave.current=true;
            setData(prev=>({...sbData}));
            setTimeout(()=>{_sbSkipSave.current=false;},500);
            console.log('[Sync/Master] Using Supabase data (richer: '+sbScore+' vs '+lsScore+')');
          } else if(lsScore>sbScore&&(data.projects||[]).length<=5&&(sbData.projects||[]).length>10){
            console.warn('[Sync/Master] PROTECTION: localStorage looks empty, using Supabase');
            _sbSkipSave.current=true;
            setData(prev=>({...sbData}));
            setTimeout(()=>{_sbSkipSave.current=false;},500);
          } else {
            /* Keeping localStorage data, but ALWAYS merge shared arrays (chat, notifications) from Supabase */
            _sbSkipSave.current=true;
            setData(prev=>({...prev,
              chat_messages:_mergeById(prev.chat_messages,sbData.chat_messages),
              chat_channels:_mergeById(prev.chat_channels,sbData.chat_channels),
              notifications:_mergeById(prev.notifications,sbData.notifications)
            }));
            setTimeout(()=>{_sbSkipSave.current=false;},500);
            console.log('[Sync/Master] Keeping localStorage data (score='+lsScore+'), merged chat/notifications from Supabase');
          }
          setSbStatus('online');
        } else if(error){
          console.warn('Supabase load error:',error);
          setSbStatus('error');
        } else {
          console.log('[Sync/Master] Supabase empty, will push localStorage data');
          setSbStatus('online');
        }
        setSbLoaded(true);
      }).catch(e=>{console.warn('Supabase fetch failed:',e);setSbStatus('error');setSbLoaded(true);});
  },[]);

  /* Save: localStorage always + Supabase only for online (master) */
  useEffect(()=>{
    try{localStorage.setItem(LS_KEY,JSON.stringify(data));}catch(e){console.warn('LS save error',e);}
    /* Localhost: никогда не трогает Supabase */
    if(_syncMode==='local')return;
    if(!_sb||!sbLoaded||_sbSkipSave.current)return;
    /* PROTECTION: don't push empty/SEED data to Supabase */
    const _saveScore=_dataScore(data);
    if(_saveScore<50){console.warn('[Save] Skipping Supabase save — data looks like SEED (score='+_saveScore+')');return;}
    clearTimeout(_sbTimer.current);
    setSbStatus('saving');
    _sbTimer.current=setTimeout(()=>{
      _sb.from('app_data').update({payload:data,updated_at:new Date().toISOString()}).eq('id',1)
        .then(({error})=>{
          if(error){console.warn('Supabase save error:',error);setSbStatus('error');}
          else setSbStatus('saved');
        }).catch(()=>setSbStatus('error'));
    },2000);
  },[data,sbLoaded]);

  /* Re-init Supabase connection (called from config modal) — also uses smart merge */
  const reconnectSb=()=>{_sb=_initSb();if(_sb){setSbStatus('loading');setSbLoaded(false);
    _sb.from('app_data').select('payload').eq('id',1).single()
      .then(({data:row,error})=>{
        if(!error&&row&&row.payload&&Object.keys(row.payload).length>0){
          const _rcData=_sanitize(row.payload);
          const sbScore=_dataScore(_rcData);
          const lsScore=_dataScore(data);
          const sbP=(_rcData.projects||[]).length;const lsP=(data.projects||[]).length;
          if(sbScore>lsScore){
            _sbSkipSave.current=true;setData(_rcData);
            setTimeout(()=>{_sbSkipSave.current=false;},500);
            console.log('[Reconnect] Using Supabase data (richer)');
          } else if(lsScore>sbScore&&lsP<=5&&sbP>10){
            console.warn('[Reconnect] PROTECTION: localStorage looks like SEED, using Supabase');
            _sbSkipSave.current=true;setData(_rcData);
            setTimeout(()=>{_sbSkipSave.current=false;},500);
          } else {
            /* Still merge chat arrays from Supabase */
            const _mbi2=(la,ra)=>{const map=new Map();(la||[]).forEach(i=>map.set(i.id,i));(ra||[]).forEach(i=>{if(!map.has(i.id))map.set(i.id,i);});return Array.from(map.values());};
            _sbSkipSave.current=true;
            setData(prev=>({...prev,
              chat_messages:_mbi2(prev.chat_messages,_rcData.chat_messages),
              chat_channels:_mbi2(prev.chat_channels,_rcData.chat_channels),
              notifications:_mbi2(prev.notifications,_rcData.notifications)
            }));
            setTimeout(()=>{_sbSkipSave.current=false;},500);
            console.log('[Reconnect] Keeping localStorage data, merged chat/notifications');
          }
          setSbStatus('online');
        } else if(error){
          console.warn('Reconnect error:',error);
          setSbStatus('error');
        } else {
          setSbStatus('online');
        }
        setSbLoaded(true);
      }).catch(()=>{setSbStatus('error');setSbLoaded(true);});
  }else{setSbStatus('offline');}};

  /* === Chat/Notifications real-time polling (master mode only, every 5s) === */
  const _pollRef=React.useRef(null);
  const _pollBusy=React.useRef(false);
  useEffect(()=>{
    if(_syncMode==='local'||!_sb)return;
    const poll=()=>{
      if(_pollBusy.current)return;
      _pollBusy.current=true;
      _sb.from('app_data').select('payload').eq('id',1).single()
        .then(({data:row,error})=>{
          _pollBusy.current=false;
          if(error||!row||!row.payload)return;
          const remote=row.payload;
          const remoteMsgs=remote.chat_messages||[];
          const remoteNotifs=remote.notifications||[];
          const remoteCh=remote.chat_channels||null;
          /* Merge chat_messages by id — add messages we don't have locally */
          _sbSkipSave.current=true;
          setData(prev=>{
            /* Build remote maps for quick lookup */
            const remoteMsgMap=new Map();remoteMsgs.forEach(m=>remoteMsgMap.set(m.id,m));
            const localMsgMap=new Map();(prev.chat_messages||[]).forEach(m=>localMsgMap.set(m.id,m));
            /* New messages not in local */
            const newMsgs=remoteMsgs.filter(m=>!localMsgMap.has(m.id));
            /* Updated messages: check reactions, edited, pinned */
            let msgUpdated=false;
            const updatedLocalMsgs=(prev.chat_messages||[]).map(lm=>{
              const rm=remoteMsgMap.get(lm.id);
              if(!rm)return lm;
              const rxChanged=JSON.stringify(rm.reactions||[])!==JSON.stringify(lm.reactions||[]);
              const editChanged=(rm.edited||false)!==(lm.edited||false)||(rm.text||'')!==(lm.text||'');
              const pinChanged=(rm.pinned||false)!==(lm.pinned||false);
              if(rxChanged||editChanged||pinChanged){msgUpdated=true;return{...lm,reactions:rm.reactions||[],text:rm.text||lm.text,edited:rm.edited||lm.edited,pinned:rm.pinned||false};}
              return lm;
            });
            /* Notifications */
            const localNotifIds=new Set((prev.notifications||[]).map(n=>n.id));
            const newNotifs=remoteNotifs.filter(n=>!localNotifIds.has(n.id));
            const remoteReadMap={};remoteNotifs.forEach(n=>{if(n.read)remoteReadMap[n.id]=true;});
            /* Channels */
            const localChIds=new Set((prev.chat_channels||[]).map(c=>c.id));
            const remoteChArr=remoteCh||[];
            const newCh=remoteChArr.filter(c=>!localChIds.has(c.id));
            /* Check if anything changed */
            const hasNotifChanges=newNotifs.length>0||Object.keys(remoteReadMap).length>0;
            if(newMsgs.length===0&&!msgUpdated&&newCh.length===0&&!hasNotifChanges)return prev;
            const mergedNotifs=[...(prev.notifications||[]).map(n=>remoteReadMap[n.id]?{...n,read:true}:n),...newNotifs];
            if(newMsgs.length===0&&!msgUpdated&&newCh.length===0){
              const notifChanged=newNotifs.length>0||(prev.notifications||[]).some(n=>!n.read&&remoteReadMap[n.id]);
              if(!notifChanged)return prev;
            }
            if(newMsgs.length>0)console.log('[Poll] +'+newMsgs.length+' new chat message(s)');
            if(msgUpdated)console.log('[Poll] Updated existing message(s) (reactions/edits/pins)');
            if(newCh.length>0)console.log('[Poll] +'+newCh.length+' new chat channel(s)');
            return {...prev,
              chat_messages:[...updatedLocalMsgs,...newMsgs],
              notifications:mergedNotifs,
              chat_channels:[...(prev.chat_channels||[]),...newCh]
            };
          });
          setTimeout(()=>{_sbSkipSave.current=false;},300);
        }).catch(()=>{_pollBusy.current=false;});
    };
    _pollRef.current=setInterval(poll,1000);
    return ()=>clearInterval(_pollRef.current);
  },[sbLoaded]);

  /* One-time migration: Ensure 'Ольга Лукина' FK project exists */
  useEffect(()=>{
    const prjs=data.projects||[];
    const norm=s=>(s||'').toLowerCase().replace(/[\s\.\-\/]+/g,'').trim();
    if(prjs.some(p=>norm(p.name).includes('лукина')||norm(p.name).includes('ольга лукина')))return;
    /* Build full FK project for Ольга Лукина */
    const pid='e7a1b2c3-d4e5-4f67-8a9b-0c1d2e3f4a5b';
    const clid='c1a2b3c4-d5e6-4f78-9a0b-1c2d3e4f5a6b';
    /* Ensure client exists */
    const cls=data.clients||[];
    let newClients=cls;
    if(!cls.some(c=>norm(c.name).includes('лукина'))){
      newClients=[...cls,{id:clid,name:'Ольга Лукина',industry:'Consulting',type:'B2C',created_at:new Date().toISOString(),updated_at:new Date().toISOString()}];
    }
    /* FK params: 2 months, 14500+28000 = avg ~21250/mo, start 2026-01 */
    const fkCost=21250;const fkMonths=2;const fkStart='2026-01-01';
    const phases=[
      {id:'fa1b0001-0001-4000-8000-000000000001',phase_code:'FM1',phase_name:'Месяц 1',track_class:'FK_M1',order_num:1,status:'COMPLETED',period_start:'2026-01-01',period_end:'2026-01-31',stages:[]},
      {id:'fa1b0001-0001-4000-8000-000000000002',phase_code:'FM2',phase_name:'Месяц 2',track_class:'FK_M2',order_num:2,status:'IN_PROGRESS',period_start:'2026-02-01',period_end:'2026-02-28',stages:[]}
    ];
    const payments=[
      {id:'pa1b0001-0001-4000-8000-000000000001',tranche_number:1,amount:14500,planned_date:'2026-01',actual_date:'2026-01-15T12:00:00.000Z',accrued_date:'2026-01-15',status:'PAID',description:'Месяц 1',prior_year:false,payment_type:'PLANNED',expected_week_monday:''},
      {id:'pa1b0001-0001-4000-8000-000000000002',tranche_number:2,amount:28000,planned_date:'2026-02',actual_date:'2026-02-15T12:00:00.000Z',accrued_date:'2026-02-15',status:'PAID',description:'Месяц 2',prior_year:false,payment_type:'PLANNED',expected_week_monday:''}
    ];
    /* Overheads from file analysis: jan=14500, feb=28000 — Подрядчики */
    const overheads=[
      {id:'oh1b0001-0001-4000-8000-000000000001',date:'2026-01-15',amount:14500,name:'Подрядчик Ольга Лукина (янв)',notes:'Подрядчики'},
      {id:'oh1b0001-0001-4000-8000-000000000002',date:'2026-02-15',amount:28000,name:'Подрядчик Ольга Лукина (фев)',notes:'Подрядчики'}
    ];
    const proj={
      id:pid,code:'FK-OL',name:'Ольга Лукина',client_id:clid,client_name:'Ольга Лукина',client_industry:'Consulting',
      project_type:'ФК',work_group:'РГ2',status:'ACTIVE',
      fixed_price:42500,total_contract_value:42500,margin_target_pct:0,
      start_date:'2026-01-01',target_end_date:'2026-02-28',notes:'Импорт из B2C. ФК-проект.',
      nd_payment_period:'',nd_period_cost:0,nd_period_start:'',nd_period_end:'',nd_has_success_fee:false,nd_success_fee:0,nd_num_periods:0,
      fk_monthly_cost:fkCost,fk_planned_months:fkMonths,fk_start_date:fkStart,
      created_at:new Date().toISOString(),updated_at:new Date().toISOString(),
      assignments:[],blockers:[],tasks:[],tracks:[],
      phases,payments,timeEntries:[],tax_rate:0,overheads,
      hypothesisBoard:{id:'hb1b0001-0001-4000-8000-000000000001',goals:[],subjects:[]}
    };
    /* Also add overhead_registry entries for this project with rg='ФК' */
    const oreg=data.overhead_registry||[];
    const newOhEntries=[
      {id:'or1b0001-0001-4000-8000-000000000001',date:'2026-01-15',amount:14500,rg:'ФК',category:'Подрядчики',cls:'прочее',format:'счет',responsible:'',comment:'Подрядчик Ольга Лукина (янв)',project_id:pid,scope:'project',cf_type:'OCF',verified:false,synced_oh_id:overheads[0].id,source:'system_proj',created_at:new Date().toISOString()},
      {id:'or1b0001-0001-4000-8000-000000000002',date:'2026-02-15',amount:28000,rg:'ФК',category:'Подрядчики',cls:'прочее',format:'счет',responsible:'',comment:'Подрядчик Ольга Лукина (фев)',project_id:pid,scope:'project',cf_type:'OCF',verified:false,synced_oh_id:overheads[1].id,source:'system_proj',created_at:new Date().toISOString()}
    ];
    setData(d=>({...d,
      clients:newClients,
      projects:[proj,...(d.projects||[])],
      overhead_registry:[...(d.overhead_registry||[]),...newOhEntries]
    }));
    console.log('[Migration] Created FK project "Ольга Лукина" with payments, overheads, and overhead_registry entries');
  },[]);

  /* One-time migration: move overhead_registry entries to rg='HR' where applicable */
  useEffect(()=>{
    const reg=data.overhead_registry||[];
    const prjs=data.projects||[];
    let changed=false;
    let updated=reg.map(e=>({...e}));
    /* Rule 1: АХО + cls содержит 'найм' → HR */
    updated=updated.map(e=>{if(e.rg==='АХО'&&(e.cls||'').toLowerCase().includes('найм')){changed=true;return {...e,rg:'HR'};}return e;});
    /* Rule 2: PP + cls='обработка данных' + comment содержит 'ЦЕС'/'CES' (подрядчик HR) → HR */
    updated=updated.map(e=>{if(e.rg==='PP'&&(e.cls||'').toLowerCase()==='обработка данных'&&((e.comment||'').toLowerCase().includes('цес')||(e.comment||'').toLowerCase().includes('ces'))){changed=true;return {...e,rg:'HR'};}return e;});
    /* Rule 3: ФК-записи с project_id, ссылающимся на не-ФК проект → исправить на ФК-проект */
    updated=updated.map(e=>{
      if(e.rg==='ФК'&&e.project_id){
        const pr=prjs.find(p=>p.id===e.project_id);
        if(pr&&pr.project_type!=='ФК'){
          /* Ищем ФК-проект с похожим именем */
          const base=(pr.name||'').replace(/[,\.\s]+(исследование|REST|rest|рест).*/i,'').trim().toLowerCase();
          const fkMatch=prjs.find(p=>p.project_type==='ФК'&&p.name.toLowerCase().includes(base));
          if(fkMatch){changed=true;return {...e,project_id:fkMatch.id};}
        }
      }
      return e;
    });
    /* Rule 4: IB → ФК/РГ1/РГ2 по project_type и work_group проекта */
    updated=updated.map(e=>{
      if(e.rg==='IB'||e.rg==='РГ1'||e.rg==='РГ2'){
        if(e.project_id){
          const pr=prjs.find(p=>p.id===e.project_id);
          if(pr&&pr.project_type==='ФК'){changed=true;return {...e,rg:'ФК'};}
          if(pr&&e.rg==='IB'){const wg=pr.work_group||'';changed=true;return {...e,rg:wg==='РГ2'?'РГ2':'РГ1'};}
        }
        if(e.rg==='IB'){changed=true;return {...e,rg:'РГ1'};}
      }
      return e;
    });
    /* Rule 5: Дедупликация — если для одного project_id+date+amount есть дубли, оставить только один */
    const seen=new Map();
    const toRemove=new Set();
    updated.forEach(e=>{
      if(!e.project_id)return;
      const key=e.project_id+'|'+(e.date||'').slice(0,7)+'|'+Math.round(Number(e.amount));
      if(seen.has(key)){
        /* Оставляем запись с rg ФК или с synced_oh_id, удаляем дубль */
        const prev=seen.get(key);
        const prevEntry=updated.find(x=>x.id===prev);
        if(prevEntry){
          const keepPrev=prevEntry.synced_oh_id||prevEntry.rg==='ФК';
          const keepCurr=e.synced_oh_id||e.rg==='ФК';
          if(keepCurr&&!keepPrev){toRemove.add(prev);seen.set(key,e.id);}
          else{toRemove.add(e.id);}
          changed=true;
        }
      }else{seen.set(key,e.id);}
    });
    if(toRemove.size>0){
      updated=updated.filter(e=>!toRemove.has(e.id));
      console.log('[Migration] Removed',toRemove.size,'duplicate overhead_registry entries');
    }
    /* Rule 6: Старые мелкие проекты (Куликовский, Румяный каравай, Полимакс) → PP */
    const _oldProjNames=['куликовск','румяный','полимакс'];
    updated=updated.map(e=>{
      if(e.project_id&&_oldProjNames.some(n=>(e.comment||'').toLowerCase().includes(n))){
        const pr=prjs.find(p=>p.id===e.project_id);
        if(pr&&_oldProjNames.some(n=>(pr.name||'').toLowerCase().includes(n))){
          changed=true;return {...e,rg:'PP',project_id:null,scope:'company'};
        }
      }
      if(!e.project_id&&_oldProjNames.some(n=>(e.comment||'').toLowerCase().includes(n))){
        if(e.rg!=='PP'){changed=true;return {...e,rg:'PP',scope:'company'};}
      }
      return e;
    });
    /* Rule 7: Ольга Лукина — все записи с rg≠'ФК' → ФК, привязать к проекту; дубли удалить */
    const _olPid='e7a1b2c3-d4e5-4f67-8a9b-0c1d2e3f4a5b';
    const _olSeen=new Map();
    const _olRemove=new Set();
    updated.forEach(e=>{
      if((e.comment||'').toLowerCase().includes('лукина')){
        if(e.rg!=='ФК'){e.rg='ФК';e.project_id=_olPid;e.scope='project';changed=true;}
        if(!e.project_id){e.project_id=_olPid;e.scope='project';changed=true;}
        const mk=(e.date||'').slice(0,7)+'|'+Math.round(Number(e.amount));
        if(_olSeen.has(mk)){_olRemove.add(e.synced_oh_id?_olSeen.get(mk):e.id);changed=true;}
        else{_olSeen.set(mk,e.id);}
      }
    });
    if(_olRemove.size>0)updated=updated.filter(e=>!_olRemove.has(e.id));
    /* Rule 8: Шатим — проект 2025 года, расход 2026 → prior_year:true (не учитывать в 2026) */
    updated=updated.map(e=>{
      if((e.comment||'').toLowerCase().includes('шатим')&&!e.prior_year){
        changed=true;return {...e,prior_year:true};
      }
      return e;
    });
    /* Rule 9a: НИЦ — проект РГ2, ошибочно попал в РГ1 → исправить на РГ2 */
    updated=updated.map(e=>{
      if((e.comment||'').toLowerCase().includes('ниц')&&e.rg==='РГ1'){
        const pr=e.project_id?prjs.find(p=>p.id===e.project_id):null;
        if(!pr||(pr.work_group||'')==='РГ2'){changed=true;return {...e,rg:'РГ2'};}
      }
      return e;
    });
    /* Rule 9b: Paper Planes [IB общие] — неидентифицированный агрегат (4 операции, 25639) → PP */
    updated=updated.map(e=>{
      const _c=(e.comment||'').toLowerCase();
      if((_c.includes('paper planes')||_c.includes('paper plane'))&&['IB','РГ1','РГ2'].includes(e.rg)&&!e.project_id){
        changed=true;return {...e,rg:'PP',scope:'company'};
      }
      return e;
    });
    /* Rule 10: Корректировки РГ2 по результатам сверки */
    /* 10a: Абрау Дюрсо 106000 — операция 2025 года, удалить из реестра */
    const _beforeAbr=updated.length;
    updated=updated.filter(e=>!((e.comment||'').toLowerCase().includes('абрау')&&Math.round(Number(e.amount))===106000));
    if(updated.length<_beforeAbr){changed=true;console.log('[Migration] Removed Абрау Дюрсо 106000 (2025 operation)');}
    /* 10b: Олсо — сумма 3001 → 3000 */
    updated=updated.map(e=>{
      if((e.comment||'').toLowerCase().includes('олсо')&&Math.round(Number(e.amount))===3001){
        changed=true;return {...e,amount:3000};
      }
      return e;
    });
    /* 10c: Сантерра — сумма 53275 → 53675 */
    updated=updated.map(e=>{
      if((e.comment||'').toLowerCase().includes('сантерр')&&Math.round(Number(e.amount))===53275){
        changed=true;return {...e,amount:53675};
      }
      return e;
    });
    /* 10d: Епифанова 97000 — добавить в реестр РГ2 (январь) */
    const _norm10=s=>(s||'').toLowerCase().replace(/[\s\.\-\/]+/g,'').trim();
    if(!updated.some(e=>_norm10(e.comment).includes('епифанов')&&Math.round(Number(e.amount))===97000)){
      const _epProj=prjs.find(p=>_norm10(p.name).includes('епифанов'));
      updated.push({id:uuid(),date:'2026-01-15',amount:97000,rg:'РГ2',category:'Подрядчики',cls:'прочее',format:'счет',responsible:'',comment:'Клиника Епифанова',project_id:_epProj?_epProj.id:'',scope:'project',cf_type:'OCF',source:'manual',verified:false});
      changed=true;console.log('[Migration] Added Епифанова 97000 to registry');
    }
    /* 10e: Салюс Легал 10000 — добавить в реестр РГ2 (январь, билеты) */
    if(!updated.some(e=>_norm10(e.comment).includes('салюс')&&Math.round(Number(e.amount))===10000)){
      const _salProj=prjs.find(p=>_norm10(p.name).includes('салюс'));
      updated.push({id:uuid(),date:'2026-01-15',amount:10000,rg:'РГ2',category:'Логистика',cls:'билеты',format:'счет',responsible:'',comment:'Салюс Легал',project_id:_salProj?_salProj.id:'',scope:'project',cf_type:'OCF',source:'manual',verified:false});
      changed=true;console.log('[Migration] Added Салюс Легал 10000 to registry');
    }
    /* 10f: Мореавто 31363 — расход 2025 года, удалить из реестра полностью */
    const _beforeMore=updated.length;
    updated=updated.filter(e=>!(_norm10(e.comment).includes('мореавто')&&Math.round(Number(e.amount))===31363));
    if(updated.length<_beforeMore){changed=true;console.log('[Migration] Removed Мореавто 31363 (2025 operation)');}
    /* Rule 11: Валютные операции PP (УЗБ/КЗ/USD) — агрегированные записи за янв-фев 2026 */
    const _fxEntries=[
      {date:'2026-01-15',amount:172472,cat:'IT решения',cls:'софт',comment:'Валютные подписки (OpenAI, Microsoft, Zoom, Notion, Figma и др.)'},
      {date:'2026-02-15',amount:20477,cat:'IT решения',cls:'софт',comment:'Валютные подписки (Claude, Figma, KREA, Zoom)'},
      {date:'2026-01-31',amount:32479,cat:'АХО',cls:'юр.услуги',comment:'Бухгалтер УЗБ+КЗ (валюта)'},
      {date:'2026-02-28',amount:33013,cat:'АХО',cls:'юр.услуги',comment:'Бухгалтер УЗБ+КЗ (валюта)'},
      {date:'2026-01-31',amount:7093,cat:'АХО',cls:'аренда помещения',comment:'Аренда юр.адреса УЗБ (валюта)'},
      {date:'2026-02-28',amount:7200,cat:'АХО',cls:'аренда помещения',comment:'Аренда юр.адреса УЗБ (валюта)'},
    ];
    _fxEntries.forEach(fx=>{
      if(!updated.some(e=>e.rg==='PP'&&(e.comment||'').includes('валют')&&(e.comment||'').toLowerCase().includes(fx.cls.toLowerCase().slice(0,4))&&(e.date||'').startsWith(fx.date.slice(0,7))&&Math.round(Number(e.amount))===fx.amount)){
        updated.push({id:uuid(),date:fx.date,amount:fx.amount,rg:'PP',category:fx.cat,cls:fx.cls,format:'карта УЗБ',responsible:'Рахматов Шохрух',comment:fx.comment,project_id:'',scope:'company',cf_type:'OCF',source:'manual',verified:false,currency_ops:true});
        changed=true;
      }
    });
    if(changed)console.log('[Migration] Added FX operations to PP registry');
    if(changed){
      setData(d=>({...d,overhead_registry:updated}));
      console.log('[Migration] Fixed overhead_registry entries');
    }
    /* Rule 12: Иутин Игорь — врем. ЧАрт-директор янв 2026.
       Янв: 170К производство + 80К HR = 250К. Фев-Мар: 75К производство. После марта — уход.
       HR-доплата за январь = 80К */
    const _kb12=data.kb_budget||[];
    /* Удалить старую запись 175К если есть, заменить на 80К */
    let _kb12u=[...(_kb12||[])];
    const _oldIutin=_kb12u.findIndex(x=>x.cf_type==='SALARY_HR_ADJ'&&(x.month||'')==='2026-01'&&(x.notes||'').includes('Иутин')&&Math.round(Number(x.amount_plan))===175000);
    if(_oldIutin>=0){_kb12u.splice(_oldIutin,1);setData(d=>({...d,kb_budget:_kb12u}));console.log('[Migration Rule 12] Removed old Iutin 175K entry');}
    if(!_kb12u.some(x=>x.cf_type==='SALARY_HR_ADJ'&&(x.month||'')==='2026-01'&&(x.notes||'').includes('Иутин')&&Math.round(Number(x.amount_plan))===80000)){
      const _iutinEntry={id:uuid(),name:'Корр. ЗП HR (Иутин — врем. ЧАрт-директор)',person_id:'',amount_plan:80000,amount_fact:80000,month:'2026-01',cf_type:'SALARY_HR_ADJ',notes:'Иутин Игорь: янв 170К прод + 80К HR. Фев-Мар 75К прод. Уход после марта.',created_at:now()};
      setData(d=>({...d,kb_budget:[_iutinEntry,...(d.kb_budget||[])]}));
      console.log('[Migration Rule 12] Added Iutin HR salary adjustment for Jan 2026: 80000');
    }
    /* Rule 12b: Иутин — salary_history + career_events + fire_date */
    const _iutinP=(data.persons||[]).find(p=>(p.name||'').toLowerCase().includes('иутин'));
    if(_iutinP&&!((_iutinP.career_events||[]).some(e=>e.note&&e.note.includes('ЧАрт-директор')))){
      const _ish=[
        {amount:170000,effective_date:'2026-01-01',grade:_iutinP.grade||'C3'},
        {amount:75000,effective_date:'2026-02-01',grade:_iutinP.grade||'C3'},
      ];
      const _ice=[
        {id:uuid(),type:'temp_role',date:'2026-01-01',note:'Врем. ЧАрт-директор. Янв: 170К прод + 80К HR = 250К',new_salary:170000,new_grade:null,new_dept:'HR',new_position:'Врем. ЧАрт-директор'},
        {id:uuid(),type:'salary_change',date:'2026-02-01',note:'Возврат в производство. Фев-Мар: 75К',new_salary:75000,new_grade:null,new_dept:null,new_position:null},
        {id:uuid(),type:'fire',date:'2026-03-31',note:'Плановый уход после марта 2026',new_salary:null,new_grade:null,new_dept:null,new_position:null},
      ];
      const _curSh=(_iutinP.salary_history||[]).length>0?_iutinP.salary_history:(_iutinP.hire_date?[{amount:Number(_iutinP.salary_monthly)||75000,effective_date:_iutinP.hire_date,grade:_iutinP.grade||''}]:[]);
      setData(d=>({...d,persons:d.persons.map(p=>p.id===_iutinP.id?{...p,salary_history:[..._curSh,..._ish],career_events:[...(p.career_events||[]),..._ice],fire_date:'2026-03-31',salary_monthly:75000}:p)}));
      console.log('[Migration Rule 12b] Set Iutin career: Jan 175K prod+80K HR, Feb-Mar 75K, fire 2026-03-31');
    }
    /* Rule 13: Рекомендации по развитию DoubleDiamond → канбан Знания */
    const _recs13=data.recommendations||[];
    if(!_recs13.some(r=>(r.title||'').includes('Cash Flow Engine'))){
      const _bid13=uuid();const _n13=now();
      const _roadmap=[
        {cat:'finance',title:'Cash Flow Engine',desc:'Rolling forecast остатка на счетах на 13 недель вперёд на основе графика платежей клиентов и обязательных расходов. Алерты кассовых разрывов.'},
        {cat:'process',title:'Утилизация и ёмкость (Utilization & Capacity)',desc:'Дашборд утилизации: % оплачиваемых часов по сотрудникам, грейдам, РГ. Обратная сторона — свободные часы на 4-8 недель для планирования новых проектов.'},
        {cat:'mgmt',title:'Pipeline продаж и конверсия',desc:'Воронка: лиды → квалификация → КП → выигрыш/проигрыш. Привязка к продавцам, средние циклы, прогноз выручки Q3-Q4.'},
        {cat:'finance',title:'Юнит-экономика проекта (Project P&L карточка)',desc:'Полный P&L по проекту: gross → налоги → net revenue → себестоимость часов → маржа → аллоцированные overheads → profit. Бенчмарк vs средняя по РГ.'},
        {cat:'data',title:'Бенчмаркинг по типам проектов',desc:'Аналитика Old Delivery vs New Delivery: средний чек, длительность, маржа, задержки оплат. Какие проекты реально кормят фирму.'},
        {cat:'mgmt',title:'Реестр рисков (Risk Register)',desc:'Реестр рисков по проектам: вероятность × импакт, привязка к финмодели. Авто-алерты: задержка 30+ дней, перерасход 20%+, красная зона РГ.'},
        {cat:'team',title:'Система KPI и OKR',desc:'Иерархия целей: компания → РГ → сотрудник → метрики. Revenue per consultant, utilization, project margin, client NPS, retention.'},
        {cat:'finance',title:'Прогнозная модель ФОТ',desc:'Сценарное моделирование: найм +2 в Q2, повышение грейдов Q3, увольнения. Пересчёт SGA и чистой прибыли «что если».'},
        {cat:'data',title:'Клиентская аналитика (Client LTV)',desc:'LTV клиента, частота возвращений, средний чек, тренд. Топ-10 по LTV vs топ-10 по маржинальности.'},
        {cat:'finance',title:'Автоматический P&L и Balance Sheet',desc:'Полноценный P&L в формате РСБУ/МСФО: операционная, финансовая, инвестиционная деятельность. Управленческая отчётность.'},
        {cat:'process',title:'Документооборот и согласования',desc:'Трекинг договоров, актов, счетов: черновик → согласование → подписание → закрытие. Привязка к проектам и платежам.'},
        {cat:'data',title:'Интеграционный слой',desc:'Экспорт в Excel, импорт банковских выписок, синхронизация с 1С. Масштабирование ввода данных за пределы 50 проектов.'},
      ];
      const _entries13=_roadmap.map(r=>({id:uuid(),category:r.cat,title:r.title,description:r.desc,status:'backlog',created_at:_n13,batch_id:_bid13}));
      setData(d=>({...d,recommendations:[..._entries13,...(d.recommendations||[])]}));
      console.log('[Migration Rule 13] Added 12 development recommendations to Knowledge kanban');
    }
    /* Rule 15: Create default user accounts if users[] is empty */
    if(!(data.users||[]).length){
      const _hp=async(pwd)=>{const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(pwd));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');};
      (async()=>{
        const adminHash=await _hp('070303');
        const userHash=await _hp('111111');
        const persons=data.persons||[];
        const _findP=(surname)=>persons.find(p=>(p.name||'').includes(surname));
        const pTokaeva=_findP('Токаева');
        const pKhudovekov=_findP('Худовеков');
        const pKartveli=_findP('Картвелишвили');
        const defaultUsers=[
          {id:'__ADMIN__',login:'ibalahnin',password_hash:adminHash,name:'Илья Балахнин',person_id:null,role:'admin',is_active:true,created_at:'2026-02-21',last_login:null},
          {id:'__USER_NT__',login:'ntokaeva',password_hash:userHash,name:'Наталья Токаева',person_id:pTokaeva?pTokaeva.id:null,role:'user',is_active:true,created_at:'2026-02-21',last_login:null},
          {id:'__USER_SK__',login:'skhudovekov',password_hash:userHash,name:'Сергей Худовеков',person_id:pKhudovekov?pKhudovekov.id:null,role:'user',is_active:true,created_at:'2026-02-21',last_login:null},
          {id:'__USER_GK__',login:'gkartveli',password_hash:userHash,name:'Георгий Картвелишвили',person_id:pKartveli?pKartveli.id:null,role:'user',is_active:true,created_at:'2026-02-21',last_login:null},
          {id:'__USER_YA__',login:'yadamova',password_hash:userHash,name:'Юлия Адамова',person_id:_findP('Адамова')?_findP('Адамова').id:null,roles:['finance'],role:'finance',is_active:true,created_at:'2026-02-21',last_login:null}
        ];
        setData(d=>({...d,users:defaultUsers}));
        console.log('[Migration Rule 15] Created default user accounts: ibalahnin (admin), ntokaeva, skhudovekov, gkartveli, yadamova (finance)');
      })();
    }
    /* Rule 18+19: Ensure Адамова Юлия person + yadamova account exist */
    setData(d=>{
      let nd={...d};let changed=false;
      /* Person */
      if(!(nd.persons||[]).find(p=>(p.name||'').includes('Адамова'))){
        nd.persons=[...(nd.persons||[]),{id:'__P_ADAMOVA__',name:'Адамова Юлия',department:'Финансы',departments:['Финансы'],grade:'C3',salary_monthly:0,is_active:true,hire_date:'2026-02-01',competencies:{},paei:'',notes:'',fire_date:'',weekly_timesheets:[]}];
        changed=true;console.log('[Migration Rule 18] Created person: Адамова Юлия');
      }
      /* User account — sync creation (use pre-computed hash) */
      if((nd.users||[]).length>0&&!(nd.users||[]).find(u=>u.login==='yadamova')){
        const pA=(nd.persons||[]).find(p=>(p.name||'').includes('Адамова'));
        /* SHA-256 of '111111' pre-computed */
        const yaHash='bcb15f821479b4d5772bd0ca866c00ad5f926e3580720659cc80d39c9d09802a';
        nd.users=[...(nd.users||[]),{id:'__USER_YA__',login:'yadamova',password_hash:yaHash,name:'Юлия Адамова',person_id:pA?pA.id:null,roles:['finance'],role:'finance',is_active:true,created_at:now(),last_login:null}];
        changed=true;console.log('[Migration Rule 19] Created user yadamova (finance)');
      }
      /* Rule 20: Ensure existing users have roles array */
      (nd.users||[]).forEach((u,i)=>{if(!u.roles){nd.users=nd.users.map((x,j)=>j===i?{...x,roles:[x.role||'user']}:x);changed=true;}});
      return changed?nd:d;
    });
    /* Rule 21: One-time clear of non-chat registry entries + retroactively link chat overhead requests */
    if(!localStorage.getItem('pp_rule21_done')){
      setData(d=>{
        let nd={...d};let changed=false;
        /* Step 1: Remove all registry entries NOT created from chat */
        const oldReg=nd.overhead_registry||[];
        const chatEntries=oldReg.filter(e=>e.source==='chat');
        if(oldReg.length!==chatEntries.length){
          nd.overhead_registry=chatEntries;
          changed=true;
          console.log('[Migration Rule 21] Cleared '+(oldReg.length-chatEntries.length)+' non-chat registry entries, kept '+chatEntries.length);
        }
        /* Step 2: Find chat messages with overhead_request but no reg_id, create registry entries */
        const msgs=nd.chat_messages||[];
        const existingRegIds=new Set((nd.overhead_registry||[]).map(e=>e.id));
        msgs.forEach((m,mi)=>{
          if(m.overhead_request&&!m.overhead_request.reg_id){
            const req=m.overhead_request;
            const regId=Date.now().toString(36)+Math.random().toString(36).slice(2,8)+mi;
            /* Update message with reg_id */
            nd.chat_messages=nd.chat_messages.map(mm=>mm.id===m.id?{...mm,overhead_request:{...mm.overhead_request,reg_id:regId}}:mm);
            /* Create registry entry */
            const entry={id:regId,date:req.date||m.created_at?.slice(0,10)||new Date().toISOString().slice(0,10),amount:Number(req.amount)||0,rg:req.rg||'КБ',category:req.category||'Прочее',cls:req.cls||'прочее',format:req.format||'счет',responsible:req.responsible||'',comment:req.comment||'',project_id:req.project_id||null,scope:req.scope||(req.project_id?'project':'company'),cf_type:req.cf_type||'OCF',verified:false,synced_oh_id:null,synced_kb_id:null,source:'chat',prior_year:req.prior_year||false,oh_status:req.status||'PENDING',oh_created_by:req.created_by||m.author_name||'',oh_approved_by:req.approved_by||null,oh_approved_at:req.approved_at||null,created_at:m.created_at||new Date().toISOString()};
            nd.overhead_registry=[entry,...(nd.overhead_registry||[])];
            changed=true;
            console.log('[Migration Rule 21] Created registry entry for chat message '+m.id+' → reg '+regId);
          }
          /* Also handle messages that have reg_id but the registry entry is missing (was cleared) */
          if(m.overhead_request&&m.overhead_request.reg_id&&!existingRegIds.has(m.overhead_request.reg_id)){
            const req=m.overhead_request;
            const regId=req.reg_id;
            const entry={id:regId,date:req.date||m.created_at?.slice(0,10)||new Date().toISOString().slice(0,10),amount:Number(req.amount)||0,rg:req.rg||'КБ',category:req.category||'Прочее',cls:req.cls||'прочее',format:req.format||'счет',responsible:req.responsible||'',comment:req.comment||'',project_id:req.project_id||null,scope:req.scope||(req.project_id?'project':'company'),cf_type:req.cf_type||'OCF',verified:req.status==='APPROVED',synced_oh_id:null,synced_kb_id:null,source:'chat',prior_year:req.prior_year||false,oh_status:req.status||'PENDING',oh_created_by:req.created_by||m.author_name||'',oh_approved_by:req.approved_by||null,oh_approved_at:req.approved_at||null,created_at:m.created_at||new Date().toISOString()};
            nd.overhead_registry=[entry,...(nd.overhead_registry||[])];
            existingRegIds.add(regId);
            changed=true;
            console.log('[Migration Rule 21] Re-created registry entry for chat message '+m.id+' (reg_id: '+regId+')');
          }
        });
        return changed?nd:d;
      });
      localStorage.setItem('pp_rule21_done','1');
    }
    /* Rule 16: Sync 85 active projects from Notion CSV (run once) */
    if(!localStorage.getItem('pp_rule16_done')){
      const _CSV=[{n:'075G',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Abis / АБИС',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'BI.Zone. Исследование',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'CosySoft / КозиСофт',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Expert',rg:'РГ2',t:'Old Delivery',seg:'2'},{n:'Olso/ Олсо',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Skillspace / СкиллСпейс',rg:'РГ2',t:'Old Delivery',seg:'2'},{n:'А-Икра',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Абрау-Дюрсо',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Авалон-П',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Авантпак',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'АДГ',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Азбука вкуса HR',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Айпол',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Аконит',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Альфамедэкс',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'АНД Азия (абонентка)',rg:'РГ1',t:'New Delivery',seg:'3'},{n:'Арвад',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Аргон',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Аюна',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Белый кролик',rg:'РГ2',t:'Old Delivery',seg:'4'},{n:'Бифиформ',rg:'РГ2',t:'Old Delivery',seg:'2'},{n:'Бонум',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'БП Модули',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Бургер Кинг / Burger King',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Вастэко',rg:'РГ1',t:'Old Delivery',seg:'3'},{n:'Вастэко (иссл)',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Венеция 2.0',rg:'РГ1',t:'Old Delivery',seg:'3'},{n:'ВУУ (абонентка)',rg:'РГ1',t:'New Delivery',seg:'3'},{n:'Глобал Имплант',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'ГриГри',rg:'РГ1',t:'Old Delivery',seg:'3'},{n:'Деафон',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Дзорт',rg:'РГ2',t:'New Delivery',seg:'3'},{n:'Евразия Групп (ФЦК)',rg:'РГ1',t:'Old Delivery',seg:'3'},{n:'ИЗТТ. CJM',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Квант',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Клиника Епифанова',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Кронус. Оргструктура',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Латитудо',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'ЛСБР',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Медицинский центр 21 век',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Микрос',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Минстрой. Модель оценки',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'МИС',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Мореавто',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Мореавто (дашборд)',rg:'РГ1',t:'Old Delivery',seg:'2'},{n:'МРТ Центр',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'НИЦ',rg:'РГ2',t:'New Delivery',seg:'1'},{n:'ОЗЭУ',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Олжас / AgroInn',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Охана',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Парк Птиц',rg:'РГ2',t:'Old Delivery',seg:'3'},{n:'Полюс Золото',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Рокада мед. Абонент',rg:'РГ1',t:'New Delivery',seg:'1'},{n:'Ростовский девелопер',rg:'РГ2',t:'Old Delivery',seg:'2'},{n:'РосЭкоПласт ( pro bono )',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Салюс Легал',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Сантерра',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Саргис',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Севенком',rg:'РГ2',t:'Old Delivery',seg:'2'},{n:'Северавто',rg:'РГ1',t:'Old Delivery',seg:'2'},{n:'Серф',rg:'РГ2',t:'Old Delivery',seg:'2'},{n:'СибТехноСтрой',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Симметрия',rg:'РГ1',t:'Old Delivery',seg:'3'},{n:'Стецык 2 (марк. страт + лендинги)',rg:'РГ2',t:'Old Delivery',seg:'2'},{n:'Текос (исследование)',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Текстильнова (дашборд)',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Теплопоток (абонентка)',rg:'РГ1',t:'New Delivery',seg:'3'},{n:'Термекс. Найм CEO',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Терра HR',rg:'РГ1',t:'Old Delivery',seg:'3'},{n:'Терра. Lean',rg:'РГ1',t:'Old Delivery',seg:'3'},{n:'ТОФС',rg:'РГ2',t:'Old Delivery',seg:'3'},{n:'Транзитсити',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Транскемикл сессия',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Уйде 2.0',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Финго',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Финестра',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Фитнес Формула 2',rg:'РГ2',t:'Old Delivery',seg:'2'},{n:'Фортепьяно',rg:'РГ1',t:'Old Delivery',seg:'2'},{n:'Фудкорт Рейсинг',rg:'РГ2',t:'Old Delivery',seg:'1'},{n:'Х5-Транспорт',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Чароит',rg:'РГ2',t:'Old Delivery',seg:'2'},{n:'Чиббис',rg:'РГ2',t:'Old Delivery',seg:'2'},{n:'Шатим',rg:'РГ1',t:'Old Delivery',seg:'1'},{n:'Шидель',rg:'РГ1',t:'Old Delivery',seg:'2'}];
      const _norm=s=>(s||'').toLowerCase().replace(/[\s\.\-\/\(\)]+/g,'').trim();
      const _matchName=(csvN,projN)=>{
        const cn=_norm(csvN),pn=_norm(projN);
        if(cn===pn)return 'exact';
        if((cn.length>=3&&pn.length>=3)&&(cn.includes(pn)||pn.includes(cn)))return 'strong';
        /* Check slash alternatives */
        const cParts=csvN.split(/\s*\/\s*/).map(_norm);
        const pParts=projN.split(/\s*\/\s*/).map(_norm);
        for(const cp of cParts)for(const pp of pParts){
          if(cp===pp&&cp.length>=3)return 'strong';
          if((cp.includes(pp)||pp.includes(cp))&&Math.min(cp.length,pp.length)>=3)return 'medium';
        }
        /* First word match */
        const cw=(csvN.split(/\s/)[0]||'').toLowerCase();
        const pw=(projN.split(/\s/)[0]||'').toLowerCase();
        if(cw&&pw&&cw===pw&&cw.length>=3)return 'medium';
        return null;
      };
      /* Ticker generator: transliterate + take first 4 unique chars */
      const _TR={'А':'A','Б':'B','В':'V','Г':'G','Д':'D','Е':'E','Ё':'E','Ж':'ZH','З':'Z','И':'I','Й':'Y','К':'K','Л':'L','М':'M','Н':'N','О':'O','П':'P','Р':'R','С':'S','Т':'T','У':'U','Ф':'F','Х':'KH','Ц':'TS','Ч':'CH','Ш':'SH','Щ':'SC','Ъ':'','Ы':'Y','Ь':'','Э':'E','Ю':'YU','Я':'YA'};
      const _genTicker=(name,usedSet)=>{
        let clean=(name||'').replace(/\s*\([^)]*\)/g,'').trim();
        if(clean.includes('/'))clean=clean.split('/')[0].trim();
        clean=clean.replace(/[.\-\s]+/g,'');
        let lat='';
        for(const ch of clean.toUpperCase()){if(_TR[ch])lat+=_TR[ch];else if(/[A-Z0-9]/.test(ch))lat+=ch;}
        let base=lat.slice(0,4);if(base.length<2)base='PROJ';
        let code=base;let suf=2;
        while(usedSet.has(code)&&suf<100){code=base.slice(0,3)+suf;suf++;}
        usedSet.add(code);return code;
      };
      const _usedCodes=new Set(data.projects.map(p=>(p.code||'').toUpperCase()).filter(Boolean));
      let updated=0,created=0;
      const projects=[...data.projects];
      _CSV.forEach(csv=>{
        let bestMatch=null,bestStrength=null;
        projects.forEach(p=>{
          const s=_matchName(csv.n,p.name);
          if(s&&(!bestStrength||['medium','strong','exact'].indexOf(s)>['medium','strong','exact'].indexOf(bestStrength))){
            bestMatch=p;bestStrength=s;
          }
        });
        if(bestMatch){
          /* Update existing project */
          const upd={};
          if(csv.t&&bestMatch.project_type!==csv.t)upd.project_type=csv.t;
          if(csv.rg&&bestMatch.work_group!==csv.rg)upd.work_group=csv.rg;
          if(Object.keys(upd).length>0){
            Object.assign(bestMatch,upd);
            updated++;
            console.log('[Rule 16] Updated "'+bestMatch.name+'" ('+bestStrength+' match with "'+csv.n+'"): '+JSON.stringify(upd));
          }
        } else {
          /* Create new project */
          const _code=_genTicker(csv.n,_usedCodes);
          const newP={
            id:([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)),
            code:_code,
            name:csv.n,
            project_type:csv.t,
            work_group:csv.rg,
            client_id:'',
            status:'active',
            country:'Россия',
            start_date:'',
            dd_phase:'Explore',
            total_contract_value:0,
            tax_rate:0,
            assignments:[],
            payments:[],
            tracks:[],
            overheads:[],
            hypothesisBoard:{goals:[],hypotheses:[]},
            documents:[],
            competencies:{},
            admin_scale:{},
            tasks:[],
            pnl_notes:'',
            nd_payment_period:'quarterly',
            nd_period_cost:0,
            nd_period_start:'',
            nd_period_end:'',
            nd_num_periods:0,
            nd_has_success_fee:false,
            nd_success_fee:0,
            created_at:new Date().toISOString()
          };
          projects.push(newP);
          created++;
          console.log('[Rule 16] Created new project "'+csv.n+'" ('+csv.t+', '+csv.rg+')');
        }
      });
      /* Also assign codes to any project missing one */
      let codeFilled=0;
      projects.forEach(p=>{
        if(!p.code){
          p.code=_genTicker(p.name,_usedCodes);
          codeFilled++;
          console.log('[Rule 16] Assigned code "'+p.code+'" to "'+p.name+'"');
        }
      });
      if(updated>0||created>0||codeFilled>0){
        setData(d=>({...d,projects:projects}));
        console.log('[Migration Rule 16] CSV sync complete: '+updated+' updated, '+created+' created, '+codeFilled+' codes assigned');
      }
      localStorage.setItem('pp_rule16_done','1');
    }
    /* Rule 17: Always assign codes to any project missing one (idempotent) */
    {
      const _TR17={'А':'A','Б':'B','В':'V','Г':'G','Д':'D','Е':'E','Ё':'E','Ж':'ZH','З':'Z','И':'I','Й':'Y','К':'K','Л':'L','М':'M','Н':'N','О':'O','П':'P','Р':'R','С':'S','Т':'T','У':'U','Ф':'F','Х':'KH','Ц':'TS','Ч':'CH','Ш':'SH','Щ':'SC','Ъ':'','Ы':'Y','Ь':'','Э':'E','Ю':'YU','Я':'YA'};
      const _genT17=(name,usedSet)=>{
        let clean=(name||'').replace(/\s*\([^)]*\)/g,'').trim();
        if(clean.includes('/'))clean=clean.split('/')[0].trim();
        clean=clean.replace(/[.\-\s]+/g,'');
        let lat='';
        for(const ch of clean.toUpperCase()){if(_TR17[ch])lat+=_TR17[ch];else if(/[A-Z0-9]/.test(ch))lat+=ch;}
        let base=lat.slice(0,4);if(base.length<2)base='PROJ';
        let code=base;let suf=2;
        while(usedSet.has(code)&&suf<100){code=base.slice(0,3)+suf;suf++;}
        usedSet.add(code);return code;
      };
      const noCode=data.projects.filter(p=>!p.code);
      if(noCode.length>0){
        const used17=new Set(data.projects.map(p=>(p.code||'').toUpperCase()).filter(Boolean));
        const patchMap={};
        noCode.forEach(p=>{
          const c=_genT17(p.name,used17);
          patchMap[p.id]=c;
          console.log('[Rule 17] Assigned code "'+c+'" to "'+p.name+'"');
        });
        setData(d=>({...d,projects:d.projects.map(p=>patchMap[p.id]?{...p,code:patchMap[p.id]}:p)}));
        console.log('[Migration Rule 17] Assigned codes to '+noCode.length+' projects');
      }
    }
  },[]);

  const addClient=(c)=>{const cl={id:uuid(),created_at:now(),...c};setData(d=>({...d,clients:[...d.clients,cl]}));showToast('Клиент добавлен');return cl;};

  const addPerson=(p)=>{const pe={id:uuid(),is_active:1,created_at:now(),assignments:[],taskCount:0,timeEntryCount:0,weekly_timesheets:[],...p};setData(d=>({...d,persons:[...d.persons,pe]}));showToast('Сотрудник добавлен');return pe;};

  const fmtD=(d)=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const addProject=(p)=>{
    const id=uuid();const n=now();
    const _cl=data.clients.find(c=>c.id===p.client_id);
    if(_cl&&_cl.country&&!p.country)p.country=_cl.country;
    if((_cl&&_cl.country==='Казахстан'||p.country==='Казахстан')&&!p.tax_rate)p.tax_rate=20;
    const isND=p.project_type==='New Delivery'&&(Number(p.nd_num_periods)||0)>0;
    const isFK=p.project_type==='ФК'&&(Number(p.fk_planned_months)||0)>0;
    const phases=isFK?(()=>{
      const n=Number(p.fk_planned_months);const sd=p.fk_start_date?new Date(p.fk_start_date):new Date();
      return Array.from({length:n},(_,i)=>{const ms=new Date(sd.getFullYear(),sd.getMonth()+i,1);const me=new Date(sd.getFullYear(),sd.getMonth()+i+1,0);return {id:uuid(),phase_code:'FM'+(i+1),phase_name:'Месяц '+(i+1),track_class:'FK_M'+(i+1),order_num:i+1,status:'NOT_STARTED',period_start:fmtD(ms),period_end:fmtD(me),stages:[]};});
    })():isND?(()=>{
      const n=Number(p.nd_num_periods);const isQ=p.nd_payment_period==='quarterly';
      const ps=p.nd_period_start?new Date(p.nd_period_start):new Date();
      const _pms=isQ?3:1;
      return Array.from({length:n},(_,i)=>{
        const pStart=new Date(ps);pStart.setMonth(pStart.getMonth()+i*_pms);const pEnd=new Date(ps);pEnd.setMonth(pEnd.getMonth()+(i+1)*_pms);pEnd.setDate(pEnd.getDate()-1);
        const label=isQ?'Q'+(i+1):'M'+(i+1);
        return {id:uuid(),phase_code:label,phase_name:isQ?'Квартал '+(i+1):'Месяц '+(i+1),track_class:'ND_'+label,order_num:i+1,status:'NOT_STARTED',period_start:fmtD(pStart),period_end:fmtD(pEnd),stages:[{id:uuid(),stage_code:'WORK',stage_name:'Работа',order_num:1,status:'NOT_STARTED'}]};
      });
    })():data.phaseTemplates.map(pt=>({id:uuid(),phase_template_id:pt.id,phase_code:pt.code,phase_name:pt.name,track_class:pt.track_class,order_num:pt.order_num,status:'NOT_STARTED',stages:data.stageTemplates.map(st=>({id:uuid(),stage_template_id:st.id,stage_code:st.code,stage_name:st.name,order_num:st.order_num,status:'NOT_STARTED'}))}));
    const client=data.clients.find(c=>c.id===p.client_id);
    const _forceStatus=p._force_status||'DRAFT';const _today=new Date().toISOString().slice(0,10);const _initPays=(p._initial_payments||[]);const _hasPaidPast=_initPays.some(t=>t.status==='PAID'&&t.planned_date&&t.planned_date.slice(0,10)<=_today);const _autoStatus=(_forceStatus==='DRAFT'&&_hasPaidPast)?'ACTIVE':_forceStatus;
    const proj={id,code:p.code,name:p.name,client_id:p.client_id,client_name:client?.name||'',client_industry:client?.industry||'',project_type:p.project_type||'Old Delivery',work_group:p.work_group||'',status:_autoStatus,fixed_price:p.fixed_price||0,total_contract_value:isND?(Number(p.nd_period_cost)||0)*phases.length:(isFK?(Number(p.fk_monthly_cost)||0)*Number(p.fk_planned_months||0):(p.total_contract_value||0)),margin_target_pct:p.margin_target_pct||0,start_date:p.start_date||'',target_end_date:p.target_end_date||'',notes:p.notes||'',nd_payment_period:p.nd_payment_period||'',nd_period_cost:p.nd_period_cost||0,nd_period_start:p.nd_period_start||'',nd_period_end:p.nd_period_end||'',nd_has_success_fee:!!p.nd_has_success_fee,nd_success_fee:p.nd_success_fee||0,nd_num_periods:Number(p.nd_num_periods)||0,fk_monthly_cost:p.fk_monthly_cost||0,fk_planned_months:Number(p.fk_planned_months)||0,fk_start_date:p.fk_start_date||'',created_at:n,updated_at:n,assignments:[],blockers:[],tasks:[],tracks:[],phases,payments:isND?phases.map((ph,i)=>({id:uuid(),tranche_number:i+1,amount:Number(p.nd_period_cost)||0,planned_date:ph.period_start?ph.period_start.slice(0,7):'',actual_date:'',accrued_date:'',status:'PLANNED',description:(ph.phase_name||'Период '+(i+1)),prior_year:false,payment_type:'PLANNED',expected_week_monday:''})):(isFK?phases.map((ph,i)=>({id:uuid(),tranche_number:i+1,amount:Number(p.fk_monthly_cost)||0,planned_date:ph.period_start?ph.period_start.slice(0,7):'',actual_date:'',accrued_date:'',status:'PLANNED',description:'Месяц '+(i+1),prior_year:false,payment_type:'PLANNED',expected_week_monday:''})):(p._initial_payments||[]).map((t,i)=>({id:uuid(),tranche_number:t.tranche_number||i+1,amount:Number(t.amount)||0,planned_date:t.planned_date||'',actual_date:t.actual_date||'',accrued_date:t.accrued_date||'',status:t.status||'PLANNED',description:'Транш '+(t.tranche_number||i+1),prior_year:!!t.prior_year,payment_type:'PLANNED',expected_week_monday:''}))),timeEntries:[],tax_rate:p.tax_rate||0,overheads:p.overheads||[],hypothesisBoard:{id:uuid(),goals:[],subjects:[]}};
    setData(d=>({...d,projects:[proj,...d.projects]}));
    showToast('Проект создан: '+p.code+(_autoStatus==='ACTIVE'&&_forceStatus==='DRAFT'?' (авто-активирован)':''));
    return proj;
  };

  /* Auto-log project changes to chat — uses setTimeout to run after main setData completes */
  const _chatLog=(projId,text,extra)=>{
    const chId='proj_'+projId;
    const msgId=uuid();const ts=now();
    setTimeout(()=>{
      setData(d=>{const nd={...d};if(!nd.chat_messages)nd.chat_messages=[];if(!nd.chat_current_user)nd.chat_current_user={id:'me',name:'Илья',avatar:'И'};nd.chat_messages=[...nd.chat_messages,{id:msgId,created_at:ts,channel_id:chId,text,author:{id:'system',name:'Система',avatar:'⚙'},reactions:[],edited:false,is_system:true,allow_thread:true,...(extra||{})}];return nd;});
    },0);
    return msgId;
  };
  const _cashflowLog=(text,tab,extra)=>{
    const msgId=uuid();const ts=now();
    setTimeout(()=>{
      setData(d=>{const nd={...d};if(!nd.chat_messages)nd.chat_messages=[];nd.chat_messages=[...nd.chat_messages,{id:msgId,created_at:ts,channel_id:'cashflow',cashflow_tab:tab||'income',text,author:{id:'system',name:'Система',avatar:'⚙'},reactions:[],edited:false,is_system:true,allow_thread:true,...(extra||{})}];return nd;});
    },0);
    return msgId;
  };

  const updateProject=(id,updates)=>{
    /* ATS sync: when ats_date changes, auto-calculate Mining/Assembling dates */
    if(updates.ats_date!==undefined){const _tmpP={...data.projects.find(x=>x.id===id),...updates};const _synced=syncPhaseDatesFromATS(_tmpP);if(_synced.phases)updates.phases=_synced.phases;}
    const prev=data.projects.find(p=>p.id===id);
    setData(d=>({...d,projects:d.projects.map(p=>p.id===id?{...p,...updates,updated_at:now()}:p)}));
    showToast('Проект обновлён');
    /* Log changes */
    if(prev){const parts=[];const labels={name:'Название',status:'Статус',work_group:'РГ',sales_group:'Гр. продаж',project_type:'Тип',client_name:'Клиент',target_end_date:'Дата окончания',contract_value:'Стоимость',manager_id:'PM',complexity:'Сложность',priority_gd:'Приоритет ГД'};Object.keys(updates).forEach(k=>{if(k==='updated_at')return;const lbl=labels[k]||k;const ov=prev[k];const nv=updates[k];if(String(ov||'')!==String(nv||''))parts.push('**'+lbl+'**: '+(ov||'—')+' → '+(nv||'—'));});if(parts.length)_chatLog(id,'✏️ Обновление проекта\n'+parts.join('\n'));}
  };

  const activateProject=(id)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==id)return p;
      const ph=[...p.phases];
      if(ph[0]){ph[0]={...ph[0],status:'IN_PROGRESS',started_at:now()};if(ph[0].stages?.[0])ph[0].stages[0]={...ph[0].stages[0],status:'IN_PROGRESS',started_at:now()};}
      return {...p,status:'ACTIVE',phases:ph,updated_at:now()};
    })}));
    showToast('Проект активирован');
    _chatLog(id,'🚀 Проект активирован');
  };

  const addAssignment=(projId,personId,roleCode)=>{
    const person=data.persons.find(p=>p.id===personId);
    const a={id:uuid(),person_id:personId,person_name:person?.name||'',person_position:person?.position||'',role_code:roleCode,is_active:1};
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,assignments:[...p.assignments,a]}:p)}));
    showToast('Назначение добавлено');
    _chatLog(projId,'👤 Назначен: **'+(person?.name||'?')+'** ('+roleCode+')');
  };

  const addTrack=(projId,trackTemplateIdOrCustom)=>{
    if(typeof trackTemplateIdOrCustom==='object'){
      /* Custom ND track */
      const c=trackTemplateIdOrCustom;
      const t={id:uuid(),track_template_id:'',track_code:c.code||'ND-'+uuid().slice(0,4),track_name:c.name,track_class:'ND',domain:'',status:'NOT_STARTED',start_date:'',end_date:'',dependencies:[],norm_days:5,track_param:null,nd_period_idx:c.nd_period_idx||null};
      setData(d=>({...d,projects:d.projects.map(p=>{
        if(p.id!==projId)return p;
        const updated={...p,tracks:[...p.tracks,t]};
        /* Auto-create Issue Tree with default goal if empty */
        const hb=updated.hypothesisBoard||{id:uuid(),goals:[],subjects:[]};
        if(!hb.goals||hb.goals.length===0){
          const defaultGoal={id:uuid(),title:'Цель проекта',description:'Автоматически созданная цель при добавлении первого трека',goal_type:'BUSINESS',metrics:[],sub_goals:[]};
          updated.hypothesisBoard={...hb,goals:[defaultGoal]};
        }else if(!updated.hypothesisBoard){
          updated.hypothesisBoard=hb;
        }
        return updated;
      })}));
      showToast('Трек добавлен: '+c.name);
    }else{
      const tt=data.trackTemplates.find(t=>t.id===trackTemplateIdOrCustom);
      const norm=TRACK_NORM_DAYS[tt?.code];const normDays=norm?norm.calc(norm.paramDefault||0):(tt?.track_class==='BPM'?3:5);const t={id:uuid(),track_template_id:trackTemplateIdOrCustom,track_code:tt?.code||'',track_name:tt?.name||'',track_class:tt?.track_class||'',domain:tt?.domain||'',status:'NOT_STARTED',start_date:'',end_date:'',dependencies:[],norm_days:normDays,track_param:norm?.paramDefault||null};
      setData(d=>({...d,projects:d.projects.map(p=>{
        if(p.id!==projId)return p;
        const updated={...p,tracks:[...p.tracks,t]};
        const hb=updated.hypothesisBoard||{id:uuid(),goals:[],subjects:[]};
        if(!hb.goals||hb.goals.length===0){
          const defaultGoal={id:uuid(),title:'Цель проекта',description:'Автоматически созданная цель при добавлении первого трека',goal_type:'BUSINESS',metrics:[],sub_goals:[]};
          updated.hypothesisBoard={...hb,goals:[defaultGoal]};
        }else if(!updated.hypothesisBoard){
          updated.hypothesisBoard=hb;
        }
        return updated;
      })}));
      showToast('Трек добавлен: '+tt?.code);
    }
  };

  const addTask=(projId,task)=>{
    const taskId=uuid();
    const assignee=data.persons.find(p=>p.id===task.assigned_to_id);
    const t={id:taskId,title:task.title,status:'TODO',priority:task.priority||3,assigned_to_id:task.assigned_to_id||null,assignee_name:assignee?.name||'',track_id:task.track_id||null,deadline:task.deadline||'',created_at:now()};
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,tasks:[t,...p.tasks]}:p)}));
    showToast('Задача добавлена');
    const prioLabels={1:'🔴 Критический',2:'🟠 Высокий',3:'🟡 Средний',4:'🟢 Низкий',5:'⚪ Минимальный'};
    const parts=['📝 Новая задача: **'+(task.title||'')+'**'];
    if(assignee)parts.push('👤 Исполнитель: '+assignee.name);
    parts.push('⚡ Приоритет: '+(prioLabels[task.priority||3]||'Средний'));
    _chatLog(projId,parts.join('\n'),{task_id:taskId,allow_thread:true});
  };

  const addBlocker=(projId,blocker)=>{
    const b={id:uuid(),description:blocker.description,severity:blocker.severity||'MEDIUM',blocker_type:blocker.blocker_type||'INTERNAL',raised_at:now(),resolved_at:null};
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,blockers:[b,...p.blockers]}:p)}));
    showToast('Блокер добавлен');
    _chatLog(projId,'🚧 Новый блокер: **'+(blocker.description||'')+'** ('+(blocker.severity||'MEDIUM')+')',{allow_thread:true});
  };

  const resolveBlocker=(projId,blockerId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,blockers:p.blockers.map(b=>b.id===blockerId?{...b,resolved_at:now()}:b)}:p)}));
    showToast('Блокер снят');
    _chatLog(projId,'✅ Блокер снят');
  };

  const addPayment=(projId,pay)=>{
    const pm={id:uuid(),tranche_number:pay.tranche_number,amount:pay.amount,planned_date:pay.planned_date,actual_date:pay.actual_date||'',accrued_date:pay.accrued_date||'',status:pay.status||'PLANNED',description:pay.description||'',prior_year:pay.prior_year||false,payment_type:pay.payment_type||'PLANNED',expected_week_monday:pay.expected_week_monday||'',is_upsell:pay.is_upsell||false,phase_id:pay.phase_id||null};
    setData(d=>({...d,projects:d.projects.map(p=>{if(p.id!==projId)return p;const upd={...p,payments:[...p.payments,pm]};if(pm.status==='PAID'&&p.status==='DRAFT')upd.status='ACTIVE';return upd;})}));
    showToast('Транш добавлен');
    const fmt=v=>v?Number(v).toLocaleString('ru')+' ₽':'';
    _chatLog(projId,'💰 Новый транш #'+(pay.tranche_number||'?')+': '+fmt(pay.amount)+(pay.planned_date?' на '+pay.planned_date:''));
  };

  const addPnlOverride=(ov)=>{setData(d=>({...d,pnl_overrides:[...(d.pnl_overrides||[]),{id:uuid(),...ov}]}));showToast('Правка добавлена');};
  const deletePnlOverride=(ovId)=>{setData(d=>({...d,pnl_overrides:(d.pnl_overrides||[]).filter(x=>x.id!==ovId)}));showToast('Правка удалена');};
  const markPaymentAccrued=(projId,payId)=>{
    const proj=data.projects.find(p=>p.id===projId);const pm2=proj?(proj.payments||[]).find(x=>x.id===payId):null;
    const client=proj?(data.clients||[]).find(c=>c.id===proj.client_id):null;
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,payments:p.payments.map(pm=>pm.id===payId?{...pm,status:'ACCRUED',accrued_date:now()}:pm)}:p)}));
    showToast('Признан по актам');
    _chatLog(projId,'📋 Транш #'+(pm2?.tranche_number||'?')+' признан по актам');
    _cashflowLog('📋 По актам: **'+((pm2?.amount||0).toLocaleString('ru'))+' ₽** по '+(proj?.code||'проекту')+' '+(client?.name||'')+' — транш #'+(pm2?.tranche_number||'?'),'income');
  };
  const markPaymentPaid=(projId,payId)=>{
    const proj=data.projects.find(p=>p.id===projId);const pm2=proj?(proj.payments||[]).find(x=>x.id===payId):null;
    const client=proj?(data.clients||[]).find(c=>c.id===proj.client_id):null;
    setData(d=>({...d,projects:d.projects.map(p=>{if(p.id!==projId)return p;const upd={...p,payments:p.payments.map(pm=>pm.id===payId?{...pm,status:'PAID',actual_date:now()}:pm)};if(p.status==='DRAFT')upd.status='ACTIVE';return upd;})}));
    showToast('Деньги поступили');
    _chatLog(projId,'💵 Транш #'+(pm2?.tranche_number||'?')+' оплачен');
    _cashflowLog('💵 Поступление: **'+((pm2?.amount||0).toLocaleString('ru'))+' ₽** по '+(proj?.code||'проекту')+' '+(client?.name||'')+' — транш #'+(pm2?.tranche_number||'?'),'income');
  };
  const markAllPaymentsPaid=(projId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{if(p.id!==projId)return p;let cnt=0;const upd={...p,payments:p.payments.map(pm=>{if(pm.status==='PAID')return pm;cnt++;return {...pm,status:'PAID',actual_date:pm.planned_date||now(),accrued_date:pm.accrued_date||pm.planned_date||now()};})};if(p.status==='DRAFT')upd.status='ACTIVE';return upd;})}));
    showToast('Все транши признаны оплаченными');
    _chatLog(projId,'💵 Все транши признаны оплаченными');
  };

  /* B2C RG2 Projects Data from Excel */
  const B2C_PROJECTS=[
    {name:'Медицинский центр 21 век',type:'ОД',prob:null,plans:[]},
    {name:'ТОФС',type:'ОД',prob:null,plans:[]},
    {name:'Медэксперт',type:'ОД',prob:null,plans:[]},
    {name:'Деафон',type:'ОД',prob:1,plans:[{m:'2026-02',a:300000},{m:'2026-03',a:300000},{m:'2026-04',a:300000},{m:'2026-05',a:300000},{m:'2026-06',a:300000}]},
    {name:'Сантерра',type:'ОД',prob:1,plans:[{m:'2026-02',a:400000},{m:'2026-03',a:400000}]},
    {name:'Аюна',type:'Инерция',prob:0.75,plans:[{m:'2026-02',a:600000},{m:'2026-03',a:600000}]},
    {name:'LifeMed',type:'Инерция',prob:1,plans:[{m:'2026-02',a:375000}]},
    {name:'Abis / АБИС',type:'Инерция',prob:0.5,plans:[{m:'2026-02',a:543000},{m:'2026-03',a:400000}]},
    {name:'Транскемикл сессия',type:'Инерция',prob:0.75,plans:[{m:'2026-04',a:700000}]},
    {name:'Менделеев ДБ ОМ',type:'Инерция',prob:1,plans:[{m:'2026-02',a:125000}]},
    {name:'Соколовский',type:'Инерция',prob:1,plans:[{m:'2026-02',a:100000}]},
    {name:'Гармония востока',type:'Инерция',prob:0.3,plans:[{m:'2026-02',a:760000}]},
    {name:'Чиббис',type:'Инерция',prob:0.5,plans:[]},
    {name:'Салюс Легал',type:'Инерция',prob:1,plans:[{m:'2026-02',a:289000},{m:'2026-03',a:289000},{m:'2026-04',a:289000},{m:'2026-05',a:289000}]},
    {name:'Кронус. Оргструктура',type:'Инерция',prob:1,plans:[{m:'2026-02',a:400000}],facts:[{m:'2026-02',a:400000}]},
    {name:'Серф',type:'Инерция',prob:0.1,plans:[]},
    {name:'Фитнес Формула 2',type:'Инерция',prob:1,plans:[{m:'2026-03',a:300000}]},
    {name:'Парк Птиц',type:'Инерция',prob:1,plans:[{m:'2026-03',a:600000}]},
    {name:'Охана',type:'Инерция',prob:0.5,plans:[{m:'2026-02',a:500000}]},
    {name:'Expert Neuro',type:'Инерция',prob:0.1,plans:[{m:'2026-02',a:290000},{m:'2026-03',a:290000}]},
    {name:'Абрау-Дюрсо',type:'Инерция',prob:0.8,plans:[{m:'2026-02',a:1000000}]},
    {name:'Стецык 2 (марк. страт + лендинги)',type:'Инерция',prob:1,plans:[]},
    {name:'075G',type:'Инерция',prob:0.75,plans:[{m:'2026-02',a:400000}]},
    {name:'Чароит',type:'Инерция',prob:0.75,plans:[{m:'2026-02',a:250000}]},
    {name:'Лифтинг',type:'Инерция',prob:1,plans:[{m:'2026-01',a:660000}],facts:[{m:'2026-01',a:660000}]},
    {name:'Olso / Олсо',type:'Инерция',prob:0.5,plans:[{m:'2026-02',a:700000},{m:'2026-04',a:700000}]},
    {name:'Бургер Кинг / Burger King',type:'Инерция',prob:0.75,plans:[{m:'2026-03',a:1600000}]},
    {name:'CosySoft',type:'Инерция',prob:0.6,plans:[{m:'2026-02',a:665000},{m:'2026-03',a:665000}]},
    {name:'Skillspace',type:'Инерция',prob:0.8,plans:[{m:'2026-03',a:320000}]},
    {name:'Азбука вкуса HR',type:'Инерция',prob:0.75,plans:[{m:'2026-02',a:893000}]},
    {name:'МИС',type:'Инерция',prob:0.75,plans:[{m:'2026-03',a:500000}]},
    {name:'Севенком',type:'Инерция',prob:0.75,plans:[{m:'2026-02',a:300000},{m:'2026-03',a:300000}],facts:[{m:'2026-02',a:150000}]},
    {name:'НИЦ',type:'Инерция',prob:0.5,plans:[]},
    {name:'Ростовский девелопер',type:'Инерция',prob:0.9,plans:[{m:'2026-03',a:500000}]},
    {name:'Термекс. Найм CEO',type:'Инерция',prob:0.75,plans:[{m:'2026-02',a:167000},{m:'2026-03',a:167000}]},
    {name:'Саргис',type:'Инерция',prob:0.75,plans:[{m:'2026-03',a:800000}]},
    {name:'Олжас',type:'Инерция',prob:1,plans:[{m:'2026-03',a:480000},{m:'2026-04',a:480000},{m:'2026-05',a:480000},{m:'2026-06',a:480000}]},
    {name:'Дзорт',type:'НД',prob:1,plans:[{m:'2026-03',a:180000},{m:'2026-04',a:180000},{m:'2026-05',a:180000},{m:'2026-06',a:180000},{m:'2026-07',a:180000},{m:'2026-08',a:180000},{m:'2026-09',a:180000},{m:'2026-10',a:180000},{m:'2026-11',a:180000}]},
    {name:'АДГ',type:'ОД',prob:1,plans:[]},
    {name:'Епифанова',type:'ОД',prob:1,plans:[{m:'2026-03',a:375000}]},
    /* Ольга Лукина — теперь создаётся как ФК-проект через миграцию useEffect */
  ];

  const importB2CProjects=()=>{
    const existing=data.projects;
    const normalize=s=>(s||'').toLowerCase().replace(/[\s\.\-\/]+/g,'').trim();
    let created=0,matched=0,report=[];
    B2C_PROJECTS.forEach(bp=>{
      const match=existing.find(ep=>normalize(ep.name)===normalize(bp.name)||normalize(ep.name).includes(normalize(bp.name))||normalize(bp.name).includes(normalize(ep.name)));
      if(match){
        matched++;
        report.push('\u2705 '+bp.name+' \u2192 '+match.name+' ('+match.code+')');
        /* add planned payments to existing project if none exist */
        if(bp.plans.length>0&&(!match.payments||match.payments.length===0)){
          const pms=bp.plans.map((pl,i)=>({id:uuid(),tranche_number:i+1,amount:pl.a,planned_date:pl.m,actual_date:'',status:'PLANNED',description:'B2C Plan P&L',payment_type:'PLANNED',prior_year:false}));
          const factPms=(bp.facts||[]).map((f,i)=>({id:uuid(),tranche_number:100+i+1,amount:f.a,planned_date:f.m,actual_date:f.m+'-15T12:00:00.000Z',status:'PAID',description:'B2C Fact',payment_type:'PLANNED',prior_year:false}));
          setData(d=>({...d,projects:d.projects.map(p=>p.id===match.id?{...p,payments:[...(p.payments||[]),...pms,...factPms]}:p)}));
          report[report.length-1]+=' + '+pms.length+' план.транш.';
        }
      }else{
        created++;
        const totalPlanned=bp.plans.reduce((s,x)=>s+x.a,0);
        const proj={
          name:bp.name,
          code:'B2C-'+String(created).padStart(3,'0'),
          status:'ACTIVE',
          work_group:'\u0420\u04132',
          project_type:bp.type==='\u041d\u0414'?'New Delivery':'Old Delivery',
          notes:'\u0418\u043c\u043f\u043e\u0440\u0442 B2C. \u0412\u0435\u0440\u043e\u044f\u0442\u043d\u043e\u0441\u0442\u044c: '+(bp.prob!==null?bp.prob*100+'%':'N/A'),
          total_contract_value:totalPlanned,
          fixed_price:totalPlanned,
          client_name:bp.name,
          start_date:'2026-01-01',
        };
        const newP=store.addProject(proj);
        if(newP&&bp.plans.length>0){
          bp.plans.forEach((pl,i)=>{store.addPayment(newP.id,{tranche_number:i+1,amount:pl.a,planned_date:pl.m,description:'B2C Plan P&L',payment_type:'PLANNED'});});
          (bp.facts||[]).forEach((f,i)=>{store.addPayment(newP.id,{tranche_number:100+i+1,amount:f.a,planned_date:f.m,actual_date:f.m+'-15T12:00:00.000Z',status:'PAID',description:'B2C Fact',payment_type:'PLANNED'});});
        }
        report.push('\u2795 '+bp.name+' \u2192 \u0441\u043e\u0437\u0434\u0430\u043d ('+bp.plans.length+' \u0442\u0440\u0430\u043d\u0448.)');
      }
    });
    alert('\u0418\u043c\u043f\u043e\u0440\u0442 B2C:\n\u0421\u043e\u043f\u043e\u0441\u0442\u0430\u0432\u043b\u0435\u043d\u043e: '+matched+'\n\u0421\u043e\u0437\u0434\u0430\u043d\u043e: '+created+'\n\n'+report.join('\n'));
  };

  const addRecommendation=(rec)=>{
    const entry={id:uuid(),category:rec.category||'mgmt',title:rec.title||'',description:rec.description||'',status:'backlog',created_at:now(),batch_id:rec.batch_id||''};
    setData(d=>({...d,recommendations:[entry,...(d.recommendations||[])]}));
  };
  const addRecommendationsBatch=(recs)=>{
    const bid=uuid();
    const entries=recs.map(r=>({id:uuid(),category:r.category||'mgmt',title:r.title||'',description:r.description||'',status:'backlog',created_at:now(),batch_id:bid}));
    setData(d=>({...d,recommendations:[...entries,...(d.recommendations||[])]}));
    showToast(entries.length+' рекомендаций добавлено');
    return bid;
  };
  const updateRecommendationStatus=(id,status)=>{
    setData(d=>({...d,recommendations:(d.recommendations||[]).map(r=>r.id===id?{...r,status}:r)}));
  };
  const deleteRecommendation=(id)=>{
    setData(d=>({...d,recommendations:(d.recommendations||[]).filter(r=>r.id!==id)}));
  };

  const _projRg=(proj)=>{if(!proj)return'РГ1';if(proj.project_type==='ФК')return'ФК';return(proj.work_group||'')==='РГ2'?'РГ2':'РГ1';};
  const addOverhead=(projId,oh)=>{
    const ohId=uuid();const regId=uuid();
    const entry={id:ohId,name:oh.name||'',amount:Number(oh.amount)||0,date:oh.date||now().slice(0,10),notes:oh.notes||'',category:oh.category||'Прочее',cls:oh.cls||'прочее',format:oh.format||'счет',responsible:oh.responsible||'',cf_type:oh.cf_type||'OCF',prior_year:oh.prior_year||false,synced_reg_id:regId};
    const proj=data.projects.find(p=>p.id===projId);
    const rg=oh.rg||_projRg(proj);
    const regEntry={id:regId,date:entry.date,amount:entry.amount,rg:rg,category:entry.category,cls:entry.cls,format:entry.format,responsible:entry.responsible,comment:entry.name+(entry.notes?' — '+entry.notes:''),project_id:projId,scope:'project',cf_type:entry.cf_type,verified:false,synced_oh_id:ohId,source:'project',prior_year:entry.prior_year,created_at:now()};
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,overheads:[entry,...(p.overheads||[])]}:p),overhead_registry:[regEntry,...(d.overhead_registry||[])]}));
    showToast('Накладная добавлена + синхронизирована в реестр');
  };
  const updateOverhead=(projId,ohId,updates)=>{
    setData(d=>{
      const proj=d.projects.find(p=>p.id===projId);
      const oh=proj&&(proj.overheads||[]).find(x=>x.id===ohId);
      const regId=oh&&oh.synced_reg_id;
      const merged=oh?{...oh,...updates}:updates;
      const regUpdates={};
      if(updates.name!==undefined||updates.notes!==undefined)regUpdates.comment=(merged.name||'')+(merged.notes?' — '+merged.notes:'');
      if(updates.amount!==undefined)regUpdates.amount=Number(updates.amount)||0;
      if(updates.date!==undefined)regUpdates.date=updates.date;
      if(updates.category!==undefined)regUpdates.category=updates.category;
      if(updates.cls!==undefined)regUpdates.cls=updates.cls;
      if(updates.format!==undefined)regUpdates.format=updates.format;
      if(updates.responsible!==undefined)regUpdates.responsible=updates.responsible;
      if(updates.cf_type!==undefined)regUpdates.cf_type=updates.cf_type;
      if(updates.prior_year!==undefined)regUpdates.prior_year=updates.prior_year;
      return {...d,
        projects:d.projects.map(p=>p.id===projId?{...p,overheads:(p.overheads||[]).map(x=>x.id===ohId?{...x,...updates}:x)}:p),
        overhead_registry:regId?(d.overhead_registry||[]).map(r=>r.id===regId?{...r,...regUpdates}:r):(d.overhead_registry||[])
      };
    });
  };
  const removeOverhead=(projId,ohId)=>{
    setData(d=>{
      const proj=d.projects.find(p=>p.id===projId);
      const oh=proj&&(proj.overheads||[]).find(x=>x.id===ohId);
      const regId=oh&&oh.synced_reg_id;
      return {...d,
        projects:d.projects.map(p=>p.id===projId?{...p,overheads:(p.overheads||[]).filter(x=>x.id!==ohId)}:p),
        overhead_registry:regId?(d.overhead_registry||[]).filter(r=>r.id!==regId):(d.overhead_registry||[])
      };
    });
    showToast('Накладная удалена');
  };

  /* KB Budget items (расходы КБ) */
  const addKbBudgetItem=(item)=>{
    const entry={id:uuid(),name:item.name||'',person_id:item.person_id||'',amount_plan:Number(item.amount_plan)||0,amount_fact:Number(item.amount_fact)||0,month:item.month||'',cf_type:item.cf_type||'OCF',notes:item.notes||'',created_at:now()};
    setData(d=>({...d,kb_budget:[entry,...(d.kb_budget||[])]}));
    showToast('Статья КБ добавлена');return entry;
  };
  const updateKbBudgetItem=(id,updates)=>{
    setData(d=>({...d,kb_budget:(d.kb_budget||[]).map(x=>x.id===id?{...x,...updates}:x)}));
  };
  const deleteKbBudgetItem=(id)=>{
    setData(d=>({...d,kb_budget:(d.kb_budget||[]).filter(x=>x.id!==id)}));
    showToast('Статья КБ удалена');
  };

  /* HR Budget items (расходы HR) */
  const addHrBudgetItem=(item)=>{
    const entry={id:uuid(),name:item.name||'',person_id:item.person_id||'',amount_plan:Number(item.amount_plan)||0,amount_fact:Number(item.amount_fact)||0,month:item.month||'',cf_type:item.cf_type||'OCF',notes:item.notes||'',created_at:now()};
    setData(d=>({...d,hr_budget:[entry,...(d.hr_budget||[])]}));
    showToast('Статья HR добавлена');return entry;
  };
  const updateHrBudgetItem=(id,updates)=>{
    setData(d=>({...d,hr_budget:(d.hr_budget||[]).map(x=>x.id===id?{...x,...updates}:x)}));
  };
  const deleteHrBudgetItem=(id)=>{
    setData(d=>({...d,hr_budget:(d.hr_budget||[]).filter(x=>x.id!==id)}));
    showToast('Статья HR удалена');
  };

  /* ===== Overhead Registry CRUD ===== */
  const addOhRegistryItem=(e)=>{
    const entry={id:e.id||uuid(),date:e.date||now().slice(0,10),amount:Number(e.amount)||0,rg:e.rg||'КБ',category:e.category||'',cls:e.cls||'',format:e.format||'счет',responsible:e.responsible||'',comment:e.comment||'',project_id:e.project_id||null,scope:e.scope||(e.project_id?'project':'company'),cf_type:e.cf_type||'OCF',verified:!!e.verified,synced_oh_id:null,synced_kb_id:null,source:e.source||'manual',prior_year:e.prior_year||false,oh_status:e.oh_status||null,oh_created_by:e.oh_created_by||null,created_at:now()};
    const isProjectScope=entry.scope==='project'&&entry.project_id&&(entry.rg==='РГ1'||entry.rg==='РГ2'||entry.rg==='ФК'||entry.rg==='IB');
    if(isProjectScope){
      const ohId=uuid();entry.synced_oh_id=ohId;
      const projOh={id:ohId,name:entry.comment||entry.category||'',amount:entry.amount,date:entry.date,notes:'',category:entry.category||'Прочее',cls:entry.cls||'прочее',format:entry.format||'счет',responsible:entry.responsible||'',cf_type:entry.cf_type||'OCF',prior_year:entry.prior_year||false,synced_reg_id:entry.id};
      setData(d=>({...d,overhead_registry:[entry,...(d.overhead_registry||[])],projects:d.projects.map(p=>p.id===entry.project_id?{...p,overheads:[projOh,...(p.overheads||[])]}:p)}));
    } else {
      setData(d=>({...d,overhead_registry:[entry,...(d.overhead_registry||[])]}));
    }
    return entry;
  };
  const updateOhRegistryItem=(id,updates)=>{
    setData(d=>{
      const reg=(d.overhead_registry||[]).find(x=>x.id===id);
      const merged=reg?{...reg,...updates}:updates;
      const ohId=reg&&reg.synced_oh_id;
      const projId=reg&&reg.project_id;
      /* Build project overhead updates from registry fields */
      const projUpdates={};
      if(updates.comment!==undefined||updates.category!==undefined)projUpdates.name=updates.comment!==undefined?updates.comment:(merged.comment||merged.category||'');
      if(updates.amount!==undefined)projUpdates.amount=Number(updates.amount)||0;
      if(updates.date!==undefined)projUpdates.date=updates.date;
      if(updates.category!==undefined)projUpdates.category=updates.category;
      if(updates.cls!==undefined)projUpdates.cls=updates.cls;
      if(updates.format!==undefined)projUpdates.format=updates.format;
      if(updates.responsible!==undefined)projUpdates.responsible=updates.responsible;
      if(updates.cf_type!==undefined)projUpdates.cf_type=updates.cf_type;
      if(updates.prior_year!==undefined)projUpdates.prior_year=updates.prior_year;
      const hasProjectUpdates=Object.keys(projUpdates).length>0&&ohId&&projId;
      return {...d,
        overhead_registry:(d.overhead_registry||[]).map(x=>x.id===id?{...x,...updates}:x),
        projects:hasProjectUpdates?d.projects.map(p=>p.id===projId?{...p,overheads:(p.overheads||[]).map(x=>x.id===ohId?{...x,...projUpdates}:x)}:p):d.projects
      };
    });
  };
  const deleteOhRegistryItem=(id)=>{
    setData(d=>{
      const reg=(d.overhead_registry||[]).find(x=>x.id===id);
      const ohId=reg&&reg.synced_oh_id;
      const projId=reg&&reg.project_id;
      return {...d,
        overhead_registry:(d.overhead_registry||[]).filter(x=>x.id!==id),
        projects:(ohId&&projId)?d.projects.map(p=>p.id===projId?{...p,overheads:(p.overheads||[]).filter(x=>x.id!==ohId)}:p):d.projects
      };
    });
    showToast('Запись удалена');
  };
  const toggleOhRegistryVerified=(id)=>{
    setData(d=>({...d,overhead_registry:(d.overhead_registry||[]).map(x=>x.id===id?{...x,verified:!x.verified}:x)}));
  };
  const clearOverheadRegistry=()=>{
    if(!confirm('Очистить ВСЕ записи из реестра общих накладных? Проектные накладные останутся, но связи будут разорваны.'))return;
    console.log('[Manual] Clearing overhead_registry ('+((data.overhead_registry||[]).length)+' entries)');
    setData(d=>({...d,overhead_registry:[]}));
    setData(d=>({...d,projects:d.projects.map(p=>({...p,overheads:(p.overheads||[]).map(oh=>oh.synced_reg_id?{...oh,synced_reg_id:null}:oh)}))}));
    showToast('Реестр накладных очищен');
  };
  const syncOhToProject=(regId)=>{
    const reg=(data.overhead_registry||[]).find(x=>x.id===regId);
    if(!reg||!reg.project_id){showToast('Проект не выбран');return;}
    if(reg.synced_oh_id){
      updateOverhead(reg.project_id,reg.synced_oh_id,{name:reg.comment||reg.category,amount:reg.amount,date:reg.date,notes:'['+reg.rg+'] '+reg.category+' | '+reg.format+' | '+reg.responsible});
      showToast('Синхронизировано (обновлено)');
    }else{
      const oh={name:reg.comment||reg.category,amount:reg.amount,date:reg.date,notes:'['+reg.rg+'] '+reg.category+' | '+reg.format+' | '+reg.responsible};
      addOverhead(reg.project_id,oh);
      /* link the newly created overhead */
      setTimeout(()=>{
        setData(d=>{
          const proj=d.projects.find(p=>p.id===reg.project_id);
          const newOhId=proj&&proj.overheads&&proj.overheads[0]?proj.overheads[0].id:null;
          return {...d,overhead_registry:(d.overhead_registry||[]).map(x=>x.id===regId?{...x,synced_oh_id:newOhId}:x)};
        });
      },50);
      showToast('Синхронизировано с проектом');
    }
  };
  const syncOhToKbBudget=(regId)=>{
    const reg=(data.overhead_registry||[]).find(x=>x.id===regId);
    if(!reg){return;}
    if(reg.synced_kb_id){
      updateKbBudgetItem(reg.synced_kb_id,{name:reg.comment||reg.category,amount_plan:reg.amount,month:reg.date.slice(0,7),cf_type:reg.cf_type,notes:'['+reg.rg+'] '+reg.format+' | '+reg.responsible});
      showToast('Синхронизировано (обновлено)');
    }else{
      const item=addKbBudgetItem({name:reg.comment||reg.category,amount_plan:reg.amount,month:reg.date.slice(0,7),cf_type:reg.cf_type,notes:'['+reg.rg+'] '+reg.format+' | '+reg.responsible});
      if(item&&item.id){updateOhRegistryItem(regId,{synced_kb_id:item.id});}
      showToast('Синхронизировано с бюджетом КБ');
    }
  };
  /* Overhead request workflow (chat-based) */
  const approveOhRequest=(msgId,approverName)=>{
    setData(d=>{const nd={...d};const msg=(nd.chat_messages||[]).find(m=>m.id===msgId);if(!msg||!msg.overhead_request||msg.overhead_request.status!=='PENDING')return nd;
    const req=msg.overhead_request;msg.overhead_request={...req,status:'APPROVED',approved_by:approverName,approved_at:now()};
    /* Update existing registry entry (created at submit time) or create new */
    const regId=req.reg_id;const existingIdx=regId?(nd.overhead_registry||[]).findIndex(e=>e.id===regId):-1;
    if(existingIdx>=0){
      /* Update existing PENDING → APPROVED */
      nd.overhead_registry=(nd.overhead_registry||[]).map((e,i)=>i===existingIdx?{...e,oh_status:'APPROVED',oh_approved_by:approverName,oh_approved_at:now(),verified:true}:e);
      const entry=nd.overhead_registry[existingIdx];
      /* If project-scope, sync to project.overheads */
      const _projRgs2=['РГ1','РГ2','ФК','IB'];const isProj=entry.scope==='project'&&entry.project_id&&_projRgs2.includes(entry.rg);
      if(isProj&&!entry.synced_oh_id){
        const ohId=uuid();nd.overhead_registry=nd.overhead_registry.map(e=>e.id===regId?{...e,synced_oh_id:ohId}:e);
        const projOh={id:ohId,name:entry.comment||entry.category||'',amount:entry.amount,date:entry.date,notes:'',category:entry.category||'Прочее',cls:entry.cls||'прочее',format:entry.format||'счет',responsible:entry.responsible||'',cf_type:entry.cf_type||'OCF',prior_year:entry.prior_year||false,synced_reg_id:entry.id};
        nd.projects=nd.projects.map(p=>p.id===entry.project_id?{...p,overheads:[projOh,...(p.overheads||[])]}:p);
      }
    } else {
      /* Fallback: create new entry (for old requests without reg_id) */
      const entry={id:uuid(),date:req.date||now().slice(0,10),amount:Number(req.amount)||0,rg:req.rg||'КБ',category:req.category||'',cls:req.cls||'',format:req.format||'счет',responsible:req.responsible||'',comment:req.comment||'',project_id:req.project_id||null,scope:req.scope||(req.project_id?'project':'company'),cf_type:req.cf_type||'OCF',verified:true,synced_oh_id:null,synced_kb_id:null,source:'chat',prior_year:req.prior_year||false,oh_status:'APPROVED',oh_approved_by:approverName,oh_approved_at:now(),created_at:now()};
      const _projRgs2=['РГ1','РГ2','ФК','IB'];const isProj=entry.scope==='project'&&entry.project_id&&_projRgs2.includes(entry.rg);
      if(isProj){const ohId=uuid();entry.synced_oh_id=ohId;const projOh={id:ohId,name:entry.comment||entry.category||'',amount:entry.amount,date:entry.date,notes:'',category:entry.category||'Прочее',cls:entry.cls||'прочее',format:entry.format||'счет',responsible:entry.responsible||'',cf_type:entry.cf_type||'OCF',prior_year:entry.prior_year||false,synced_reg_id:entry.id};
      nd.overhead_registry=[entry,...(nd.overhead_registry||[])];nd.projects=nd.projects.map(p=>p.id===entry.project_id?{...p,overheads:[projOh,...(p.overheads||[])]}:p);}
      else{nd.overhead_registry=[entry,...(nd.overhead_registry||[])];}
    }
    nd.chat_messages=[...nd.chat_messages,{id:uuid(),created_at:now(),channel_id:'cashflow',cashflow_tab:'overhead_request',text:'✅ Заявка на накладную ('+((req.amount||0).toLocaleString('ru'))+' ₽, '+req.category+') подтверждена **'+approverName+'**.',author:{id:'system',name:'Система',avatar:'⚙'},reactions:[],edited:false,is_system:true}];
    return nd;});showToast('Заявка подтверждена');
  };
  const rejectOhRequest=(msgId,approverName)=>{
    setData(d=>{const nd={...d};const msg=(nd.chat_messages||[]).find(m=>m.id===msgId);if(!msg||!msg.overhead_request||msg.overhead_request.status!=='PENDING')return nd;
    msg.overhead_request={...msg.overhead_request,status:'REJECTED',rejected_by:approverName,rejected_at:now()};
    nd.chat_messages=[...nd.chat_messages,{id:uuid(),created_at:now(),channel_id:'cashflow',cashflow_tab:'overhead_request',text:'❌ Заявка на накладную ('+((msg.overhead_request.amount||0).toLocaleString('ru'))+' ₽) отклонена **'+approverName+'**.',author:{id:'system',name:'Система',avatar:'⚙'},reactions:[],edited:false,is_system:true}];
    return nd;});showToast('Заявка отклонена');
  };
  const updateOhRequest=(msgId,updates)=>{
    setData(d=>{const nd={...d};const msg=(nd.chat_messages||[]).find(m=>m.id===msgId);if(!msg||!msg.overhead_request)return nd;
    msg.overhead_request={...msg.overhead_request,...updates};return nd;});
  };
  /* Mark overhead as disbursed (фактически выдана) — from chat or registry */
  const markOhDisbursed=(regId,disbursedBy)=>{
    setData(d=>{const nd={...d};
    nd.overhead_registry=(nd.overhead_registry||[]).map(e=>e.id===regId?{...e,disbursed:true,disbursed_by:disbursedBy,disbursed_at:now()}:e);
    /* Sync to project.overheads if linked */
    const reg=(nd.overhead_registry||[]).find(e=>e.id===regId);
    if(reg&&reg.synced_oh_id&&reg.project_id){
      nd.projects=nd.projects.map(p=>p.id===reg.project_id?{...p,overheads:(p.overheads||[]).map(oh=>oh.id===reg.synced_oh_id?{...oh,disbursed:true,disbursed_by:disbursedBy,disbursed_at:now()}:oh)}:p);
    }
    return nd;});showToast('Отмечена как выданная');
  };
  /* Mark overhead disbursed from chat message */
  const markOhRequestDisbursed=(msgId,disbursedBy)=>{
    setData(d=>{const nd={...d};const msg=(nd.chat_messages||[]).find(m=>m.id===msgId);
    if(!msg||!msg.overhead_request||msg.overhead_request.status!=='APPROVED')return nd;
    msg.overhead_request={...msg.overhead_request,disbursed:true,disbursed_by:disbursedBy,disbursed_at:now()};
    /* Find corresponding registry entry and mark it too */
    const req=msg.overhead_request;const regIdx=(nd.overhead_registry||[]).findIndex(e=>e.source==='chat'&&Math.abs(e.amount-req.amount)<1&&e.category===req.category&&(e.date||'').slice(0,7)===(req.date||'').slice(0,7));
    if(regIdx>=0){const reg=nd.overhead_registry[regIdx];nd.overhead_registry=nd.overhead_registry.map((e,i)=>i===regIdx?{...e,disbursed:true,disbursed_by:disbursedBy,disbursed_at:now()}:e);
      if(reg.synced_oh_id&&reg.project_id){nd.projects=nd.projects.map(p=>p.id===reg.project_id?{...p,overheads:(p.overheads||[]).map(oh=>oh.id===reg.synced_oh_id?{...oh,disbursed:true,disbursed_by:disbursedBy,disbursed_at:now()}:oh)}:p);}
    }
    nd.chat_messages=[...nd.chat_messages,{id:uuid(),created_at:now(),channel_id:'cashflow',cashflow_tab:'overhead_request',text:'💸 Накладная ('+((req.amount||0).toLocaleString('ru'))+' ₽, '+req.category+') отмечена как фактически выданная — **'+disbursedBy+'**.',author:{id:'system',name:'Система',avatar:'⚙'},reactions:[],edited:false,is_system:true}];
    return nd;});showToast('Накладная отмечена как выданная');
  };
  const bulkImportOhRegistry=(entries)=>{
    const _projRgs=['РГ1','РГ2','ФК','IB'];
    const newEntries=entries.map(e=>{
      const regId=uuid();const scope=e.scope||(e.project_id?'project':'company');
      const isProj=scope==='project'&&e.project_id&&_projRgs.includes(e.rg||'');
      const ohId=isProj?uuid():null;
      return {_regId:regId,_ohId:ohId,_projId:e.project_id||null,_isProj:isProj,
        reg:{id:regId,date:e.date||now().slice(0,10),amount:Number(e.amount)||0,rg:e.rg||'КБ',category:e.category||'',cls:e.cls||'',format:e.format||'счет',responsible:e.responsible||'',comment:e.comment||'',project_id:e.project_id||null,scope:scope,cf_type:e.cf_type||'OCF',verified:false,synced_oh_id:ohId,synced_kb_id:null,source:e.source||'file',prior_year:e.prior_year||false,created_at:now()},
        oh:isProj?{id:ohId,name:e.comment||e.category||'',amount:Number(e.amount)||0,date:e.date||now().slice(0,10),notes:'',category:e.category||'Прочее',cls:e.cls||'прочее',format:e.format||'счет',responsible:e.responsible||'',cf_type:e.cf_type||'OCF',prior_year:e.prior_year||false,synced_reg_id:regId}:null
      };
    });
    setData(d=>{
      /* Group project overheads by project_id */
      const projOhMap=new Map();
      newEntries.forEach(ne=>{if(ne._isProj&&ne.oh){const arr=projOhMap.get(ne._projId)||[];arr.push(ne.oh);projOhMap.set(ne._projId,arr);}});
      return {...d,
        overhead_registry:[...(d.overhead_registry||[]),...newEntries.map(ne=>ne.reg)],
        projects:projOhMap.size>0?d.projects.map(p=>{const ohs=projOhMap.get(p.id);return ohs?{...p,overheads:[...ohs,...(p.overheads||[])]}:p;}):d.projects
      };
    });
    showToast(newEntries.length+' записей импортировано');
  };

  /* Double-Check: сопоставление overhead_registry проектных записей (ФК/РГ1/РГ2) с project.overheads */
  const runFkDoubleCheck=()=>{
    const reg=data.overhead_registry||[];
    const prjs=data.projects||[];
    const warnings=new Map();
    let verifiedCount=0;
    const toVerify=[];
    const _projRgs=['ФК','РГ1','РГ2'];
    const fkEntries=reg.filter(e=>_projRgs.includes(e.rg)&&e.project_id);
    fkEntries.forEach(entry=>{
      const proj=prjs.find(p=>p.id===entry.project_id);
      if(!proj){warnings.set(entry.id,{reason:'PROJECT_NOT_FOUND',message:'Проект не найден (id: '+entry.project_id+')'});return;}
      const ohs=proj.overheads||[];
      let matched=null;
      /* 1) Прямой матч через synced_oh_id */
      if(entry.synced_oh_id){matched=ohs.find(oh=>oh.id===entry.synced_oh_id);}
      /* 2) Fuzzy match: month+amount+name */
      const entryMonth=(entry.date||'').slice(0,7);
      const ohMonth=d=>(d||'').slice(0,7);
      if(!matched){
        const normN=s=>(s||'').toLowerCase().trim();
        matched=ohs.find(oh=>ohMonth(oh.date)===entryMonth&&Math.round(Number(oh.amount))===Math.round(Number(entry.amount))&&(normN(entry.comment)===normN(oh.name)||normN(entry.comment).includes(normN(oh.name))||normN(oh.name).includes(normN(entry.comment))));
      }
      /* 3) Мягче: month+amount */
      if(!matched){
        const candidates=ohs.filter(oh=>ohMonth(oh.date)===entryMonth&&Math.round(Number(oh.amount))===Math.round(Number(entry.amount)));
        if(candidates.length===1)matched=candidates[0];
      }
      /* 4) Самый мягкий: только amount */
      if(!matched){
        const candidates=ohs.filter(oh=>Math.round(Number(oh.amount))===Math.round(Number(entry.amount)));
        if(candidates.length===1)matched=candidates[0];
      }
      if(!matched){warnings.set(entry.id,{reason:'NO_MATCH',message:'Нет соответствующей накладной в проекте «'+proj.name+'»',regAmount:entry.amount});return;}
      if(Math.round(Number(matched.amount))!==Math.round(Number(entry.amount))){
        warnings.set(entry.id,{reason:'AMOUNT_MISMATCH',message:'Сумма: реестр '+entry.amount+' ≠ проект '+matched.amount,regAmount:entry.amount,projAmount:matched.amount});return;
      }
      /* Всё ок → собираем для батчевой верификации */
      if(!entry.verified){toVerify.push(entry.id);}
      verifiedCount++;
    });
    /* Один setData вместо N вызовов updateOhRegistryItem */
    if(toVerify.length>0){
      setData(d=>{const vSet=new Set(toVerify);return{...d,overhead_registry:(d.overhead_registry||[]).map(e=>vSet.has(e.id)?{...e,verified:true}:e)};});
    }
    const msg='Проверка проектных: '+fkEntries.length+' записей, ✅ '+verifiedCount+' подтверждено'+(warnings.size>0?', ⚠️ '+warnings.size+' предупр.':'');
    showToast(msg);
    console.log('[DoubleCheck]',msg,warnings.size>0?Object.fromEntries(warnings):'');
    return warnings;
  };

  const addTimeEntry=(projId,te)=>{
    const person=data.persons.find(p=>p.id===te.person_id);
    const teMonth=(te.date||'').slice(0,7);const tePhase=te.work_phase||'MINING_ASSEMBLING';
    const proj=data.projects.find(p=>p.id===projId);
    const existing=proj?(proj.timeEntries||[]).find(x=>x.person_id===te.person_id&&(x.date||'').slice(0,7)===teMonth&&(x.work_phase||'MINING_ASSEMBLING')===tePhase):null;
    if(existing){
      const mergedHrs=(Number(existing.hours)||0)+(Number(te.hours)||0);
      const mergedDesc=[existing.description,te.description].filter(Boolean).join('; ');
      setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,timeEntries:(p.timeEntries||[]).map(x=>x.id===existing.id?{...x,hours:mergedHrs,description:mergedDesc}:x)}:p)}));
      showToast('Часы объединены: '+(person?.name||'')+' → '+mergedHrs+'ч');
    } else {
      const entry={id:uuid(),person_id:te.person_id,person_name:person?.name||'',date:te.date,hours:te.hours,work_phase:tePhase,description:te.description||'',created_at:now()};
      setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,timeEntries:[entry,...p.timeEntries]}:p)}));
      showToast('Время списано');
    }
  };

  const updateTimeEntry=(projId,teId,updates)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,timeEntries:(p.timeEntries||[]).map(te=>te.id===teId?{...te,...updates}:te)}:p)}));
  };

  const deleteTimeEntry=(projId,teId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,timeEntries:(p.timeEntries||[]).filter(te=>te.id!==teId)}:p)}));
    showToast('Запись времени удалена');
  };

  const addSubGoal=(projId,goalId,sg)=>{
    const sub={id:uuid(),title:sg.title||'',description:sg.description||'',order_num:0};
    setData(d=>({...d,projects:d.projects.map(p=>{if(p.id!==projId||!p.hypothesisBoard)return p;return{...p,hypothesisBoard:{...p.hypothesisBoard,goals:p.hypothesisBoard.goals.map(g=>g.id===goalId?{...g,sub_goals:[...(g.sub_goals||[]),sub]}:g)}};})}));
    showToast('Подцель добавлена');
  };
  const deleteSubGoal=(projId,goalId,sgId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{if(p.id!==projId||!p.hypothesisBoard)return p;return{...p,hypothesisBoard:{...p.hypothesisBoard,goals:p.hypothesisBoard.goals.map(g=>g.id===goalId?{...g,sub_goals:(g.sub_goals||[]).filter(s=>s.id!==sgId)}:g)}};})}));
    showToast('Подцель удалена');
  };
  const autoScheduleTracks=(projId)=>{
    const proj=data.projects.find(p=>p.id===projId);
    if(!proj)return;
    const schedule=calcAutoSchedule(proj);
    if(schedule.length===0){showToast('Нечего планировать');return;}
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const tMap=new Map(schedule.map(s=>[s.trackId,s]));
      return {...p,tracks:(p.tracks||[]).map(t=>{
        const s=tMap.get(t.id);
        if(!s)return t;
        // Only set dates if not already manually set
        return {...t,start_date:t.start_date||s.start_date,end_date:t.end_date||s.end_date,_auto_scheduled:!t.start_date&&!t.end_date};
      })};
    })}));
    showToast('Треки запланированы ('+schedule.length+' шт.)');
  };
  const forceScheduleTracks=(projId)=>{
    const proj=data.projects.find(p=>p.id===projId);
    if(!proj)return;
    const schedule=calcAutoSchedule(proj);
    if(schedule.length===0){showToast('Нечего планировать');return;}
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const tMap=new Map(schedule.map(s=>[s.trackId,s]));
      return {...p,tracks:(p.tracks||[]).map(t=>{
        const s=tMap.get(t.id);
        if(!s)return t;
        return {...t,start_date:s.start_date,end_date:s.end_date,_auto_scheduled:true};
      })};
    })}));
    showToast('Все треки перепланированы');
  };
  const addGoal=(projId,goal)=>{
    const g={id:uuid(),title:goal.title,description:goal.description||'',goal_type:goal.goal_type||'BUSINESS',order_num:0,metrics:[],sub_goals:[]};
    setData(d=>({...d,projects:d.projects.map(p=>{if(p.id!==projId)return p;const hb=p.hypothesisBoard||{id:uuid(),goals:[],subjects:[]};return{...p,hypothesisBoard:{...hb,goals:[...hb.goals,g]}};})}));
    showToast('Цель добавлена');
  };

  const addSubject=(projId,goalId,subj)=>{
    const s={id:uuid(),goal_id:goalId,sub_goal_id:subj.sub_goal_id||null,name:subj.name,role:subj.role||'',order_num:0,insights:[],trackLinks:[]};
    setData(d=>({...d,projects:d.projects.map(p=>{if(p.id!==projId||!p.hypothesisBoard)return p;return{...p,hypothesisBoard:{...p.hypothesisBoard,subjects:[...p.hypothesisBoard.subjects,s]}};})}));
    showToast('Субъект добавлен');
  };

  // ===== EDIT FUNCTIONS =====
  const updateClient=(id,updates)=>{
    setData(d=>({...d,clients:d.clients.map(c=>c.id===id?{...c,...updates}:c),
      projects:d.projects.map(p=>p.client_id===id?{...p,client_name:updates.name||p.client_name,client_industry:updates.industry||p.client_industry}:p)
    }));showToast('Клиент обновлён');
  };

  const updatePerson=(id,updates)=>{
    setData(d=>({...d,persons:d.persons.map(p=>p.id===id?{...p,...updates}:p),
      projects:d.projects.map(pr=>({...pr,
        assignments:pr.assignments.map(a=>a.person_id===id?{...a,person_name:updates.name||a.person_name,person_position:updates.position||a.person_position}:a),
        tasks:pr.tasks.map(t=>t.assigned_to_id===id?{...t,assignee_name:updates.name||t.assignee_name}:t)
      }))
    }));showToast('Сотрудник обновлён');
  };

  const deletePerson=(id)=>{
    setData(d=>({...d,persons:d.persons.filter(p=>p.id!==id),_deletedPersonIds:[...(d._deletedPersonIds||[]),id]}));showToast('Сотрудник удалён');
  };

  const upsertWeeklyHours=(personId,weekStart,openHours,notes)=>{
    setData(d=>({...d,persons:d.persons.map(p=>{
      if(p.id!==personId)return p;
      const wts=[...(p.weekly_timesheets||[])];
      const idx=wts.findIndex(w=>w.week_start===weekStart);
      if(idx>=0){wts[idx]={...wts[idx],open_hours:Number(openHours)||0,notes:notes||'',updated_at:new Date().toISOString()};}
      else{wts.unshift({id:String(Date.now()),week_start:weekStart,open_hours:Number(openHours)||0,notes:notes||'',created_at:new Date().toISOString()});}
      return {...p,weekly_timesheets:wts};
    })}));showToast('Часы обновлены');
  };
  const deleteWeeklyHours=(personId,tsId)=>{
    setData(d=>({...d,persons:d.persons.map(p=>p.id===personId?{...p,weekly_timesheets:(p.weekly_timesheets||[]).filter(w=>w.id!==tsId)}:p)}));
    showToast('Запись удалена');
  };
  const updateTrackDates=(projId,trackId,updates)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,tracks:(p.tracks||[]).map(t=>{if(t.id!==trackId)return t;const upd={...t,...updates};if(updates.track_param!==undefined&&!updates.norm_days){const norm=TRACK_NORM_DAYS[t.track_code];if(norm)upd.norm_days=norm.calc(Number(updates.track_param));}return upd;})}:p)}));
    showToast('Трек обновлён');
  };
  const addTrackDep=(projId,trackId,dep)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,tracks:(p.tracks||[]).map(t=>t.id===trackId?{...t,dependencies:[...(t.dependencies||[]),{id:uuid(),target_track_id:dep.target_track_id,lag_days:dep.lag_days||0}]}:t)}:p)}));
    showToast('Зависимость добавлена');
  };
  const removeTrackDep=(projId,trackId,depId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,tracks:(p.tracks||[]).map(t=>t.id===trackId?{...t,dependencies:(t.dependencies||[]).filter(d=>d.id!==depId)}:t)}:p)}));
    showToast('Зависимость удалена');
  };
  const updateTrackStatus=(projId,trackId,status)=>{
    const proj=data.projects.find(p=>p.id===projId);const trk=proj?(proj.tracks||[]).find(t=>t.id===trackId):null;
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,tracks:(p.tracks||[]).map(t=>t.id===trackId?{...t,status}:t)}:p)}));
    showToast('Статус трека: '+status);
    _chatLog(projId,'📊 Трек **'+(trk?.track_name||trk?.track_code||'?')+'** → '+status);
  };

  const deleteTrack=(projId,trackId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,tracks:(p.tracks||[]).filter(t=>t.id!==trackId)}:p)}));
    showToast('Трек удалён');
  };

  /* ── Базовые статусы задач ── */
  const BASE_TASK_STATUSES=[
    {key:'TODO',label:'📋 TODO',color:'var(--text2)',bg:'var(--bg2)',order:0},
    {key:'IN_PROGRESS',label:'🔄 В работе',color:'var(--sky)',bg:'rgba(14,165,233,.08)',order:10},
    {key:'DONE',label:'✅ Готово',color:'var(--emerald)',bg:'rgba(16,185,129,.08)',order:90},
    {key:'BLOCKED',label:'🚧 Блокер',color:'var(--red)',bg:'rgba(239,68,68,.08)',order:95}
  ];
  /* Глобальные (кросс-проектные) кастомные статусы → data.globalTaskStatuses */
  const _applyBaseOverrides=(list)=>{
    const ov=data._baseStatusOrders||{};
    const lbl=data._baseStatusLabels||{};
    return list.map(s=>{const r={...s};if(ov[s.key]!==undefined)r.order=ov[s.key];if(lbl[s.key])r.label=lbl[s.key];return r;});
  };
  const getGlobalStatuses=()=>{
    const base=_applyBaseOverrides(BASE_TASK_STATUSES);
    const custom=(data.globalTaskStatuses||[]).map(s=>({...s}));
    const merged=[...base,...custom];
    merged.sort((a,b)=>(a.order||0)-(b.order||0));
    return merged;
  };
  /* Все статусы для конкретного проекта (базовые+глоб+локальные) */
  const getProjectStatuses=(projId)=>{
    const proj=data.projects.find(p=>p.id===projId);
    const local=(proj&&proj.localTaskStatuses)||[];
    const base=_applyBaseOverrides(BASE_TASK_STATUSES);
    const custom=[...(data.globalTaskStatuses||[]),...local];
    const merged=[...base,...custom];
    merged.sort((a,b)=>(a.order||0)-(b.order||0));
    return merged;
  };
  /* Лейблы из всех статусов */
  const allStatusLabels=()=>{
    const lbl={TODO:'📋 К выполнению',IN_PROGRESS:'🔄 В работе',DONE:'✅ Выполнена',BLOCKED:'🚧 Заблокирована'};
    const blOv=data._baseStatusLabels||{};
    Object.keys(blOv).forEach(k=>{lbl[k]=blOv[k];});
    (data.globalTaskStatuses||[]).forEach(s=>{lbl[s.key]=s.label;});
    data.projects.forEach(pr=>(pr.localTaskStatuses||[]).forEach(s=>{lbl[s.key]=s.label;}));
    return lbl;
  };
  /* CRUD глобальных статусов */
  const addGlobalTaskStatus=(status)=>{
    setData(d=>({...d,globalTaskStatuses:[...(d.globalTaskStatuses||[]),status]}));
    showToast('Статус «'+status.label+'» добавлен');
  };
  const removeGlobalTaskStatus=(key)=>{
    setData(d=>({...d,globalTaskStatuses:(d.globalTaskStatuses||[]).filter(s=>s.key!==key)}));
    showToast('Статус удалён');
  };
  const updateGlobalTaskStatus=(key,updates)=>{
    setData(d=>({...d,globalTaskStatuses:(d.globalTaskStatuses||[]).map(s=>s.key===key?{...s,...updates}:s)}));
  };
  const renameBaseStatus=(key,newLabel)=>{
    setData(d=>({...d,_baseStatusLabels:{...(d._baseStatusLabels||{}), [key]:newLabel}}));
    showToast('Статус переименован');
  };
  /* Перемещение колонки влево/вправо — переставляем order местами с соседом */
  const moveGlobalStatusOrder=(key,direction)=>{
    const all=getGlobalStatuses(); /* уже отсортированы */
    const idx=all.findIndex(s=>s.key===key);
    if(idx<0)return;
    const swapIdx=direction==='left'?idx-1:idx+1;
    if(swapIdx<0||swapIdx>=all.length)return;
    const myOrder=all[idx].order;const neighborOrder=all[swapIdx].order;
    /* Обновляем order: для базовых — они живут в BASE, не трогаем их напрямую,
       но вместо этого нормализуем: перестраиваем все order с шагом 10 после swap */
    const reordered=[...all];
    [reordered[idx],reordered[swapIdx]]=[reordered[swapIdx],reordered[idx]];
    /* Назначаем новые order с шагом 10 */
    reordered.forEach((s,i)=>{s.order=i*10;});
    /* Обновляем BASE order через специальный маппинг */
    const baseKeys=['TODO','IN_PROGRESS','DONE','BLOCKED'];
    const newBaseOrders={};reordered.forEach(s=>{if(baseKeys.includes(s.key))newBaseOrders[s.key]=s.order;});
    /* Сохраняем custom + baseOrderOverrides */
    setData(d=>{
      const customs=reordered.filter(s=>!baseKeys.includes(s.key)).map(s=>({...s}));
      return {...d,globalTaskStatuses:customs,_baseStatusOrders:newBaseOrders};
    });
  };
  const moveLocalStatusOrder=(projId,key,direction)=>{
    const all=getProjectStatuses(projId);
    const idx=all.findIndex(s=>s.key===key);
    if(idx<0)return;
    const swapIdx=direction==='left'?idx-1:idx+1;
    if(swapIdx<0||swapIdx>=all.length)return;
    const reordered=[...all];
    [reordered[idx],reordered[swapIdx]]=[reordered[swapIdx],reordered[idx]];
    reordered.forEach((s,i)=>{s.order=i*10;});
    const baseKeys=['TODO','IN_PROGRESS','DONE','BLOCKED'];
    const globalKeys=(data.globalTaskStatuses||[]).map(s=>s.key);
    /* Разделяем обратно: baseOrder, globals, locals */
    const newBaseOrders={};reordered.forEach(s=>{if(baseKeys.includes(s.key))newBaseOrders[s.key]=s.order;});
    const newGlobals=reordered.filter(s=>globalKeys.includes(s.key)).map(s=>({...s}));
    const newLocals=reordered.filter(s=>!baseKeys.includes(s.key)&&!globalKeys.includes(s.key)).map(s=>({...s}));
    setData(d=>({...d,
      _baseStatusOrders:newBaseOrders,
      globalTaskStatuses:newGlobals,
      projects:d.projects.map(p=>p.id===projId?{...p,localTaskStatuses:newLocals}:p)
    }));
  };
  /* CRUD локальных статусов проекта */
  const addLocalTaskStatus=(projId,status)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,localTaskStatuses:[...(p.localTaskStatuses||[]),status]}:p)}));
    showToast('Локальный статус «'+status.label+'» добавлен');
  };
  const removeLocalTaskStatus=(projId,key)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,localTaskStatuses:(p.localTaskStatuses||[]).filter(s=>s.key!==key)}:p)}));
  };
  const updateTaskStatus=(projId,taskId,status)=>{
    const proj=data.projects.find(p=>p.id===projId);const tsk=proj?(proj.tasks||[]).find(t=>t.id===taskId):null;
    const oldStatus=tsk?.status||'TODO';
    if(oldStatus===status)return;
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,tasks:(p.tasks||[]).map(t=>t.id===taskId?{...t,status}:t)}:p)}));
    showToast('Статус задачи: '+status);
    const sl=allStatusLabels();
    _chatLog(projId,'🔄 Статус задачи **'+(tsk?.title||'?')+'** изменён: '+(sl[oldStatus]||oldStatus)+' → '+(sl[status]||status),{task_id:taskId,allow_thread:true});
  };
  const updateTask=(projId,taskId,updates)=>{
    const proj=data.projects.find(p=>p.id===projId);const tsk=proj?(proj.tasks||[]).find(t=>t.id===taskId):null;
    if(updates.assigned_to_id!==undefined){const p2=data.persons.find(x=>x.id===updates.assigned_to_id);updates.assignee_name=p2?.name||'';}
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,tasks:(p.tasks||[]).map(t=>t.id===taskId?{...t,...updates}:t)}:p)}));
    /* Chat log for significant field changes */
    const parts=[];
    if(updates.assigned_to_id!==undefined&&updates.assigned_to_id!==(tsk?.assigned_to_id||''))parts.push('👤 Исполнитель → '+(updates.assignee_name||'Без исполнителя'));
    if(updates.deadline!==undefined&&updates.deadline!==(tsk?.deadline||''))parts.push('📅 Дедлайн → '+(updates.deadline||'снят'));
    if(updates.priority!==undefined&&Number(updates.priority)!==Number(tsk?.priority||3)){const prL={1:'🔴 Критич.',2:'🟠 Высокий',3:'🟡 Средний',4:'🟢 Низкий',5:'⚪ Миним.'};parts.push('⚡ Приоритет → '+(prL[updates.priority]||updates.priority));}
    if(updates.title!==undefined&&updates.title!==(tsk?.title||''))parts.push('✏️ Название → '+updates.title);
    if(parts.length>0)_chatLog(projId,'📝 Задача **'+(tsk?.title||updates.title||'?')+'** обновлена:\n'+parts.join('\n'),{task_id:taskId,allow_thread:true});
  };

  const deleteTask=(projId,taskId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,tasks:(p.tasks||[]).filter(t=>t.id!==taskId)}:p)}));
    showToast('Задача удалена');
  };

  const deleteProject=(id)=>{
    setData(d=>({...d,projects:d.projects.filter(p=>p.id!==id)}));showToast('Проект удалён');
  };

  const updatePayment=(projId,payId,updates)=>{
    const proj=data.projects.find(p=>p.id===projId);const pm2=proj?(proj.payments||[]).find(x=>x.id===payId):null;
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,payments:(p.payments||[]).map(pm=>pm.id===payId?{...pm,...updates}:pm)}:p)}));
    showToast('Транш обновлён');
    const parts=[];if(updates.status&&updates.status!==(pm2?.status||''))parts.push('статус → '+updates.status);if(updates.amount&&Number(updates.amount)!==Number(pm2?.amount||0))parts.push('сумма → '+Number(updates.amount).toLocaleString('ru')+' ₽');if(updates.planned_date&&updates.planned_date!==(pm2?.planned_date||''))parts.push('дата → '+updates.planned_date);
    if(parts.length)_chatLog(projId,'✏️ Транш #'+(pm2?.tranche_number||'?')+' обновлён: '+parts.join(', '));
  };

  const lockProject=(projId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,audit_locked:true,audit_locked_at:now()}:p)}));
    showToast('Проект заблокирован для редактирования');
    _chatLog(projId,'🔒 Проект заблокирован');
  };
  const unlockProject=(projId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,audit_locked:false}:p)}));
    showToast('Проект разблокирован');
    _chatLog(projId,'🔓 Проект разблокирован');
  };
  const deletePayment=(projId,payId)=>{
    const proj=data.projects.find(p=>p.id===projId);const pm2=proj?(proj.payments||[]).find(x=>x.id===payId):null;
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,payments:(p.payments||[]).filter(pm=>pm.id!==payId)}:p)}));
    showToast('Транш удалён');
    _chatLog(projId,'🗑️ Транш #'+(pm2?.tranche_number||'?')+' удалён');
  };

  const advanceStage=(projId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const phases=[...p.phases].map(ph=>({...ph,stages:[...(ph.stages||[])]}));
      let tracks=null;
      // Find current in-progress phase and stage
      let curPhIdx=phases.findIndex(ph=>ph.status==='IN_PROGRESS');
      if(curPhIdx<0)return p;
      let curStIdx=phases[curPhIdx].stages.findIndex(st=>st.status==='IN_PROGRESS');
      if(curStIdx<0)return p;
      // Complete current stage
      phases[curPhIdx].stages[curStIdx]={...phases[curPhIdx].stages[curStIdx],status:'COMPLETED',completed_at:now()};
      // Move to next stage or next phase
      if(curStIdx<phases[curPhIdx].stages.length-1){
        phases[curPhIdx].stages[curStIdx+1]={...phases[curPhIdx].stages[curStIdx+1],status:'IN_PROGRESS',started_at:now()};
      } else {
        phases[curPhIdx]={...phases[curPhIdx],status:'COMPLETED',completed_at:now()};
        if(curPhIdx<phases.length-1){
          phases[curPhIdx+1]={...phases[curPhIdx+1],status:'IN_PROGRESS',started_at:now()};
          phases[curPhIdx+1].stages[0]={...phases[curPhIdx+1].stages[0],status:'IN_PROGRESS',started_at:now()};
          // Auto-close tracks of completed phases
          const completedPhaseCodes=phases.filter(ph=>ph.status==='COMPLETED').map(ph=>ph.phase_code);
          const classToClose=[];
          if(completedPhaseCodes.includes('MINING'))classToClose.push('BPM');
          if(completedPhaseCodes.includes('ASSEMBLING'))classToClose.push('BPA');
          if(classToClose.length>0){
            tracks=(p.tracks||[]).map(t=>{
              if(classToClose.includes((t.track_class||'').toUpperCase())&&t.status!=='COMPLETED'){
                return {...t,status:'COMPLETED',end_date:t.end_date||now().slice(0,10)};
              }
              return t;
            });
          }
        } else {
          // Auto-close all remaining tracks when project completes
          tracks=(p.tracks||[]).map(t=>t.status!=='COMPLETED'?{...t,status:'COMPLETED',end_date:t.end_date||now().slice(0,10)}:t);
          return {...p,status:'COMPLETED',phases,tracks,updated_at:now()};
        }
      }
      return {...p,phases,tracks:tracks||(p.tracks||[]),updated_at:now()};
    })}));showToast('Стадия продвинута');
    _chatLog(projId,'⏩ Стадия проекта продвинута');
  };

  const earlyCompleteProject=(projId,settlement)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const tracks=(p.tracks||[]).map(t=>t.status!=='COMPLETED'?{...t,status:'COMPLETED',end_date:t.end_date||now().slice(0,10)}:t);
      const phases=(p.phases||[]).map(ph=>ph.status!=='COMPLETED'?{...ph,status:'COMPLETED',completed_at:now()}:ph);
      return {...p,status:'COMPLETED',tracks,phases,updated_at:now(),early_completed:true,early_completed_at:now(),early_settlement:{received:Number(settlement.received)||0,lost:Number(settlement.lost)||0,sf_claimed:Number(settlement.sf_claimed)||0,notes:settlement.notes||''}};
    })}));showToast('Проект досрочно завершён');
    _chatLog(projId,'🏁 Проект досрочно завершён'+(settlement.notes?' — '+settlement.notes:''));
  };

  /* Start first NOT_STARTED phase (or specific phase by id) */
  const startPhase=(projId,phaseId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const phases=(p.phases||[]).map(ph=>{
        if(phaseId){
          if(ph.id!==phaseId||ph.status!=='NOT_STARTED')return ph;
        }else{
          if(ph.status!=='NOT_STARTED')return ph;
          /* Only auto-start if no other phase is IN_PROGRESS */
          if((p.phases||[]).some(x=>x.status==='IN_PROGRESS'))return ph;
        }
        const stages=(ph.stages||[]).map((st,i)=>i===0?{...st,status:'IN_PROGRESS',started_at:now()}:st);
        return {...ph,status:'IN_PROGRESS',started_at:now(),stages};
      });
      /* If phaseId given, only that phase gets started; ensure project is ACTIVE */
      const newStatus=phases.some(ph=>ph.status==='IN_PROGRESS')?'ACTIVE':p.status;
      return {...p,status:newStatus,phases,updated_at:now()};
    })}));
    showToast('Фаза запущена');
    _chatLog(projId,'▶️ Фаза проекта запущена');
  };

  /* ===== Set phase status manually (ON_HOLD / resume / etc.) ===== */
  const setPhaseStatus=(projId,phaseId,newStatus)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const phases=(p.phases||[]).map(ph=>{
        if(ph.id!==phaseId)return ph;
        const upd={...ph,status:newStatus};
        if(newStatus==='ON_HOLD'&&ph.status==='IN_PROGRESS'){
          /* Remember when hold started; pause stages too */
          upd.hold_started_at=now();
          upd.stages=(ph.stages||[]).map(st=>st.status==='IN_PROGRESS'?{...st,status:'ON_HOLD',hold_started_at:now()}:st);
        }
        if(newStatus==='IN_PROGRESS'&&ph.status==='ON_HOLD'){
          /* Resume: accumulate hold_days */
          const held=ph.hold_started_at?calcDaysBetween(ph.hold_started_at,now()):0;
          upd.hold_days=(Number(ph.hold_days)||0)+held;
          delete upd.hold_started_at;
          upd.stages=(ph.stages||[]).map(st=>{
            if(st.status!=='ON_HOLD')return st;
            const sHeld=st.hold_started_at?calcDaysBetween(st.hold_started_at,now()):0;
            return {...st,status:'IN_PROGRESS',hold_days:(Number(st.hold_days)||0)+sHeld,hold_started_at:undefined};
          });
        }
        if(newStatus==='IN_PROGRESS'&&ph.status==='NOT_STARTED'){
          upd.started_at=now();
          upd.stages=(ph.stages||[]).map((st,i)=>i===0?{...st,status:'IN_PROGRESS',started_at:now()}:st);
        }
        if(newStatus==='COMPLETED'&&!ph.completed_at){
          upd.completed_at=now();
          upd.stages=(ph.stages||[]).map(st=>st.status!=='COMPLETED'?{...st,status:'COMPLETED',completed_at:now()}:st);
        }
        return upd;
      });
      return {...p,phases,updated_at:now()};
    })}));
    const labels={ON_HOLD:'⏸ Фаза приостановлена',IN_PROGRESS:'▶️ Фаза возобновлена',COMPLETED:'✅ Фаза завершена',NOT_STARTED:'⏹ Фаза сброшена'};
    showToast(labels[newStatus]||'Статус фазы: '+newStatus);
    _chatLog(projId,(labels[newStatus]||'Статус фазы: '+newStatus));
  };

  /* ===== Hold/Resume entire project (affects all IN_PROGRESS phases) ===== */
  const holdProject=(projId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const phases=(p.phases||[]).map(ph=>{
        if(ph.status!=='IN_PROGRESS')return ph;
        return {...ph,status:'ON_HOLD',hold_started_at:now(),
          stages:(ph.stages||[]).map(st=>st.status==='IN_PROGRESS'?{...st,status:'ON_HOLD',hold_started_at:now()}:st)};
      });
      return {...p,status:'ON_HOLD',phases,updated_at:now()};
    })}));
    showToast('Проект приостановлен');
    _chatLog(projId,'⏸ Проект приостановлен — все фазы на паузе');
  };

  const resumeProject=(projId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const phases=(p.phases||[]).map(ph=>{
        if(ph.status!=='ON_HOLD')return ph;
        const held=ph.hold_started_at?calcDaysBetween(ph.hold_started_at,now()):0;
        return {...ph,status:'IN_PROGRESS',hold_days:(Number(ph.hold_days)||0)+held,hold_started_at:undefined,
          stages:(ph.stages||[]).map(st=>{
            if(st.status!=='ON_HOLD')return st;
            const sHeld=st.hold_started_at?calcDaysBetween(st.hold_started_at,now()):0;
            return {...st,status:'IN_PROGRESS',hold_days:(Number(st.hold_days)||0)+sHeld,hold_started_at:undefined};
          })};
      });
      return {...p,status:'ACTIVE',phases,updated_at:now()};
    })}));
    showToast('Проект возобновлён');
    _chatLog(projId,'▶️ Проект возобновлён — фазы продолжены');
  };

  /* ===== Milestones / Enablers ===== */
  const addMilestone=(projId,ms)=>{
    const m={id:uuid(),name:ms.name||'',description:ms.description||'',target_date:ms.target_date||'',phase_id:ms.phase_id||null,status:'PENDING',is_enabler:ms.is_enabler||false,created_at:now()};
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,milestones:[...(p.milestones||[]),m]}:p)}));
    showToast(m.is_enabler?'Энейблер добавлен':'Веха добавлена');
    _chatLog(projId,(m.is_enabler?'📞 Энейблер':'🏁 Веха')+': **'+m.name+'**');
  };
  const updateMilestone=(projId,msId,upd)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      return {...p,milestones:(p.milestones||[]).map(m=>m.id===msId?{...m,...upd}:m)};
    })}));
    showToast('Веха обновлена');
  };
  const deleteMilestone=(projId,msId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      return {...p,milestones:(p.milestones||[]).filter(m=>m.id!==msId)};
    })}));
    showToast('Веха удалена');
  };
  const completeMilestone=(projId,msId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      return {...p,milestones:(p.milestones||[]).map(m=>m.id===msId?{...m,status:'DONE',completed_at:now()}:m)};
    })}));
    showToast('Веха завершена');
    const ms=(data.projects.find(x=>x.id===projId)?.milestones||[]).find(m=>m.id===msId);
    _chatLog(projId,'✅ Веха завершена: **'+(ms?.name||'')+'**');
  };

  const removeAssignment=(projId,assignId)=>{
    const proj=data.projects.find(p=>p.id===projId);const asg=proj?(proj.assignments||[]).find(a=>a.id===assignId):null;
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,assignments:(p.assignments||[]).filter(a=>a.id!==assignId)}:p)}));
    showToast('Назначение снято');
    _chatLog(projId,'👤 Снято назначение: **'+(asg?.person_name||'?')+'**');
  };

  const addProjectType=(name)=>{if(!name)return;setData(d=>({...d,projectTypes:[...d.projectTypes,name]}));showToast('Тип проекта добавлен');};
  const deleteProjectType=(name)=>{setData(d=>({...d,projectTypes:d.projectTypes.filter(t=>t!==name)}));showToast('Тип проекта удалён');};

  const updatePhaseDates=(projId,phaseId,dates)=>{
    /* dates = {period_start?, period_end?} */
    const proj=data.projects.find(p=>p.id===projId);
    if(!proj)return;
    const contractStart=proj.start_date||'';
    const contractEnd=proj.target_end_date||proj.end_date||'';
    /* Soft validate: warn but allow saving */
    if(dates.period_start&&contractStart&&dates.period_start<contractStart){showToast('⚠️ Дата раньше старта контракта ('+contractStart+')');}
    if(dates.period_end&&contractEnd&&dates.period_end>contractEnd){showToast('⚠️ Дата позже конца контракта ('+contractEnd+')');}
    if(dates.period_start&&dates.period_end&&dates.period_start>dates.period_end){showToast('⚠️ Старт позже конца — проверьте даты');}
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      return {...p,phases:(p.phases||[]).map(ph=>ph.id===phaseId?{...ph,...dates}:ph)};
    })}));
    showToast('Даты фазы обновлены');
  };
  const updatePhaseDoc=(projId,phaseCode,docKey,updates)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const pd={...(p.phase_docs||{})};
      pd[phaseCode]={...(pd[phaseCode]||{})};
      pd[phaseCode][docKey]={...(pd[phaseCode][docKey]||{}),...updates,uploaded_at:updates.status==='DONE'?new Date().toISOString():(pd[phaseCode][docKey]||{}).uploaded_at||''};
      return {...p,phase_docs:pd};
    })}));
    if(updates.status==='DONE')showToast('Документ загружен');
  };
  const addDocument=(projId,doc)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,documents:[...(p.documents||[]),{id:crypto.randomUUID(),...doc,added_at:new Date().toISOString()}]}:p)}));
    showToast('Документ добавлен');
  };
  const deleteDocument=(projId,docId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>p.id===projId?{...p,documents:(p.documents||[]).filter(d=>d.id!==docId)}:p)}));
    showToast('Документ удалён');
  };
  const updateAdminScale=(projId,sectionKey,notes)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const as={...(p.admin_scale||{})};
      as[sectionKey]=notes;
      return {...p,admin_scale:as};
    })}));
  };
  const addInsight=(projId,subjId,insight)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId||!p.hypothesisBoard)return p;
      return {...p,hypothesisBoard:{...p.hypothesisBoard,subjects:(p.hypothesisBoard.subjects||[]).map(s=>s.id===subjId?{...s,insights:[...(s.insights||[]),{id:crypto.randomUUID(),...insight}]}:s)}};
    })}));showToast('Инсайт добавлен');
  };
  const deleteInsight=(projId,subjId,insId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId||!p.hypothesisBoard)return p;
      return {...p,hypothesisBoard:{...p.hypothesisBoard,subjects:(p.hypothesisBoard.subjects||[]).map(s=>s.id===subjId?{...s,insights:(s.insights||[]).filter(ins=>ins.id!==insId)}:s)}};
    })}));showToast('Инсайт удалён');
  };
  const linkTrackToSubject=(projId,subjId,trackId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId||!p.hypothesisBoard)return p;
      const track=(p.tracks||[]).find(t=>t.id===trackId);
      if(!track)return p;
      const link={id:trackId,track_code:track.track_code,track_name:track.track_name,track_class:track.track_class};
      return {...p,hypothesisBoard:{...p.hypothesisBoard,subjects:(p.hypothesisBoard.subjects||[]).map(s=>s.id===subjId?{...s,trackLinks:[...(s.trackLinks||[]).filter(tl=>tl.id!==trackId),link]}:s)}};
    })}));showToast('Трек привязан');
  };
  const unlinkTrackFromSubject=(projId,subjId,trackId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId||!p.hypothesisBoard)return p;
      return {...p,hypothesisBoard:{...p.hypothesisBoard,subjects:(p.hypothesisBoard.subjects||[]).map(s=>s.id===subjId?{...s,trackLinks:(s.trackLinks||[]).filter(tl=>tl.id!==trackId)}:s)}};
    })}));showToast('Трек отвязан');
  };
  const linkTrackToInsight=(projId,subjId,insightId,trackId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId||!p.hypothesisBoard)return p;
      const track=(p.tracks||[]).find(t=>t.id===trackId);
      if(!track)return p;
      const tl={id:trackId,track_code:track.track_code,track_name:track.track_name,track_class:track.track_class};
      return {...p,hypothesisBoard:{...p.hypothesisBoard,subjects:(p.hypothesisBoard.subjects||[]).map(s=>s.id===subjId?{...s,insights:(s.insights||[]).map(ins=>{
        if(ins.id!==insightId)return ins;
        const lt=[...(ins.linked_tracks||[])];
        if(ins.linked_track_id&&!lt.some(x=>x.id===ins.linked_track_id)){lt.push({id:ins.linked_track_id,track_code:ins.linked_track_code,track_name:ins.linked_track_name,track_class:ins.linked_track_class});}
        if(!lt.some(x=>x.id===trackId))lt.push(tl);
        return {...ins,linked_tracks:lt,linked_track_id:null,linked_track_code:null,linked_track_name:null,linked_track_class:null};
      })}:s)}};
    })}));showToast('Трек привязан к инсайту');
  };
  const unlinkTrackFromInsight=(projId,subjId,insightId,trackId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId||!p.hypothesisBoard)return p;
      return {...p,hypothesisBoard:{...p.hypothesisBoard,subjects:(p.hypothesisBoard.subjects||[]).map(s=>s.id===subjId?{...s,insights:(s.insights||[]).map(ins=>ins.id===insightId?{...ins,linked_tracks:(ins.linked_tracks||[]).filter(lt=>lt.id!==trackId)}:ins)}:s)}};
    })}));showToast('Трек отвязан от инсайта');
  };
  const deleteGoal=(projId,goalId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId||!p.hypothesisBoard)return p;
      return {...p,hypothesisBoard:{...p.hypothesisBoard,goals:(p.hypothesisBoard.goals||[]).filter(g=>g.id!==goalId),subjects:(p.hypothesisBoard.subjects||[]).filter(s=>s.goal_id!==goalId)}};
    })}));showToast('Цель удалена');
  };
  const deleteSubject=(projId,subjId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId||!p.hypothesisBoard)return p;
      return {...p,hypothesisBoard:{...p.hypothesisBoard,subjects:(p.hypothesisBoard.subjects||[]).filter(s=>s.id!==subjId)}};
    })}));showToast('Субъект удалён');
  };
  /* ===== Issue Tree dynamic columns & card links ===== */
  const IT_DEFAULT_COLS=[
    {id:'it_col_goal',title:'Цели',entity_type:'goal',is_sub:false,parent_column_id:null,color:'#10b981',order_num:0,items:[]},
    {id:'it_col_subj',title:'Субъекты',entity_type:'subject',is_sub:false,parent_column_id:null,color:'#f97316',order_num:1,items:[]},
    {id:'it_col_ins',title:'Инсайты',entity_type:'insight',is_sub:false,parent_column_id:null,color:'#ef4444',order_num:2,items:[]},
    {id:'it_col_track',title:'Треки',entity_type:'track',is_sub:false,parent_column_id:null,color:'#0ea5e9',order_num:3,items:[]},
    {id:'it_col_task',title:'Задачи',entity_type:'task',is_sub:false,parent_column_id:null,color:'#8b5cf6',order_num:4,items:[]}
  ];
  const _ensureITCols=(hb)=>{if(hb.columns&&hb.columns.length>0)return hb;return {...hb,columns:[...IT_DEFAULT_COLS],cardLinks:hb.cardLinks||[]};};
  const _etLabel=(et)=>({goal:'Подцели',subject:'Подсубъекты',insight:'Подинсайты',track:'Подтреки',task:'Подзадачи'}[et]||'Подэлементы');

  const addITColumn=(projId,sourceColId,position)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const hb=_ensureITCols(p.hypothesisBoard||{id:uuid(),goals:[],subjects:[]});
      const cols=[...hb.columns];
      const srcIdx=cols.findIndex(c=>c.id===sourceColId);
      if(srcIdx<0)return p;
      const src=cols[srcIdx];
      const newOrd=position==='right'?src.order_num+0.5:src.order_num-0.5;
      const nc={id:uuid(),title:_etLabel(src.entity_type),entity_type:src.entity_type,is_sub:true,parent_column_id:sourceColId,color:src.color,order_num:newOrd,items:[]};
      cols.push(nc);
      cols.sort((a,b)=>a.order_num-b.order_num);
      cols.forEach((c,i)=>{c.order_num=i;});
      return {...p,hypothesisBoard:{...hb,columns:cols}};
    })}));showToast('Колонка добавлена');
  };
  const removeITColumn=(projId,colId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const hb=_ensureITCols(p.hypothesisBoard||{id:uuid(),goals:[],subjects:[]});
      const col=hb.columns.find(c=>c.id===colId);
      if(!col||!col.is_sub)return p;
      const cols=hb.columns.filter(c=>c.id!==colId);
      cols.forEach((c,i)=>{c.order_num=i;});
      const links=(hb.cardLinks||[]).filter(l=>l.from_col!==colId&&l.to_col!==colId);
      return {...p,hypothesisBoard:{...hb,columns:cols,cardLinks:links}};
    })}));showToast('Колонка удалена');
  };
  const updateITColumnColor=(projId,colId,color)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const hb=_ensureITCols(p.hypothesisBoard||{id:uuid(),goals:[],subjects:[]});
      return {...p,hypothesisBoard:{...hb,columns:hb.columns.map(c=>c.id===colId?{...c,color}:c)}};
    })}));
  };
  const addITColumnItem=(projId,colId,item)=>{
    const it={id:uuid(),title:item.title||'',description:item.description||'',meta:item.meta||'',created_at:now()};
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const hb=_ensureITCols(p.hypothesisBoard||{id:uuid(),goals:[],subjects:[]});
      return {...p,hypothesisBoard:{...hb,columns:hb.columns.map(c=>c.id===colId?{...c,items:[...(c.items||[]),it]}:c)}};
    })}));showToast('Элемент добавлен');
  };
  const removeITColumnItem=(projId,colId,itemId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const hb=_ensureITCols(p.hypothesisBoard||{id:uuid(),goals:[],subjects:[]});
      const links=(hb.cardLinks||[]).filter(l=>!(l.from_col===colId&&l.from_id===itemId)&&!(l.to_col===colId&&l.to_id===itemId));
      return {...p,hypothesisBoard:{...hb,columns:hb.columns.map(c=>c.id===colId?{...c,items:(c.items||[]).filter(i=>i.id!==itemId)}:c),cardLinks:links}};
    })}));showToast('Элемент удалён');
  };
  const addCardLink=(projId,fromId,fromCol,toId,toCol)=>{
    if(fromId===toId&&fromCol===toCol)return;
    const lnk={id:uuid(),from_id:fromId,from_col:fromCol,to_id:toId,to_col:toCol};
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const hb=_ensureITCols(p.hypothesisBoard||{id:uuid(),goals:[],subjects:[]});
      const exists=(hb.cardLinks||[]).some(l=>(l.from_id===fromId&&l.to_id===toId)||(l.from_id===toId&&l.to_id===fromId));
      if(exists)return p;
      return {...p,hypothesisBoard:{...hb,cardLinks:[...(hb.cardLinks||[]),lnk]}};
    })}));showToast('Связь создана');
  };
  const removeCardLink=(projId,linkId)=>{
    setData(d=>({...d,projects:d.projects.map(p=>{
      if(p.id!==projId)return p;
      const hb=p.hypothesisBoard;if(!hb)return p;
      return {...p,hypothesisBoard:{...hb,cardLinks:(hb.cardLinks||[]).filter(l=>l.id!==linkId)}};
    })}));showToast('Связь удалена');
  };

  const importData=(json)=>{
    try{
      const imported=JSON.parse(json);
      setData(d=>({...d,...imported}));showToast('Данные импортированы');
    }catch(e){showToast('Ошибка импорта: '+e.message);}
  };

  const exportData=()=>{
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='portfolio-export-'+new Date().toISOString().slice(0,10)+'.json';a.click();URL.revokeObjectURL(url);
    showToast('Данные экспортированы');
  };

  /* === CRM Deals === */
  const addCrmDeal=(deal)=>{setData(d=>({...d,crm_deals:[...(d.crm_deals||[]),{id:uuid(),created_at:now(),...deal}]}));showToast('Сделка добавлена');};
  const updateCrmDeal=(id,upd)=>{setData(d=>({...d,crm_deals:(d.crm_deals||[]).map(x=>x.id===id?{...x,...upd,updated_at:now()}:x)}));};
  const deleteCrmDeal=(id)=>{setData(d=>({...d,crm_deals:(d.crm_deals||[]).filter(x=>x.id!==id)}));showToast('Сделка удалена');};

  /* === ICF Deals (сделки инвестпроектов) === */
  const addIcfDeal=(deal)=>{const d={id:uuid(),created_at:now(),...deal};setData(dd=>({...dd,icf_deals:[...(dd.icf_deals||[]),d]}));showToast('Сделка инвестпроекта добавлена');return d;};
  const updateIcfDeal=(id,upd)=>{setData(d=>({...d,icf_deals:(d.icf_deals||[]).map(x=>x.id===id?{...x,...upd,updated_at:now()}:x)}));};
  const deleteIcfDeal=(id)=>{setData(d=>({...d,icf_deals:(d.icf_deals||[]).filter(x=>x.id!==id)}));showToast('Сделка удалена');};
  const bulkImportIcfDeals=(deals)=>{setData(d=>{const existing=(d.icf_deals||[]);const newDeals=deals.map(dl=>({id:uuid(),created_at:now(),...dl}));return{...d,icf_deals:[...existing,...newDeals]};});showToast('Импортировано '+deals.length+' сделок');};

  /* === Metrics Maps (Карта метрик проекта) === */
  const getMetricsMap=(projName)=>(data.metrics_maps||{})[projName]||{nodes:[],links:[]};
  const setMetricsMap=(projName,map)=>{setData(d=>({...d,metrics_maps:{...(d.metrics_maps||{}),[projName]:map}}));};
  const updateMetricsNode=(projName,nodeId,upd)=>{setData(d=>{const mm={...(d.metrics_maps||{})};const m=mm[projName]||{nodes:[],links:[]};mm[projName]={...m,nodes:m.nodes.map(n=>n.id===nodeId?{...n,...upd}:n)};return{...d,metrics_maps:mm};});};
  const addMetricsNode=(projName,node)=>{setData(d=>{const mm={...(d.metrics_maps||{})};const m=mm[projName]||{nodes:[],links:[]};mm[projName]={...m,nodes:[...m.nodes,node]};return{...d,metrics_maps:mm};});};
  const deleteMetricsNode=(projName,nodeId)=>{setData(d=>{const mm={...(d.metrics_maps||{})};const m=mm[projName]||{nodes:[],links:[]};mm[projName]={nodes:m.nodes.filter(n=>n.id!==nodeId),links:m.links.filter(l=>{const f=l.from||l[0];const t=l.to||l[1];return f!==nodeId&&t!==nodeId;})};return{...d,metrics_maps:mm};});};
  const addMetricsLink=(projName,link)=>{setData(d=>{const mm={...(d.metrics_maps||{})};const m=mm[projName]||{nodes:[],links:[]};mm[projName]={...m,links:[...m.links,link]};return{...d,metrics_maps:mm};});};
  const deleteMetricsLink=(projName,from,to)=>{setData(d=>{const mm={...(d.metrics_maps||{})};const m=mm[projName]||{nodes:[],links:[]};mm[projName]={...m,links:m.links.filter(l=>{const lf=l.from||l[0];const lt=l.to||l[1];return!(lf===from&&lt===to);})};return{...d,metrics_maps:mm};});};

  /* === ICF Non-Student toggle === */
  const toggleNonStudent=(proj,userName)=>{setData(d=>{const ns={...(d.icf_non_students||{})};const arr=ns[proj]||[];if(arr.includes(userName))ns[proj]=arr.filter(u=>u!==userName);else ns[proj]=[...arr,userName];return{...d,icf_non_students:ns};});};

  /* === Notion CRM Staging (проверка) === */
  const addStagingDeal=(deal)=>{setData(d=>({...d,notion_crm_staging:[...(d.notion_crm_staging||[]),{id:uuid(),created_at:now(),...deal}]}));showToast('Сделка добавлена в проверку');};
  const updateStagingDeal=(id,upd)=>{setData(d=>({...d,notion_crm_staging:(d.notion_crm_staging||[]).map(x=>x.id===id?{...x,...upd}:x)}));};
  const deleteStagingDeal=(id)=>{setData(d=>({...d,notion_crm_staging:(d.notion_crm_staging||[]).filter(x=>x.id!==id)}));showToast('Запись удалена');};
  const transferStagingToCrm=(ids)=>{setData(d=>{
    const staging=(d.notion_crm_staging||[]);const toMove=staging.filter(x=>ids.includes(x.id));
    const STAGE_MAP={'Накопан в академии':'nakopan_6','Накопан в клубе':'nakopan_6','Накопан у Бодрейшего':'nakopan_bm','Накопан в ABM':'nakopan_bm','Накопан на ивенте или партнером':'nakopan_bm','MQL назначен созвон':'mql_call','SQL назначен созвон':'sql_call','SQL требуется прогрев':'sql_warmup','Пишем КП':'writing_kp','КП выслано':'kp_sent','Защита обсуждается':'defense_discuss','Защита поставлена':'defense_set','Дожим':'push','Дослать материалы':'send_materials','Вернуться позже':'come_back','Нет ответа':'no_answer','Устное Да':'verbal_yes','Договор сделан':'contract_done','Счета выставлены':'invoices_sent','Выиграно':'won','Прошел созвон по TWWW':'twww_call','Выиграно в прошл. периоды':'won_past','Проиграно RFR':'lost','RFR Выслана матрица':'lost','RFR Матрица презентована':'lost','RFR Выиграно':'refresh_won','RNG Написать кейс':'re_need','RNG Выявлена потребность':'re_need','RNG КП выслано':'re_kp','RNG Защита проведена':'re_defense','RNG Проиграно':'re_lost','RNG Выиграно':'re_won','RNG Кейс написан':'re_kp','RNG Выиграно в прош. периоды':'re_won_past','RNG Счета выставлены':'re_invoice'};
    const newDeals=toMove.map(s=>({id:uuid(),created_at:now(),name:s.name,client_id:'',amount:Number(s.contract)||0,first_payment:Number(s.first_payment)||0,stage:STAGE_MAP[s.notion_stage]||'nakopan_6',request_type:s.request_type||'',priority:s.priority||'',notes:s.comment||'',responsible:s.responsible||'',notion_id:s.notion_id||'',contact_person:'',contact_email:'',contact_phone:'',chat_link:'',source:'',date_first_call:'',date_kp_sent:'',date_kp_defense:'',date_push:'',date_won:''}));
    return {...d,crm_deals:[...(d.crm_deals||[]),...newDeals],notion_crm_staging:staging.filter(x=>!ids.includes(x.id))};
  });showToast('Перенесено '+ids.length+' сделок в CRM');};
  /* CRM stages CRUD */
  const addCrmStage=(lineIdx,stage)=>{setData(d=>{const lines=JSON.parse(JSON.stringify(d.crm_lines||[]));if(!lines[lineIdx])return d;lines[lineIdx].stages.push({id:uuid(),label:stage.label,color:stage.color||lines[lineIdx].defaultColor||'#e8eaf6'});return{...d,crm_lines:lines};});showToast('Этап добавлен');};
  const updateCrmStage=(lineIdx,stageId,upd)=>{setData(d=>{const lines=JSON.parse(JSON.stringify(d.crm_lines||[]));if(!lines[lineIdx])return d;lines[lineIdx].stages=lines[lineIdx].stages.map(s=>s.id===stageId?{...s,...upd}:s);return{...d,crm_lines:lines};});};
  const deleteCrmStage=(lineIdx,stageId)=>{setData(d=>{const lines=JSON.parse(JSON.stringify(d.crm_lines||[]));if(!lines[lineIdx])return d;lines[lineIdx].stages=lines[lineIdx].stages.filter(s=>s.id!==stageId);return{...d,crm_lines:lines};});showToast('Этап удалён');};
  const reorderCrmStage=(lineIdx,stageId,dir)=>{setData(d=>{const lines=JSON.parse(JSON.stringify(d.crm_lines||[]));if(!lines[lineIdx])return d;const arr=lines[lineIdx].stages;const idx=arr.findIndex(s=>s.id===stageId);if(idx<0)return d;const ni=idx+dir;if(ni<0||ni>=arr.length)return d;[arr[idx],arr[ni]]=[arr[ni],arr[idx]];return{...d,crm_lines:lines};});};

  /* ===== CHAT OPERATIONS ===== */
  const _ensureChat=(d)=>{
    if(!d.chat_channels)d.chat_channels=[
      {id:'general',name:'Общий',description:'Основной канал для всей команды',type:'public',created_at:now(),pinned:true},
      {id:'projects',name:'Проекты',description:'Обсуждение проектов',type:'public',created_at:now(),pinned:true},
      {id:'random',name:'Разное',description:'Неформальное общение',type:'public',created_at:now(),pinned:false}
    ];
    if(!d.chat_messages)d.chat_messages=[];
    if(!d.chat_current_user)d.chat_current_user={id:'me',name:'Илья',avatar:'И'};
    return d;
  };
  const addChatChannel=(ch)=>{setData(d=>{const nd={..._ensureChat({...d})};
    /* For DM channels: deterministic id based on sorted pair of user ids */
    let chId=uuid();
    if(ch.type==='dm'&&ch.person_id){
      const me=_getChatAuthor();
      const pair=[me.id,ch.person_id].sort().join('_');
      chId='dm_'+pair;
      /* If channel already exists, don't create duplicate */
      if(nd.chat_channels.some(c=>c.id===chId))return nd;
    }
    nd.chat_channels=[...nd.chat_channels,{id:chId,created_at:now(),type:'public',pinned:false,...ch}];return nd;});showToast('Канал создан');};
  const updateChatChannel=(id,upd)=>{setData(d=>{const nd={..._ensureChat({...d})};nd.chat_channels=nd.chat_channels.map(c=>c.id===id?{...c,...upd}:c);return nd;});};
  const deleteChatChannel=(id)=>{setData(d=>{const nd={..._ensureChat({...d})};nd.chat_channels=nd.chat_channels.filter(c=>c.id!==id);nd.chat_messages=nd.chat_messages.filter(m=>m.channel_id!==id);return nd;});showToast('Канал удалён');};
  const _getChatAuthor=()=>{try{const s=JSON.parse(sessionStorage.getItem('pp_auth_session'));if(s)return{id:s.user_id,name:s.name||s.login,avatar:(s.name||s.login||'?')[0].toUpperCase()};}catch(e){}return{id:'me',name:'Илья',avatar:'И'};};
  const addChatMessage=(msg)=>{const id=uuid();const ts=now();const author=_getChatAuthor();setData(d=>{const nd={..._ensureChat({...d})};nd.chat_messages=[...nd.chat_messages,{id,created_at:ts,author,...msg,reactions:[],edited:false}];/* Detect @mentions and create notifications */const mentionRx=/@([\w.]+)/g;let mt;const text=msg.text||'';while((mt=mentionRx.exec(text))!==null){const login=mt[1];const targetUser=(nd.users||[]).find(u=>u.login===login&&u.is_active);if(targetUser&&targetUser.id!==author.id){if(!nd.notifications)nd.notifications=[];nd.notifications=[...nd.notifications,{id:uuid(),created_at:ts,read:false,type:'mention',user_id:targetUser.id,user_login:targetUser.login,from_user_id:author.id,from_user_name:author.name,channel_id:msg.channel_id||'',message_id:id,message_text:text.length>120?text.slice(0,120)+'…':text,thread_id:msg.thread_id||null}];}}return nd;});return id;};
  const updateChatMessage=(id,upd)=>{setData(d=>{const nd={..._ensureChat({...d})};nd.chat_messages=nd.chat_messages.map(m=>m.id===id?{...m,...upd,edited:true,edited_at:now()}:m);return nd;});};
  const deleteChatMessage=(id)=>{setData(d=>{const nd={..._ensureChat({...d})};nd.chat_messages=nd.chat_messages.filter(m=>m.id!==id&&m.thread_id!==id);return nd;});};
  const addChatReaction=(msgId,emoji)=>{const au=_getChatAuthor();setData(d=>{const nd={..._ensureChat({...d})};nd.chat_messages=nd.chat_messages.map(m=>{if(m.id!==msgId)return m;const rx=[...(m.reactions||[])];const existing=rx.findIndex(r=>r.emoji===emoji&&r.user_id===au.id);if(existing>=0)rx.splice(existing,1);else rx.push({emoji,user_id:au.id,user_name:au.name});return{...m,reactions:rx};});return nd;});};
  const pinChatMessage=(msgId)=>{setData(d=>{const nd={..._ensureChat({...d})};nd.chat_messages=nd.chat_messages.map(m=>m.id===msgId?{...m,pinned:!m.pinned}:m);return nd;});};
  const setChatUser=(user)=>{setData(d=>({...d,chat_current_user:user}));};

  /* === Notifications === */
  const addNotification=(notif)=>{
    const id=uuid();
    setData(d=>({...d,notifications:[...(d.notifications||[]),{id,created_at:now(),read:false,...notif}]}));
    return id;
  };
  const markNotificationRead=(nId)=>{
    setData(d=>({...d,notifications:(d.notifications||[]).map(n=>n.id===nId?{...n,read:true}:n)}));
  };
  const markAllNotificationsRead=(userId)=>{
    setData(d=>({...d,notifications:(d.notifications||[]).map(n=>n.user_id===userId?{...n,read:true}:n)}));
  };
  const deleteNotification=(nId)=>{
    setData(d=>({...d,notifications:(d.notifications||[]).filter(n=>n.id!==nId)}));
  };

  const stats=useMemo(()=>({projectCount:data.projects.length,activeCount:data.projects.filter(p=>p.status==='ACTIVE').length,clientCount:data.clients.length,personCount:data.persons.filter(p=>p.is_active).length,taskCount:data.projects.reduce((s,p)=>s+(p.tasks||[]).length,0),blockerCount:data.projects.reduce((s,p)=>s+(p.blockers||[]).filter(b=>!b.resolved_at).length,0)}),[data.projects,data.clients,data.persons]);

  /* ===== Auth / User CRUD ===== */
  const hashPwd=async(pwd)=>{const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(pwd));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');};
  const addUser=async(u)=>{
    const ph=await hashPwd(u.password||'111111');
    const _roles=u.roles&&Array.isArray(u.roles)&&u.roles.length>0?u.roles:(u.role?[u.role]:['user']);
    const entry={id:uuid(),login:u.login,password_hash:ph,name:u.name||'',person_id:u.person_id||null,role:_roles[0]||'user',roles:_roles,is_active:true,created_at:now(),last_login:null};
    setData(d=>({...d,users:[...(d.users||[]),entry]}));
    showToast('Аккаунт создан: '+u.login);return entry;
  };
  const updateUser=(userId,updates)=>{
    setData(d=>({...d,users:(d.users||[]).map(u=>u.id===userId?{...u,...updates}:u)}));
  };
  const deleteUser=(userId)=>{
    setData(d=>({...d,users:(d.users||[]).filter(u=>u.id!==userId)}));
    showToast('Аккаунт удалён');
  };
  const resetUserPassword=async(userId,newPwd)=>{
    const ph=await hashPwd(newPwd);
    setData(d=>({...d,users:(d.users||[]).map(u=>u.id===userId?{...u,password_hash:ph}:u)}));
    showToast('Пароль сброшен');
  };
  const validateLogin=async(login,password)=>{
    const users=data.users||[];
    const user=users.find(u=>u.login===login&&u.is_active);
    if(!user)return null;
    const ph=await hashPwd(password);
    if(ph!==user.password_hash)return null;
    /* Update last_login */
    setData(d=>({...d,users:(d.users||[]).map(u=>u.id===user.id?{...u,last_login:now()}:u)}));
    return user;
  };

  return {data,stats,toast,sbStatus,sbLoaded,reconnectSb,hashPwd,addUser,updateUser,deleteUser,resetUserPassword,validateLogin,addClient,addPerson,addProject,updateProject,activateProject,addAssignment,removeAssignment,addTrack,addTask,addBlocker,resolveBlocker,addPayment,markPaymentAccrued,markPaymentPaid,markAllPaymentsPaid,addPnlOverride,deletePnlOverride,addRecommendation,addRecommendationsBatch,updateRecommendationStatus,deleteRecommendation,addOverhead,updateOverhead,removeOverhead,addKbBudgetItem,updateKbBudgetItem,deleteKbBudgetItem,addHrBudgetItem,updateHrBudgetItem,deleteHrBudgetItem,addOhRegistryItem,updateOhRegistryItem,deleteOhRegistryItem,toggleOhRegistryVerified,clearOverheadRegistry,syncOhToProject,syncOhToKbBudget,approveOhRequest,rejectOhRequest,updateOhRequest,markOhDisbursed,markOhRequestDisbursed,bulkImportOhRegistry,runFkDoubleCheck,addTimeEntry,updateTimeEntry,deleteTimeEntry,autoScheduleTracks,forceScheduleTracks,addGoal,addSubGoal,deleteSubGoal,addSubject,exportData,updateClient,updatePerson,deletePerson,updateTrackDates,updateTrackStatus,deleteTrack,updateTaskStatus,updateTask,deleteTask,deleteProject,updatePayment,deletePayment,advanceStage,importData,addProjectType,deleteProjectType,addDocument,deleteDocument,updateAdminScale,updatePhaseDoc,addInsight,deleteInsight,linkTrackToSubject,unlinkTrackFromSubject,deleteGoal,deleteSubject,linkTrackToInsight,unlinkTrackFromInsight,addTrackDep,removeTrackDep,upsertWeeklyHours,deleteWeeklyHours,lockProject,unlockProject,earlyCompleteProject,addCrmDeal,updateCrmDeal,deleteCrmDeal,addIcfDeal,updateIcfDeal,deleteIcfDeal,bulkImportIcfDeals,toggleNonStudent,getMetricsMap,setMetricsMap,updateMetricsNode,addMetricsNode,deleteMetricsNode,addMetricsLink,deleteMetricsLink,addStagingDeal,updateStagingDeal,deleteStagingDeal,transferStagingToCrm,addCrmStage,updateCrmStage,deleteCrmStage,reorderCrmStage,addChatChannel,updateChatChannel,deleteChatChannel,addChatMessage,updateChatMessage,deleteChatMessage,addChatReaction,pinChatMessage,setChatUser,addNotification,markNotificationRead,markAllNotificationsRead,deleteNotification,updatePhaseDates,startPhase,setPhaseStatus,holdProject,resumeProject,addMilestone,updateMilestone,deleteMilestone,completeMilestone,addITColumn,removeITColumn,updateITColumnColor,addITColumnItem,removeITColumnItem,addCardLink,removeCardLink,_ensureITCols,IT_DEFAULT_COLS,BASE_TASK_STATUSES,getGlobalStatuses,getProjectStatuses,addGlobalTaskStatus,removeGlobalTaskStatus,updateGlobalTaskStatus,renameBaseStatus,addLocalTaskStatus,removeLocalTaskStatus,moveGlobalStatusOrder,moveLocalStatusOrder};
}

/* ===== FORMS ===== */
function NewProjectModal({store,onClose,initialName,initialClientId}){
  const [f,setF]=useState({code:'',name:initialName||'',client_id:initialClientId||'',project_type:'',work_group:'',sales_group:'',total_contract_value:'',tax_rate:0,start_date:'',target_end_date:'',notes:'',nd_payment_period:'quarterly',nd_period_cost:'',nd_period_start:'',nd_period_end:'',nd_has_success_fee:false,nd_success_fee:'',nd_num_periods:4,fk_monthly_cost:'',fk_planned_months:12,fk_start_date:'',proj_status:'DRAFT'});
  const [showNewClient,setShowNewClient]=useState(false);
  const [nc,setNc]=useState({name:'',industry:'',country:''});
  const [tranches,setTranches]=useState([]);
  const addTranche=()=>setTranches(t=>[...t,{num:t.length+1,amount:'',date:'',status:'PLANNED'}]);
  const removeTranche=(i)=>setTranches(t=>t.filter((_,j)=>j!==i).map((x,j)=>({...x,num:j+1})));
  const updTranche=(i,k,v)=>setTranches(t=>t.map((x,j)=>j===i?{...x,[k]:v}:x));
  const tranchesTotal=tranches.reduce((s,t)=>s+(Number(t.amount)||0),0);
  const _curYear=new Date().getFullYear();
  const upd=(k,v)=>setF(p=>({...p,[k]:v}));
  const submit=e=>{e.preventDefault();if(!f.code||!f.name||!f.client_id)return;const tcv=tranches.length>0&&!Number(f.total_contract_value)?tranchesTotal:(Number(f.total_contract_value)||0);store.addProject({...f,fixed_price:0,total_contract_value:tcv,margin_target_pct:0,tax_rate:Number(f.tax_rate)||0,nd_period_cost:Number(f.nd_period_cost)||0,nd_success_fee:Number(f.nd_success_fee)||0,nd_num_periods:Number(f.nd_num_periods)||4,_force_status:f.proj_status||'DRAFT',_initial_payments:tranches.filter(t=>Number(t.amount)>0).map(t=>{const tYear=t.date?parseInt(t.date.slice(0,4)):_curYear;const isPrior=tYear<_curYear;const pDate=t.date||'';return {tranche_number:t.num,amount:Number(t.amount)||0,planned_date:pDate,status:t.status||'PLANNED',prior_year:isPrior,actual_date:t.status==='PAID'?pDate:'',accrued_date:(t.status==='PAID'||t.status==='ACCRUED')?pDate:''};})});onClose();};
  const createClient=()=>{if(!nc.name)return;const c=store.addClient(nc);upd('client_id',c.id);setShowNewClient(false);setNc({name:'',industry:''});};
  return <Modal onClose={onClose}><h2>Новый проект</h2><form onSubmit={submit}>
    <div className="form-row"><div className="form-group"><label>Код проекта *</label><input value={f.code} onChange={e=>upd('code',e.target.value)} placeholder="AB-2026-01"/></div>
    <div className="form-group"><label>Тип</label><select value={f.project_type} onChange={e=>upd('project_type',e.target.value)}><option value="">— Тип —</option>{(store.data.projectTypes||[]).map(t=><option key={t} value={t}>{t}</option>)}</select></div></div>
    <div className="form-group"><label>Название *</label><input value={f.name} onChange={e=>upd('name',e.target.value)} placeholder="Оптимизация процессов..."/></div>
    <div className="form-group"><label>Клиент *</label>
      <div style={{display:'flex',gap:8}}><select style={{flex:1}} value={f.client_id} onChange={e=>upd('client_id',e.target.value)}><option value="">— Выберите —</option>{store.data.clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select>
      <button type="button" className="btn btn-secondary btn-sm" onClick={()=>setShowNewClient(!showNewClient)}>+ Новый</button></div>
    </div>
    {showNewClient && <div className="card" style={{marginBottom:14}}><div className="form-row"><div className="form-group"><label>Название клиента</label><input value={nc.name} onChange={e=>setNc(p=>({...p,name:e.target.value}))}/></div><div className="form-group"><label>Отрасль</label><input value={nc.industry} onChange={e=>setNc(p=>({...p,industry:e.target.value}))}/></div></div><div className="form-row"><div className="form-group"><label>Страна</label><select value={nc.country} onChange={e=>setNc(p=>({...p,country:e.target.value}))}><option value="">— Страна —</option>{COUNTRIES.map(co=><option key={co} value={co}>{co}</option>)}</select></div><div className="form-group"/></div><button type="button" className="btn btn-success btn-sm" onClick={createClient}>Создать клиента</button></div>}
    <div className="form-row"><div className="form-group"><label>Стоимость контракта (₽)</label><input type="number" value={f.total_contract_value} onChange={e=>upd('total_contract_value',e.target.value)} placeholder={tranchesTotal>0?'Авто из траншей: '+fmt(tranchesTotal):''}/></div><div className="form-group"><label>Налоговый режим</label><div className="tax-select" style={{display:'flex',gap:4}}>{[{v:0,l:'0%'},{v:11,l:'11%'},{v:22,l:'22%'}].map(r=><div key={r.v} className={'tax-btn'+(Number(f.tax_rate)===r.v?' active':'')} onClick={()=>upd('tax_rate',r.v)} style={{cursor:'pointer'}}>{r.l}</div>)}</div></div></div>
    <div className="form-row"><div className="form-group"><label>Дата старта</label><input type="date" value={f.start_date} onChange={e=>upd('start_date',e.target.value)}/></div><div className="form-group"><label>Дата окончания</label><input type="date" value={f.target_end_date} onChange={e=>upd('target_end_date',e.target.value)}/></div><div className="form-group"><label>Дата защиты АТС</label><input type="date" value={f.ats_date||''} onChange={e=>upd('ats_date',e.target.value)}/></div></div>
    <div style={{marginBottom:12,padding:10,background:'var(--bg1)',borderRadius:8,border:'1px solid var(--border)'}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}><span style={{fontSize:12,fontWeight:600}}>Транши</span><button type="button" className="btn btn-primary btn-sm" style={{fontSize:10,padding:'2px 8px'}} onClick={addTranche}>+ Транш</button></div>
      {tranches.length>0&&<table style={{width:'100%',fontSize:12,borderCollapse:'collapse'}}><thead><tr style={{borderBottom:'1px solid var(--border)'}}><th style={{width:36,textAlign:'center',padding:'2px 4px'}}>#</th><th style={{padding:'2px 4px'}}>Сумма (₽)</th><th style={{padding:'2px 4px'}}>Период</th><th style={{padding:'2px 4px'}}>Статус</th><th style={{width:28}}></th></tr></thead><tbody>{tranches.map((t,i)=>{const tYear=t.date?parseInt(t.date.slice(0,4)):_curYear;const isPrior=tYear<_curYear;return <tr key={i} style={isPrior?{background:'rgba(255,193,7,0.08)'}:{}}>
        <td style={{textAlign:'center',color:'var(--text2)',padding:'2px 4px'}}>{t.num}</td>
        <td style={{padding:'2px 4px'}}><input type="number" value={t.amount} onChange={e=>updTranche(i,'amount',e.target.value)} placeholder="500000" style={{width:'100%',fontSize:12}}/></td>
        <td style={{padding:'2px 4px'}}><input type="month" value={t.date} onChange={e=>updTranche(i,'date',e.target.value)} style={{width:'100%',fontSize:12}}/></td>
        <td style={{padding:'2px 4px'}}><select value={t.status||'PLANNED'} onChange={e=>updTranche(i,'status',e.target.value)} style={{fontSize:11,padding:'2px 4px',width:'100%'}}><option value="PLANNED">план</option><option value="ACCRUED">акт</option><option value="PAID">оплачен</option></select></td>
        <td style={{padding:'2px 4px'}}><button type="button" style={{background:'none',border:'none',cursor:'pointer',color:'var(--red)',fontSize:14,lineHeight:1}} onClick={()=>removeTranche(i)}>✕</button></td>
      </tr>;})}</tbody></table>}
      {tranches.length>0&&<div style={{textAlign:'right',fontSize:12,fontWeight:600,marginTop:4,color:'var(--accent)'}}>Итого: {fmt(tranchesTotal)} ₽</div>}
      {tranches.length===0&&<div style={{fontSize:11,color:'var(--text2)',textAlign:'center',padding:4}}>Нет траншей — добавьте при необходимости</div>}
    </div>
    <div className="form-row"><div className="form-group"><label>Рабочая группа</label><select value={f.work_group} onChange={e=>upd('work_group',e.target.value)}><option value="">— РГ —</option><option value="РГ1">РГ1</option><option value="РГ2">РГ2</option></select></div><div className="form-group"><label>Группа продаж</label><select value={f.sales_group} onChange={e=>upd('sales_group',e.target.value)}><option value="">= РГ</option><option value="РГ1">РГ1</option><option value="РГ2">РГ2</option></select></div><div className="form-group"><label>Статус проекта</label><select value={f.proj_status} onChange={e=>upd('proj_status',e.target.value)}><option value="DRAFT">Черновик</option><option value="ACTIVE">Активный</option><option value="ON_HOLD">Приостановлен</option><option value="COMPLETED">Завершён</option></select></div></div>
    <div className="form-group"><label>Заметки</label><textarea value={f.notes} onChange={e=>upd('notes',e.target.value)}/></div>
    {f.project_type==='New Delivery'&&<div className="card" style={{marginTop:8,padding:12,background:'var(--bg1)',border:'1px solid var(--accent2)',borderRadius:8}}>
      <div style={{fontSize:13,fontWeight:600,color:'var(--accent2)',marginBottom:8}}>New Delivery — настройки</div>
      <div className="form-row">
        <div className="form-group"><label>Периодичность оплаты</label>
          <select value={f.nd_payment_period} onChange={e=>{upd('nd_payment_period',e.target.value);const _e=_calcNdEnd(f.nd_period_start,f.nd_num_periods,e.target.value==='quarterly');if(_e)upd('nd_period_end',_e);}}>
            <option value="quarterly">Квартальная</option>
            <option value="monthly">Помесячная</option>
          </select>
        </div>
        <div className="form-group"><label>Стоимость {f.nd_payment_period==='quarterly'?'квартала':'месяца'} (₽)</label>
          <input type="number" value={f.nd_period_cost} onChange={e=>upd('nd_period_cost',e.target.value)} placeholder="550000"/>
        </div>
      </div>
      <div className="form-row">
        <div className="form-group"><label>Кол-во {f.nd_payment_period==='quarterly'?'кварталов':'месяцев'}</label>
          <input type="number" min="1" max="24" value={f.nd_num_periods} onChange={e=>{upd('nd_num_periods',e.target.value);const _e=_calcNdEnd(f.nd_period_start,e.target.value,f.nd_payment_period==='quarterly');if(_e)upd('nd_period_end',_e);}}/>
        </div>
        <div className="form-group"><label>Итого контракт</label>
          <div style={{padding:'6px 0',fontSize:13,fontWeight:600,color:'var(--accent)'}}>{fmt((Number(f.nd_period_cost)||0)*(Number(f.nd_num_periods)||0))} ₽{f.nd_has_success_fee&&Number(f.nd_success_fee)>0?' + SF '+fmt(Number(f.nd_success_fee))+' ₽':''}</div>
        </div>
      </div>
      <div className="form-row">
        <div className="form-group"><label>Начало 1-го {f.nd_payment_period==='quarterly'?'квартала':'месяца'}</label>
          <input type="date" value={f.nd_period_start} onChange={e=>{upd('nd_period_start',e.target.value);const _e=_calcNdEnd(e.target.value,f.nd_num_periods,f.nd_payment_period==='quarterly');if(_e)upd('nd_period_end',_e);}}/>
        </div>
        <div className="form-group"><label>Завершение (авто)</label>
          <input type="date" value={f.nd_period_end} readOnly style={{opacity:.7,cursor:'default'}}/>
        </div>
      </div>
      <div className="form-row">
        <div className="form-group"><label style={{display:'flex',alignItems:'center',gap:6}}><input type="checkbox" checked={f.nd_has_success_fee} onChange={e=>upd('nd_has_success_fee',e.target.checked)}/> Success Fee</label></div>
        {f.nd_has_success_fee&&<div className="form-group"><label>Success Fee (₽)</label><input type="number" value={f.nd_success_fee} onChange={e=>upd('nd_success_fee',e.target.value)}/></div>}
      </div>
      <div style={{fontSize:10,color:'var(--text2)',marginTop:6}}>Success Fee прогнозно приземляется на конец последнего периода. Учитывается только в сверхоптимистичном прогнозе.</div>
    </div>}
    {f.project_type==='ФК'&&<div className="card" style={{marginTop:8,padding:12,background:'var(--bg1)',border:'1px solid var(--violet)',borderRadius:8}}>
      <div style={{fontSize:13,fontWeight:600,color:'var(--violet)',marginBottom:8}}>ФК — абонентские платежи</div>
      <div className="form-row">
        <div className="form-group"><label>Стоимость месяца (₽)</label><input type="number" value={f.fk_monthly_cost} onChange={e=>upd('fk_monthly_cost',e.target.value)} placeholder="100000"/></div>
        <div className="form-group"><label>Кол-во месяцев</label><input type="number" min="1" max="60" value={f.fk_planned_months} onChange={e=>upd('fk_planned_months',e.target.value)}/></div>
      </div>
      <div className="form-row">
        <div className="form-group"><label>Дата начала</label><input type="date" value={f.fk_start_date} onChange={e=>upd('fk_start_date',e.target.value)}/></div>
        <div className="form-group"><label>Итого контракт</label><div style={{padding:'6px 0',fontSize:13,fontWeight:600,color:'var(--violet)'}}>{fmt((Number(f.fk_monthly_cost)||0)*(Number(f.fk_planned_months)||0))} ₽</div></div>
      </div>
    </div>}
    <div className="form-actions"><button type="button" className="btn btn-secondary" onClick={onClose}>Отмена</button><button type="submit" className="btn btn-primary">Создать проект</button></div>
  </form></Modal>;
}

function AddPersonModal({onClose,store}){
  const [f,setF]=useState({name:'',email:'',position:'',grade:'',department:'',departments:[],work_group:'',intern_start_date:'',intern_stipend:15000,intern_extended:false,manager_id:'',salary_monthly:'',hire_date:'',fire_date:'',total_salary_earned:'',total_bonus_paid:''});
  const upd=(k,v)=>setF(o=>({...o,[k]:v}));
  const submit=e=>{e.preventDefault();if(!f.name)return;store.addPerson({...f,salary_monthly:Number(f.salary_monthly)||0,total_salary_earned:Number(f.total_salary_earned)||0,total_bonus_paid:Number(f.total_bonus_paid)||0,paei:{p:0,a:0,e:0,i:0},competencies:{},bpm_expertise:{}});onClose();};
  return <Modal onClose={onClose}><h2>Новый сотрудник</h2><form onSubmit={submit}>
    <div className="form-row"><div className="form-group"><label>ФИО *</label><input value={f.name} onChange={e=>upd('name',e.target.value)}/></div><div className="form-group"><label>Email</label><input value={f.email} onChange={e=>upd('email',e.target.value)}/></div></div>
    <div className="form-row"><div className="form-group"><label>Должность</label><input value={f.position} onChange={e=>upd('position',e.target.value)}/></div><div className="form-group"><label>Грейд</label><select value={f.grade} onChange={e=>upd('grade',e.target.value)}><option value="">--</option><option value="C1">C1</option><option value="C2">C2</option><option value="C3">C3</option><option value="C4">C4</option><option value="C5">C5</option><option value="Стажёр">Стажёр</option><option value="Admin">Администратор</option></select></div></div>
    {f.grade==='Стажёр'&&<div style={{background:'var(--bg1)',padding:10,borderRadius:8,marginBottom:8}}><div style={{fontSize:12,fontWeight:600,marginBottom:6}}>Стажировка</div><div className="form-row"><div className="form-group"><label>Начало стажировки</label><input type="date" value={f.intern_start_date} onChange={e=>upd('intern_start_date',e.target.value)}/></div><div className="form-group"><label>Стипендия (₽/2нед)</label><input type="number" value={f.intern_stipend} onChange={e=>upd('intern_stipend',e.target.value)}/></div></div><div className="form-row"><div className="form-group"><label style={{display:'flex',alignItems:'center',gap:6,cursor:'pointer'}}><input type="checkbox" checked={f.intern_extended||false} onChange={e=>upd('intern_extended',e.target.checked)}/> Стажировка продлена</label></div><div className="form-group"/></div></div>}
    <div className="form-row"><div className="form-group"><label>Отдел</label><select value={f.department} onChange={e=>{upd('department',e.target.value);upd('departments',e.target.value?[e.target.value]:[]);if(e.target.value!=='Производство')upd('work_group','');}}><option value="">-- Отдел --</option>{['Стратегия','HR','Продажи и Маркетинг','Финансы','Производство','Качество','Инновационные проекты'].map(d=><option key={d} value={d}>{d}</option>)}</select></div><div className="form-group"><label>Руководитель</label><select value={f.manager_id} onChange={e=>upd('manager_id',e.target.value)}><option value="">-- Нет --</option>{store.data.persons.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select></div></div>
    {f.department==='Производство'&&<div className="form-row"><div className="form-group"><label>Рабочая группа</label><select value={f.work_group} onChange={e=>upd('work_group',e.target.value)}><option value="">--</option><option value="РГ1">РГ1</option><option value="РГ2">РГ2</option></select></div><div className="form-group"/></div>}
    <div className="form-row"><div className="form-group"><label>ЗП (мес. ₽)</label><input type="number" value={f.salary_monthly} onChange={e=>upd('salary_monthly',e.target.value)}/></div><div className="form-group"><label>Дата приёма</label><input type="date" value={f.hire_date} onChange={e=>upd('hire_date',e.target.value)}/></div></div>
    <div className="form-row"><div className="form-group"><label>Совокупный фикс (₽)</label><input type="number" value={f.total_salary_earned} onChange={e=>upd('total_salary_earned',e.target.value)}/></div><div className="form-group"><label>Совокупная премия (₽)</label><input type="number" value={f.total_bonus_paid} onChange={e=>upd('total_bonus_paid',e.target.value)}/></div></div>
    <div className="form-actions"><button type="button" className="btn btn-secondary" onClick={onClose}>Отмена</button><button type="submit" className="btn btn-primary">Добавить</button></div>
  </form></Modal>;
}

/* ===== EDIT MODALS ===== */
function EditProjectModal({project:p,store,onClose}){
  const [f,setF]=useState({name:p.name,code:p.code,project_type:p.project_type||'',work_group:p.work_group||p._work_group||'',sales_group:p.sales_group||'',total_contract_value:p.project_type==='New Delivery'?(Number(p.nd_period_cost)||0)*(Number(p.nd_num_periods)||0):(p.total_contract_value||''),tax_rate:p.tax_rate||0,start_date:p.start_date||'',target_end_date:p.target_end_date||'',notes:p.notes||'',status:p.status,client_id:p.client_id,nd_payment_period:p.nd_payment_period||'quarterly',nd_period_cost:p.nd_period_cost||'',nd_period_start:p.nd_period_start||'',nd_period_end:p.nd_period_end||'',nd_has_success_fee:!!p.nd_has_success_fee,nd_success_fee:p.nd_success_fee||'',nd_num_periods:p.nd_num_periods||4,fk_monthly_cost:p.fk_monthly_cost||'',fk_planned_months:p.fk_planned_months||12,fk_start_date:p.fk_start_date||''});
  const upd=(k,v)=>setF(o=>({...o,[k]:v}));
  const [newTranches,setNewTranches]=useState([]);
  const existingMax=Math.max(0,...(p.payments||[]).map(pm=>pm.tranche_number||0));
  const addTr=()=>setNewTranches(t=>[...t,{num:existingMax+t.length+1,amount:'',date:'',status:'PLANNED'}]);
  const rmTr=(i)=>setNewTranches(t=>t.filter((_,j)=>j!==i));
  const updTr=(i,k,v)=>setNewTranches(t=>t.map((x,j)=>j===i?{...x,[k]:v}:x));
  const newTrTotal=newTranches.reduce((s,t)=>s+(Number(t.amount)||0),0);
  const _curYearE=new Date().getFullYear();
  const submit=e=>{e.preventDefault();const cl=store.data.clients.find(c=>c.id===f.client_id);store.updateProject(p.id,{...f,total_contract_value:f.project_type==='New Delivery'?(Number(f.nd_period_cost)||0)*(Number(f.nd_num_periods)||0):(Number(f.total_contract_value)||0),tax_rate:Number(f.tax_rate)||0,fixed_price:0,margin_target_pct:0,nd_period_cost:Number(f.nd_period_cost)||0,nd_success_fee:Number(f.nd_success_fee)||0,nd_num_periods:Number(f.nd_num_periods)||0,fk_monthly_cost:Number(f.fk_monthly_cost)||0,fk_planned_months:Number(f.fk_planned_months)||0,fk_start_date:f.fk_start_date||'',client_name:cl?.name||p.client_name,client_industry:cl?.industry||p.client_industry});newTranches.filter(t=>Number(t.amount)>0).forEach(t=>{const tY=t.date?parseInt(t.date.slice(0,4)):_curYearE;const isPr=tY<_curYearE;const pD=t.date||'';store.addPayment(p.id,{tranche_number:t.num,amount:Number(t.amount)||0,planned_date:pD,actual_date:t.status==='PAID'?pD:'',accrued_date:(t.status==='PAID'||t.status==='ACCRUED')?pD:'',status:t.status||'PLANNED',description:'Транш '+t.num,prior_year:isPr,payment_type:'PLANNED',expected_week_monday:''});});onClose();};
  return <Modal onClose={onClose}><h2>Редактировать проект</h2><form onSubmit={submit}>
    <div className="form-row"><div className="form-group"><label>Код</label><input value={f.code} onChange={e=>upd('code',e.target.value)}/></div>
    <div className="form-group"><label>Статус</label><select value={f.status} onChange={e=>upd('status',e.target.value)}><option value="DRAFT">Черновик</option><option value="ACTIVE">Активный</option><option value="ON_HOLD">Приостановлен</option><option value="PAUSED">Пауза</option><option value="COMPLETED">Завершён</option></select></div></div>
    <div className="form-group"><label>Название</label><input value={f.name} onChange={e=>upd('name',e.target.value)}/></div>
    <div className="form-group"><label>Клиент</label><select value={f.client_id} onChange={e=>upd('client_id',e.target.value)}>{store.data.clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
    <div className="form-row"><div className="form-group"><label>Тип</label><select value={f.project_type} onChange={e=>upd('project_type',e.target.value)}><option value="">— Тип —</option>{(store.data.projectTypes||[]).map(t=><option key={t} value={t}>{t}</option>)}</select></div>
    <div className="form-group"><label>Рабочая группа</label><select value={f.work_group} onChange={e=>upd('work_group',e.target.value)}><option value="">— РГ —</option><option value="РГ1">РГ1</option><option value="РГ2">РГ2</option></select></div><div className="form-group"><label>Группа продаж</label><select value={f.sales_group} onChange={e=>upd('sales_group',e.target.value)}><option value="">= РГ</option><option value="РГ1">РГ1</option><option value="РГ2">РГ2</option></select></div></div>
    <div className="form-row"><div className="form-group"><label>Стоимость контракта (₽)</label><input type="number" value={f.total_contract_value} onChange={e=>upd('total_contract_value',e.target.value)}/></div><div className="form-group"><label>Налоговый режим</label><div className="tax-select" style={{display:'flex',gap:4}}>{[{v:0,l:'0%'},{v:11,l:'11%'},{v:22,l:'22%'}].map(r=><div key={r.v} className={'tax-btn'+(Number(f.tax_rate)===r.v?' active':'')} onClick={()=>upd('tax_rate',r.v)} style={{cursor:'pointer'}}>{r.l}</div>)}</div></div></div>
    <div className="form-row"><div className="form-group"><label>Дата старта</label><input type="date" value={f.start_date} onChange={e=>upd('start_date',e.target.value)}/></div>
    <div className="form-group"><label>Дата окончания</label><input type="date" value={f.target_end_date} onChange={e=>upd('target_end_date',e.target.value)}/></div></div>
    <div className="form-group"><label>Заметки</label><textarea rows={3} value={f.notes} onChange={e=>upd('notes',e.target.value)}/></div>
    {f.project_type==='New Delivery'&&<div className="card" style={{marginTop:8,padding:12,background:'var(--bg1)',border:'1px solid var(--accent2)',borderRadius:8}}>
      <div style={{fontSize:13,fontWeight:600,color:'var(--accent2)',marginBottom:8}}>New Delivery — настройки</div>
      <div className="form-row">
        <div className="form-group"><label>Периодичность</label>
          <select value={f.nd_payment_period} onChange={e=>{upd('nd_payment_period',e.target.value);const _e=_calcNdEnd(f.nd_period_start,f.nd_num_periods,e.target.value==='quarterly');if(_e)upd('nd_period_end',_e);}}>
            <option value="quarterly">Квартальная</option><option value="monthly">Помесячная</option>
          </select></div>
        <div className="form-group"><label>Стоимость {f.nd_payment_period==='quarterly'?'квартала':'месяца'} (₽)</label>
          <input type="number" value={f.nd_period_cost} onChange={e=>upd('nd_period_cost',e.target.value)}/>
        </div>
      </div>
      <div className="form-row">
        <div className="form-group"><label>Кол-во {f.nd_payment_period==='quarterly'?'кварталов':'месяцев'}</label>
          <input type="number" min="1" max="24" value={f.nd_num_periods} onChange={e=>{upd('nd_num_periods',e.target.value);const _e=_calcNdEnd(f.nd_period_start,e.target.value,f.nd_payment_period==='quarterly');if(_e)upd('nd_period_end',_e);}}/>
        </div>
        <div className="form-group"><label>Итого</label>
          <div style={{padding:'6px 0',fontSize:13,fontWeight:600,color:'var(--accent)'}}>{fmt((Number(f.nd_period_cost)||0)*(Number(f.nd_num_periods)||0))} ₽{f.nd_has_success_fee&&Number(f.nd_success_fee)>0?' + SF '+fmt(Number(f.nd_success_fee))+' ₽':''}</div>
        </div>
      </div>
      <div className="form-row">
        <div className="form-group"><label>Начало 1-го периода</label><input type="date" value={f.nd_period_start} onChange={e=>{upd('nd_period_start',e.target.value);const _e=_calcNdEnd(e.target.value,f.nd_num_periods,f.nd_payment_period==='quarterly');if(_e)upd('nd_period_end',_e);}}/></div>
        <div className="form-group"><label>Завершение (авто)</label><input type="date" value={f.nd_period_end} readOnly style={{opacity:.7,cursor:'default'}}/></div>
      </div>
      <div className="form-row">
        <div className="form-group"><label style={{display:'flex',alignItems:'center',gap:6}}><input type="checkbox" checked={f.nd_has_success_fee} onChange={e=>upd('nd_has_success_fee',e.target.checked)}/> Success Fee</label></div>
        {f.nd_has_success_fee&&<div className="form-group"><label>Success Fee (₽)</label><input type="number" value={f.nd_success_fee} onChange={e=>upd('nd_success_fee',e.target.value)}/></div>}
      </div>
      <div style={{fontSize:10,color:'var(--text2)',marginTop:6}}>Success Fee учитывается только в сверхоптимистичном прогнозе.</div>
    </div>}
    {f.project_type==='ФК'&&<div className="card" style={{marginTop:8,padding:12,background:'var(--bg1)',border:'1px solid var(--violet)',borderRadius:8}}>
      <div style={{fontSize:13,fontWeight:600,color:'var(--violet)',marginBottom:8}}>ФК — абонентские платежи</div>
      <div className="form-row">
        <div className="form-group"><label>Стоимость месяца (₽)</label><input type="number" value={f.fk_monthly_cost} onChange={e=>upd('fk_monthly_cost',e.target.value)} placeholder="100000"/></div>
        <div className="form-group"><label>Кол-во месяцев</label><input type="number" min="1" max="60" value={f.fk_planned_months} onChange={e=>upd('fk_planned_months',e.target.value)}/></div>
      </div>
      <div className="form-row">
        <div className="form-group"><label>Дата начала</label><input type="date" value={f.fk_start_date} onChange={e=>upd('fk_start_date',e.target.value)}/></div>
        <div className="form-group"><label>Итого</label><div style={{padding:'6px 0',fontSize:13,fontWeight:600,color:'var(--violet)'}}>{fmt((Number(f.fk_monthly_cost)||0)*(Number(f.fk_planned_months)||0))} ₽</div></div>
      </div>
    </div>}
    {f.project_type!=='New Delivery'&&f.project_type!=='ФК'&&<div style={{marginTop:10,padding:12,background:'var(--bg1)',borderRadius:8,border:'1px solid var(--border)'}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
        <span style={{fontSize:13,fontWeight:600}}>Транши</span>
        <span style={{fontSize:11,color:'var(--text2)'}}>Существующих: {(p.payments||[]).length} · на сумму {fmt((p.payments||[]).reduce((s,pm)=>s+(Number(pm.amount)||0),0))} ₽</span>
      </div>
      {(p.payments||[]).length>0&&<table style={{fontSize:11,marginBottom:8}}><thead><tr><th>#</th><th>Сумма</th><th>Период</th><th>Статус</th></tr></thead><tbody>{(p.payments||[]).slice(0,10).map(pm=><tr key={pm.id}><td>{pm.tranche_number}</td><td style={{fontWeight:600}}>{fmt(pm.amount)} ₽</td><td style={{color:'var(--text2)'}}>{pm.planned_date||'—'}</td><td>{SB(pm.status)}</td></tr>)}{(p.payments||[]).length>10&&<tr><td colSpan={4} style={{textAlign:'center',color:'var(--text2)',fontSize:10}}>...и ещё {(p.payments||[]).length-10}</td></tr>}</tbody></table>}
      {newTranches.length>0&&<div style={{marginBottom:8}}>
        <div style={{fontSize:11,fontWeight:600,color:'var(--accent)',marginBottom:4}}>Новые транши:</div>
        <table style={{fontSize:11}}><thead><tr><th>#</th><th>Сумма (₽)</th><th>Период</th><th>Статус</th><th></th></tr></thead><tbody>{newTranches.map((t,i)=>{const tY=t.date?parseInt(t.date.slice(0,4)):_curYearE;return <tr key={i} style={tY<_curYearE?{background:'rgba(255,193,7,0.08)'}:{}}><td style={{fontWeight:600}}>{t.num}</td><td><input type="number" value={t.amount} onChange={e=>updTr(i,'amount',e.target.value)} style={{width:100,fontSize:11,padding:'2px 6px'}} placeholder="0"/></td><td><input type="month" value={t.date} onChange={e=>updTr(i,'date',e.target.value)} style={{fontSize:11,padding:'2px 6px'}}/></td><td><select value={t.status||'PLANNED'} onChange={e=>updTr(i,'status',e.target.value)} style={{fontSize:10,padding:'2px 4px'}}><option value="PLANNED">план</option><option value="ACCRUED">акт</option><option value="PAID">оплачен</option></select></td><td><span style={{color:'var(--red)',cursor:'pointer',fontSize:14}} onClick={()=>rmTr(i)}>✕</span></td></tr>;})}</tbody></table>
        <div style={{fontSize:11,marginTop:4,color:'var(--text2)'}}>Итого новых: <strong>{fmt(newTrTotal)} ₽</strong></div>
      </div>}
      <button type="button" className="btn btn-secondary btn-sm" style={{fontSize:11}} onClick={addTr}>+ Добавить транш</button>
    </div>}
    <div className="form-actions"><button type="button" className="btn btn-secondary" onClick={onClose}>Отмена</button><button type="button" className="btn btn-danger" style={{marginRight:'auto'}} onClick={()=>{if(confirm('Удалить проект '+p.code+'?')){store.deleteProject(p.id);onClose();}}}>Удалить</button><button type="submit" className="btn btn-primary">Сохранить</button></div>
  </form></Modal>;
}

function EditPersonModal({person:pe,store,onClose}){
  const [tab,setTab]=useState('info');
  const [f,setF]=useState({name:pe.name,email:pe.email||'',position:pe.position||'',grade:pe.grade||'',salary_monthly:pe.salary_monthly||'',hire_date:pe.hire_date||'',fire_date:pe.fire_date||'',is_investment_employee:pe.is_investment_employee||false,intern_start_date:pe.intern_start_date||'',intern_stipend:pe.intern_stipend||15000,intern_extended:pe.intern_extended||false,intern_converted_date:pe.intern_converted_date||'',total_salary_earned:pe.total_salary_earned||'',total_bonus_paid:pe.total_bonus_paid||'',hr_section:pe.hr_section||'',sales_section:pe.sales_section||'',department:pe.department||'',work_group:pe.work_group||pe._work_group||'',departments:pe.departments||(pe.department?[pe.department]:[])});
  const [paei,setPaei]=useState({p:(pe.paei||{}).p||0,a:(pe.paei||{}).a||0,e:(pe.paei||{}).e||0,i:(pe.paei||{}).i||0});
  const [comp,setComp]=useState({...(pe.competencies||{})});
  const [bpmExp,setBpmExp]=useState({...(pe.bpm_expertise||{})});
  const [promo,setPromo]=useState(null);
  const upd=(k,v)=>setF(o=>({...o,[k]:v}));
  const submit=()=>{if(!f.name)return;let sh=[...(pe.salary_history||[])];let fSal=Number(f.salary_monthly)||0;if(promo&&promo.newSalary&&promo.effectiveDate){if(sh.length===0)sh.push({amount:Number(pe.salary_monthly)||0,effective_date:pe.hire_date||'2020-01-01',grade:pe.grade||''});sh.push({amount:Number(promo.newSalary),effective_date:promo.effectiveDate,grade:f.grade||''});fSal=Number(promo.newSalary);}store.updatePerson(pe.id,{...f,departments:f.departments||[],department:(f.departments||[])[0]||'',salary_monthly:fSal,salary_history:sh,total_salary_earned:Number(f.total_salary_earned)||0,total_bonus_paid:Number(f.total_bonus_paid)||0,is_active:f.fire_date?0:1,is_investment_employee:!!f.is_investment_employee,paei,competencies:comp,bpm_expertise:bpmExp});onClose();};
  const pCode=PAEI_AXES.map(ax=>{const v=paei[ax.key]||0;return v>=6?ax.label.toUpperCase():v>=3?ax.label.toLowerCase():'-';}).join('');
  return <Modal onClose={onClose}><h2 style={{marginBottom:4}}>{pe.name}</h2>
    <div className="person-detail-tabs">
      {[['info','Основное'],['career','Карьера'],['paei','PAEI'],['comp','Компетенции'],['bpm','BPM-экспертиза']].map(([k,l])=><button key={k} className={tab===k?'active':''} onClick={()=>setTab(k)}>{l}</button>)}
    </div>
    {tab==='info'&&<div>
    <div className="form-row"><div className="form-group"><label>ФИО *</label><input value={f.name} onChange={e=>upd('name',e.target.value)}/></div>
    <div className="form-group"><label>Email</label><input value={f.email} onChange={e=>upd('email',e.target.value)}/></div></div>
    <div className="form-row"><div className="form-group"><label>Должность</label><input value={f.position} onChange={e=>upd('position',e.target.value)}/></div>
    <div className="form-group"><label>Грейд</label><select value={f.grade} onChange={e=>{upd('grade',e.target.value);if(e.target.value&&pe.grade&&e.target.value!==pe.grade&&e.target.value!=='Стажёр')setPromo({newSalary:f.salary_monthly||'',effectiveDate:new Date().toISOString().slice(0,10)});else setPromo(null);}}><option value="">--</option><option value="C1">C1</option><option value="C2">C2</option><option value="C3">C3</option><option value="C4">C4</option><option value="C5">C5</option><option value="Стажёр">Стажёр</option></select></div></div>
    {f.grade==='Стажёр'&&<div style={{background:'var(--bg1)',padding:10,borderRadius:8,marginBottom:8}}><div style={{fontSize:12,fontWeight:600,marginBottom:6}}>Стажировка</div><div className="form-row"><div className="form-group"><label>Начало стажировки</label><input type="date" value={f.intern_start_date} onChange={e=>upd('intern_start_date',e.target.value)}/></div><div className="form-group"><label>Стипендия (₽/2нед)</label><input type="number" value={f.intern_stipend} onChange={e=>upd('intern_stipend',e.target.value)}/></div></div><div className="form-row"><div className="form-group"><label style={{display:'flex',alignItems:'center',gap:6,cursor:'pointer'}}><input type="checkbox" checked={f.intern_extended||false} onChange={e=>upd('intern_extended',e.target.checked)}/> Стажировка продлена</label></div><div className="form-group" style={{display:'flex',alignItems:'flex-end'}}><button type="button" className="btn btn-success btn-sm" onClick={()=>{const d=new Date().toISOString().slice(0,10);upd('grade','C1');upd('salary_monthly',50000);upd('hire_date',d);upd('intern_converted_date',d);}}>Перевести в C1 (50 000 ₽)</button></div></div></div>}
    {f.intern_converted_date&&f.grade!=='Стажёр'&&<div style={{fontSize:11,color:'var(--emerald)',marginBottom:6,padding:'4px 8px',background:'rgba(34,197,94,.1)',borderRadius:6}}>Переведён из стажировки: {f.intern_converted_date}</div>}
    {promo&&<div className="card" style={{marginBottom:8,padding:10,background:'var(--bg1)',border:'1px solid var(--accent)',borderRadius:8}}><div style={{fontSize:12,fontWeight:600,color:'var(--accent)',marginBottom:6}}>📈 Промоушен: {pe.grade} → {f.grade}</div><div className="form-row"><div className="form-group"><label>Новая ЗП (₽/мес)</label><input type="number" value={promo.newSalary} onChange={e=>setPromo(prev=>({...prev,newSalary:e.target.value}))}/></div><div className="form-group"><label>Дата начала</label><input type="date" value={promo.effectiveDate} onChange={e=>setPromo(prev=>({...prev,effectiveDate:e.target.value}))}/></div></div><div style={{fontSize:10,color:'var(--text2)'}}>ЗП будет пересчитана пропорционально дням месяца повышения</div></div>}
    <div className="form-row"><div className="form-group"><label>ЗП (мес. ₽)</label><input type="number" value={f.salary_monthly} onChange={e=>upd('salary_monthly',e.target.value)}/></div>
    <div className="form-group"><label>Отделы</label>
    <div style={{display:'flex',flexWrap:'wrap',gap:4}}>{ORG_DEPTS.map(d=>{const ck=(f.departments||[]).includes(d.key);return <label key={d.key} style={{display:'flex',alignItems:'center',gap:3,fontSize:10,cursor:'pointer',padding:'2px 6px',background:ck?d.color+'22':'var(--bg1)',border:'1px solid '+(ck?d.color:'var(--border)'),borderRadius:4}}>
      <input type="checkbox" style={{width:12,height:12}} checked={ck} onChange={e=>{const cur=f.departments||[];const next=e.target.checked?[...cur,d.key]:cur.filter(x=>x!==d.key);upd('departments',next);upd('department',next[0]||'');if(!next.includes('HR'))upd('hr_section','');if(!next.includes('Продажи и Маркетинг'))upd('sales_section','');if(!next.includes('Производство'))upd('work_group','');}}/>
      {d.icon} {d.key}</label>;})}
    </div></div></div>
    {(f.departments||[]).includes('HR')&&<div className="form-row"><div className="form-group"><label>HR-секция</label><select value={f.hr_section} onChange={e=>upd('hr_section',e.target.value)}><option value="">--</option>{HR_SECTIONS.map(s=><option key={s.key} value={s.key}>{s.key}</option>)}</select></div><div className="form-group"/></div>}
    {(f.departments||[]).includes('Продажи и Маркетинг')&&<div className="form-row"><div className="form-group"><label>ПиМ-секция</label><select value={f.sales_section} onChange={e=>upd('sales_section',e.target.value)}><option value="">--</option>{SALES_SECTIONS.map(s=><option key={s.key} value={s.key}>{s.key}</option>)}</select></div><div className="form-group"/></div>}
    {(f.departments||[]).includes('Производство')&&<div className="form-row"><div className="form-group"><label>Рабочая группа</label><select value={f.work_group} onChange={e=>upd('work_group',e.target.value)}><option value="">--</option><option value="РГ1">РГ1</option><option value="РГ2">РГ2</option></select></div><div className="form-group"/></div>}
    <div className="form-row"><div className="form-group"><label>Дата приёма</label><input type="date" value={f.hire_date} onChange={e=>upd('hire_date',e.target.value)}/></div>
    <div className="form-group"><label>Дата увольнения</label><input type="date" value={f.fire_date} onChange={e=>upd('fire_date',e.target.value)}/></div></div>
    <div className="form-row"><div className="form-group" style={{display:'flex',alignItems:'center',gap:8}}><label style={{margin:0}}>Инвестиционный сотрудник</label><input type="checkbox" checked={!!f.is_investment_employee} onChange={e=>upd('is_investment_employee',e.target.checked)} style={{width:18,height:18}}/></div><div className="form-group"/></div>
    <div className="form-row"><div className="form-group"><label>Совокупный фикс (₽)</label><input type="number" value={f.total_salary_earned} onChange={e=>upd('total_salary_earned',e.target.value)}/></div>
    <div className="form-group"><label>Совокупная премия (₽)</label><input type="number" value={f.total_bonus_paid} onChange={e=>upd('total_bonus_paid',e.target.value)}/></div></div>
    </div>}
    {tab==='career'&&<div>
      <div style={{fontSize:13,fontWeight:600,marginBottom:8}}>Карьерная история</div>
      {/* salary_history display */}
      {(()=>{
        const sh=(pe.salary_history||[]).slice().sort((a,b)=>(b.effective_date||'').localeCompare(a.effective_date||''));
        const ce=(pe.career_events||[]).slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
        const EVENT_TYPES=[{key:'hire',label:'Приём',icon:'🟢'},{key:'promotion',label:'Повышение',icon:'📈'},{key:'demotion',label:'Понижение',icon:'📉'},{key:'transfer',label:'Перевод',icon:'🔄'},{key:'temp_role',label:'Врем. совмещение',icon:'⏱️'},{key:'salary_change',label:'Изменение ЗП',icon:'💰'},{key:'leave',label:'Отпуск/декрет',icon:'🏖️'},{key:'fire',label:'Увольнение',icon:'🔴'}];
        const [newEvt,setNewEvt]=React.useState({type:'promotion',date:new Date().toISOString().slice(0,10),note:'',new_salary:'',new_grade:'',new_dept:'',new_position:''});
        const addEvent=()=>{
          const evt={id:uuid(),type:newEvt.type,date:newEvt.date,note:newEvt.note,new_salary:newEvt.new_salary?Number(newEvt.new_salary):null,new_grade:newEvt.new_grade||null,new_dept:newEvt.new_dept||null,new_position:newEvt.new_position||null};
          const upCe=[...(pe.career_events||[]),evt];
          const upd={career_events:upCe};
          /* auto-update salary_history if new salary provided */
          if(evt.new_salary&&evt.date){
            const curSh=[...(pe.salary_history||[])];
            if(curSh.length===0)curSh.push({amount:Number(pe.salary_monthly)||0,effective_date:pe.hire_date||'2020-01-01',grade:pe.grade||''});
            curSh.push({amount:evt.new_salary,effective_date:evt.date,grade:evt.new_grade||f.grade||''});
            upd.salary_history=curSh;upd.salary_monthly=evt.new_salary;
          }
          if(evt.new_grade)upd.grade=evt.new_grade;
          if(evt.new_position)upd.position=evt.new_position;
          if(evt.new_dept){const cur=f.departments||[];if(!cur.includes(evt.new_dept))upd.departments=[...cur,evt.new_dept];}
          if(evt.type==='fire'&&evt.date)upd.fire_date=evt.date;
          store.updatePerson(pe.id,upd);
          setNewEvt({type:'promotion',date:new Date().toISOString().slice(0,10),note:'',new_salary:'',new_grade:'',new_dept:'',new_position:''});
        };
        const delEvent=(eid)=>{if(!confirm('Удалить событие?'))return;store.updatePerson(pe.id,{career_events:(pe.career_events||[]).filter(e=>e.id!==eid)});};
        return <div>
          {/* Timeline */}
          <div style={{maxHeight:250,overflowY:'auto',marginBottom:12}}>
          {ce.length===0&&sh.length===0&&<div style={{color:'var(--text2)',fontSize:12,padding:8}}>Нет записей. Добавьте первое карьерное событие ниже.</div>}
          {ce.length>0&&<table style={{width:'100%',fontSize:11,borderCollapse:'collapse',marginBottom:8}}>
            <thead><tr style={{borderBottom:'1px solid var(--border)',background:'var(--bg3)'}}>
              <th style={{textAlign:'left',padding:'3px 6px'}}>Дата</th>
              <th style={{textAlign:'left',padding:'3px 6px'}}>Тип</th>
              <th style={{textAlign:'left',padding:'3px 6px'}}>Описание</th>
              <th style={{textAlign:'right',padding:'3px 6px'}}>Новая ЗП</th>
              <th style={{textAlign:'left',padding:'3px 6px'}}>Грейд</th>
              <th style={{width:30}}></th>
            </tr></thead>
            <tbody>{ce.map(ev=>{const et=EVENT_TYPES.find(t=>t.key===ev.type);return <tr key={ev.id} style={{borderBottom:'1px solid var(--bg3)'}}>
              <td style={{padding:'3px 6px',whiteSpace:'nowrap'}}>{ev.date}</td>
              <td style={{padding:'3px 6px'}}>{et?et.icon+' '+et.label:ev.type}</td>
              <td style={{padding:'3px 6px',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis'}}>{ev.note||''}{ev.new_position?' → '+ev.new_position:''}{ev.new_dept?' ('+ev.new_dept+')':''}</td>
              <td style={{textAlign:'right',padding:'3px 6px'}}>{ev.new_salary?fmt(ev.new_salary):'-'}</td>
              <td style={{padding:'3px 6px'}}>{ev.new_grade||'-'}</td>
              <td><button style={{fontSize:10,background:'none',border:'none',color:'var(--red)',cursor:'pointer'}} onClick={()=>delEvent(ev.id)}>✕</button></td>
            </tr>})}</tbody>
          </table>}
          {sh.length>0&&<div style={{marginBottom:8}}>
            <div style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginBottom:4}}>История ЗП (salary_history)</div>
            <div style={{display:'flex',flexWrap:'wrap',gap:6}}>{sh.map((h,i)=><div key={i} style={{fontSize:10,padding:'3px 8px',background:'var(--bg1)',border:'1px solid var(--border)',borderRadius:4}}>
              <span style={{fontWeight:600}}>{fmt(h.amount)}</span> <span style={{color:'var(--text2)'}}>с {h.effective_date}</span>{h.grade&&<span style={{color:'var(--accent)',marginLeft:4}}>{h.grade}</span>}
            </div>)}</div>
          </div>}
          </div>
          {/* Add event form */}
          <div style={{background:'var(--bg1)',padding:10,borderRadius:8,border:'1px solid var(--border)'}}>
            <div style={{fontSize:12,fontWeight:600,marginBottom:6}}>+ Новое карьерное событие</div>
            <div className="form-row">
              <div className="form-group"><label>Тип</label><select value={newEvt.type} onChange={e=>setNewEvt(p=>({...p,type:e.target.value}))}>{EVENT_TYPES.map(t=><option key={t.key} value={t.key}>{t.icon} {t.label}</option>)}</select></div>
              <div className="form-group"><label>Дата</label><input type="date" value={newEvt.date} onChange={e=>setNewEvt(p=>({...p,date:e.target.value}))}/></div>
            </div>
            <div className="form-row">
              <div className="form-group"><label>Новая ЗП (₽/мес)</label><input type="number" value={newEvt.new_salary} onChange={e=>setNewEvt(p=>({...p,new_salary:e.target.value}))} placeholder="оставить пустым если без изменений"/></div>
              <div className="form-group"><label>Новый грейд</label><select value={newEvt.new_grade} onChange={e=>setNewEvt(p=>({...p,new_grade:e.target.value}))}><option value="">без изменений</option><option value="C1">C1</option><option value="C2">C2</option><option value="C3">C3</option><option value="C4">C4</option><option value="C5">C5</option></select></div>
            </div>
            <div className="form-row">
              <div className="form-group"><label>Новая должность</label><input value={newEvt.new_position} onChange={e=>setNewEvt(p=>({...p,new_position:e.target.value}))} placeholder="оставить пустым если без изменений"/></div>
              <div className="form-group"><label>Новый отдел</label><select value={newEvt.new_dept} onChange={e=>setNewEvt(p=>({...p,new_dept:e.target.value}))}><option value="">без изменений</option>{ORG_DEPTS.map(d=><option key={d.key} value={d.key}>{d.key}</option>)}</select></div>
            </div>
            <div className="form-group" style={{marginBottom:6}}><label>Комментарий</label><input value={newEvt.note} onChange={e=>setNewEvt(p=>({...p,note:e.target.value}))} placeholder="Причина, контекст"/></div>
            <button className="btn btn-primary btn-sm" onClick={addEvent}>Добавить событие</button>
          </div>
        </div>;
      })()}
    </div>}
    {tab==='paei'&&<div>
    <div style={{textAlign:'center',marginBottom:12}}><span style={{fontSize:28,fontWeight:700,letterSpacing:2}}>{pCode}</span><div style={{fontSize:11,color:'var(--text2)',marginTop:2}}>Код по Адизесу</div></div>
    <div className="paei-edit">
      {PAEI_AXES.map(ax=><div key={ax.key} className="pe-axis">
        <label style={{color:ax.color}}>{ax.label} — {ax.name}</label>
        <div className="pe-val" style={{color:ax.color}}>{paei[ax.key]}</div>
        <input type="range" min="0" max="10" value={paei[ax.key]} onChange={e=>setPaei(p=>({...p,[ax.key]:Number(e.target.value)}))}/>
      </div>)}
    </div>
    <div style={{marginTop:12,padding:10,background:'var(--bg1)',borderRadius:8,fontSize:11,color:'var(--text2)'}}>
      <strong>Расшифровка:</strong> Заглавная (6+) = сильная ось, строчная (3-5) = средняя, прочерк (&lt;3) = слабая
    </div>
    </div>}
    {tab==='comp'&&<div>
    <div style={{fontSize:11,color:'var(--text2)',marginBottom:8}}>Оцените уровень (1—7) по каждой компетенции. Нажмите на кружок для установки/сброса.</div>
    <div style={{display:'grid',gridTemplateColumns:'auto repeat(7,1fr)',gap:'4px 2px',alignItems:'center',fontSize:10,marginBottom:6}}>
      <div/>
      {COMP_LEVELS.map((l,i)=><div key={i} style={{textAlign:'center',color:'var(--text2)',fontWeight:500}}>{i+1}</div>)}
    </div>
    <div className="comp-grid">
      {COMPETENCY_MODEL.map(cm=><React.Fragment key={cm.key}>
        <div className="cg-label" title={cm.name}>{cm.name}</div>
        <div className="cg-dots">
          {[1,2,3,4,5,6,7].map(lv=><div key={lv} className={'cg-dot'+(((comp[cm.key]||0)>=lv)?' filled':'')} onClick={()=>setComp(c=>({...c,[cm.key]:c[cm.key]===lv?0:lv}))}>{lv}</div>)}
        </div>
      </React.Fragment>)}
    </div>
    <div style={{marginTop:10,padding:8,background:'var(--bg1)',borderRadius:8,fontSize:11,display:'flex',justifyContent:'space-between'}}>
      <span>Средний уровень: <strong>{(()=>{const vals=COMPETENCY_MODEL.map(cm=>comp[cm.key]||0).filter(v=>v>0);return vals.length?(vals.reduce((s,v)=>s+v,0)/vals.length).toFixed(1):'--';})()}</strong></span>
      <span>Оценено: <strong>{COMPETENCY_MODEL.filter(cm=>(comp[cm.key]||0)>0).length}/{COMPETENCY_MODEL.length}</strong></span>
    </div>
    </div>}
    {tab==='bpm'&&<div>
    <div style={{fontSize:11,color:'var(--text2)',marginBottom:8}}>Оцените уровень владения каждым BPM-треком. Нажмите на уровень для установки/сброса.</div>
    <div className="bpm-exp-grid">
      {store.data.trackTemplates.filter(tt=>tt.track_class==='BPM').map(tt=><div key={tt.id} className="bpm-exp-row">
        <div className="bpm-exp-name" title={tt.name}>{tt.code} {tt.name}</div>
        <div className="bpm-exp-levels">
          {BPM_EXP_LEVELS.filter(l=>l.key>0).map(l=><div key={l.key} className={'bpm-exp-btn'+((bpmExp[tt.code]||0)>=l.key?' lv-'+l.key:'')} onClick={()=>setBpmExp(x=>({...x,[tt.code]:x[tt.code]===l.key?0:l.key}))}>{l.label}</div>)}
        </div>
      </div>)}
    </div>
    <div style={{marginTop:10,padding:8,background:'var(--bg1)',borderRadius:8,fontSize:11,display:'flex',justifyContent:'space-between'}}>
      <span>Освоено BPM: <strong>{store.data.trackTemplates.filter(tt=>tt.track_class==='BPM'&&(bpmExp[tt.code]||0)>0).length}/{store.data.trackTemplates.filter(tt=>tt.track_class==='BPM').length}</strong></span>
      <span>Средний уровень: <strong>{(()=>{const vals=store.data.trackTemplates.filter(tt=>tt.track_class==='BPM').map(tt=>bpmExp[tt.code]||0).filter(v=>v>0);return vals.length?(vals.reduce((s,v)=>s+v,0)/vals.length).toFixed(1):'—';})()}</strong></span>
    </div>
    <div style={{marginTop:8,fontSize:10,color:'var(--text2)'}}>
      <strong>Уровни:</strong> Учусь (1) — проходил обучение; Новичок (2) — делал 1-2 раза; Профи (3) — регулярно делает; Эксперт (4) — может обучать других
    </div>
    </div>}
    <div className="form-actions" style={{marginTop:12}}><button type="button" className="btn btn-secondary" onClick={onClose}>Отмена</button><button type="button" className="btn btn-danger" style={{marginRight:'auto'}} onClick={()=>{if(confirm('Удалить сотрудника?')){store.deletePerson(pe.id);onClose();}}}>Удалить</button><button type="button" className="btn btn-primary" onClick={submit}>Сохранить</button></div>
  </Modal>;
}

function EditClientModal({client:c,store,onClose,onCreateProject,onGoProject}){
  const [f,setF]=useState({name:c.name,industry:c.industry||'',inn:c.inn||'',segment:c.segment||'',contact_person:c.contact_person||'',contact_email:c.contact_email||'',contact_phone:c.contact_phone||'',notes:c.notes||'',country:c.country||''});
  const cfin=useMemo(()=>{
    const projs=store.data.projects.filter(p=>p.client_id===c.id);
    let totalRev=0,totalRevNet=0,totalCostProd=0,totalCostAll=0,totalOh=0,totalHours=0,totalPaid=0,totalAccrued=0,totalPlanned=0;
    projs.forEach(proj=>{
      const rev=Number(proj.total_contract_value)||Number(proj.fixed_price)||0;
      const tr=_effTax(proj.tax_rate);
      totalRev+=rev;totalRevNet+=Math.round(rev*(1-tr/100));
      let cA=0,cP=0;
      (proj.timeEntries||[]).forEach(te=>{const per=store.data.persons.find(x=>x.id===te.person_id);if(!per||!per.salary_monthly)return;const dt=te.date?new Date(te.date):new Date();const dy=dt.getDay();const df=dt.getDate()-dy+(dy===0?-6:1);const wk=new Date(dt.getFullYear(),dt.getMonth(),df).toISOString().slice(0,10);const we=(per.weekly_timesheets||[]).find(w=>w.week_start===wk);const oh=we?we.open_hours:40;const rate=oh>0?getPersonSalaryAtDate(per,te.date||new Date().toISOString().slice(0,10))/(oh*4.33):0;const cost=rate*(Number(te.hours)||0);cA+=cost;if(per.grade!=='C5')cP+=cost;});
      totalCostProd+=Math.round(cP);totalCostAll+=Math.round(cA);
      totalOh+=(proj.overheads||[]).reduce((s,x)=>s+(Number(x.amount)||0),0);
      totalHours+=(proj.timeEntries||[]).reduce((s,te)=>s+(Number(te.hours)||0),0);
      (proj.payments||[]).forEach(pm=>{const amt=Number(pm.amount)||0;totalPlanned+=amt;if(pm.status==='PAID')totalPaid+=amt;if(pm.status==='ACCRUED')totalAccrued+=amt;});
    });
    const dirtyProfit=totalRevNet-totalCostProd-totalOh;const cleanProfit=totalRevNet-totalCostAll-totalOh;
    const dirtyPct=totalRevNet>0?Math.round(dirtyProfit/totalRevNet*100):0;const cleanPct=totalRevNet>0?Math.round(cleanProfit/totalRevNet*100):0;
    return {cnt:projs.length,totalRev,totalRevNet,totalCostProd,totalCostAll,totalOh,totalHours,totalPaid,totalAccrued,totalPlanned,dirtyProfit,cleanProfit,dirtyPct,cleanPct};
  },[store.data,c.id]);
  const submit=e=>{e.preventDefault();if(!f.name)return;store.updateClient(c.id,f);if(f.country){store.data.projects.filter(p=>p.client_id===c.id).forEach(p=>{const upd={};if(!p.country||p.country!==f.country)upd.country=f.country;if(f.country==='Казахстан'&&(Number(p.tax_rate)||0)!==20)upd.tax_rate=20;if(Object.keys(upd).length)store.updateProject(p.id,upd);});}onClose();};
  return <Modal onClose={onClose}><h2>Редактировать клиента</h2>
  {cfin.cnt>0&&<div style={{marginBottom:16}}>
    <div style={{fontSize:12,fontWeight:600,textTransform:'uppercase',letterSpacing:'.3px',color:'var(--text2)',marginBottom:8}}>Финансовая сводка · {cfin.cnt} {cfin.cnt===1?'проект':cfin.cnt<5?'проекта':'проектов'}</div>
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8,marginBottom:10}}>
      <div style={{background:'var(--bg1)',padding:'8px 10px',borderRadius:8,fontSize:11}}><div style={{color:'var(--text2)'}}>Контракты</div><div style={{fontWeight:700,color:'var(--green)',fontSize:14}}>{fmt(cfin.totalRev)} ₽</div></div>
      <div style={{background:'var(--bg1)',padding:'8px 10px',borderRadius:8,fontSize:11}}><div style={{color:'var(--text2)'}}>Нетто</div><div style={{fontWeight:700,color:'var(--emerald)',fontSize:14}}>{fmt(cfin.totalRevNet)} ₽</div></div>
      <div style={{background:'var(--bg1)',padding:'8px 10px',borderRadius:8,fontSize:11}}><div style={{color:'var(--text2)'}}>Оплачено</div><div style={{fontWeight:700,color:'var(--sky)',fontSize:14}}>{fmt(cfin.totalPaid)} ₽</div></div>
      <div style={{background:'var(--bg1)',padding:'8px 10px',borderRadius:8,fontSize:11}}><div style={{color:'var(--text2)'}}>ДЗ</div><div style={{fontWeight:700,color:'var(--amber)',fontSize:14}}>{fmt(cfin.totalAccrued)} ₽</div></div>
    </div>
    <div className="profit-panel" style={{padding:10}}>
      <div className="profit-row"><span className="pr-label">Выручка (брутто)</span><span className="pr-val">{fmt(cfin.totalRev)} ₽</span></div>
      <div className="profit-row"><span className="pr-label">− Налоги</span><span className="pr-val pr-neg">−{fmt(cfin.totalRev-cfin.totalRevNet)} ₽</span></div>
      <div className="profit-row"><span className="pr-label">= Нетто</span><span className="pr-val">{fmt(cfin.totalRevNet)} ₽</span></div>
      <div className="profit-row"><span className="pr-label">− Косты произв. (C1–C4)</span><span className="pr-val pr-neg">−{fmt(cfin.totalCostProd)} ₽</span></div>
      <div className="profit-row"><span className="pr-label">− Накладные</span><span className="pr-val pr-neg">−{fmt(cfin.totalOh)} ₽</span></div>
      <div className="profit-row pr-total"><span className="pr-label" style={{fontWeight:700}}>Грязная прибыль</span><span className={'pr-val '+(cfin.dirtyProfit>=0?'pr-pos':'pr-neg')}>{fmt(cfin.dirtyProfit)} ₽ ({cfin.dirtyPct}%)</span></div>
      <div className="profit-row"><span className="pr-label">− Косты C5</span><span className="pr-val pr-neg">−{fmt(cfin.totalCostAll-cfin.totalCostProd)} ₽</span></div>
      <div className="profit-row pr-total" style={{borderTop:'2px solid var(--accent)',paddingTop:8}}><span className="pr-label" style={{fontWeight:700}}>Чистая прибыль</span><span className={'pr-val '+(cfin.cleanProfit>=0?'pr-pos':'pr-neg')}>{fmt(cfin.cleanProfit)} ₽ ({cfin.cleanPct}%)</span></div>
    </div>
    <div style={{marginTop:8,display:'flex',gap:12,fontSize:11,color:'var(--text2)'}}>
      <span>Часов: <strong>{cfin.totalHours}</strong></span>
      <span>Оплачено: <strong>{fmt(cfin.totalPaid)}</strong> из <strong>{fmt(cfin.totalPlanned)} ₽</strong></span>
      {cfin.totalPlanned>0&&<span>({Math.round(cfin.totalPaid/cfin.totalPlanned*100)}%)</span>}
    </div>
  </div>}
  {(()=>{const cProjs=store.data.projects.filter(p=>p.client_id===c.id);if(!cProjs.length)return null;return <div style={{marginBottom:14}}>
    <div style={{fontSize:12,fontWeight:600,color:'var(--text2)',marginBottom:6}}>Проекты клиента ({cProjs.length})</div>
    <div style={{display:'flex',flexDirection:'column',gap:3}}>{cProjs.map(pr=><div key={pr.id} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'4px 8px',background:'var(--bg1)',borderRadius:6,fontSize:12}}>
      <div style={{display:'flex',alignItems:'center',gap:6}}>
        <span style={{fontWeight:600,color:'var(--accent2)'}}>{pr.code}</span>
        <span style={{color:'var(--text1)'}}>{pr.name}</span>
        {SB(pr.status)}
      </div>
      {onGoProject?<span className="clickable" style={{color:'var(--accent)',fontSize:11,fontWeight:600}} onClick={()=>{onClose();onGoProject(pr.id);}}>Открыть →</span>:<span style={{fontSize:10,color:'var(--text2)'}}>{fmt(Number(pr.total_contract_value)||0)} ₽</span>}
    </div>)}</div>
  </div>;})()}
  <form onSubmit={submit}>
    <div className="form-row"><div className="form-group"><label>Название *</label><input value={f.name} onChange={e=>setF(p=>({...p,name:e.target.value}))}/></div>
    <div className="form-group"><label>Отрасль</label><input value={f.industry} onChange={e=>setF(p=>({...p,industry:e.target.value}))}/></div></div>
    <div className="form-row"><div className="form-group"><label>ИНН</label><input value={f.inn} onChange={e=>setF(p=>({...p,inn:e.target.value}))}/></div>
    <div className="form-group"><label>Сегмент</label><input value={f.segment} onChange={e=>setF(p=>({...p,segment:e.target.value}))}/></div></div>
    <div className="form-row"><div className="form-group"><label>Страна *</label><select value={f.country} onChange={e=>setF(p=>({...p,country:e.target.value}))} style={!f.country?{borderColor:'var(--red)'}:{}}><option value="">— Выберите страну —</option>{COUNTRIES.map(co=><option key={co} value={co}>{co}</option>)}</select></div><div className="form-group"/></div>
    <div className="form-row"><div className="form-group"><label>Контактное лицо</label><input value={f.contact_person} onChange={e=>setF(p=>({...p,contact_person:e.target.value}))}/></div>
    <div className="form-group"><label>Email</label><input value={f.contact_email} onChange={e=>setF(p=>({...p,contact_email:e.target.value}))}/></div></div>
    <div className="form-row"><div className="form-group"><label>Телефон</label><input value={f.contact_phone} onChange={e=>setF(p=>({...p,contact_phone:e.target.value}))}/></div>
    <div className="form-group"><label>Заметки</label><input value={f.notes} onChange={e=>setF(p=>({...p,notes:e.target.value}))}/></div></div>
    <div className="form-actions"><button type="button" className="btn btn-secondary" onClick={onClose}>Отмена</button>{onCreateProject&&<button type="button" className="btn btn-success" onClick={onCreateProject}>+ Проект</button>}<button type="submit" className="btn btn-primary">Сохранить</button></div>
  </form></Modal>;
}

function EditPaymentModal({payment:pm,projId,store,onClose}){
  const _pd2date=(pd)=>{if(!pd)return '';if(pd.length===7)return pd+'-01';return pd;};
  const proj=store.data.projects.find(p=>p.id===projId);
  const phaseGroups=proj?getPhaseGroups(proj):[];
  const [f,setF]=useState({tranche_number:pm.tranche_number||1,amount:pm.amount||'',planned_date:pm.planned_date||'',actual_date:pm.actual_date||'',accrued_date:pm.accrued_date||'',description:pm.description||'',status:pm.status||'PLANNED',prior_year:pm.prior_year||false,expected_week_monday:pm.expected_week_monday||'',is_upsell:pm.is_upsell||false,phase_id:pm.phase_id||''});
  const onStatusChange=(newSt)=>{const upd={status:newSt};const pdd=_pd2date(f.planned_date);if(newSt==='PAID'){if(!f.actual_date)upd.actual_date=pdd;if(!f.accrued_date)upd.accrued_date=pdd;}else if(newSt==='ACCRUED'){if(!f.accrued_date)upd.accrued_date=pdd;}setF(p=>({...p,...upd}));};
  const submit=e=>{e.preventDefault();store.updatePayment(projId,pm.id,{...f,amount:Number(f.amount)||0,is_upsell:f.tranche_number===1?f.is_upsell:false,phase_id:f.phase_id||null});onClose();};
  return <Modal onClose={onClose}><h2>Редактировать транш</h2><form onSubmit={submit}>
    <div className="form-row"><div className="form-group"><label># транша</label><input type="number" value={f.tranche_number} onChange={e=>setF(p=>({...p,tranche_number:Number(e.target.value)}))}/></div>
    <div className="form-group"><label>Сумма (₽)</label><input type="number" value={f.amount} onChange={e=>setF(p=>({...p,amount:e.target.value}))}/></div></div>
    <div className="form-row"><div className="form-group"><label>Месяц (план)</label><input type="month" value={(f.planned_date||'').slice(0,7)} onChange={e=>setF(p=>({...p,planned_date:e.target.value}))}/></div>
    <div className="form-group"><label>Статус</label><select value={f.status} onChange={e=>onStatusChange(e.target.value)}><option value="PLANNED">запланирован</option><option value="ACCRUED">признан по актам</option><option value="PAID">оплачен</option></select></div></div>
    <div className="form-row"><div className="form-group"><label>Дата признания (акт)</label><input type="date" value={f.accrued_date} onChange={e=>setF(p=>({...p,accrued_date:e.target.value}))}/></div>
    <div className="form-group"><label>Ожид. неделя (Пн)</label><input type="date" value={f.expected_week_monday} onChange={e=>setF(p=>({...p,expected_week_monday:e.target.value}))}/></div></div>
    <div className="form-row"><div className="form-group"><label>Факт. дата оплаты</label><input type="date" value={f.actual_date} onChange={e=>setF(p=>({...p,actual_date:e.target.value}))}/></div>
    <div className="form-group" style={{display:'flex',alignItems:'center',gap:6,paddingTop:18}}><input type="checkbox" checked={f.prior_year} onChange={e=>setF(p=>({...p,prior_year:e.target.checked}))}/><label style={{margin:0,fontSize:12}}>Приход прошлого года</label></div></div>
    {f.tranche_number===1&&<div className="form-row"><div className="form-group" style={{display:'flex',alignItems:'center',gap:6}}><input type="checkbox" checked={f.is_upsell} onChange={e=>setF(p=>({...p,is_upsell:e.target.checked}))}/><label style={{margin:0,fontSize:12,color:'var(--amber)'}}>Допродажа (upsell)</label></div></div>}
    {phaseGroups.length>0&&<div className="form-group"><label>Привязка к стадии</label><select value={f.phase_id||''} onChange={e=>setF(p=>({...p,phase_id:e.target.value||null}))}>
      <option value="">— Без привязки —</option>
      {phaseGroups.map(g=><option key={g.id} value={g.phases[0]?.id||g.id}>{g.group_name}</option>)}
    </select></div>}
    <div className="form-group"><label>Описание</label><input value={f.description} onChange={e=>setF(p=>({...p,description:e.target.value}))}/></div>
    <div className="form-actions"><button type="button" className="btn btn-secondary" onClick={onClose}>Отмена</button><button type="button" className="btn btn-danger" style={{marginRight:'auto'}} onClick={()=>{store.deletePayment(projId,pm.id);onClose();}}>Удалить</button><button type="submit" className="btn btn-primary">Сохранить</button></div>
  </form></Modal>;
}

const TRACK_STATUSES=['NOT_STARTED','IN_PROGRESS','COMPLETED'];
const TASK_STATUSES=['TODO','IN_PROGRESS','DONE'];
const nextStatus=(cur,list)=>{const i=list.indexOf(cur);return list[(i+1)%list.length];};

/* ===== PAGES ===== */
function Dashboard({store,goProject}){
  const {stats,data}=store;
  const active=data.projects.filter(p=>p.status==='ACTIVE');
  const draft=data.projects.filter(p=>p.status==='DRAFT');
  const completed=data.projects.filter(p=>p.status==='COMPLETED');
  const onHold=data.projects.filter(p=>p.status==='ON_HOLD');

  /* ---- computed metrics ---- */
  const triaged=useMemo(()=>active.map(p=>({...p,tri:calcTriage(p),asc:calcAdminScale(p)})),[active]);
  const seg1=triaged.filter(p=>p.tri.segment===1);
  const seg2=triaged.filter(p=>p.tri.segment===2);
  const seg3=triaged.filter(p=>p.tri.segment===3);
  const seg4=triaged.filter(p=>p.tri.segment===4);

  /* finances */
  const totalRevenue=active.reduce((s,p)=>s+(Number(p.total_contract_value)||Number(p.fixed_price)||0),0);
  const totalPaid=active.reduce((s,p)=>s+(p.payments||[]).filter(x=>x.status==='PAID').reduce((a,x)=>a+(Number(x.amount)||0),0),0);
  const totalPaidCurrentYear=active.reduce((s,p)=>s+(p.payments||[]).filter(x=>x.status==='PAID'&&!x.prior_year).reduce((a,x)=>a+(Number(x.amount)||0),0),0);
  const totalPaidPriorYear=active.reduce((s,p)=>s+(p.payments||[]).filter(x=>x.status==='PAID'&&x.prior_year).reduce((a,x)=>a+(Number(x.amount)||0),0),0);
  const totalPlanned=active.reduce((s,p)=>s+(p.payments||[]).reduce((a,x)=>a+(Number(x.amount)||0),0),0);
  const calcProjCostsDash=(proj)=>{
    let costAll=0,costProd=0;
    (proj.timeEntries||[]).forEach(te=>{
      const per=data.persons.find(x=>x.id===te.person_id);
      if(!per||!per.salary_monthly)return;
      const dt=te.date?new Date(te.date):new Date();
      const day=dt.getDay();const diff=dt.getDate()-day+(day===0?-6:1);
      const wk=new Date(dt.getFullYear(),dt.getMonth(),diff).toISOString().slice(0,10);
      const wts=per.weekly_timesheets||[];const we=wts.find(w=>w.week_start===wk);
      const oh=we?we.open_hours:40;
      const rate=oh>0?getPersonSalaryAtDate(per,te.date||new Date().toISOString().slice(0,10))/(oh*4.33):0;
      const cost=rate*(Number(te.hours)||0);
      costAll+=cost;if(per.grade!=='C5')costProd+=cost;
    });
    return {costAll:Math.round(costAll),costProd:Math.round(costProd)};
  };
  const portfolioCosts=active.reduce((s,proj)=>{const c=calcProjCostsDash(proj);return {costAll:s.costAll+c.costAll,costProd:s.costProd+c.costProd};},{costAll:0,costProd:0});
  const portfolioOverheads=active.reduce((s,proj)=>s+(proj.overheads||[]).reduce((a,x)=>a+(Number(x.amount)||0),0),0);
  const portfolioTax=active.reduce((s,proj)=>{const rev=Number(proj.total_contract_value)||Number(proj.fixed_price)||0;const tr=_effTax(proj.tax_rate);return s+Math.round(rev*tr/100);},0);
  const portfolioRevNet=totalRevenue-portfolioTax;
  const portfolioDirtyProfit=portfolioRevNet-portfolioCosts.costProd-portfolioOverheads;
  const portfolioCleanProfit=portfolioRevNet-portfolioCosts.costAll-portfolioOverheads;
  const portfolioGrossProfit=portfolioRevNet-portfolioOverheads;
  const portfolioGrossPct=portfolioRevNet>0?Math.round(portfolioGrossProfit/portfolioRevNet*100):0;
  const portfolioDirtyPct=portfolioRevNet>0?Math.round(portfolioDirtyProfit/portfolioRevNet*100):0;
  const portfolioCleanPct=portfolioRevNet>0?Math.round(portfolioCleanProfit/portfolioRevNet*100):0;

  /* buffer */
  const avgBuffer=triaged.length>0?Math.round(triaged.reduce((s,p)=>s+(p.tri.daysRemaining||0),0)/triaged.length):0;
  const overdue=triaged.filter(p=>p.tri.daysRemaining!==null&&p.tri.daysRemaining<=0);

  /* DD progress avg */
  const avgDDprogress=active.length>0?Math.round(active.reduce((s,p)=>{const phases=p.phases||[];const ts=phases.reduce((a,ph)=>a+(ph.stages||[]).length,0);const ds=phases.reduce((a,ph)=>a+(ph.stages||[]).filter(st=>st.status==='COMPLETED').length,0);return s+(ts>0?ds/ts*100:0);},0)/active.length):0;

  /* admin scale avg */
  const avgAS=triaged.length>0?Math.round(triaged.reduce((s,p)=>s+p.asc.pct,0)/triaged.length):0;

  /* risks */
  const allBlockers=data.projects.flatMap(p=>(p.blockers||[]).filter(b=>!b.resolved_at).map(b=>({...b,projCode:p.code,projId:p.id})));
  const critBlockers=allBlockers.filter(b=>b.severity==='CRITICAL'||b.severity==='HIGH');

  /* capacity */
  const getWeekStartD=(d)=>{const dt=d?new Date(d):new Date();const day=dt.getDay();const diff=dt.getDate()-day+(day===0?-6:1);return new Date(dt.getFullYear(),dt.getMonth(),diff).toISOString().slice(0,10);};
  const thisWeekD=getWeekStartD();
  const activePersons=data.persons.filter(p=>!p.fire_date&&p.grade!=='C5'&&p.grade!=='Стажёр'&&getPersonDepts(p).includes('Производство'));
  const totalOpenHoursD=activePersons.reduce((s,p)=>{const wts=p.weekly_timesheets||[];const e=wts.find(w=>w.week_start===thisWeekD);return s+(e?e.open_hours:0);},0);
  const maxTriageD=Math.floor(totalOpenHoursD/8);
  const triageCount=seg1.length+seg2.length;

  /* team */
  const personLoad={};
  active.forEach(p=>(p.assignments||[]).forEach(a=>{personLoad[a.person_name]=(personLoad[a.person_name]||0)+1;}));
  const teamSorted=Object.entries(personLoad).sort((a,b)=>b[1]-a[1]);
  const maxLoad=teamSorted.length>0?teamSorted[0][1]:1;

  /* work groups */
  const wg1=active.filter(p=>(p.work_group||p._work_group)==='РГ1');
  const wg2=active.filter(p=>(p.work_group||p._work_group)==='РГ2');
  const wg1rev=wg1.reduce((s,p)=>s+(Number(p.total_contract_value)||0),0);
  const wg2rev=wg2.reduce((s,p)=>s+(Number(p.total_contract_value)||0),0);

  /* deadlines */
  const deadlines=triaged.filter(p=>p.tri.daysRemaining!==null).sort((a,b)=>a.tri.daysRemaining-b.tri.daysRemaining);

  /* phase docs completion */
  const avgDocsCompl=active.length>0?Math.round(active.reduce((s,p)=>{const codes=['MINING','ASSEMBLING','IMPLEMENTATION','ORGANIZATION'];let total=0,done=0;codes.forEach(c=>{const docs=getPhaseDocsState(p,c);total+=docs.length;done+=docs.filter(d=>d.status==='DONE').length;});return s+(total>0?done/total*100:0);},0)/active.length):0;

  /* === Milestones (Этапы реализации) aggregation === */
  const milestoneData=React.useMemo(()=>{
    const oldDel=data.projects.filter(p=>p.project_type==='Old Delivery'&&p.status!=='CANCELLED');
    const allMs=oldDel.flatMap(p=>calcProjectMilestones(p).map(m=>({...m,project:p})));
    const ms2026=allMs.filter(m=>(m.planned_month||'')>='2026-01'||(m.delivered_date||'')>='2026-01'||(m.paid_date||'')>='2026-01');
    const byMonth={};
    ms2026.forEach(m=>{
      const key=m.planned_month||'без даты';
      if(!byMonth[key])byMonth[key]={planned:0,delivered:0,paid:0,deliveredSum:0,paidSum:0,items:[]};
      byMonth[key].planned++;
      byMonth[key].items.push(m);
      if(m.status==='DELIVERED'||m.status==='PAID'){byMonth[key].delivered++;byMonth[key].deliveredSum+=m.payment?.amount||0;}
      if(m.status==='PAID'){byMonth[key].paid++;byMonth[key].paidSum+=m.payment?.amount||0;}
    });
    const months=Object.entries(byMonth).sort((a,b)=>a[0].localeCompare(b[0]));
    const totPlanned=ms2026.length;
    const totDelivered=ms2026.filter(m=>m.status==='DELIVERED'||m.status==='PAID').length;
    const totPaid=ms2026.filter(m=>m.status==='PAID').length;
    const totDeliveredSum=ms2026.filter(m=>m.status==='DELIVERED'||m.status==='PAID').reduce((s,m)=>s+(m.payment?.amount||0),0);
    const totPaidSum=ms2026.filter(m=>m.status==='PAID').reduce((s,m)=>s+(m.payment?.amount||0),0);
    /* avg days from planned to delivered */
    let durSum=0,durCnt=0;
    ms2026.forEach(m=>{
      if(m.delivered_date&&m.planned_month){
        const pd=new Date(m.planned_month+'-15');
        const dd=new Date(m.delivered_date);
        const days=Math.ceil((dd-pd)/(864e5));
        if(!isNaN(days)){durSum+=days;durCnt++;}
      }
    });
    const avgDuration=durCnt>0?Math.round(durSum/durCnt):0;
    const convPct=totDelivered>0?Math.round(totPaid/totDelivered*100):0;
    return{oldDel,allMs:ms2026,months,totPlanned,totDelivered,totPaid,totDeliveredSum,totPaidSum,avgDuration,convPct};
  },[data]);

  return <div>
    <h2 className="page-title">Дашборд портфеля</h2>

    {/* === ROW 1: Executive KPIs === */}
    <div className="kpi-row">
      <div className="kpi-card"><div className="kpi-label">Активные проекты</div><div className="kpi-value accent-c">{stats.activeCount}</div><div className="kpi-sub">Всего: {stats.projectCount} · Черновик: {draft.length} · Hold: {onHold.length}</div><div className="kpi-bar"><div className="kpi-bar-fill" style={{width:(stats.activeCount/Math.max(stats.projectCount,1)*100)+'%',background:'var(--accent)'}}></div></div></div>
      <div className="kpi-card"><div className="kpi-label">Выручка портфеля</div><div className="kpi-value green-c">{fmt(totalRevenue)}</div><div className="kpi-sub">Оплачено: {fmt(totalPaid)} ₽ ({totalPlanned>0?Math.round(totalPaid/totalPlanned*100):0}%)</div><div className="kpi-bar"><div className="kpi-bar-fill" style={{width:(totalPlanned>0?totalPaid/totalPlanned*100:0)+'%',background:'var(--green)'}}></div></div></div>
      <div className="kpi-card"><div className="kpi-label">Средний буфер</div><div className="kpi-value" style={{color:avgBuffer<=20?'var(--red)':avgBuffer<=30?'var(--yellow)':'var(--green)'}}>{avgBuffer} дн.</div><div className="kpi-sub">Просрочено: {overdue.length} · S1: {seg1.length}</div><div className="kpi-bar"><div className="kpi-bar-fill" style={{width:Math.min(avgBuffer/60*100,100)+'%',background:avgBuffer<=20?'var(--red)':avgBuffer<=30?'var(--yellow)':'var(--green)'}}></div></div></div>
      <div className="kpi-card"><div className="kpi-label">Прогресс DD</div><div className="kpi-value accent-c">{avgDDprogress}%</div><div className="kpi-sub">Среднее прохождение фаз</div><div className="kpi-bar"><div className="kpi-bar-fill" style={{width:avgDDprogress+'%',background:'var(--accent)'}}></div></div></div>
      <div className="kpi-card"><div className="kpi-label">Админ.шкала</div><div className="kpi-value" style={{color:'var(--violet)'}}>{avgAS}%</div><div className="kpi-sub">Среднее заполнение</div><div className="kpi-bar"><div className="kpi-bar-fill" style={{width:avgAS+'%',background:'var(--violet)'}}></div></div></div>
      <div className="kpi-card"><div className="kpi-label">Риски</div><div className="kpi-value red-c">{allBlockers.length}</div><div className="kpi-sub">Критических: {critBlockers.length} · Команда: {stats.personCount}</div><div className="kpi-bar"><div className="kpi-bar-fill" style={{width:Math.min(allBlockers.length/10*100,100)+'%',background:'var(--red)'}}></div></div></div>
      <div className="kpi-card"><div className="kpi-label">Ёмкость триажа</div><div className="kpi-value" style={{color:triageCount>maxTriageD?'var(--red)':'var(--emerald)'}}>{triageCount}/{maxTriageD||'—'}</div><div className="kpi-sub">{totalOpenHoursD} откр. часов / 8 = {maxTriageD} проектов</div><div className="kpi-bar"><div className="kpi-bar-fill" style={{width:Math.min(maxTriageD>0?triageCount/maxTriageD*100:0,100)+'%',background:triageCount>maxTriageD?'var(--red)':'var(--emerald)'}}></div></div></div>
    </div>

    {/* === ROW 2: Segments + Finances === */}
    <div className="dash-grid-2 dash-section">
      <div className="dash-card">
        <div className="dc-title"><span>Распределение по сегментам</span><span style={{fontSize:10,color:'var(--text2)'}}>{triaged.length} проектов</span></div>
        <div className="seg-bar">
          {seg1.length>0&&<div style={{width:(seg1.length/Math.max(triaged.length,1)*100)+'%',background:'var(--red)'}}>S1 ({seg1.length})</div>}
          {seg2.length>0&&<div style={{width:(seg2.length/Math.max(triaged.length,1)*100)+'%',background:'var(--yellow)',color:'#000'}}>S2 ({seg2.length})</div>}
          {seg3.length>0&&<div style={{width:(seg3.length/Math.max(triaged.length,1)*100)+'%',background:'var(--sky)'}}>S3 ({seg3.length})</div>}
          {seg4.length>0&&<div style={{width:(seg4.length/Math.max(triaged.length,1)*100)+'%',background:'var(--green)'}}>S4 ({seg4.length})</div>}
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,fontSize:11}}>
          <div style={{display:'flex',justifyContent:'space-between'}}><span style={{color:'var(--red)'}}>S1 Ближ. срок + выс. скор</span><span style={{fontWeight:700}}>{seg1.length}</span></div>
          <div style={{display:'flex',justifyContent:'space-between'}}><span style={{color:'var(--yellow)'}}>S2 Ближ. срок + низ. скор</span><span style={{fontWeight:700}}>{seg2.length}</span></div>
          <div style={{display:'flex',justifyContent:'space-between'}}><span style={{color:'var(--sky)'}}>S3 Дальн. срок + выс. скор</span><span style={{fontWeight:700}}>{seg3.length}</span></div>
          <div style={{display:'flex',justifyContent:'space-between'}}><span style={{color:'var(--green)'}}>S4 Дальн. срок + низ. скор</span><span style={{fontWeight:700}}>{seg4.length}</span></div>
        </div>
      </div>
      <div className="dash-card">
        <div className="dc-title">Финансы портфеля</div>
        <div className="fin-mini">
          <div className="fin-mini-card"><div className="fmc-lbl">Контракты</div><div className="fmc-val green-c">{fmt(totalRevenue)}</div></div>
          <div className="fin-mini-card"><div className="fmc-lbl">Оплачено</div><div className="fmc-val accent-c">{fmt(totalPaid)}</div></div>
          <div className="fin-mini-card"><div className="fmc-lbl">К оплате</div><div className="fmc-val yellow-c">{fmt(totalPlanned-totalPaid)}</div></div>
        </div>
        <div className="progress-bar" style={{height:8,marginBottom:6}}><div className="progress-fill" style={{width:(totalPlanned>0?totalPaid/totalPlanned*100:0)+'%',background:'linear-gradient(90deg,var(--green),var(--emerald))'}}></div></div>
        <div style={{fontSize:10,color:'var(--text2)',textAlign:'center'}}>Оплачено {totalPlanned>0?Math.round(totalPaid/totalPlanned*100):0}% от плановых траншей</div>
        <div style={{borderTop:'1px solid var(--border)',marginTop:8,paddingTop:8}}>
          <div className="fmc-lbl" style={{marginBottom:4}}>P&L портфеля</div>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:12,padding:'3px 0'}}><span style={{color:'var(--text2)'}}>Выручка нетто</span><span style={{fontWeight:600}}>{fmt(portfolioRevNet)} ₽</span></div>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:12,padding:'3px 0'}}><span style={{color:'var(--text2)'}}>Накладные</span><span style={{fontWeight:600,color:'var(--violet)'}}>−{fmt(portfolioOverheads)} ₽</span></div>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:12,padding:'4px 0',borderTop:'1px dashed var(--border)',marginTop:2}}><span style={{fontWeight:600}}>Валовая прибыль</span><span style={{fontWeight:600,color:portfolioGrossProfit>=0?'var(--green)':'var(--red)'}}>{fmt(portfolioGrossProfit)} ₽ <span style={{fontSize:10,opacity:.7}}>({portfolioGrossPct}%)</span></span></div>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:12,padding:'3px 0'}}><span style={{color:'var(--text2)'}}>Косты произв. (C1–C4)</span><span style={{fontWeight:600,color:'var(--red)'}}>−{fmt(portfolioCosts.costProd)} ₽</span></div>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:12,padding:'5px 0',borderTop:'1px solid var(--border)',marginTop:2}}><span style={{fontWeight:600}}>Грязная валовая</span><span style={{fontWeight:700,color:portfolioDirtyProfit>=0?'var(--green)':'var(--red)'}}>{fmt(portfolioDirtyProfit)} ₽ <span style={{fontSize:10,opacity:.7}}>({portfolioDirtyPct}%)</span></span></div>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:12,padding:'3px 0'}}><span style={{color:'var(--text2)'}}>Косты C5</span><span style={{fontWeight:600,color:'var(--amber)'}}>−{fmt(portfolioCosts.costAll-portfolioCosts.costProd)} ₽</span></div>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:13,padding:'5px 0',borderTop:'2px solid var(--accent)',marginTop:2}}><span style={{fontWeight:700}}>Чистая валовая</span><span style={{fontWeight:700,color:portfolioCleanProfit>=0?'var(--green)':'var(--red)'}}>{fmt(portfolioCleanProfit)} ₽ <span style={{fontSize:10,opacity:.7}}>({portfolioCleanPct}%)</span></span></div>
          <div style={{marginTop:6,fontSize:10,color:'var(--text2)',textAlign:'center'}}>Норма операц. рентабельности: ≥75–80% от нетто</div>
        </div>
      </div>
    </div>

    {/* === ROW 3: Heatmap === */}
    <div className="dash-section">
      <div className="dash-section-title">Портфельная матрица <span className="subtitle">здоровье проектов по 5 осям</span></div>
      <div className="dash-card" style={{padding:10}}>
        <div className="heatmap-row" style={{borderBottom:'2px solid var(--border)',fontWeight:700,cursor:'default'}}>
          <div>Код</div><div>Проект</div><div className="hm-cell">Буфер</div><div className="hm-cell">Скор</div><div className="hm-cell">DD%</div><div className="hm-cell">АШ%</div><div className="hm-cell">Док%</div>
        </div>
        {triaged.slice(0,20).map(p=>{
          const ddPct=(()=>{const ph=p.phases||[];const ts=ph.reduce((a,x)=>a+(x.stages||[]).length,0);const ds=ph.reduce((a,x)=>a+(x.stages||[]).filter(s=>s.status==='COMPLETED').length,0);return ts>0?Math.round(ds/ts*100):0;})();
          const docPct=(()=>{const codes=['MINING','ASSEMBLING','IMPLEMENTATION','ORGANIZATION'];let t=0,d=0;codes.forEach(c=>{const docs=getPhaseDocsState(p,c);t+=docs.length;d+=docs.filter(x=>x.status==='DONE').length;});return t>0?Math.round(d/t*100):0;})();
          const bC=p.tri.daysRemaining===null?'hm-d':p.tri.daysRemaining<=0?'hm-r':p.tri.daysRemaining<=20?'hm-r':p.tri.daysRemaining<=30?'hm-y':'hm-g';
          const sC=p.tri.totalScore>2.5?'hm-r':p.tri.totalScore>2.2?'hm-y':p.tri.totalScore>0?'hm-g':'hm-d';
          const ddC=ddPct>=75?'hm-g':ddPct>=40?'hm-b':ddPct>0?'hm-y':'hm-d';
          const asC=p.asc.pct>=70?'hm-g':p.asc.pct>=40?'hm-y':'hm-r';
          const dcC=docPct>=70?'hm-g':docPct>=30?'hm-y':'hm-r';
          return <div key={p.id} className="heatmap-row" onClick={()=>goProject(p.id)}>
            <div className="hm-code">{p.code}</div>
            <div className="hm-name">{p.name}</div>
            <div className={'hm-cell '+bC}>{p.tri.daysRemaining!==null?(p.tri.daysRemaining>0?p.tri.daysRemaining+'д':'Проср.'):'—'}</div>
            <div className={'hm-cell '+sC}>{p.tri.totalScore||'—'}</div>
            <div className={'hm-cell '+ddC}>{ddPct}%</div>
            <div className={'hm-cell '+asC}>{p.asc.pct}%</div>
            <div className={'hm-cell '+dcC}>{docPct}%</div>
          </div>;
        })}
      </div>
    </div>

    {/* === ROW 4: Deadlines + Risks === */}
    <div className="dash-grid-2 dash-section">
      <div className="dash-card">
        <div className="dc-title"><span>Сроки и дедлайны</span><span style={{fontSize:10,color:'var(--text2)'}}>{overdue.length>0?overdue.length+' просроч.':'все в срок'}</span></div>
        {deadlines.slice(0,10).map(p=><div key={p.id} className="deadline-item" onClick={()=>goProject(p.id)}>
          <div><span style={{color:'var(--accent2)',fontWeight:600,marginRight:6}}>{p.code}</span><span style={{color:'var(--text2)',fontSize:10}}>{p.name}</span></div>
          <div className="dl-days" style={{background:p.tri.daysRemaining<=0?'rgba(239,68,68,.15)':p.tri.daysRemaining<=20?'rgba(239,68,68,.1)':p.tri.daysRemaining<=30?'rgba(234,179,8,.1)':'rgba(34,197,94,.1)',color:p.tri.daysRemaining<=0?'var(--red)':p.tri.daysRemaining<=20?'var(--red)':p.tri.daysRemaining<=30?'var(--yellow)':'var(--green)'}}>{p.tri.daysRemaining<=0?'Проср. '+Math.abs(p.tri.daysRemaining)+'д':p.tri.daysRemaining+' дн.'}</div>
        </div>)}
        {deadlines.length===0&&<div className="empty" style={{padding:12}}>Нет дат окончания</div>}
      </div>
      <div className="dash-card">
        <div className="dc-title"><span>Риски и блокеры</span><span style={{fontSize:10,color:critBlockers.length?'var(--red)':'var(--text2)'}}>{critBlockers.length} крит.</span></div>
        {allBlockers.length===0?<div className="empty" style={{padding:12}}>Нет открытых блокеров</div>:allBlockers.slice(0,8).map((b,i)=><div key={i} className="risk-item" onClick={()=>goProject(b.projId)}>
          <div className="risk-dot" style={{background:b.severity==='CRITICAL'?'var(--red)':b.severity==='HIGH'?'var(--amber)':'var(--yellow)'}}></div>
          <span style={{fontWeight:600,color:'var(--accent2)',marginRight:4}}>{b.projCode}</span>
          <span style={{flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{b.description}</span>
          <span style={{fontSize:9,color:'var(--text2)',flexShrink:0}}>{b.severity}</span>
        </div>)}
      </div>
    </div>

    {/* === ROW 4b: Milestones (Этапы реализации Old Delivery) === */}
    {milestoneData.oldDel.length>0&&<div className="dash-section">
      <div className="dash-card">
        <div className="dc-title"><span>Этапы реализации (Old Delivery)</span><span style={{fontSize:10,color:'var(--text2)'}}>{milestoneData.oldDel.length} проектов</span></div>

        {/* KPI row */}
        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8,marginBottom:16}}>
          <div style={{textAlign:'center',padding:8,background:'var(--bg3)',borderRadius:8}}>
            <div style={{fontSize:18,fontWeight:700,color:'var(--accent)'}}>{milestoneData.totPlanned}</div>
            <div style={{fontSize:10,color:'var(--text2)'}}>Всего этапов</div>
          </div>
          <div style={{textAlign:'center',padding:8,background:'var(--bg3)',borderRadius:8}}>
            <div style={{fontSize:18,fontWeight:700,color:'var(--green)'}}>{milestoneData.totDelivered}</div>
            <div style={{fontSize:10,color:'var(--text2)'}}>Оказано</div>
          </div>
          <div style={{textAlign:'center',padding:8,background:'var(--bg3)',borderRadius:8}}>
            <div style={{fontSize:18,fontWeight:700,color:'var(--emerald)'}}>{milestoneData.totPaid}</div>
            <div style={{fontSize:10,color:'var(--text2)'}}>Оплачено</div>
          </div>
          <div style={{textAlign:'center',padding:8,background:'var(--bg3)',borderRadius:8}}>
            <div style={{fontSize:18,fontWeight:700,color:'var(--sky)'}}>{milestoneData.avgDuration} дн.</div>
            <div style={{fontSize:10,color:'var(--text2)'}}>Ср. длительность</div>
          </div>
        </div>

        {/* Monthly table */}
        <div style={{overflowX:'auto'}}>
          <table style={{width:'100%',fontSize:11,borderCollapse:'collapse'}}>
            <thead><tr style={{borderBottom:'2px solid var(--border)'}}>
              <th style={{textAlign:'left',padding:'4px 8px'}}>Месяц</th>
              <th style={{textAlign:'center',padding:'4px 8px'}}>Плановых</th>
              <th style={{textAlign:'center',padding:'4px 8px',color:'var(--green)'}}>Оказано</th>
              <th style={{textAlign:'center',padding:'4px 8px',color:'var(--emerald)'}}>Оплачено</th>
              <th style={{textAlign:'right',padding:'4px 8px'}}>Сумма оказ.</th>
              <th style={{textAlign:'right',padding:'4px 8px'}}>Сумма оплач.</th>
            </tr></thead>
            <tbody>
              {milestoneData.months.map(([month,d])=><tr key={month} style={{borderBottom:'1px solid var(--border)'}}>
                <td style={{padding:'4px 8px',fontWeight:600}}>{month}</td>
                <td style={{textAlign:'center',padding:'4px 8px'}}>{d.planned}</td>
                <td style={{textAlign:'center',padding:'4px 8px',color:'var(--green)',fontWeight:600}}>{d.delivered||'—'}</td>
                <td style={{textAlign:'center',padding:'4px 8px',color:'var(--emerald)',fontWeight:600}}>{d.paid||'—'}</td>
                <td style={{textAlign:'right',padding:'4px 8px'}}>{d.deliveredSum>0?fmt(d.deliveredSum):'—'}</td>
                <td style={{textAlign:'right',padding:'4px 8px'}}>{d.paidSum>0?fmt(d.paidSum):'—'}</td>
              </tr>)}
              {milestoneData.months.length>0&&<tr style={{borderTop:'2px solid var(--border)',fontWeight:700}}>
                <td style={{padding:'4px 8px'}}>Итого</td>
                <td style={{textAlign:'center',padding:'4px 8px'}}>{milestoneData.totPlanned}</td>
                <td style={{textAlign:'center',padding:'4px 8px',color:'var(--green)'}}>{milestoneData.totDelivered}</td>
                <td style={{textAlign:'center',padding:'4px 8px',color:'var(--emerald)'}}>{milestoneData.totPaid}</td>
                <td style={{textAlign:'right',padding:'4px 8px'}}>{milestoneData.totDeliveredSum>0?fmt(milestoneData.totDeliveredSum):'—'}</td>
                <td style={{textAlign:'right',padding:'4px 8px'}}>{milestoneData.totPaidSum>0?fmt(milestoneData.totPaidSum):'—'}</td>
              </tr>}
            </tbody>
          </table>
        </div>
        {milestoneData.months.length===0&&<div className="empty" style={{padding:12}}>Нет этапов с 2026 года</div>}

        {/* Conversion bar */}
        {milestoneData.totPlanned>0&&<div style={{marginTop:12,display:'flex',alignItems:'center',gap:8,fontSize:10,color:'var(--text2)'}}>
          <span>Конверсия оказан→оплачен: <b style={{color:'var(--accent)'}}>{milestoneData.convPct}%</b></span>
          <div style={{flex:1,height:6,background:'var(--bg4)',borderRadius:3,overflow:'hidden'}}><div style={{height:'100%',width:milestoneData.convPct+'%',background:'var(--emerald)',borderRadius:3}}></div></div>
        </div>}

        {/* Detail by project (collapsed) */}
        {milestoneData.allMs.length>0&&<details style={{marginTop:12}}>
          <summary style={{fontSize:10,color:'var(--accent)',cursor:'pointer'}}>Детализация по проектам ({milestoneData.allMs.length} этапов)</summary>
          <table style={{width:'100%',fontSize:10,borderCollapse:'collapse',marginTop:8}}>
            <thead><tr style={{borderBottom:'1px solid var(--border)'}}>
              <th style={{textAlign:'left',padding:'3px 6px'}}>Проект</th>
              <th style={{textAlign:'left',padding:'3px 6px'}}>Этап</th>
              <th style={{textAlign:'center',padding:'3px 6px'}}>Статус</th>
              <th style={{textAlign:'center',padding:'3px 6px'}}>План</th>
              <th style={{textAlign:'center',padding:'3px 6px'}}>Факт</th>
              <th style={{textAlign:'right',padding:'3px 6px'}}>Сумма</th>
            </tr></thead>
            <tbody>{milestoneData.allMs.map((m,i)=><tr key={i} style={{borderBottom:'1px solid var(--border)',cursor:'pointer'}} onClick={()=>goProject(m.project.id)}>
              <td style={{padding:'3px 6px',color:'var(--accent2)',fontWeight:600}}>{m.project.code||m.project.name}</td>
              <td style={{padding:'3px 6px'}}>{m.name}</td>
              <td style={{textAlign:'center',padding:'3px 6px'}}>
                <span style={{padding:'1px 6px',borderRadius:4,fontSize:9,fontWeight:600,
                  background:m.status==='PAID'?'rgba(16,185,129,.15)':m.status==='DELIVERED'?'rgba(34,197,94,.15)':'rgba(96,165,250,.15)',
                  color:m.status==='PAID'?'var(--emerald)':m.status==='DELIVERED'?'var(--green)':'var(--sky)'
                }}>{m.status==='PAID'?'Оплачен':m.status==='DELIVERED'?'Оказан':'Плановый'}</span>
              </td>
              <td style={{textAlign:'center',padding:'3px 6px',fontSize:9}}>{m.planned_month||'—'}</td>
              <td style={{textAlign:'center',padding:'3px 6px',fontSize:9}}>{m.delivered_date?m.delivered_date.slice(0,10):'—'}</td>
              <td style={{textAlign:'right',padding:'3px 6px'}}>{m.payment?fmt(m.payment.amount):'—'}</td>
            </tr>)}</tbody>
          </table>
        </details>}
      </div>
    </div>}

    {/* === ROW 5: Team + Work Groups === */}
    <div className="dash-grid-2 dash-section">
      <div className="dash-card">
        <div className="dc-title"><span>Нагрузка команды</span><span style={{fontSize:10,color:'var(--text2)'}}>{teamSorted.length} чел.</span></div>
        {teamSorted.slice(0,12).map(([name,count])=><div key={name} className="team-bar">
          <div className="tb-name">{name}</div>
          <div className="tb-fill" style={{width:(count/maxLoad*100)+'%',background:count>=4?'var(--red)':count>=3?'var(--yellow)':'var(--accent)'}}></div>
          <div className="tb-count">{count} пр.</div>
        </div>)}
        {teamSorted.length===0&&<div className="empty" style={{padding:12}}>Нет назначений</div>}
      </div>
      <div className="dash-card">
        <div className="dc-title">Рабочие группы</div>
        <div className="wg-compare">
          <div>
            <div className="wg-stat"><div className="wg-val accent-c">{wg1.length}</div><div className="wg-lbl">РГ1 проектов</div></div>
            <div className="wg-stat" style={{marginTop:8}}><div className="wg-val" style={{fontSize:14,color:'var(--green)'}}>{fmt(wg1rev)}</div><div className="wg-lbl">выручка</div></div>
            <div className="wg-stat" style={{marginTop:8}}><div className="wg-val" style={{fontSize:14}}>{wg1.length>0?Math.round(wg1.reduce((s,p)=>s+calcTriage(p).totalScore,0)/wg1.length*10)/10:0}</div><div className="wg-lbl">ср. скоринг</div></div>
          </div>
          <div className="wg-vs">vs</div>
          <div>
            <div className="wg-stat"><div className="wg-val accent-c">{wg2.length}</div><div className="wg-lbl">РГ2 проектов</div></div>
            <div className="wg-stat" style={{marginTop:8}}><div className="wg-val" style={{fontSize:14,color:'var(--green)'}}>{fmt(wg2rev)}</div><div className="wg-lbl">выручка</div></div>
            <div className="wg-stat" style={{marginTop:8}}><div className="wg-val" style={{fontSize:14}}>{wg2.length>0?Math.round(wg2.reduce((s,p)=>s+calcTriage(p).totalScore,0)/wg2.length*10)/10:0}</div><div className="wg-lbl">ср. скоринг</div></div>
          </div>
        </div>
      </div>
    </div>

    {/* === ROW 6: Document Compliance + Phase Completion === */}
    <div className="dash-grid-2 dash-section">
      <div className="dash-card">
        <div className="dc-title"><span>Комплектность документов</span><span style={{fontSize:10,color:'var(--text2)'}}>Ср.: {avgDocsCompl}%</span></div>
        {active.slice(0,10).map(p=>{const codes=['MINING','ASSEMBLING','IMPLEMENTATION','ORGANIZATION'];let t=0,d=0;codes.forEach(c=>{const docs=getPhaseDocsState(p,c);t+=docs.length;d+=docs.filter(x=>x.status==='DONE').length;});const pct=t>0?Math.round(d/t*100):0;return <div key={p.id} className="deadline-item" onClick={()=>goProject(p.id)}>
          <div style={{flex:1}}><span style={{color:'var(--accent2)',fontWeight:600,marginRight:6}}>{p.code}</span><span style={{color:'var(--text2)',fontSize:10}}>{d}/{t}</span></div>
          <div style={{width:80}}><div className="progress-bar" style={{height:6}}><div className="progress-fill" style={{width:pct+'%',background:pct>=70?'var(--green)':pct>=30?'var(--yellow)':'var(--red)'}}></div></div></div>
          <div style={{fontSize:10,fontWeight:600,width:35,textAlign:'right',color:pct>=70?'var(--green)':pct>=30?'var(--yellow)':'var(--red)'}}>{pct}%</div>
        </div>;})}
      </div>
      <div className="dash-card">
        <div className="dc-title">Прогресс по фазам DD</div>
        {['MINING','ASSEMBLING','IMPLEMENTATION','ORGANIZATION'].map(code=>{const label={'MINING':'Добыча','ASSEMBLING':'Сборка','IMPLEMENTATION':'Внедрение','ORGANIZATION':'Организация'}[code];const inPhase=active.filter(p=>(p.phases||[]).some(ph=>ph.phase_code===code&&ph.status==='IN_PROGRESS')).length;const donePhase=active.filter(p=>(p.phases||[]).some(ph=>ph.phase_code===code&&ph.status==='COMPLETED')).length;return <div key={code} className="team-bar">
          <div className="tb-name">{label}</div>
          <div style={{flex:1,display:'flex',gap:2}}>
            <div className="tb-fill" style={{width:(donePhase/Math.max(active.length,1)*100)+'%',background:'var(--green)'}}></div>
            <div className="tb-fill" style={{width:(inPhase/Math.max(active.length,1)*100)+'%',background:'var(--accent)'}}></div>
          </div>
          <div className="tb-count" style={{width:60}}>{donePhase}✓ {inPhase}▶</div>
        </div>;})}
        <div style={{fontSize:9,color:'var(--text2)',marginTop:6,display:'flex',gap:12,justifyContent:'center'}}><span><span style={{display:'inline-block',width:8,height:8,borderRadius:2,background:'var(--green)',marginRight:4}}></span>Завершено</span><span><span style={{display:'inline-block',width:8,height:8,borderRadius:2,background:'var(--accent)',marginRight:4}}></span>В работе</span></div>
      </div>
    </div>
  </div>;
}

function ProjectList({store,goProject,filters,setFilters}){
  const [showNew,setShowNew]=useState(false);
  const [projView,setProjView]=useState('list'); /* 'list' | 'kanban' */
  const [tasksProjFilter,setTasksProjFilter]=useState([]);
  const [editCrossTask,setEditCrossTask]=useState(null);
  const [kbDeadline,setKbDeadline]=useState(''); /* '','overdue','3d','7d','30d' */
  const [kbAssignee,setKbAssignee]=useState('');
  const [kbSeg,setKbSeg]=useState(''); /* '','1','2','3','4' */
  const [kbDoneFilter,setKbDoneFilter]=useState('active'); /* 'all','active','done' */
  const [kbMode,setKbMode]=useState('kanban'); /* 'kanban' | 'table' */
  const [kbGroupBy,setKbGroupBy]=useState('status'); /* status|project|assignee|priority|track|segment */
  const [kbSortBy2,setKbSortBy2]=useState('priority'); /* priority|deadline|title|status */
  const _defaultView={name:'',mode:'kanban',groupBy:'status',sortBy:'priority',projFilter:[],deadline:'',assignee:'',seg:''};
  const [savedViews,setSavedViews]=useState(()=>{try{return JSON.parse(localStorage.getItem('pp_kb_views')||'[]');}catch(e){return [];}});
  const saveCurrentView=(name)=>{const v={...{name,mode:kbMode,groupBy:kbGroupBy,sortBy:kbSortBy2,projFilter:[...tasksProjFilter],deadline:kbDeadline,assignee:kbAssignee,seg:kbSeg,doneFilter:kbDoneFilter},id:uuid()};const nv=[...savedViews,v];setSavedViews(nv);localStorage.setItem('pp_kb_views',JSON.stringify(nv));};
  const loadView=(v)=>{setKbMode(v.mode||'kanban');setKbGroupBy(v.groupBy||'status');setKbSortBy2(v.sortBy||'priority');setTasksProjFilter(v.projFilter||[]);setKbDeadline(v.deadline||'');setKbAssignee(v.assignee||'');setKbSeg(v.seg||'');setKbDoneFilter(v.doneFilter||'active');};
  const deleteView=(id)=>{const nv=savedViews.filter(v=>v.id!==id);setSavedViews(nv);localStorage.setItem('pp_kb_views',JSON.stringify(nv));};
  const [collapsedGroups,setCollapsedGroups]=useState(new Set());
  const toggleGroup=(gk)=>setCollapsedGroups(prev=>{const n=new Set(prev);if(n.has(gk))n.delete(gk);else n.add(gk);return n;});
  const {fWG,fType,fStat,fSeg,sortBy}=filters;
  const uf=(k,v)=>setFilters(prev=>({...prev,[k]:v}));
  const hasActiveFilters=fWG||fType||(fStat&&fStat!=='_active')||fSeg||sortBy!=='buffer';
  const clearFilters=()=>setFilters({fWG:'',fType:'',fStat:'_active',fSeg:'',sortBy:'buffer'});
  const projects=useMemo(()=>{
    let ps=store.data.projects.filter(p=>{
      if(fWG&&(p.work_group||p._work_group)!==fWG)return false;
      if(fType&&p.project_type!==fType)return false;
      if(fStat==='_active'&&p.status==='COMPLETED')return false;
      if(fStat&&fStat!=='_active'&&p.status!==fStat)return false;
      if(fSeg){const seg=calcTriage(p).segment;if(String(seg||0)!==fSeg)return false;}
      return true;
    });
    if(sortBy==='buffer')ps=[...ps].sort((a,b)=>{const ta=calcTriage(a),tb=calcTriage(b);const da=ta.daysRemaining??999,db=tb.daysRemaining??999;return da-db;});
    if(sortBy==='segment')ps=[...ps].sort((a,b)=>{const ta=calcTriage(a),tb=calcTriage(b);return(ta.segment||99)-(tb.segment||99);});
    if(sortBy==='name')ps=[...ps].sort((a,b)=>a.name.localeCompare(b.name));
    return ps;
  },[store.data.projects,fWG,fType,fStat,fSeg,sortBy]);
  return <div>
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}>
      <h2 className="page-title" style={{margin:0}}>Проекты ({projects.length}/{store.data.projects.length})</h2>
      <div style={{display:'flex',gap:6,alignItems:'center'}}>
        <div className="tab-bar" style={{marginBottom:0}}>
          <div className={`tab ${projView==='list'?'active':''}`} onClick={()=>setProjView('list')}>📋 Список</div>
          <div className={`tab ${projView==='kanban'?'active':''}`} onClick={()=>setProjView('kanban')}>📊 Канбан задач</div>
        </div>
        <button className="btn btn-primary" onClick={()=>setShowNew(true)}>+ Новый проект</button>
      </div>
    </div>
    {projView==='list'&&<React.Fragment>
    <div style={{display:'flex',gap:8,marginBottom:12,flexWrap:'wrap',alignItems:'center'}}>
      <select className="filter-select" value={fWG} onChange={e=>uf('fWG',e.target.value)}><option value="">Все РГ</option><option value="РГ1">РГ1</option><option value="РГ2">РГ2</option></select>
      <select className="filter-select" value={fType} onChange={e=>uf('fType',e.target.value)}><option value="">Все типы</option>{(store.data.projectTypes||[]).map(t=><option key={t} value={t}>{t}</option>)}</select>
      <select className="filter-select" value={fStat} onChange={e=>uf('fStat',e.target.value)}><option value="_active">Без завершённых</option><option value="">Все статусы</option><option value="ACTIVE">ACTIVE</option><option value="DRAFT">DRAFT</option><option value="ON_HOLD">ON_HOLD</option><option value="COMPLETED">COMPLETED</option></select>
      <select className="filter-select" value={fSeg} onChange={e=>uf('fSeg',e.target.value)}><option value="">Все сегменты</option><option value="1">S1 Критич.</option><option value="2">S2 Внимание</option><option value="3">S3 Наблюд.</option><option value="4">S4 Спокойн.</option></select>
      <span style={{color:'var(--text2)',fontSize:11,marginLeft:8}}>Сорт.:</span>
      <select className="filter-select" value={sortBy} onChange={e=>uf('sortBy',e.target.value)}><option value="buffer">Буфер ↑</option><option value="segment">Сегмент</option><option value="name">Название</option></select>
      {hasActiveFilters&&<button className="btn btn-secondary btn-sm" style={{marginLeft:4,fontSize:10,padding:'2px 8px'}} onClick={clearFilters}>✕ Сбросить фильтры</button>}
    </div>
    <div style={{overflowX:'auto'}}><table className="project-table"><thead><tr><th>Код</th><th>Название</th><th>Клиент</th><th>РГ</th><th>Тип</th><th>Статус</th><th>Старт</th><th>Дедлайн</th><th>Стадия</th><th>Буфер</th><th>P&L</th><th>Сегм.</th></tr></thead>
    <tbody>{projects.map(p=>{const tri=calcTriage(p);return <tr key={p.id} className="clickable" onClick={()=>goProject(p.id)}>
      <td style={{color:'var(--accent2)',fontWeight:600,whiteSpace:'nowrap'}}>{p.code}</td>
      <td style={{maxWidth:260,whiteSpace:'nowrap'}}><span style={{overflow:'hidden',textOverflow:'ellipsis',display:'inline-block',maxWidth:160,verticalAlign:'middle'}}>{p.name}</span>{!(Number(p.total_contract_value)||0)&&<span title="Не указана сумма контракта" style={{color:'var(--red)',cursor:'pointer',marginLeft:4,fontSize:14,verticalAlign:'middle'}} onClick={e=>{e.stopPropagation();goProject(p.id,'financials');}}>💲</span>}{!(p.payments||[]).length&&<span title="Нет траншей" style={{color:'var(--red)',cursor:'pointer',marginLeft:2,fontSize:14,verticalAlign:'middle'}} onClick={e=>{e.stopPropagation();goProject(p.id,'financials');}}>💰</span>}{(()=>{const _oh=p.overheads||[];const _cyPfx=String(new Date().getFullYear());if(!_oh.length)return <span title="Нет накладных" style={{color:'var(--yellow)',cursor:'pointer',marginLeft:2,fontSize:13,verticalAlign:'middle'}} onClick={e=>{e.stopPropagation();goProject(p.id,'financials');}}>❗</span>;if(!_oh.some(x=>(x.date||'').startsWith(_cyPfx))){const _ackAt=p.oh_ack_at||'';const _lastReset=(()=>{const n=new Date();const pts=[];for(let d=0;d<8;d++){const c=new Date(n.getTime()-d*864e5);c.setUTCHours(12,0,0,0);const wd=c.getUTCDay();if((wd===1||wd===6)&&c<=n)pts.push(c);}return pts.length?pts[0].toISOString():'';})();const _expired=!_ackAt||_ackAt<_lastReset;if(!_expired)return null;return <React.Fragment><span title="Нет накладных в текущем году" style={{color:'var(--yellow)',cursor:'pointer',marginLeft:2,fontSize:13,verticalAlign:'middle'}} onClick={e=>{e.stopPropagation();goProject(p.id,'financials');}}>❗❗</span><span title="Подтвердить: накладных пока нет" style={{cursor:'pointer',marginLeft:2,fontSize:11,verticalAlign:'middle',color:'var(--green)',fontWeight:700}} onClick={e=>{e.stopPropagation();store.updateProject(p.id,{oh_ack_at:new Date().toISOString()});}}>✓</span></React.Fragment>;}return null;})()}</td>
      <td style={{color:'var(--text2)',fontSize:12}}>{p.client_name}</td>
      <td onClick={e=>e.stopPropagation()}><select style={{fontSize:10,padding:'1px 4px',border:'1px solid var(--border)',borderRadius:4,background:'var(--bg2)',color:'var(--text1)',cursor:'pointer'}} value={p.work_group||p._work_group||''} onChange={e=>store.updateProject(p.id,{work_group:e.target.value,_work_group:e.target.value})}><option value="">—</option><option value="РГ1">РГ1</option><option value="РГ2">РГ2</option></select></td>
      <td onClick={e=>e.stopPropagation()}><select style={{fontSize:10,padding:'1px 4px',border:'1px solid var(--border)',borderRadius:4,background:'var(--bg2)',color:'var(--text1)',cursor:'pointer'}} value={p.project_type||''} onChange={e=>store.updateProject(p.id,{project_type:e.target.value})}><option value="">—</option>{(store.data.projectTypes||[]).map(t=><option key={t} value={t}>{t}</option>)}</select></td>
      <td>{SB(p.status)}</td>
      <td style={{color:'var(--text2)',fontSize:11,whiteSpace:'nowrap'}}>{fmtD(p.start_date)}</td>
      <td style={{color:'var(--text2)',fontSize:11,whiteSpace:'nowrap'}}>{fmtD(p.target_end_date)}</td>
      <td style={{fontSize:11,whiteSpace:'nowrap'}}>{tri.currentPhase!=='—'?<span><span style={{color:'var(--accent2)'}}>{tri.currentPhase.split('(')[0].trim()}</span>{tri.currentStage!=='—'&&<span style={{color:'var(--text2)'}}> / {tri.currentStage}</span>}</span>:'—'}</td>
      <td><span className={'badge buffer-'+tri.bufferColor}>{tri.daysRemaining!==null?(tri.daysRemaining>0?tri.daysRemaining+' дн.':'Просрочен'):'—'}</span></td>
      {(()=>{const rev=Number(p.total_contract_value)||Number(p.fixed_price)||0;if(rev===0)return <td><span className="pnl-dot" style={{background:'var(--text2)'}}></span></td>;const tr2=_effTax(p.tax_rate);const rn=Math.round(rev*(1-tr2/100));let cP=0;(p.timeEntries||[]).forEach(te=>{const pe=store.data.persons.find(x=>x.id===te.person_id);if(!pe||!pe.salary_monthly||pe.grade==='C5')return;const dt2=te.date?new Date(te.date):new Date();const dy2=dt2.getDay();const df2=dt2.getDate()-dy2+(dy2===0?-6:1);const wk2=new Date(dt2.getFullYear(),dt2.getMonth(),df2).toISOString().slice(0,10);const we2=(pe.weekly_timesheets||[]).find(w=>w.week_start===wk2);const oh2=we2?we2.open_hours:40;cP+=oh2>0?getPersonSalaryAtDate(pe,te.date||new Date().toISOString().slice(0,10))/(oh2*4.33)*(Number(te.hours)||0):0;});const ohT=(p.overheads||[]).reduce((s,x)=>s+(Number(x.amount)||0),0);const dp=rn-Math.round(cP)-ohT;const dpPct=rn>0?Math.round(dp/rn*100):0;const clr=dpPct>=80?'var(--green)':dpPct>=75?'var(--yellow)':'var(--red)';return <td title={'Грязная: '+dpPct+'%'}><span className="pnl-dot" style={{background:clr}}></span><span style={{fontSize:10,color:clr,fontWeight:600}}>{dpPct}%</span></td>;})()}
      <td>{tri.segment?<span className={'badge seg-'+tri.segment}>S{tri.segment}</span>:'—'}</td>
    </tr>;})}</tbody></table></div>
    </React.Fragment>}

    {/* ═══════ Канбан задач (вкладка) ═══════ */}
    {projView==='kanban'&&(()=>{
      const activeProjs=store.data.projects.filter(pr=>['ACTIVE','ON_HOLD','PAUSED'].includes(pr.status));
      const crossTasks=activeProjs.flatMap(pr=>(pr.tasks||[]).map(t=>({...t,_projId:pr.id,_projCode:pr.code,_projName:pr.name})));
      /* Предвычислить триаж для каждого проекта */
      const _projTriMap={};activeProjs.forEach(pr=>{_projTriMap[pr.id]=calcTriage(pr);});
      /* Фильтрация: проект + дедлайн + ответственный + сегмент проекта */
      let filtered=tasksProjFilter.length>0?crossTasks.filter(t=>tasksProjFilter.includes(t._projId)):crossTasks;
      if(kbSeg){filtered=filtered.filter(t=>{const tri=_projTriMap[t._projId];return tri&&String(tri.segment)===kbSeg;});}
      if(kbAssignee){filtered=filtered.filter(t=>(t.assigned_to_id||'')=== kbAssignee);}
      if(kbDeadline){const now=new Date();filtered=filtered.filter(t=>{if(!t.deadline)return kbDeadline==='none';const dl=new Date(t.deadline);const dd=Math.ceil((dl-now)/864e5);if(kbDeadline==='overdue')return dd<0;if(kbDeadline==='3d')return dd>=0&&dd<=3;if(kbDeadline==='7d')return dd>=0&&dd<=7;if(kbDeadline==='30d')return dd>=0&&dd<=30;if(kbDeadline==='none')return !t.deadline;return true;});}
      if(kbDoneFilter==='active')filtered=filtered.filter(t=>(t.status||'TODO')!=='DONE');
      else if(kbDoneFilter==='done')filtered=filtered.filter(t=>(t.status||'TODO')==='DONE');
      const selectProj=(id)=>setTasksProjFilter(f=>f.length===1&&f[0]===id?[]:[id]);
      const selProj=tasksProjFilter.length===1?activeProjs.find(pr=>pr.id===tasksProjFilter[0]):null;
      /* Быстрые фильтры-группы */
      const filterByWG=(wg)=>{const ids=activeProjs.filter(pr=>(pr.work_group||pr._work_group)===wg).map(pr=>pr.id);setTasksProjFilter(ids);};
      const filterBySeg=(seg)=>{const ids=activeProjs.filter(pr=>calcTriage(pr).segment===seg).map(pr=>pr.id);setTasksProjFilter(ids);};
      const kanbanCols=store.getGlobalStatuses();
      const prioColors={1:'var(--red)',2:'#f97316',3:'var(--amber)',4:'var(--green)',5:'var(--text2)'};
      const onDragStart2=(e,taskId,projId)=>{e.dataTransfer.setData('text/plain',JSON.stringify({taskId,projId}));e.dataTransfer.effectAllowed='move';e.currentTarget.style.opacity='0.4';};
      const onDragEnd2=(e)=>{e.currentTarget.style.opacity='1';};
      const onDragOver2=(e)=>{e.preventDefault();e.dataTransfer.dropEffect='move';e.currentTarget.style.background='rgba(14,165,233,.12)';};
      const onDragLeave2=(e)=>{e.currentTarget.style.background='';};
      const onDrop2=(e,newStatus)=>{e.preventDefault();e.currentTarget.style.background='';try{const d=JSON.parse(e.dataTransfer.getData('text/plain'));if(d&&d.taskId&&d.projId)store.updateTaskStatus(d.projId,d.taskId,newStatus);}catch(ex){}};
      return <div style={{padding:'0 16px 16px'}}>
        {/* === Панель видов + сохранённые === */}
        <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:10,alignItems:'center',justifyContent:'space-between'}}>
          <div style={{display:'flex',gap:4,alignItems:'center'}}>
            <span className={'filter-chip'+(kbMode==='kanban'?' active':'')} onClick={()=>setKbMode('kanban')}>📊 Канбан</span>
            <span className={'filter-chip'+(kbMode==='table'?' active':'')} onClick={()=>setKbMode('table')}>📋 Таблица</span>
            {kbMode==='table'&&<React.Fragment>
              <span style={{fontSize:10,color:'var(--text2)',marginLeft:6}}>Группировка:</span>
              <select className="filter-select" style={{fontSize:10,padding:'2px 4px'}} value={kbGroupBy} onChange={e=>setKbGroupBy(e.target.value)}>
                <option value="status">Статус</option><option value="project">Проект</option><option value="assignee">Ответственный</option><option value="priority">Приоритет</option><option value="track">Трек</option><option value="segment">Сегмент</option>
              </select>
              <span style={{fontSize:10,color:'var(--text2)',marginLeft:4}}>Сорт.:</span>
              <select className="filter-select" style={{fontSize:10,padding:'2px 4px'}} value={kbSortBy2} onChange={e=>setKbSortBy2(e.target.value)}>
                <option value="priority">Приоритет</option><option value="deadline">Дедлайн</option><option value="title">Название</option><option value="status">Статус</option>
              </select>
            </React.Fragment>}
          </div>
          <div style={{display:'flex',gap:4,alignItems:'center'}}>
            {savedViews.map(sv=><span key={sv.id} className="filter-chip" style={{position:'relative',paddingRight:18}} onClick={()=>loadView(sv)}>{sv.name||'View'}<span style={{position:'absolute',right:4,top:1,fontSize:10,cursor:'pointer',opacity:.5,fontWeight:700}} onClick={e=>{e.stopPropagation();deleteView(sv.id);}}>×</span></span>)}
            <span className="filter-chip" style={{borderStyle:'dashed',cursor:'pointer'}} onClick={()=>{const nm=prompt('Название вида:');if(nm)saveCurrentView(nm);}}>+ Сохранить вид</span>
          </div>
        </div>
        {/* Быстрые фильтры */}
        <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:8,alignItems:'center'}}>
          <span style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginRight:2}}>Фильтр:</span>
          <span className={'filter-chip'+(tasksProjFilter.length===0?' active':'')} onClick={()=>setTasksProjFilter([])}>Все</span>
          <span className="filter-chip" style={{background:'var(--bg1)',borderStyle:'dashed'}} onClick={()=>filterByWG('РГ1')}>РГ1</span>
          <span className="filter-chip" style={{background:'var(--bg1)',borderStyle:'dashed'}} onClick={()=>filterByWG('РГ2')}>РГ2</span>
          <span className="filter-chip" style={{background:'var(--bg1)',borderStyle:'dashed',color:'var(--red)'}} onClick={()=>filterBySeg(1)}>S1</span>
          <span className="filter-chip" style={{background:'var(--bg1)',borderStyle:'dashed',color:'var(--amber)'}} onClick={()=>filterBySeg(2)}>S2</span>
          <span className="filter-chip" style={{background:'var(--bg1)',borderStyle:'dashed',color:'var(--sky)'}} onClick={()=>filterBySeg(3)}>S3</span>
          <span className="filter-chip" style={{background:'var(--bg1)',borderStyle:'dashed',color:'var(--green)'}} onClick={()=>filterBySeg(4)}>S4</span>
        </div>
        {/* Проекты */}
        <div style={{display:'flex',gap:5,flexWrap:'wrap',marginBottom:12,alignItems:'center'}}>
          <span style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginRight:2}}>Проекты:</span>
          {activeProjs.map(pr=><span key={pr.id} className={'filter-chip'+(tasksProjFilter.includes(pr.id)?' active':'')} onClick={()=>selectProj(pr.id)}>{pr.code}</span>)}
        </div>
        {/* Доп. фильтры: дедлайн, сегмент проекта, ответственный */}
        <div style={{display:'flex',gap:8,flexWrap:'wrap',marginBottom:10,alignItems:'center'}}>
          <div style={{display:'flex',gap:2,background:'var(--bg2)',borderRadius:8,padding:2}}>
            <span onClick={()=>setKbDoneFilter('active')} style={{cursor:'pointer',fontSize:10,fontWeight:600,padding:'3px 8px',borderRadius:6,transition:'all .15s',background:kbDoneFilter==='active'?'var(--accent)':'transparent',color:kbDoneFilter==='active'?'#fff':'var(--text2)'}}>Активные</span>
            <span onClick={()=>setKbDoneFilter('all')} style={{cursor:'pointer',fontSize:10,fontWeight:600,padding:'3px 8px',borderRadius:6,transition:'all .15s',background:kbDoneFilter==='all'?'var(--accent)':'transparent',color:kbDoneFilter==='all'?'#fff':'var(--text2)'}}>Все</span>
            <span onClick={()=>setKbDoneFilter('done')} style={{cursor:'pointer',fontSize:10,fontWeight:600,padding:'3px 8px',borderRadius:6,transition:'all .15s',background:kbDoneFilter==='done'?'var(--green)':'transparent',color:kbDoneFilter==='done'?'#fff':'var(--text2)'}}>✅ Готовые</span>
          </div>
          <select className="filter-select" style={{fontSize:11,padding:'2px 6px'}} value={kbDeadline} onChange={e=>setKbDeadline(e.target.value)}>
            <option value="">Дедлайн: все</option><option value="overdue">🔴 Просрочено</option><option value="3d">⚡ До 3 дней</option><option value="7d">📅 До 7 дней</option><option value="30d">📆 До 30 дней</option><option value="none">∅ Без дедлайна</option>
          </select>
          <select className="filter-select" style={{fontSize:11,padding:'2px 6px'}} value={kbSeg} onChange={e=>setKbSeg(e.target.value)}>
            <option value="">Сегмент: все</option><option value="1">🔴 S1 Критич.</option><option value="2">🟡 S2 Внимание</option><option value="3">🔵 S3 Наблюд.</option><option value="4">🟢 S4 Спокойн.</option>
          </select>
          <select className="filter-select" style={{fontSize:11,padding:'2px 6px'}} value={kbAssignee} onChange={e=>setKbAssignee(e.target.value)}>
            <option value="">Ответственный: все</option>
            {(()=>{const ids=new Set();const opts=[];crossTasks.forEach(t=>{if(t.assigned_to_id&&!ids.has(t.assigned_to_id)){ids.add(t.assigned_to_id);opts.push({id:t.assigned_to_id,name:t.assignee_name||'?'});}});return opts.sort((a,b)=>a.name.localeCompare(b.name)).map(o=><option key={o.id} value={o.id}>{o.name}</option>);})()}
          </select>
          {(kbDeadline||kbSeg||kbAssignee||kbDoneFilter!=='active')&&<button className="btn btn-secondary btn-sm" style={{fontSize:10,padding:'2px 8px'}} onClick={()=>{setKbDeadline('');setKbSeg('');setKbAssignee('');setKbDoneFilter('active');}}>✕ Сбросить</button>}
        </div>

        {/* Треки + Информационная панель */}
        {tasksProjFilter.length>0&&(()=>{
          const filtProjs=activeProjs.filter(pr=>tasksProjFilter.includes(pr.id));
          const isSingle=filtProjs.length===1;
          const sp=isSingle?filtProjs[0]:null;

          /* Треки (только для одного проекта) */
          const tracksBlock=sp?<div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:10,alignItems:'center'}}>
            <span style={{fontSize:11,fontWeight:600,color:'var(--text2)'}}>Треки:</span>
            {(sp.tracks||[]).map(tr=><span key={tr.id} style={{display:'inline-flex',gap:4,alignItems:'center',fontSize:10,padding:'2px 8px',borderRadius:10,background:'var(--bg3)',border:'1px solid var(--border)'}}><strong>{tr.track_code}</strong> {tr.track_name} {SB(tr.status)}</span>)}
            {(sp.tracks||[]).length===0&&<span style={{fontSize:11,color:'var(--text2)',fontStyle:'italic'}}>Нет треков</span>}
          </div>:null;

          /* Сводные данные (сумма по всем отфильтрованным проектам) */
          const allPays=filtProjs.flatMap(pr=>pr.payments||[]);
          const paid=allPays.filter(x=>x.status==='PAID').reduce((s,x)=>s+(Number(x.amount)||0),0);
          const accrued=allPays.filter(x=>x.status==='ACCRUED').reduce((s,x)=>s+(Number(x.amount)||0),0);
          const planned=allPays.filter(x=>x.status==='PLANNED').reduce((s,x)=>s+(Number(x.amount)||0),0);
          const totalCV=filtProjs.reduce((s,pr)=>s+(Number(pr.total_contract_value)||Number(pr.fixed_price)||0),0);
          const allMs=filtProjs.flatMap(pr=>(pr.milestones||[]));
          const mss=allMs.filter(m=>!m.is_enabler);
          const ens=allMs.filter(m=>m.is_enabler);

          /* Триаж: для одного — его данные; для группы — среднее/мин */
          const triages=filtProjs.map(pr=>calcTriage(pr));
          const avgSeg=isSingle?triages[0].segment:Math.round(triages.reduce((s,t)=>s+(t.segment||4),0)/triages.length);
          const minBuf=triages.reduce((m,t)=>t.daysRemaining!==null&&(m===null||t.daysRemaining<m)?t.daysRemaining:m,null);
          const worstBufColor=triages.some(t=>t.bufferColor==='red')?'red':triages.some(t=>t.bufferColor==='yellow')?'yellow':'green';
          const bufC=worstBufColor==='red'?'var(--red)':worstBufColor==='yellow'?'var(--amber)':'var(--green)';

          const panelTitle=isSingle?sp.code+' — '+sp.name:filtProjs.length+' проектов';

          return <React.Fragment>
            {tracksBlock}
            <div style={{fontSize:12,fontWeight:700,color:'var(--text)',marginBottom:6}}>{panelTitle}</div>
            <div className="proj-info-panel">
              <div className="pi-section" style={{borderColor:bufC}}>
                <div className="pi-label">{isSingle?'Триаж':'Сводный триаж'}</div>
                <div className="pi-value" style={{color:bufC}}>{isSingle?'S'+avgSeg:'≈S'+avgSeg}</div>
                <div style={{fontSize:11,color:'var(--text2)'}}>{isSingle?'Буфер':'Мин. буфер'}: <strong style={{color:bufC}}>{minBuf!==null?minBuf:'—'} дн.</strong></div>
                {!isSingle&&<div style={{fontSize:10,color:'var(--text2)',marginTop:2}}>
                  {triages.filter(t=>t.segment===1).length>0&&<span style={{color:'var(--red)'}}>S1: {triages.filter(t=>t.segment===1).length} </span>}
                  {triages.filter(t=>t.segment===2).length>0&&<span style={{color:'var(--amber)'}}>S2: {triages.filter(t=>t.segment===2).length} </span>}
                  {triages.filter(t=>t.segment===3).length>0&&<span style={{color:'var(--sky)'}}>S3: {triages.filter(t=>t.segment===3).length} </span>}
                  {triages.filter(t=>t.segment===4).length>0&&<span style={{color:'var(--green)'}}>S4: {triages.filter(t=>t.segment===4).length} </span>}
                </div>}
              </div>
              <div className="pi-section" style={{borderColor:'var(--emerald)'}}>
                <div className="pi-label">Оплаты{!isSingle?' (сумма)':''}</div>
                <div style={{fontSize:12}}><span style={{color:'var(--green)',fontWeight:700}}>✓ {fmt(paid)}</span> <span style={{color:'var(--text2)'}}>оплач.</span></div>
                <div style={{fontSize:12}}><span style={{color:'var(--amber)',fontWeight:700}}>◎ {fmt(accrued)}</span> <span style={{color:'var(--text2)'}}>начисл.</span></div>
                <div style={{fontSize:12}}><span style={{color:'var(--text2)',fontWeight:700}}>○ {fmt(planned)}</span> <span style={{color:'var(--text2)'}}>план</span></div>
                <div style={{fontSize:10,color:'var(--text2)',marginTop:2}}>Итого: {fmt(totalCV)} ₽</div>
              </div>
              <div className="pi-section" style={{borderColor:'var(--amber)'}}>
                <div className="pi-label">Вехи ({mss.length})</div>
                {mss.length===0?<div style={{fontSize:11,color:'var(--text2)',fontStyle:'italic'}}>Нет вех</div>:mss.slice(0,8).map(m=><div key={m.id} style={{fontSize:11,marginBottom:2}}>{m.status==='DONE'?'✅':'🏁'} {!isSingle?<span style={{color:'var(--accent2)',fontSize:9,marginRight:3}}>{(filtProjs.find(pr=>(pr.milestones||[]).some(mm=>mm.id===m.id))||{}).code}</span>:null}{m.name}{m.target_date?' · '+fmtD(m.target_date):''}</div>)}
                {mss.length>8&&<div style={{fontSize:10,color:'var(--text2)',fontStyle:'italic'}}>...и ещё {mss.length-8}</div>}
              </div>
              <div className="pi-section" style={{borderColor:'var(--sky)'}}>
                <div className="pi-label">Энейблеры ({ens.length})</div>
                {ens.length===0?<div style={{fontSize:11,color:'var(--text2)',fontStyle:'italic'}}>Нет энейблеров</div>:ens.slice(0,8).map(m=><div key={m.id} style={{fontSize:11,marginBottom:2,color:'var(--sky)'}}>{m.status==='DONE'?'✅':'📞'} {!isSingle?<span style={{color:'var(--accent2)',fontSize:9,marginRight:3}}>{(filtProjs.find(pr=>(pr.milestones||[]).some(mm=>mm.id===m.id))||{}).code}</span>:null}{m.name}{m.target_date?' · '+fmtD(m.target_date):''}</div>)}
                {ens.length>8&&<div style={{fontSize:10,color:'var(--text2)',fontStyle:'italic'}}>...и ещё {ens.length-8}</div>}
              </div>
            </div>
          </React.Fragment>;
        })()}

        {/* ──── Канбан-доска ──── */}
        {kbMode==='kanban'&&<div className="cross-kanban">
          {kanbanCols.map((kc,kci)=>{
            const colTasks=filtered.filter(t=>(t.status||'TODO')===kc.key);
            const isBase=['TODO','IN_PROGRESS','DONE','BLOCKED'].includes(kc.key);
            return <div key={kc.key} className="cross-kanban-col" onDragOver={onDragOver2} onDragLeave={onDragLeave2} onDrop={e=>onDrop2(e,kc.key)}>
              <div className="cross-kanban-head" style={{color:kc.color,background:kc.bg}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                  <span style={{flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',cursor:'pointer'}} title="Двойной клик — переименовать" onDoubleClick={e=>{e.stopPropagation();const nn=prompt('Новое название:',kc.label);if(nn&&nn!==kc.label){if(isBase){store.renameBaseStatus(kc.key,nn);}else{store.updateGlobalTaskStatus(kc.key,{label:nn});}}}}>{kc.label} <span style={{opacity:.5}}>({colTasks.length})</span></span>
                  <span style={{display:'flex',gap:1,flexShrink:0,marginLeft:4}}>
                    {kci>0&&<span style={{cursor:'pointer',opacity:.4,fontSize:11,padding:'0 2px',borderRadius:3}} title="Сдвинуть влево" onClick={e=>{e.stopPropagation();store.moveGlobalStatusOrder(kc.key,'left');}}>◀</span>}
                    {kci<kanbanCols.length-1&&<span style={{cursor:'pointer',opacity:.4,fontSize:11,padding:'0 2px',borderRadius:3}} title="Сдвинуть вправо" onClick={e=>{e.stopPropagation();store.moveGlobalStatusOrder(kc.key,'right');}}>▶</span>}
                    {!isBase&&<span style={{cursor:'pointer',opacity:.4,fontSize:12,padding:'0 2px'}} title="Удалить колонку" onClick={e=>{e.stopPropagation();if(colTasks.length>0){alert('Переместите задачи из колонки перед удалением');}else{if(confirm('Удалить статус «'+kc.label+'»?'))store.removeGlobalTaskStatus(kc.key);}}}>✕</span>}
                  </span>
                </div>
              </div>
              {colTasks.map(tsk=>{
                const proj2=activeProjs.find(pr=>pr.id===tsk._projId);
                const trk2=proj2?(proj2.tracks||[]).find(x=>x.id===tsk.track_id):null;
                const dlDays=tsk.deadline?Math.ceil((new Date(tsk.deadline)-new Date())/(864e5)):null;
                const dlC=dlDays===null?'var(--text2)':dlDays<0?'var(--red)':dlDays<=3?'var(--amber)':'var(--green)';
                const _pTri=_projTriMap[tsk._projId];
                const _segC=_pTri?(_pTri.segment===1?'var(--red)':_pTri.segment===2?'var(--amber)':_pTri.segment===3?'var(--sky)':'var(--green)'):'var(--accent)';
                return <div key={tsk._projId+'_'+tsk.id} className="cross-task-card" draggable onDragStart={e=>onDragStart2(e,tsk.id,tsk._projId)} onDragEnd={onDragEnd2} onClick={()=>setEditCrossTask({task:tsk,projId:tsk._projId,projCode:tsk._projCode})}>
                  <div style={{display:'flex',gap:4,alignItems:'center',marginBottom:3}}>
                    <span className="proj-badge" style={{background:_segC}}>{tsk._projCode}</span>
                    <span style={{fontSize:9,color:'var(--text2)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',maxWidth:120}}>{tsk._projName}</span>
                  </div>
                  <div style={{display:'flex',alignItems:'flex-start',gap:4,marginBottom:3}}>
                    <div style={{flex:1,fontSize:12,fontWeight:600}}>{tsk.title}</div>
                    {(tsk.status||'TODO')!=='DONE'&&<span title="Отметить готовой" onClick={e=>{e.stopPropagation();store.updateTaskStatus(tsk._projId,tsk.id,'DONE');}} style={{cursor:'pointer',fontSize:14,lineHeight:'16px',width:20,height:20,display:'flex',alignItems:'center',justifyContent:'center',borderRadius:6,border:'1.5px solid var(--green)',color:'var(--green)',flexShrink:0,transition:'all .15s',background:'transparent'}} onMouseEnter={e=>{e.currentTarget.style.background='var(--green)';e.currentTarget.style.color='#fff';}} onMouseLeave={e=>{e.currentTarget.style.background='transparent';e.currentTarget.style.color='var(--green)';}}>✓</span>}
                    {(tsk.status||'TODO')==='DONE'&&<span title="Вернуть в работу" onClick={e=>{e.stopPropagation();store.updateTaskStatus(tsk._projId,tsk.id,'TODO');}} style={{cursor:'pointer',fontSize:14,lineHeight:'16px',width:20,height:20,display:'flex',alignItems:'center',justifyContent:'center',borderRadius:6,background:'var(--green)',color:'#fff',flexShrink:0,transition:'all .15s'}} onMouseEnter={e=>{e.currentTarget.style.opacity='.7';}} onMouseLeave={e=>{e.currentTarget.style.opacity='1';}}>✓</span>}
                  </div>
                  <div style={{display:'flex',gap:4,flexWrap:'wrap',alignItems:'center'}}>
                    {trk2&&<span style={{fontSize:9,padding:'1px 5px',borderRadius:6,background:'var(--bg1)',border:'1px solid var(--border)',fontWeight:600}}>{trk2.track_name}</span>}
                    {tsk.assignee_name&&<span style={{fontSize:9,color:'var(--text2)'}}>👤 {tsk.assignee_name}</span>}
                    {tsk.deadline&&<span style={{fontSize:9,color:dlC}}>{tsk.deadline}{dlDays!==null&&(dlDays<0?' !'+Math.abs(dlDays)+'д':' '+dlDays+'д')}</span>}
                    <span style={{fontSize:9,color:prioColors[tsk.priority||3]}}>P{tsk.priority||3}</span>
                  </div>
                </div>;
              })}
              {colTasks.length===0&&<div style={{fontSize:10,color:'var(--text2)',fontStyle:'italic',padding:8,textAlign:'center'}}>—</div>}
            </div>;
          })}
          {/* ＋ Новая колонка */}
          <div style={{minWidth:80,display:'flex',alignItems:'flex-start',justifyContent:'center',paddingTop:8}}>
            <button className="btn btn-secondary btn-sm" style={{fontSize:11,padding:'6px 12px',borderStyle:'dashed',borderRadius:10,opacity:.7,whiteSpace:'nowrap'}} onClick={()=>{
              const name=prompt('Название нового статуса:');if(!name)return;
              const key=name.toUpperCase().replace(/[^A-ZА-ЯЁ0-9]/gi,'_').substring(0,20)+'_'+Date.now().toString(36);
              const col=prompt('Цвет (#hex или CSS var, по умолчанию #8b5cf6):','#8b5cf6')||'#8b5cf6';
              /* Определяем order — перед DONE (order=90) */
              const existingOrders=kanbanCols.map(c=>c.order).filter(o=>o<90);
              const maxBefore=existingOrders.length?Math.max(...existingOrders):10;
              const newOrder=maxBefore+((90-maxBefore)/2);
              store.addGlobalTaskStatus({key,label:name,color:col,bg:col+'18',order:newOrder});
            }}>+ Колонка</button>
          </div>
        </div>}

        {/* ──── Табличный вид ──── */}
        {kbMode==='table'&&(()=>{
          const stLbl={};kanbanCols.forEach(c=>{stLbl[c.key]=c.label;});
          const prioLbl={1:'🔴 P1',2:'🟠 P2',3:'🟡 P3',4:'🟢 P4',5:'⚪ P5'};
          const segLbl={1:'🔴 S1',2:'🟡 S2',3:'🔵 S3',4:'🟢 S4'};
          /* Группировка */
          const getGroupKey=(tsk)=>{
            if(kbGroupBy==='status')return tsk.status||'TODO';
            if(kbGroupBy==='project')return tsk._projId;
            if(kbGroupBy==='assignee')return tsk.assigned_to_id||'_none';
            if(kbGroupBy==='priority')return String(tsk.priority||3);
            if(kbGroupBy==='track')return tsk.track_id||'_none';
            if(kbGroupBy==='segment'){const tri=_projTriMap[tsk._projId];return String(tri?tri.segment:0);}
            return 'all';
          };
          const getGroupLabel=(key)=>{
            if(kbGroupBy==='status')return stLbl[key]||key;
            if(kbGroupBy==='project'){const pr=activeProjs.find(p=>p.id===key);return pr?pr.code+' — '+pr.name:key;}
            if(kbGroupBy==='assignee'){if(key==='_none')return '— Не назначен —';const tsk=filtered.find(t=>(t.assigned_to_id||'_none')===key);return tsk?tsk.assignee_name||key:key;}
            if(kbGroupBy==='priority')return prioLbl[Number(key)]||'P'+key;
            if(kbGroupBy==='track'){if(key==='_none')return '— Без трека —';for(const pr of activeProjs){const tr=(pr.tracks||[]).find(t=>t.id===key);if(tr)return tr.track_code+' — '+tr.track_name;}return key;}
            if(kbGroupBy==='segment')return segLbl[Number(key)]||'—';
            return key;
          };
          /* Сортировка */
          const sortFn=(a,b)=>{
            if(kbSortBy2==='priority')return (a.priority||3)-(b.priority||3);
            if(kbSortBy2==='deadline'){const da=a.deadline||'9999';const db=b.deadline||'9999';return da.localeCompare(db);}
            if(kbSortBy2==='title')return (a.title||'').localeCompare(b.title||'');
            if(kbSortBy2==='status'){const ord={TODO:0,IN_PROGRESS:1,BLOCKED:2,DONE:3};return (ord[a.status]||0)-(ord[b.status]||0);}
            return 0;
          };
          /* Build groups */
          const groups={};const groupOrder=[];
          [...filtered].sort(sortFn).forEach(tsk=>{
            const gk=getGroupKey(tsk);
            if(!groups[gk]){groups[gk]=[];groupOrder.push(gk);}
            groups[gk].push(tsk);
          });
          return <div style={{overflowX:'auto'}}>
            {groupOrder.map(gk=>{
              const gTasks=groups[gk];
              const isCollapsed=collapsedGroups.has(gk);
              return <div key={gk} style={{marginBottom:12}}>
                <div style={{display:'flex',alignItems:'center',gap:8,padding:'6px 8px',background:'var(--bg2)',borderRadius:8,cursor:'pointer',userSelect:'none',marginBottom:isCollapsed?0:4}} onClick={()=>toggleGroup(gk)}>
                  <span style={{fontSize:12,transition:'transform .15s',transform:isCollapsed?'rotate(0deg)':'rotate(90deg)',display:'inline-block'}}>▶</span>
                  <span style={{fontSize:13,fontWeight:700}}>{getGroupLabel(gk)}</span>
                  <span style={{fontSize:11,color:'var(--text2)'}}>({gTasks.length})</span>
                </div>
                {!isCollapsed&&<table className="project-table" style={{fontSize:11}}>
                  <thead><tr>
                    <th style={{width:28}}></th>
                    <th style={{width:30}}>#</th>
                    <th>Задача</th>
                    <th style={{width:70}}>Проект</th>
                    <th style={{width:100}}>Ответственный</th>
                    <th style={{width:70}}>Статус</th>
                    <th style={{width:40}}>P</th>
                    <th style={{width:90}}>Дедлайн</th>
                    <th style={{width:100}}>Трек</th>
                    <th style={{width:40}}>S</th>
                  </tr></thead>
                  <tbody>{gTasks.map((tsk,i)=>{
                    const _tri2=_projTriMap[tsk._projId];
                    const _seg2=_tri2?_tri2.segment:null;
                    const _segC2=_seg2===1?'var(--red)':_seg2===2?'var(--amber)':_seg2===3?'var(--sky)':'var(--green)';
                    const dlDays2=tsk.deadline?Math.ceil((new Date(tsk.deadline)-new Date())/(864e5)):null;
                    const dlC2=dlDays2===null?'var(--text2)':dlDays2<0?'var(--red)':dlDays2<=3?'var(--amber)':'var(--green)';
                    const proj3=activeProjs.find(pr=>pr.id===tsk._projId);
                    const trk3=proj3?(proj3.tracks||[]).find(x=>x.id===tsk.track_id):null;
                    const isDone2=(tsk.status||'TODO')==='DONE';
                    return <tr key={tsk._projId+'_'+tsk.id} className="clickable" style={isDone2?{opacity:.55}:{}} onClick={()=>setEditCrossTask({task:tsk,projId:tsk._projId,projCode:tsk._projCode})}>
                      <td style={{textAlign:'center',padding:'2px 0'}}>{isDone2
                        ?<span title="Вернуть в работу" onClick={e=>{e.stopPropagation();store.updateTaskStatus(tsk._projId,tsk.id,'TODO');}} style={{cursor:'pointer',display:'inline-flex',alignItems:'center',justifyContent:'center',width:18,height:18,borderRadius:5,background:'var(--green)',color:'#fff',fontSize:12,fontWeight:700}}>✓</span>
                        :<span title="Отметить готовой" onClick={e=>{e.stopPropagation();store.updateTaskStatus(tsk._projId,tsk.id,'DONE');}} style={{cursor:'pointer',display:'inline-flex',alignItems:'center',justifyContent:'center',width:18,height:18,borderRadius:5,border:'1.5px solid var(--border)',color:'var(--text2)',fontSize:12,transition:'all .15s'}} onMouseEnter={e=>{e.currentTarget.style.borderColor='var(--green)';e.currentTarget.style.color='var(--green)';}} onMouseLeave={e=>{e.currentTarget.style.borderColor='var(--border)';e.currentTarget.style.color='var(--text2)';}}>✓</span>
                      }</td>
                      <td style={{color:'var(--text2)'}}>{i+1}</td>
                      <td style={{fontWeight:600,textDecoration:isDone2?'line-through':'none'}}>{tsk.title}</td>
                      <td><span style={{fontSize:9,fontWeight:700,padding:'1px 5px',borderRadius:8,background:_segC2,color:'#fff'}}>{tsk._projCode}</span></td>
                      <td style={{color:'var(--text2)'}}>{tsk.assignee_name||'—'}</td>
                      <td>{stLbl[tsk.status||'TODO']||tsk.status}</td>
                      <td style={{color:prioColors[tsk.priority||3],fontWeight:700}}>P{tsk.priority||3}</td>
                      <td style={{color:dlC2,whiteSpace:'nowrap'}}>{tsk.deadline?fmtD(tsk.deadline):'—'}{dlDays2!==null&&<span style={{fontSize:9,marginLeft:3}}>{dlDays2<0?'!'+Math.abs(dlDays2)+'д':dlDays2+'д'}</span>}</td>
                      <td style={{fontSize:10}}>{trk3?trk3.track_name:'—'}</td>
                      <td>{_seg2?<span style={{color:_segC2,fontWeight:700}}>S{_seg2}</span>:'—'}</td>
                    </tr>;
                  })}</tbody>
                </table>}
              </div>;
            })}
            {groupOrder.length===0&&<div style={{padding:20,textAlign:'center',color:'var(--text2)',fontSize:12}}>Нет задач по текущим фильтрам</div>}
          </div>;
        })()}

        {/* Модалка редактирования задачи */}
        {editCrossTask&&(()=>{
          const et=editCrossTask.task;
          const ep=activeProjs.find(pr=>pr.id===editCrossTask.projId);
          const eTracks=ep?(ep.tracks||[]):[];
          const eTrk=eTracks.find(x=>x.id===et.track_id);
          const eDlDays=et.deadline?Math.ceil((new Date(et.deadline)-new Date())/(864e5)):null;
          const eDlC=eDlDays===null?'var(--text2)':eDlDays<0?'var(--red)':eDlDays<=3?'var(--amber)':'var(--green)';
          return <Modal onClose={()=>setEditCrossTask(null)}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}><h2 style={{margin:0,fontSize:18}}>{et.title||'Задача'}</h2><span className="proj-badge" style={{fontSize:11}}>{editCrossTask.projCode}</span></div>
            <div className="form-group"><label>Название</label><input value={et.title||''} onChange={e=>{const v=e.target.value;store.updateTask(editCrossTask.projId,et.id,{title:v});setEditCrossTask(x=>({...x,task:{...x.task,title:v}}));}}/></div>
            <div style={{display:'flex',gap:12,flexWrap:'wrap'}}>
              <div className="form-group" style={{flex:1,minWidth:170}}><label>Приоритет</label><select value={et.priority||3} onChange={e=>{const v=Number(e.target.value);store.updateTask(editCrossTask.projId,et.id,{priority:v});setEditCrossTask(x=>({...x,task:{...x.task,priority:v}}));}}>
                <option value={1}>🔴 1 — Критический</option><option value={2}>🟠 2 — Высокий</option><option value={3}>🟡 3 — Средний</option><option value={4}>🟢 4 — Низкий</option><option value={5}>⚪ 5 — Минимальный</option>
              </select></div>
              <div className="form-group" style={{flex:1,minWidth:170}}><label>Статус</label><select value={et.status||'TODO'} onChange={e=>{const v=e.target.value;store.updateTaskStatus(editCrossTask.projId,et.id,v);setEditCrossTask(x=>({...x,task:{...x.task,status:v}}));}}>
                {kanbanCols.map(sc=><option key={sc.key} value={sc.key}>{sc.label}</option>)}
              </select></div>
            </div>
            <div style={{display:'flex',gap:12,flexWrap:'wrap'}}>
              <div className="form-group" style={{flex:1,minWidth:170}}><label>Исполнитель</label><select value={et.assigned_to_id||''} onChange={e=>{const v=e.target.value;const nm=(store.data.persons.find(pp=>pp.id===v)||{}).name||'';store.updateTask(editCrossTask.projId,et.id,{assigned_to_id:v||null,assignee_name:nm});setEditCrossTask(x=>({...x,task:{...x.task,assigned_to_id:v,assignee_name:nm}}));}}>
                <option value="">— Не назначен —</option>{store.data.persons.filter(pe=>pe.is_active).map(pe=><option key={pe.id} value={pe.id}>{pe.name}</option>)}
              </select></div>
              <div className="form-group" style={{flex:1,minWidth:170}}><label>Трек</label><select value={et.track_id||''} onChange={e=>{const v=e.target.value;store.updateTask(editCrossTask.projId,et.id,{track_id:v||null});setEditCrossTask(x=>({...x,task:{...x.task,track_id:v}}));}}>
                <option value="">— Без трека —</option>{eTracks.map(t2=><option key={t2.id} value={t2.id}>{t2.track_code} — {t2.track_name}</option>)}
              </select></div>
            </div>
            <div style={{display:'flex',gap:12,flexWrap:'wrap'}}>
              <div className="form-group" style={{flex:1,minWidth:170}}><label>Дедлайн</label><input type="date" value={et.deadline||''} onChange={e=>{const v=e.target.value;store.updateTask(editCrossTask.projId,et.id,{deadline:v});setEditCrossTask(x=>({...x,task:{...x.task,deadline:v}}));}} style={{color:eDlC}}/>{eDlDays!==null&&<span style={{fontSize:11,color:eDlC,marginTop:2}}>{eDlDays<0?'Просрочено на '+Math.abs(eDlDays)+' дн.':eDlDays===0?'Сегодня':'Осталось '+eDlDays+' дн.'}</span>}</div>
              <div className="form-group" style={{flex:1,minWidth:170}}><label>Описание</label><textarea value={et.description||''} onChange={e=>{const v=e.target.value;store.updateTask(editCrossTask.projId,et.id,{description:v});setEditCrossTask(x=>({...x,task:{...x.task,description:v}}));}} rows={3} placeholder="Описание задачи..."/></div>
            </div>
            {eTrk&&<div style={{fontSize:12,color:'var(--text2)',marginTop:4,padding:'6px 10px',background:'var(--bg1)',borderRadius:6}}>Трек: <strong style={{color:'var(--accent)'}}>{eTrk.track_code}</strong> — {eTrk.track_name}</div>}
            <div className="form-actions" style={{marginTop:12}}>
              <button className="btn btn-danger" onClick={()=>{if(confirm('Удалить задачу «'+et.title+'»?')){store.deleteTask(editCrossTask.projId,et.id);setEditCrossTask(null);}}}>Удалить</button>
              <button className="btn btn-primary" onClick={()=>setEditCrossTask(null)}>Закрыть</button>
            </div>
          </Modal>;
        })()}

        <div style={{marginTop:10,textAlign:'center'}}><span style={{fontSize:11,color:'var(--text2)'}}>{filtered.length} задач из {activeProjs.length} активных проектов</span></div>
      </div>;
    })()}

    {showNew&&<NewProjectModal store={store} onClose={()=>setShowNew(false)}/>}
  </div>;
}

/* ===== ERROR BOUNDARY ===== */
class ErrorBoundary extends React.Component{
  constructor(props){super(props);this.state={error:null,info:null};}
  static getDerivedStateFromError(e){return{error:e};}
  componentDidCatch(e,info){this.setState({info});console.error('ErrorBoundary caught:',e,info);}
  render(){
    if(this.state.error)return React.createElement('div',{style:{padding:20,margin:20,background:'#fff0f0',border:'2px solid red',borderRadius:8}},
      React.createElement('h3',{style:{color:'red',margin:'0 0 8px'}},'Ошибка рендеринга'),
      React.createElement('pre',{style:{whiteSpace:'pre-wrap',fontSize:12,color:'#333'}},String(this.state.error)),
      this.state.info&&React.createElement('pre',{style:{whiteSpace:'pre-wrap',fontSize:10,color:'#666',marginTop:8}},this.state.info.componentStack),
      React.createElement('button',{style:{marginTop:12,padding:'6px 16px',cursor:'pointer'},onClick:()=>this.setState({error:null,info:null})},'Попробовать снова')
    );
    return this.props.children;
  }
}
/* ===== CRITICAL CHAIN (CPM) ===== */
function computeCriticalChain(tracks){
  const dated=tracks.filter(t=>t.start_date&&t.end_date);
  if(dated.length===0)return{criticalIds:new Set(),slacks:{}};
  const toDay=d=>Math.floor(new Date(d).getTime()/864e5);
  const nodes={};
  dated.forEach(t=>{nodes[t.id]={id:t.id,es:toDay(t.start_date),ef:toDay(t.end_date),dur:toDay(t.end_date)-toDay(t.start_date),ls:Infinity,lf:Infinity,deps:(t.dependencies||[]).map(d=>({tid:d.target_track_id,lag:d.lag_days||0}))};});
  // Forward pass: ES/EF already set from dates, but adjust for deps
  const ids=Object.keys(nodes);
  let changed=true,iter=0;
  while(changed&&iter<100){changed=false;iter++;
    ids.forEach(id=>{const n=nodes[id];
      n.deps.forEach(d=>{const pred=nodes[d.tid];if(!pred)return;
        const minStart=pred.ef+d.lag;
        if(minStart>n.es){n.es=minStart;n.ef=n.es+n.dur;changed=true;}
      });
    });
  }
  // Backward pass
  let maxEf=0;ids.forEach(id=>{if(nodes[id].ef>maxEf)maxEf=nodes[id].ef;});
  ids.forEach(id=>{nodes[id].lf=maxEf;nodes[id].ls=maxEf-nodes[id].dur;});
  changed=true;iter=0;
  while(changed&&iter<100){changed=false;iter++;
    ids.forEach(id=>{const n=nodes[id];
      // find all successors
      ids.forEach(sid=>{const s=nodes[sid];
        s.deps.forEach(d=>{if(d.tid===id){
          const maxFinish=s.ls-d.lag;
          if(maxFinish<n.lf){n.lf=maxFinish;n.ls=n.lf-n.dur;changed=true;}
        }});
      });
    });
  }
  const criticalIds=new Set();const slacks={};
  ids.forEach(id=>{const n=nodes[id];const slack=n.ls-n.es;slacks[id]=slack;if(slack<=0)criticalIds.add(id);});
  return{criticalIds,slacks};
}

/* ===== GANTT CHART ===== */
function GanttChart({project:p,store,onEditTrack}){
  const tracks=p.tracks||[];
  const dated=tracks.filter(t=>t.start_date&&t.end_date);
  if(dated.length===0)return React.createElement('div',{className:'empty',style:{padding:20}},'Укажите даты начала и конца у треков для отображения диаграммы Ганта');
  const cc=computeCriticalChain(tracks);
  const toDay=d=>Math.floor(new Date(d).getTime()/864e5);
  const allDays=dated.flatMap(t=>[toDay(t.start_date),toDay(t.end_date)]);
  const minDay=Math.min(...allDays)-2;
  const todayDay=toDay(new Date().toISOString().slice(0,10));
  const maxDay=Math.max(...allDays,todayDay)+5;
  const totalDays=maxDay-minDay;
  const dayW=Math.max(28,Math.min(48,800/totalDays));
  const chartW=totalDays*dayW;

  // Build week headers
  const weeks=[];
  let wd=minDay;
  while(wd<=maxDay){const dt=new Date(wd*864e5);const mo=['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'][dt.getUTCMonth()];const dd=dt.getUTCDate();weeks.push({day:wd,label:dd+' '+mo});wd+=7;}

  const rowH=28;
  const todayX=(todayDay-minDay)*dayW;
  // Dependency arrows
  const arrows=[];
  dated.forEach((t,ri)=>{
    (t.dependencies||[]).forEach(dep=>{
      const ti=dated.findIndex(x=>x.id===dep.target_track_id);
      if(ti<0)return;
      const pred=dated[ti];
      const fromX=(toDay(pred.end_date)-minDay)*dayW;
      const fromY=ti*rowH+rowH/2;
      const toX=(toDay(t.start_date)-minDay)*dayW;
      const toY=ri*rowH+rowH/2;
      arrows.push({fromX,fromY,toX,toY,key:t.id+'-'+dep.target_track_id});
    });
  });

  return React.createElement('div',{className:'gantt-wrap'},
    React.createElement('div',{className:'gantt-legend'},
      React.createElement('span',null,React.createElement('span',{className:'gl-box',style:{background:'#94a3b8'}}),'Не начат'),
      React.createElement('span',null,React.createElement('span',{className:'gl-box',style:{background:'var(--accent)'}}),'В работе'),
      React.createElement('span',null,React.createElement('span',{className:'gl-box',style:{background:'var(--emerald)'}}),'Завершён'),
      React.createElement('span',null,React.createElement('span',{className:'gl-box',style:{background:'transparent',border:'2px solid var(--red)'}}),'Критическая цепь')
    ),
    React.createElement('div',{style:{overflowX:'auto'}},
      React.createElement('div',{style:{minWidth:180+chartW}},
        // Header
        React.createElement('div',{className:'gantt-header'},
          React.createElement('div',{className:'gantt-header-label'},'Трек'),
          React.createElement('div',{className:'gantt-header-dates',style:{width:chartW}},
            weeks.map((w,i)=>React.createElement('div',{key:i,className:'gh-cell',style:{width:dayW*7}},w.label))
          )
        ),
        // Body
        React.createElement('div',{className:'gantt-body',style:{position:'relative'}},
          // Today line
          todayX>0&&todayX<chartW&&React.createElement('div',{className:'gantt-today',style:{left:180+todayX}}),
          // Dep arrows SVG
          arrows.length>0&&React.createElement('svg',{className:'gantt-dep-svg',width:chartW,height:dated.length*rowH,style:{top:0}},
            arrows.map(a=>React.createElement('path',{key:a.key,d:'M'+a.fromX+','+a.fromY+' C'+(a.fromX+20)+','+a.fromY+' '+(a.toX-20)+','+a.toY+' '+a.toX+','+a.toY,stroke:'var(--text2)',strokeWidth:1.5,fill:'none',markerEnd:'url(#arrowhead)',opacity:.5})),
            React.createElement('defs',null,React.createElement('marker',{id:'arrowhead',markerWidth:8,markerHeight:6,refX:8,refY:3,orient:'auto'},React.createElement('polygon',{points:'0 0, 8 3, 0 6',fill:'var(--text2)'})))
          ),
          // Track rows
          dated.map((t,i)=>{
            const x=(toDay(t.start_date)-minDay)*dayW;
            const w=Math.max(dayW/2,(toDay(t.end_date)-toDay(t.start_date))*dayW);
            const isCrit=cc.criticalIds.has(t.id);
            const slack=cc.slacks[t.id]||0;
            return React.createElement('div',{key:t.id,className:'gantt-row'},
              React.createElement('div',{className:'gantt-row-label',onClick:()=>onEditTrack&&onEditTrack(t),title:t.track_name},
                React.createElement('span',{style:{fontWeight:600}},t.track_code),' ',t.track_name
              ),
              React.createElement('div',{className:'gantt-row-bars',style:{width:chartW}},
                React.createElement('div',{
                  className:'gantt-bar st-'+t.status+(isCrit?' critical':''),
                  style:{left:x,width:w},
                  onClick:()=>onEditTrack&&onEditTrack(t),
                  title:t.track_code+': '+t.start_date+' → '+t.end_date+(isCrit?' [КРИТ. ЦЕПЬ]':' slack: '+slack+'д')
                },React.createElement('span',{className:'gb-text'},t.track_code))
              )
            );
          })
        )
      )
    )
  );
}

/* ===== EDIT TRACK MODAL ===== */
function EditTrackModal({track:t,project:p,store,onClose}){
  const [etTab,setEtTab]=useState('dates');
  const [sd,setSd]=useState(t.start_date||'');
  const [ed,setEd]=useState(t.end_date||'');
  const [deps,setDeps]=useState(t.dependencies||[]);
  const [newDepTrack,setNewDepTrack]=useState('');
  /* type state removed — simple predecessor model */
  const [editDepIdx,setEditDepIdx]=useState(null);
  const [newDepLag,setNewDepLag]=useState(0);
  const dur=sd&&ed?Math.max(0,Math.ceil((new Date(ed)-new Date(sd))/864e5)):0;
  const otherTracks=(p.tracks||[]).filter(x=>x.id!==t.id);

  const handleSave=()=>{
    store.updateTrackDates(p.id,t.id,{start_date:sd,end_date:ed,dependencies:deps});
    onClose();
  };

  const handleAddDep=()=>{
    if(!newDepTrack)return;
    setDeps(d=>[...d,{id:String(Date.now()),target_track_id:newDepTrack,lag_days:Number(newDepLag)||0}]);
    setNewDepTrack('');setNewDepLag(0);
  };

  return React.createElement(Modal,{onClose},
    React.createElement('div',{className:'edit-track-modal'},
      React.createElement('h2',null,t.track_code,' — ',t.track_name),
      React.createElement('div',{className:'etm-tabs'},
        React.createElement('div',{className:'etm-tab'+(etTab==='dates'?' active':''),onClick:()=>setEtTab('dates')},'Даты'),
        React.createElement('div',{className:'etm-tab'+(etTab==='deps'?' active':''),onClick:()=>setEtTab('deps')},'Предшественники (',deps.length,')')
      ),
      etTab==='dates'&&React.createElement('div',null,
        React.createElement('div',{className:'form-row'},
          React.createElement('div',{className:'form-group'},React.createElement('label',null,'Дата начала'),React.createElement('input',{type:'date',value:sd,onChange:e=>setSd(e.target.value)})),
          React.createElement('div',{className:'form-group'},React.createElement('label',null,'Дата окончания'),React.createElement('input',{type:'date',value:ed,onChange:e=>setEd(e.target.value)}))
        ),
        dur>0&&React.createElement('div',{style:{fontSize:12,color:'var(--text2)',marginBottom:12}},'Длительность: ',dur,' дн.')
      ),
      etTab==='deps'&&React.createElement('div',null,
        deps.length>0?React.createElement('table',{className:'dep-table'},
          React.createElement('thead',null,React.createElement('tr',null,
            React.createElement('th',null,''),React.createElement('th',null,'Предшественник'),React.createElement('th',null,'Лаг'),React.createElement('th',null,'')
          )),
          React.createElement('tbody',null,deps.map((d,i)=>{
            const dt=otherTracks.find(x=>x.id===d.target_track_id);
            return React.createElement('tr',{key:d.id||i},
              React.createElement('td',null,React.createElement('span',{className:'dep-arrow-icon pred'},'←')),
              React.createElement('td',null,dt?dt.track_code+' '+dt.track_name:d.target_track_id),
              React.createElement('td',null,d.lag_days||0,' дн.'),
              React.createElement('td',null,React.createElement('button',{className:'btn btn-sm',style:{color:'var(--red)',background:'transparent',border:'none',cursor:'pointer'},onClick:()=>setDeps(x=>x.filter((_,j)=>j!==i))},'×'))
            );
          }))
        ):React.createElement('div',{className:'empty',style:{padding:8}},'Нет зависимостей'),
        React.createElement('div',{style:{marginTop:8,fontSize:10,color:'var(--text2)',marginBottom:4}},'Предшественник = трек, который должен завершиться до начала текущего'),
        React.createElement('div',{style:{marginTop:4,display:'flex',gap:6,alignItems:'flex-end',flexWrap:'wrap'}},
          React.createElement('div',{className:'form-group',style:{flex:1,minWidth:120}},
            React.createElement('label',null,'Трек'),
            React.createElement('select',{value:newDepTrack,onChange:e=>setNewDepTrack(e.target.value)},
              React.createElement('option',{value:''},'—'),
              otherTracks.filter(x=>!deps.some(d=>d.target_track_id===x.id)).map(x=>React.createElement('option',{key:x.id,value:x.id},x.track_code,' — ',x.track_name))
            )
          ),
          /* type selector removed */
          React.createElement('div',{className:'form-group',style:{width:70}},
            React.createElement('label',null,'Лаг'),
            React.createElement('input',{type:'number',value:newDepLag,onChange:e=>setNewDepLag(e.target.value),style:{width:60}})
          ),
          React.createElement('button',{className:'btn btn-primary btn-sm',style:{marginBottom:12},onClick:handleAddDep},'+')
        )
      ),
      React.createElement('div',{className:'form-actions'},
        React.createElement('button',{className:'btn btn-secondary',onClick:onClose},'Отмена'),
        React.createElement('button',{className:'btn btn-primary',onClick:handleSave},'Сохранить')
      )
    )
  );
}

function PersonAutocomplete({persons,value,onChange,onCreatePerson}){
  const [q,setQ]=useState('');
  const [open,setOpen]=useState(false);
  const ref=React.useRef(null);
  const sel=persons.find(p=>p.id===value);
  React.useEffect(()=>{if(sel&&!q)setQ(sel.name);},[value]);
  React.useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false);};document.addEventListener('mousedown',h);return()=>document.removeEventListener('mousedown',h);},[]);
  const filtered=q.trim()?persons.filter(p=>p.name.toLowerCase().includes(q.trim().toLowerCase())).slice(0,8):persons.slice(0,12);
  const pick=(p)=>{onChange(p.id);setQ(p.name);setOpen(false);};
  const handleCreate=()=>{if(!q.trim())return;const np=onCreatePerson(q.trim());if(np){onChange(np.id);setQ(np.name);setOpen(false);}};
  return <div ref={ref} style={{position:'relative'}}>
    <input value={q} onChange={e=>{setQ(e.target.value);setOpen(true);if(!e.target.value)onChange('');}} onFocus={()=>setOpen(true)} placeholder="Имя..." style={{fontSize:11,padding:'2px 4px',width:'100%'}}/>
    {open&&<div style={{position:'absolute',top:'100%',left:0,right:0,zIndex:999,background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:6,maxHeight:180,overflowY:'auto',boxShadow:'0 4px 12px rgba(0,0,0,.15)'}}>
      {filtered.map(p=><div key={p.id} style={{padding:'4px 8px',cursor:'pointer',fontSize:11,display:'flex',justifyContent:'space-between',borderBottom:'1px solid var(--bg3)'}} onMouseDown={()=>pick(p)}>
        <span>{p.name}</span>{!p.is_active&&<span style={{fontSize:9,color:'var(--red)',marginLeft:4}}>уволен</span>}
      </div>)}
      {filtered.length===0&&q.trim()&&<div style={{padding:'4px 8px',fontSize:11,color:'var(--text2)'}}>Не найдено</div>}
      {q.trim()&&!persons.find(p=>p.name.toLowerCase()===q.trim().toLowerCase())&&<div style={{padding:'4px 8px',cursor:'pointer',fontSize:11,color:'var(--accent)',fontWeight:600,borderTop:'1px solid var(--border)'}} onMouseDown={handleCreate}>+ Создать «{q.trim()}»</div>}
    </div>}
  </div>;
}

function ProjectDetail({project:p,store,onBack,initialTab,goProject}){
  const [tab,_setTab]=useState(initialTab||localStorage.getItem('pp_projTab')||'overview');
  const setTab=(t)=>{localStorage.setItem('pp_projTab',t);_setTab(t);};
  const [showAssign,setShowAssign]=useState(false);
  const [showTrack,setShowTrack]=useState(false);
  const [addTrackPhaseClass,setAddTrackPhaseClass]=useState(null);
  const [showTask,setShowTask]=useState(false);
  const [showBlocker,setShowBlocker]=useState(false);
  const [showPay,setShowPay]=useState(false);
  const [showTime,setShowTime]=useState(false);
  const [showGoal,setShowGoal]=useState(false);
  const [showSubj,setShowSubj]=useState(false);
  const [selGoal,setSelGoal]=useState(null);const [selSubj,setSelSubj]=useState(null);const [selInsight,setSelInsight]=useState(null);
  const [addInsightFor,setAddInsightFor]=useState(null);
  const [insForm,setInsForm]=useState({type:'PAIN',text:''});
  const [linkTrackFor,setLinkTrackFor]=useState(null);
  const [linkTrackSel,setLinkTrackSel]=useState('');
  /* Issue Tree v2 state */
  const [itFocused,setItFocused]=useState(null); /* {cardId,colId} */
  const [itLinkMode,setItLinkMode]=useState(null); /* {fromId,fromCol} — creating a link */
  const [itAddItem,setItAddItem]=useState(null); /* {colId} — inline add form */
  const [expandedTask,setExpandedTask]=useState(null); /* taskId for open card */
  const [showEditProject,setShowEditProject]=useState(false);
  const [showDoc,setShowDoc]=useState(false);
  const [editPhDoc,setEditPhDoc]=useState(null);
  const [docF,setDocF]=useState({name:'',doc_type:'Договор',url:'',description:'',file_data:null,file_name:''});
  const [showEditClient,setShowEditClient]=useState(false);
  const [showNewProjClient,setShowNewProjClient]=useState(false);
  const [expandedTrack,setExpandedTrack]=useState(null);
  const [editingTrack,setEditingTrack]=useState(null);
  const [editingPay,setEditingPay]=useState(null);
  const [af,setAf]=useState({person_id:'',role_code:'PM'});
  const [tf,setTf]=useState('');
  const [ndTrkPeriod,setNdTrkPeriod]=useState('');const [tkf,setTkf]=useState({title:'',priority:3,assigned_to_id:'',track_id:'',deadline:''});
  const [bf,setBf]=useState({description:'',severity:'MEDIUM',blocker_type:'INTERNAL'});
  const [pf,setPf]=useState({tranche_number:1,amount:'',planned_date:'',description:''});
  const [teRows,setTeRows]=useState([]);
  const _teAddRow=()=>setTeRows(r=>[...r,{person_id:'',month:new Date().toISOString().slice(0,7),hours:'',work_phase:'MINING_ASSEMBLING',description:''}]);
  const _teUpd=(i,k,v)=>setTeRows(r=>r.map((x,j)=>j===i?{...x,[k]:v}:x));
  const _teRm=(i)=>setTeRows(r=>r.filter((_,j)=>j!==i));
  const [ohf,setOhf]=useState({name:'',amount:'',date:'',notes:'',category:'Прочее',cls:'прочее',format:'счет',responsible:'',cf_type:'OCF',prior_year:false});
  const [gf,setGf]=useState({title:'',description:'',goal_type:'BUSINESS'});
  const [sf,setSf]=useState({name:'',role:'',goalId:'',subGoalId:''});
  const [sgForm,setSgForm]=useState({goalId:null,title:''});
  const [docFilter,setDocFilter]=useState('ALL');
  const [showEarlyComplete,setShowEarlyComplete]=useState(false);
  const [ecForm,setEcForm]=useState({received:'',lost:'',sf_claimed:'',notes:''});
  const [msForm,setMsForm]=useState(null); /* {phase_id?,name,description,target_date} */
  const [editMs,setEditMs]=useState(null);
  const [embedDoc,setEmbedDoc]=useState(null);
  const [asGoalInline,setAsGoalInline]=useState({show:false,title:'',goal_type:'BUSINESS'});
  /* Metrics Map state (must be at component level for Rules of Hooks) */
  const [mmShowImport,setMmShowImport]=useState(false);
  const [mmJsonText,setMmJsonText]=useState('');
  const [mmDragOver,setMmDragOver]=useState(false);
  const [mmShowAddNode,setMmShowAddNode]=useState(false);
  const [mmNn,setMmNn]=useState({id:'',label:'',group:'finance',fact:'',target:'',tip:'',comment:''});
  const [mmShowAddLink,setMmShowAddLink]=useState(false);
  const [mmNl,setMmNl]=useState({from:'',to:'',group:''});
  const [mmEditNode,setMmEditNode]=useState(null);
  const [mmHovNode,setMmHovNode]=useState(null);
  const [mmHovPos,setMmHovPos]=useState({x:0,y:0});
  const client=store.data.clients.find(c=>c.id===p.client_id);

  const totalHours=(p.timeEntries||[]).reduce((s,te)=>s+(Number(te.hours)||0),0);
  const calcProjectCosts=(entries)=>{
    let costAll=0,costProd=0;
    (entries||[]).forEach(te=>{
      const per=store.data.persons.find(x=>x.id===te.person_id);
      if(!per||!per.salary_monthly)return;
      const teDate=te.date||'';
      const dt=teDate?new Date(teDate):new Date();
      const day=dt.getDay();const diff=dt.getDate()-day+(day===0?-6:1);
      const wkStart=new Date(dt.getFullYear(),dt.getMonth(),diff).toISOString().slice(0,10);
      const wts=per.weekly_timesheets||[];
      const wkEntry=wts.find(w=>w.week_start===wkStart);
      const openH=wkEntry?wkEntry.open_hours:40;
      const rate=openH>0?getPersonSalaryAtDate(per,teDate||new Date().toISOString().slice(0,10))/(openH*4.33):0;
      const cost=rate*(Number(te.hours)||0);
      costAll+=cost;
      if(per.grade!=='C5')costProd+=cost;
    });
    return {costAll:Math.round(costAll),costProd:Math.round(costProd)};
  };
  const projCosts=calcProjectCosts(p.timeEntries);
  const totalPaid=(p.payments||[]).filter(x=>x.status==='PAID').reduce((s,x)=>s+(Number(x.amount)||0),0);
  const totalAccrued=(p.payments||[]).filter(x=>x.status==='ACCRUED').reduce((s,x)=>s+(Number(x.amount)||0),0);
  const totalPlanned=(p.payments||[]).reduce((s,x)=>s+(Number(x.amount)||0),0);
  const revenue=(p.project_type==='New Delivery'||p.project_type==='ФК')?totalPlanned:(Number(p.total_contract_value)||Number(p.fixed_price)||0);
  const [finSub,_setFinSub]=useState(()=>localStorage.getItem('pp_finSub')||'pnl');
  const setFinSub=(t)=>{localStorage.setItem('pp_finSub',t);_setFinSub(t);};
  const [editTCV,setEditTCV]=useState(false);
  const [tcvVal,setTcvVal]=useState(String(p.total_contract_value||''));
  const openBlockers=(p.blockers||[]).filter(b=>!b.resolved_at);

  const assignedIds=new Set((p.assignments||[]).map(a=>a.person_id));
  const usedTrackIds=new Set((p.tracks||[]).map(t=>t.track_template_id));

  return <div>
    <button className="back-btn" onClick={onBack}>← Проекты</button>
    <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:6}}>
      <h2 className="page-title" style={{margin:0}}>{p.code}</h2>{SB(p.status)}
      {p.status==='DRAFT'&&<button className="btn btn-success btn-sm" onClick={()=>store.activateProject(p.id)}>Активировать</button>}
      <button className="btn btn-secondary btn-sm" onClick={()=>setShowEditProject(true)}>Редактировать</button>
    </div>
    <p style={{color:'var(--text2)',marginBottom:14,fontSize:13}}>{p.name} — <span className="clickable" style={{textDecoration:'underline'}} onClick={()=>setShowEditClient(true)}>{p.client_name}</span> {p._work_group&&<span style={{fontSize:11,color:'var(--text2)',marginLeft:8}}>{p._work_group}</span>}</p>
    {showEditProject&&<EditProjectModal project={p} store={store} onClose={()=>setShowEditProject(false)}/>}
    {showEditClient&&client&&<EditClientModal client={client} store={store} onClose={()=>setShowEditClient(false)} onCreateProject={()=>{setShowEditClient(false);setShowNewProjClient(true);}} onGoProject={goProject?(id)=>{setShowEditClient(false);goProject(id);}:null}/>}
    {showNewProjClient&&client&&<NewProjectModal store={store} onClose={()=>setShowNewProjClient(false)} initialClientId={client.id}/>}
    <div className="tab-bar">
      {['overview','tracks','competencies','admin_scale','documents','financials','metrics_map'].map(t=><div key={t} className={`tab ${tab===t?'active':''}`} onClick={()=>setTab(t)}>{{overview:'Обзор',tracks:'Issue Tree',competencies:'Команда',admin_scale:'Админ.шкала',documents:'Документы',financials:'Финансы',metrics_map:'Карта метрик'}[t]}</div>)}
    </div>

    {tab==='overview'&&<div>
      {/* === Triage Criteria Editing === */}
      {(()=>{
        const tri=calcTriage(p);
        const autoUrgency=(()=>{const te=p.target_end_date||p.end_date||'';const ndE=getNextNDPeriodEnd(p);const ed=ndE||(te?new Date(te):null);if(!ed)return null;const dr=Math.ceil((ed-new Date())/(1000*60*60*24));return dr<=20?3:dr>=60?1:2;})();
        const bpmC=(p.tracks||[]).filter(t=>(t.track_class||'').toUpperCase()==='BPM').length;
        const autoScale=bpmC>=10?3:bpmC>=5?2:1;
        const costPer2=(Number(p.total_contract_value)||Number(p.contract_value)||0)/3;
        const autoCost=costPer2>550000?3:costPer2===550000?2:costPer2>0?1:null;
        const lbl={1:'Низкий',2:'Средний',3:'Высокий'};
        const segLbl={1:'S1 Близкий+Высокий',2:'S2 Близкий+Низкий',3:'S3 Дальний+Высокий',4:'S4 Дальний+Низкий'};
        const segClr={1:'var(--red)',2:'var(--yellow)',3:'var(--sky)',4:'var(--green)'};
        const mkSel=(label2,field,autoVal,weight)=>{
          const cur=p['_'+field]?Number(p['_'+field]):null;
          const used=cur||autoVal;
          return <div style={{display:'flex',alignItems:'center',gap:6,fontSize:11}}>
            <span style={{width:110,color:'var(--text2)',flexShrink:0}}>{label2} <span style={{fontSize:9,opacity:.6}}>(×{weight})</span></span>
            <select style={{fontSize:11,padding:'2px 6px',border:'1px solid var(--border)',borderRadius:4,background:'var(--bg2)',color:'var(--text1)',cursor:'pointer',width:120}} value={cur||''} onChange={e=>{const v=e.target.value;const upd={};upd['_'+field]=v?Number(v):null;store.updateProject(p.id,upd);}}>
              <option value="">Авто ({autoVal!==null?lbl[autoVal]||autoVal:'—'})</option>
              <option value="1">1 — {lbl[1]}</option>
              <option value="2">2 — {lbl[2]}</option>
              <option value="3">3 — {lbl[3]}</option>
            </select>
            <span style={{fontWeight:600,fontSize:12,color:used===3?'var(--red)':used===2?'var(--amber)':'var(--green)',width:16,textAlign:'center'}}>{used||'—'}</span>
          </div>;
        };
        return <div className="card" style={{marginBottom:12}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
            <span style={{fontSize:13,fontWeight:600}}>Критерии триажа</span>
            <div style={{display:'flex',gap:8,alignItems:'center'}}>
              <span style={{fontSize:12,fontWeight:700,color:'var(--accent)'}}>Score: {tri.totalScore}</span>
              {tri.segment&&<span className={'badge seg-'+tri.segment} style={{fontSize:11}}>{segLbl[tri.segment]}</span>}
            </div>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
            {mkSel('Срочность','urgency',autoUrgency,1.5)}
            {mkSel('Масштаб','scale',autoScale,1)}
            {mkSel('Стоимость','cost',autoCost,1)}
            {mkSel('Сложность','complexity',p.complexity||null,1)}
            {mkSel('Приоритет GD','priority',p.priority_gd||null,1)}
          </div>
          <div style={{marginTop:6,fontSize:10,color:'var(--text2)',display:'flex',gap:12,flexWrap:'wrap'}}>
            <span>Буфер: <b style={{color:tri.bufferColor==='red'?'var(--red)':tri.bufferColor==='yellow'?'var(--amber)':'var(--green)'}}>{tri.daysRemaining!==null?tri.daysRemaining+' дн.':'—'}</b></span>
            <span>BPM треков: <b>{bpmC}</b></span>
            <span>Стоимость/3: <b>{fmt(Math.round(costPer2))}</b></span>
          </div>
        </div>;
      })()}

      {/* === Phases (moved from tab) === */}
      {/* ATS date warning */}
      {(p.project_type==='Old Delivery')&&!p.ats_date&&<div style={{padding:'10px 14px',background:'rgba(255,193,7,0.15)',border:'1px solid var(--amber)',borderRadius:8,marginBottom:12,display:'flex',alignItems:'center',gap:10,flexWrap:'wrap'}}>
        <span style={{fontSize:12,color:'var(--amber)'}}>⚠️ Укажите дату защиты АТС для автоматического расчёта дат фаз</span>
        <input type="date" style={{fontSize:12,padding:'3px 8px',borderRadius:4,border:'1px solid var(--amber)',background:'var(--bg2)',color:'var(--text1)'}} onBlur={e=>{if(e.target.value&&e.target.value.length>=10)store.updateProject(p.id,{ats_date:e.target.value})}} onKeyDown={e=>{if(e.key==='Enter'&&e.target.value&&e.target.value.length>=10){store.updateProject(p.id,{ats_date:e.target.value});e.target.blur();}}}/>
      </div>}
      {p.ats_date&&<div style={{fontSize:11,color:'var(--accent)',marginBottom:8}}>📅 Дата защиты АТС: <b>{fmtD(p.ats_date)}</b> <input type="date" defaultValue={p.ats_date} onBlur={e=>{if(e.target.value&&e.target.value.length>=10&&e.target.value!==p.ats_date)store.updateProject(p.id,{ats_date:e.target.value})}} onKeyDown={e=>{if(e.key==='Enter'&&e.target.value&&e.target.value.length>=10){store.updateProject(p.id,{ats_date:e.target.value});e.target.blur();}}} style={{fontSize:10,padding:'1px 4px',marginLeft:6,borderRadius:4,border:'1px solid var(--border)',background:'var(--bg2)',color:'var(--text1)'}}/></div>}
      {/* Header buttons */}
      <div style={{display:'flex',gap:8,flexWrap:'wrap',alignItems:'center',marginBottom:12}}>
        {p.status==='ACTIVE'&&<button className="btn btn-primary btn-sm" onClick={()=>store.advanceStage(p.id)}>Продвинуть стадию →</button>}
              {p.status==='ACTIVE'&&<button className="btn btn-sm" style={{background:'var(--amber)',color:'#000',border:'none',borderRadius:6,padding:'4px 10px',fontSize:11,cursor:'pointer'}} onClick={()=>store.holdProject(p.id)}>⏸ Приостановить проект</button>}
              {p.status==='ON_HOLD'&&<button className="btn btn-sm" style={{background:'var(--green)',color:'#fff',border:'none',borderRadius:6,padding:'4px 10px',fontSize:11,cursor:'pointer'}} onClick={()=>store.resumeProject(p.id)}>▶ Возобновить проект</button>}
        {p.status==='ACTIVE'&&(p.project_type==='New Delivery'||p.project_type==='Old Delivery')&&<button className="btn btn-sm" style={{background:'var(--amber)',color:'#fff',border:'none'}} onClick={()=>setShowEarlyComplete(true)}>Досрочное завершение</button>}
        {/* Phase grouping mode switcher (only for Old Delivery / DD) */}
        {p.project_type!=='ФК'&&p.project_type!=='New Delivery'&&<div className="pg-mode-switch" style={{marginBottom:0,marginLeft:'auto'}}>
          {[{k:'DD4',l:'4 фазы'},{k:'DD3',l:'3 группы'},{k:'DD2',l:'2 группы'}].map(m=><button key={m.k} className={'pg-mode-btn'+((p.phase_grouping||'DD3')===m.k?' active':'')} onClick={()=>store.updateProject(p.id,{phase_grouping:m.k})}>{m.l}</button>)}
        </div>}
      </div>
      {showEarlyComplete&&<Modal onClose={()=>setShowEarlyComplete(false)}><h2>Досрочное завершение проекта</h2>
        <div style={{fontSize:12,color:'var(--text2)',marginBottom:12}}>{p.code} — {p.name}</div>
        {p.project_type==='New Delivery'&&<div style={{padding:8,background:'var(--bg1)',borderRadius:6,marginBottom:12,fontSize:11}}>
          <div>Периоды: {(p.phases||[]).length} ({p.nd_payment_period==='quarterly'?'кварт.':'мес.'})</div>
          <div>Стоимость периода: {fmt(p.nd_period_cost||0)} ₽</div>
          <div>Общая стоимость: {fmt((p.nd_period_cost||0)*(p.nd_num_periods||0))} ₽</div>
          {p.nd_has_success_fee&&<div>Success Fee: {fmt(p.nd_success_fee||0)} ₽</div>}
        </div>}
        <div className="form-group"><label>Сколько денег мы ещё получим (₽)</label><input type="number" value={ecForm.received} onChange={e=>setEcForm(x=>({...x,received:e.target.value}))}/></div>
        <div className="form-group"><label>Сколько уже не получим (₽)</label><input type="number" value={ecForm.lost} onChange={e=>setEcForm(x=>({...x,lost:e.target.value}))}/></div>
        {p.nd_has_success_fee&&<div className="form-group"><label>Часть Success Fee, на которую претендуем (₽)</label><input type="number" value={ecForm.sf_claimed} onChange={e=>setEcForm(x=>({...x,sf_claimed:e.target.value}))}/></div>}
        <div className="form-group"><label>Комментарий</label><textarea value={ecForm.notes} onChange={e=>setEcForm(x=>({...x,notes:e.target.value}))} placeholder="Причина досрочного завершения..."/></div>
        <div className="form-actions"><button className="btn btn-secondary" onClick={()=>setShowEarlyComplete(false)}>Отмена</button><button className="btn btn-danger" onClick={()=>{if(confirm('Досрочно завершить проект?')){store.earlyCompleteProject(p.id,ecForm);setShowEarlyComplete(false);}}}>Завершить досрочно</button></div>
      </Modal>}

      {/* ===== PHASE FLOW — vertical with payment/milestone wedges ===== */}
      {(()=>{
        const groups=getPhaseGroups(p);
        const today=new Date();
        const payments=p.payments||[];
        const milestones=p.milestones||[];
        const hasAnyIP=(p.phases||[]).some(ph=>ph.status==='IN_PROGRESS');
        /* Contract bounds */
        const cStart=p.start_date||'';const cEnd=p.target_end_date||p.end_date||'';
        /* Helper: get payments/milestones "before" a group (attached to previous group's end or project start) */
        const getWedgeItems=(grpIdx)=>{
          const prevGroupPhaseIds=grpIdx>0?groups[grpIdx-1].phases.map(ph=>ph.id):[];
          const curGroupPhaseIds=groups[grpIdx].phases.map(ph=>ph.id);
          /* Payments linked to prev group = "after prev, before cur" */
          const wedgePay=grpIdx===0?payments.filter(pm=>!pm.phase_id||(!curGroupPhaseIds.includes(pm.phase_id)&&!groups.some(g=>g.phases.some(ph=>ph.id===pm.phase_id)))):payments.filter(pm=>prevGroupPhaseIds.includes(pm.phase_id));
          /* Milestones linked to prev phase_id or between */
          const wedgeMs=grpIdx===0?milestones.filter(m=>!m.phase_id):milestones.filter(m=>prevGroupPhaseIds.includes(m.phase_id));
          return {wedgePay,wedgeMs};
        };
        /* Payments/milestones after last group */
        const lastGroupIds=groups.length>0?groups[groups.length-1].phases.map(ph=>ph.id):[];
        const tailPay=payments.filter(pm=>lastGroupIds.includes(pm.phase_id));
        const tailMs=milestones.filter(m=>lastGroupIds.includes(m.phase_id));

        return <div className="pg-flow-vertical">
          {groups.map((grp,gi)=>{
            const buf=calcPhaseBuffer(grp,today);
            const allDocs=grp.phases.flatMap(ph=>getPhaseDocsState(p,ph.phase_code));
            const docsDone=allDocs.filter(d=>d.status==='DONE').length;
            const docsPct=allDocs.length>0?Math.round(docsDone/allDocs.length*100):0;
            const allStages=grp.phases.flatMap(ph=>ph.stages||[]);
            const stagesDone=allStages.filter(s=>s.status==='COMPLETED').length;
            const stagesCur=allStages.find(s=>s.status==='IN_PROGRESS');
            const grpTrackClasses=grp.phases.map(ph=>ph.track_class).filter(Boolean);
            const grpTracks=(p.tracks||[]).filter(t=>grpTrackClasses.includes(t.track_class));
            const openTracks=grpTracks.filter(t=>t.status!=='COMPLETED'&&t.status!=='CLOSED');
            const hCol=buf.health==='red'?'var(--red)':buf.health==='yellow'?'var(--amber)':buf.health==='done'?'var(--accent)':buf.health==='gray'?'var(--text2)':'var(--green)';
            const workPct=buf.totalDays>0?Math.round(buf.workDays/buf.totalDays*100):67;
            const bufPctWidth=100-workPct;
            const todayPct=buf.totalDays>0?Math.min(100,Math.max(0,buf.progressPct)):0;
            const bufBarCls=buf.health==='red'?'danger':buf.health==='yellow'?'warning':'healthy';
            const wi=getWedgeItems(gi);

            return <React.Fragment key={grp.id}>
              {/* ── Wedge: payments + milestones BEFORE this card ── */}
              {(wi.wedgePay.length>0||wi.wedgeMs.length>0||gi===0)&&<div className="pg-wedge">
                <div className="pg-wedge-items">
                  {wi.wedgePay.map(pm=><span key={pm.id} className={'pg-wedge-pay '+(pm.status||'PLANNED')} title={'Транш #'+pm.tranche_number}>💰 #{pm.tranche_number} · {fmt(Number(pm.amount)||0)} ₽ {pm.status==='PAID'?'✓':pm.status==='ACCRUED'?'◎':''}</span>)}
                  {wi.wedgeMs.map(m=><span key={m.id} className={'pg-wedge-ms '+(m.status||'PENDING')+(m.is_enabler?' enabler':'')} onClick={()=>setEditMs(m)} title={m.description||m.name}>{m.is_enabler?'📞':'🏁'} {m.name}{m.target_date?' · '+fmtD(m.target_date):''}{m.status==='DONE'?' ✓':''}<span className="pg-wedge-del" onClick={e=>{e.stopPropagation();if(confirm('Удалить '+(m.is_enabler?'энейблер':'веху')+'?'))store.deleteMilestone(p.id,m.id);}}>×</span></span>)}
                  {gi===0&&<button className="pg-add-ms-btn" onClick={()=>setMsForm({phase_id:null,name:'',description:'',target_date:'',is_enabler:false})}>+ Веха</button>}
                  {gi===0&&<button className="pg-add-en-btn" onClick={()=>setMsForm({phase_id:null,name:'',description:'',target_date:'',is_enabler:true})}>+ Энейблер</button>}
                </div>
              </div>}

              {/* ── Phase Group Card ── */}
              <div className={'pg-card '+grp.color}>
                <div className="pg-header">
                  <span className="pg-title">{grp.group_name}</span>
                  <div style={{display:'flex',gap:6,alignItems:'center'}}>
                    {grp.status==='NOT_STARTED'&&p.status==='ACTIVE'&&!hasAnyIP&&<button className="pg-start-btn" onClick={()=>{const first=grp.phases.find(ph=>ph.status==='NOT_STARTED');if(first)store.startPhase(p.id,first.id);}}>▶ Начать</button>}
                    {grp.status==='NOT_STARTED'&&p.status==='ACTIVE'&&hasAnyIP&&<button className="pg-start-btn" style={{opacity:.6,background:'var(--text2)'}} title="Завершите текущую фазу" disabled>Ожидает</button>}
                    {grp.status==='IN_PROGRESS'&&<button className="pg-start-btn" style={{background:'var(--amber)',fontSize:9,padding:'2px 8px'}} onClick={()=>{grp.phases.filter(ph=>ph.status==='IN_PROGRESS').forEach(ph=>store.setPhaseStatus(p.id,ph.id,'ON_HOLD'));}}>⏸ Пауза</button>}
                    {grp.status==='ON_HOLD'&&<button className="pg-start-btn" style={{background:'var(--green)',fontSize:9,padding:'2px 8px'}} onClick={()=>{grp.phases.filter(ph=>ph.status==='ON_HOLD').forEach(ph=>store.setPhaseStatus(p.id,ph.id,'IN_PROGRESS'));}}>▶ Возобновить</button>}
                    <span>{SB(grp.status)}</span>
                  </div>
                </div>
                {(cStart||cEnd)&&<div className="pg-contract-bounds">📋 Контракт: {cStart?fmtD(cStart):'—'} — {cEnd?fmtD(cEnd):'—'}</div>}
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginTop:8}}><div>{/* LEFT: Phase info */}

                <div className="pg-phase-dates">
                  <div className="pg-phase-dates-head">
                    <b>Даты фаз</b>
                    {grp.period_start&&<span className="pg-phase-dates-hint">{fmtD(grp.period_start)} — {fmtD(grp.period_end)} · {buf.totalDays} дн.</span>}
                  </div>
                  {grp.phases.map(ph=><div key={ph.id} style={{marginBottom:grp.phases.length>1?6:0}}>
                    {grp.phases.length>1&&<div style={{fontSize:9,fontWeight:600,color:'var(--text2)',marginBottom:2}}>{ph.phase_name}</div>}
                    <div className="pg-phase-date-row">
                      <label>Старт</label>
                      <input type="date" value={ph.period_start||''} onChange={e=>{store.updatePhaseDates(p.id,ph.id,{period_start:e.target.value})}}/>
                      <label>Конец</label>
                      <input type="date" value={ph.period_end||''} onChange={e=>{store.updatePhaseDates(p.id,ph.id,{period_end:e.target.value})}}/>
                      {ph.status!=='COMPLETED'&&<button title="Закрыть эту фазу как завершённую прошлым годом" style={{fontSize:8,padding:'2px 6px',borderRadius:4,background:'var(--amber)',color:'#000',border:'none',cursor:'pointer',marginLeft:4,whiteSpace:'nowrap'}} onClick={()=>{if(!confirm('Закрыть фазу «'+(ph.phase_name||ph.phase_code)+'» как завершённую прошлым годом?'))return;const s=ph.period_start||'2025-03-01';const e=ph.period_end||'2025-11-30';store.updatePhaseDates(p.id,ph.id,{period_start:s,period_end:e,actual_start:ph.actual_start||s,actual_end:ph.actual_end||e});store.setPhaseStatus(p.id,ph.id,'COMPLETED');}}>✓ 2025</button>}
                      {ph.status==='COMPLETED'&&<button title="Переоткрыть фазу" style={{fontSize:8,padding:'2px 6px',borderRadius:4,background:'var(--surface2)',color:'var(--text)',border:'1px solid var(--border)',cursor:'pointer',marginLeft:4,whiteSpace:'nowrap'}} onClick={()=>{if(!confirm('Переоткрыть фазу «'+(ph.phase_name||ph.phase_code)+'»?'))return;store.setPhaseStatus(p.id,ph.id,'IN_PROGRESS');}}>↩ Открыть</button>}
                    </div>
                  </div>)}
                </div>

                {buf.totalDays>0&&<div className="pg-timeline">
                  <div className={'pg-timeline-work '+grp.color} style={{width:workPct+'%'}}></div>
                  <div className={'pg-timeline-buffer '+bufBarCls} style={{width:bufPctWidth+'%'}}></div>
                  {grp.status==='IN_PROGRESS'&&<div className="pg-timeline-today" style={{left:todayPct+'%'}}></div>}
                </div>}

                <div className="pg-metrics">
                  <div className="pg-metric">Работа: <b>{buf.workDays}</b> дн.</div>
                  <div className="pg-metric">Буфер: <b>{buf.bufferDays}</b> дн.</div>
                  {grp.status==='IN_PROGRESS'&&buf.daysRemaining!==null&&<div className="pg-metric" style={{color:hCol}}>
                    {buf.isOverdue?'Просрочено на '+Math.abs(buf.daysRemaining)+' дн.':'Осталось: '+buf.daysRemaining+' дн.'}
                  </div>}
                  {grp.status==='ON_HOLD'&&<div className="pg-metric" style={{color:'var(--amber)'}}>⏸ На паузе{grp.phases.some(ph=>ph.hold_days>0)?' (было на паузе '+grp.phases.reduce((s,ph)=>s+(Number(ph.hold_days)||0),0)+' дн.)':''}</div>}
                </div>

                {grp.status==='IN_PROGRESS'&&<div>
                  <div className="pg-buffer-gauge"><div className={'pg-buffer-fill '+buf.health} style={{width:Math.min(buf.bufferPct,100)+'%'}}></div></div>
                  <div style={{display:'flex',justifyContent:'space-between',fontSize:9,color:hCol}}>
                    <span>{buf.bufferConsumed>0?'Буфер сгорел: '+buf.bufferConsumed+'/'+buf.bufferDays+' дн.':'Буфер цел'}</span>
                    <span>{buf.bufferPct>0?buf.bufferPct+'%':''}</span>
                  </div>
                </div>}
                {grp.status==='COMPLETED'&&<div>
                  <div className="pg-buffer-gauge"><div className="pg-buffer-fill done" style={{width:'100%'}}></div></div>
                  <div style={{fontSize:9,color:'var(--accent)'}}>Завершено{grp.completed_at?' '+fmtD(grp.completed_at):''}</div>
                </div>}
                {grp.status==='NOT_STARTED'&&<div>
                  <div className="pg-buffer-gauge"><div className="pg-buffer-fill gray" style={{width:'0%'}}></div></div>
                  <div style={{fontSize:9,color:'var(--text2)'}}>Не начато</div>
                </div>}

                {grp.phases.length>1&&<div className="pg-flow">
                  {grp.phases.map((ph,i)=><React.Fragment key={ph.id}>
                    {i>0&&<span className="pg-flow-arrow">→</span>}
                    <span className={'pg-flow-item '+ph.status.toLowerCase()}>{ph.phase_name} {ph.status==='COMPLETED'?'✓':ph.status==='IN_PROGRESS'?'▶':''}</span>
                  </React.Fragment>)}
                </div>}

                {stagesCur&&<div style={{fontSize:10,color:'var(--sky)',marginBottom:4}}>Стадия: {stagesCur.stage_name} ({stagesDone}/{allStages.length})</div>}
                <div style={{display:'flex',gap:3,marginBottom:6}}>
                  {allStages.map(st=><div key={st.id} title={st.stage_name+' ('+st.status+')'} style={{width:6,height:6,borderRadius:'50%',background:st.status==='COMPLETED'?'var(--accent)':st.status==='IN_PROGRESS'?'var(--green)':'var(--bg4)',border:'1px solid '+(st.status==='IN_PROGRESS'?'var(--green)':'var(--border)'),boxShadow:st.status==='IN_PROGRESS'?'0 0 4px rgba(34,197,94,.5)':'none'}}></div>)}
                </div>

                <div style={{display:'flex',gap:12,marginBottom:4}}>
                  <div className="pg-docs">
                    <span>Документы: {docsDone}/{allDocs.length}</span>
                    <div className="pg-docs-bar"><div className="pg-docs-fill" style={{width:docsPct+'%'}}></div></div>
                    <span>{docsPct}%</span>
                  </div>
                </div>
                {grpTracks.length>0&&<div style={{fontSize:10,color:'var(--text2)',marginBottom:4}}>Треков: {grpTracks.length} ({openTracks.length} открыт.)</div>}

                <div style={{marginTop:8}}>
                  <details>
                    <summary style={{fontSize:10,color:'var(--accent)',cursor:'pointer'}}>Документы и стадии подробно</summary>
                    <div style={{marginTop:8}}>
                      {grp.phases.map(ph=>{
                        const docs=getPhaseDocsState(p,ph.phase_code);
                        const dn=docs.filter(d=>d.status==='DONE').length;
                        const pc=docs.length>0?Math.round(dn/docs.length*100):0;
                        return <div key={ph.id} style={{marginBottom:10}}>
                          <div style={{fontSize:11,fontWeight:600,marginBottom:4}}>{ph.phase_name} ({SB(ph.status)})</div>
                          {(ph.stages||[]).map(st=>{const sd=calcStageDays(st);return <div key={st.id} className="stage-row"><div className={'stage-dot '+(st.status==='IN_PROGRESS'?'ip':st.status==='COMPLETED'?'done':'ns')}></div><span>{st.stage_name}</span><span style={{fontSize:10,color:'var(--text2)',marginLeft:4}}>{st.status==='IN_PROGRESS'?'▶':st.status==='COMPLETED'?'✓':''}</span>{sd>0&&<span className={'stage-dur'+(st.status==='COMPLETED'?' done-dur':' ip-dur')}>{sd} дн.</span>}</div>})}
                          <div className="ph-docs" style={{marginTop:4}}>
                            <div className="ph-docs-title"><span>Документы ({dn}/{docs.length})</span><span className={'phase-docs-pct'+(pc===100?' complete':'')}>{pc}%</span></div>
                            {docs.map(doc=><div key={doc.key} className={'ph-doc-card'+(doc.status==='DONE'?' uploaded':doc.status==='IN_PROGRESS'?' wip':'')} onClick={()=>setEditPhDoc({phaseCode:ph.phase_code,...doc})} title={doc.required?'Обязательный':'Опциональный'}>
                              <div className={'doc-status-dot'+(doc.status==='DONE'?' s-done':doc.status==='IN_PROGRESS'?' s-wip':' s-none')}></div>
                              <div className="doc-label">{doc.required?'✱ ':''}{doc.name}</div>
                              {doc.url&&<a className="doc-link" href={doc.url} target="_blank" onClick={e=>e.stopPropagation()}>↗</a>}
                            </div>)}
                          </div>
                        </div>;
                      })}
                    </div>
                  </details>
                </div>
</div>{/* END LEFT */}
                <div style={{borderLeft:'1px solid var(--border)',paddingLeft:12,minWidth:0}}>{/* RIGHT: Tracks */}
                  <div style={{fontSize:11,fontWeight:600,marginBottom:8,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <span>Треки ({grpTracks.length})</span>
                    <button className="btn btn-sm" style={{fontSize:9,padding:'2px 6px',background:'var(--accent)',color:'#fff',border:'none',borderRadius:4,cursor:'pointer'}} onClick={e=>{e.stopPropagation();setAddTrackPhaseClass(grpTrackClasses[0]||'BPM');setShowTrack(true);}}>+ Трек</button>
                  </div>
                  {grpTracks.length===0&&<div style={{fontSize:10,color:'var(--text2)',fontStyle:'italic',padding:'8px 0'}}>Нет треков. Нажмите «+ Трек» для добавления.</div>}
                  {grpTracks.map(t=>{
                    const hb=p.hypothesisBoard||{goals:[],subjects:[]};
                    const cl=p.cardLinks||[];
                    const trkGoals=hb.goals.filter(g=>cl.some(l=>(l.from===g.id&&l.to===t.id)||(l.to===g.id&&l.from===t.id)));
                    const trkInsights=(hb.subjects||[]).flatMap(s=>s.insights||[]).filter(ins=>(ins.linked_tracks||[]).includes(t.id)||cl.some(l=>(l.from===ins.id&&l.to===t.id)||(l.to===ins.id&&l.from===t.id)));
                    const trkTasks=(p.tasks||[]).filter(tk=>tk.track_id===t.id||cl.some(l=>(l.from===tk.id&&l.to===t.id)||(l.to===tk.id&&l.from===t.id)));
                    const stIcon=t.status==='COMPLETED'?'✅':t.status==='IN_PROGRESS'?'▶️':t.status==='CLOSED'?'🔒':'⏳';
                    const stLabel=t.status==='COMPLETED'?'Завершён':t.status==='IN_PROGRESS'?'В работе':t.status==='CLOSED'?'Закрыт':'Не начат';
                    const stColor=t.status==='COMPLETED'?'var(--green)':t.status==='IN_PROGRESS'?'var(--accent)':t.status==='CLOSED'?'var(--text2)':'var(--amber)';
                    const allTrks=p.tracks||[];
                    const deps=t.dependencies||[];
                    const preds=deps.map(d=>{const pt=allTrks.find(x=>x.id===d.target_track_id);return pt?{...d,track:pt}:null;}).filter(Boolean);
                    const succs=allTrks.filter(x=>(x.dependencies||[]).some(d=>d.target_track_id===t.id)).map(x=>({track:x,lag:(x.dependencies||[]).find(d=>d.target_track_id===t.id)?.lag_days||0}));
                    /* Conflict detection */
                    const conflicts=preds.filter(d=>{if(!t.start_date||!d.track.end_date)return false;const predEnd=new Date(d.track.end_date);predEnd.setDate(predEnd.getDate()+(d.lag_days||0));return new Date(t.start_date)<predEnd;});
                    const actualDays=t.start_date&&t.end_date?Math.max(0,Math.ceil((new Date(t.end_date)-new Date(t.start_date))/(1000*60*60*24))):null;
                    return <details key={t.id} style={{marginBottom:6}}>
                      <summary style={{padding:'6px 8px',borderRadius:6,background:conflicts.length>0?'rgba(239,68,68,0.08)':'var(--bg1)',border:'1px solid '+(conflicts.length>0?'var(--red)':'var(--border)'),cursor:'pointer',listStyle:'none',display:'flex',alignItems:'center',gap:6}}>
                        <span style={{fontSize:11,fontWeight:600,flex:'0 0 auto'}}>{stIcon} {t.track_code}</span>
                        <span style={{fontSize:10,color:'var(--text2)',flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{t.track_name}</span>
                        <span style={{fontSize:9,color:'var(--text2)',flex:'0 0 auto'}}>{actualDays!==null?actualDays+'д':t.norm_days?t.norm_days+'д':'—'}</span>
                        {conflicts.length>0&&<span style={{fontSize:9,color:'var(--red)',flex:'0 0 auto'}} title="Конфликт дат">⚠️</span>}
                        <span style={{fontSize:9,color:stColor,fontWeight:600,flex:'0 0 auto',padding:'1px 5px',borderRadius:4,background:stColor+'18'}}>{stLabel}</span>
                      </summary>
                      <div style={{padding:'8px 10px',margin:'2px 0 0',borderRadius:'0 0 6px 6px',background:'var(--bg1)',border:'1px solid var(--border)',borderTop:'none',fontSize:10}}>
                        {/* Editable dates & days */}
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'4px 8px',marginBottom:8}}>
                          <div><span style={{color:'var(--text2)',fontSize:9}}>Старт</span><br/><input type="date" defaultValue={t.start_date||''} onBlur={e=>{if(e.target.value!==t.start_date)store.updateTrackDates(p.id,t.id,{start_date:e.target.value})}} style={{fontSize:10,width:'100%',padding:'2px 4px',borderRadius:4,border:'1px solid var(--border)',background:'var(--bg2)',color:'var(--text1)'}}/></div>
                          <div><span style={{color:'var(--text2)',fontSize:9}}>Конец</span><br/><input type="date" defaultValue={t.end_date||''} onBlur={e=>{if(e.target.value!==t.end_date)store.updateTrackDates(p.id,t.id,{end_date:e.target.value})}} style={{fontSize:10,width:'100%',padding:'2px 4px',borderRadius:4,border:'1px solid var(--border)',background:'var(--bg2)',color:'var(--text1)'}}/></div>
                          <div><span style={{color:'var(--text2)',fontSize:9}}>Норм.дней</span><br/><input type="number" defaultValue={t.norm_days||''} min="1" max="999" onBlur={e=>{const v=parseInt(e.target.value);if(!isNaN(v)&&v!==t.norm_days)store.updateTrackDates(p.id,t.id,{norm_days:v})}} style={{fontSize:10,width:'100%',padding:'2px 4px',borderRadius:4,border:'1px solid var(--border)',background:'var(--bg2)',color:'var(--text1)'}}/></div>
                        </div>
                        {/* Status + meta */}
                        <div style={{display:'flex',gap:8,marginBottom:6,alignItems:'center',flexWrap:'wrap'}}>
                          <select value={t.status} onChange={e=>store.updateTrackStatus(p.id,t.id,e.target.value)} style={{fontSize:10,padding:'2px 4px',borderRadius:4,border:'1px solid var(--border)',background:'var(--bg2)',color:'var(--text1)'}}>
                            <option value="NOT_STARTED">Не начат</option><option value="IN_PROGRESS">В работе</option><option value="COMPLETED">Завершён</option><option value="CLOSED">Закрыт</option>
                          </select>
                          <span style={{fontSize:9,color:'var(--text2)'}}>Класс: {t.track_class} · Домен: {t.domain||'—'}</span>
                          {actualDays!==null&&<span style={{fontSize:9,color:'var(--accent)'}}>Факт: {actualDays} дн.</span>}
                          <button style={{marginLeft:'auto',fontSize:9,color:'var(--red)',background:'none',border:'none',cursor:'pointer',padding:0}} onClick={()=>{if(confirm('Удалить трек '+t.track_code+'?'))store.deleteTrack(p.id,t.id)}}>🗑</button>
                        </div>

                        {/* Dependencies: Predecessors */}
                        <div style={{marginBottom:6}}>
                          <div style={{fontSize:9,fontWeight:600,color:'var(--text2)',marginBottom:3}}>Предшественники ({preds.length})</div>
                          {preds.map(d=><div key={d.id} style={{display:'flex',alignItems:'center',gap:4,marginBottom:2,fontSize:9,padding:'2px 4px',borderRadius:4,background:conflicts.some(c=>c.id===d.id)?'rgba(239,68,68,0.12)':'var(--bg2)'}}>
                            <span style={{fontWeight:600}}>{d.track.track_code}</span>
                            <span style={{color:'var(--text2)'}}>{d.track.track_name}</span>
                            {d.lag_days>0&&<span style={{color:'var(--amber)'}}>+{d.lag_days}д</span>}
                            {d.track.end_date&&<span style={{color:'var(--text2)'}}>до {fmtD(d.track.end_date)}</span>}
                            {conflicts.some(c=>c.id===d.id)&&<span style={{color:'var(--red)',fontWeight:700}}>⚠ конфликт!</span>}
                            <button style={{marginLeft:'auto',color:'var(--red)',background:'none',border:'none',cursor:'pointer',fontSize:9,padding:0}} onClick={()=>store.removeTrackDep(p.id,t.id,d.id)}>×</button>
                          </div>)}
                          {/* Add predecessor */}
                          <select style={{fontSize:9,marginTop:2,padding:'1px 3px',borderRadius:3,border:'1px solid var(--border)',background:'var(--bg2)',color:'var(--text1)'}} value="" onChange={e=>{if(e.target.value)store.addTrackDep(p.id,t.id,{target_track_id:e.target.value,lag_days:0});e.target.value='';}}>
                            <option value="">+ предшественник...</option>
                            {allTrks.filter(x=>x.id!==t.id&&!deps.some(d=>d.target_track_id===x.id)).map(x=><option key={x.id} value={x.id}>{x.track_code} — {x.track_name}</option>)}
                          </select>
                        </div>

                        {/* Successors (read-only) */}
                        {succs.length>0&&<div style={{marginBottom:6}}>
                          <div style={{fontSize:9,fontWeight:600,color:'var(--text2)',marginBottom:3}}>Последователи ({succs.length})</div>
                          {succs.map(s=><div key={s.track.id} style={{fontSize:9,padding:'2px 4px',borderRadius:4,background:'var(--bg2)',marginBottom:2,display:'flex',gap:4}}>
                            <span style={{fontWeight:600}}>{s.track.track_code}</span>
                            <span style={{color:'var(--text2)'}}>{s.track.track_name}</span>
                            {s.lag>0&&<span style={{color:'var(--amber)'}}>+{s.lag}д</span>}
                          </div>)}
                        </div>}

                        {/* Conflicts summary */}
                        {conflicts.length>0&&<div style={{padding:'4px 8px',marginBottom:6,borderRadius:4,background:'rgba(239,68,68,0.1)',border:'1px solid rgba(239,68,68,0.2)',fontSize:9,color:'var(--red)'}}>
                          ⚠️ Конфликт дат: старт трека ({t.start_date?fmtD(t.start_date):'—'}) раньше конца предшественника ({conflicts.map(c=>c.track.track_code+' до '+fmtD(c.track.end_date)).join(', ')})
                        </div>}

                        {/* Goals */}
                        {trkGoals.length>0&&<div style={{marginBottom:6}}>
                          <div style={{fontWeight:600,color:'var(--accent)',marginBottom:3}}>🎯 Цели ({trkGoals.length})</div>
                          {trkGoals.map(g=><div key={g.id} style={{padding:'3px 6px',marginBottom:2,borderRadius:4,background:'rgba(99,102,241,0.08)',border:'1px solid rgba(99,102,241,0.15)'}}>
                            <div style={{fontWeight:500}}>{g.title||g.description||'Цель'}</div>
                            {g.metrics&&<div style={{fontSize:9,color:'var(--text2)',marginTop:1}}>Метрика: {g.metrics}</div>}
                          </div>)}
                        </div>}

                        {/* Insights */}
                        {trkInsights.length>0&&<div style={{marginBottom:6}}>
                          <div style={{fontWeight:600,color:'var(--violet)',marginBottom:3}}>💡 Инсайты ({trkInsights.length})</div>
                          {trkInsights.map(ins=><div key={ins.id} style={{padding:'3px 6px',marginBottom:2,borderRadius:4,background:ins.insight_type==='PAIN'?'rgba(239,68,68,0.08)':'rgba(34,197,94,0.08)',border:'1px solid '+(ins.insight_type==='PAIN'?'rgba(239,68,68,0.15)':'rgba(34,197,94,0.15)')}}>
                            <span style={{fontSize:9,fontWeight:700,color:ins.insight_type==='PAIN'?'var(--red)':'var(--green)'}}>{ins.insight_type}</span>{' '}
                            <span>{ins.description||'Инсайт'}</span>
                          </div>)}
                        </div>}

                        {/* Tasks */}
                        {trkTasks.length>0&&<div style={{marginBottom:4}}>
                          <div style={{fontWeight:600,color:'var(--sky)',marginBottom:3}}>📋 Задачи ({trkTasks.length})</div>
                          {trkTasks.map(tk=><div key={tk.id} style={{padding:'3px 6px',marginBottom:2,borderRadius:4,background:'rgba(14,165,233,0.08)',border:'1px solid rgba(14,165,233,0.15)',display:'flex',alignItems:'center',gap:4}}>
                            <span style={{fontSize:9,width:8,height:8,borderRadius:'50%',background:tk.status==='DONE'?'var(--green)':tk.status==='IN_PROGRESS'?'var(--sky)':'var(--border)',display:'inline-block',flexShrink:0}}></span>
                            <span style={{flex:1}}>{tk.title||tk.description||'Задача'}</span>
                            {tk.status&&<span style={{fontSize:8,color:'var(--text2)'}}>{tk.status}</span>}
                          </div>)}
                        </div>}

                        {trkGoals.length===0&&trkInsights.length===0&&trkTasks.length===0&&<div style={{color:'var(--text2)',fontStyle:'italic',fontSize:9}}>Нет связанных сущностей. Привяжите через Issue Tree.</div>}
                      </div>
                    </details>;
                  })}
                </div></div>{/* END GRID */}
                {/* Add milestone button per group */}
                <div style={{marginTop:6,textAlign:'right'}}>
                  <button className="pg-add-ms-btn" onClick={()=>setMsForm({phase_id:grp.phases[grp.phases.length-1].id,name:'',description:'',target_date:'',is_enabler:false})}>+ Веха после {grp.group_name}</button>
                  <button className="pg-add-en-btn" style={{marginLeft:4}} onClick={()=>setMsForm({phase_id:grp.phases[grp.phases.length-1].id,name:'',description:'',target_date:'',is_enabler:true})}>+ Энейблер</button>
                </div>
              </div>
            </React.Fragment>;
          })}

          {/* ── Tail wedge: payments + milestones after last group ── */}
          {(tailPay.length>0||tailMs.length>0)&&<div className="pg-wedge">
            <div className="pg-wedge-items">
              {tailPay.map(pm=><span key={pm.id} className={'pg-wedge-pay '+(pm.status||'PLANNED')} title={'Транш #'+pm.tranche_number}>💰 #{pm.tranche_number} · {fmt(Number(pm.amount)||0)} ₽ {pm.status==='PAID'?'✓':pm.status==='ACCRUED'?'◎':''}</span>)}
              {tailMs.map(m=><span key={m.id} className={'pg-wedge-ms '+(m.status||'PENDING')+(m.is_enabler?' enabler':'')} onClick={()=>setEditMs(m)}>{m.is_enabler?'📞':'🏁'} {m.name}{m.target_date?' · '+fmtD(m.target_date):''}{m.status==='DONE'?' ✓':''}<span className="pg-wedge-del" onClick={e=>{e.stopPropagation();if(confirm('Удалить '+(m.is_enabler?'энейблер':'веху')+'?'))store.deleteMilestone(p.id,m.id);}}>×</span></span>)}
            </div>
          </div>}
        </div>;
      })()}

      {/* ── Milestone Add Modal ── */}
      {msForm&&<Modal onClose={()=>setMsForm(null)}>
        <h2>{msForm.is_enabler?'📞 Новый энейблер':'🏁 Новая веха'}</h2>
        {msForm.is_enabler&&<p style={{fontSize:12,color:'var(--sky)',margin:'-8px 0 12px'}}>Энейблер — коммуникационное событие (созвон, отчётность, презентация)</p>}
        <div className="form-group"><label>Название</label><input value={msForm.name} onChange={e=>setMsForm(x=>({...x,name:e.target.value}))} placeholder={msForm.is_enabler?'Созвон, презентация, отчёт...':'Ключевое событие...'}/></div>
        <div className="form-group"><label>Описание</label><textarea value={msForm.description} onChange={e=>setMsForm(x=>({...x,description:e.target.value}))} placeholder={msForm.is_enabler?'Детали коммуникационного события...':'Что означает эта веха...'}/></div>
        <div className="form-group"><label>Целевая дата</label><input type="date" value={msForm.target_date} onChange={e=>setMsForm(x=>({...x,target_date:e.target.value}))}/></div>
        <div className="form-actions">
          <button className="btn btn-secondary" onClick={()=>setMsForm(null)}>Отмена</button>
          <button className="btn btn-primary" style={msForm.is_enabler?{background:'var(--sky)'}:{}} onClick={()=>{if(msForm.name.trim()){store.addMilestone(p.id,msForm);setMsForm(null);}else{alert('Введите название');}}}>Добавить</button>
        </div>
      </Modal>}

      {/* ── Milestone Edit Modal ── */}
      {editMs&&<Modal onClose={()=>setEditMs(null)}>
        <h2>{editMs.is_enabler?'📞 Энейблер':'🏁 Веха'}: {editMs.name}</h2>
        <div className="form-group"><label>Название</label><input value={editMs.name} onChange={e=>setEditMs(x=>({...x,name:e.target.value}))}/></div>
        <div className="form-group"><label>Описание</label><textarea value={editMs.description||''} onChange={e=>setEditMs(x=>({...x,description:e.target.value}))}/></div>
        <div className="form-group"><label>Целевая дата</label><input type="date" value={editMs.target_date||''} onChange={e=>setEditMs(x=>({...x,target_date:e.target.value}))}/></div>
        <div className="form-group" style={{display:'flex',alignItems:'center',gap:8}}><label style={{margin:0,cursor:'pointer'}} onClick={()=>setEditMs(x=>({...x,is_enabler:!x.is_enabler}))}><input type="checkbox" checked={!!editMs.is_enabler} onChange={e=>setEditMs(x=>({...x,is_enabler:e.target.checked}))} style={{marginRight:4}}/>Энейблер</label><span style={{fontSize:11,color:'var(--text2)'}}>(коммуникационное событие)</span></div>
        <div className="form-group"><label>Статус</label><span style={{fontWeight:600,color:editMs.status==='DONE'?'var(--green)':'var(--amber)'}}>{editMs.status==='DONE'?'Завершена':'Ожидает'}</span></div>
        <div className="form-actions">
          <button className="btn btn-danger" onClick={()=>{if(confirm('Удалить '+(editMs.is_enabler?'энейблер':'веху')+'?')){store.deleteMilestone(p.id,editMs.id);setEditMs(null);}}}>Удалить</button>
          {editMs.status!=='DONE'&&<button className="btn" style={{background:'var(--green)',color:'#fff',border:'none'}} onClick={()=>{store.completeMilestone(p.id,editMs.id);setEditMs(null);}}>✓ Завершить</button>}
          <button className="btn btn-primary" onClick={()=>{store.updateMilestone(p.id,editMs.id,{name:editMs.name,description:editMs.description,target_date:editMs.target_date,is_enabler:!!editMs.is_enabler});setEditMs(null);}}>Сохранить</button>
        </div>
      </Modal>}

    {editPhDoc&&<Modal onClose={()=>setEditPhDoc(null)}>
      <h2>{editPhDoc.name}</h2>
      <div style={{fontSize:11,color:'var(--text2)',marginBottom:12}}>{editPhDoc.required?'Обязательный документ':'Опциональный документ'} · Фаза: {editPhDoc.phaseCode}</div>
      <div className="form-group"><label>Статус</label><select value={editPhDoc.status} onChange={e=>setEditPhDoc(x=>({...x,status:e.target.value}))}><option value="NOT_STARTED">Не загружен</option><option value="IN_PROGRESS">В работе</option><option value="DONE">Загружен</option></select></div>
      <div className="form-group"><label>Ссылка на документ</label><input value={editPhDoc.url} onChange={e=>setEditPhDoc(x=>({...x,url:e.target.value}))} placeholder="https://docs.google.com/..."/></div>
      <div className="form-group"><label>Имя файла</label><input value={editPhDoc.file_name} onChange={e=>setEditPhDoc(x=>({...x,file_name:e.target.value}))} placeholder="document.pdf"/></div>
      <div className="form-group"><label>Заметки</label><textarea value={editPhDoc.notes} onChange={e=>setEditPhDoc(x=>({...x,notes:e.target.value}))} placeholder="Комментарии по документу..."/></div>
      <div className="upload-zone" onClick={()=>{const inp=document.createElement('input');inp.type='file';inp.onchange=e=>{const f=e.target.files[0];if(f){setEditPhDoc(x=>({...x,file_name:f.name,status:'DONE'}))}};inp.click()}}>
        📁 Нажмите для выбора файла или перетащите сюда
      </div>
      {editPhDoc.file_name&&<div style={{fontSize:11,color:'var(--green)',marginBottom:8}}>Файл: {editPhDoc.file_name}</div>}
      {editPhDoc.uploaded_at&&<div style={{fontSize:10,color:'var(--text2)',marginBottom:8}}>Загружен: {new Date(editPhDoc.uploaded_at).toLocaleDateString('ru-RU')}</div>}
      <div className="form-actions">
        <button className="btn btn-secondary" onClick={()=>setEditPhDoc(null)}>Отмена</button>
        <button className="btn btn-primary" onClick={()=>{store.updatePhaseDoc(p.id,editPhDoc.phaseCode,editPhDoc.key,{status:editPhDoc.status,url:editPhDoc.url,file_name:editPhDoc.file_name,notes:editPhDoc.notes});setEditPhDoc(null);}}>Сохранить</button>
      </div>
    </Modal>}

      {/* === Track Add Modal (for phase-specific track adding) === */}
      {showTrack&&<Modal onClose={()=>{setShowTrack(false);setAddTrackPhaseClass(null);}}>
        <h2>Добавить трек{addTrackPhaseClass?' ('+addTrackPhaseClass+')':''}</h2>
        {p.project_type==='New Delivery'?<div>
          <div className="form-group"><label>Название трека (кастомный)</label><input value={tf} onChange={e=>setTf(e.target.value)} placeholder="Например: Аудит процессов Q1"/></div>
          <div className="form-actions"><button className="btn btn-secondary" onClick={()=>{setShowTrack(false);setAddTrackPhaseClass(null);}}>Отмена</button><button className="btn btn-primary" onClick={()=>{if(tf.trim()){store.addTrack(p.id,{name:tf.trim()});setShowTrack(false);setTf('');setAddTrackPhaseClass(null);}}} disabled={!tf.trim()}>Добавить</button></div>
        </div>:<div>
          <div className="form-group"><label>Шаблон трека</label><select value={tf} onChange={e=>setTf(e.target.value)}><option value="">—</option>{store.data.trackTemplates.filter(tt=>!usedTrackIds.has(tt.id)&&(!addTrackPhaseClass||tt.track_class===addTrackPhaseClass)).map(tt=><option key={tt.id} value={tt.id}>{tt.code} — {tt.name} ({tt.track_class})</option>)}</select></div>
          <div className="form-actions"><button className="btn btn-secondary" onClick={()=>{setShowTrack(false);setAddTrackPhaseClass(null);}}>Отмена</button><button className="btn btn-primary" onClick={()=>{if(tf){store.addTrack(p.id,tf);setShowTrack(false);setTf('');setAddTrackPhaseClass(null);}}}>Добавить</button></div>
        </div>}
      </Modal>}

      {(()=>{const phases=p.phases||[];const totalStages=phases.reduce((s,ph)=>s+(ph.stages||[]).length,0);const doneStages=phases.reduce((s,ph)=>s+(ph.stages||[]).filter(st=>st.status==='COMPLETED').length,0);const ipStages=phases.reduce((s,ph)=>s+(ph.stages||[]).filter(st=>st.status==='IN_PROGRESS').length,0);const pct=totalStages>0?Math.round((doneStages+ipStages*0.5)/totalStages*100):0;return <div className="dd-progress"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{fontSize:13,fontWeight:600}}>Прогресс Double Diamond</span><span style={{fontSize:13,fontWeight:700,color:'var(--accent)'}}>{pct}%</span></div><div className="progress-bar" style={{height:10,marginTop:6}}><div className="progress-fill" style={{width:pct+'%',background:'linear-gradient(90deg,var(--accent),var(--emerald))'}}></div></div><div className="dd-progress-bar">{phases.map(ph=>{const st=ph.stages||[];return st.map(s=>{const sd=calcStageDays(s);return <div key={s.id} className={'dd-progress-seg '+(s.status==='COMPLETED'?'done':s.status==='IN_PROGRESS'?'ip':'ns')} title={ph.phase_name+' → '+s.stage_name+(sd?' ('+sd+' дн.)':'')}>{s.stage_name.substring(0,3)}{sd>0&&<span style={{fontSize:7,marginLeft:1}}>{sd}д</span>}</div>;});})}</div><div className="dd-phase-dur">{phases.map(ph=>{const d=calcPhaseDays(ph);return d>0?<span key={ph.id} className={'dd-phase-chip '+(ph.status==='COMPLETED'?'done':'ip')}>{ph.phase_name.split('(')[0].trim()}: <span className="chip-days">{d} дн.</span></span>:null;})}</div></div>;})()}
      {(()=>{
      const buf=calcProjectBuffer(p);
      if(!p.start_date)return <div className="buf-panel"><div className="buf-title"><span>Диагональный буфер проекта</span><span className="buf-status warn">Нет даты старта</span></div><div style={{fontSize:11,color:"var(--text2)"}}>Укажите дату старта и окончания проекта для расчёта буфера</div></div>;
      const healthLabel={ok:"В норме",warn:"Внимание",danger:"Критично",overdue:"Просрочка"};
      const healthIcon={ok:"✅",warn:"\u26A0\uFE0F",danger:"\uD83D\uDD34",overdue:"\uD83D\uDCA5"};
      return <div className="buf-panel">
        <div className="buf-title"><span>Диагональный буфер проекта</span><span className={"buf-status "+buf.health}>{healthIcon[buf.health]} {healthLabel[buf.health]}</span></div>
        <div style={{display:"flex",gap:16,marginBottom:10,flexWrap:"wrap"}}>
          <div style={{fontSize:11}}><span style={{color:"var(--text2)"}}>Длительность: </span><b>{buf.totalWeeks} нед. ({buf.totalDays} дн.)</b></div>
          <div style={{fontSize:11}}><span style={{color:"var(--text2)"}}>Прошло: </span><b>{buf.elapsedDays} дн.</b></div>
          <div style={{fontSize:11}}><span style={{color:"var(--text2)"}}>Осталось: </span><b style={{color:buf.remainingDays<14?"var(--red)":"var(--green)"}}>{buf.remainingDays} дн.</b></div>
          <div style={{fontSize:11}}><span style={{color:"var(--text2)"}}>Буфер: </span><b>{buf.totalBuf} дн.</b> <span style={{color:buf.bufPct>66?"var(--red)":buf.bufPct>33?"var(--yellow)":"var(--green)"}}>({buf.bufPct}% израсходовано)</span></div>
          {buf.totalOverdue>0&&<div style={{fontSize:11,color:"var(--red)",fontWeight:700}}>Просрочка: +{buf.totalOverdue} дн.</div>}
        </div>
        <div className="buf-bar-wrap">
          {(()=>{const wPct=Math.min(100,Math.round((buf.totalDays-buf.totalBuf)/buf.totalDays*100));const bPct=Math.round(buf.totalBuf/buf.totalDays*100);const ePct=Math.min(100,Math.round(buf.elapsedDays/buf.totalDays*100));return <React.Fragment><div className="buf-bar-work" style={{width:wPct+"%",background:"var(--accent)"}}><span className="buf-bar-label">Работа {buf.totalDays-buf.totalBuf}д</span></div><div className="buf-bar-buf" style={{width:bPct+"%",left:wPct+"%",background:buf.bufPct>66?"var(--red)":buf.bufPct>33?"var(--yellow)":"var(--green)"}}><span className="buf-bar-label">Буфер {buf.totalBuf}д</span></div><div className="buf-bar-cursor" style={{left:Math.min(99,ePct)+"%"}} title={"Сегодня: день "+buf.elapsedDays}></div></React.Fragment>;})()}
        </div>
        <div className="buf-legend"><div className="buf-legend-item"><div className="buf-legend-dot" style={{background:"var(--accent)"}}></div>Рабочие дни</div><div className="buf-legend-item"><div className="buf-legend-dot" style={{background:"var(--green)"}}></div>Буфер свободен</div><div className="buf-legend-item"><div className="buf-legend-dot" style={{background:"var(--yellow)"}}></div>Буфер частично</div><div className="buf-legend-item"><div className="buf-legend-dot" style={{background:"var(--red)"}}></div>Буфер исчерпан</div><div className="buf-legend-item"><div className="buf-legend-dot" style={{background:"var(--text)"}}></div>Сегодня</div></div>
        <div className="buf-stages">
          {buf.phases.map(ph=>{
            const pctFill=ph.norm>0?Math.min(100,Math.round(ph.actual/ph.norm*100)):0;
            const workPct=ph.norm>0?Math.round(ph.work/ph.norm*100):67;
            const fillColor=ph.overdue>0?"var(--red)":ph.bufUsed>0?(ph.bufRemain<ph.buffer*0.33?"var(--yellow)":"var(--accent)"):"var(--accent)";
            return <div key={ph.code}>
              <div className="buf-stage-row">
                <div className="buf-stage-name" style={{fontWeight:600}}>{ph.name.split("(")[0].trim()}</div>
                <div className="buf-stage-bar-wrap" style={{height:12}}>
                  <div style={{position:"absolute",left:0,top:0,width:workPct+"%",height:"100%",background:"var(--accent)",opacity:.2,borderRadius:5}}></div>
                  <div style={{position:"absolute",left:workPct+"%",top:0,width:(100-workPct)+"%",height:"100%",background:ph.bufRemain<ph.buffer*0.33?"var(--red)":"var(--green)",opacity:.15,borderRadius:"0 5px 5px 0"}}></div>
                  <div className="buf-stage-fill" style={{width:Math.min(100,pctFill)+"%",background:fillColor}}></div>
                </div>
                <div className="buf-stage-nums">{ph.actual}д / {ph.norm}д {ph.overdue>0&&<span style={{color:"var(--red)",fontWeight:700}}>+{ph.overdue}</span>}</div>
              </div>
              {ph.stages.map(st=>{
                const sPct=st.norm>0?Math.min(100,Math.round(st.actual/st.norm*100)):0;
                const sColor=st.overdue>0?"var(--red)":st.actual>st.work?"var(--yellow)":"var(--accent)";
                return <div key={st.code} className="buf-stage-row" style={{paddingLeft:16}}>
                  <div className="buf-stage-name" style={{fontSize:10,color:"var(--text2)"}}>{st.name}</div>
                  <div className="buf-stage-bar-wrap" style={{height:6}}>
                    <div className="buf-stage-fill" style={{width:Math.min(100,sPct)+"%",background:sColor}}></div>
                  </div>
                  <div className="buf-stage-nums" style={{fontSize:9}}>{st.actual>0?st.actual+"д":"—"} / {st.norm}д {st.overdue>0&&<span style={{color:"var(--red)"}}>+{st.overdue}</span>}</div>
                </div>;
              })}
            </div>;
          })}
        </div>
      </div>;
    })()}
      <div className="stats-grid">
        <div className="stat-card"><div className="label">Команда</div><div className="value accent-c">{(p.assignments||[]).length}</div></div>
        <div className="stat-card"><div className="label">Треков</div><div className="value">{(p.tracks||[]).length}</div></div>
        <div className="stat-card"><div className="label">Задач</div><div className="value yellow-c">{(p.tasks||[]).length}</div></div>
        <div className="stat-card"><div className="label">Блокеров</div><div className="value red-c">{openBlockers.length}</div></div>
        <div className="stat-card"><div className="label">Админ.шкала</div><div className="value" style={{color:'var(--accent)'}}>{calcAdminScale(p).pct}%</div></div>
      </div>
      {(()=>{
        const pnl=calcPnlHealth(p,store.data.persons);
        return <div className="pnl-mini">
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
            <span style={{fontSize:13,fontWeight:600}}>P&L проекта</span>
            <span className={'pnl-health '+pnl.health}>{pnl.health==='green'?'✅':pnl.health==='yellow'?'\u26A0\uFE0F':pnl.health==='red'?'\uD83D\uDD34':'➖'} {pnl.label}{pnl.health!=='gray'&&(' '+pnl.dirtyPct+'%')}</span>
          </div>
          {pnl.health==='gray'?<div style={{fontSize:11,color:'var(--text2)'}}>Укажите стоимость контракта для расчёта P&L</div>:
          <div>
            <div className="pnl-row"><span style={{color:'var(--text2)'}}>Выручка нетто</span><span className="pnl-val">{fmt(pnl.revNet)} ₽</span></div>
            <div className="pnl-row"><span style={{color:'var(--text2)'}}>Косты произв. (C1-C4)</span><span className="pnl-val" style={{color:'var(--red)'}}>−{fmt(pnl.costProd)} ₽</span></div>
            <div className="pnl-row"><span style={{color:'var(--text2)'}}>Накладные</span><span className="pnl-val" style={{color:'var(--violet)'}}>−{fmt(pnl.ohTotal)} ₽</span></div>
            <div className="pnl-row total"><span>Грязная валовая прибыль</span><span className="pnl-val" style={{color:pnl.dirtyProfit>=0?'var(--green)':'var(--red)'}}>{fmt(pnl.dirtyProfit)} ₽ ({pnl.dirtyPct}%)</span></div>
            <div className="pnl-row"><span style={{color:'var(--text2)'}}>Косты C5</span><span className="pnl-val" style={{color:'var(--amber)'}}>−{fmt(pnl.costAll-pnl.costProd)} ₽</span></div>
            <div className="pnl-row total"><span>Чистая валовая прибыль</span><span className="pnl-val" style={{color:pnl.cleanProfit>=0?'var(--green)':'var(--red)'}}>{fmt(pnl.cleanProfit)} ₽ ({pnl.cleanPct}%)</span></div>
            <div style={{marginTop:6,fontSize:10,color:'var(--text2)'}}>Норма операц. рентабельности: ≥75-80% от нетто</div>
          </div>}
        </div>;
      })()}
    </div>}

    {tab==='tracks'&&<div className="it-container" style={{marginTop:16}} onClick={()=>{setItFocused(null);setItLinkMode(null);setSelGoal(null);setSelSubj(null);setSelInsight(null);}}>
      <div style={{display:'flex',gap:8,marginBottom:12,alignItems:'center',flexWrap:'wrap'}} onClick={e=>e.stopPropagation()}>
        <h3 style={{margin:0,fontSize:16}}>Issue Tree</h3>
        <button className="btn btn-primary btn-sm" onClick={()=>setShowGoal(true)}>+ Цель</button>
        <button className="btn btn-secondary btn-sm" onClick={()=>setShowSubj(true)}>+ Субъект</button>
        {itLinkMode&&<span style={{fontSize:11,color:'var(--amber)',background:'rgba(245,158,11,.1)',padding:'3px 10px',borderRadius:8}}>🔗 Режим связи — кликните на целевую карточку</span>}
        {itFocused&&<button className="btn btn-sm" style={{background:'var(--amber)',color:'#fff',border:'none'}} onClick={()=>setItFocused(null)}>✕ Снять фокус</button>}
      </div>

      {(()=>{
        const hb0=p.hypothesisBoard||{id:'hb_'+p.id,goals:[],subjects:[]};
        const hb=store._ensureITCols(hb0);
        const columns=[...(hb.columns||store.IT_DEFAULT_COLS)].sort((a,b)=>a.order_num-b.order_num);
        const cardLinks=hb.cardLinks||[];
        const goals=hb.goals||[];
        const subjects=hb.subjects||[];
        const tracks=p.tracks||[];
        const getInsLinked=(ins)=>{const lt=[...(ins.linked_tracks||[])];if(ins.linked_track_id&&!lt.some(x=>x.id===ins.linked_track_id))lt.push({id:ins.linked_track_id,track_code:ins.linked_track_code,track_name:ins.linked_track_name,track_class:ins.linked_track_class});return lt;};
        const allInsights=subjects.flatMap(s=>(s.insights||[]).map(ins=>({...ins,_subjId:s.id,_subjName:s.name,_linked:getInsLinked(ins)})));
        const insightsWithTrack=allInsights.filter(ins=>ins._linked.length>0);
        const linkedTrackIds=new Set(insightsWithTrack.flatMap(ins=>ins._linked.map(lt=>lt.id)));
        const unlinkedTracks=tracks.filter(t=>!linkedTrackIds.has(t.id));
        const allTasks=p.tasks||[];

        /* Compute active (visible) card IDs based on selection */
        /* Helper: get IDs linked to a given ID via cardLinks */
        const clLinked=(id)=>{const s=new Set();cardLinks.forEach(l=>{if(l.from_id===id)s.add(l.to_id);if(l.to_id===id)s.add(l.from_id);});return s;};
        /* Helper: add tasks for a track (by track_id AND cardLinks) */
        const addTrackTasks=(trkId,ids)=>{allTasks.filter(tk=>tk.track_id===trkId).forEach(tk=>ids.add(tk.id));clLinked(trkId).forEach(lid=>{if(allTasks.some(tk=>tk.id===lid))ids.add(lid);});};

        const activeCardIds=(()=>{
          if(!selGoal&&!selSubj&&!selInsight)return null;
          const ids=new Set();
          if(selInsight){
            const ins=allInsights.find(i=>i.id===selInsight);
            if(ins){const subj=subjects.find(s=>s.id===ins._subjId);if(subj){ids.add(subj.goal_id);ids.add(subj.id);}ids.add(ins.id);(ins._linked||[]).forEach(lt=>{ids.add(lt.id);addTrackTasks(lt.id,ids);});}
          }else if(selSubj){
            const subj=subjects.find(s=>s.id===selSubj);
            if(subj){ids.add(subj.goal_id);ids.add(subj.id);(subj.insights||[]).forEach(ins=>{ids.add(ins.id);getInsLinked(ins).forEach(lt=>{ids.add(lt.id);addTrackTasks(lt.id,ids);});});}
          }else if(selGoal){
            ids.add(selGoal);subjects.filter(s=>s.goal_id===selGoal).forEach(s=>{ids.add(s.id);(s.insights||[]).forEach(ins=>{ids.add(ins.id);getInsLinked(ins).forEach(lt=>{ids.add(lt.id);addTrackTasks(lt.id,ids);});});});
          }
          /* Also add cardLinks-connected items for all collected IDs (goals↔tracks, etc.) */
          const extra=new Set();
          ids.forEach(id=>{clLinked(id).forEach(lid=>{
            if(goals.some(g=>g.id===lid)||allTasks.some(tk=>tk.id===lid)||tracks.some(tr=>tr.id===lid))extra.add(lid);
          });});
          extra.forEach(id=>ids.add(id));
          return ids.size>0?ids:null;
        })();

        /* Focus mode helpers */
        const focusedLinks=itFocused?cardLinks.filter(l=>l.from_id===itFocused.cardId||l.to_id===itFocused.cardId):[];
        const focusedCardIds=(()=>{
          if(!itFocused)return null;
          const s=new Set([itFocused.cardId,...focusedLinks.flatMap(l=>[l.from_id,l.to_id])]);
          /* If focused card is a track — also include tasks by track_id */
          const focTrack=tracks.find(tr=>tr.id===itFocused.cardId);
          if(focTrack)allTasks.filter(tk=>tk.track_id===focTrack.id).forEach(tk=>s.add(tk.id));
          /* If focused card is a task — also include its track by track_id */
          const focTask=allTasks.find(tk=>tk.id===itFocused.cardId);
          if(focTask&&focTask.track_id)s.add(focTask.track_id);
          return s;
        })();
        const getCardLinkCount=(cardId)=>cardLinks.filter(l=>l.from_id===cardId||l.to_id===cardId).length;
        const cardCls=(cardId,colId)=>{
          let c='it-card-v2';
          if(itLinkMode&&!(itLinkMode.fromId===cardId&&itLinkMode.fromCol===colId))c+=' link-target';
          if(activeCardIds&&!activeCardIds.has(cardId))c+=' dimmed';
          else if(itFocused){
            if(itFocused.cardId===cardId)c+=' focused';
            else if(focusedCardIds&&focusedCardIds.has(cardId))c+=' linked';
            else c+=' dimmed';
          }
          return c;
        };
        const handleCardClick=(cardId,colId,e)=>{
          if(e)e.stopPropagation();
          if(itLinkMode){
            if(itLinkMode.fromId!==cardId||itLinkMode.fromCol!==colId){
              store.addCardLink(p.id,itLinkMode.fromId,itLinkMode.fromCol,cardId,colId);
            }
            setItLinkMode(null);return;
          }
        };
        const toggleFocus=(cardId,colId,e)=>{
          e.stopPropagation();
          if(itFocused&&itFocused.cardId===cardId)setItFocused(null);
          else setItFocused({cardId,colId});
        };
        const startLink=(cardId,colId,e)=>{
          e.stopPropagation();
          setItLinkMode({fromId:cardId,fromCol:colId});
        };

        /* Column renderers by entity_type */
        const renderGoalCards=(col)=>{
          return goals.map(g=><div key={g.id} className={cardCls(g.id,col.id)} onClick={e=>{e.stopPropagation();handleCardClick(g.id,col.id,e);if(!itLinkMode){setSelGoal(selGoal===g.id?null:g.id);setSelSubj(null);}}}>
            {getCardLinkCount(g.id)>0&&<span className="it-link-count">{getCardLinkCount(g.id)}</span>}
            <span className="it-link-btn" onClick={e=>startLink(g.id,col.id,e)} title="Создать связь">🔗</span>
            <span className="it-card-del" onClick={e=>{e.stopPropagation();if(confirm('Удалить цель?'))store.deleteGoal(p.id,g.id);}}>×</span>
            <div className="it-card-title" style={{cursor:'pointer'}} onClick={e=>{e.stopPropagation();toggleFocus(g.id,col.id,e);}}>{g.title}</div>
            {g.description&&<div className="it-card-sub">{g.description}</div>}
            <div className="it-card-meta">{g.goal_type||'BUSINESS'} · {subjects.filter(s=>s.goal_id===g.id).length} субъ.</div>
            {(g.sub_goals||[]).length>0&&<div className="it-subgoal-list">{(g.sub_goals||[]).map(sg=><div key={sg.id} className="it-subgoal"><span className="sg-title">{sg.title}</span><span className="sg-del" onClick={e=>{e.stopPropagation();store.deleteSubGoal(p.id,g.id,sg.id);}}>×</span></div>)}</div>}
            {selGoal===g.id&&<div onClick={e=>e.stopPropagation()}>
              {sgForm.goalId===g.id?<div className="it-inline-form" style={{marginTop:4}}>
                <input placeholder="Подцель..." value={sgForm.title} onChange={e=>setSgForm(f=>({...f,title:e.target.value}))} onKeyDown={e=>{if(e.key==='Enter'&&sgForm.title){store.addSubGoal(p.id,g.id,{title:sgForm.title});setSgForm({goalId:null,title:''});}}} style={{flex:1}}/>
                <button className="btn btn-primary btn-sm" style={{padding:'2px 6px',fontSize:10}} onClick={()=>{if(sgForm.title){store.addSubGoal(p.id,g.id,{title:sgForm.title});setSgForm({goalId:null,title:''});}}}>OK</button>
              </div>:<div className="it-sg-add" onClick={()=>setSgForm({goalId:g.id,title:''})}>+ Подцель</div>}
            </div>}
          </div>);
        };

        const renderSubjectCards=(col)=>{
          return subjects.map(s=><div key={s.id} className={cardCls(s.id,col.id)} onClick={e=>{e.stopPropagation();handleCardClick(s.id,col.id,e);if(!itLinkMode)setSelSubj(selSubj===s.id?null:s.id);}}>
            {getCardLinkCount(s.id)>0&&<span className="it-link-count">{getCardLinkCount(s.id)}</span>}
            <span className="it-link-btn" onClick={e=>startLink(s.id,col.id,e)} title="Создать связь">🔗</span>
            <span className="it-card-del" onClick={e=>{e.stopPropagation();if(confirm('Удалить?'))store.deleteSubject(p.id,s.id);}}>×</span>
            <div className="it-card-title" style={{color:'var(--accent)',cursor:'pointer'}} onClick={e=>{e.stopPropagation();toggleFocus(s.id,col.id,e);}}>{s.name}</div>
            {s.role&&<div className="it-card-sub">{s.role}</div>}
            <div className="it-card-meta">{(s.insights||[]).length} инсайтов</div>
          </div>);
        };

        const renderInsightCards=(col)=>{
          const ins=allInsights;
          return ins.map(i=><div key={i.id} className={cardCls(i.id,col.id)+' '+(i.insight_type==='PAIN'?'pain':'gain')} onClick={e=>{e.stopPropagation();handleCardClick(i.id,col.id,e);if(!itLinkMode)setSelInsight(selInsight===i.id?null:i.id);}}>
            {getCardLinkCount(i.id)>0&&<span className="it-link-count">{getCardLinkCount(i.id)}</span>}
            <span className="it-link-btn" onClick={e=>startLink(i.id,col.id,e)} title="Создать связь">🔗</span>
            <span className="it-card-del" onClick={e=>{e.stopPropagation();store.deleteInsight(p.id,i._subjId,i.id);}}>×</span>
            <div style={{display:'flex',alignItems:'center',gap:4,cursor:'pointer'}} onClick={e=>{e.stopPropagation();toggleFocus(i.id,col.id,e);}}>
              <span style={{fontWeight:700}}>{i.insight_type==='PAIN'?'✗':'✓'}</span>
              <span style={{flex:1,fontSize:11}}>{i.description}</span>
            </div>
            {i._linked&&i._linked.length>0&&<div style={{marginTop:4,display:'flex',flexWrap:'wrap',gap:3}}>
              {i._linked.map(lt=><span key={lt.id} style={{display:'inline-flex',alignItems:'center',gap:2}}>
                <span className={'it-track-badge '+(lt.track_class||'').toLowerCase()}>{lt.track_code}</span>
                <span style={{cursor:'pointer',opacity:.4,fontSize:10}} onClick={e=>{e.stopPropagation();store.unlinkTrackFromInsight(p.id,i._subjId,i.id,lt.id);}}>×</span>
              </span>)}
            </div>}
            {tracks.length>0&&selInsight===i.id&&<div className="it-inline-form" style={{marginTop:6}} onClick={e=>e.stopPropagation()}>
              <select value={linkTrackSel} onChange={e=>setLinkTrackSel(e.target.value)}>
                <option value="">Трек...</option>
                {tracks.filter(t=>!(i._linked||[]).some(lt=>lt.id===t.id)).map(t=><option key={t.id} value={t.id}>{t.track_code} — {t.track_name}</option>)}
              </select>
              <button className="btn btn-primary btn-sm" style={{padding:'2px 6px',fontSize:10}} onClick={()=>{if(linkTrackSel){store.linkTrackToInsight(p.id,i._subjId,i.id,linkTrackSel);setLinkTrackSel('');setSelInsight(null);}}}>OK</button>
            </div>}
          </div>);
        };

        const renderTrackCards=(col)=>{
          return tracks.map(t=><div key={t.id} className={cardCls(t.id,col.id)} onClick={e=>{e.stopPropagation();handleCardClick(t.id,col.id,e);}}>
            {getCardLinkCount(t.id)>0&&<span className="it-link-count">{getCardLinkCount(t.id)}</span>}
            <span className="it-link-btn" onClick={e=>startLink(t.id,col.id,e)} title="Создать связь">🔗</span>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer'}} onClick={e=>{e.stopPropagation();toggleFocus(t.id,col.id,e);}}>
              <div><span className={'it-track-badge '+(t.track_class||'').toLowerCase()} style={{marginLeft:0}}>{t.track_class}</span><span style={{fontWeight:700,marginLeft:4}}>{t.track_code}</span></div>
              <span style={{fontSize:10,padding:'1px 6px',borderRadius:4,background:t.status==='COMPLETED'?'#dcfce7':t.status==='IN_PROGRESS'?'#dbeafe':'var(--bg1)',color:t.status==='COMPLETED'?'#166534':t.status==='IN_PROGRESS'?'#1e40af':'var(--text2)'}}>{t.status||'PENDING'}</span>
            </div>
            <div style={{fontSize:11,marginTop:3}}>{t.track_name}</div>
          </div>);
        };

        const renderTaskCards=(col)=>{
          const kanbanCols=store.getProjectStatuses(p.id);
          const prioColors={1:'var(--red)',2:'#f97316',3:'var(--amber)',4:'var(--green)',5:'var(--text2)'};
          const prioLabels={1:'🔴 Критический',2:'🟠 Высокий',3:'🟡 Средний',4:'🟢 Низкий',5:'⚪ Минимальный'};
          const onDragStart=(e,taskId)=>{e.dataTransfer.setData('text/plain',taskId);e.dataTransfer.effectAllowed='move';e.currentTarget.style.opacity='0.4';};
          const onDragEnd=(e)=>{e.currentTarget.style.opacity='1';};
          const onDragOver=(e)=>{e.preventDefault();e.dataTransfer.dropEffect='move';e.currentTarget.style.background='rgba(14,165,233,.12)';};
          const onDragLeave=(e)=>{e.currentTarget.style.background='';};
          const onDrop=(e,newStatus)=>{e.preventDefault();e.currentTarget.style.background='';const taskId=e.dataTransfer.getData('text/plain');if(taskId)store.updateTaskStatus(p.id,taskId,newStatus);};
          const editTask=expandedTask?allTasks.find(tk=>tk.id===expandedTask):null;
          const editTrk=editTask?tracks.find(x=>x.id===editTask.track_id):null;
          const editDlDays=editTask&&editTask.deadline?Math.ceil((new Date(editTask.deadline)-new Date())/(864e5)):null;
          const editDlC=editDlDays===null?'var(--text2)':editDlDays<0?'var(--red)':editDlDays<=3?'var(--amber)':'var(--green)';
          return <div onClick={e=>e.stopPropagation()}>
            <div className="it-tasks-horiz">
            {kanbanCols.map((kc,kci)=>{
              const colTasks=allTasks.filter(t=>(t.status||'TODO')===kc.key);
              const isBaseIT=['TODO','IN_PROGRESS','DONE','BLOCKED'].includes(kc.key);
              const isGlobalIT=(store.data.globalTaskStatuses||[]).some(s=>s.key===kc.key);
              return <div key={kc.key} className="it-task-subcol" onDragOver={onDragOver} onDragLeave={onDragLeave} onDrop={e=>onDrop(e,kc.key)}>
                <div className="it-task-subcol-head" style={{color:kc.color,display:'flex',alignItems:'center',justifyContent:'space-between',gap:2}}>
                  <span style={{flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',cursor:'pointer'}} title="Двойной клик — переименовать" onDoubleClick={e=>{e.stopPropagation();const nn=prompt('Новое название:',kc.label);if(nn&&nn!==kc.label){if(isBaseIT)store.renameBaseStatus(kc.key,nn);else if(isGlobalIT)store.updateGlobalTaskStatus(kc.key,{label:nn});else{/* local */const proj=store.data.projects.find(pp=>pp.id===p.id);const ls=(proj?.localTaskStatuses||[]).map(s=>s.key===kc.key?{...s,label:nn}:s);store.updateProject(p.id,{localTaskStatuses:ls});}}}}>{kc.label} <span style={{opacity:.5}}>({colTasks.length})</span></span>
                  <span style={{display:'flex',gap:1,flexShrink:0}}>
                    {kci>0&&<span style={{cursor:'pointer',opacity:.35,fontSize:9}} title="Влево" onClick={e=>{e.stopPropagation();store.moveLocalStatusOrder(p.id,kc.key,'left');}}>◀</span>}
                    {kci<kanbanCols.length-1&&<span style={{cursor:'pointer',opacity:.35,fontSize:9}} title="Вправо" onClick={e=>{e.stopPropagation();store.moveLocalStatusOrder(p.id,kc.key,'right');}}>▶</span>}
                    {!isBaseIT&&!isGlobalIT&&<span style={{cursor:'pointer',opacity:.35,fontSize:10}} title="Удалить" onClick={e=>{e.stopPropagation();if(colTasks.length>0)alert('Сначала переместите задачи');else if(confirm('Удалить «'+kc.label+'»?'))store.removeLocalTaskStatus(p.id,kc.key);}}>✕</span>}
                  </span>
                </div>
                {colTasks.map(tsk=>{
                  const trk2=tracks.find(x=>x.id===tsk.track_id);
                  const dlDays=tsk.deadline?Math.ceil((new Date(tsk.deadline)-new Date())/(864e5)):null;
                  const dlC=dlDays===null?'var(--text2)':dlDays<0?'var(--red)':dlDays<=3?'var(--amber)':'var(--green)';
                  return <div key={tsk.id} className={cardCls(tsk.id,col.id)} draggable onDragStart={e=>onDragStart(e,tsk.id)} onDragEnd={onDragEnd} style={{cursor:'grab'}} onClick={e=>{e.stopPropagation();setExpandedTask(tsk.id);}}>
                    {getCardLinkCount(tsk.id)>0&&<span className="it-link-count">{getCardLinkCount(tsk.id)}</span>}
                    <span className="it-link-btn" onClick={e=>{e.stopPropagation();startLink(tsk.id,col.id,e);}}>🔗</span>
                    <div style={{fontSize:11,fontWeight:600}}>{tsk.title}</div>
                    <div style={{display:'flex',gap:4,flexWrap:'wrap',marginTop:3,alignItems:'center'}}>
                      {trk2&&<span className={'it-track-badge '+(trk2.track_class||'').toLowerCase()} style={{marginLeft:0,fontSize:9}}>{trk2.track_name}</span>}
                      {tsk.assignee_name&&<span style={{fontSize:9,color:'var(--text2)'}}>👤 {tsk.assignee_name}</span>}
                      {tsk.deadline&&<span style={{fontSize:9,color:dlC}}>{tsk.deadline}{dlDays!==null&&(dlDays<0?' !'+Math.abs(dlDays)+'д':' '+dlDays+'д')}</span>}
                      <span style={{fontSize:9,color:prioColors[tsk.priority||3]}}>P{tsk.priority||3}</span>
                    </div>
                  </div>;
                })}
                {colTasks.length===0&&<div style={{fontSize:10,color:'var(--text2)',fontStyle:'italic',padding:4}}>—</div>}
                {/* Шапка: кнопка удаления кастомной колонки */}
              </div>;
            })}
            {/* + Локальная колонка для этого проекта */}
            <div style={{minWidth:60,display:'flex',alignItems:'flex-start',paddingTop:2}}>
              <button className="btn btn-secondary btn-sm" style={{fontSize:9,padding:'4px 8px',borderStyle:'dashed',borderRadius:8,opacity:.6,whiteSpace:'nowrap'}} onClick={()=>{
                const name=prompt('Новый статус (только для этого проекта):');if(!name)return;
                const key=name.toUpperCase().replace(/[^A-ZА-ЯЁ0-9]/gi,'_').substring(0,20)+'_L'+Date.now().toString(36);
                const col2=prompt('Цвет (#hex, по умолчанию #8b5cf6):','#8b5cf6')||'#8b5cf6';
                const existingOrders=kanbanCols.map(c=>c.order||0).filter(o=>o<90);
                const maxBefore=existingOrders.length?Math.max(...existingOrders):10;
                store.addLocalTaskStatus(p.id,{key,label:name,color:col2,bg:col2+'18',order:maxBefore+((90-maxBefore)/2)});
              }}>+ Колонка</button>
            </div>
          </div>
          <div className="it-add" style={{marginTop:6}} onClick={()=>setShowTask(true)}>+ Задача</div>
          {editTask&&<Modal onClose={()=>setExpandedTask(null)}>
            <h2 style={{marginTop:0,fontSize:18}}>{editTask.title||'Задача'}</h2>
            <div className="form-group"><label>Название</label><input value={editTask.title||''} onChange={e=>store.updateTask(p.id,editTask.id,{title:e.target.value})}/></div>
            <div style={{display:'flex',gap:12,flexWrap:'wrap'}}>
              <div className="form-group" style={{flex:1,minWidth:180}}><label>Приоритет</label><select value={editTask.priority||3} onChange={e=>store.updateTask(p.id,editTask.id,{priority:Number(e.target.value)})}>
                <option value={1}>🔴 1 — Критический</option><option value={2}>🟠 2 — Высокий</option><option value={3}>🟡 3 — Средний</option><option value={4}>🟢 4 — Низкий</option><option value={5}>⚪ 5 — Минимальный</option>
              </select></div>
              <div className="form-group" style={{flex:1,minWidth:180}}><label>Статус</label><select value={editTask.status||'TODO'} onChange={e=>store.updateTaskStatus(p.id,editTask.id,e.target.value)}>
                {kanbanCols.map(sc=><option key={sc.key} value={sc.key}>{sc.label}</option>)}
              </select></div>
            </div>
            <div style={{display:'flex',gap:12,flexWrap:'wrap'}}>
              <div className="form-group" style={{flex:1,minWidth:180}}><label>Исполнитель</label><select value={editTask.assigned_to_id||''} onChange={e=>store.updateTask(p.id,editTask.id,{assigned_to_id:e.target.value||null,assignee_name:(store.data.persons.find(pp=>pp.id===e.target.value)||{}).name||''})}>
                <option value="">— Не назначен —</option>{store.data.persons.filter(pe=>pe.is_active).map(pe=><option key={pe.id} value={pe.id}>{pe.name}</option>)}
              </select></div>
              <div className="form-group" style={{flex:1,minWidth:180}}><label>Трек</label><select value={editTask.track_id||''} onChange={e=>store.updateTask(p.id,editTask.id,{track_id:e.target.value||null})}>
                <option value="">— Без трека —</option>{tracks.map(t2=><option key={t2.id} value={t2.id}>{t2.track_code} — {t2.track_name}</option>)}
              </select></div>
            </div>
            <div style={{display:'flex',gap:12,flexWrap:'wrap'}}>
              <div className="form-group" style={{flex:1,minWidth:180}}><label>Дедлайн</label><input type="date" value={editTask.deadline||''} onChange={e=>store.updateTask(p.id,editTask.id,{deadline:e.target.value})} style={{color:editDlC}}/>{editDlDays!==null&&<span style={{fontSize:11,color:editDlC,marginTop:2}}>{editDlDays<0?'Просрочено на '+Math.abs(editDlDays)+' дн.':editDlDays===0?'Сегодня':'Осталось '+editDlDays+' дн.'}</span>}</div>
              <div className="form-group" style={{flex:1,minWidth:180}}><label>Описание</label><textarea value={editTask.description||''} onChange={e=>store.updateTask(p.id,editTask.id,{description:e.target.value})} rows={3} placeholder="Описание задачи..."/></div>
            </div>
            {editTrk&&<div style={{fontSize:12,color:'var(--text2)',marginTop:4,padding:'6px 10px',background:'var(--bg1)',borderRadius:6}}>Трек: <strong style={{color:'var(--accent)'}}>{editTrk.track_code}</strong> — {editTrk.track_name} <span className={'it-track-badge '+(editTrk.track_class||'').toLowerCase()} style={{marginLeft:6}}>{editTrk.track_class}</span></div>}
            <div className="form-actions" style={{marginTop:12}}>
              <button className="btn btn-danger" onClick={()=>{if(confirm('Удалить задачу «'+editTask.title+'»?')){store.deleteTask(p.id,editTask.id);setExpandedTask(null);}}}>Удалить</button>
              <button className="btn btn-primary" onClick={()=>setExpandedTask(null)}>Закрыть</button>
            </div>
          </Modal>}
          </div>;
        };

        const renderSubItems=(col)=>{
          return <React.Fragment>
            {(col.items||[]).map(it=><div key={it.id} className={cardCls(it.id,col.id)} onClick={e=>{e.stopPropagation();handleCardClick(it.id,col.id,e);}}>
              {getCardLinkCount(it.id)>0&&<span className="it-link-count">{getCardLinkCount(it.id)}</span>}
              <span className="it-link-btn" onClick={e=>startLink(it.id,col.id,e)}>🔗</span>
              <span className="it-card-del" onClick={e=>{e.stopPropagation();store.removeITColumnItem(p.id,col.id,it.id);}}>×</span>
              <div className="it-card-title" style={{cursor:'pointer'}} onClick={e=>{e.stopPropagation();toggleFocus(it.id,col.id,e);}}>{it.title}</div>
              {it.description&&<div className="it-card-sub">{it.description}</div>}
            </div>)}
            {itAddItem&&itAddItem.colId===col.id?<div className="it-inline-form">
              <input placeholder="Название..." value={itAddItem.title||''} onChange={e=>setItAddItem(x=>({...x,title:e.target.value}))} onKeyDown={e=>{if(e.key==='Enter'&&itAddItem.title){store.addITColumnItem(p.id,col.id,{title:itAddItem.title,description:''});setItAddItem(null);}}}/>
              <button className="btn btn-primary btn-sm" style={{padding:'2px 6px',fontSize:10}} onClick={()=>{if(itAddItem.title){store.addITColumnItem(p.id,col.id,{title:itAddItem.title,description:''});setItAddItem(null);}}}>OK</button>
              <button className="btn btn-secondary btn-sm" style={{padding:'2px 6px',fontSize:10}} onClick={()=>setItAddItem(null)}>×</button>
            </div>:<div className="it-add" onClick={()=>setItAddItem({colId:col.id,title:''})}>+ Добавить</div>}
          </React.Fragment>;
        };

        /* Render column content by type */
        const renderColContent=(col)=>{
          if(col.is_sub)return renderSubItems(col);
          switch(col.entity_type){
            case 'goal': return renderGoalCards(col);
            case 'subject': return renderSubjectCards(col);
            case 'insight': return renderInsightCards(col);
            case 'track': return renderTrackCards(col);
            case 'task': return renderTaskCards(col);
            default: return renderSubItems(col);
          }
        };

        const getColCount=(col)=>{
          if(col.is_sub)return (col.items||[]).length;
          switch(col.entity_type){
            case 'goal': return goals.length;
            case 'subject': return selGoal?subjects.filter(s=>s.goal_id===selGoal).length:subjects.length;
            case 'insight': return selSubj?(subjects.find(s=>s.id===selSubj)?.insights||[]).length:allInsights.length;
            case 'track': return tracks.length;
            case 'task': return allTasks.length;
            default: return (col.items||[]).length;
          }
        };

        if(goals.length===0&&columns.every(c=>!c.is_sub))return <div>
          <div className="empty" style={{padding:40}}>Добавьте цель, чтобы начать Issue Tree</div>
          {tracks.length>0&&<div className="card" style={{marginTop:12,padding:12}}>
            <div style={{fontWeight:600,marginBottom:6,fontSize:13}}>Треки проекта ({tracks.length})</div>
            <div style={{fontSize:11,color:'var(--text2)',marginBottom:8}}>Треки появятся в Issue Tree после добавления цели и субъекта.</div>
            {tracks.map(t=><div key={t.id} style={{fontSize:12,padding:'4px 0',display:'flex',alignItems:'center',gap:6}}>
              <span className={'it-track-badge '+(t.track_class||'').toLowerCase()} style={{marginLeft:0}}>{t.track_class||'ND'}</span>
              <span style={{fontWeight:600}}>{t.track_code}</span>
              <span>{t.track_name}</span>
              <span style={{fontSize:10,padding:'1px 6px',borderRadius:4,background:t.status==='COMPLETED'?'#dcfce7':t.status==='IN_PROGRESS'?'#dbeafe':'var(--bg1)',color:t.status==='COMPLETED'?'#166534':t.status==='IN_PROGRESS'?'#1e40af':'var(--text2)'}}>{t.status||'NOT_STARTED'}</span>
            </div>)}
          </div>}
        </div>;

        /* ===== DYNAMIC COLUMN RENDERER ===== */
        return <div className="it-flow-dynamic">
          {columns.map((col,ci)=><React.Fragment key={col.id}>
            {ci>0&&<div className="it-conn-v2"><svg viewBox="0 0 20 30"><path d="M0 15h14m-5-5l5 5-5 5" stroke="var(--text2)" fill="none" strokeWidth="1.5" opacity=".4"/></svg></div>}
            <div className={'it-col-dynamic'+(col.entity_type==='task'?' task-col':'')}>
              {/* Column header with controls */}
              <div className="it-col-hdr" style={{background:col.color||'var(--sky)'}}>
                <div className="it-col-hdr-left">
                  <button className="it-col-add-lr" onClick={()=>store.addITColumn(p.id,col.id,'left')} title="Добавить колонку слева">←+</button>
                  <div className="it-col-color-dot" style={{background:col.color||'var(--sky)'}} onClick={()=>{const inp=document.getElementById('clr_'+col.id);if(inp)inp.click();}}></div>
                  <input type="color" id={'clr_'+col.id} className="it-col-color-inp" value={col.color||'#0ea5e9'} onChange={e=>store.updateITColumnColor(p.id,col.id,e.target.value)}/>
                  <span>{col.title} ({getColCount(col)})</span>
                </div>
                <div className="it-col-hdr-right">
                  <button className="it-col-add-lr" onClick={()=>store.addITColumn(p.id,col.id,'right')} title="Добавить колонку справа">+→</button>
                  {col.is_sub&&<span className="it-col-del" onClick={()=>{if(confirm('Удалить колонку?'))store.removeITColumn(p.id,col.id);}}>✕</span>}
                </div>
              </div>
              {/* Column content */}
              {renderColContent(col)}
              {/* Add buttons for base columns */}
              {!col.is_sub&&col.entity_type==='goal'&&<div className="it-add" onClick={()=>setShowGoal(true)}>+ Цель</div>}
              {!col.is_sub&&col.entity_type==='subject'&&selGoal&&<div className="it-add" onClick={()=>{setSf(f=>({...f,goalId:selGoal}));setShowSubj(true);}}>+ Субъект</div>}
              {!col.is_sub&&col.entity_type==='insight'&&selSubj&&<div>
                {addInsightFor===selSubj?<div className="it-inline-form">
                  <select value={insForm.type} onChange={e=>setInsForm(f=>({...f,type:e.target.value}))}><option value="PAIN">Pain</option><option value="GAIN">Gain</option></select>
                  <input placeholder="Инсайт..." value={insForm.text} onChange={e=>setInsForm(f=>({...f,text:e.target.value}))} onKeyDown={e=>{if(e.key==='Enter'&&insForm.text){store.addInsight(p.id,selSubj,{insight_type:insForm.type,description:insForm.text});setInsForm({type:'PAIN',text:''});setAddInsightFor(null);}}}/>
                  <button className="btn btn-primary btn-sm" style={{padding:'2px 6px',fontSize:10}} onClick={()=>{if(insForm.text){store.addInsight(p.id,selSubj,{insight_type:insForm.type,description:insForm.text});setInsForm({type:'PAIN',text:''});setAddInsightFor(null);}}}>OK</button>
                  <button className="btn btn-secondary btn-sm" style={{padding:'2px 6px',fontSize:10}} onClick={()=>setAddInsightFor(null)}>✕</button>
                </div>:<div className="it-add" onClick={()=>setAddInsightFor(selSubj)}>+ Инсайт</div>}
              </div>}
              {!col.is_sub&&col.entity_type==='track'&&!selInsight&&unlinkedTracks.length>0&&<div className="it-unlinked">
                <div style={{fontSize:10,fontWeight:600,marginBottom:4,color:'var(--text2)'}}>Без инсайта ({unlinkedTracks.length})</div>
                {unlinkedTracks.map(t=><div key={t.id} style={{fontSize:11,padding:'3px 0',display:'flex',alignItems:'center',gap:4}}>
                  <span className={'it-track-badge '+(t.track_class||'').toLowerCase()} style={{marginLeft:0}}>{t.track_class}</span>
                  <span>{t.track_code} {t.track_name}</span>
                </div>)}
              </div>}
            </div>
          </React.Fragment>)}
        </div>;
      })()}
      {showGoal&&<Modal onClose={()=>setShowGoal(false)}><h2>Новая цель</h2>
        <div className="form-group"><label>Название *</label><input value={gf.title} onChange={e=>setGf(p=>({...p,title:e.target.value}))}/></div>
        <div className="form-group"><label>Описание</label><textarea value={gf.description} onChange={e=>setGf(p=>({...p,description:e.target.value}))}/></div>
        <div className="form-group"><label>Тип</label><select value={gf.goal_type} onChange={e=>setGf(p=>({...p,goal_type:e.target.value}))}><option value="BUSINESS">Business</option><option value="RESEARCH">Research</option><option value="PRODUCT">Product</option></select></div>
        <div className="form-actions"><button className="btn btn-secondary" onClick={()=>setShowGoal(false)}>Отмена</button><button className="btn btn-primary" onClick={()=>{if(gf.title){store.addGoal(p.id,gf);setShowGoal(false);setGf({title:'',description:'',goal_type:'BUSINESS'});}}}>Добавить</button></div>
      </Modal>}
      {showSubj&&<Modal onClose={()=>setShowSubj(false)}><h2>Новый субъект</h2>
        <div className="form-group"><label>Цель</label><select value={sf.goalId} onChange={e=>setSf(p=>({...p,goalId:e.target.value,subGoalId:''}))}><option value="">—</option>{(p.hypothesisBoard?.goals||[]).map(g=><option key={g.id} value={g.id}>{g.title}</option>)}</select></div>
        {sf.goalId&&(()=>{const g=(p.hypothesisBoard?.goals||[]).find(x=>x.id===sf.goalId);const sgs=g?(g.sub_goals||[]):[];return sgs.length>0?<div className="form-group"><label>Подцель (опционально)</label><select value={sf.subGoalId} onChange={e=>setSf(p=>({...p,subGoalId:e.target.value}))}><option value="">— Без подцели —</option>{sgs.map(sg=><option key={sg.id} value={sg.id}>{sg.title}</option>)}</select></div>:null;})()}
        <div className="form-row"><div className="form-group"><label>Имя субъекта *</label><input value={sf.name} onChange={e=>setSf(p=>({...p,name:e.target.value}))}/></div><div className="form-group"><label>Роль</label><input value={sf.role} onChange={e=>setSf(p=>({...p,role:e.target.value}))}/></div></div>
        <div className="form-actions"><button className="btn btn-secondary" onClick={()=>setShowSubj(false)}>Отмена</button><button className="btn btn-primary" onClick={()=>{if(sf.name&&sf.goalId){store.addSubject(p.id,sf.goalId,{...sf,sub_goal_id:sf.subGoalId||null});setShowSubj(false);setSf({name:'',role:'',goalId:'',subGoalId:''});}}}>Добавить</button></div>
      </Modal>}
    </div>}

    {tab==='competencies'&&<div>

      {/* === Команда (moved from overview) === */}
      <div className="card"><div className="card-title" style={{display:'flex',justifyContent:'space-between'}}>Команда <button className="btn btn-primary btn-sm" onClick={()=>setShowAssign(true)}>+ Назначить</button></div>
        {(p.assignments||[]).length===0?<div className="empty">Нет назначений</div>:<table><thead><tr><th>Имя</th><th>Должность</th><th>Роль</th><th></th></tr></thead><tbody>{p.assignments.map((a,i)=><tr key={i}><td>{a.person_name}</td><td style={{color:'var(--text2)'}}>{a.person_position||'—'}</td><td>{a.role_code}</td><td><button className="btn btn-sm" style={{color:'var(--red)',background:'transparent',border:'none',cursor:'pointer',fontSize:14}} onClick={()=>store.removeAssignment(p.id,a.id)} title="Снять назначение">×</button></td></tr>)}</tbody></table>}
      </div>
      {openBlockers.length>0&&<div className="card"><div className="card-title">Блокеры</div>{openBlockers.map((b,i)=><div key={i} className="blocker-item" style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><div><span style={{color:'var(--red)',fontWeight:600,fontSize:11}}>{b.severity}</span> {b.description}</div><button className="btn btn-sm btn-secondary" onClick={()=>store.resolveBlocker(p.id,b.id)}>Снять</button></div>)}</div>}
      {showAssign&&<Modal onClose={()=>setShowAssign(false)}><h2>Назначить на проект</h2>
        <div className="form-group"><label>Сотрудник</label><select value={af.person_id} onChange={e=>setAf(p=>({...p,person_id:e.target.value}))}><option value="">—</option>{store.data.persons.filter(pe=>!assignedIds.has(pe.id)).map(pe=><option key={pe.id} value={pe.id}>{pe.name} — {pe.position||''}</option>)}</select></div>
        <div className="form-group"><label>Роль</label><select value={af.role_code} onChange={e=>setAf(p=>({...p,role_code:e.target.value}))}><option>PM</option><option>ANALYST</option><option>CONSULTANT</option><option>LEAD</option><option>EXPERT</option></select></div>
        <div className="form-actions"><button className="btn btn-secondary" onClick={()=>setShowAssign(false)}>Отмена</button><button className="btn btn-primary" onClick={()=>{if(af.person_id){store.addAssignment(p.id,af.person_id,af.role_code);setShowAssign(false);}}}>Назначить</button></div>
      </Modal>}

      {/* === Компетенции проекта === */}
      {(()=>{
        const tracks=p.tracks||[];
        const te=p.timeEntries||[];
        const personIds=new Set(te.map(x=>x.person_id));
        const projPersons=store.data.persons.filter(pe=>personIds.has(pe.id));
        const hoursMap={};
        te.forEach(x=>{hoursMap[x.person_id]=(hoursMap[x.person_id]||0)+(Number(x.hours)||0);});
        const compData=projPersons.map(pe=>{
          const comp=pe.competencies||{};
          const bpmExp=pe.bpm_expertise||{};
          const hrs=hoursMap[pe.id]||0;
          return {person:pe,hours:hrs,comp,bpmExp};
        });
        const bpmTracks=tracks.filter(t=>(t.track_class||'').toUpperCase()==='BPM');
        const bpaTracks=tracks.filter(t=>(t.track_class||'').toUpperCase()==='BPA');
        const bpiTracks=tracks.filter(t=>(t.track_class||'').toUpperCase()==='BPI');
        const bpoTracks=tracks.filter(t=>(t.track_class||'').toUpperCase()==='BPO');
        return <div className="card" style={{marginTop:12}}>
          <div className="card-title">Обеспеченность компетенциями</div>
          {compData.length===0?<div className="empty">Нет участников с часами</div>:
          <table><thead><tr><th>Имя</th><th>Часы</th>{COMPETENCY_MODEL.map(cm=><th key={cm.key} title={cm.name} style={{fontSize:9,maxWidth:40,textAlign:'center'}}>{cm.short}</th>)}</tr></thead>
          <tbody>{compData.map(cd=><tr key={cd.person.id}><td>{cd.person.name}</td><td>{cd.hours}</td>{COMPETENCY_MODEL.map(cm=><td key={cm.key} style={{textAlign:'center',fontSize:10,color:(cd.comp[cm.key]||0)>0?'var(--accent)':'var(--text2)'}}>{cd.comp[cm.key]||'—'}</td>)}</tr>)}</tbody></table>}

          {bpmTracks.length>0&&<div style={{marginTop:12}}><div style={{fontSize:12,fontWeight:600,marginBottom:6}}>BPM-экспертиза</div>
            <table><thead><tr><th>Имя</th>{bpmTracks.map(t=><th key={t.id} style={{fontSize:9,maxWidth:50,textAlign:'center'}} title={t.track_name}>{t.track_code}</th>)}</tr></thead>
            <tbody>{compData.map(cd=><tr key={cd.person.id}><td>{cd.person.name}</td>{bpmTracks.map(t=>{const lv=cd.bpmExp[t.track_code]||0;return <td key={t.id} style={{textAlign:'center',fontSize:10,color:lv>0?'var(--accent)':'var(--text2)'}}>{BPM_EXP_LEVELS[lv]?.short||'—'}</td>;})}</tr>)}</tbody></table>
          </div>}

          <div style={{marginTop:12,display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:8}}>
            <div style={{padding:6,borderRadius:6,background:'var(--bg1)',textAlign:'center'}}><div style={{fontSize:9,color:'var(--text2)'}}>BPM</div><div style={{fontSize:14,fontWeight:700,color:'var(--accent)'}}>{bpmTracks.length}</div></div>
            <div style={{padding:6,borderRadius:6,background:'var(--bg1)',textAlign:'center'}}><div style={{fontSize:9,color:'var(--text2)'}}>BPA</div><div style={{fontSize:14,fontWeight:700,color:'var(--sky)'}}>{bpaTracks.length}</div></div>
            <div style={{padding:6,borderRadius:6,background:'var(--bg1)',textAlign:'center'}}><div style={{fontSize:9,color:'var(--text2)'}}>BPI</div><div style={{fontSize:14,fontWeight:700,color:'var(--violet)'}}>{bpiTracks.length}</div></div>
            <div style={{padding:6,borderRadius:6,background:'var(--bg1)',textAlign:'center'}}><div style={{fontSize:9,color:'var(--text2)'}}>BPO</div><div style={{fontSize:14,fontWeight:700,color:'var(--emerald)'}}>{bpoTracks.length}</div></div>
          </div>
        </div>;
      })()}
    </div>}

    {tab==='admin_scale'&&<div>
      {(()=>{
        const sections=ADMIN_SCALE_SECTIONS.map(s=>{
          const as=p.admin_scale||{};
          return {...s,notes:as[s.key]||'',autoOk:s.autoCheck(p)};
        });
        const filled=sections.filter(s=>s.autoOk||s.notes.trim()).length;
        return <div className="card">
          <div className="card-title" style={{display:'flex',justifyContent:'space-between'}}>
            <span>Административная шкала Адизеса</span>
            <span style={{fontSize:11,color:'var(--accent)'}}>{filled}/{sections.length} заполнено</span>
          </div>
          <div style={{fontSize:11,color:'var(--text2)',marginBottom:12}}>Оцените полноту управленческой системы проекта по 9 элементам шкалы Адизеса</div>
          {sections.map(sec=><div key={sec.key} style={{marginBottom:12,padding:10,borderRadius:8,background:'var(--bg1)',border:'1px solid var(--border)'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
              <span style={{fontWeight:600,fontSize:12}}>{sec.num}. {sec.title}</span>
              {sec.autoOk&&<span style={{fontSize:9,color:'var(--green)',background:'rgba(34,197,94,0.1)',padding:'2px 6px',borderRadius:4}}>✓ {sec.autoLabel(p)}</span>}
            </div>
            <div style={{fontSize:10,color:'var(--text2)',marginBottom:4}}>{sec.hint}</div>
            {sec.key==='programs'?<div>
              <div className="as-tracks">
                {store.data.trackTemplates.map(tt=>{const isActive=(p.tracks||[]).some(t=>t.track_template_id===tt.id);const cls=tt.track_class?tt.track_class.toLowerCase():'';return <div key={tt.id} className={'as-track-chip'+(isActive?' active':'')+' '+cls} onClick={()=>{if(isActive){const trk=(p.tracks||[]).find(t=>t.track_template_id===tt.id);if(trk)store.deleteTrack(p.id,trk.id)}else{store.addTrack(p.id,tt.id)}}} title={tt.name+' ('+tt.track_class+')'}>{isActive?'✓ ':''}{tt.code}{isActive&&<span className="chip-x">×</span>}</div>;})}
              </div>
              <div style={{fontSize:10,color:'var(--text2)',marginTop:6}}>Нажмите на трек для добавления/удаления.</div>
            </div>:<div className="as-notes">
              <textarea value={sec.notes} onChange={e=>store.updateAdminScale(p.id,sec.key,e.target.value)} placeholder={'Заметки по разделу «'+sec.title+'»...'}/>
            </div>}
          </div>)}
        </div>;
      })()}
    </div>}

    {tab==='financials'&&<div>
      {(()=>{
        const trDisp=Number(p.tax_rate)||0;const tr=_effTax(p.tax_rate);
        const ohTotal=(p.overheads||[]).reduce((s,x)=>s+(Number(x.amount)||0),0);
        const costC5=projCosts.costAll-projCosts.costProd;
        /* P&L: revenue from ACCRUED + PAID */
        const pnlRevBrutto=totalPaid+totalAccrued||revenue;
        const pnlRevNet=Math.round(pnlRevBrutto*(1-tr/100));
        const pnlGross=pnlRevNet-ohTotal;
        const pnlDirty=pnlGross-projCosts.costProd;
        const pnlClean=pnlDirty-costC5;
        /* CF: revenue from PAID only */
        const cfRevBrutto=totalPaid;
        const cfRevNet=Math.round(cfRevBrutto*(1-tr/100));
        /* AR: ACCRUED not PAID */
        const arPayments=(p.payments||[]).filter(pm=>pm.status==='ACCRUED');
        const arTotal=totalAccrued;
        return <div>
          <div className="oc-tabs" style={{marginBottom:10}}>
            <div className={'oc-tab'+(finSub==='pnl'?' active':'')} onClick={()=>setFinSub('pnl')}>P&L</div>
            <div className={'oc-tab'+(finSub==='cf'?' active':'')} onClick={()=>setFinSub('cf')}>Кэшфлоу</div>
            <div className={'oc-tab'+(finSub==='ar'?' active':'')} onClick={()=>setFinSub('ar')}>ДЗ{arTotal>0&&<span style={{marginLeft:4,fontSize:10,color:'var(--amber)'}}>({fmt(arTotal)})</span>}</div>
          </div>
          <div className="card" style={{marginBottom:12}}>
            <div className="card-title" style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <span>Контракт: {(p.project_type==='New Delivery'||p.project_type==='ФК')?<span style={{color:'var(--accent)'}}>{fmt(totalPlanned)} {String.fromCharCode(8381)} <span style={{fontSize:10,color:'var(--text2)'}}>(сумма {(p.payments||[]).length} траншей)</span></span>:editTCV?<span><input type="number" value={tcvVal} onChange={e=>setTcvVal(e.target.value)} onBlur={()=>{store.updateProject(p.id,{total_contract_value:Number(tcvVal)||0});setEditTCV(false);}} onKeyDown={e=>{if(e.key==='Enter'){store.updateProject(p.id,{total_contract_value:Number(tcvVal)||0});setEditTCV(false);}}} style={{width:120,fontSize:12,padding:'2px 6px'}} autoFocus/> {String.fromCharCode(8381)}</span>:<span className="clickable" style={{color:'var(--accent)'}} onClick={()=>{setTcvVal(String(p.total_contract_value||''));setEditTCV(true);}}>{fmt(revenue)} {String.fromCharCode(8381)}</span>}</span>
              <div className="tax-select">
                {[0,11,20,22].map(r=><div key={r} className={'tax-btn'+(trDisp===r?' active':'')} onClick={()=>store.updateProject(p.id,{tax_rate:r})}>{r}%</div>)}
              </div>
            </div>
          </div>

          {finSub==='pnl'&&<div>
            <div className="fin-grid">
              <div className="fin-card"><div className="lbl">Выручка факт (брутто)</div><div className="val green-c">{fmt(pnlRevBrutto)} {String.fromCharCode(8381)}</div></div>
              <div className="fin-card"><div className="lbl">Выручка факт (нетто)</div><div className="val" style={{color:'var(--emerald)'}}>{fmt(pnlRevNet)} {String.fromCharCode(8381)}</div></div>
              <div className="fin-card"><div className="lbl">Контракт</div><div className="val accent-c">{fmt(revenue)} {String.fromCharCode(8381)}</div></div>
              <div className="fin-card"><div className="lbl">Часов</div><div className="val yellow-c">{totalHours.toFixed(1)}</div></div>
              <div className="fin-card"><div className="lbl">Косты произв.</div><div className="val" style={{color:'var(--red)'}}>{fmt(projCosts.costProd)} {String.fromCharCode(8381)}</div></div>
              <div className="fin-card"><div className="lbl">Косты C5</div><div className="val" style={{color:'var(--amber)'}}>{fmt(costC5)} {String.fromCharCode(8381)}</div></div>
              <div className="fin-card"><div className="lbl">Накладные</div><div className="val" style={{color:'var(--violet)'}}>{fmt(ohTotal)} {String.fromCharCode(8381)}</div></div>
              <div className="fin-card"><div className="lbl">ДЗ (не оплачено)</div><div className="val" style={{color:'var(--amber)'}}>{fmt(arTotal)} {String.fromCharCode(8381)}</div></div>
            </div>
            <div className="profit-panel">
              <div style={{fontSize:12,fontWeight:600,textTransform:'uppercase',letterSpacing:'.3px',color:'var(--text2)',marginBottom:8}}>P&L проекта (факт: признано + оплачено)</div>
              <div className="profit-row"><span className="pr-label">Выручка (брутто)</span><span className="pr-val">{fmt(pnlRevBrutto)} {String.fromCharCode(8381)}</span></div>
              <div className="profit-row"><span className="pr-label">— Налог ({trDisp}%)</span><span className="pr-val pr-neg">−{fmt(pnlRevBrutto-pnlRevNet)} {String.fromCharCode(8381)}</span></div>
              <div className="profit-row"><span className="pr-label">= Выручка (нетто)</span><span className="pr-val">{fmt(pnlRevNet)} {String.fromCharCode(8381)}</span></div>
              <div className="profit-row"><span className="pr-label">— Накладные расходы</span><span className="pr-val pr-neg">−{fmt(ohTotal)} {String.fromCharCode(8381)}</span></div>
              <div className="profit-row pr-total" style={{borderTop:'1px dashed var(--border)',paddingTop:6,marginTop:4}}><span className="pr-label" style={{fontWeight:600}}>= Валовая прибыль</span><span className={'pr-val '+(pnlGross>=0?'pr-pos':'pr-neg')}>{fmt(pnlGross)} {String.fromCharCode(8381)}{pnlRevBrutto>0?' ('+Math.round(pnlGross/pnlRevBrutto*100)+'%)':''}</span></div>
              <div className="profit-row"><span className="pr-label">— Затраты C1–C4</span><span className="pr-val pr-neg">−{fmt(projCosts.costProd)} {String.fromCharCode(8381)}</span></div>
              <div className="profit-row pr-total"><span className="pr-label" style={{fontWeight:700}}>= Грязная валовая прибыль</span><span className={'pr-val '+(pnlDirty>=0?'pr-pos':'pr-neg')}>{fmt(pnlDirty)} {String.fromCharCode(8381)}{pnlRevBrutto>0?' ('+Math.round(pnlDirty/pnlRevBrutto*100)+'%)':''}</span></div>
              <div className="profit-row"><span className="pr-label">— Затраты C5</span><span className="pr-val pr-neg">−{fmt(costC5)} {String.fromCharCode(8381)}</span></div>
              <div className="profit-row pr-total" style={{borderTop:'2px solid var(--accent)',paddingTop:10}}><span className="pr-label" style={{fontWeight:700}}>= Чистая валовая прибыль</span><span className={'pr-val '+(pnlClean>=0?'pr-pos':'pr-neg')}>{fmt(pnlClean)} {String.fromCharCode(8381)}{pnlRevBrutto>0?' ('+Math.round(pnlClean/pnlRevBrutto*100)+'%)':''}</span></div>
            </div>
          </div>}

          {finSub==='cf'&&<div>
            <div className="fin-grid">
              <div className="fin-card"><div className="lbl">Поступило (брутто)</div><div className="val green-c">{fmt(cfRevBrutto)} {String.fromCharCode(8381)}</div></div>
              <div className="fin-card"><div className="lbl">Поступило (нетто)</div><div className="val" style={{color:'var(--emerald)'}}>{fmt(cfRevNet)} {String.fromCharCode(8381)}</div></div>
              <div className="fin-card"><div className="lbl">Контракт</div><div className="val accent-c">{fmt(revenue)} {String.fromCharCode(8381)}</div></div>
              <div className="fin-card"><div className="lbl">Оплачено %</div><div className="val" style={{color:revenue>0&&totalPaid/revenue>=0.8?'var(--green)':'var(--amber)'}}>{revenue>0?Math.round(totalPaid/revenue*100):0}%</div></div>
            </div>
            {revenue>0&&<div className="card" style={{marginBottom:12}}><div className="card-title">Кэшфлоу ({Math.round(totalPaid/revenue*100)}%)</div><div className="progress-bar"><div className="progress-fill" style={{width:Math.min(100,Math.round(totalPaid/revenue*100))+'%',background:'var(--green)'}}></div></div></div>}
            <div style={{fontSize:11,color:'var(--text2)',padding:'8px 0'}}>Кэшфлоу учитывает только физически поступившие деньги (статус «оплачен»). Признанные по актам суммы — во вкладке P&L.</div>
            {(p.payments||[]).filter(pm=>pm.status==='PAID').length>0&&<table style={{fontSize:11}}><thead><tr><th>#</th><th>Сумма</th><th>Дата оплаты</th></tr></thead><tbody>{(p.payments||[]).filter(pm=>pm.status==='PAID').map(pm=><tr key={pm.id}><td>{pm.tranche_number}</td><td style={{fontWeight:600}}>{fmt(pm.amount)} {String.fromCharCode(8381)}</td><td style={{color:'var(--text2)'}}>{fmtD(pm.actual_date)}</td></tr>)}</tbody></table>}
          </div>}

          {finSub==='ar'&&<div>
            <div className="card" style={{marginBottom:12}}>
              <div className="card-title" style={{display:'flex',justifyContent:'space-between'}}>Дебиторская задолженность<span style={{fontWeight:700,color:arTotal>0?'var(--amber)':'var(--text2)'}}>{fmt(arTotal)} {String.fromCharCode(8381)}</span></div>
              {arPayments.length>0?<table style={{fontSize:11}}><thead><tr><th>#</th><th>Сумма</th><th>Дата признания</th><th>План. дата</th><th></th></tr></thead><tbody>{arPayments.map(pm=><tr key={pm.id}><td>{pm.tranche_number}</td><td style={{fontWeight:600}}>{fmt(pm.amount)} {String.fromCharCode(8381)}</td><td style={{color:'var(--amber)'}}>{fmtD(pm.accrued_date)}</td><td style={{color:'var(--text2)'}}>{fmtD(pm.planned_date)}</td><td><button className="btn btn-success btn-sm" style={{fontSize:10}} onClick={()=>store.markPaymentPaid(p.id,pm.id)}>Деньги пришли</button></td></tr>)}</tbody></table>:<div className="empty">Нет признанных неоплаченных траншей</div>}
            </div>
            <div style={{fontSize:11,color:'var(--text2)',padding:'8px 0'}}>ДЗ = транши со статусом «признан по актам», но ещё не оплаченные физически.</div>
          </div>}
        </div>;
      })()}
      <div className="card" style={{marginBottom:12}}><div className="card-title" style={{display:'flex',justifyContent:'space-between'}}>Проектные накладные <span style={{fontSize:11,color:'var(--text2)',fontWeight:400}}>Итого: {fmt((p.overheads||[]).reduce((s,x)=>s+(Number(x.amount)||0),0))} ₽</span></div>
        {(p.overheads||[]).length>0&&<div style={{overflowX:'auto'}}><table className="oh-table"><thead><tr><th>Название</th><th>Сумма</th><th>Дата</th><th>Категория</th><th>Класс</th><th>Формат</th><th>Ответственный</th><th>CF</th><th style={{fontSize:9}}>Пр.г.</th><th style={{fontSize:9}}>💸</th><th>Заметка</th><th></th></tr></thead><tbody>{(p.overheads||[]).map(oh=><tr key={oh.id} style={{background:oh.prior_year?'rgba(251,191,36,0.06)':''}}>
          <td><input defaultValue={oh.name} onBlur={e=>{const v=e.target.value.trim();if(v&&v!==oh.name)store.updateOverhead(p.id,oh.id,{name:v});}} style={{fontSize:11,padding:'2px 4px',width:'100%',border:'1px solid transparent',borderRadius:3,background:'transparent'}} onFocus={e=>{e.target.style.border='1px solid var(--accent)';e.target.style.background='var(--bg1)';}} onMouseOut={e=>{if(document.activeElement!==e.target)e.target.style.border='1px solid transparent';}}/></td>
          <td style={{fontWeight:600}}><input type="number" defaultValue={oh.amount} onBlur={e=>{const v=Number(e.target.value);if(v>=0&&v!==Number(oh.amount))store.updateOverhead(p.id,oh.id,{amount:v});}} style={{fontSize:11,fontWeight:600,padding:'2px 4px',width:80,border:'1px solid transparent',borderRadius:3,background:'transparent',textAlign:'right'}} onFocus={e=>{e.target.style.border='1px solid var(--accent)';e.target.style.background='var(--bg1)';}} onMouseOut={e=>{if(document.activeElement!==e.target)e.target.style.border='1px solid transparent';}}/> ₽</td>
          <td><input type="date" defaultValue={oh.date||''} onBlur={e=>{const v=e.target.value;if(v!==oh.date)store.updateOverhead(p.id,oh.id,{date:v});}} style={{fontSize:11,padding:'2px 4px',border:'1px solid transparent',borderRadius:3,background:'transparent',color:'var(--text2)'}} onFocus={e=>{e.target.style.border='1px solid var(--accent)';}} onMouseOut={e=>{if(document.activeElement!==e.target)e.target.style.border='1px solid transparent';}}/></td>
          <td><select defaultValue={oh.category||'Прочее'} onChange={e=>store.updateOverhead(p.id,oh.id,{category:e.target.value})} style={{fontSize:10,padding:'1px 2px',border:'1px solid transparent',borderRadius:3,background:'transparent'}}>{['Подрядчики','IT решения','Промо','АХО','Логистика','Зарплата ФК','Найм','Авансированная прибыль','Прочее'].map(c=><option key={c}>{c}</option>)}</select></td>
          <td><select defaultValue={oh.cls||'прочее'} onChange={e=>store.updateOverhead(p.id,oh.id,{cls:e.target.value})} style={{fontSize:10,padding:'1px 2px',border:'1px solid transparent',borderRadius:3,background:'transparent'}}>{['поддержка сайта','софт','билеты','для офиса','оборудование','дизайн','копирайтинг','монтаж','обработка данных','программирование','аналитика','найм','медиапартнерства','опросы','сбор данных','аренда помещения','прочее'].map(c=><option key={c}>{c}</option>)}</select></td>
          <td><select defaultValue={oh.format||'счет'} onChange={e=>store.updateOverhead(p.id,oh.id,{format:e.target.value})} style={{fontSize:10,padding:'1px 2px',border:'1px solid transparent',borderRadius:3,background:'transparent'}}>{['счет','нал','карта ИП'].map(c=><option key={c}>{c}</option>)}</select></td>
          <td><input defaultValue={oh.responsible||''} placeholder="—" onBlur={e=>{store.updateOverhead(p.id,oh.id,{responsible:e.target.value.trim()});}} style={{fontSize:10,padding:'2px 4px',width:80,border:'1px solid transparent',borderRadius:3,background:'transparent'}} onFocus={e=>{e.target.style.border='1px solid var(--accent)';}} onMouseOut={e=>{if(document.activeElement!==e.target)e.target.style.border='1px solid transparent';}}/></td>
          <td><select defaultValue={oh.cf_type||'OCF'} onChange={e=>store.updateOverhead(p.id,oh.id,{cf_type:e.target.value})} style={{fontSize:9,padding:'1px 2px',border:'1px solid transparent',borderRadius:3,background:'transparent'}}>{['OCF','ICF','AHO'].map(c=><option key={c}>{c}</option>)}</select></td>
          <td style={{textAlign:'center'}}><input type="checkbox" checked={!!oh.prior_year} onChange={e=>store.updateOverhead(p.id,oh.id,{prior_year:e.target.checked})} title="Расход прошлого года"/></td>
          <td style={{textAlign:'center',fontSize:11}}>{oh.disbursed?<span title={'Выдана: '+(oh.disbursed_by||'')} style={{color:'var(--sky)'}}>💸</span>:<span style={{color:'var(--text2)',fontSize:9}}>—</span>}</td>
          <td><input defaultValue={oh.notes||''} placeholder="—" onBlur={e=>{store.updateOverhead(p.id,oh.id,{notes:e.target.value.trim()});}} style={{fontSize:10,padding:'2px 4px',width:'100%',border:'1px solid transparent',borderRadius:3,background:'transparent',color:'var(--text2)'}} onFocus={e=>{e.target.style.border='1px solid var(--accent)';}} onMouseOut={e=>{if(document.activeElement!==e.target)e.target.style.border='1px solid transparent';}}/></td>
          <td><span className="clickable" style={{color:'var(--red)',fontSize:12}} onClick={()=>{if(confirm('Удалить накладную «'+oh.name+'»?'))store.removeOverhead(p.id,oh.id);}}>×</span></td></tr>)}</tbody></table></div>}
        <div className="oh-add" style={{display:'flex',flexWrap:'wrap',gap:4,alignItems:'flex-end'}}>
          <div className="form-group" style={{flex:'1 1 120px'}}><label style={{fontSize:10}}>Название</label><input value={ohf.name} onChange={e=>setOhf(f=>({...f,name:e.target.value}))} placeholder="Аренда, подрядчик..." style={{fontSize:11,padding:'4px 8px'}}/></div>
          <div className="form-group" style={{flex:'0 0 80px'}}><label style={{fontSize:10}}>Сумма (₽)</label><input type="number" value={ohf.amount} onChange={e=>setOhf(f=>({...f,amount:e.target.value}))} style={{fontSize:11,padding:'4px 8px',width:75}}/></div>
          <div className="form-group" style={{flex:'0 0 110px'}}><label style={{fontSize:10}}>Дата</label><input type="date" value={ohf.date} onChange={e=>setOhf(f=>({...f,date:e.target.value}))} style={{fontSize:11,padding:'4px 8px'}}/></div>
          <div className="form-group" style={{flex:'0 0 100px'}}><label style={{fontSize:10}}>Категория</label><select value={ohf.category} onChange={e=>setOhf(f=>({...f,category:e.target.value}))} style={{fontSize:10,padding:'4px 4px'}}>{['Подрядчики','IT решения','Промо','АХО','Логистика','Зарплата ФК','Найм','Авансированная прибыль','Прочее'].map(c=><option key={c}>{c}</option>)}</select></div>
          <div className="form-group" style={{flex:'0 0 100px'}}><label style={{fontSize:10}}>Класс</label><select value={ohf.cls} onChange={e=>setOhf(f=>({...f,cls:e.target.value}))} style={{fontSize:10,padding:'4px 4px'}}>{['поддержка сайта','софт','билеты','для офиса','оборудование','дизайн','копирайтинг','монтаж','обработка данных','программирование','аналитика','найм','медиапартнерства','опросы','сбор данных','аренда помещения','прочее'].map(c=><option key={c}>{c}</option>)}</select></div>
          <div className="form-group" style={{flex:'0 0 70px'}}><label style={{fontSize:10}}>Формат</label><select value={ohf.format} onChange={e=>setOhf(f=>({...f,format:e.target.value}))} style={{fontSize:10,padding:'4px 4px'}}>{['счет','нал','карта ИП'].map(c=><option key={c}>{c}</option>)}</select></div>
          <div className="form-group" style={{flex:'0 0 80px'}}><label style={{fontSize:10}}>Ответств.</label><input value={ohf.responsible||''} onChange={e=>setOhf(f=>({...f,responsible:e.target.value}))} style={{fontSize:10,padding:'4px 8px',width:75}}/></div>
          <div className="form-group" style={{flex:'0 0 55px'}}><label style={{fontSize:10}}>CF тип</label><select value={ohf.cf_type} onChange={e=>setOhf(f=>({...f,cf_type:e.target.value}))} style={{fontSize:10,padding:'4px 4px'}}>{['OCF','ICF','AHO'].map(c=><option key={c}>{c}</option>)}</select></div>
          <div className="form-group" style={{flex:'0 0 30px'}}><label style={{fontSize:9}} title="Расход прошлого года">Пр.г.</label><input type="checkbox" checked={ohf.prior_year} onChange={e=>setOhf(f=>({...f,prior_year:e.target.checked}))}/></div>
          <div className="form-group" style={{flex:'1 1 80px'}}><label style={{fontSize:10}}>Заметка</label><input value={ohf.notes||''} onChange={e=>setOhf(f=>({...f,notes:e.target.value}))} placeholder="..." style={{fontSize:11,padding:'4px 8px'}}/></div>
          <button className="btn btn-primary btn-sm" style={{marginBottom:12,padding:'4px 10px',fontSize:11}} onClick={()=>{if(ohf.name&&ohf.amount){store.addOverhead(p.id,ohf);setOhf({name:'',amount:'',date:'',notes:'',category:'Прочее',cls:'прочее',format:'счет',responsible:'',cf_type:'OCF',prior_year:false});}}}>+</button>
        </div>
      </div>
      {/* Progress bar moved to CF sub-tab */}
      <div className="card"><div className="card-title" style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>Транши <div style={{display:'flex',gap:6}}>{(p.payments||[]).some(pm=>pm.status!=='PAID')&&<button className="btn btn-sm" style={{background:'var(--emerald)',color:'#fff',border:'none',fontSize:10,padding:'3px 8px',cursor:'pointer'}} onClick={()=>{if(confirm('Признать все неоплаченные транши оплаченными?\nДата факта = дата плана'))store.markAllPaymentsPaid(p.id);}}>✓ Признать все оплаченными</button>}<button className="btn btn-primary btn-sm" onClick={()=>setShowPay(true)}>+ Транш</button></div></div>
        {(p.payments||[]).length>0?<table><thead><tr><th>#</th><th>Сумма</th><th>Дата</th><th>Статус</th><th></th></tr></thead><tbody>{p.payments.map(pm=>{const mLabel={'01':'Янв','02':'Фев','03':'Мар','04':'Апр','05':'Май','06':'Июн','07':'Июл','08':'Авг','09':'Сен','10':'Окт','11':'Ноя','12':'Дек'};const pdStr=pm.planned_date&&pm.planned_date.length===7?mLabel[pm.planned_date.slice(5,7)]+' '+pm.planned_date.slice(0,4):fmtD(pm.planned_date);return <tr key={pm.id} className="clickable" onClick={()=>setEditingPay(pm)}><td>{pm.tranche_number}</td><td style={{fontWeight:600}}>{fmt(pm.amount)} ₽</td><td style={{color:'var(--text2)'}}>{pdStr}{pm.status==='PAID'&&pm.actual_date?' → '+fmtD(pm.actual_date):''}</td><td>{pm.payment_type==='PLANNED'?<span style={{fontSize:9,color:'var(--accent2)'}}>план</span>:''} {SB(pm.status)}{pm.accrued_date&&<span style={{fontSize:9,color:'var(--amber)',marginLeft:4}}>акт: {fmtD(pm.accrued_date)}</span>}</td><td onClick={e=>e.stopPropagation()} style={{whiteSpace:'nowrap'}}><button className="btn btn-sm" title="Копировать транш" style={{background:'var(--bg3)',border:'1px solid var(--border)',cursor:'pointer',fontSize:10,marginRight:4,padding:'2px 6px'}} onClick={()=>store.addPayment(p.id,{tranche_number:Math.max(...(p.payments||[]).map(x=>x.tranche_number||0))+1,amount:pm.amount,planned_date:pm.planned_date||'',actual_date:'',accrued_date:'',status:'PLANNED',description:pm.description||'',prior_year:pm.prior_year||false,payment_type:pm.payment_type||'PLANNED',expected_week_monday:pm.expected_week_monday||''})}>⧉</button>{pm.status==='PLANNED'&&<button className="btn btn-sm" style={{background:'var(--amber)',color:'#000',border:'none',cursor:'pointer',fontSize:10}} onClick={()=>store.markPaymentAccrued(p.id,pm.id)}>По актам</button>}{pm.status==='ACCRUED'&&<button className="btn btn-success btn-sm" style={{fontSize:10}} onClick={()=>store.markPaymentPaid(p.id,pm.id)}>Деньги пришли</button>}</td></tr>;})}</tbody></table>:<div className="empty">Нет траншей</div>}
        {editingPay&&<EditPaymentModal payment={editingPay} projId={p.id} store={store} onClose={()=>setEditingPay(null)}/>}
      </div>
      <div className="card"><div className="card-title" style={{display:'flex',justifyContent:'space-between'}}>Время <button className="btn btn-primary btn-sm" onClick={()=>{setTeRows([{person_id:'',month:new Date().toISOString().slice(0,7),hours:'',work_phase:'MINING_ASSEMBLING',description:''}]);setShowTime(true);}}>+ Списать</button></div>
        {(p.timeEntries||[]).length>0?<table><thead><tr><th>Дата</th><th>Кто</th><th>Грейд</th><th>{p.project_type==='New Delivery'?'Период':'Фаза'}</th><th>Часы</th><th>Ставка</th><th>Стоимость</th><th>Описание</th><th style={{width:28}}></th></tr></thead><tbody>{p.timeEntries.slice(0,15).map(te=>{const per=store.data.persons.find(x=>x.id===te.person_id);const sal=per?per.salary_monthly:0;const teD=te.date?new Date(te.date):new Date();const dy=teD.getDay();const df=teD.getDate()-dy+(dy===0?-6:1);const wk=new Date(teD.getFullYear(),teD.getMonth(),df).toISOString().slice(0,10);const wts=per?(per.weekly_timesheets||[]):[];const we=wts.find(w=>w.week_start===wk);const oh=we?we.open_hours:40;const rt=oh>0&&sal>0?Math.round(sal/(oh*4.33)):0;const cost=rt*(Number(te.hours)||0);return <tr key={te.id}><td style={{color:'var(--text2)'}}>{fmtD(te.date)}</td><td>{te.person_name}</td><td style={{fontSize:11}}>{per?per.grade||'—':'—'}</td><td style={{fontSize:10,color:'var(--accent2)'}}>{p.project_type==='New Delivery'?((p.phases||[]).find(ph=>ph.phase_code===te.work_phase)?.phase_name||te.work_phase||'—'):({MINING_ASSEMBLING:'М+А',IMPLEMENTATION:'Внедр.',ORGANISATION:'Орг.'})[te.work_phase||'MINING_ASSEMBLING']||'М+А'}</td><td style={{fontWeight:600}}><input type="number" step="0.5" min="0" defaultValue={te.hours} onBlur={e=>{const nv=Number(e.target.value);if(nv!==Number(te.hours)&&nv>=0)store.updateTimeEntry(p.id,te.id,{hours:nv});}} style={{width:50,fontSize:12,fontWeight:600,padding:'1px 4px',border:'1px solid transparent',borderRadius:4,background:'transparent',textAlign:'center'}} onFocus={e=>{e.target.style.border='1px solid var(--accent)';e.target.style.background='var(--bg1)';}} onMouseOver={e=>{e.target.style.border='1px solid var(--border)';}} onMouseOut={e=>{if(document.activeElement!==e.target)e.target.style.border='1px solid transparent';}}/></td><td style={{fontSize:11,color:'var(--text2)'}}>{rt>0?fmt(rt)+' ₽':'—'}</td><td style={{fontWeight:600,color:'var(--accent)'}}>{cost>0?fmt(Math.round(cost))+' ₽':'—'}</td><td style={{color:'var(--text2)',fontSize:11}}>{te.description||'—'}</td><td><button title="Удалить запись" style={{background:'none',border:'none',cursor:'pointer',color:'var(--red)',fontSize:14,lineHeight:1,padding:0}} onClick={()=>{if(confirm('Удалить запись: '+te.person_name+' '+te.hours+'ч от '+(te.date||'?')+'?'))store.deleteTimeEntry(p.id,te.id);}}>✕</button></td></tr>;})}</tbody></table>:<div className="empty">Нет записей</div>}
      </div>
      {showPay&&<Modal onClose={()=>setShowPay(false)}><h2>Новый транш</h2>
        <div className="form-row"><div className="form-group"><label># транша</label><input type="number" value={pf.tranche_number} onChange={e=>setPf(p=>({...p,tranche_number:Number(e.target.value)}))}/></div><div className="form-group"><label>Сумма (₽)</label><input type="number" value={pf.amount} onChange={e=>setPf(p=>({...p,amount:e.target.value}))}/></div></div>
        <div className="form-row"><div className="form-group"><label>Дата (план)</label><input type="date" value={pf.planned_date} onChange={e=>setPf(p=>({...p,planned_date:e.target.value}))}/></div><div className="form-group"><label>Описание</label><input value={pf.description} onChange={e=>setPf(p=>({...p,description:e.target.value}))}/></div></div>
        {(()=>{const phGrps=getPhaseGroups(p);return phGrps.length>0?<div className="form-group"><label>Привязка к стадии</label><select value={pf.phase_id||''} onChange={e=>setPf(x=>({...x,phase_id:e.target.value||null}))}><option value="">— Без привязки —</option>{phGrps.map(g=><option key={g.id} value={g.phases[0]?.id||g.id}>{g.group_name}</option>)}</select></div>:null;})()}
        <div className="form-actions"><button className="btn btn-secondary" onClick={()=>setShowPay(false)}>Отмена</button><button className="btn btn-primary" onClick={()=>{if(pf.amount&&pf.planned_date){store.addPayment(p.id,{...pf,amount:Number(pf.amount),phase_id:pf.phase_id||null});setShowPay(false);}}}>Добавить</button></div>
      </Modal>}
      {showTime&&<Modal onClose={()=>{setShowTime(false);setTeRows([]);}} style={{maxWidth:720}}><h2>Списать время</h2>
        <table style={{width:'100%',fontSize:12,borderCollapse:'collapse',marginBottom:8}}><thead><tr style={{borderBottom:'1px solid var(--border)'}}><th style={{padding:'4px 4px',textAlign:'left'}}>Сотрудник</th><th style={{padding:'4px 4px',textAlign:'left'}}>Месяц</th><th style={{padding:'4px 4px',textAlign:'left',width:60}}>Часы</th><th style={{padding:'4px 4px',textAlign:'left'}}>{p.project_type==='New Delivery'?'Период':'Фаза'}</th><th style={{padding:'4px 4px',textAlign:'left'}}>Описание</th><th style={{width:28}}></th></tr></thead>
        <tbody>{teRows.map((r,i)=><tr key={i}><td style={{padding:'3px 4px',minWidth:150}}><PersonAutocomplete persons={store.data.persons} value={r.person_id} onChange={v=>_teUpd(i,'person_id',v)} onCreatePerson={(name)=>{const np=store.addPerson({name,salary_monthly:0,paei:{p:0,a:0,e:0,i:0},competencies:{},bpm_expertise:{}});return np;}}/></td>
        <td style={{padding:'3px 4px'}}><input type="month" value={r.month} onChange={e=>_teUpd(i,'month',e.target.value)} style={{fontSize:11,padding:'2px 4px',width:130}}/></td>
        <td style={{padding:'3px 4px'}}><input type="number" step="0.5" min="0" value={r.hours} onChange={e=>_teUpd(i,'hours',e.target.value)} style={{fontSize:11,padding:'2px 4px',width:55}}/></td>
        <td style={{padding:'3px 4px'}}>{p.project_type==='New Delivery'?<select value={r.work_phase||''} onChange={e=>_teUpd(i,'work_phase',e.target.value)} style={{fontSize:10,padding:'2px 4px',width:'100%'}}><option value="">—</option>{(p.phases||[]).map(ph=><option key={ph.id} value={ph.phase_code}>{ph.phase_name}</option>)}</select>:<select value={r.work_phase||'MINING_ASSEMBLING'} onChange={e=>_teUpd(i,'work_phase',e.target.value)} style={{fontSize:10,padding:'2px 4px'}}><option value="MINING_ASSEMBLING">М+А</option><option value="IMPLEMENTATION">Внедр.</option><option value="ORGANISATION">Орг.</option></select>}</td>
        <td style={{padding:'3px 4px'}}><input value={r.description} onChange={e=>_teUpd(i,'description',e.target.value)} placeholder="..." style={{fontSize:11,padding:'2px 4px',width:'100%'}}/></td>
        <td style={{padding:'3px 4px'}}><button style={{background:'none',border:'none',cursor:'pointer',color:'var(--red)',fontSize:14,lineHeight:1}} onClick={()=>_teRm(i)}>✕</button></td></tr>)}
        {teRows.length===0&&<tr><td colSpan={6} style={{textAlign:'center',color:'var(--text2)',padding:12,fontSize:11}}>Нажмите «+ Строка» для добавления записей</td></tr>}
        </tbody></table>
        <div style={{display:'flex',gap:8,marginBottom:8}}><button type="button" className="btn btn-secondary btn-sm" style={{fontSize:11}} onClick={_teAddRow}>+ Строка</button>{teRows.length>0&&<span style={{fontSize:11,color:'var(--text2)',alignSelf:'center'}}>Итого: {teRows.reduce((s,r)=>s+(Number(r.hours)||0),0)} ч · строк: {teRows.length}</span>}</div>
        <div className="form-actions"><button className="btn btn-secondary" onClick={()=>{setShowTime(false);setTeRows([]);}}>Отмена</button><button className="btn btn-primary" onClick={()=>{const valid=teRows.filter(r=>r.person_id&&r.month&&Number(r.hours)>0);if(!valid.length)return;valid.forEach(r=>{store.addTimeEntry(p.id,{person_id:r.person_id,date:r.month+'-15',hours:Number(r.hours),work_phase:r.work_phase||'MINING_ASSEMBLING',description:r.description||''});});setTeRows([]);setShowTime(false);}}>{teRows.filter(r=>r.person_id&&Number(r.hours)>0).length>0?'Списать '+teRows.filter(r=>r.person_id&&Number(r.hours)>0).length+' записей':'Списать'}</button></div>
      </Modal>}
    </div>}

    {tab==='documents'&&<div>
      <div className="card">
        <div className="card-title" style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          Документы проекта ({(p.documents||[]).length})
          <button className="btn btn-primary btn-sm" onClick={()=>setShowDoc(true)}>+ Документ</button>
        </div>
        {(()=>{
          const docs=p.documents||[];
          const types=['ALL','Договор','Устав','ТЗ','NDA','КП','Бриф','Акт','Отчёт','Прочее'];
          const usedTypes=new Set(docs.map(d=>d.doc_type));
          const shownTypes=types.filter(t=>t==='ALL'||usedTypes.has(t));
          const filtered=docFilter==='ALL'?docs:docs.filter(d=>d.doc_type===docFilter);
          const iconMap={'Договор':'📄','Устав':'📋','ТЗ':'📝','NDA':'🔒','КП':'💼','Бриф':'📑','Акт':'✅','Отчёт':'📊','Прочее':'📎'};
          return <div>
            {docs.length>1&&<div className="doc-filter-bar">
              {shownTypes.map(t=><div key={t} className={'doc-filter-chip'+(docFilter===t?' active':'')} onClick={()=>setDocFilter(t)}>{t==='ALL'?'Все ('+docs.length+')':t+' ('+(docs.filter(d=>d.doc_type===t).length)+')'}</div>)}
            </div>}
            {filtered.length===0?<div className="empty">Нет документов{docFilter!=='ALL'?' типа «'+docFilter+'»':''}.</div>:
            filtered.map(doc=><div key={doc.id}>
              <div className="doc-item">
                <div className="doc-icon">{iconMap[doc.doc_type]||'📎'}</div>
                <div className="doc-info">
                  <div className="doc-name">{doc.name}{doc.file_data?' (файл)':''}</div>
                  <div className="doc-meta">{doc.doc_type}{doc.description?' · '+doc.description:''} · {new Date(doc.added_at).toLocaleDateString('ru-RU')}</div>
                  {doc.url&&<div style={{display:'flex',gap:8,alignItems:'center'}}>
                    <a href={doc.url} target="_blank" style={{color:'var(--accent)',textDecoration:'none',fontSize:11}}>Открыть ↗</a>
                    <span className="doc-embed-toggle" onClick={()=>setEmbedDoc(embedDoc===doc.id?null:doc.id)}>{embedDoc===doc.id?'Скрыть превью ▲':'Превью ▼'}</span>
                  </div>}
                  {doc.file_data&&<a href={doc.file_data} download={doc.file_name||doc.name} style={{color:'var(--accent)',textDecoration:'none',fontSize:11}}>Скачать файл ↓</a>}
                </div>
                <button className="doc-del" onClick={()=>store.deleteDocument(p.id,doc.id)} title="Удалить">×</button>
              </div>
              {embedDoc===doc.id&&doc.url&&<div className="doc-embed-wrap">
                <iframe src={doc.url.includes('docs.google.com')?doc.url.replace(/\/edit.*$/,'/preview'):doc.url.includes('figma.com')?doc.url.replace('figma.com/','figma.com/embed?embed_host=share&url='+encodeURIComponent(doc.url)+'&'):doc.url} title={doc.name} sandbox="allow-scripts allow-same-origin allow-popups"/>
              </div>}
            </div>)}
          </div>;
        })()}
      </div>
      {showDoc&&<Modal onClose={()=>setShowDoc(false)}><h2>Добавить документ</h2>
        <div className="doc-upload-zone" onClick={()=>{const inp=document.createElement('input');inp.type='file';inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const reader=new FileReader();reader.onload=()=>{setDocF(x=>({...x,name:x.name||f.name,file_data:reader.result,file_name:f.name}));};reader.readAsDataURL(f);};inp.click();}}>
          <div className="upload-icon">📁</div>
          {docF.file_name?<div style={{color:'var(--green)',fontWeight:600}}>Файл: {docF.file_name}</div>:<div>Нажмите для загрузки файла<br/><span style={{fontSize:10}}>PDF, DOCX, XLSX, PNG, JPG и др.</span></div>}
        </div>
        <div className="form-group"><label>Название *</label><input value={docF.name} onChange={e=>setDocF(x=>({...x,name:e.target.value}))}/></div>
        <div className="form-row">
          <div className="form-group"><label>Тип</label><select value={docF.doc_type} onChange={e=>setDocF(x=>({...x,doc_type:e.target.value}))}><option>Договор</option><option>Устав</option><option>ТЗ</option><option>NDA</option><option>КП</option><option>Бриф</option><option>Акт</option><option>Отчёт</option><option>Прочее</option></select></div>
          <div className="form-group"><label>Ссылка (URL)</label><input value={docF.url} onChange={e=>setDocF(x=>({...x,url:e.target.value}))} placeholder="https://docs.google.com/..."/></div>
        </div>
        <div className="form-group"><label>Описание</label><input value={docF.description} onChange={e=>setDocF(x=>({...x,description:e.target.value}))}/></div>
        <div className="form-actions"><button className="btn btn-secondary" onClick={()=>setShowDoc(false)}>Отмена</button><button className="btn btn-primary" onClick={()=>{if(docF.name){store.addDocument(p.id,{...docF});setShowDoc(false);setDocF({name:'',doc_type:'Договор',url:'',description:'',file_data:null,file_name:''});}else{alert('Укажите название документа')}}}>Добавить</button></div>
      </Modal>}
    </div>}

    {/* ===== КАРТА МЕТРИК ПРОЕКТА ===== */}
    {tab==='metrics_map'&&(()=>{
      const projName=p.name;
      const map=store.getMetricsMap(projName);
      const nodes=map.nodes||[];
      const links=map.links||[];
      const _isAND=(projName||'').toLowerCase().includes('анд');
      const GROUP_ORDER=_isAND
        ?['finance','commerce','procurement','marketing','ops','logistics','hr']
        :['finance','strategy','marketing','commerce','ops','structure','hr','culture','it'];
      const _usedGroups=new Set(nodes.map(n=>n.group).filter(Boolean));
      const groups=[...GROUP_ORDER.filter(g=>_usedGroups.has(g)),...[..._usedGroups].filter(g=>!GROUP_ORDER.includes(g)).sort()];
      const GROUP_COLORS=_isAND
        ?{finance:'#3b82f6',commerce:'#10b981',procurement:'#d97706',marketing:'#f97316',ops:'#ec4899',logistics:'#8b5cf6',hr:'#0ea5e9'}
        :{finance:'#10b981',strategy:'#8b5cf6',marketing:'#d4a054',commerce:'#f97316',ops:'#ef4444',structure:'#3b82f6',hr:'#0ea5e9',culture:'#e2e8f0',it:'#94a3b8'};
      const gColor=(g)=>GROUP_COLORS[g]||'#64748b';
      const GROUP_LABELS={finance:'Финансы',strategy:'Стратегия',marketing:'Маркетинг',commerce:'Коммерция',ops:'Операции',structure:'Структура',hr:'HR',culture:'Культура',it:'ИТ',procurement:'Закупки',logistics:'Логистика',sales:'Продажи',product:'Продукт',tech:'Технологии'};
      const gLabel=(g)=>GROUP_LABELS[g]||g;

      const showImport=mmShowImport,setShowImport=setMmShowImport;
      const jsonText=mmJsonText,setJsonText=setMmJsonText;
      const dragOver=mmDragOver,setDragOver=setMmDragOver;
      const _extractJson=(raw)=>{
        /* helper: конвертировать linksData [[from,to,type],...] в [{from,to},...] */
        const _normLinks=(arr)=>{if(!Array.isArray(arr)||arr.length===0)return arr;if(Array.isArray(arr[0]))return arr.map(a=>({from:a[0],to:a[1]}));return arr;};
        /* 1) прямой JSON */
        try{const d=JSON.parse(raw);if(d.nodes&&d.links)return{nodes:d.nodes,links:_normLinks(d.links)};} catch(_){}
        /* 2) JS: отдельные nodes=[] и linksData=[] / links=[] */
        const _jsToJson=(s)=>{/* конвертируем JS-литерал в JSON */let r=s;r=r.replace(/,\s*([\]}])/g,'$1');/* trailing commas */r=r.replace(/(['"])?([a-zA-Z_]\w*)\s*:/g,(m,q,k)=>q?m:'"'+k+'":');/* unquoted keys → "key": */r=r.replace(/'([^'\\]*(\\.[^'\\]*)*)'/g,'"$1"');/* ' → " */return r;};
        const _findArr=(name)=>{const re=new RegExp('\\b'+name+'\\s*=\\s*\\[','g');let m;while((m=re.exec(raw))!==null){const start=m.index+m[0].length-1;let dep=0;let end=-1;for(let i=start;i<raw.length;i++){if(raw[i]==='[')dep++;if(raw[i]===']')dep--;if(dep===0){end=i;break;}}if(end<0||end-start<3)continue;const s=raw.slice(start,end+1);try{const a=JSON.parse(s);if(Array.isArray(a)&&a.length>0)return a;}catch(_){try{const a=JSON.parse(_jsToJson(s));if(Array.isArray(a)&&a.length>0)return a;}catch(_2){}}}return null;};
        const nArr=_findArr('nodes');const lArr=_findArr('linksData')||_findArr('links');
        if(nArr&&Array.isArray(nArr)&&nArr.length>0&&lArr&&Array.isArray(lArr)){return{nodes:nArr,links:_normLinks(lArr)};}
        /* 3) единый объект data={nodes:[],links:[]} */
        const dataRe=/(?:const|let|var)\s+\w+\s*=\s*(\{[\s\S]*?"nodes"\s*:[\s\S]*?"links"\s*:[\s\S]*?\})\s*;/;
        const dm=raw.match(dataRe);if(dm){try{const d=JSON.parse(dm[1]);if(d.nodes&&d.links)return{nodes:d.nodes,links:_normLinks(d.links)};}catch(_){}}
        /* 4) brute-force */
        for(let i=0;i<raw.length&&i<500000;i++){if(raw[i]==='{'){let dep=0;for(let j=i;j<raw.length;j++){if(raw[j]==='{')dep++;if(raw[j]==='}')dep--;if(dep===0){try{const d=JSON.parse(raw.slice(i,j+1));if(d.nodes&&d.links)return{nodes:d.nodes,links:_normLinks(d.links)};}catch(_){}break;}}}}
        return null;
      };
      const doImport=()=>{const d=_extractJson(jsonText);if(d){store.setMetricsMap(projName,{nodes:d.nodes,links:d.links});setShowImport(false);setJsonText('');} else{alert('Не удалось найти данные метрик (nodes + links).\nУбедитесь что файл содержит JSON с полями "nodes" и "links".');}};
      const handleDrop=(e)=>{e.preventDefault();e.stopPropagation();setDragOver(false);const file=(e.dataTransfer.files&&e.dataTransfer.files[0])||(e.dataTransfer.items&&e.dataTransfer.items[0]&&e.dataTransfer.items[0].getAsFile());if(!file)return;const reader=new FileReader();reader.onload=(ev)=>{setJsonText(ev.target.result);};reader.readAsText(file);};
      const handleFileInput=(e)=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=(ev)=>{setJsonText(ev.target.result);};reader.readAsText(file);};
      const preventDef=(e)=>{e.preventDefault();e.stopPropagation();setDragOver(true);};

      const showAddNode=mmShowAddNode,setShowAddNode=setMmShowAddNode;
      const nn=mmNn,setNn=setMmNn;
      const doAddNode=()=>{if(!nn.id||!nn.label)return;store.addMetricsNode(projName,{...nn});setNn({id:'',label:'',group:'finance',fact:'',target:'',tip:'',comment:''});setShowAddNode(false);};

      const showAddLink=mmShowAddLink,setShowAddLink=setMmShowAddLink;
      const nl=mmNl,setNl=setMmNl;
      const doAddLink=()=>{if(!nl.from||!nl.to)return;store.addMetricsLink(projName,{from:nl.from,to:nl.to});setNl({from:'',to:'',group:''});setShowAddLink(false);};

      const editNode=mmEditNode,setEditNode=setMmEditNode;
      const hovNode=mmHovNode,setHovNode=setMmHovNode;
      const hovPos=mmHovPos,setHovPos=setMmHovPos;

      /* SVG Layout: группы в колонках */
      const NODE_W=180,NODE_H=70,PAD_X=40,PAD_Y=20,TOP=60;
      const groupCols={};groups.forEach((g,i)=>{groupCols[g]=i;});
      const groupNodeIdx={};const nodePos={};
      nodes.forEach(n=>{
        const g=n.group||'_';if(!groupNodeIdx[g])groupNodeIdx[g]=0;
        const col=groupCols[g]!==undefined?groupCols[g]:groups.length;
        const row=groupNodeIdx[g]++;
        nodePos[n.id]={x:PAD_X+col*(NODE_W+PAD_X),y:TOP+row*(NODE_H+PAD_Y)};
      });
      const svgW=Math.max(600,(groups.length||1)*(NODE_W+PAD_X)+PAD_X);
      const maxRow=Math.max(1,...Object.values(groupNodeIdx));
      const svgH=Math.max(400,TOP+maxRow*(NODE_H+PAD_Y)+PAD_Y);

      return <div>
        <div style={{fontSize:14,fontWeight:700,marginBottom:10,color:'var(--accent)'}}>Карта метрик — {projName}</div>

        {/* Тулбар */}
        <div style={{display:'flex',gap:6,marginBottom:10,flexWrap:'wrap'}}>
          <button onClick={()=>setShowImport(s=>!s)} style={{fontSize:10,padding:'4px 12px',borderRadius:6,border:'1px solid var(--border)',background:showImport?'var(--accent)':'var(--bg1)',color:showImport?'#fff':'var(--text2)',cursor:'pointer'}}>Импорт JSON</button>
          <button onClick={()=>setShowAddNode(s=>!s)} style={{fontSize:10,padding:'4px 12px',borderRadius:6,border:'1px solid var(--emerald)',background:showAddNode?'var(--emerald)':'var(--bg1)',color:showAddNode?'#fff':'var(--emerald)',cursor:'pointer'}}>+ Метрика</button>
          <button onClick={()=>setShowAddLink(s=>!s)} style={{fontSize:10,padding:'4px 12px',borderRadius:6,border:'1px solid var(--violet)',background:showAddLink?'var(--violet)':'var(--bg1)',color:showAddLink?'#fff':'var(--violet)',cursor:'pointer'}}>+ Связь</button>
          <button onClick={()=>{navigator.clipboard.writeText(JSON.stringify({nodes,links},null,2));}} style={{fontSize:10,padding:'4px 12px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg1)',color:'var(--text2)',cursor:'pointer'}}>Копировать JSON</button>
          <span style={{fontSize:10,color:'var(--text2)',alignSelf:'center'}}>Метрик: {nodes.length} | Связей: {links.length}</span>
        </div>

        {/* Импорт JSON (вставка текста или drag-n-drop файла) */}
        {showImport&&<div style={{marginBottom:10,padding:10,background:'var(--bg3)',borderRadius:8}}>
          <div style={{fontSize:11,fontWeight:600,marginBottom:4}}>Вставьте JSON или перетащите файл:</div>
          <div onDragOver={preventDef} onDragEnter={preventDef} onDragLeave={()=>setDragOver(false)} onDrop={handleDrop}
            style={{border:'2px dashed '+(dragOver?'var(--accent)':'var(--border)'),borderRadius:6,padding:6,background:dragOver?'rgba(67,97,238,0.08)':'transparent',transition:'all .15s',marginBottom:4}}>
            <textarea value={jsonText} onChange={e=>setJsonText(e.target.value)} onDragOver={preventDef} onDrop={handleDrop} rows={6} placeholder="Вставьте JSON сюда или перетащите .json файл..." style={{width:'100%',fontSize:10,fontFamily:'monospace',border:'1px solid var(--border)',borderRadius:4,padding:6,resize:'vertical',background:'var(--bg0)'}}/>
          </div>
          <div style={{display:'flex',gap:6,marginTop:4,alignItems:'center'}}>
            <button onClick={doImport} style={{fontSize:10,padding:'3px 12px',borderRadius:4,background:'var(--accent)',color:'#fff',border:'none',cursor:'pointer'}}>Импортировать</button>
            <label style={{fontSize:10,padding:'3px 12px',borderRadius:4,background:'var(--bg1)',border:'1px solid var(--border)',cursor:'pointer',display:'inline-block'}}>Выбрать файл<input type="file" accept=".json,.txt,.html,.htm" onChange={handleFileInput} style={{display:'none'}}/></label>
            <button onClick={()=>setShowImport(false)} style={{fontSize:10,padding:'3px 12px',borderRadius:4,background:'var(--bg1)',border:'1px solid var(--border)',cursor:'pointer'}}>Отмена</button>
          </div>
        </div>}

        {/* Добавить метрику */}
        {showAddNode&&<div style={{marginBottom:10,padding:10,background:'var(--bg3)',borderRadius:8}}>
          <div style={{fontSize:11,fontWeight:600,marginBottom:4}}>Новая метрика:</div>
          <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:4}}>
            <input placeholder="ID (лат.)" value={nn.id} onChange={e=>setNn(x=>({...x,id:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,width:100}}/>
            <input placeholder="Название" value={nn.label} onChange={e=>setNn(x=>({...x,label:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,width:160}}/>
            <select value={nn.group} onChange={e=>setNn(x=>({...x,group:e.target.value}))} style={{fontSize:10,padding:'3px 4px',border:'1px solid var(--border)',borderRadius:4}}>
              {GROUP_ORDER.map(g=><option key={g} value={g}>{gLabel(g)}</option>)}
            </select>
            <input placeholder="Факт" value={nn.fact} onChange={e=>setNn(x=>({...x,fact:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,width:80}}/>
            <input placeholder="Цель" value={nn.target} onChange={e=>setNn(x=>({...x,target:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,width:80}}/>
          </div>
          <div style={{display:'flex',gap:6,marginBottom:4}}>
            <input placeholder="Подсказка (tip)" value={nn.tip} onChange={e=>setNn(x=>({...x,tip:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,flex:1}}/>
            <input placeholder="Комментарий" value={nn.comment} onChange={e=>setNn(x=>({...x,comment:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,flex:1}}/>
          </div>
          <button onClick={doAddNode} disabled={!nn.id||!nn.label} style={{fontSize:10,padding:'3px 12px',borderRadius:4,background:(!nn.id||!nn.label)?'var(--bg2)':'var(--emerald)',color:'#fff',border:'none',cursor:(!nn.id||!nn.label)?'default':'pointer'}}>Добавить</button>
        </div>}

        {/* Добавить связь */}
        {showAddLink&&<div style={{marginBottom:10,padding:10,background:'var(--bg3)',borderRadius:8}}>
          <div style={{fontSize:11,fontWeight:600,marginBottom:4}}>Новая связь:</div>
          <div style={{display:'flex',gap:6,alignItems:'center'}}>
            <select value={nl.from} onChange={e=>setNl(x=>({...x,from:e.target.value}))} style={{fontSize:10,padding:'3px 4px',border:'1px solid var(--border)',borderRadius:4}}>
              <option value="">— От —</option>{nodes.map(n=><option key={n.id} value={n.id}>{n.label} ({n.id})</option>)}
            </select>
            <span style={{fontSize:12}}>→</span>
            <select value={nl.to} onChange={e=>setNl(x=>({...x,to:e.target.value}))} style={{fontSize:10,padding:'3px 4px',border:'1px solid var(--border)',borderRadius:4}}>
              <option value="">— К —</option>{nodes.map(n=><option key={n.id} value={n.id}>{n.label} ({n.id})</option>)}
            </select>
            <input placeholder="Группа связи" value={nl.group} onChange={e=>setNl(x=>({...x,group:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,width:100}}/>
            <button onClick={doAddLink} disabled={!nl.from||!nl.to} style={{fontSize:10,padding:'3px 12px',borderRadius:4,background:(!nl.from||!nl.to)?'var(--bg2)':'var(--violet)',color:'#fff',border:'none',cursor:(!nl.from||!nl.to)?'default':'pointer'}}>Добавить</button>
          </div>
        </div>}

        {/* Граф SVG */}
        {nodes.length===0?<div className="card" style={{padding:40,textAlign:'center',color:'var(--text2)',fontSize:13}}>Нет метрик. Импортируйте JSON или добавьте вручную.</div>
        :<div className="card" style={{padding:12,overflowX:'auto'}}>
          <div style={{display:'flex',gap:10,marginBottom:8,flexWrap:'wrap'}}>
            {groups.map(g=><span key={g} style={{fontSize:10,display:'flex',alignItems:'center',gap:3}}><span style={{width:10,height:10,borderRadius:3,background:gColor(g),display:'inline-block'}}/>{gLabel(g)}</span>)}
          </div>
          <svg width={svgW} height={svgH} style={{background:'#f8f9fb',borderRadius:8,border:'1px solid #e2e8f0'}}>
            {groups.map((g,i)=><text key={g} x={PAD_X+i*(NODE_W+PAD_X)+NODE_W/2} y={24} textAnchor="middle" style={{fontSize:10,fontWeight:700,fill:gColor(g),textTransform:'uppercase',letterSpacing:'1px'}}>{gLabel(g)}</text>)}
            <defs>{groups.map(g=><marker key={g} id={'mmA_'+g} markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto"><polygon points="0 0, 7 2.5, 0 5" fill={gColor(g)} opacity="0.6"/></marker>)}</defs>
            {links.map((l,i)=>{
              const fId=l.from||l[0];const tId=l.to||l[1];
              const from=nodePos[fId];const to=nodePos[tId];if(!from||!to)return null;
              const x1=from.x+NODE_W/2;const y1=from.y;const x2=to.x+NODE_W/2;const y2=to.y+NODE_H;
              const cp=Math.abs(y1-y2)*0.35;
              const fromN=nodes.find(n=>n.id===fId);const toN=nodes.find(n=>n.id===tId);
              const lnkColor=(fromN&&toN&&fromN.group===toN.group)?gColor(fromN.group):'#9ca3af';
              const isDash=(fromN&&toN&&fromN.group!==toN.group);
              return <path key={i} d={'M'+x1+','+y1+' C'+x1+','+(y1-cp)+' '+x2+','+(y2+cp)+' '+x2+','+y2} fill="none" stroke={lnkColor} strokeWidth={1.4} opacity={0.35} strokeDasharray={isDash?'5,3':''} markerEnd={'url(#mmA_'+(fromN?fromN.group:groups[0])+')'}/>;
            })}
            {nodes.map(n=>{
              const pos=nodePos[n.id];if(!pos)return null;const gc=gColor(n.group);
              const isEdit=editNode===n.id;
              const lbl=(n.label||'').length>22?(n.label||'').slice(0,22)+'…':(n.label||'');
              const _fv=parseFloat(n.factNum),_tv=parseFloat(n.targetNum);
              const _hasDelta=!_isAND&&!isNaN(_fv)&&!isNaN(_tv)&&_tv!==0;
              const _delta=_hasDelta?((_fv-_tv)/Math.abs(_tv)*100):0;
              const _deltaStr=_hasDelta?((_delta>=0?'+':'')+_delta.toFixed(1)+'%'):'';
              /* subText: АНД — факт/цель как раньше; остальные — числовые метрики */
              const sub=[];
              if(_isAND){if(n.fact)sub.push('Факт: '+n.fact);if(n.target)sub.push('Цель: '+n.target);}
              else{if(n.factNum!=null&&n.factNum!=='')sub.push('Ф: '+n.factNum);if(_deltaStr)sub.push(_deltaStr);if(n.targetNum!=null&&n.targetNum!=='')sub.push('П: '+n.targetNum);}
              const subText=sub.join('  ')||(n.sub||'');
              const txtFill=gc==='#e2e8f0'?'#334155':'#fff';
              const txtFill2=gc==='#e2e8f0'?'rgba(51,65,85,0.7)':'rgba(255,255,255,0.85)';
              const txtFill3=gc==='#e2e8f0'?'rgba(51,65,85,0.5)':'rgba(255,255,255,0.55)';
              return <g key={n.id} style={{cursor:'pointer'}} onClick={()=>setEditNode(isEdit?null:n.id)}
                onMouseEnter={(e)=>{setHovNode(n);setHovPos({x:e.clientX,y:e.clientY});}}
                onMouseMove={(e)=>{setHovPos({x:e.clientX,y:e.clientY});}}
                onMouseLeave={()=>setHovNode(null)}>
                <rect x={pos.x} y={pos.y} width={NODE_W} height={NODE_H} rx={10} fill={gc} stroke={isEdit?'#fff':'none'} strokeWidth={isEdit?3:0}/>
                <text x={pos.x+NODE_W/2} y={pos.y+20} textAnchor="middle" style={{fontSize:11,fontWeight:700,fill:txtFill}}>{lbl}</text>
                {subText&&<text x={pos.x+NODE_W/2} y={pos.y+36} textAnchor="middle" style={{fontSize:9,fontWeight:600,fill:txtFill2}}>{subText.length>36?subText.slice(0,36)+'…':subText}</text>}
                {n.comment&&<text x={pos.x+NODE_W/2} y={pos.y+50} textAnchor="middle" style={{fontSize:7,fill:txtFill3}}>{(n.comment||'').length>30?(n.comment||'').slice(0,30)+'…':(n.comment||'')}</text>}
              </g>;
            })}
          </svg>
          {hovNode&&(()=>{
            const fv=parseFloat(hovNode.factNum),tv=parseFloat(hovNode.targetNum);
            const hasDelta=!isNaN(fv)&&!isNaN(tv)&&tv!==0;
            const delta=hasDelta?((fv-tv)/Math.abs(tv)*100):0;
            return <div style={{position:'fixed',left:hovPos.x+14,top:hovPos.y+14,background:'#fff',border:'1px solid #e2e8f0',borderRadius:10,padding:'12px 16px',fontSize:12,lineHeight:1.55,maxWidth:360,pointerEvents:'none',zIndex:9999,boxShadow:'0 8px 24px rgba(0,0,0,.15)'}}>
              <div style={{fontWeight:700,fontSize:13,marginBottom:4}}>{hovNode.label||hovNode.id}</div>
              {!_isAND&&(hovNode.factNum!=null||hovNode.targetNum!=null)&&<div style={{display:'flex',gap:8,alignItems:'center',marginBottom:4,padding:'4px 8px',background:'#f8fafc',borderRadius:6}}>
                {hovNode.factNum!=null&&<span style={{fontSize:12}}><span style={{color:'#10b981',fontWeight:600}}>Факт:</span> {hovNode.factNum}</span>}
                {hasDelta&&<span style={{fontSize:13,fontWeight:700,color:delta>=0?'#10b981':'#ef4444'}}>{delta>=0?'+':''}{delta.toFixed(1)}%</span>}
                {hovNode.targetNum!=null&&<span style={{fontSize:12}}><span style={{color:'#8b5cf6',fontWeight:600}}>План:</span> {hovNode.targetNum}</span>}
              </div>}
              {hovNode.fact&&<div><span style={{color:'#10b981',fontWeight:600}}>Факт:</span> {hovNode.fact}</div>}
              {hovNode.target&&<div><span style={{color:'#8b5cf6',fontWeight:600}}>{_isAND?'Цель':'План'}:</span> {hovNode.target}</div>}
              {_isAND&&hovNode.tip&&<div style={{marginTop:4,color:'#475569'}}>{hovNode.tip}</div>}
              {hovNode.comment&&<div style={{color:'#6366f1',marginTop:3,fontSize:11}}>💬 {hovNode.comment}</div>}
            </div>;
          })()}

          {editNode&&(()=>{
            const n=nodes.find(x=>x.id===editNode);if(!n)return null;
            const _lf=(l)=>l.from||l[0];const _lt=(l)=>l.to||l[1];
            const nodeLinks=links.filter(l=>_lf(l)===n.id||_lt(l)===n.id);
            return <div style={{marginTop:10,padding:10,background:'var(--bg3)',borderRadius:8,border:'2px solid var(--accent)'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
                <span style={{fontSize:12,fontWeight:700,color:'var(--accent)'}}>{n.label} <span style={{fontSize:9,color:'var(--text2)'}}>({n.id})</span></span>
                <div style={{display:'flex',gap:4}}>
                  <button onClick={()=>{store.deleteMetricsNode(projName,n.id);setEditNode(null);}} style={{fontSize:9,padding:'2px 8px',borderRadius:4,background:'var(--red)',color:'#fff',border:'none',cursor:'pointer'}}>Удалить</button>
                  <button onClick={()=>setEditNode(null)} style={{fontSize:9,padding:'2px 8px',borderRadius:4,background:'var(--bg1)',border:'1px solid var(--border)',cursor:'pointer'}}>✕</button>
                </div>
              </div>
              <div style={{marginBottom:6}}><div style={{fontSize:9,color:'var(--text2)'}}>Название</div><input defaultValue={n.label||''} key={n.id+'l'} onBlur={e=>store.updateMetricsNode(projName,n.id,{label:e.target.value})} style={{width:'100%',fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,fontWeight:600}}/></div>
              {_isAND?<React.Fragment>
                <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:6}}>
                  <div style={{flex:'1 1 150px'}}><div style={{fontSize:9,color:'var(--text2)'}}>Факт</div><input defaultValue={n.fact||''} key={n.id+'f'} onBlur={e=>store.updateMetricsNode(projName,n.id,{fact:e.target.value})} style={{width:'100%',fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
                  <div style={{flex:'1 1 150px'}}><div style={{fontSize:9,color:'var(--text2)'}}>Цель</div><input defaultValue={n.target||''} key={n.id+'t'} onBlur={e=>store.updateMetricsNode(projName,n.id,{target:e.target.value})} style={{width:'100%',fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
                </div>
                <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:6}}>
                  <div style={{flex:'1 1 200px'}}><div style={{fontSize:9,color:'var(--text2)'}}>Подсказка</div><input defaultValue={n.tip||''} key={n.id+'p'} onBlur={e=>store.updateMetricsNode(projName,n.id,{tip:e.target.value})} style={{width:'100%',fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
                  <div style={{flex:'1 1 200px'}}><div style={{fontSize:9,color:'var(--text2)'}}>Комментарий</div><input defaultValue={n.comment||''} key={n.id+'c'} onBlur={e=>store.updateMetricsNode(projName,n.id,{comment:e.target.value})} style={{width:'100%',fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
                </div>
              </React.Fragment>:<React.Fragment>
                {/* Числовые метрики: факт, дельта %, цель */}
                <div style={{display:'flex',gap:6,alignItems:'flex-end',marginBottom:6}}>
                  <div style={{flex:'0 0 100px'}}><div style={{fontSize:9,color:'var(--text2)'}}>Факт (число)</div><input type="number" defaultValue={n.factNum||''} key={n.id+'fn'} onBlur={e=>store.updateMetricsNode(projName,n.id,{factNum:e.target.value?parseFloat(e.target.value):null})} style={{width:'100%',fontSize:11,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,fontWeight:600}}/></div>
                  {(()=>{const fv=parseFloat(n.factNum),tv=parseFloat(n.targetNum);if(!isNaN(fv)&&!isNaN(tv)&&tv!==0){const d=((fv-tv)/Math.abs(tv)*100);return <div style={{flex:'0 0 70px',textAlign:'center',padding:'3px 0'}}><div style={{fontSize:9,color:'var(--text2)'}}>Δ%</div><span style={{fontSize:13,fontWeight:700,color:d>=0?'#10b981':'#ef4444'}}>{d>=0?'+':''}{d.toFixed(1)}%</span></div>;}return <div style={{flex:'0 0 70px',textAlign:'center',padding:'3px 0'}}><div style={{fontSize:9,color:'var(--text2)'}}>Δ%</div><span style={{fontSize:11,color:'var(--text2)'}}>—</span></div>;})()}
                  <div style={{flex:'0 0 100px'}}><div style={{fontSize:9,color:'var(--text2)'}}>План (число)</div><input type="number" defaultValue={n.targetNum||''} key={n.id+'tn'} onBlur={e=>store.updateMetricsNode(projName,n.id,{targetNum:e.target.value?parseFloat(e.target.value):null})} style={{width:'100%',fontSize:11,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,fontWeight:600}}/></div>
                </div>
                {/* Текстовые поля: факт, цель, комментарий */}
                <div style={{marginBottom:6}}><div style={{fontSize:9,color:'var(--text2)'}}>Факт (описание)</div><textarea defaultValue={n.fact||''} key={n.id+'f'} onBlur={e=>store.updateMetricsNode(projName,n.id,{fact:e.target.value})} rows={2} style={{width:'100%',fontSize:10,padding:'4px 6px',border:'1px solid var(--border)',borderRadius:4,resize:'vertical',fontFamily:'inherit'}}/></div>
                <div style={{marginBottom:6}}><div style={{fontSize:9,color:'var(--text2)'}}>План (описание)</div><textarea defaultValue={n.target||''} key={n.id+'t'} onBlur={e=>store.updateMetricsNode(projName,n.id,{target:e.target.value})} rows={2} style={{width:'100%',fontSize:10,padding:'4px 6px',border:'1px solid var(--border)',borderRadius:4,resize:'vertical',fontFamily:'inherit'}}/></div>
                <div style={{marginBottom:6}}><div style={{fontSize:9,color:'var(--text2)'}}>Комментарий</div><textarea defaultValue={n.comment||''} key={n.id+'c'} onBlur={e=>store.updateMetricsNode(projName,n.id,{comment:e.target.value})} rows={3} style={{width:'100%',fontSize:10,padding:'4px 6px',border:'1px solid var(--border)',borderRadius:4,resize:'vertical',fontFamily:'inherit'}}/></div>
              </React.Fragment>}
              {nodeLinks.length>0&&<div style={{marginTop:4}}>
                <div style={{fontSize:9,fontWeight:600,color:'var(--text2)',marginBottom:2}}>Связи:</div>
                {nodeLinks.map((l,i)=>{const other=_lf(l)===n.id?_lt(l):_lf(l);const dir=_lf(l)===n.id?'→':'←';const oNode=nodes.find(x=>x.id===other);
                  return <div key={i} style={{fontSize:10,display:'flex',alignItems:'center',gap:4,padding:'1px 0'}}>
                    <span>{dir} {oNode?oNode.label:other}</span>
                    <button onClick={()=>store.deleteMetricsLink(projName,_lf(l),_lt(l))} style={{fontSize:8,padding:'0 4px',borderRadius:3,background:'var(--red)',color:'#fff',border:'none',cursor:'pointer'}}>✕</button>
                  </div>;
                })}
              </div>}
            </div>;
          })()}
        </div>}

        {/* Таблица метрик */}
        {nodes.length>0&&<div className="card" style={{padding:12,marginTop:10}}>
          <div style={{fontSize:12,fontWeight:700,marginBottom:6}}>Все метрики</div>
          <table style={{width:'100%',fontSize:10,borderCollapse:'collapse'}}>
            <thead><tr style={{borderBottom:'2px solid var(--border)',background:'var(--bg3)'}}>
              <th style={{textAlign:'left',padding:'4px 6px'}}>Метрика</th>
              <th style={{textAlign:'left',padding:'4px 6px'}}>Группа</th>
              {!_isAND&&<th style={{textAlign:'right',padding:'4px 6px'}}>Факт#</th>}
              {!_isAND&&<th style={{textAlign:'center',padding:'4px 6px'}}>Δ%</th>}
              {!_isAND&&<th style={{textAlign:'right',padding:'4px 6px'}}>План#</th>}
              <th style={{textAlign:'left',padding:'4px 6px'}}>{_isAND?'Факт':'Факт (текст)'}</th>
              <th style={{textAlign:'left',padding:'4px 6px'}}>{_isAND?'Цель':'План (текст)'}</th>
              {_isAND&&<th style={{textAlign:'left',padding:'4px 6px'}}>Подсказка</th>}
              <th style={{textAlign:'left',padding:'4px 6px'}}>Комментарий</th>
            </tr></thead>
            <tbody>{nodes.map(n=>{
              const _tfv=parseFloat(n.factNum),_ttv=parseFloat(n.targetNum);
              const _thd=!isNaN(_tfv)&&!isNaN(_ttv)&&_ttv!==0;
              const _td=_thd?((_tfv-_ttv)/Math.abs(_ttv)*100):0;
              return <tr key={n.id} style={{borderBottom:'1px solid var(--bg3)',cursor:'pointer',background:editNode===n.id?'rgba(99,102,241,0.08)':''}} onClick={()=>setEditNode(editNode===n.id?null:n.id)}>
              <td style={{padding:'3px 6px',fontWeight:600}}><span style={{display:'inline-block',width:8,height:8,borderRadius:2,background:gColor(n.group),marginRight:4}}/>{n.label}</td>
              <td style={{padding:'3px 6px',color:gColor(n.group)}}>{gLabel(n.group)}</td>
              {!_isAND&&<td style={{padding:'3px 6px',textAlign:'right',fontWeight:600}}>{n.factNum!=null&&n.factNum!==''?n.factNum:'—'}</td>}
              {!_isAND&&<td style={{padding:'3px 6px',textAlign:'center',fontWeight:700,color:_thd?(_td>=0?'#10b981':'#ef4444'):'var(--text2)'}}>{_thd?((_td>=0?'+':'')+_td.toFixed(1)+'%'):'—'}</td>}
              {!_isAND&&<td style={{padding:'3px 6px',textAlign:'right',fontWeight:600}}>{n.targetNum!=null&&n.targetNum!==''?n.targetNum:'—'}</td>}
              <td style={{padding:'3px 6px',color:'var(--emerald)',maxWidth:150,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{n.fact||'—'}</td>
              <td style={{padding:'3px 6px',color:'var(--violet)',maxWidth:150,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{n.target||'—'}</td>
              {_isAND&&<td style={{padding:'3px 6px',color:'var(--text2)',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{n.tip||''}</td>}
              <td style={{padding:'3px 6px',color:'var(--text2)',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{n.comment||''}</td>
            </tr>})}</tbody>
          </table>
        </div>}
      </div>;
    })()}

    {/* Task & Blocker modals — available from Issue Tree kanban */}
    {showTask&&<Modal onClose={()=>setShowTask(false)}><h2>Новая задача</h2>
      <div className="form-group"><label>Название *</label><input value={tkf.title} onChange={e=>setTkf(p=>({...p,title:e.target.value}))}/></div>
      <div className="form-row"><div className="form-group"><label>Исполнитель</label><select value={tkf.assigned_to_id} onChange={e=>setTkf(p=>({...p,assigned_to_id:e.target.value}))}><option value="">—</option>{store.data.persons.map(pe=><option key={pe.id} value={pe.id}>{pe.name}</option>)}</select></div><div className="form-group"><label>Приоритет (1-5)</label><input type="number" min="1" max="5" value={tkf.priority} onChange={e=>setTkf(p=>({...p,priority:Number(e.target.value)}))}/></div></div>
      <div className="form-row"><div className="form-group"><label>Трек (опционально)</label><select value={tkf.track_id} onChange={e=>setTkf(p=>({...p,track_id:e.target.value}))}><option value="">Без трека</option>{(p.tracks||[]).map(t=><option key={t.id} value={t.id}>{t.track_code} — {t.track_name}</option>)}</select></div><div className="form-group"><label>Дедлайн</label><input type="date" value={tkf.deadline||''} onChange={e=>setTkf(p=>({...p,deadline:e.target.value}))}/></div></div>
      <div className="form-actions"><button className="btn btn-secondary" onClick={()=>setShowTask(false)}>Отмена</button><button className="btn btn-primary" onClick={()=>{if(tkf.title){store.addTask(p.id,tkf);setShowTask(false);setTkf({title:'',priority:3,assigned_to_id:'',track_id:'',deadline:''});}}}>Добавить</button></div>
    </Modal>}
    {showBlocker&&<Modal onClose={()=>setShowBlocker(false)}><h2>Новый блокер</h2>
      <div className="form-group"><label>Описание *</label><textarea value={bf.description} onChange={e=>setBf(p=>({...p,description:e.target.value}))}/></div>
      <div className="form-row"><div className="form-group"><label>Критичность</label><select value={bf.severity} onChange={e=>setBf(p=>({...p,severity:e.target.value}))}><option>LOW</option><option>MEDIUM</option><option>HIGH</option><option>CRITICAL</option></select></div><div className="form-group"><label>Тип</label><select value={bf.blocker_type} onChange={e=>setBf(p=>({...p,blocker_type:e.target.value}))}><option>INTERNAL</option><option>CLIENT</option><option>EXTERNAL</option><option>RESOURCE</option></select></div></div>
      <div className="form-actions"><button className="btn btn-secondary" onClick={()=>setShowBlocker(false)}>Отмена</button><button className="btn btn-danger" onClick={()=>{if(bf.description){store.addBlocker(p.id,bf);setShowBlocker(false);setBf({description:'',severity:'MEDIUM',blocker_type:'INTERNAL'});}}}>Добавить</button></div>
    </Modal>}
  </div>;
}

function TriageView({store,goProject}){
  const [triFilter,setTriFilter]=useState('all');
  const [triMode,setTriMode]=useState('projects'); /* 'projects' | 'phases' */
  const active=store.data.projects.filter(p=>p.status==='ACTIVE');
  const _filterRg=(list)=>{
    if(triFilter==='all')return list;
    if(triFilter==='ФК')return list.filter(p=>p.project_type==='ФК');
    return list.filter(p=>p.project_type!=='ФК'&&(p.work_group||'')===(triFilter));
  };
  const triaged=_filterRg(active).map(p=>({...p,tri:calcTriage(p)}));
  const seg1=triaged.filter(p=>p.tri.segment===1);
  const seg2=triaged.filter(p=>p.tri.segment===2);
  const seg3=triaged.filter(p=>p.tri.segment===3);
  const seg4=triaged.filter(p=>p.tri.segment===4);
  const noSeg=triaged.filter(p=>!p.tri.segment);
  const draft=_filterRg(store.data.projects.filter(p=>p.status==='DRAFT'));

  /* Phase-level triage */
  const phaseTriItems=useMemo(()=>{
    const items=[];
    _filterRg(active).forEach(proj=>{
      const groups=getPhaseGroups(proj);
      groups.forEach(grp=>{
        if(grp.status==='COMPLETED')return;
        const tri=calcPhaseTriage(grp,proj);
        items.push({...grp,_proj:proj,_projId:proj.id,_projCode:proj.code,_projName:proj.name,_clientName:proj.client_name,tri});
      });
    });
    return items;
  },[active,triFilter]);
  const phSeg1=phaseTriItems.filter(x=>x.tri.segment===1);
  const phSeg2=phaseTriItems.filter(x=>x.tri.segment===2);
  const phSeg3=phaseTriItems.filter(x=>x.tri.segment===3);
  const phSeg4=phaseTriItems.filter(x=>x.tri.segment===4);
  const phNoSeg=phaseTriItems.filter(x=>!x.tri.segment);

  // Capacity
  const getWS=(d)=>{const dt=d?new Date(d):new Date();const day=dt.getDay();const diff=dt.getDate()-day+(day===0?-6:1);return new Date(dt.getFullYear(),dt.getMonth(),diff).toISOString().slice(0,10);};
  const tw=getWS();
  const actP=store.data.persons.filter(p=>!p.fire_date&&p.grade!=='C5'&&p.grade!=='Стажёр'&&getPersonDepts(p).includes('Производство'));
  const totOH=actP.reduce((s,p)=>{const wts=p.weekly_timesheets||[];const e=wts.find(w=>w.week_start===tw);return s+(e?e.open_hours:0);},0);
  const maxTP=Math.floor(totOH/8);
  const inTriage=triMode==='phases'?(phSeg1.length+phSeg2.length):(seg1.length+seg2.length);
  const overCapacity=maxTP>0&&inTriage>maxTP;

  const renderMini=(items)=>items.map(p=>{const t=p.tri||calcTriage(p);const cc=computeCriticalChain(p.tracks||[]);const critCount=cc.criticalIds.size;return <div key={p.id} className="proj-mini" onClick={()=>goProject(p.id)}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><span className="code">{p.code}</span><span style={{display:'flex',gap:3}}>{critCount>0&&<span style={{fontSize:9,background:'var(--red)',color:'#fff',borderRadius:8,padding:'1px 5px'}}>крит:{critCount}</span>}{t.segment&&<span className={'badge seg-'+t.segment} style={{fontSize:9}}>S{t.segment}</span>}</span></div>
    <div className="name">{p.name}</div>
    <div className="meta">{p.client_name} · <span className={'buffer-'+t.bufferColor} style={{padding:'1px 5px',borderRadius:8,fontSize:10}}>{t.daysRemaining!==null?(t.daysRemaining>0?t.daysRemaining+' дн.':'Проср.'):'—'}</span> · Скор: {t.totalScore}</div>
  </div>;});

  const renderPhaseMini=(items)=>items.map(ph=>{
    const t=ph.tri;
    const hCol=t.health==='red'?'var(--red)':t.health==='yellow'?'var(--amber)':'var(--green)';
    return <div key={ph._projId+'_'+ph.id} className="tri-phase-item" onClick={()=>goProject(ph._projId)}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <span className="tri-phase-code">{ph._projCode}</span>
        <span style={{display:'flex',gap:3}}>
          {t.segment&&<span className={'badge seg-'+t.segment} style={{fontSize:9}}>S{t.segment}</span>}
        </span>
      </div>
      <div className="tri-phase-name">{ph.group_name}</div>
      <div className="tri-phase-meta">
        <span>{ph._clientName||''}</span>
        <span style={{color:hCol,fontWeight:600}}>{t.daysRemaining!==null?(t.daysRemaining>0?t.daysRemaining+' дн.':'Проср. '+Math.abs(t.daysRemaining)+'д'):'—'}</span>
        <span>Скор: {t.totalScore}</span>
        {t.bufferConsumed>0&&<span style={{color:hCol}}>Буфер: {t.bufferPct}%</span>}
      </div>
      {/* Mini buffer bar */}
      <div style={{height:3,background:'var(--bg4)',borderRadius:2,marginTop:4,overflow:'hidden'}}>
        <div style={{height:'100%',width:Math.min(t.bufferPct,100)+'%',background:hCol,borderRadius:2}}></div>
      </div>
    </div>;
  });

  return <div>
    <h2 className="page-title">Триаж портфеля</h2>
    <div style={{display:'flex',gap:6,marginBottom:12,alignItems:'center',flexWrap:'wrap'}}>
      {/* Mode switcher */}
      <div className="pg-mode-switch" style={{marginBottom:0}}>
        <button className={'pg-mode-btn'+(triMode==='projects'?' active':'')} onClick={()=>setTriMode('projects')}>Проекты</button>
        <button className={'pg-mode-btn'+(triMode==='phases'?' active':'')} onClick={()=>setTriMode('phases')}>Фазы</button>
      </div>
      <div style={{width:1,height:20,background:'var(--border)',margin:'0 4px'}}></div>
      {['all','РГ1','РГ2','ФК'].map(f=><div key={f} className={'oc-tab'+(triFilter===f?' active':'')} onClick={()=>setTriFilter(f)} style={{fontSize:11,padding:'4px 12px',cursor:'pointer'}}>{f==='all'?'Все':f}</div>)}
    </div>
    <div className={'cap-indicator'+(overCapacity?' over':'')}>
      <div className="cap-header">
        <div className="cap-title">Ёмкость триажа: {inTriage} / {maxTP||'—'} {triMode==='phases'?'фаз':'проектов'}</div>
        <div className="cap-formula">{totOH} откр. часов ÷ 8 = {maxTP} макс. единиц (1 ед. = 8 часов команды)</div>
      </div>
      <div className="cap-bar"><div className="cap-fill" style={{width:Math.min(maxTP>0?inTriage/maxTP*100:0,100)+'%',background:overCapacity?'var(--red)':'var(--emerald)'}}/></div>
      <div className="cap-text">S1+S2: {inTriage} {triMode==='phases'?'фаз':'проектов'} в активном триаже · {actP.length} сотрудников · {totOH} часов открыто</div>
      {overCapacity&&<div className="cap-warn">⚠️ Превышена ёмкость! Нужно снять {inTriage-maxTP} из S1/S2 или открыть больше часов.</div>}
      {totOH===0&&<div className="cap-warn">⚠️ Ни один сотрудник не открыл часы на эту неделю. Перейдите в раздел Команда для внесения.</div>}
    </div>
    <div className="stats-grid" style={{marginBottom:16}}>
      {triMode==='projects'?<React.Fragment>
        <div className="stat-card"><div className="label">Сегмент 1 (Крит.)</div><div className="value red-c">{seg1.length}</div></div>
        <div className="stat-card"><div className="label">Сегмент 2</div><div className="value yellow-c">{seg2.length}</div></div>
        <div className="stat-card"><div className="label">Сегмент 3</div><div className="value accent-c">{seg3.length}</div></div>
        <div className="stat-card"><div className="label">Сегмент 4 (Спок.)</div><div className="value green-c">{seg4.length}</div></div>
      </React.Fragment>:<React.Fragment>
        <div className="stat-card"><div className="label">S1 Фазы (Крит.)</div><div className="value red-c">{phSeg1.length}</div></div>
        <div className="stat-card"><div className="label">S2 Фазы</div><div className="value yellow-c">{phSeg2.length}</div></div>
        <div className="stat-card"><div className="label">S3 Фазы</div><div className="value accent-c">{phSeg3.length}</div></div>
        <div className="stat-card"><div className="label">S4 Фазы (Спок.)</div><div className="value green-c">{phSeg4.length}</div></div>
      </React.Fragment>}
    </div>
    <div className="card" style={{marginBottom:14,padding:14}}>
      <div style={{fontSize:11,color:'var(--text2)',marginBottom:8}}>Диагональный буфер: Сегмент = f(буфер дней, скоринг). Скоринг = mean(срочность×1.5, масштаб, стоимость, сложность, приоритет ГД){triMode==='phases'&&' · Скоринг наследуется от проекта, срочность — из буфера фазы'}</div>
      <div style={{display:'grid',gridTemplateColumns:'120px 1fr 1fr',gap:4,fontSize:11}}>
        <div></div><div style={{textAlign:'center',fontWeight:600,color:'var(--text2)'}}>Скоринг ≤ 2.2</div><div style={{textAlign:'center',fontWeight:600,color:'var(--text2)'}}>Скоринг > 2.2</div>
        <div style={{fontWeight:600,color:'var(--text2)'}}>Буфер ≤ 30 дн.</div><div style={{textAlign:'center',padding:4,background:'rgba(234,179,8,.1)',borderRadius:4}}>Сегмент 2</div><div style={{textAlign:'center',padding:4,background:'rgba(239,68,68,.1)',borderRadius:4}}>Сегмент 1 🔥</div>
        <div style={{fontWeight:600,color:'var(--text2)'}}>Буфер > 30 дн.</div><div style={{textAlign:'center',padding:4,background:'rgba(34,197,94,.1)',borderRadius:4}}>Сегмент 4 ✅</div><div style={{textAlign:'center',padding:4,background:'rgba(14,165,233,.1)',borderRadius:4}}>Сегмент 3</div>
      </div>
    </div>
    {triMode==='projects'&&<div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14}}>
        <div className="triage-col" style={{borderTop:'3px solid var(--red)'}}><h3 style={{color:'var(--red)'}}>S1 Критические ({seg1.length})</h3>{renderMini(seg1)}{seg1.length===0&&<div className="empty" style={{padding:12}}>Пусто</div>}</div>
        <div className="triage-col" style={{borderTop:'3px solid var(--yellow)'}}><h3 style={{color:'var(--yellow)'}}>S2 Внимание ({seg2.length})</h3>{renderMini(seg2)}{seg2.length===0&&<div className="empty" style={{padding:12}}>Пусто</div>}</div>
        <div className="triage-col" style={{borderTop:'3px solid var(--sky)'}}><h3 style={{color:'var(--sky)'}}>S3 Наблюдение ({seg3.length})</h3>{renderMini(seg3)}{seg3.length===0&&<div className="empty" style={{padding:12}}>Пусто</div>}</div>
        <div className="triage-col" style={{borderTop:'3px solid var(--green)'}}><h3 style={{color:'var(--green)'}}>S4 Спокойные ({seg4.length})</h3>{renderMini(seg4)}{seg4.length===0&&<div className="empty" style={{padding:12}}>Пусто</div>}</div>
      </div>
      {(noSeg.length>0||draft.length>0)&&<div style={{marginTop:14}}><div className="triage-col"><h3 style={{color:'var(--text2)'}}>Без сегмента / Черновики ({noSeg.length+draft.length})</h3>{renderMini([...noSeg,...draft.map(p=>({...p,tri:calcTriage(p)}))])}</div></div>}
    </div>}
    {triMode==='phases'&&<div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14}}>
        <div className="triage-col" style={{borderTop:'3px solid var(--red)'}}><h3 style={{color:'var(--red)'}}>S1 Критические ({phSeg1.length})</h3>{renderPhaseMini(phSeg1)}{phSeg1.length===0&&<div className="empty" style={{padding:12}}>Пусто</div>}</div>
        <div className="triage-col" style={{borderTop:'3px solid var(--yellow)'}}><h3 style={{color:'var(--yellow)'}}>S2 Внимание ({phSeg2.length})</h3>{renderPhaseMini(phSeg2)}{phSeg2.length===0&&<div className="empty" style={{padding:12}}>Пусто</div>}</div>
        <div className="triage-col" style={{borderTop:'3px solid var(--sky)'}}><h3 style={{color:'var(--sky)'}}>S3 Наблюдение ({phSeg3.length})</h3>{renderPhaseMini(phSeg3)}{phSeg3.length===0&&<div className="empty" style={{padding:12}}>Пусто</div>}</div>
        <div className="triage-col" style={{borderTop:'3px solid var(--green)'}}><h3 style={{color:'var(--green)'}}>S4 Спокойные ({phSeg4.length})</h3>{renderPhaseMini(phSeg4)}{phSeg4.length===0&&<div className="empty" style={{padding:12}}>Пусто</div>}</div>
      </div>
      {phNoSeg.length>0&&<div style={{marginTop:14}}><div className="triage-col"><h3 style={{color:'var(--text2)'}}>Без сегмента ({phNoSeg.length})</h3>{renderPhaseMini(phNoSeg)}</div></div>}
    </div>}
  </div>;
}

const ORG_DEPTS=[
  {key:'Стратегия',color:'var(--violet)',icon:'🎯'},
  {key:'HR',color:'var(--sky)',icon:'👥'},
  {key:'Продажи и Маркетинг',color:'var(--amber)',icon:'📈'},
  {key:'Финансы',color:'var(--emerald)',icon:'💰'},
  {key:'Производство',color:'var(--accent)',icon:'⚙️'},
  {key:'Качество',color:'var(--green)',icon:'✅'},
  {key:'Инновационные проекты',color:'var(--red)',icon:'🚀'}
];
const GRADE_ORDER_OC={C5:0,C4:1,C3:2,C2:3,C1:4,Admin:5};
const gradeColorOC=g=>({C5:'#7e22ce',C4:'#9d174d',C3:'#92400e',C2:'#1e40af',C1:'#166534',Admin:'#475569'}[g]||'var(--text2)');

function PeopleView({store}){
  const [showNew,setShowNew]=useState(false);
  const [editPerson,setEditPerson]=useState(null);
  const [filter,setFilter]=useState('all');
  const [deptFilter,setDeptFilter]=useState('all');
  const [tsFor,setTsFor]=useState(null);
  const [tsForm,setTsForm]=useState({week_start:'',open_hours:40,notes:''});
  const [viewMode,_setViewMode]=useState(()=>localStorage.getItem('pp_viewMode')||'cards');
  const setViewMode=(t)=>{localStorage.setItem('pp_viewMode',t);_setViewMode(t);};
  const [dragPerson,setDragPerson]=useState(null);
  const persons=store.data.persons;
  const active=persons.filter(p=>!p.fire_date);
  const fired=persons.filter(p=>!!p.fire_date);
  const filteredByStatus=filter==='active'?active:filter==='fired'?fired:persons;
  const filtered=deptFilter==='all'?filteredByStatus:deptFilter==='none'?filteredByStatus.filter(p=>getPersonDepts(p).length===0):filteredByStatus.filter(p=>getPersonDepts(p).includes(deptFilter));
  const totalSalary=persons.reduce((s,p)=>s+(p.total_salary_earned||0),0);
  const totalBonus=persons.reduce((s,p)=>s+(p.total_bonus_paid||0),0);
  const prodStaff=active.filter(p=>p.grade!=='C5'&&p.grade!=='Стажёр'&&getPersonDepts(p).includes('Производство'));
  const totalMonthly=prodStaff.reduce((s,p)=>s+(p.salary_monthly||0),0);

  // Week helpers
  const getWeekStart=(d)=>{const dt=d?new Date(d):new Date();const day=dt.getDay();const diff=dt.getDate()-day+(day===0?-6:1);return new Date(dt.getFullYear(),dt.getMonth(),diff).toISOString().slice(0,10);};
  const thisWeek=getWeekStart();
  const getPersonWeekHours=(p,wk)=>{const wts=p.weekly_timesheets||[];const entry=wts.find(w=>w.week_start===wk);return entry?entry.open_hours:0;};
  const totalOpenHours=prodStaff.reduce((s,p)=>s+getPersonWeekHours(p,thisWeek),0);
  const avgRate=totalOpenHours>0?Math.round(totalMonthly/totalOpenHours/4.33):0;
  const maxTriageProjects=Math.floor(totalOpenHours/8);

  return <div>
    <h2 className="page-title">Команда ({persons.length}) <button className="btn btn-primary" onClick={()=>setShowNew(true)}>+ Сотрудник</button></h2>

    <div className="team-capacity">
      <div className="tc-item"><div className="tc-val" style={{color:'var(--accent)'}}>{totalOpenHours}</div><div className="tc-label">Открытых часов (эта неделя)</div></div>
      <div className="tc-item"><div className="tc-val" style={{color:'var(--emerald)'}}>{maxTriageProjects}</div><div className="tc-label">Макс. проектов в триаже</div></div>
      <div className="tc-item"><div className="tc-val">{fmt(totalMonthly)} ₽</div><div className="tc-label">ФОТ / мес</div></div>
      <div className="tc-item"><div className="tc-val">{totalOpenHours>0?fmt(avgRate)+' ₽':'—'}</div><div className="tc-label">Ср. ставка / час</div></div>
      <div className="tc-item"><div className="tc-val">{active.length}</div><div className="tc-label">Активных</div></div>
      <div className="tc-item"><div className="tc-val" style={{color:'var(--red)'}}>{fired.length}</div><div className="tc-label">Уволенных</div></div>
    </div>

    <div className="oc-tabs">
      <div className={'oc-tab'+(viewMode==='cards'?' active':'')} onClick={()=>setViewMode('cards')}>Карточки</div>
      <div className={'oc-tab'+(viewMode==='org'?' active':'')} onClick={()=>setViewMode('org')}>Оргструктура</div>
    </div>

    {viewMode==='org'&&(()=>{
      const unassigned=active.filter(p=>getPersonDepts(p).length===0);
      const handleDragStart=(person)=>{setDragPerson(person.id);};
      const handleDrop=(dept,mgr)=>{if(!dragPerson)return;const dp=store.data.persons.find(x=>x.id===dragPerson);const cur=getPersonDepts(dp);const next=cur.includes(dept)?cur:[...cur,dept];const u={departments:next,department:next[0]||dept};if(mgr)u.manager_id=mgr;store.updatePerson(dragPerson,u);setDragPerson(null);};

      const renderPerson=(p,level,curDept)=>{
        const cd=curDept||getPersonDepts(p)[0]||'';
        const subs=active.filter(s=>s.manager_id===p.id&&getPersonDepts(s).includes(cd));
        const deptCount=getPersonDepts(p).length;
        return <div key={p.id+'-'+cd}>
          <div className={'oc-person'+(dragPerson===p.id?' dragging':'')} draggable={true}
            onDragStart={()=>handleDragStart(p)} onDragEnd={()=>setDragPerson(null)}
            onDragOver={e=>{e.preventDefault();e.currentTarget.classList.add('drag-over');}}
            onDragLeave={e=>e.currentTarget.classList.remove('drag-over')}
            onDrop={e=>{e.preventDefault();e.currentTarget.classList.remove('drag-over');if(dragPerson&&dragPerson!==p.id){const dp=store.data.persons.find(x=>x.id===dragPerson);const cur=getPersonDepts(dp);const next=cur.includes(cd)?cur:[...cur,cd];store.updatePerson(dragPerson,{departments:next,department:next[0]||cd,manager_id:p.id});setDragPerson(null);}}}
            onClick={()=>setEditPerson(p)}>
            <div style={{display:'flex',flexDirection:'column',flex:1}}>
              <div className="oc-name">{p.name}{deptCount>1&&<span style={{fontSize:8,color:'var(--text2)',marginLeft:4}}>(×{deptCount})</span>}</div>
              <div className="oc-pos">{p.position||'—'}</div>
            </div>
            {p.grade&&<span className={'oc-grade g-'+p.grade}>{p.grade}</span>}
            <span className="oc-unpin" title={'Открепить от '+cd} onClick={e=>{e.stopPropagation();if(confirm('Открепить '+p.name+' от '+cd+'?')){const nd=getPersonDepts(p).filter(d=>d!==cd);store.updatePerson(p.id,{departments:nd,department:nd[0]||'',manager_id:nd.length===0?'':p.manager_id});}}}>×</span>
          </div>
          {subs.length>0&&<div className="oc-sub">{subs.sort((a,b)=>(GRADE_ORDER_OC[a.grade]||9)-(GRADE_ORDER_OC[b.grade]||9)).map(s=>renderPerson(s,level+1,cd))}</div>}
        </div>;
      };

      return <div>
        <div className="oc-dept-grid">
          {ORG_DEPTS.map(dept=>{
            const deptPersons=active.filter(p=>getPersonDepts(p).includes(dept.key));
            const tops=deptPersons.filter(p=>!p.manager_id||!deptPersons.some(x=>x.id===p.manager_id));

            if(dept.key==='Производство'){
              const rg1=deptPersons.filter(p=>(p.work_group||p._work_group||'')==='РГ1');
              const rg2=deptPersons.filter(p=>(p.work_group||p._work_group||'')==='РГ2');
              const noRg=deptPersons.filter(p=>!(p.work_group||p._work_group)||!['РГ1','РГ2'].includes(p.work_group||p._work_group));
              const byGrade={};deptPersons.forEach(p=>{const g=p.grade||'?';if(!byGrade[g])byGrade[g]=[];byGrade[g].push(p);});
              const pyrLevels=['C5','C4','C3','C2','C1'].filter(g=>byGrade[g]&&byGrade[g].length>0);
              return <div key={dept.key} className="oc-dept" style={{gridColumn:'span 2'}}>
                <div className="oc-dept-head" style={{background:dept.color+'22',color:dept.color}}>
                  <span>{dept.icon} {dept.key} ({deptPersons.length})</span>
                  <span style={{fontSize:11}}>РГ1: {rg1.length} · РГ2: {rg2.length} | ФОТ: {fmt(deptPersons.filter(x=>x.grade!=='C5').reduce((s,x)=>s+getPersonDeptSalary(x),0))} ₽/мес</span>
                </div>
                <div className="oc-dept-body">
                  {pyrLevels.length>0&&<div>
                    <div style={{fontSize:10,color:'var(--text2)',textAlign:'center',marginBottom:4}}>Пирамида seniority</div>
                    <div className="oc-pyramid">{pyrLevels.map(g=><div key={g} className="oc-pyr-row">
                      {(byGrade[g]||[]).map(pp=><div key={pp.id} className="oc-pyr-chip" style={{background:gradeColorOC(g)+'18',color:gradeColorOC(g),border:'1px solid '+gradeColorOC(g)+'44'}} title={pp.name+' ('+pp.position+')'}>{pp.name.split(' ')[0]}</div>)}
                    </div>)}</div>
                  </div>}
                  <div className="oc-prod-groups">
                    <div className="oc-prod-group" onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();if(dragPerson){const dp=store.data.persons.find(x=>x.id===dragPerson);const cur=getPersonDepts(dp);const next=cur.includes('Производство')?cur:[...cur,'Производство'];store.updatePerson(dragPerson,{departments:next,department:next[0]||'Производство',work_group:'РГ1',_work_group:'РГ1'});setDragPerson(null);}}}>>
                      <h4>РГ1 ({rg1.length})</h4>
                      {(()=>{const rg1t=rg1.filter(p=>!p.manager_id||!rg1.some(x=>x.id===p.manager_id));return rg1t.length>0?rg1t.sort((a,b)=>(GRADE_ORDER_OC[a.grade]||9)-(GRADE_ORDER_OC[b.grade]||9)).map(p=>renderPerson(p,0,dept.key)):<div className="oc-empty">Перетащите сотрудника</div>;})()}
                    </div>
                    <div className="oc-prod-group" onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();if(dragPerson){const dp=store.data.persons.find(x=>x.id===dragPerson);const cur=getPersonDepts(dp);const next=cur.includes('Производство')?cur:[...cur,'Производство'];store.updatePerson(dragPerson,{departments:next,department:next[0]||'Производство',work_group:'РГ2',_work_group:'РГ2'});setDragPerson(null);}}}>
                      <h4>РГ2 ({rg2.length})</h4>
                      {(()=>{const rg2t=rg2.filter(p=>!p.manager_id||!rg2.some(x=>x.id===p.manager_id));return rg2t.length>0?rg2t.sort((a,b)=>(GRADE_ORDER_OC[a.grade]||9)-(GRADE_ORDER_OC[b.grade]||9)).map(p=>renderPerson(p,0,dept.key)):<div className="oc-empty">Перетащите сотрудника</div>;})()}
                    </div>
                  </div>
                  {noRg.length>0&&<div style={{marginTop:8}}><div style={{fontSize:10,color:'var(--text2)'}}>Без группы:</div>{noRg.filter(p=>!p.manager_id||!noRg.some(x=>x.id===p.manager_id)).map(p=>renderPerson(p,0,dept.key))}</div>}
                </div>
              </div>;
            }

            if(dept.key==='HR'){
              return <div key={dept.key} className="oc-dept" style={{gridColumn:'span 2'}}>
                <div className="oc-dept-head" style={{background:dept.color+'22',color:dept.color}}>
                  <span>{dept.icon} {dept.key} ({deptPersons.length})</span>
                  <span style={{fontSize:11}}>ФОТ: {fmt(deptPersons.filter(x=>x.grade!=='C5').reduce((s,x)=>s+getPersonDeptSalary(x),0))} ₽/мес</span>
                </div>
                <div className="oc-dept-body">
                  <div className="oc-prod-groups" style={{gridTemplateColumns:'repeat(4,1fr)'}}>
                    {HR_SECTIONS.map(sec=>{
                      const secPersons=deptPersons.filter(p=>(p.hr_section||'')===sec.key);
                      return <div key={sec.key} className="oc-prod-group" onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();if(dragPerson){const dp=store.data.persons.find(x=>x.id===dragPerson);const cur=getPersonDepts(dp);const next=cur.includes('HR')?cur:[...cur,'HR'];store.updatePerson(dragPerson,{departments:next,department:next[0]||'HR',hr_section:sec.key});setDragPerson(null);}}}>
                        <h4 style={{color:sec.color}}>{sec.icon} {sec.key} ({secPersons.length})</h4>
                        {(()=>{const secT=secPersons.filter(p=>!p.manager_id||!secPersons.some(x=>x.id===p.manager_id));return secT.length>0?secT.sort((a,b)=>(GRADE_ORDER_OC[a.grade]||9)-(GRADE_ORDER_OC[b.grade]||9)).map(p=>renderPerson(p,0,dept.key)):<div className="oc-empty">Перетащите сотрудника</div>;})()}
                      </div>;
                    })}
                  </div>
                  {(()=>{const noSec=deptPersons.filter(p=>!p.hr_section||!HR_SECTIONS.some(s=>s.key===p.hr_section));const noSecT=noSec.filter(p=>!p.manager_id||!noSec.some(x=>x.id===p.manager_id));return noSecT.length>0?<div style={{marginTop:8}}><div style={{fontSize:10,color:'var(--text2)'}}>Без секции:</div>{noSecT.map(p=>renderPerson(p,0,dept.key))}</div>:null;})()}
                </div>
              </div>;
            }

            if(dept.key==='Продажи и Маркетинг'){
              return <div key={dept.key} className="oc-dept" style={{gridColumn:'span 2'}}>
                <div className="oc-dept-head" style={{background:dept.color+'22',color:dept.color}}>
                  <span>{dept.icon} {dept.key} ({deptPersons.length})</span>
                  <span style={{fontSize:11}}>ФОТ: {fmt(deptPersons.filter(x=>x.grade!=='C5').reduce((s,x)=>s+getPersonDeptSalary(x),0))} ₽/мес</span>
                </div>
                <div className="oc-dept-body">
                  <div className="oc-prod-groups" style={{gridTemplateColumns:'repeat(3,1fr)'}}>
                    {SALES_SECTIONS.map(sec=>{
                      const secPersons=deptPersons.filter(p=>(p.sales_section||'')===sec.key);
                      return <div key={sec.key} className="oc-prod-group" onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();if(dragPerson){const dp=store.data.persons.find(x=>x.id===dragPerson);const cur=getPersonDepts(dp);const next=cur.includes('Продажи и Маркетинг')?cur:[...cur,'Продажи и Маркетинг'];store.updatePerson(dragPerson,{departments:next,department:next[0]||'Продажи и Маркетинг',sales_section:sec.key});setDragPerson(null);}}}>
                        <h4 style={{color:sec.color}}>{sec.icon} {sec.key} ({secPersons.length})</h4>
                        {(()=>{const secT=secPersons.filter(p=>!p.manager_id||!secPersons.some(x=>x.id===p.manager_id));return secT.length>0?secT.sort((a,b)=>(GRADE_ORDER_OC[a.grade]||9)-(GRADE_ORDER_OC[b.grade]||9)).map(p=>renderPerson(p,0,dept.key)):<div className="oc-empty">Перетащите сотрудника</div>;})()}
                      </div>;
                    })}
                  </div>
                  {(()=>{const noSec=deptPersons.filter(p=>!p.sales_section||!SALES_SECTIONS.some(s=>s.key===p.sales_section));const noSecT=noSec.filter(p=>!p.manager_id||!noSec.some(x=>x.id===p.manager_id));return noSecT.length>0?<div style={{marginTop:8}}><div style={{fontSize:10,color:'var(--text2)'}}>Без секции:</div>{noSecT.map(p=>renderPerson(p,0,dept.key))}</div>:null;})()}
                </div>
              </div>;
            }

            return <div key={dept.key} className="oc-dept" onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();handleDrop(dept.key,null);}}>
              <div className="oc-dept-head" style={{background:dept.color+'22',color:dept.color}}>
                <span>{dept.icon} {dept.key}</span>
                <span style={{fontSize:11,fontWeight:400}}>{deptPersons.length} чел. | ФОТ: {fmt(deptPersons.filter(x=>x.grade!=='C5').reduce((s,x)=>s+getPersonDeptSalary(x),0))} ₽/мес</span>
              </div>
              <div className="oc-dept-body">
                {tops.length>0?tops.sort((a,b)=>(GRADE_ORDER_OC[a.grade]||9)-(GRADE_ORDER_OC[b.grade]||9)).map(p=>renderPerson(p,0,dept.key))
                :<div className={'oc-drop-zone'+(dragPerson?' drag-active':'')}>Перетащите сотрудника</div>}
              </div>
            </div>;
          })}
        </div>
        {unassigned.length>0&&<div className="oc-dept" style={{marginTop:8}}>
          <div className="oc-dept-head" style={{background:'var(--bg2)'}}>
            <span>📋 Без отдела</span>
            <span style={{fontSize:11}}>{unassigned.length} чел. | ФОТ: {fmt(unassigned.filter(x=>x.grade!=='C5').reduce((s,x)=>s+getPersonDeptSalary(x),0))} ₽/мес</span>
          </div>
          <div className="oc-dept-body">{unassigned.map(p=>renderPerson(p,0,''))}</div>
        </div>}
      </div>;
    })()}

    <div className="people-stats">
      <div className="ps-card"><div className="ps-label">Выплачено фикс</div><div className="ps-val">{fmt(totalSalary)} ₽</div></div>
      <div className="ps-card"><div className="ps-label">Выплачено премий</div><div className="ps-val">{fmt(totalBonus)} ₽</div></div>
    </div>
    {viewMode==='cards'&&<React.Fragment><div className="people-filters">
      {[['all','Все'],['active','Активные'],['fired','Уволенные']].map(([k,l])=><button key={k} className={'pf-btn'+(filter===k?' active':'')} onClick={()=>setFilter(k)}>{l} ({k==='all'?persons.length:k==='active'?active.length:fired.length})</button>)}
    </div>
    <div className="people-filters" style={{marginTop:4}}>
      <button className={'pf-btn'+(deptFilter==='all'?' active':'')} onClick={()=>setDeptFilter('all')}>Все отделы</button>
      {ORG_DEPTS.map(d=>{const cnt=filteredByStatus.filter(p=>getPersonDepts(p).includes(d.key)).length;return cnt>0?<button key={d.key} className={'pf-btn'+(deptFilter===d.key?' active':'')} onClick={()=>setDeptFilter(d.key)} style={deptFilter===d.key?{background:d.color,color:'#fff',borderColor:d.color}:{}}>{d.icon} {d.key.length>12?d.key.substring(0,12)+'..':d.key} ({cnt})</button>:null;})}
      {(()=>{const noD=filteredByStatus.filter(p=>getPersonDepts(p).length===0).length;return noD>0?<button className={'pf-btn'+(deptFilter==='none'?' active':'')} onClick={()=>setDeptFilter('none')}>Без отд. ({noD})</button>:null;})()}
    </div>
    <div className="person-grid">{filtered.map(p=>{
      const isFired=!!p.fire_date;
      return <div key={p.id} className="person-card clickable" style={isFired?{opacity:0.65}:{}} onClick={()=>setEditPerson(p)}>
      <div style={{fontSize:14,fontWeight:600}}>{p.name}{p.grade&&<span className="p-grade">{p.grade}</span>}<span className={'p-status '+(isFired?'fired':'active')}>{isFired?'Уволен':'Активен'}</span></div>
      <div style={{fontSize:11,color:'var(--text2)',marginTop:2}}>{p.position||'—'}{p.email?' · '+p.email:''}{getPersonDepts(p).map(d=><span key={d} style={{marginLeft:4,padding:'1px 6px',borderRadius:8,fontSize:9,background:'var(--bg3)',color:'var(--text2)'}}>{d}</span>)}</div>
      {(p.hire_date||p.fire_date)&&<div className="p-dates">
        {p.hire_date&&<span>C {p.hire_date}</span>}
        {p.fire_date&&<span>по {p.fire_date}</span>}
        {p.hire_date&&<span>Стаж: {(()=>{const end=p.fire_date?new Date(p.fire_date):new Date();const start=new Date(p.hire_date);const months=Math.max(0,Math.round((end-start)/(1000*60*60*24*30.44)));return months<12?months+' мес.':Math.floor(months/12)+' г. '+(months%12)+' мес.';})()}</span>}
      </div>}
      {(()=>{const pa=p.paei||{};const hasP=pa.p||pa.a||pa.e||pa.i;if(!hasP)return null;const code=PAEI_AXES.map(ax=>{const v=pa[ax.key]||0;return v>=6?ax.label.toUpperCase():v>=3?ax.label.toLowerCase():'-';}).join('');return <div className="paei-bar" title={'PAEI: '+code}>
        {PAEI_AXES.map(ax=><div key={ax.key} className={'paei-axis'+((pa[ax.key]||0)>=6?' strong':'')} style={{background:(pa[ax.key]||0)>=6?ax.color+'22':'var(--bg1)',color:(pa[ax.key]||0)>=6?ax.color:'var(--text2)',borderBottom:'2px solid '+((pa[ax.key]||0)>=3?ax.color:'transparent')}}>{ax.label}{pa[ax.key]||0}</div>)}
      </div>;})()}
      {(()=>{const c=p.competencies||{};const vals=COMPETENCY_MODEL.map(cm=>c[cm.key]||0);const any=vals.some(v=>v>0);if(!any)return null;const avg=(vals.filter(v=>v>0).reduce((s,v)=>s+v,0)/vals.filter(v=>v>0).length).toFixed(1);return <div style={{marginTop:4}}>
        <div style={{fontSize:10,color:'var(--text2)',marginBottom:2}}>Компетенции (avg {avg}/7)</div>
        <div className="comp-mini">{vals.map((v,i)=><div key={i} className="cm-bar" title={COMPETENCY_MODEL[i].name+': '+v} style={{height:Math.max(2,v*4)+'px',background:v===0?'var(--border)':'var(--accent)',opacity:v===0?0.3:0.4+v/7*0.6}}/>)}</div>
      </div>;})()}
      {(()=>{const _wh=getPersonWeekHours(p,thisWeek);const _sal=p.salary_monthly||0;const _rate=_wh>0?Math.round(_sal/(_wh*4.33)):0;return (_wh>0||_sal>0)?<div style={{marginTop:4,padding:'4px 8px',background:'var(--bg1)',borderRadius:6,fontSize:10,display:'flex',gap:10,flexWrap:'wrap'}}>
        {_wh>0&&<span title="Открытые часы этой недели" style={{fontWeight:600,color:'var(--accent)'}}>🕐 {_wh}ч/нед</span>}
        {_sal>0&&<span title="Зарплата в месяц">💵 {fmt(_sal)} ₽/мес</span>}
        {_rate>0&&<span title="Ставка в час">⏱ {fmt(_rate)} ₽/ч</span>}
      </div>:null;})()}
      {(()=>{const idx=calcPersonIndex(p,store.data.projects,store.data.persons);if(!idx||idx.billableHrs===0)return null;return <div style={{marginTop:4,padding:'4px 8px',background:'var(--bg1)',borderRadius:6,fontSize:10,display:'flex',gap:10,flexWrap:'wrap'}}>
        <span title="Вменённый доход">💰 {fmt(idx.imputed)} ₽</span>
        <span title="Индекс эфф. (billable)" style={{fontWeight:600,color:idx.idx1>=1.5?'var(--green)':idx.idx1>=1?'var(--amber)':'var(--red)'}}>📊 K1={idx.idx1}</span>
        <span title="Индекс эфф. (с non-billable)" style={{color:idx.idx2>=1?'var(--green)':idx.idx2>=0.7?'var(--amber)':'var(--red)'}}>K2={idx.idx2}</span>
        <span title="Billable / Non-billable">{idx.billableHrs}ч bill. | {idx.nonBillableHrs}ч non-bill.</span>
      </div>;})()}
      <div style={{display:'flex',gap:14,marginTop:6,fontSize:11,color:'var(--text2)'}}>
        {p.salary_monthly>0&&<span>{fmt(p.salary_monthly)} ₽/мес</span>}
        {(()=>{const wh=getPersonWeekHours(p,thisWeek);return wh>0?<span className="wts-badge">{wh} ч/нед</span>:null;})()}
        <span>{(p.assignments||[]).length} проектов</span>
      </div>
      {((p.total_salary_earned||0)>0||(p.total_bonus_paid||0)>0)&&<div className="p-fin">
        {(p.total_salary_earned||0)>0&&<div className="pf-item"><span className="pf-label">Фикс:</span><span className="pf-val">{fmt(p.total_salary_earned)} ₽</span></div>}
        {(p.total_bonus_paid||0)>0&&<div className="pf-item"><span className="pf-label">Премии:</span><span className="pf-val">{fmt(p.total_bonus_paid)} ₽</span></div>}
      </div>}
      {(()=>{const wh=getPersonWeekHours(p,thisWeek);const rate=wh>0&&p.salary_monthly>0?Math.round(p.salary_monthly/(wh*4.33)):0;return <div>
        {rate>0&&<div className="wts-rate">Ставка: {fmt(rate)} ₽/час ({fmt(Math.round(rate*8))} ₽/день)</div>}
        <button className="btn btn-sm btn-secondary" style={{marginTop:4,fontSize:10,padding:'2px 8px'}} onClick={e=>{e.stopPropagation();setTsFor(tsFor===p.id?null:p.id);setTsForm({week_start:thisWeek,open_hours:wh||40,notes:''});}}>{tsFor===p.id?'Скрыть':'Открыть часы'}</button>
      </div>;})()}
      {tsFor===p.id&&<div className="wts-panel" onClick={e=>e.stopPropagation()}>
        <h4>Тайм-шит: {p.name}</h4>
        <div className="wts-add">
          <div className="form-group" style={{flex:0,minWidth:120}}><label style={{fontSize:10}}>Неделя</label><input type="date" value={tsForm.week_start} onChange={e=>setTsForm(f=>({...f,week_start:e.target.value}))} style={{fontSize:11,padding:'3px 6px'}}/></div>
          <div className="form-group" style={{flex:0,minWidth:60}}><label style={{fontSize:10}}>Часы</label><input type="number" min="0" max="168" value={tsForm.open_hours} onChange={e=>setTsForm(f=>({...f,open_hours:e.target.value}))} style={{fontSize:11,padding:'3px 6px',width:55}}/></div>
          <div className="form-group" style={{flex:1,minWidth:80}}><label style={{fontSize:10}}>Заметка</label><input value={tsForm.notes} onChange={e=>setTsForm(f=>({...f,notes:e.target.value}))} placeholder="Отпуск, больничный..." style={{fontSize:11,padding:'3px 6px'}}/></div>
          <button className="btn btn-primary btn-sm" style={{marginBottom:12,padding:'3px 10px',fontSize:11}} onClick={()=>{if(tsForm.week_start){store.upsertWeeklyHours(p.id,tsForm.week_start,Number(tsForm.open_hours)||0,tsForm.notes);}}}>OK</button>
        </div>
        {(p.weekly_timesheets||[]).length>0&&<table className="wts-table">
          <thead><tr><th>Неделя</th><th>Часы</th><th>Заметка</th><th></th></tr></thead>
          <tbody>{(p.weekly_timesheets||[]).slice(0,8).map(w=><tr key={w.id}><td>{w.week_start}</td><td style={{fontWeight:600}}>{w.open_hours}</td><td style={{color:'var(--text2)'}}>{w.notes||'—'}</td><td><span className="clickable" style={{color:'var(--red)',fontSize:12}} onClick={()=>store.deleteWeeklyHours(p.id,w.id)}>×</span></td></tr>)}</tbody>
        </table>}
      </div>}
      <div style={{marginTop:4,display:'flex',flexWrap:'wrap',gap:4}}>{(()=>{const projHrs=store.data.projects.map(pr=>{const h=(pr.timeEntries||[]).filter(te=>te.person_id===p.id).reduce((s,te)=>s+(Number(te.hours)||0),0);const assigned=(pr.assignments||[]).some(a=>a.person_id===p.id);return{code:pr.code,hours:h,assigned};}).filter(x=>x.hours>0||x.assigned);return projHrs.length>0?projHrs.map((ph,i)=><span key={i} className="badge b-active" style={{fontSize:10}} title={ph.hours>0?ph.hours+' ч на проекте':'Назначен'}>{ph.code}{ph.hours>0?' ('+ph.hours+'ч)':''}</span>):<span style={{fontSize:10,color:'var(--text2)'}}>Нет проектов</span>;})()}</div>
      {!p.fire_date&&<button className="btn btn-sm" style={{marginTop:4,fontSize:10,padding:'2px 8px',background:'var(--red)',color:'#fff',border:'none',borderRadius:4,cursor:'pointer'}} onClick={e=>{e.stopPropagation();if(confirm('Уволить '+p.name+' одним днём?')){store.updatePerson(p.id,{fire_date:new Date().toISOString().slice(0,10),is_active:0});}}}>Уволить одним днём</button>}
    </div>})}</div>
    </React.Fragment>}
    {showNew&&<AddPersonModal store={store} onClose={()=>setShowNew(false)}/>}
    {editPerson&&<EditPersonModal person={editPerson} store={store} onClose={()=>setEditPerson(null)}/>}
  </div>;
}

function KnowledgeView({store,goProject}){
  const recs=store.data.recommendations||[];
  const [knTab,_setKnTab]=useState(()=>localStorage.getItem('pp_knTab')||'completed');
  const setKnTab=(t)=>{localStorage.setItem('pp_knTab',t);_setKnTab(t);};
  const [dragRec,setDragRec]=useState(null);
  const [selectedCp,setSelectedCp]=useState(null);
  const [showAddRec,setShowAddRec]=useState(false);
  const [newRecTitle,setNewRecTitle]=useState('');
  const [newRecDesc,setNewRecDesc]=useState('');
  const [newRecCat,setNewRecCat]=useState('mgmt');
  const completedProjects=useMemo(()=>store.data.projects.filter(p=>p.status==='COMPLETED'),[store.data.projects]);
  const CAT_LABELS={mgmt:"Управление",data:"Модель данных",process:"Процессы",finance:"Финансы",team:"Команда"};
  const CAT_CLS={mgmt:"rc-mgmt",data:"rc-data",process:"rc-process",finance:"rc-finance",team:"rc-team"};
  const COLS=[{key:"backlog",label:"Бэклог"},{key:"in_progress",label:"В работе"},{key:"done",label:"Готово"}];
  const batches=[...new Set(recs.map(r=>r.batch_id).filter(Boolean))];
  const byBatch={};
  batches.forEach(bid=>{
    const items=recs.filter(r=>r.batch_id===bid);
    if(items.length>0)byBatch[bid]={ts:items[0].created_at,items};
  });
  const sortedBatches=Object.keys(byBatch).sort((a,b)=>(byBatch[b].ts||"").localeCompare(byBatch[a].ts||""));

  const handleDrop=(col,e)=>{
    e.preventDefault();
    if(dragRec){store.updateRecommendationStatus(dragRec,col);setDragRec(null);}
  };

  const renderCard=(r)=>(
    <div key={r.id} className={"rec-card"+(dragRec===r.id?" dragging":"")}
      draggable={true}
      onDragStart={()=>setDragRec(r.id)}
      onDragEnd={()=>setDragRec(null)}
      onDragOver={e=>e.preventDefault()}>
      <div className={"rc-cat "+(CAT_CLS[r.category]||"rc-mgmt")}>{CAT_LABELS[r.category]||r.category}</div>
      <div className="rc-title">{r.title}</div>
      <div className="rc-desc">{r.description}</div>
      <div className="rc-actions">
        {r.status==="backlog"&&<span className="rc-act-btn" onClick={()=>store.updateRecommendationStatus(r.id,"in_progress")}>В работу</span>}
        {r.status==="in_progress"&&<span className="rc-act-btn" onClick={()=>store.updateRecommendationStatus(r.id,"done")}>Готово</span>}
        {r.status==="done"&&<span className="rc-act-btn" onClick={()=>store.updateRecommendationStatus(r.id,"backlog")}>Вернуть</span>}
        <span className="rc-act-btn" style={{color:"var(--red)"}} onClick={()=>store.deleteRecommendation(r.id)}>x</span>
      </div>
    </div>
  );

  const renderCompletedDetail=(cp)=>{
    const phases=cp.phases||[];
    const tracks=cp.tracks||[];
    const tasks=cp.tasks||[];
    const client=store.data.clients.find(c=>c.id===cp.client_id);
    const persons=store.data.persons||[];
    const pnl=calcPnlHealth(cp,persons);
    const payments=cp.payments||[];
    const totalPaid=payments.filter(x=>x.status==='PAID').reduce((s,x)=>s+(Number(x.amount)||0),0);
    const isLocked=cp.audit_locked===true;
    // Phase speed stats
    const phaseStats=phases.map(ph=>{
      const days=ph.started_at&&ph.completed_at?Math.max(1,Math.ceil((new Date(ph.completed_at)-new Date(ph.started_at))/86400000)):null;
      const stagesCount=(ph.stages||[]).length;
      const stagesDone=(ph.stages||[]).filter(s=>s.status==='COMPLETED').length;
      return {name:ph.phase_name||ph.phase_code,days,stagesCount,stagesDone,status:ph.status};
    });
    const totalProjectDays=cp.start_date&&cp.end_date?Math.max(1,Math.ceil((new Date(cp.end_date)-new Date(cp.start_date))/86400000)):null;

    return <div className="cp-detail">
      <button className="btn btn-sm" style={{marginBottom:8}} onClick={()=>setSelectedCp(null)}>{String.fromCharCode(8592)} Назад к списку</button>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap'}}>
        <h2 style={{margin:'8px 0'}}>{cp.code} {String.fromCharCode(8212)} {cp.name}</h2>
        <div style={{display:'flex',gap:8,alignItems:'center'}}>
          {isLocked?<span style={{fontSize:11,color:'var(--green)',fontWeight:600}}>{String.fromCharCode(128274)} Закрыт для редактирования {cp.audit_locked_at?'('+cp.audit_locked_at.slice(0,10)+')':''}</span>
          :<span style={{fontSize:11,color:'var(--amber)',fontWeight:600}}>{String.fromCharCode(128275)} Открыт для редактирования</span>}
          {isLocked?<button className="btn btn-sm" onClick={()=>store.unlockProject(cp.id)}>Разблокировать</button>
          :<button className="btn btn-primary btn-sm" onClick={()=>store.lockProject(cp.id)}>Закрыть (аудит)</button>}
        </div>
      </div>
      <div className="cp-meta" style={{fontSize:12,marginBottom:12}}>
        <span>Клиент: <strong>{client?.name||cp.client_name||'—'}</strong>{(cp.country||client?.country)&&<span style={{marginLeft:6,fontSize:10,padding:'1px 6px',background:'var(--accent)',color:'#fff',borderRadius:6}}>{cp.country||client?.country}</span>}</span>
        <span>Период: <strong>{cp.start_date||'?'}</strong> {String.fromCharCode(8212)} <strong>{cp.end_date||'?'}</strong>{totalProjectDays&&<span style={{color:'var(--accent)'}}> ({totalProjectDays} дн.)</span>}</span>
        {cp.contract_value>0&&<span>Контракт: <strong>{fmt(cp.contract_value)} {String.fromCharCode(8381)}</strong></span>}
        {cp.project_type&&<span>Тип: <strong>{cp.project_type}</strong></span>}
      </div>

      {pnl.revNet>0&&<div className="pnl-mini" style={{marginBottom:14}}>
        <div style={{fontWeight:700,marginBottom:6,fontSize:13}}>P&L проекта</div>
        <div className="pnl-row"><span>Нетто</span><span className="pnl-val">{fmt(pnl.revNet)} {String.fromCharCode(8381)}</span></div>
        <div className="pnl-row"><span>Накладные</span><span className="pnl-val" style={{color:'var(--violet)'}}>-{fmt(pnl.ohTotal)} {String.fromCharCode(8381)}</span></div>
        <div className="pnl-row"><span>Валовая прибыль</span><span className="pnl-val" style={{color:pnl.grossProfit>=0?'var(--green)':'var(--red)'}}>{fmt(pnl.grossProfit)} {String.fromCharCode(8381)} ({pnl.grossPct}%)</span></div>
        <div className="pnl-row"><span>Затраты C1-C4</span><span className="pnl-val" style={{color:'var(--red)'}}>-{fmt(pnl.costProd)} {String.fromCharCode(8381)}</span></div>
        <div className="pnl-row" style={{fontWeight:600}}><span>Грязная валовая</span><span className="pnl-val" style={{color:pnl.dirtyProfit>=0?'var(--green)':'var(--red)'}}>{fmt(pnl.dirtyProfit)} {String.fromCharCode(8381)} ({pnl.dirtyPct}%)</span></div>
        <div className="pnl-row"><span>Затраты C5</span><span className="pnl-val" style={{color:'var(--amber)'}}>-{fmt(pnl.costC5)} {String.fromCharCode(8381)}</span></div>
        <div className="pnl-row total"><span>Чистая валовая</span><span className="pnl-val" style={{color:pnl.cleanProfit>=0?'var(--green)':'var(--red)'}}>{fmt(pnl.cleanProfit)} {String.fromCharCode(8381)} ({pnl.cleanPct}%)</span></div>
        <div className="pnl-row" style={{marginTop:4}}><span>{String.fromCharCode(10004)} Приход факт</span><span className="pnl-val" style={{color:'var(--green)'}}>{fmt(pnl.paidSum||totalPaid)} {String.fromCharCode(8381)}</span></div>
        <div className="pnl-row"><span>Приход план</span><span className="pnl-val">{fmt(pnl.plannedSum||0)} {String.fromCharCode(8381)}</span></div>
        {pnl.paidSum>0&&pnl.revNet>0&&<div className="pnl-row"><span>Оплачено %</span><span className="pnl-val" style={{fontWeight:600}}>{Math.round(pnl.paidSum/pnl.revNet*100)}%</span></div>}
      </div>}

      {phaseStats.length>0&&<div style={{marginBottom:14}}>
        <h3 style={{marginTop:0}}>{String.fromCharCode(9203)} Скорость прохождения фаз</h3>
        <table><thead><tr><th>Фаза</th><th>Статус</th><th>Дней</th><th>Стадии</th></tr></thead>
        <tbody>{phaseStats.map((ps,i)=><tr key={i}>
          <td style={{fontWeight:600}}>{ps.name}</td>
          <td>{SB(ps.status)}</td>
          <td style={{fontWeight:600,color:ps.days?'var(--accent)':'var(--text2)'}}>{ps.days?ps.days+' дн.':'—'}</td>
          <td>{ps.stagesDone}/{ps.stagesCount}</td>
        </tr>)}</tbody></table>
      </div>}

      <h3>{String.fromCharCode(128295)} Треки ({tracks.length})</h3>
      {tracks.length>0?<table><thead><tr><th>Код</th><th>Трек</th><th>Класс</th>{p.project_type==='New Delivery'&&<th>Период</th>}<th>Статус</th><th>Начало</th><th>Конец</th></tr></thead>
      <tbody>{tracks.map(t=><tr key={t.id}>
        <td style={{fontWeight:600,color:'var(--accent2)'}}>{t.track_code}</td>
        <td>{t.track_name}</td>
        <td>{t.track_class}</td>
        {p.project_type==='New Delivery'&&<td style={{fontSize:10,color:'var(--accent2)'}}>{t.nd_period_idx?(p.phases||[])[t.nd_period_idx-1]?.phase_name||'П'+t.nd_period_idx:'—'}</td>}
        <td>{SB(t.status)}</td>
        <td style={{fontSize:11,color:'var(--text2)'}}>{t.start_date||'—'}</td>
        <td style={{fontSize:11,color:'var(--text2)'}}>{t.end_date||'—'}</td>
      </tr>)}</tbody></table>:<div className="empty">Нет треков</div>}

      <h3>{String.fromCharCode(9989)} Задачи ({tasks.length})</h3>
      {tasks.length>0?<table><thead><tr><th>Задача</th><th>Статус</th><th>Исполнитель</th><th>Приоритет</th></tr></thead>
      <tbody>{tasks.map(tk=><tr key={tk.id}>
        <td>{tk.title}</td>
        <td>{SB(tk.status)}</td>
        <td style={{color:'var(--text2)'}}>{tk.assignee_name||'—'}</td>
        <td style={{textAlign:'center'}}>{tk.priority||'—'}</td>
      </tr>)}</tbody></table>:<div className="empty">Нет задач</div>}

      {(cp.hypothesisBoard?.subjects||[]).length>0&&<div>
        <h3>{String.fromCharCode(128269)} Issue Tree</h3>
        <div style={{fontSize:12}}>{(cp.hypothesisBoard.subjects||[]).map(s=><div key={s.id||s.name} style={{marginBottom:6}}>
          <strong>{s.name}</strong>: {(s.insights||[]).length} инсайтов
        </div>)}</div>
      </div>}

      <div style={{marginTop:16,display:'flex',gap:8}}>
        {!isLocked&&<button className="btn btn-primary btn-sm" onClick={()=>goProject&&goProject(cp.id)}>Редактировать проект</button>}
        {isLocked&&<span style={{fontSize:11,color:'var(--text2)',padding:'6px 0'}}>Проект заблокирован. Разблокируйте для редактирования.</span>}
      </div>
    </div>;
  };

  return <div>
    <h2 className="page-title">База знаний</h2>
    <div className="kn-tabs">
      <div className={"kn-tab"+(knTab==='completed'?' active':'')} onClick={()=>{setKnTab('completed');setSelectedCp(null);}}>🏆 Завершённые проекты <span className="kn-count">{completedProjects.length}</span></div>
      <div className={"kn-tab"+(knTab==='recs'?' active':'')} onClick={()=>setKnTab('recs')}>📋 Рекомендации <span className="kn-count">{recs.length}</span></div>
      <div className={"kn-tab"+(knTab==='artifacts'?' active':'')} onClick={()=>setKnTab('artifacts')}>📚 Артефакты</div>
    </div>

    {knTab==='completed'&&<div>
      {selectedCp?renderCompletedDetail(selectedCp):<div>
        {completedProjects.length===0?<div className="empty" style={{padding:20}}>Нет завершённых проектов. Когда проект переходит в статус COMPLETED, он автоматически перемещается сюда.</div>
        :<div>
          <div style={{fontSize:12,color:'var(--text2)',marginBottom:10}}>Завершённые проекты сохраняют полную историю: фазы, треки, задачи, инсайты.</div>
          {completedProjects.map(cp=>{
            const phases=cp.phases||[];
            const tracks=cp.tracks||[];
            const client=store.data.clients.find(c=>c.id===cp.client_id);
            const donePhases=phases.filter(ph=>ph.status==='COMPLETED').length;
            const doneTracks=tracks.filter(t=>t.status==='COMPLETED').length;
            return <div key={cp.id} className="cp-card" onClick={()=>setSelectedCp(cp)}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div>
                  <span style={{fontWeight:700,color:'var(--accent2)',marginRight:8}}>{cp.code}</span>
                  <span style={{fontWeight:600}}>{cp.name}</span>
                </div>
                {SB('COMPLETED')}
              </div>
              <div className="cp-meta">
                <span>Клиент: {client?.name||cp.client_name||'—'}</span>
                <span>Период: {cp.start_date||'?'} — {cp.end_date||'?'}</span>
                {cp.contract_value>0&&<span>Контракт: {fmt(cp.contract_value)} ₽</span>}
                {cp.project_type&&<span>Тип: {cp.project_type}</span>}
              </div>
              <div className="cp-phases">
                {phases.map(ph=><span key={ph.id} className="cp-phase">{ph.phase_name||ph.phase_code}</span>)}
              </div>
              <div className="cp-tracks">Треки: {tracks.length} (завершено: {doneTracks}) | Фазы: {phases.length} (завершено: {donePhases})</div>
            </div>;
          })}
        </div>}
      </div>}
    </div>}

    {knTab==='recs'&&<div>
      <div className="rec-layout">
        <div>
          <div className="card-title">Журнал рекомендаций ({recs.length})</div>
          <div className="rec-log">
            {sortedBatches.length===0&&recs.length===0&&<div className="empty">Пока нет рекомендаций.</div>}
            {sortedBatches.map(bid=>{
              const b=byBatch[bid];
              return <div key={bid} className="rec-entry">
                <div className="rec-ts">{b.ts}</div>
                {b.items.map(r=><div key={r.id} style={{marginBottom:6}}>
                  <span className={"rec-cat "+(CAT_CLS[r.category]||"")}>{CAT_LABELS[r.category]||r.category}</span>
                  <span className="rec-title">{r.title}</span>
                  <div className="rec-desc">{r.description}</div>
                </div>)}
              </div>;
            })}
          </div>
        </div>
        <div>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
            <div className="card-title" style={{marginBottom:0}}>Kanban задач</div>
            <button className="btn btn-primary btn-sm" style={{fontSize:11,padding:'3px 10px'}} onClick={()=>setShowAddRec(!showAddRec)}>+ Задача</button>
          </div>
          {showAddRec&&<div style={{background:'var(--bg1)',border:'1px solid var(--border)',borderRadius:10,padding:12,marginBottom:10}}>
            <div style={{display:'flex',gap:8,flexWrap:'wrap',marginBottom:8}}>
              <input style={{flex:2,minWidth:180,fontSize:12,padding:'6px 10px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg)',color:'var(--text)'}} placeholder="Название задачи..." value={newRecTitle} onChange={e=>setNewRecTitle(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&newRecTitle.trim()){store.addRecommendation({title:newRecTitle.trim(),description:newRecDesc.trim(),category:newRecCat});setNewRecTitle('');setNewRecDesc('');setShowAddRec(false);}}}/>
              <select style={{fontSize:11,padding:'4px 8px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg)',color:'var(--text)'}} value={newRecCat} onChange={e=>setNewRecCat(e.target.value)}>
                <option value="mgmt">Управление</option><option value="data">Модель данных</option><option value="process">Процессы</option><option value="finance">Финансы</option><option value="team">Команда</option>
              </select>
            </div>
            <textarea style={{width:'100%',fontSize:12,padding:'6px 10px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg)',color:'var(--text)',resize:'vertical',minHeight:50,boxSizing:'border-box'}} placeholder="Описание (необязательно)..." value={newRecDesc} onChange={e=>setNewRecDesc(e.target.value)} rows={2}/>
            <div style={{display:'flex',gap:6,marginTop:8}}>
              <button className="btn btn-primary btn-sm" style={{fontSize:11,padding:'3px 12px'}} onClick={()=>{if(newRecTitle.trim()){store.addRecommendation({title:newRecTitle.trim(),description:newRecDesc.trim(),category:newRecCat});setNewRecTitle('');setNewRecDesc('');setShowAddRec(false);}}} disabled={!newRecTitle.trim()}>Добавить</button>
              <button className="btn btn-secondary btn-sm" style={{fontSize:11,padding:'3px 12px'}} onClick={()=>{setShowAddRec(false);setNewRecTitle('');setNewRecDesc('');}}>Отмена</button>
            </div>
          </div>}
          <div className="rec-kanban">
            {COLS.map(col=>{
              const items=recs.filter(r=>r.status===col.key);
              return <div key={col.key} className="rec-col"
                onDragOver={e=>e.preventDefault()}
                onDrop={e=>handleDrop(col.key,e)}>
                <div className="rec-col-head"><span>{col.label}</span><span className="rc-count">{items.length}</span></div>
                {items.map(r=>renderCard(r))}
              </div>;
            })}
          </div>
        </div>
      </div>
    </div>}

    {knTab==='artifacts'&&<div>
      {(store.data.knowledgeItems||[]).length>0?<div className="card" style={{marginBottom:14}}>
        <div className="card-title">Артефакты знаний ({store.data.knowledgeItems.length})</div>
        <table><thead><tr><th>Название</th><th>Тип</th><th>Проект</th><th>Повт.</th></tr></thead>
        <tbody>{store.data.knowledgeItems.map(ki=><tr key={ki.id}><td>{ki.title}</td><td style={{color:"var(--text2)"}}>{ki.item_type}</td><td><span className="badge b-active">{ki.project_code}</span></td><td style={{fontWeight:600}}>{ki.reuse_count}</td></tr>)}</tbody></table>
      </div>:<div className="empty" style={{padding:20}}>Нет артефактов знаний</div>}

      {(store.data.tags||[]).length>0&&<div className="card" style={{marginBottom:14}}>
        <div className="card-title">Теги</div>{store.data.tags.map(t=><span key={t.id} className="chip">{t.category}: {t.value}</span>)}
      </div>}
    </div>}
  </div>;
}

function SettingsView({store}){
  const fileRef=useRef();
  const [editClient,setEditClient]=useState(null);
  const [theme,setTheme]=useState(()=>document.documentElement.classList.contains('light')?'light':'dark');
  const toggleTheme=()=>{const next=theme==='dark'?'light':'dark';document.documentElement.className=next;setTheme(next);try{localStorage.setItem('pp_theme',next);}catch(e){}};
  const handleImport=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>store.importData(ev.target.result);reader.readAsText(file);};
  return <div><h2 className="page-title">Настройки <button className="btn btn-secondary btn-sm" onClick={store.exportData}>📥 Экспорт</button> <button className="btn btn-secondary btn-sm" onClick={()=>fileRef.current?.click()}>📤 Импорт</button><input ref={fileRef} type="file" accept=".json" style={{display:'none'}} onChange={handleImport}/></h2>
  <div className="card" style={{marginBottom:16}}><div className="card-title">Тема оформления</div>
    <div className="theme-toggle">
      <span style={{fontSize:18}}>🌙</span>
      <label className="theme-switch"><input type="checkbox" checked={theme==='light'} onChange={toggleTheme}/><span className="theme-slider"></span></label>
      <span style={{fontSize:18}}>☀️</span>
      <span style={{fontSize:13,color:'var(--text2)',marginLeft:8}}>{theme==='dark'?'Тёмная тема':'Светлая тема'}</span>
    </div>
  </div>
  {(()=>{
    const _sess=(() => {try{return JSON.parse(sessionStorage.getItem('pp_auth_session'));}catch(e){return null;}})();
    const _sr=_sess.roles||[_sess.role||'user'];if(!_sr.includes('admin')&&!_sr.includes('partner'))return null;
    const users=store.data.users||[];
    const persons=store.data.persons||[];
    const [showNewUser,setShowNewUser]=React.useState(false);
    const [nuForm,setNuForm]=React.useState({login:'',password:'111111',name:'',person_id:'',role:'user',roles:['user']});
    const [resetInfo,setResetInfo]=React.useState(null);
    const genLogin=(name)=>{
      if(!name)return'';
      const parts=name.trim().split(/\s+/);
      if(parts.length<2)return name.toLowerCase().replace(/[^a-zа-яё0-9]/gi,'');
      const translitMap={'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'yo','ж':'zh','з':'z','и':'i','й':'y','к':'k','л':'l','м':'m','н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'kh','ц':'ts','ч':'ch','ш':'sh','щ':'shch','ъ':'','ы':'y','ь':'','э':'e','ю':'yu','я':'ya'};
      const tlit=(s)=>s.toLowerCase().split('').map(c=>translitMap[c]||c).join('').replace(/[^a-z0-9]/g,'');
      const first=tlit(parts[0]);
      const last=tlit(parts[parts.length-1]);
      return first.charAt(0)+last;
    };
    const handlePersonSelect=(pid)=>{
      const p=persons.find(x=>x.id===pid);
      if(p){setNuForm(f=>({...f,person_id:pid,name:p.name,login:genLogin(p.name)}));}
      else{setNuForm(f=>({...f,person_id:''}));}
    };
    const doCreate=async()=>{
      if(!nuForm.login){alert('Укажите логин');return;}
      if(users.find(u=>u.login===nuForm.login)){alert('Логин уже занят');return;}
      await store.addUser(nuForm);
      setNuForm({login:'',password:'111111',name:'',person_id:'',role:'user',roles:['user']});
      setShowNewUser(false);
    };
    const doReset=async(userId)=>{
      const newPwd=Math.random().toString(36).slice(2,10);
      await store.resetUserPassword(userId,newPwd);
      setResetInfo({userId,newPwd});
    };
    return <div className="card" style={{marginBottom:16}}>
      <div className="card-title" style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>Управление аккаунтами ({users.length})
        <button className="btn btn-success btn-sm" style={{fontSize:11}} onClick={()=>setShowNewUser(!showNewUser)}>+ Новый аккаунт</button>
      </div>
      {showNewUser&&<div style={{marginBottom:12,padding:12,background:'var(--bg2)',borderRadius:8,border:'1px solid var(--border)'}}>
        <div style={{display:'flex',gap:8,marginBottom:8,flexWrap:'wrap'}}>
          <div style={{flex:1,minWidth:150}}>
            <label style={{fontSize:10,color:'var(--text2)'}}>Сотрудник</label>
            <select value={nuForm.person_id} onChange={e=>handlePersonSelect(e.target.value)} style={{width:'100%',padding:'6px 8px',fontSize:12,background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:6,color:'var(--text)'}}>
              <option value="">— не привязан —</option>
              {persons.filter(p=>p.is_active).sort((a,b)=>(a.name||'').localeCompare(b.name||'')).map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
            </select>
          </div>
          <div style={{flex:1,minWidth:120}}>
            <label style={{fontSize:10,color:'var(--text2)'}}>Логин</label>
            <input value={nuForm.login} onChange={e=>setNuForm(f=>({...f,login:e.target.value}))} placeholder="login" style={{width:'100%',padding:'6px 8px',fontSize:12,background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:6,color:'var(--text)',boxSizing:'border-box'}}/>
          </div>
          <div style={{flex:1,minWidth:120}}>
            <label style={{fontSize:10,color:'var(--text2)'}}>Пароль</label>
            <input value={nuForm.password} onChange={e=>setNuForm(f=>({...f,password:e.target.value}))} placeholder="111111" style={{width:'100%',padding:'6px 8px',fontSize:12,background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:6,color:'var(--text)',boxSizing:'border-box'}}/>
          </div>
          <div style={{minWidth:140}}>
            <label style={{fontSize:10,color:'var(--text2)'}}>Роли</label>
            <div style={{display:'flex',flexWrap:'wrap',gap:4,padding:'4px 0'}}>
              {['user','finance','partner','admin'].map(r=><label key={r} style={{fontSize:11,display:'flex',alignItems:'center',gap:3,cursor:'pointer'}}><input type="checkbox" checked={(nuForm.roles||[nuForm.role||'user']).includes(r)} onChange={e=>{const cur=nuForm.roles||[nuForm.role||'user'];const next=e.target.checked?[...cur.filter(x=>x!==r),r]:cur.filter(x=>x!==r);if(next.length===0)next.push('user');setNuForm(f=>({...f,roles:next,role:next[0]}));}}/>{r}</label>)}
            </div>
          </div>
        </div>
        <div style={{display:'flex',gap:8}}>
          <button className="btn btn-primary btn-sm" style={{fontSize:11}} onClick={doCreate}>Создать</button>
          <button className="btn btn-secondary btn-sm" style={{fontSize:11}} onClick={()=>setShowNewUser(false)}>Отмена</button>
        </div>
      </div>}
      {resetInfo&&<div style={{marginBottom:8,padding:8,background:'rgba(34,197,94,0.1)',borderRadius:6,border:'1px solid rgba(34,197,94,0.2)',fontSize:12,color:'var(--green)'}}>
        Новый пароль: <strong style={{fontFamily:'monospace',letterSpacing:1}}>{resetInfo.newPwd}</strong> — сообщите пользователю (показывается один раз)
        <span style={{cursor:'pointer',marginLeft:8}} onClick={()=>setResetInfo(null)}>✕</span>
      </div>}
      <table style={{width:'100%',fontSize:12}}><thead><tr><th>Логин</th><th>Имя</th><th>Роль</th><th>Сотрудник</th><th>Последний вход</th><th></th></tr></thead>
      <tbody>{users.map(u=>{
        const linkedP=u.person_id&&persons.find(p=>p.id===u.person_id);
        return <tr key={u.id}>
          <td style={{fontWeight:600,fontFamily:'monospace'}}>{u.login}</td>
          <td>{u.name||'—'}</td>
          <td style={{fontSize:10}}>{_getUserRoles(u).map(r=>{const rc={admin:{bg:'rgba(251,191,36,0.15)',c:'#eab308'},partner:{bg:'rgba(168,85,247,0.15)',c:'#a855f7'},finance:{bg:'rgba(6,182,212,0.15)',c:'#06b6d4'},user:{bg:'rgba(99,102,241,0.1)',c:'#6366f1'}};const s=rc[r]||rc.user;return <span key={r} style={{display:'inline-block',fontSize:9,padding:'1px 5px',borderRadius:4,background:s.bg,color:s.c,fontWeight:600,marginRight:3,cursor:'pointer'}} onClick={()=>{if(confirm('Убрать роль «'+r+'» у '+u.login+'?')){const nr=_getUserRoles(u).filter(x=>x!==r);if(nr.length===0)nr.push('user');store.updateUser(u.id,{roles:nr,role:nr[0]});}}} title={'Клик — убрать роль «'+r+'»'}>{r}</span>;})}
            <select onChange={e=>{if(e.target.value){const cur=_getUserRoles(u);if(!cur.includes(e.target.value)){store.updateUser(u.id,{roles:[...cur,e.target.value],role:cur[0]});}e.target.value='';}}} style={{fontSize:9,padding:'1px 2px',border:'1px solid var(--border)',borderRadius:3,background:'var(--bg3)',color:'var(--text2)',width:18,cursor:'pointer'}} title="Добавить роль"><option value="">+</option>{['user','finance','partner','admin'].filter(r=>!_getUserRoles(u).includes(r)).map(r=><option key={r} value={r}>{r}</option>)}</select></td>
          <td style={{fontSize:11,color:'var(--text2)'}}>{linkedP?linkedP.name:'—'}</td>
          <td style={{fontSize:10,color:'var(--text2)'}}>{u.last_login?u.last_login.slice(0,16).replace('T',' '):'никогда'}</td>
          <td style={{display:'flex',gap:4}}>
            <button style={{fontSize:9,padding:'2px 6px',border:'1px solid var(--amber)',borderRadius:4,background:'transparent',color:'var(--amber)',cursor:'pointer'}} onClick={()=>doReset(u.id)} title="Сбросить пароль">🔑</button>
            {u.id!=='__ADMIN__'&&<button style={{fontSize:9,padding:'2px 6px',border:'1px solid var(--red)',borderRadius:4,background:'transparent',color:'var(--red)',cursor:'pointer'}} onClick={()=>{if(confirm('Удалить аккаунт «'+u.login+'»?'))store.deleteUser(u.id);}} title="Удалить">✕</button>}
          </td>
        </tr>;
      })}</tbody></table>
    </div>;
  })()}
  <div className="card" style={{marginBottom:16}}><div className="card-title">Типы проектов ({(store.data.projectTypes||[]).length})</div>
    <div style={{display:'flex',flexWrap:'wrap',gap:6,marginBottom:10}}>{(store.data.projectTypes||[]).map(t=><span key={t} className="type-chip">{t}<span className="del" onClick={()=>{if(confirm('Удалить тип "'+t+'"?'))store.deleteProjectType(t);}}>×</span></span>)}</div>
    <div style={{display:'flex',gap:8}}><input id="new-pt-input" placeholder="Новый тип..." style={{flex:1,padding:'6px 10px',background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:8,color:'var(--text)',fontSize:12}}/><button className="btn btn-success btn-sm" onClick={()=>{const inp=document.getElementById('new-pt-input');if(inp.value.trim()){store.addProjectType(inp.value.trim());inp.value='';}}}>+ Добавить</button></div></div>
  <div className="card" style={{marginBottom:16}}><div className="card-title">Фазы Double Diamond ({store.data.phaseTemplates.length})</div>
    <table><thead><tr><th>Код</th><th>Фаза</th><th>Класс</th><th>#</th></tr></thead><tbody>{store.data.phaseTemplates.map(pt=><tr key={pt.id}><td style={{fontWeight:600}}>{pt.code}</td><td>{pt.name}</td><td>{TCB(pt.track_class)}</td><td>{pt.order_num}</td></tr>)}</tbody></table></div>
  <div className="card" style={{marginBottom:16}}><div className="card-title">Стадии ({store.data.stageTemplates.length})</div>
    <div>{store.data.stageTemplates.map(st=><span key={st.id} className="chip">{st.order_num}. {st.code} — {st.name}</span>)}</div></div>
  <div className="card" style={{marginBottom:16}}><div className="card-title">Треки ({store.data.trackTemplates.length})</div>
    <table><thead><tr><th>Код</th><th>Трек</th><th>Класс</th><th>Домен</th></tr></thead><tbody>{store.data.trackTemplates.map(tt=><tr key={tt.id}><td style={{fontWeight:600}}>{tt.code}</td><td>{tt.name}</td><td>{TCB(tt.track_class)}</td><td style={{color:'var(--text2)',fontSize:11}}>{tt.domain||'—'}</td></tr>)}</tbody></table></div>
  <div className="card" style={{marginBottom:16}}><div className="card-title">Клиенты ({store.data.clients.length})</div>
    <table><thead><tr><th>Название</th><th>Страна</th><th>Отрасль</th><th>Контакт</th><th>Проектов</th></tr></thead><tbody>{store.data.clients.map(c=>{const pCount=store.data.projects.filter(p=>p.client_id===c.id).length;return <tr key={c.id} className="clickable" onClick={()=>setEditClient(c)}><td style={{fontWeight:600}}>{c.name}</td><td style={{fontSize:11}}>{c.country||<span style={{color:'var(--red)',fontSize:10}}>не указана</span>}</td><td style={{color:'var(--text2)'}}>{c.industry||'—'}</td><td style={{color:'var(--text2)',fontSize:11}}>{c.contact_person||'—'}</td><td>{pCount}</td></tr>;})}</tbody></table></div>
  {editClient&&<EditClientModal client={editClient} store={store} onClose={()=>setEditClient(null)} onGoProject={goProject?(id)=>{setEditClient(null);goProject(id);}:null}/>}
  <div className="card"><div className="card-title">FullKit ({store.data.fullKitComponents.length})</div>
    <div>{store.data.fullKitComponents.map(c=><span key={c.id} className="chip">{c.code} — {c.name}</span>)}</div></div>
</div>;}

function ClientsView({store,goProject}){
  const [selClient,setSelClient]=useState(null);
  const [editClient,setEditClient]=useState(null);
  const [showNewProj,setShowNewProj]=useState(false);
  const [clSearch,setClSearch]=useState('');
  const [clCountry,setClCountry]=useState('');
  const [clIndustry,setClIndustry]=useState('');
  const [clHealth,setClHealth]=useState('');
  const [clDeals,setClDeals]=useState('');
  const [clSort,setClSort]=useState('revenue');
  const [clSegment,setClSegment]=useState('');
  const [clientTab,setClientTab]=useState('agency');
  const clientAgg=useMemo(()=>{
    const icfDeals=store.data.icf_deals||[];
    return store.data.clients.map(c=>{
      const projs=store.data.projects.filter(p=>p.client_id===c.id);
      const strelaDeals=icfDeals.filter(d=>d.company_id===c.id);
      const isAgency=projs.length>0;
      const isStrela=strelaDeals.length>0;
      const strelaDealCount=strelaDeals.length;
      const strelaSum=strelaDeals.reduce((s,d)=>s+(Number(d.cost)||0),0);
      const strelaProducts=[...new Set(strelaDeals.map(d=>d.product).filter(Boolean))];
      let totalRev=0,totalRevNet=0,totalCostProd=0,totalCostAll=0,totalOh=0,totalHours=0;
      projs.forEach(proj=>{
        const rev=Number(proj.total_contract_value)||Number(proj.fixed_price)||0;
        const tr=_effTax(proj.tax_rate);
        totalRev+=rev;
        totalRevNet+=Math.round(rev*(1-tr/100));
        let cA=0,cP=0;
        (proj.timeEntries||[]).forEach(te=>{
          const per=store.data.persons.find(x=>x.id===te.person_id);
          if(!per||!per.salary_monthly)return;
          const dt=te.date?new Date(te.date):new Date();
          const dy=dt.getDay();const df=dt.getDate()-dy+(dy===0?-6:1);
          const wk=new Date(dt.getFullYear(),dt.getMonth(),df).toISOString().slice(0,10);
          const we=(per.weekly_timesheets||[]).find(w=>w.week_start===wk);
          const oh=we?we.open_hours:40;
          const rate=oh>0?getPersonSalaryAtDate(per,te.date||new Date().toISOString().slice(0,10))/(oh*4.33):0;
          const cost=rate*(Number(te.hours)||0);
          cA+=cost;if(per.grade!=='C5')cP+=cost;
        });
        totalCostProd+=Math.round(cP);totalCostAll+=Math.round(cA);
        totalOh+=(proj.overheads||[]).reduce((s,x)=>s+(Number(x.amount)||0),0);
        totalHours+=(proj.timeEntries||[]).reduce((s,te)=>s+(Number(te.hours)||0),0);
      });
      const dirtyProfit=totalRevNet-totalCostProd-totalOh;
      const cleanProfit=totalRevNet-totalCostAll-totalOh;
      const dirtyPct=totalRevNet>0?Math.round(dirtyProfit/totalRevNet*100):0;
      const cleanPct=totalRevNet>0?Math.round(cleanProfit/totalRevNet*100):0;
      const health=totalRev===0?'gray':dirtyPct>=80?'green':dirtyPct>=75?'yellow':'red';
      return {...c,projs,isAgency,isStrela,strelaDealCount,strelaSum,strelaProducts,totalRev,totalRevNet,totalCostProd,totalCostAll,totalOh,totalHours,dirtyProfit,cleanProfit,dirtyPct,cleanPct,health};
    }).sort((a,b)=>b.totalRev-a.totalRev);
  },[store.data]);
  const sel=selClient?clientAgg.find(c=>c.id===selClient):null;
  if(sel)return <div>
    <span className="client-detail-back" onClick={()=>setSelClient(null)}>← Все клиенты</span>
    <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:12}}>
      <h2 className="page-title" style={{margin:0}}>{sel.name}</h2>
      {sel.country&&<span style={{fontSize:11,color:'#fff',padding:'2px 8px',background:'var(--accent)',borderRadius:8}}>{sel.country}</span>}
      {sel.industry&&<span style={{fontSize:11,color:'var(--text2)',padding:'2px 8px',background:'var(--bg3)',borderRadius:8}}>{sel.industry}</span>}
      <span className={'pnl-health '+sel.health}>{sel.health==='green'?'✅':sel.health==='yellow'?'\u26A0\uFE0F':sel.health==='red'?'\uD83D\uDD34':'➖'}{sel.health!=='gray'?' '+sel.dirtyPct+'%':' Нет данных'}</span>
      <button className="btn btn-secondary btn-sm" onClick={()=>setEditClient(sel)}>Ред.</button>
      <button className="btn btn-success btn-sm" onClick={()=>setShowNewProj(true)}>+ Проект</button>
    </div>
    <div style={{display:'flex',gap:8,marginBottom:12,flexWrap:'wrap',fontSize:11,color:'var(--text2)'}}>
      {sel.contact_person&&<span>{'👤'} {sel.contact_person}</span>}{sel.contact_email&&<span>{'✉'} {sel.contact_email}</span>}{sel.contact_phone&&<span>{'☎'} {sel.contact_phone}</span>}{sel.inn&&<span>{'ИНН: '+sel.inn}</span>}{sel.segment&&<span>{'Сегмент: '+sel.segment}</span>}
    </div>
    <div className="cv-fin-grid" style={{marginBottom:16}}>
      <div className="cv-fin-item"><div className="cv-lbl">Контракты (брутто)</div><div className="cv-val" style={{color:'var(--green)'}}>{fmt(sel.totalRev)} ₽</div></div>
      <div className="cv-fin-item"><div className="cv-lbl">Нетто</div><div className="cv-val" style={{color:'var(--emerald)'}}>{fmt(sel.totalRevNet)} ₽</div></div>
      <div className="cv-fin-item"><div className="cv-lbl">Грязная рент.</div><div className="cv-val" style={{color:sel.dirtyProfit>=0?'var(--green)':'var(--red)'}}>{fmt(sel.dirtyProfit)} ₽</div></div>
      <div className="cv-fin-item"><div className="cv-lbl">Чистая рент.</div><div className="cv-val" style={{color:sel.cleanProfit>=0?'var(--green)':'var(--red)'}}>{fmt(sel.cleanProfit)} ₽</div></div>
    </div>
    <div className="profit-panel" style={{marginBottom:16}}>
      <div style={{fontSize:12,fontWeight:600,textTransform:'uppercase',letterSpacing:'.3px',color:'var(--text2)',marginBottom:8}}>Сводный P&L по клиенту</div>
      <div className="profit-row"><span className="pr-label">Выручка (брутто)</span><span className="pr-val">{fmt(sel.totalRev)} ₽</span></div>
      <div className="profit-row"><span className="pr-label">− Налоги</span><span className="pr-val pr-neg">−{fmt(sel.totalRev-sel.totalRevNet)} ₽</span></div>
      <div className="profit-row"><span className="pr-label">= Выручка (нетто)</span><span className="pr-val">{fmt(sel.totalRevNet)} ₽</span></div>
      <div className="profit-row"><span className="pr-label">− Косты производства</span><span className="pr-val pr-neg">−{fmt(sel.totalCostProd)} ₽</span></div>
      <div className="profit-row"><span className="pr-label">− Накладные</span><span className="pr-val pr-neg">−{fmt(sel.totalOh)} ₽</span></div>
      <div className="profit-row pr-total"><span className="pr-label" style={{fontWeight:700}}>= Грязная валовая прибыль</span><span className={'pr-val '+(sel.dirtyProfit>=0?'pr-pos':'pr-neg')}>{fmt(sel.dirtyProfit)} ₽ ({sel.dirtyPct}%)</span></div>
      <div className="profit-row"><span className="pr-label">− Косты C5</span><span className="pr-val pr-neg">−{fmt(sel.totalCostAll-sel.totalCostProd)} ₽</span></div>
      <div className="profit-row pr-total" style={{borderTop:'2px solid var(--accent)',paddingTop:10}}><span className="pr-label" style={{fontWeight:700}}>= Чистая валовая прибыль</span><span className={'pr-val '+(sel.cleanProfit>=0?'pr-pos':'pr-neg')}>{fmt(sel.cleanProfit)} ₽ ({sel.cleanPct}%)</span></div>
    </div>
    <div className="card"><div className="card-title">Проекты ({sel.projs.length})</div>
      <table><thead><tr><th>Код</th><th>Название</th><th>Статус</th><th>Контракт</th><th>Грязная</th><th>P&L</th><th>Часов</th></tr></thead>
      <tbody>{sel.projs.map(proj=>{
        const rev2=Number(proj.total_contract_value)||Number(proj.fixed_price)||0;
        const tr2=_effTax(proj.tax_rate);const rn2=Math.round(rev2*(1-tr2/100));
        let cp2=0;(proj.timeEntries||[]).forEach(te=>{const pe=store.data.persons.find(x=>x.id===te.person_id);if(!pe||!pe.salary_monthly||pe.grade==='C5')return;const dt=te.date?new Date(te.date):new Date();const dy=dt.getDay();const df=dt.getDate()-dy+(dy===0?-6:1);const wk=new Date(dt.getFullYear(),dt.getMonth(),df).toISOString().slice(0,10);const we=(pe.weekly_timesheets||[]).find(w=>w.week_start===wk);const oh=we?we.open_hours:40;cp2+=oh>0?getPersonSalaryAtDate(pe,te.date||new Date().toISOString().slice(0,10))/(oh*4.33)*(Number(te.hours)||0):0;});
        const oh2=(proj.overheads||[]).reduce((s,x)=>s+(Number(x.amount)||0),0);
        const dp2=rn2-Math.round(cp2)-oh2;const dpPct2=rn2>0?Math.round(dp2/rn2*100):0;
        const pClr=rev2===0?'var(--text2)':dpPct2>=80?'var(--green)':dpPct2>=75?'var(--yellow)':'var(--red)';
        const hrs2=(proj.timeEntries||[]).reduce((s,te)=>s+(Number(te.hours)||0),0);
        return <tr key={proj.id} className="clickable" onClick={()=>goProject(proj.id)}>
          <td style={{color:'var(--accent2)',fontWeight:600}}>{proj.code}</td>
          <td>{proj.name}</td>
          <td>{SB(proj.status)}</td>
          <td style={{fontWeight:600}}>{rev2>0?fmt(rev2)+' ₽':'—'}</td>
          <td style={{fontWeight:600,color:dp2>=0?'var(--green)':'var(--red)'}}>{rev2>0?fmt(dp2)+' ₽':'—'}</td>
          <td><span className="pnl-dot" style={{background:pClr}}></span><span style={{fontSize:10,color:pClr,fontWeight:600}}>{rev2>0?dpPct2+'%':'—'}</span></td>
          <td style={{color:'var(--text2)'}}>{hrs2>0?hrs2.toFixed(1)+'ч':'—'}</td>
        </tr>;
      })}</tbody></table>
    </div>
    {(()=>{
      const EXCL_STAGES=['won_past','re_won_past'];
      const clientDeals=(store.data.crm_deals||[]).filter(d=>d.client_id===sel.id&&!EXCL_STAGES.includes(d.stage));
      const stLabel=(sid)=>{const s=([{id:'nakopan_6',l:'Накопан 6'},{id:'nakopan_bm',l:'Накопан БМ'},{id:'mql_call',l:'MQL созвон'},{id:'sql_call',l:'SQL созвон'},{id:'sql_warmup',l:'SQL прогрев'},{id:'writing_kp',l:'Пишем КП'},{id:'kp_sent',l:'КП выслано'},{id:'defense_discuss',l:'Защита обсужд.'},{id:'defense_set',l:'Защита пост.'},{id:'push',l:'Дожим'},{id:'send_materials',l:'Дослать мат.'},{id:'come_back',l:'Вернуться'},{id:'no_answer',l:'Нет ответа'},{id:'verbal_yes',l:'Устное да'},{id:'contract_done',l:'Договор'},{id:'invoices_sent',l:'Счета'},{id:'won',l:'Выиграно'},{id:'twww_call',l:'TWWW'},{id:'lost',l:'Проиграно'},{id:'refresh_won',l:'Refresh выигр.'},{id:'re_need',l:'РИ потребн.'},{id:'re_kp',l:'РИ КП'},{id:'re_defense',l:'РИ защита'},{id:'re_invoice',l:'РИ счёт'},{id:'re_won',l:'РИ выигр.'},{id:'re_lost',l:'РИ проигр.'}]).find(x=>x.id===sid);return s?s.l:sid||'—';};
      const dealTotal=clientDeals.reduce((s,d)=>s+(Number(d.amount)||0),0);
      return <div className="card" style={{marginTop:16}}>
        <div className="card-title">Открытые сделки ({clientDeals.length}){dealTotal>0?' • '+fmt(dealTotal)+' ₽':''}</div>
        {clientDeals.length===0?<div style={{color:'var(--text2)',fontSize:12,padding:8}}>Нет открытых сделок</div>:
        <table><thead><tr><th>Сделка</th><th>Этап</th><th>Контракт</th><th>1 оплата</th><th>Ответственный</th><th>Приоритет</th></tr></thead>
        <tbody>{clientDeals.map(d=><tr key={d.id} className="clickable" onClick={()=>{/* navigate to CRM */}}>
          <td style={{fontWeight:600}}>{d.name}</td>
          <td><span style={{fontSize:10,padding:'1px 6px',borderRadius:6,background:'var(--bg3)'}}>{stLabel(d.stage)}</span></td>
          <td style={{fontWeight:600,color:'var(--accent)'}}>{d.amount>0?fmt(d.amount)+' ₽':'—'}</td>
          <td style={{color:'var(--text2)'}}>{d.first_payment>0?fmt(d.first_payment)+' ₽':'—'}</td>
          <td style={{fontSize:11,color:'var(--text2)'}}>{d.responsible||'—'}</td>
          <td><span style={{fontSize:10,color:d.priority==='Высокий'?'var(--red)':d.priority==='Средний'?'var(--amber)':'var(--text2)'}}>{d.priority||'—'}</span></td>
        </tr>)}</tbody></table>}
      </div>;
    })()}
    {editClient&&<EditClientModal client={editClient} store={store} onClose={()=>setEditClient(null)} onGoProject={goProject?(id)=>{setEditClient(null);goProject(id);}:null}/>}
    {showNewProj&&<NewProjectModal store={store} onClose={()=>setShowNewProj(false)} initialClientId={sel.id}/>}
  </div>;
  const countries=[...new Set(clientAgg.map(c=>c.country).filter(Boolean))].sort();
  const industries=[...new Set(clientAgg.map(c=>c.industry).filter(Boolean))].sort();
  const segments=[...new Set(clientAgg.map(c=>c.segment).filter(Boolean))].sort();
  const allDeals=(store.data.crm_deals||[]);
  const getOpenDeals=(cid)=>allDeals.filter(d=>d.client_id===cid&&!['won_past','re_won_past'].includes(d.stage));
  const agencyCount=clientAgg.filter(c=>c.isAgency).length;
  const strelaCount=clientAgg.filter(c=>c.isStrela).length;
  const tabFiltered=clientAgg.filter(c=>clientTab==='agency'?c.isAgency:clientTab==='strela'?c.isStrela:true);
  const filtered=tabFiltered.filter(c=>{
    if(clSearch&&!c.name.toLowerCase().includes(clSearch.toLowerCase())&&!(c.contact_person||'').toLowerCase().includes(clSearch.toLowerCase())&&!(c.inn||'').includes(clSearch))return false;
    if(clCountry&&c.country!==clCountry)return false;
    if(clIndustry&&c.industry!==clIndustry)return false;
    if(clSegment&&c.segment!==clSegment)return false;
    if(clHealth&&c.health!==clHealth)return false;
    if(clDeals==='with'&&getOpenDeals(c.id).length===0)return false;
    if(clDeals==='without'&&getOpenDeals(c.id).length>0)return false;
    return true;
  }).sort((a,b)=>{
    if(clSort==='name')return a.name.localeCompare(b.name);
    if(clSort==='revenue')return b.totalRev-a.totalRev;
    if(clSort==='profit')return b.dirtyPct-a.dirtyPct;
    if(clSort==='projects')return b.projs.length-a.projs.length;
    if(clSort==='deals')return getOpenDeals(b.id).length-getOpenDeals(a.id).length;
    return 0;
  });
  const hasFilters=clSearch||clCountry||clIndustry||clHealth||clDeals||clSegment;
  return <div>
    <h2 className="page-title">Клиенты</h2>
    <p style={{color:'var(--text2)',marginBottom:12,fontSize:13}}>Финансовая аналитика по клиентам • {clientAgg.length} клиентов • {clientAgg.reduce((s,c)=>s+c.projs.length,0)} проектов</p>
    {/* Client type tabs */}
    <div style={{display:'flex',gap:4,marginBottom:12}}>
      <button className={clientTab==='agency'?'tab active':'tab'} onClick={()=>setClientTab('agency')} style={{fontSize:11,padding:'5px 14px',borderRadius:6,cursor:'pointer',border:clientTab==='agency'?'1px solid var(--accent)':'1px solid var(--border)',background:clientTab==='agency'?'var(--accent)':'var(--bg2)',color:clientTab==='agency'?'#fff':'var(--text)'}}>Агентства ({agencyCount})</button>
      <button className={clientTab==='strela'?'tab active':'tab'} onClick={()=>setClientTab('strela')} style={{fontSize:11,padding:'5px 14px',borderRadius:6,cursor:'pointer',border:clientTab==='strela'?'1px solid var(--amber)':'1px solid var(--border)',background:clientTab==='strela'?'var(--amber)':'var(--bg2)',color:clientTab==='strela'?'#000':'var(--text)'}}>Стрела ({strelaCount})</button>
    </div>
    <div style={{display:'flex',gap:8,marginBottom:14,flexWrap:'wrap',alignItems:'center'}}>
      <input placeholder="Поиск: название, контакт, ИНН..." value={clSearch} onChange={e=>setClSearch(e.target.value)} style={{width:220,fontSize:11,padding:'5px 10px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg1)'}}/>
      <select value={clCountry} onChange={e=>setClCountry(e.target.value)} style={{fontSize:11,padding:'5px 6px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg1)'}}>
        <option value="">Все страны</option>{countries.map(c=><option key={c} value={c}>{c}</option>)}
      </select>
      <select value={clIndustry} onChange={e=>setClIndustry(e.target.value)} style={{fontSize:11,padding:'5px 6px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg1)'}}>
        <option value="">Все отрасли</option>{industries.map(i=><option key={i} value={i}>{i}</option>)}
      </select>
      {segments.length>0&&<select value={clSegment} onChange={e=>setClSegment(e.target.value)} style={{fontSize:11,padding:'5px 6px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg1)'}}>
        <option value="">Все сегменты</option>{segments.map(s=><option key={s} value={s}>{s}</option>)}
      </select>}
      <select value={clHealth} onChange={e=>setClHealth(e.target.value)} style={{fontSize:11,padding:'5px 6px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg1)'}}>
        <option value="">Все P&L</option><option value="green">✅ Здоровые (≥80%)</option><option value="yellow">⚠️ Под наблюдением</option><option value="red">🔴 Проблемные (&lt;75%)</option><option value="gray">➖ Нет данных</option>
      </select>
      <select value={clDeals} onChange={e=>setClDeals(e.target.value)} style={{fontSize:11,padding:'5px 6px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg1)'}}>
        <option value="">Все (сделки)</option><option value="with">С открытыми сделками</option><option value="without">Без сделок</option>
      </select>
      <select value={clSort} onChange={e=>setClSort(e.target.value)} style={{fontSize:11,padding:'5px 6px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg1)'}}>
        <option value="revenue">Сорт: по выручке ↓</option><option value="name">Сорт: по имени</option><option value="profit">Сорт: по рент. ↓</option><option value="projects">Сорт: по проектам ↓</option><option value="deals">Сорт: по сделкам ↓</option>
      </select>
      {hasFilters&&<button className="btn btn-sm" style={{fontSize:10}} onClick={()=>{setClSearch('');setClCountry('');setClIndustry('');setClHealth('');setClDeals('');setClSegment('');}}>✕ Сбросить</button>}
    </div>
    <div style={{fontSize:11,color:'var(--text2)',marginBottom:10}}>Показано: <b>{filtered.length}</b> из {tabFiltered.length}</div>
    {filtered.map(c=>{
      const od=getOpenDeals(c.id);const odSum=od.reduce((s,d)=>s+(Number(d.amount)||0),0);
      return <div key={c.id} className="client-view-card" onClick={()=>setSelClient(c.id)}>
      <div className="cv-header">
        <div style={{display:'flex',alignItems:'center',gap:8}}><span className="cv-name">{c.name}</span>{c.country&&<span style={{fontSize:10,padding:'1px 6px',background:'var(--accent)',color:'#fff',borderRadius:6}}>{c.country}</span>}{c.industry&&<span className="cv-industry">{c.industry}</span>}{c.segment&&<span style={{fontSize:9,padding:'1px 5px',background:'var(--bg3)',borderRadius:4,color:'var(--text2)'}}>{c.segment}</span>}</div>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <span style={{fontSize:12,color:'var(--text2)'}}>{c.projs.length} проект{c.projs.length===1?'':'ов'}</span>
          {od.length>0&&<span style={{fontSize:10,padding:'1px 8px',background:'var(--amber)',color:'#000',borderRadius:8,fontWeight:600}}>{od.length} сдел{od.length===1?'ка':od.length<5?'ки':'ок'}{odSum>0?' • '+fmt(odSum):''}</span>}
          <span className={'pnl-health '+c.health}>{c.health==='green'?'✅':c.health==='yellow'?'\u26A0\uFE0F':c.health==='red'?'\uD83D\uDD34':'➖'}{c.health!=='gray'?' '+c.dirtyPct+'%':''}</span>
        </div>
      </div>
      {c.totalRev>0&&<div className="cv-fin-grid">
        <div className="cv-fin-item"><div className="cv-lbl">Контракты</div><div className="cv-val" style={{color:'var(--green)'}}>{fmt(c.totalRev)}</div></div>
        <div className="cv-fin-item"><div className="cv-lbl">Грязная</div><div className="cv-val" style={{color:c.dirtyProfit>=0?'var(--green)':'var(--red)'}}>{fmt(c.dirtyProfit)}</div></div>
        <div className="cv-fin-item"><div className="cv-lbl">Чистая</div><div className="cv-val" style={{color:c.cleanProfit>=0?'var(--green)':'var(--red)'}}>{fmt(c.cleanProfit)}</div></div>
        <div className="cv-fin-item"><div className="cv-lbl">Часов</div><div className="cv-val" style={{color:'var(--accent)'}}>{c.totalHours>0?c.totalHours.toFixed(0):'—'}</div></div>
      </div>}
      {c.projs.length>0&&<div className="cv-proj-list">{c.projs.slice(0,5).map(pr=><div key={pr.id} className="cv-proj-row"><span>{pr.code} {pr.name}</span>{SB(pr.status)}</div>)}{c.projs.length>5&&<div style={{fontSize:10,color:'var(--text2)',marginTop:4}}>+ ещё {c.projs.length-5}</div>}</div>}
      {clientTab==='strela'&&c.isStrela&&<div style={{marginTop:6,padding:'6px 10px',background:'rgba(234,179,8,.08)',borderRadius:6,fontSize:10}}>
        <span style={{fontWeight:600,color:'var(--amber)'}}>Стрела:</span> {c.strelaDealCount} сдел{c.strelaDealCount===1?'ка':c.strelaDealCount<5?'ки':'ок'} • {fmt(c.strelaSum)}
        {c.strelaProducts.length>0&&<span style={{color:'var(--text2)',marginLeft:6}}>({c.strelaProducts.join(', ')})</span>}
      </div>}
    </div>;})}
    {filtered.length===0&&<div style={{textAlign:'center',padding:30,color:'var(--text2)'}}>Нет клиентов по заданным фильтрам</div>}
  </div>;
}

function FinanceMachineView({store,goProject}){
  /* === ALL HOOKS FIRST (unconditional) === */
  const [fmTab,_setFmTab]=useState(()=>localStorage.getItem('pp_fmTab')||'pnl');
  const setFmTab=(t)=>{localStorage.setItem('pp_fmTab',t);_setFmTab(t);};
  const [fmDrill,setFmDrill]=useState(null);const [fmNewPay,setFmNewPay]=useState(null);const [fmNewProj,setFmNewProj]=useState(false);const fmCreRef=useRef(null);const [fmFilter,setFmFilter]=useState({wg:'',ptype:''});
  const [fmLabels,setFmLabels]=useState(()=>{try{return JSON.parse(localStorage.getItem('pp_fm_row_labels')||'{}')}catch(e){return {}}});
  const [fmEditLabel,setFmEditLabel]=useState(null);
  const [fmEditCell,setFmEditCell]=useState(null); /* {key,monthIdx,value} for inline editing */
  const [showFinExp,setShowFinExp]=useState(false); /* toggle: Расходы от фин. деятельности */
  const [showFinInc,setShowFinInc]=useState(false); /* toggle: Доход от фин. деятельности */
  const [showICF,setShowICF]=useState(false); /* toggle: Инвестиционный CF */
  const [showICFProj,setShowICFProj]=useState(false); /* toggle: Расходы инвест. проектов (по проектам) */
  const [investProjTab,setInvestProjTab]=useState('Стрела'); /* подвкладка инвест проекта */
  const [ohChecked,setOhChecked]=useState(()=>{try{return JSON.parse(localStorage.getItem('pp_oh_checked')||'[]')}catch(e){return []}});
  const [openCompRg,setOpenCompRg]=useState(null);
  const [ohCompChecked,setOhCompChecked]=useState(()=>{try{return JSON.parse(localStorage.getItem('pp_oh_comp_checked')||'[]')}catch(e){return []}});
  const toggleOhCompCheck=(key)=>{setOhCompChecked(prev=>{const next=prev.includes(key)?prev.filter(k=>k!==key):[...prev,key];localStorage.setItem('pp_oh_comp_checked',JSON.stringify(next));return next;});};
  const [ohCompOpen,setOhCompOpen]=useState(null);
  const [ohRegEdit,setOhRegEdit]=useState(null); /* editing entry or new */
  const [ohRegFilter,setOhRegFilter]=useState({month:'',rg:'',scope:'',verified:'',source:''});
  const [kbDrillCat,setKbDrillCat]=useState(null);
  const [hrDrillCat,setHrDrillCat]=useState(null);
  const [hrForm,setHrForm]=useState({name:'',cf_type:'OCF',amount_plan:''});
  const [fkWarnings,setFkWarnings]=useState(new Map());
  const [ohDiagReport,setOhDiagReport]=useState(null);
  /* Автозапуск FK double-check при открытии вкладки oh_registry */
  useEffect(()=>{if(fmTab==='oh_registry'){const w=store.runFkDoubleCheck();if(w)setFkWarnings(new Map(w));}},[fmTab]);
  const toggleOhCheck=(key)=>{setOhChecked(prev=>{const next=prev.includes(key)?prev.filter(k=>k!==key):[...prev,key];localStorage.setItem('pp_oh_checked',JSON.stringify(next));return next;});};
  const saveFmCell=(cfType,monthPfx,val)=>{
    const _kb=store.data.kb_budget||[];
    const existing=_kb.find(x=>x.cf_type===cfType&&(x.month||'')===monthPfx&&!x.person_id);
    if(existing){store.updateKbBudgetItem(existing.id,{amount_plan:Number(val)||0});}
    else if(Number(val)>0){store.addKbBudgetItem({name:cfType==='OFFICE'?'Аренда офиса':cfType==='BANK_FEES'?'Комиссии банков':cfType==='EXTRA_TAX'?'Дополнительные налоги':cfType==='FX_OPS'?'Валютные операции':cfType==='DEP_INCOME'?'Доход от депозитов':cfType==='TAX_OPT'?'Оптимизация налогов':cfType==='ICF_PROJ_EXP'?'Расходы инвест. проектов':cfType==='ICF_PROJ_INC'?'Возмещение от инвест. проектов':'АХО',amount_plan:Number(val)||0,month:monthPfx,cf_type:cfType});}
  };
  const [kbForm,setKbForm]=useState(()=>{const n=new Date();return{name:'',amount_plan:'',amount_fact:'',month:n.getFullYear()+'-'+(n.getMonth()+1<10?'0':'')+(n.getMonth()+1),cf_type:'OCF',notes:''};});
  const [kbEditId,setKbEditId]=useState(null);
  /* === Hoisted hooks from conditional IIFEs (React rules of hooks) === */
  const [curStream,setCurStream]=useState(1);
  const [groupByUser,setGroupByUser]=useState(false);
  const _icfDealDef={date:'',user_name:'',company:'',company_id:'',product:'',cost:'',commission:'',received:'',tax_rate:6,tax_amount:0,earned:0,pay_system:'',seller:'',is_forecast:false};
  const [nf,setNf]=useState({..._icfDealDef});
  const [sellerCustom,setSellerCustom]=useState(false);
  const [editBal,setEditBal]=useState(null);
  const [showDetail,setShowDetail]=useState(false);

  /* === DATA & COMPUTATION (wrapped in try-catch) === */
  try {
  const projects=store.data.projects.filter(p=>p.status!=='DRAFT');
  const persons=store.data.persons;
  const pnls=projects.map(p=>({...p,pnl:calcPnlHealth(p,persons)}));
  const totRevNet=pnls.reduce((s,p)=>s+p.pnl.revNet,0);
  const totCostProd=pnls.reduce((s,p)=>s+p.pnl.costProd,0);
  const totCostC5=pnls.reduce((s,p)=>s+p.pnl.costC5,0);
  const totOH=pnls.reduce((s,p)=>s+p.pnl.ohTotal,0);
  const totGross=totRevNet-totOH;
  const totDirty=totRevNet-totCostProd-totOH;
  const totClean=totDirty-totCostC5;
  const dirtyPct=totRevNet>0?Math.round(totDirty/totRevNet*100):0;
  const cleanPct=totRevNet>0?Math.round(totClean/totRevNet*100):0;

  /* FOT by grade */
  const gradeMap={};
  persons.filter(p=>p.salary_monthly>0).forEach(p=>{
    const g=p.grade||'Без грейда';
    if(!gradeMap[g])gradeMap[g]={count:0,fot:0};
    gradeMap[g].count++;gradeMap[g].fot+=Number(p.salary_monthly)||0;
  });
  const totalFOT=Object.values(gradeMap).reduce((s,g)=>s+g.fot,0);

  const saveFmLabel=(k,v)=>{const nl={...fmLabels,[k]:v};setFmLabels(nl);localStorage.setItem('pp_fm_row_labels',JSON.stringify(nl));};
  /* === Monthly aggregation for quarterly view === */
  const MONTHS=['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
  const yr=new Date().getFullYear();
  const MFULL=MONTHS.map((_,i)=>yr+'-'+(i+1<10?'0':'')+(i+1));
  const monthlyData=Array.from({length:12},(_,mi)=>{
    const mKey=(mi+1<10?'0':'')+(mi+1);const mPfx=yr+'-'+mKey;
    /* payments */
    let incPlan=0,incFactCF=0,incFactPNL=0;
    projects.filter(p=>p.project_type!=='ФК').forEach(p=>{(p.payments||[]).forEach(pm=>{
      if(pm.prior_year)return;
      /* Plan CF: all payments by plan date (any status) */
      if((pm.expected_week_monday||pm.planned_date||pm.payment_date||'').startsWith(mPfx)){
        incPlan+=(Number(pm.amount)||0);
      }
      /* Fact CF: only PAID by actual_date */
      if(pm.status==='PAID'&&(pm.actual_date||'').startsWith(mPfx)){
        incFactCF+=(Number(pm.amount)||0);
      }
      /* Fact PNL: ACCRUED by accrued_date + PAID by actual_date */
      if(pm.status==='ACCRUED'&&(pm.accrued_date||'').startsWith(mPfx)){
        incFactPNL+=(Number(pm.amount)||0);
      }
      if(pm.status==='PAID'&&(pm.actual_date||'').startsWith(mPfx)){
        incFactPNL+=(Number(pm.amount)||0);
      }
    });});
    /* costs */
    let costProd=0,costC5=0;
    projects.forEach(p=>{(p.timeEntries||[]).forEach(te=>{
      if(!(te.date||'').startsWith(mPfx))return;
      const per=persons.find(x=>x.id===te.person_id);
      if(!per||!per.salary_monthly)return;
      const wts=per.weekly_timesheets||[];
      const oh=wts.length>0?wts.reduce((s,w)=>s+(w.open_hours||0),0)/wts.length:40;
      const rate=oh>0?getPersonSalaryAtDate(per,te.date)/(oh*4.33):0;
      const c=rate*(Number(te.hours)||0);
      if(per.grade==='C5')costC5+=c;else costProd+=c;
    });});
    /* net revenue plan & fact CF */
    let netRevPlan=0,netRevFactCF=0,netRevFactPNL=0;
    projects.filter(p=>p.project_type!=='ФК').forEach(p=>{const tr=_effTax(p.tax_rate);(p.payments||[]).forEach(pm=>{
      if(pm.prior_year)return;const amt=Number(pm.amount)||0;
      if((pm.expected_week_monday||pm.planned_date||pm.payment_date||'').startsWith(mPfx))netRevPlan+=Math.round(amt*(1-tr/100));
      if(pm.status==='PAID'&&(pm.actual_date||'').startsWith(mPfx))netRevFactCF+=Math.round(amt*(1-tr/100));
      if(pm.status==='ACCRUED'&&(pm.accrued_date||'').startsWith(mPfx))netRevFactPNL+=Math.round(amt*(1-tr/100));
      if(pm.status==='PAID'&&(pm.actual_date||'').startsWith(mPfx))netRevFactPNL+=Math.round(amt*(1-tr/100));
    });});
    /* overheads (non-FK, by month) */
    let ohPlan=0;
    projects.filter(p=>p.project_type!=='ФК').forEach(p=>{(p.overheads||[]).forEach(x=>{
      if((x.date||'').startsWith(mPfx))ohPlan+=(Number(x.amount)||0);
    });});
    /* FK income & overheads */
    let fkIncPlan=0,fkIncFactCF=0,fkIncFactPNL=0,fkOh=0,fkNetRev=0;
    projects.filter(pp=>pp.project_type==='ФК').forEach(pp=>{
      const fkTr=_effTax(pp.tax_rate);
      (pp.payments||[]).forEach(pm=>{
        if(pm.prior_year)return;const amt=Number(pm.amount)||0;
        if((pm.expected_week_monday||pm.planned_date||pm.payment_date||'').startsWith(mPfx)){fkIncPlan+=amt;}
        if(pm.status==='PAID'&&(pm.actual_date||'').startsWith(mPfx)){fkIncFactCF+=amt;}
        if(pm.status==='ACCRUED'&&(pm.accrued_date||'').startsWith(mPfx)){fkIncFactPNL+=amt;fkNetRev+=Math.round(amt*(1-fkTr/100));}
        if(pm.status==='PAID'&&(pm.actual_date||'').startsWith(mPfx)){fkIncFactPNL+=amt;fkNetRev+=Math.round(amt*(1-fkTr/100));}
      });
      (pp.overheads||[]).forEach(x=>{if((x.date||'').startsWith(mPfx))fkOh+=(Number(x.amount)||0);});
    });
    const fkProfit=Math.round(fkNetRev)-Math.round(fkOh);
    /* profit computed after fot below */
    let fot=0;
    persons.filter(p=>p.grade!=='C5'&&!p.is_investment_employee&&getPersonDepts(p).includes('Производство')&&(p.salary_monthly||0)>0).forEach(p=>{
      fot+=getPersonMonthSalary(p,mPfx);
    });
    fot=Math.round(fot);
    const _kbBudget=store.data.kb_budget||[];
    const _kbSalOcf=_kbBudget.filter(x=>x.cf_type==='SALARY_OCF'&&(x.month||'')===mPfx);
    const _kbSalIcf=_kbBudget.filter(x=>x.cf_type==='SALARY_ICF'&&(x.month||'')===mPfx);
    let salaryKB=0;persons.filter(p=>!p.is_investment_employee&&getPersonDepts(p).includes('Продажи и Маркетинг')&&(p.salary_monthly||0)>0).forEach(p=>{const _ov=_kbSalOcf.find(x=>x.person_id===p.id);salaryKB+=(_ov&&Number(_ov.amount_fact)>0)?Number(_ov.amount_fact):getPersonMonthSalary(p,mPfx);});salaryKB=Math.round(salaryKB);
    let salaryHR=0;persons.filter(p=>getPersonDepts(p).includes('HR')&&(p.salary_monthly||0)>0).forEach(p=>{salaryHR+=getPersonMonthSalary(p,mPfx);});
    /* Корректировки ЗП HR (разовые доплаты, врем. совмещение и т.д.) */
    const _hrAdj=_kbBudget.filter(x=>x.cf_type==='SALARY_HR_ADJ'&&(x.month||'')===mPfx);
    _hrAdj.forEach(a=>{salaryHR+=Number(a.amount_fact||a.amount_plan||0);});
    salaryHR=Math.round(salaryHR);
    /* Зарплата бухгалтерии: сотрудники «Финансы» с грейдом ниже C5 */
    let salaryAcct=0;persons.filter(p=>getPersonDepts(p).includes('Финансы')&&p.grade!=='C5'&&(p.salary_monthly||0)>0).forEach(p=>{salaryAcct+=getPersonMonthSalary(p,mPfx);});salaryAcct=Math.round(salaryAcct);
    /*
     * МАРШРУТ ДАННЫХ АХО/КБ/HR/ОФИС (УТВЕРЖДЕНО):
     * Факт АХО, расходов КБ, HR и аренды берётся из overhead_registry.
     * Штатный маршрут: Реестр «Общие накладные» → Все проекты Кв (авто).
     */
    const _ohReg=store.data.overhead_registry||[];
    const _ohComp=_ohReg.filter(e=>e.scope==='company'&&(e.date||'').startsWith(mPfx));
    let expKB=Math.round(_ohComp.filter(e=>e.rg==='КБ').reduce((s,e)=>s+Number(e.amount||0),0));
    let aho=Math.round(_ohComp.filter(e=>e.rg==='АХО').reduce((s,e)=>s+Number(e.amount||0),0));
    /* Аренда офиса: фиксированная сумма из kb_budget cf_type='OFFICE' (по умолчанию 1200000) */
    const _rentOvr=_kbBudget.find(x=>x.cf_type==='OFFICE'&&(x.month||'')===mPfx&&!x.person_id);
    let officeRent=_rentOvr&&Number(_rentOvr.amount_plan)>0?Number(_rentOvr.amount_plan):1200000;
    officeRent=Math.round(officeRent);
    /* АХО из реестра = всё АХО (аренда уже фиксирована отдельно, не вычитаем) */
    let expHR=Math.round(_ohComp.filter(e=>e.rg==='HR').reduce((s,e)=>s+Number(e.amount||0),0));
    /* Расходы PP из реестра накладных (без currency_ops — те учтены в строке «Валютные операции») */
    let expPP=Math.round(_ohReg.filter(e=>e.rg==='PP'&&!e.prior_year&&!e.currency_ops&&(e.date||'').startsWith(mPfx)).reduce((s,e)=>s+Number(e.amount||0),0));
    /* Валютные операции — ручной ввод через kb_budget cf_type=FX_OPS */
    const _fxOvr=_kbBudget.find(x=>x.cf_type==='FX_OPS'&&(x.month||'')===mPfx&&!x.person_id);
    let fxOps=_fxOvr&&Number(_fxOvr.amount_plan)>0?Number(_fxOvr.amount_plan):0;
    fxOps=Math.round(fxOps);
    const sga=officeRent+aho+expKB+expHR+salaryKB+salaryHR+salaryAcct+expPP+fxOps;
    /* Расходы от финансовой деятельности — ручной ввод */
    const _bfOvr=_kbBudget.find(x=>x.cf_type==='BANK_FEES'&&(x.month||'')===mPfx&&!x.person_id);
    let bankFees=_bfOvr?Number(_bfOvr.amount_plan)||0:0;bankFees=Math.round(bankFees);
    const _etOvr=_kbBudget.find(x=>x.cf_type==='EXTRA_TAX'&&(x.month||'')===mPfx&&!x.person_id);
    let extraTax=_etOvr?Number(_etOvr.amount_plan)||0:0;extraTax=Math.round(extraTax);
    const finExp=bankFees+extraTax;
    const _diOvr=_kbBudget.find(x=>x.cf_type==='DEP_INCOME'&&(x.month||'')===mPfx&&!x.person_id);
    let depIncome=_diOvr?Number(_diOvr.amount_plan)||0:0;depIncome=Math.round(depIncome);
    const _toOvr=_kbBudget.find(x=>x.cf_type==='TAX_OPT'&&(x.month||'')===mPfx&&!x.person_id);
    let taxOpt=_toOvr?Number(_toOvr.amount_plan)||0:0;taxOpt=Math.round(taxOpt);
    const finInc=depIncome+taxOpt;
    /* ICF — инвестиционный денежный поток */
    /* ЗП: инвест. сотрудники + стажёры (grade==='Стажёр', до перевода на C1+) */
    let icfSalary=0;
    persons.filter(p=>(!!p.is_investment_employee||p.grade==='Стажёр')&&(p.salary_monthly||0)>0).forEach(p=>{const _ov=_kbSalIcf.find(x=>x.person_id===p.id);icfSalary+=(_ov&&Number(_ov.amount_fact)>0)?Number(_ov.amount_fact):getPersonMonthSalary(p,mPfx);});
    /* Стажёры без salary_monthly — по стипендии */
    persons.filter(p=>p.grade==='Стажёр'&&!p.is_investment_employee&&!(p.salary_monthly>0)&&(p.intern_stipend||0)>0).forEach(p=>{if((p.hire_date||'')>mPfx+'-31'||((p.fire_date||'')&&p.fire_date<mPfx+'-01'))return;icfSalary+=Number(p.intern_stipend)||0;});
    icfSalary=Math.round(icfSalary);
    /* Накладные ICF из overhead_registry (без icf_project — те идут в icfProjExp) */
    let icfOh=Math.round(_ohComp.filter(e=>(e.cf_type||'')==='ICF'&&!e.icf_project).reduce((s,e)=>s+Number(e.amount||0),0));
    /* Расходы инвестпроектов: только overhead с icf_project (сумма подстрок) */
    const _icfOhProj=_ohComp.filter(e=>(e.cf_type||'')==='ICF'&&!!e.icf_project);
    let icfProjExp=Math.round(_icfOhProj.reduce((s,e)=>s+Number(e.amount||0),0));
    /* Суммы по каждому инвестпроекту */
    const ICF_PROJ_NAMES=['Стрела','Moove','Клуб ЧТД','Консорциум ЧТД','Скрытые Чемпионы','IAM'];
    const _icfByProj={};ICF_PROJ_NAMES.forEach(n=>{_icfByProj[n]=Math.round(_icfOhProj.filter(e=>e.icf_project===n).reduce((s,e)=>s+Number(e.amount||0),0));});
    const _icfPiOvr=_kbBudget.find(x=>x.cf_type==='ICF_PROJ_INC'&&(x.month||'')===mPfx&&!x.person_id);
    let icfProjInc=_icfPiOvr?Number(_icfPiOvr.amount_plan)||0:0;icfProjInc=Math.round(icfProjInc);
    /* 5% возмещение от Стрелы: 5% от заработанного комм.персоналу переносится как + в КВ */
    const _icfDealsMonth=(store.data.icf_deals||[]).filter(d=>!d.is_forecast&&(d.date||'').startsWith(mPfx));
    const _strEarn=_icfDealsMonth.filter(d=>d.icf_project==='Стрела').reduce((s,d)=>s+(Number(d.earned)||0),0);
    const icf5Total=Math.round(_strEarn*0.05);
    icfProjInc+=icf5Total;/* добавляем 5% комиссий как возмещение от инвестпроектов */
    /* ICF операции месяца (без баланса — баланс считается после цикла) */
    const icfOps=icfProjInc-icfSalary-icfOh-icfProjExp;
    const profit=Math.round(netRevFactPNL)-Math.round(ohPlan)-fot;
    const marginPct=netRevFactPNL>0?Math.round(profit/netRevFactPNL*100):0;
    return {month:MONTHS[mi],incPlan:Math.round(incPlan),incFact:Math.round(incFactCF),incFactPNL:Math.round(incFactPNL),incFactCF:Math.round(incFactCF),netRevPlan:Math.round(netRevPlan),netRevFactCF:Math.round(netRevFactCF),netRevFactPNL:Math.round(netRevFactPNL),costProd:Math.round(costProd),costC5:Math.round(costC5),ohPlan:Math.round(ohPlan),profit,marginPct,fot,fkIncPlan:Math.round(fkIncPlan),fkIncFactCF:Math.round(fkIncFactCF),fkIncFactPNL:Math.round(fkIncFactPNL),fkOh:Math.round(fkOh),fkNetRev:Math.round(fkNetRev),fkProfit,profitExP:profit-Math.round(costC5),totalProfit:profit+fkProfit,officeRent,aho,expKB,expHR,salaryKB,salaryHR,salaryAcct,expPP,fxOps,sga,bankFees,extraTax,finExp,depIncome,taxOpt,finInc,netProfit:profit+fkProfit-sga-finExp,fullProfit:profit+fkProfit-sga-finExp+finInc,icfSalary,icfOh,icfProjExp,icfProjInc,icfOps,icfByProj:_icfByProj,icf5Total};
  });
  const quarters=[0,1,2,3].map(qi=>{
    const ms=monthlyData.slice(qi*3,(qi+1)*3);
    return {label:(qi+1)+' кв.',incPlan:ms.reduce((s,m)=>s+m.incPlan,0),incFact:ms.reduce((s,m)=>s+m.incFact,0),incFactPNL:ms.reduce((s,m)=>s+(m.incFactPNL||0),0),incFactCF:ms.reduce((s,m)=>s+(m.incFactCF||0),0),netRevPlan:ms.reduce((s,m)=>s+m.netRevPlan,0),netRevFactCF:ms.reduce((s,m)=>s+m.netRevFactCF,0),netRevFactPNL:ms.reduce((s,m)=>s+m.netRevFactPNL,0),costProd:ms.reduce((s,m)=>s+m.costProd,0),costC5:ms.reduce((s,m)=>s+m.costC5,0),ohPlan:ms.reduce((s,m)=>s+m.ohPlan,0),profit:ms.reduce((s,m)=>s+m.profit,0),marginPct:0,fot:ms.reduce((s,m)=>s+m.fot,0),fkIncPlan:ms.reduce((s,m)=>s+(m.fkIncPlan||0),0),fkIncFactCF:ms.reduce((s,m)=>s+(m.fkIncFactCF||0),0),fkIncFactPNL:ms.reduce((s,m)=>s+(m.fkIncFactPNL||0),0),fkOh:ms.reduce((s,m)=>s+(m.fkOh||0),0),fkNetRev:ms.reduce((s,m)=>s+(m.fkNetRev||0),0),fkProfit:ms.reduce((s,m)=>s+(m.fkProfit||0),0),profitExP:ms.reduce((s,m)=>s+(m.profitExP||0),0),totalProfit:ms.reduce((s,m)=>s+(m.totalProfit||0),0),officeRent:ms.reduce((s,m)=>s+(m.officeRent||0),0),aho:ms.reduce((s,m)=>s+(m.aho||0),0),expKB:ms.reduce((s,m)=>s+(m.expKB||0),0),expHR:ms.reduce((s,m)=>s+(m.expHR||0),0),salaryKB:ms.reduce((s,m)=>s+(m.salaryKB||0),0),salaryHR:ms.reduce((s,m)=>s+(m.salaryHR||0),0),salaryAcct:ms.reduce((s,m)=>s+(m.salaryAcct||0),0),expPP:ms.reduce((s,m)=>s+(m.expPP||0),0),fxOps:ms.reduce((s,m)=>s+(m.fxOps||0),0),sga:ms.reduce((s,m)=>s+(m.sga||0),0),bankFees:ms.reduce((s,m)=>s+(m.bankFees||0),0),extraTax:ms.reduce((s,m)=>s+(m.extraTax||0),0),finExp:ms.reduce((s,m)=>s+(m.finExp||0),0),depIncome:ms.reduce((s,m)=>s+(m.depIncome||0),0),taxOpt:ms.reduce((s,m)=>s+(m.taxOpt||0),0),finInc:ms.reduce((s,m)=>s+(m.finInc||0),0),netProfit:ms.reduce((s,m)=>s+(m.netProfit||0),0),fullProfit:ms.reduce((s,m)=>s+(m.fullProfit||0),0),icfSalary:ms.reduce((s,m)=>s+(m.icfSalary||0),0),icfOh:ms.reduce((s,m)=>s+(m.icfOh||0),0),icfProjExp:ms.reduce((s,m)=>s+(m.icfProjExp||0),0),icfProjInc:ms.reduce((s,m)=>s+(m.icfProjInc||0),0),icfOps:0,icfNet:0,icfBalanceOpen:0,icfBalanceClose:0,icfByProj:(()=>{const r={};['Стрела','Moove','Клуб ЧТД','Консорциум ЧТД','Скрытые Чемпионы','IAM'].forEach(n=>{r[n]=ms.reduce((s,m)=>s+((m.icfByProj||{})[n]||0),0);});return r;})(),icf5Total:ms.reduce((s,m)=>s+(m.icf5Total||0),0)};
  });
  quarters.forEach(q=>{q.marginPct=q.netRevFactPNL>0?Math.round(q.profit/q.netRevFactPNL*100):0;});

  const yrTotal={incPlan:monthlyData.reduce((s,m)=>s+m.incPlan,0),incFact:monthlyData.reduce((s,m)=>s+m.incFact,0),incFactPNL:monthlyData.reduce((s,m)=>s+(m.incFactPNL||0),0),incFactCF:monthlyData.reduce((s,m)=>s+(m.incFactCF||0),0),netRevPlan:monthlyData.reduce((s,m)=>s+m.netRevPlan,0),netRevFactCF:monthlyData.reduce((s,m)=>s+m.netRevFactCF,0),netRevFactPNL:monthlyData.reduce((s,m)=>s+m.netRevFactPNL,0),costProd:monthlyData.reduce((s,m)=>s+m.costProd,0),costC5:monthlyData.reduce((s,m)=>s+m.costC5,0),ohPlan:monthlyData.reduce((s,m)=>s+m.ohPlan,0),profit:monthlyData.reduce((s,m)=>s+m.profit,0),fot:monthlyData.reduce((s,m)=>s+m.fot,0),fkIncPlan:monthlyData.reduce((s,m)=>s+(m.fkIncPlan||0),0),fkIncFactCF:monthlyData.reduce((s,m)=>s+(m.fkIncFactCF||0),0),fkIncFactPNL:monthlyData.reduce((s,m)=>s+(m.fkIncFactPNL||0),0),fkOh:monthlyData.reduce((s,m)=>s+(m.fkOh||0),0),fkNetRev:monthlyData.reduce((s,m)=>s+(m.fkNetRev||0),0),fkProfit:monthlyData.reduce((s,m)=>s+(m.fkProfit||0),0),profitExP:monthlyData.reduce((s,m)=>s+(m.profitExP||0),0),totalProfit:monthlyData.reduce((s,m)=>s+(m.totalProfit||0),0),officeRent:monthlyData.reduce((s,m)=>s+(m.officeRent||0),0),aho:monthlyData.reduce((s,m)=>s+(m.aho||0),0),expKB:monthlyData.reduce((s,m)=>s+(m.expKB||0),0),expHR:monthlyData.reduce((s,m)=>s+(m.expHR||0),0),salaryKB:monthlyData.reduce((s,m)=>s+(m.salaryKB||0),0),salaryHR:monthlyData.reduce((s,m)=>s+(m.salaryHR||0),0),salaryAcct:monthlyData.reduce((s,m)=>s+(m.salaryAcct||0),0),expPP:monthlyData.reduce((s,m)=>s+(m.expPP||0),0),fxOps:monthlyData.reduce((s,m)=>s+(m.fxOps||0),0),sga:monthlyData.reduce((s,m)=>s+(m.sga||0),0),bankFees:monthlyData.reduce((s,m)=>s+(m.bankFees||0),0),extraTax:monthlyData.reduce((s,m)=>s+(m.extraTax||0),0),finExp:monthlyData.reduce((s,m)=>s+(m.finExp||0),0),depIncome:monthlyData.reduce((s,m)=>s+(m.depIncome||0),0),taxOpt:monthlyData.reduce((s,m)=>s+(m.taxOpt||0),0),finInc:monthlyData.reduce((s,m)=>s+(m.finInc||0),0),netProfit:monthlyData.reduce((s,m)=>s+(m.netProfit||0),0),fullProfit:monthlyData.reduce((s,m)=>s+(m.fullProfit||0),0),icfSalary:monthlyData.reduce((s,m)=>s+(m.icfSalary||0),0),icfOh:monthlyData.reduce((s,m)=>s+(m.icfOh||0),0),icfProjExp:monthlyData.reduce((s,m)=>s+(m.icfProjExp||0),0),icfProjInc:monthlyData.reduce((s,m)=>s+(m.icfProjInc||0),0),icfOps:monthlyData.reduce((s,m)=>s+(m.icfOps||0),0),icfNet:_icfRun,icfBalanceOpen:ICF_START,icfBalanceClose:_icfRun,icfByProj:(()=>{const r={};['Стрела','Moove','Клуб ЧТД','Консорциум ЧТД','Скрытые Чемпионы','IAM'].forEach(n=>{r[n]=monthlyData.reduce((s,m)=>s+((m.icfByProj||{})[n]||0),0);});return r;})()};
  yrTotal.marginPct=yrTotal.netRevFactPNL>0?Math.round(yrTotal.profit/yrTotal.netRevFactPNL*100):0;
  /* ICF — бегущий баланс; будущие месяцы не учитываются */
  const ICF_START=31266000;
  const _nowM=new Date();const _curMPfx=_nowM.getFullYear()+'-'+String(_nowM.getMonth()+1).padStart(2,'0');
  let _icfRun=ICF_START;
  monthlyData.forEach((m,i)=>{
    const mPfx=yr+'-'+String(i+1).padStart(2,'0');
    const isFuture=mPfx>_curMPfx;
    if(isFuture){m.icfSalary=0;m.icfOh=0;m.icfProjExp=0;m.icfProjInc=0;m.icfOps=0;}
    m.icfBalanceOpen=_icfRun;
    m.icfNet=isFuture?_icfRun:_icfRun+m.icfOps;
    if(!isFuture)_icfRun=_icfRun+m.icfOps;
    m.icfBalanceClose=_icfRun;
  });
  quarters.forEach((q,qi)=>{
    const ms=monthlyData.slice(qi*3,(qi+1)*3);
    q.icfBalanceOpen=ms[0].icfBalanceOpen;q.icfBalanceClose=ms[2].icfBalanceClose;
    q.icfNet=ms[2].icfBalanceClose;q.icfOps=ms.reduce((s,x)=>s+(x.icfOps||0),0);
  });

  const openDrill=(key,lbl,pfxs)=>{
    let items=[];
    const matchD=d=>pfxs.some(pfx=>(d||'').startsWith(pfx));
    const isFK=key.startsWith('fk');
    const filtP=isFK?projects.filter(p=>p.project_type==='ФК'):projects.filter(p=>p.project_type!=='ФК');
    if(key==='incPlan'||key==='fkIncPlan'){
      filtP.forEach(p=>{(p.payments||[]).forEach(pm=>{
        if(pm.prior_year)return;
        if(matchD(pm.expected_week_monday||pm.planned_date||pm.payment_date)){
          items.push({pid:p.id,pmId:pm.id,proj:p.code,name:p.name,desc:pm.description||'Транш #'+pm.tranche_number,tnum:pm.tranche_number||0,amt:Number(pm.amount)||0,extra:pm.status,pmStatus:pm.status});
        }
      });});
    }else if(key==='incFactCF'||key==='incFact'||key==='fkIncFactCF'){
      filtP.forEach(p=>{(p.payments||[]).forEach(pm=>{
        if(pm.prior_year)return;
        if(pm.status==='PAID'&&matchD(pm.actual_date)){
          items.push({pid:p.id,pmId:pm.id,proj:p.code,name:p.name,desc:pm.description||'Транш #'+pm.tranche_number,tnum:pm.tranche_number||0,amt:Number(pm.amount)||0,extra:'PAID',pmStatus:pm.status});
        }
      });});
    }else if(key==='incFactPNL'||key==='fkIncFactPNL'){
      filtP.forEach(p=>{(p.payments||[]).forEach(pm=>{
        if(pm.prior_year)return;
        if(pm.status==='ACCRUED'&&matchD(pm.accrued_date))items.push({pid:p.id,pmId:pm.id,proj:p.code,name:p.name,desc:pm.description||'#'+pm.tranche_number,tnum:pm.tranche_number||0,amt:Number(pm.amount)||0,extra:'ACCRUED',pmStatus:pm.status});
        if(pm.status==='PAID'&&matchD(pm.actual_date))items.push({pid:p.id,pmId:pm.id,proj:p.code,name:p.name,desc:pm.description||'#'+pm.tranche_number,tnum:pm.tranche_number||0,amt:Number(pm.amount)||0,extra:'PAID',pmStatus:pm.status});
      });});
    }else if(key==='netRevPlan'){
      filtP.forEach(p=>{const tr=_effTax(p.tax_rate);const trL=Number(p.tax_rate)||0;(p.payments||[]).forEach(pm=>{
        if(pm.prior_year)return;const d=pm.expected_week_monday||pm.planned_date||pm.payment_date;
        if(matchD(d)){const raw=Number(pm.amount)||0;items.push({pid:p.id,pmId:pm.id,proj:p.code,name:p.name,desc:pm.description||'#'+pm.tranche_number,tnum:pm.tranche_number||0,amt:Math.round(raw*(1-tr/100)),extra:'налог '+trL+'%',pmStatus:pm.status});}
      });});
    }else if(key==='fkNetRev'){
      filtP.forEach(p=>{const tr=_effTax(p.tax_rate);const trL=Number(p.tax_rate)||0;(p.payments||[]).forEach(pm=>{
        if(pm.prior_year)return;
        if(pm.status==='ACCRUED'&&matchD(pm.accrued_date)){const raw=Number(pm.amount)||0;items.push({pid:p.id,pmId:pm.id,proj:p.code,name:p.name,desc:pm.description||'#'+pm.tranche_number,tnum:pm.tranche_number||0,amt:Math.round(raw*(1-tr/100)),extra:'ACCRUED, налог '+trL+'%',pmStatus:pm.status});}
        if(pm.status==='PAID'&&matchD(pm.actual_date)){const raw=Number(pm.amount)||0;items.push({pid:p.id,pmId:pm.id,proj:p.code,name:p.name,desc:pm.description||'#'+pm.tranche_number,tnum:pm.tranche_number||0,amt:Math.round(raw*(1-tr/100)),extra:'PAID, налог '+trL+'%',pmStatus:pm.status});}
      });});
    }else if(key==='netRevFactCF'){
      filtP.forEach(p=>{const tr=_effTax(p.tax_rate);const trL=Number(p.tax_rate)||0;(p.payments||[]).forEach(pm=>{
        if(pm.prior_year)return;
        if(pm.status==='PAID'&&matchD(pm.actual_date)){const raw=Number(pm.amount)||0;items.push({pid:p.id,pmId:pm.id,proj:p.code,name:p.name,desc:pm.description||'#'+pm.tranche_number,tnum:pm.tranche_number||0,amt:Math.round(raw*(1-tr/100)),extra:'PAID, налог '+trL+'%',pmStatus:pm.status});}
      });});
    }else if(key==='netRevFactPNL'){
      filtP.forEach(p=>{const tr=_effTax(p.tax_rate);const trL=Number(p.tax_rate)||0;(p.payments||[]).forEach(pm=>{
        if(pm.prior_year)return;
        if(pm.status==='ACCRUED'&&matchD(pm.accrued_date)){const raw=Number(pm.amount)||0;items.push({pid:p.id,pmId:pm.id,proj:p.code,name:p.name,desc:pm.description||'#'+pm.tranche_number,tnum:pm.tranche_number||0,amt:Math.round(raw*(1-tr/100)),extra:'ACCRUED, налог '+trL+'%',pmStatus:pm.status});}
        if(pm.status==='PAID'&&matchD(pm.actual_date)){const raw=Number(pm.amount)||0;items.push({pid:p.id,pmId:pm.id,proj:p.code,name:p.name,desc:pm.description||'#'+pm.tranche_number,tnum:pm.tranche_number||0,amt:Math.round(raw*(1-tr/100)),extra:'PAID, налог '+trL+'%',pmStatus:pm.status});}
      });});
    }else if(key==='costProd'||key==='costC5'){
      projects.forEach(p=>{(p.timeEntries||[]).forEach(te=>{
        if(!matchD(te.date))return;const per=persons.find(x=>x.id===te.person_id);if(!per||!per.salary_monthly)return;
        const isC5=per.grade==='C5';if(key==='costProd'&&isC5)return;if(key==='costC5'&&!isC5)return;
        const wts=per.weekly_timesheets||[];const oh=wts.length>0?wts.reduce((s,w)=>s+(w.open_hours||0),0)/wts.length:40;
        const rate=oh>0?getPersonSalaryAtDate(per,te.date)/(oh*4.33):0;
        items.push({pid:p.id,proj:p.code,name:per.name,desc:te.hours+'ч ('+te.date+')',amt:Math.round(rate*(Number(te.hours)||0)),extra:per.grade});
      });});
    }else if(key==='ohPlan'||key==='ohProj'){
      projects.filter(p=>p.project_type!=='ФК').forEach(p=>{(p.overheads||[]).forEach(x=>{
        if(matchD(x.date))items.push({pid:p.id,proj:p.code,name:p.name,desc:x.description||x.category||'Накладная',amt:Number(x.amount)||0,extra:x.date||''});
      });});
    }else if(key==='fkOh'||key==='ohFK'){
      projects.filter(p=>p.project_type==='ФК').forEach(p=>{(p.overheads||[]).forEach(x=>{
        if(matchD(x.date))items.push({pid:p.id,proj:p.code,name:p.name,desc:x.description||x.category||'Накладная',amt:Number(x.amount)||0,extra:x.date||''});
      });});
    }else if(key==='fot'){
      persons.filter(p=>p.grade!=='C5'&&!p.is_investment_employee&&getPersonDepts(p).includes('Производство')&&(p.salary_monthly||0)>0).forEach(p=>{
        let ta=0;pfxs.forEach(pfx=>{ta+=getPersonMonthSalary(p,pfx);});
        const isFired=!!p.fire_date;
        if(ta>0)items.push({pid:'',proj:'',name:p.name,desc:(p.position||'')+(p.grade?' · '+p.grade:''),amt:Math.round(ta),extra:isFired?'❌ Уволен':'✅ Работает'});
      });
    }else if(key==='salaryKB'){
      const _kb=store.data.kb_budget||[];
      persons.filter(p=>!p.is_investment_employee&&getPersonDepts(p).includes('Продажи и Маркетинг')&&(p.salary_monthly||0)>0).forEach(p=>{
        let ta=0,hasFact=false;pfxs.forEach(pfx=>{const ov=_kb.find(x=>x.person_id===p.id&&x.cf_type==='SALARY_OCF'&&(x.month||'')===pfx);if(ov&&Number(ov.amount_fact)>0){ta+=Number(ov.amount_fact);hasFact=true;}else{ta+=getPersonMonthSalary(p,pfx);}});
        const isFired=!!p.fire_date;
        if(ta>0)items.push({pid:'',proj:'',name:p.name,desc:(p.position||'')+(p.grade?' · '+p.grade:'')+(hasFact?' (факт)':''),amt:Math.round(ta),extra:isFired?'❌ Уволен':'✅ Работает',_kbLink:true,_personId:p.id});
      });
    }else if(key==='expKB'){
      /* Расходы КБ из overhead_registry rg='КБ' scope='company' */
      const _or=store.data.overhead_registry||[];
      pfxs.forEach(pfx=>{
        _or.filter(e=>e.rg==='КБ'&&e.scope==='company'&&(e.date||'').startsWith(pfx)).forEach(e=>{
          const amt=Number(e.amount)||0;
          if(amt>0)items.push({pid:'',proj:'',name:e.comment||e.category||'Расход КБ',desc:e.category+(e.cls?' / '+e.cls:''),amt:Math.round(amt),extra:e.date+' | '+e.format+' | '+e.responsible});
        });
      });
    }else if(key==='officeRent'){
      /* Аренда офиса — фиксированная сумма (по умолчанию 1.2 млн/мес) */
      const _kbr=store.data.kb_budget||[];
      pfxs.forEach(pfx=>{
        const ovr=_kbr.find(x=>x.cf_type==='OFFICE'&&(x.month||'')===pfx&&!x.person_id);
        const amt=ovr&&Number(ovr.amount_plan)>0?Number(ovr.amount_plan):1200000;
        items.push({pid:'',proj:'',name:'Аренда офиса',desc:'Фиксированная ставка'+(ovr?' (ручн. переопред.)':' (по умолчанию 1.2 млн)'),amt:Math.round(amt),extra:pfx});
      });
    }else if(key==='aho'){
      /* АХО из overhead_registry rg='АХО' (всё, аренда отдельно фиксирована) */
      const _or=store.data.overhead_registry||[];
      pfxs.forEach(pfx=>{
        _or.filter(e=>e.rg==='АХО'&&e.scope==='company'&&(e.date||'').startsWith(pfx)).forEach(e=>{
          const amt=Number(e.amount)||0;
          if(amt>0)items.push({pid:'',proj:'',name:e.comment||'АХО',desc:e.category+(e.cls?' / '+e.cls:''),amt:Math.round(amt),extra:e.date+' | '+e.format+' | '+e.responsible});
        });
      });
    }else if(key==='expHR'){
      /* Расходы HR из overhead_registry rg='HR' scope='company' */
      const _or=store.data.overhead_registry||[];
      pfxs.forEach(pfx=>{
        _or.filter(e=>e.rg==='HR'&&e.scope==='company'&&(e.date||'').startsWith(pfx)).forEach(e=>{
          const amt=Number(e.amount)||0;
          if(amt>0)items.push({pid:'',proj:'',name:e.comment||e.category||'Расход HR',desc:e.category+(e.cls?' / '+e.cls:''),amt:Math.round(amt),extra:e.date+' | '+e.format+' | '+e.responsible});
        });
      });
    }else if(key==='salaryHR'){
      persons.filter(p=>getPersonDepts(p).includes('HR')&&(p.salary_monthly||0)>0).forEach(p=>{
        let ta=0;pfxs.forEach(pfx=>{ta+=getPersonMonthSalary(p,pfx);});
        const isFired=!!p.fire_date;
        if(ta>0)items.push({pid:'',proj:'',name:p.name,desc:(p.position||'')+(p.grade?' · '+p.grade:''),amt:Math.round(ta),extra:isFired?'❌ Уволен':'✅ Работает'});
      });
    }else if(key==='salaryInvest'){
      const _kb=store.data.kb_budget||[];
      const _icfOv=_kb.filter(x=>x.cf_type==='SALARY_ICF');
      persons.filter(p=>!!p.is_investment_employee&&getPersonDepts(p).includes('Продажи и Маркетинг')&&(p.salary_monthly||0)>0).forEach(p=>{
        let ta=0,hasFact=false;pfxs.forEach(pfx=>{const ov=_icfOv.find(x=>x.person_id===p.id&&(x.month||'')===pfx);if(ov&&Number(ov.amount_fact)>0){ta+=Number(ov.amount_fact);hasFact=true;}else{ta+=getPersonMonthSalary(p,pfx);}});
        const isFired=!!p.fire_date;
        if(ta>0)items.push({pid:'',proj:'',name:p.name,desc:'Инвест. сотр.'+(p.grade?' · '+p.grade:'')+(hasFact?' (факт)':''),amt:Math.round(ta),extra:isFired?'❌ Уволен':'✅ Работает',_kbLink:true});
      });
    }else if(key==='icfSalary'){
      /* Drill-down: ЗП инвест. сотрудников + стажёры */
      const _kb=store.data.kb_budget||[];
      const _icfOv=_kb.filter(x=>x.cf_type==='SALARY_ICF');
      persons.filter(p=>(!!p.is_investment_employee||p.grade==='Стажёр')&&((p.salary_monthly||0)>0||(p.intern_stipend||0)>0)).forEach(p=>{
        let ta=0;pfxs.forEach(pfx=>{
          if((p.hire_date||'')>pfx+'-31'||((p.fire_date||'')&&p.fire_date<pfx+'-01'))return;
          const ov=_icfOv.find(x=>x.person_id===p.id&&(x.month||'')===pfx);
          if(ov&&Number(ov.amount_fact)>0){ta+=Number(ov.amount_fact);}
          else if((p.salary_monthly||0)>0){ta+=getPersonMonthSalary(p,pfx);}
          else if(p.grade==='Стажёр'&&(p.intern_stipend||0)>0){ta+=Number(p.intern_stipend)||0;}
        });
        if(ta>0)items.push({pid:'',proj:'',name:p.name,desc:(p.position||'')+(p.grade?' · '+p.grade:'')+(p.is_investment_employee?' (инвест.)':' (стажёр)'),amt:Math.round(ta),extra:p.fire_date?'❌ Уволен':'✅ Работает',_icfType:'salary',_personId:p.id});
      });
    }else if(key==='icfOh'){
      /* Drill-down: Накладные ICF — только записи БЕЗ icf_project, scope=company */
      const _or=store.data.overhead_registry||[];
      pfxs.forEach(pfx=>{
        _or.filter(e=>e.scope==='company'&&(e.cf_type||'')==='ICF'&&!e.icf_project&&(e.date||'').startsWith(pfx)).forEach(e=>{
          const amt=Number(e.amount)||0;
          if(amt>0)items.push({pid:'',proj:'',name:e.comment||e.category||'Накладная ICF',desc:e.category+(e.cls?' / '+e.cls:''),amt:Math.round(amt),extra:e.date+' | '+e.format+' | '+(e.responsible||''),_icfType:'oh',_ohId:e.id,_cfType:e.cf_type});
        });
      });
    }else if(key==='icfProjExp'){
      /* Drill-down: Расходы инвест. проектов
         = kb_budget ICF_PROJ_EXP
         + overhead scope=company, cf_type=ICF, с icf_project (по каждому проекту) */
      const _kb=store.data.kb_budget||[];
      pfxs.forEach(pfx=>{
        _kb.filter(x=>x.cf_type==='ICF_PROJ_EXP'&&(x.month||'')===pfx&&!x.person_id).forEach(x=>{
          const amt=Number(x.amount_plan)||0;
          if(amt>0)items.push({pid:'',proj:'',name:x.name||'Расходы инвест. проектов (ручн.)',desc:'ICF_PROJ_EXP',amt:Math.round(amt),extra:pfx,_icfType:'kbBudget',_kbId:x.id,_cfType:x.cf_type});
        });
      });
      /* Overhead записи с icf_project */
      const _or=store.data.overhead_registry||[];
      pfxs.forEach(pfx=>{
        _or.filter(e=>e.scope==='company'&&(e.cf_type||'')==='ICF'&&!!e.icf_project&&(e.date||'').startsWith(pfx)).forEach(e=>{
          const amt=Number(e.amount)||0;
          if(amt>0)items.push({pid:'',proj:e.icf_project,name:e.comment||e.category||'Расход инвестпроекта',desc:e.category+(e.cls?' / '+e.cls:''),amt:Math.round(amt),extra:e.date+' | '+(e.responsible||''),_icfType:'oh',_ohId:e.id,_cfType:e.cf_type,_icfProject:e.icf_project});
        });
      });
    }else if(key==='icfProjInc'){
      /* Drill-down: Возмещение от инвест. проектов (kb_budget ICF_PROJ_INC + 5% комиссии) */
      const _kb=store.data.kb_budget||[];
      pfxs.forEach(pfx=>{
        _kb.filter(x=>x.cf_type==='ICF_PROJ_INC'&&(x.month||'')===pfx&&!x.person_id).forEach(x=>{
          const amt=Number(x.amount_plan)||0;
          if(amt>0)items.push({pid:'',proj:'',name:x.name||'Возмещение от инвест. проектов',desc:'ICF_PROJ_INC',amt:Math.round(amt),extra:pfx,_icfType:'kbBudget',_kbId:x.id,_cfType:x.cf_type});
        });
        /* 5% комиссии от заработанного в Стреле → возмещение комм.персоналу */
        const _icfD=(store.data.icf_deals||[]).filter(d=>!d.is_forecast&&d.icf_project==='Стрела'&&(d.date||'').startsWith(pfx));
        const _strEarnD=_icfD.reduce((s,d)=>s+(Number(d.earned)||0),0);
        const c5=Math.round(_strEarnD*0.05);
        if(c5>0)items.push({pid:'',proj:'Стрела',name:'5% комм.персоналу (Стрела)',desc:'Авто: 5% от заработанного '+fmt(_strEarnD),amt:c5,extra:pfx,_icfType:'auto5pct'});
      });
    }else if(key.startsWith('_icfP_')){
      /* Drill-down: подстрока конкретного инвестпроекта */
      const _projName=key.replace('_icfP_','');
      const _or=store.data.overhead_registry||[];
      pfxs.forEach(pfx=>{
        _or.filter(e=>e.scope==='company'&&(e.cf_type||'')==='ICF'&&e.icf_project===_projName&&(e.date||'').startsWith(pfx)).forEach(e=>{
          const amt=Number(e.amount)||0;
          if(amt>0)items.push({pid:'',proj:_projName,name:e.comment||e.category||'Расход',desc:e.category+(e.cls?' / '+e.cls:''),amt:Math.round(amt),extra:e.date+' | '+(e.responsible||''),_icfType:'oh',_ohId:e.id,_cfType:e.cf_type,_icfProject:_projName});
        });
      });
    }else if(key==='profit'||key==='fkProfit'||key==='marginPct'||key==='profitExP'||key==='totalProfit'||key==='netProfit'||key==='fullProfit'||key==='finExp'||key==='finInc'||key==='sga'||key==='icfNet'||key==='icfOps'){
      setFmFilter({wg:'',ptype:''});setFmDrill({label:lbl,items:[],total:0,computed:true,key,pfxs});setFmNewPay(null);return;
    }
    items.forEach(it=>{if(it.pid){const pr=store.data.projects.find(x=>x.id===it.pid);if(pr){it.wg=pr.work_group||'';it.ptype=pr.project_type||'';}}});
    items.sort((a,b)=>Math.abs(b.amt)-Math.abs(a.amt));
    setFmFilter({wg:'',ptype:''});
    setFmDrill({label:lbl,items,total:items.reduce((s,x)=>s+x.amt,0),key,pfxs});setFmNewPay(null);
  };


  return <div>
    <h2 className="page-title">Финансовая машина</h2>
    <div className="tabs" style={{marginBottom:12}}>
      {[['pnl','P&L по проектам'],['quarterly','Все проекты Кв'],['kb_budget','Бюджет КБ'],['hr_budget','Бюджет HR'],['overheads','Накладные'],['oh_registry','Общие накладные'],['invest_proj','Инвест проекты'],['cash_flow','Cash Flow']].map(([k,l])=><div key={k} className={'tab '+(fmTab===k?'active':'')} onClick={()=>setFmTab(k)}>{l}</div>)}
    </div>

    {fmTab==='quarterly'&&<div>
      <div className="dash-card" style={{padding:10,overflowX:'auto'}}>
        <div style={{fontSize:13,fontWeight:700,marginBottom:8}}>ОБЩИЕ ПОКАЗАТЕЛИ (ВСЕ ПРОЕКТЫ) — {yr}</div>
        <table style={{width:'100%',fontSize:10,borderCollapse:'collapse'}}>
          <thead><tr style={{background:'var(--bg3)'}}>
            <th style={{textAlign:'left',padding:'4px 6px',minWidth:160}}>Показатель</th>
            <th style={{textAlign:'right',padding:'4px 4px',fontWeight:700,background:'var(--accent)',color:'#fff'}}>Итого</th>
            {monthlyData.map((m,i)=><React.Fragment key={i}>
              <th style={{textAlign:'right',padding:'4px 4px'}}>{m.month}</th>
              {(i+1)%3===0&&<th style={{textAlign:'right',padding:'4px 4px',fontWeight:700,background:'var(--accent2)',color:'#fff'}}>{quarters[Math.floor(i/3)].label}</th>}
            </React.Fragment>)}
          </tr></thead>
          <tbody>
            {[
              {label:'Приход план CF',key:'incPlan',type:'CF',clr:''},
              {label:'Приход факт CF',key:'incFactCF',type:'CF',clr:'var(--green)'},
              {label:'Приход план PnL',key:'incPlan',type:'PnL',clr:''},
              {label:'Приход факт PnL',key:'incFactPNL',type:'PnL',clr:'var(--emerald)'},
              {label:'Стоимость после налогов план',key:'netRevPlan',type:'CF',clr:''},
              {label:'Стоимость после налогов факт',key:'netRevFactPNL',type:'PnL',clr:'var(--emerald)'},
              {label:'Накладные',key:'ohPlan',type:'',clr:'var(--violet)'},
              {label:'Факт ФОТ стратегии',key:'fot',type:'',clr:'var(--sky)'},
              {label:'Опер. прибыль от стратегий',key:'profit',type:'',clr:'',bold:true},
              {label:'Маржинальность',key:'marginPct',type:'',clr:'',pct:true},
              {label:'Косты произв. (C1-C4)',key:'costProd',type:'',clr:'var(--red)'},
              {label:'Косты C5',key:'costC5',type:'',clr:'var(--amber)'},
              {label:'Опер. прибыль за вычетом партнёров',key:'profitExP',type:'',clr:'',bold:true},
              {label:'Приход план CF ФК',key:'fkIncPlan',type:'CF',clr:''},
              {label:'Приход факт CF ФК',key:'fkIncFactCF',type:'CF',clr:'var(--green)'},
              {label:'Приход план PnL ФК',key:'fkIncPlan',type:'PnL',clr:''},
              {label:'Приход факт PnL ФК',key:'fkIncFactPNL',type:'PnL',clr:'var(--emerald)'},
              {label:'Стоимость после налогов ФК',key:'fkNetRev',type:'',clr:''},
              {label:'Накладные ФК',key:'fkOh',type:'',clr:'var(--violet)'},
              {label:'Опер. прибыль ФК',key:'fkProfit',type:'',clr:'',bold:true},
              {label:'Общая оперприбыль',key:'totalProfit',type:'',clr:'',bold:true},
              {label:'Офис (аренда)',key:'officeRent',type:'',clr:'var(--amber)',editable:true},
              {label:'АХО',key:'aho',type:'',clr:'var(--amber)'},
              {label:'Расходы КБ',key:'expKB',type:'',clr:'var(--amber)'},
              {label:'Расходы HR',key:'expHR',type:'',clr:'var(--emerald)'},
              {label:'Зарплата КБ',key:'salaryKB',type:'',clr:'var(--sky)'},
              {label:'Зарплата HR',key:'salaryHR',type:'',clr:'var(--sky)'},
              {label:'Зарплата бухгалтерии',key:'salaryAcct',type:'',clr:'var(--emerald)'},
              {label:'Расходы PP',key:'expPP',type:'',clr:'var(--violet)'},
              {label:'Валютные операции',key:'fxOps',type:'',clr:'var(--amber)',editable:true},
              {label:'SG&A',key:'sga',type:'',clr:'var(--red)',bold:true},
              {label:(showFinExp?'▼':'▶')+' Расходы от фин. деятельности',key:'finExp',type:'',clr:'var(--red)',bold:true,toggle:true},
              ...(showFinExp?[
                {label:'  Комиссии банков',key:'bankFees',type:'',clr:'var(--amber)',editable:true},
                {label:'  Дополнительные налоги',key:'extraTax',type:'',clr:'var(--amber)',editable:true},
              ]:[]),
              {label:'Чистая прибыль',key:'netProfit',type:'',clr:'',bold:true},
              {label:(showFinInc?'▼':'▶')+' Доход от фин. деятельности',key:'finInc',type:'',clr:'var(--emerald)',bold:true,toggle:true,toggleFn:()=>setShowFinInc(p=>!p)},
              ...(showFinInc?[
                {label:'  Доход от депозитов',key:'depIncome',type:'',clr:'var(--emerald)',editable:true},
                {label:'  Оптимизация налогов',key:'taxOpt',type:'',clr:'var(--emerald)',editable:true},
              ]:[]),
              {label:'Полная прибыль',key:'fullProfit',type:'',clr:'',bold:true},
              {label:(showICF?'▼':'▶')+' Инвестиционный CF (ICF)',key:'icfNet',type:'',clr:'var(--sky)',bold:true,toggle:true,toggleFn:()=>setShowICF(p=>!p)},
              ...(showICF?[
                {label:'  Входящий баланс ICF',key:'icfBalanceOpen',type:'',clr:'var(--sky)',balance:true},
                {label:'  ЗП инвест. сотрудников + стажёры',key:'icfSalary',type:'',clr:'var(--red)'},
                {label:'  Накладные ICF',key:'icfOh',type:'',clr:'var(--red)'},
                {label:'  '+(showICFProj?'▼':'▶')+' Расходы инвест. проектов',key:'icfProjExp',type:'',clr:'var(--red)',toggle:true,toggleFn:()=>setShowICFProj(p=>!p)},
                ...(showICFProj?['Стрела','Moove','Клуб ЧТД','Консорциум ЧТД','Скрытые Чемпионы','IAM'].map(pn=>({label:'    '+pn,key:'_icfP_'+pn,type:'',clr:'var(--red)',_icfProjName:pn})):[]),
                {label:'  Возмещение от инвест. проектов',key:'icfProjInc',type:'',clr:'var(--emerald)',editable:true},
                {label:'  Исходящий баланс ICF',key:'icfBalanceClose',type:'',clr:'var(--sky)',bold:true,balance:true},
              ]:[]),
            ].map((row,ri)=>{
              const isSep=row.bold;const rowLabel=row.toggle?row.label:(fmLabels[row.key]||row.label);const isPK=row.key==='profit'||row.key==='profitExP'||row.key==='fkProfit'||row.key==='totalProfit'||row.key==='netProfit'||row.key==='fullProfit';
              const _ipn=row._icfProjName;const _getVal=(src)=>_ipn?((src.icfByProj||{})[_ipn]||0):src[row.key];
              return <tr key={ri} style={isSep?{borderTop:'2px solid var(--accent)',fontWeight:700}:ri%2===0?{background:'var(--bg1)'}:{}}>
                <td style={{padding:'3px 6px',whiteSpace:'nowrap'}}>{row.toggle?<span style={{cursor:'pointer',userSelect:'none'}} onClick={row.toggleFn||(() =>setShowFinExp(p=>!p))}>{rowLabel}</span>:fmEditLabel&&fmEditLabel.key===row.key?<input style={{fontSize:11,width:200,padding:'1px 4px',border:'1px solid var(--accent)',borderRadius:3}} autoFocus value={fmEditLabel.value} onChange={e=>setFmEditLabel(prev=>({...prev,value:e.target.value}))} onBlur={()=>{if(fmEditLabel.value.trim())saveFmLabel(fmEditLabel.key,fmEditLabel.value.trim());setFmEditLabel(null);}} onKeyDown={e=>{if(e.key==='Enter'){if(fmEditLabel.value.trim())saveFmLabel(fmEditLabel.key,fmEditLabel.value.trim());setFmEditLabel(null);}if(e.key==='Escape')setFmEditLabel(null);}}/>:<span style={{cursor:'pointer'}} onDoubleClick={()=>setFmEditLabel({key:row.key,value:rowLabel})} title="2× клик — редактировать">{rowLabel}</span>}{row.type&&<span style={{fontSize:8,color:'var(--text2)',marginLeft:4}}>{row.type}</span>}</td>
                <td style={{textAlign:'right',padding:'3px 4px',fontWeight:700,color:row.clr||(isPK?(_getVal(yrTotal)>=0?'var(--green)':'var(--red)'):''),background:'var(--bg3)',cursor:row.balance?'default':'pointer'}} onClick={row.balance?undefined:()=>openDrill(row.key,rowLabel+' — Итого',Array.from({length:12},(_,j)=>yr+'-'+String(j+1).padStart(2,'0')))}>{row.pct?_getVal(yrTotal)+'%':fmt(_getVal(yrTotal))}</td>
                {monthlyData.map((m,i)=>{const mPfx=yr+'-'+String(i+1).padStart(2,'0');const isEditing=fmEditCell&&fmEditCell.key===row.key&&fmEditCell.monthIdx===i;return <React.Fragment key={i}>
                  {row.editable?<td style={{textAlign:'right',padding:'1px 2px',color:row.clr,background:isEditing?'var(--bg3)':'transparent',cursor:'pointer',minWidth:50}} onDoubleClick={()=>setFmEditCell({key:row.key,monthIdx:i,value:String(m[row.key]||'')})}>{isEditing?<input type="number" style={{width:56,fontSize:10,textAlign:'right',padding:'1px 3px',border:'1px solid var(--accent)',borderRadius:3,background:'#fff'}} autoFocus value={fmEditCell.value} onChange={e=>setFmEditCell(prev=>({...prev,value:e.target.value}))} onBlur={()=>{saveFmCell(row.key==='officeRent'?'OFFICE':row.key==='fxOps'?'FX_OPS':row.key==='bankFees'?'BANK_FEES':row.key==='extraTax'?'EXTRA_TAX':row.key==='depIncome'?'DEP_INCOME':row.key==='taxOpt'?'TAX_OPT':row.key==='icfProjExp'?'ICF_PROJ_EXP':row.key==='icfProjInc'?'ICF_PROJ_INC':'AHO',mPfx,fmEditCell.value);setFmEditCell(null);}} onKeyDown={e=>{if(e.key==='Enter'){saveFmCell(row.key==='officeRent'?'OFFICE':row.key==='fxOps'?'FX_OPS':row.key==='bankFees'?'BANK_FEES':row.key==='extraTax'?'EXTRA_TAX':row.key==='depIncome'?'DEP_INCOME':row.key==='taxOpt'?'TAX_OPT':row.key==='icfProjExp'?'ICF_PROJ_EXP':row.key==='icfProjInc'?'ICF_PROJ_INC':'AHO',mPfx,fmEditCell.value);setFmEditCell(null);}if(e.key==='Escape')setFmEditCell(null);}}/>:<span title="2× клик — редактировать">{fmt(m[row.key])}</span>}</td>
                  :<td style={{textAlign:'right',padding:'3px 4px',color:row.clr||(isPK?(_getVal(m)>=0?'var(--green)':'var(--red)'):''),fontWeight:isSep?700:400,cursor:row.balance?'default':'pointer'}} onClick={row.balance?undefined:()=>openDrill(row.key,rowLabel+' — '+m.month,[mPfx])}>{row.pct?_getVal(m)+'%':fmt(_getVal(m))}</td>}
                  {(i+1)%3===0&&<td style={{textAlign:'right',padding:'3px 4px',fontWeight:700,background:'var(--bg3)',color:row.clr||(isPK?(_getVal(quarters[Math.floor(i/3)])>=0?'var(--green)':'var(--red)'):''),cursor:row.balance?'default':'pointer'}} onClick={row.balance?undefined:()=>{const qi=Math.floor(i/3);openDrill(row.key,rowLabel+' — '+quarters[qi].label,[0,1,2].map(j=>yr+'-'+String(qi*3+j+1).padStart(2,'0')));}}>{row.pct?_getVal(quarters[Math.floor(i/3)])+'%':fmt(_getVal(quarters[Math.floor(i/3)]))}</td>}
                </React.Fragment>})}
              </tr>;
            })}
          </tbody>
        </table>
      </div>
      {fmDrill&&<Modal onClose={()=>setFmDrill(null)}>
        <h2 style={{fontSize:14,marginBottom:8}}>{fmDrill.label}</h2>
        {fmDrill.computed?<div style={{fontSize:12,color:'var(--text2)'}}>Вычисляемый показатель (составлен из других строк таблицы)</div>:
        <div>
          <div style={{display:'flex',gap:8,marginBottom:8,flexWrap:'wrap',alignItems:'center'}}>
            <select style={{fontSize:10,padding:'2px 6px',borderRadius:4,border:'1px solid var(--border)'}} value={fmFilter.wg} onChange={e=>setFmFilter(p=>({...p,wg:e.target.value}))}>
              <option value="">Все РГ</option><option value="РГ1">РГ1</option><option value="РГ2">РГ2</option></select>
            <select style={{fontSize:10,padding:'2px 6px',borderRadius:4,border:'1px solid var(--border)'}} value={fmFilter.ptype} onChange={e=>setFmFilter(p=>({...p,ptype:e.target.value}))}>
              <option value="">Все типы</option><option value="Old Delivery">Old Delivery</option><option value="New Delivery">New Delivery</option></select>
            {(fmFilter.wg||fmFilter.ptype)&&<button className="btn btn-secondary btn-sm" style={{fontSize:9,padding:'1px 6px'}} onClick={()=>setFmFilter({wg:'',ptype:''})}>Сбросить</button>}
          </div>
          {(()=>{const fi=fmDrill.items.filter(it=>{if(fmFilter.wg&&it.wg!==fmFilter.wg)return false;if(fmFilter.ptype&&it.ptype!==fmFilter.ptype)return false;return true;});const filtTotal=fi.reduce((s,x)=>s+x.amt,0);return <>
          <div style={{fontSize:11,color:'var(--text2)',marginBottom:8}}>{(fmFilter.wg||fmFilter.ptype)?<span>Отфильтровано: <b>{fmt(filtTotal)} ₽</b> ({fi.length} из {fmDrill.items.length}) | Всего: <b>{fmt(fmDrill.total)} ₽</b></span>:<span>Всего: <b>{fmt(fmDrill.total)} ₽</b> ({fmDrill.items.length} позиций)</span>}</div>
          <div style={{maxHeight:400,overflowY:'auto'}}>
            <table style={{width:'100%',fontSize:11,borderCollapse:'collapse'}}>
              <thead><tr style={{borderBottom:'1px solid var(--border)',background:'var(--bg3)'}}>
                <th style={{textAlign:'left',padding:'3px 6px'}}>Проект</th>
                <th style={{textAlign:'left',padding:'3px 6px',fontSize:9}}>РГ</th>
                <th style={{textAlign:'center',padding:'3px 6px',fontSize:9}}>№</th>
                <th style={{textAlign:'left',padding:'3px 6px'}}>Описание</th>
                <th style={{textAlign:'right',padding:'3px 6px'}}>Сумма</th>
                <th style={{textAlign:'left',padding:'3px 6px'}}>Инфо</th>
                {fmDrill.items.some(x=>x._icfType)&&<th style={{textAlign:'center',padding:'3px 6px',fontSize:9}}>CF</th>}
                {fmDrill.items.some(x=>x._icfType)&&<th style={{textAlign:'center',padding:'3px 4px',fontSize:9}}></th>}
              </tr></thead>
              <tbody>{fi.map((it,idx)=><tr key={idx} style={{borderBottom:'1px solid var(--bg3)'}}>
                <td style={{padding:'3px 6px',fontWeight:600,color:'var(--accent2)',whiteSpace:'nowrap',cursor:(it.pid||it._kbLink)?'pointer':'default'}} onClick={()=>{if(it.pid){setFmDrill(null);goProject(it.pid);}else if(it._kbLink){setFmDrill(null);setFmTab('kb_budget');}}}>{it.proj||''}{it._kbLink&&!it.proj?<span style={{color:'var(--amber)',fontSize:9}}>📋 Бюджет КБ</span>:null}{it.name&&<span style={{fontWeight:400,color:it._kbLink?'var(--accent2)':'var(--text2)',marginLeft:4}}>{it.name}</span>}</td>
                <td style={{padding:'3px 6px',fontSize:9,color:'var(--text2)'}}>{it.wg||''}</td>
                <td style={{padding:'3px 6px',textAlign:'center',fontSize:9,color:'var(--text2)'}}>{it.tnum||''}</td>
                <td style={{padding:'3px 6px',color:'var(--text2)'}}>{it.desc}</td>
                <td style={{padding:'3px 6px',textAlign:'right',fontWeight:600}}>{fmt(it.amt)}</td>
                <td style={{padding:'3px 6px',fontSize:9,color:'var(--text2)'}}>{it.pmId?<select value={it.pmStatus||'PLANNED'} style={{fontSize:9,padding:'1px 3px',border:'1px solid var(--border)',borderRadius:4,background:it.pmStatus==='PAID'?'var(--green-bg,#e6f9e6)':it.pmStatus==='ACCRUED'?'var(--amber-bg,#fff8e0)':'var(--bg2)',color:it.pmStatus==='PAID'?'var(--green)':it.pmStatus==='ACCRUED'?'var(--amber)':'var(--text2)',cursor:'pointer',fontWeight:600}} onChange={e=>{const nv=e.target.value;const upd={status:nv};const today=new Date().toISOString().slice(0,10);if(nv==='ACCRUED'){upd.accrued_date=today;}else if(nv==='PAID'){upd.actual_date=today;}store.updatePayment(it.pid,it.pmId,upd);setTimeout(()=>openDrill(fmDrill.key,fmDrill.label,fmDrill.pfxs),50);}}><option value="PLANNED">PLANNED</option><option value="ACCRUED">ACCRUED</option><option value="PAID">PAID</option></select>:it.extra}</td>
                {fmDrill.items.some(x=>x._icfType)&&<td style={{padding:'3px 4px',textAlign:'center'}}>{it._icfType==='oh'?<select value={it._cfType||'ICF'} style={{fontSize:9,padding:'1px 3px',border:'1px solid var(--border)',borderRadius:4,background:it._cfType==='ICF'?'#e0f0ff':'var(--bg2)',color:it._cfType==='ICF'?'var(--sky)':'var(--text2)',cursor:'pointer',fontWeight:600}} onChange={e=>{store.updateOhRegistryItem(it._ohId,{cf_type:e.target.value});setTimeout(()=>openDrill(fmDrill.key,fmDrill.label,fmDrill.pfxs),50);}}><option value="ICF">ICF</option><option value="OCF">OCF</option></select>:it._icfType==='kbBudget'?<span style={{fontSize:9,color:'var(--sky)',fontWeight:600}}>{(it._cfType||'').replace('ICF_PROJ_','')}</span>:it._icfType==='salary'?<span style={{fontSize:9,color:'var(--sky)'}}>ICF</span>:''}</td>}
                {fmDrill.items.some(x=>x._icfType)&&<td style={{padding:'3px 2px',textAlign:'center'}}>{(it._icfType==='oh'||it._icfType==='kbBudget')?<button style={{fontSize:9,padding:'1px 4px',border:'1px solid var(--red)',borderRadius:3,background:'transparent',color:'var(--red)',cursor:'pointer',lineHeight:1}} title="Удалить" onClick={()=>{if(!confirm('Удалить эту запись?'))return;if(it._icfType==='oh')store.deleteOhRegistryItem(it._ohId);else if(it._icfType==='kbBudget')store.deleteKbBudgetItem(it._kbId);setTimeout(()=>openDrill(fmDrill.key,fmDrill.label,fmDrill.pfxs),50);}}>✕</button>:''}</td>}
              </tr>)}
              <tr style={{borderTop:'2px solid var(--accent2)',fontWeight:700,background:'var(--bg3)'}}>
                <td colSpan={3} style={{padding:'4px 6px'}}>Итого</td><td></td>
                <td style={{padding:'4px 6px',textAlign:'right'}}>{fmt(filtTotal)} ₽</td><td></td>
                {fmDrill.items.some(x=>x._icfType)&&<td></td>}
                {fmDrill.items.some(x=>x._icfType)&&<td></td>}
              </tr></tbody>
            </table>
          </div></>})()}
          {fmDrill.key&&['incPlan','incFactCF','incFactPNL','netRevPlan','netRevFactPNL','fkIncPlan','fkIncFactCF','fkIncFactPNL','fkNetRev'].includes(fmDrill.key)&&<div style={{marginTop:12,borderTop:'1px solid var(--border)',paddingTop:8}}>
            {!fmNewPay?<button className="btn btn-primary btn-sm" onClick={()=>setFmNewPay({proj_id:'',amount:'',description:''})}>+ Добавить транш</button>
            :<div style={{display:'flex',flexDirection:'column',gap:6}}>
              <div style={{fontSize:12,fontWeight:600,color:'var(--accent2)'}}>Новый транш → {fmDrill.pfxs?.[0]||''}</div>
              <div style={{display:'flex',gap:6,flexWrap:'wrap',alignItems:'center'}}>
                <div style={{flex:2,minWidth:160,position:'relative'}}><input style={{width:'100%',fontSize:11,boxSizing:'border-box'}} placeholder="Код или название проекта..." value={fmNewPay._search||''} onChange={e=>{const v=e.target.value;setFmNewPay(prev=>({...prev,_search:v,proj_id:'',_open:true}));}} onFocus={()=>setFmNewPay(prev=>({...prev,_open:true}))} onBlur={()=>setTimeout(()=>setFmNewPay(prev=>({...prev,_open:false})),200)}/>{fmNewPay._open&&(fmNewPay._search||'').length>0&&(()=>{const q=(fmNewPay._search||'').toLowerCase();const ms=store.data.projects.filter(x=>(x.code+' '+x.name).toLowerCase().includes(q)).slice(0,12);return ms.length>0?<div style={{position:'absolute',top:'100%',left:0,right:0,background:'var(--bg1)',border:'1px solid var(--border)',borderRadius:6,maxHeight:200,overflowY:'auto',zIndex:999,boxShadow:'0 4px 12px rgba(0,0,0,.15)'}}>{ms.map(x=><div key={x.id} style={{padding:'5px 8px',fontSize:11,cursor:'pointer',borderBottom:'1px solid var(--bg3)'}} onMouseDown={e=>{e.preventDefault();setFmNewPay(prev=>({...prev,proj_id:x.id,_search:x.code+' '+x.name,_open:false}));}} onMouseEnter={e=>e.currentTarget.style.background='var(--bg3)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}><b style={{color:'var(--accent2)'}}>{x.code}</b> <span style={{color:'var(--text2)'}}>{x.name}</span> <span className={'badge '+(statusMap[x.status]||'b-draft')} style={{fontSize:8,marginLeft:4,verticalAlign:'middle'}}>{x.status}</span></div>)}</div>:<div style={{position:'absolute',top:'100%',left:0,right:0,background:'var(--bg1)',border:'1px solid var(--border)',borderRadius:6,zIndex:999,boxShadow:'0 4px 12px rgba(0,0,0,.15)'}}><div style={{padding:'8px 10px',fontSize:11,cursor:'pointer',color:'var(--accent)',display:'flex',alignItems:'center',gap:4}} onMouseDown={e=>{e.preventDefault();setFmNewProj(fmNewPay._search||'');}} onMouseEnter={e=>e.currentTarget.style.background='var(--bg3)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}><b>+</b> Создать проект «{fmNewPay._search}»</div></div>;})()}{fmNewPay.proj_id&&<div style={{fontSize:9,color:'var(--green)',marginTop:2}}>✓ {store.data.projects.find(x=>x.id===fmNewPay.proj_id)?.code}</div>}</div>
                <input type="number" style={{width:100,fontSize:11}} placeholder="Сумма ₽" value={fmNewPay.amount} onChange={e=>setFmNewPay(p=>({...p,amount:e.target.value}))}/>
                <input style={{flex:1,minWidth:100,fontSize:11}} placeholder="Описание" value={fmNewPay.description} onChange={e=>setFmNewPay(p=>({...p,description:e.target.value}))}/>
                <button className="btn btn-success btn-sm" onClick={()=>{if(!fmNewPay.proj_id||!fmNewPay.amount)return;const pr=projects.find(x=>x.id===fmNewPay.proj_id);store.addPayment(fmNewPay.proj_id,{tranche_number:(pr?.payments||[]).length+1,amount:Number(fmNewPay.amount),planned_date:fmDrill.pfxs?.[0]||'',actual_date:fmDrill.pfxs?.[0]||'',accrued_date:fmDrill.pfxs?.[0]||'',status:'PAID',description:fmNewPay.description||'Транш из FinMashina',prior_year:false});setFmNewPay(null);setFmDrill(null);}}>Создать</button>
                <button className="btn btn-secondary btn-sm" onClick={()=>setFmNewPay(null)} style={{padding:'2px 8px'}}>✕</button>
              </div>
            </div>}
          </div>}
        </div>}
      </Modal>}
      {fmNewProj&&<NewProjectModal store={{...store,addProject:(p)=>{const proj=store.addProject(p);fmCreRef.current=proj;return proj;}}} initialName={typeof fmNewProj==='string'?fmNewProj:''} onClose={()=>{setFmNewProj(false);if(fmCreRef.current){const np=fmCreRef.current;setFmNewPay(prev=>prev?{...prev,proj_id:np.id,_search:np.code+' '+np.name,_open:false}:prev);fmCreRef.current=null;}}}/>}
    </div>}

    {fmTab==='pnl'&&<React.Fragment>
    <div className="kpi-row">
      <div className="kpi-card"><div className="kpi-label">Выручка нетто</div><div className="kpi-value green-c">{fmt(totRevNet)}</div></div>
      <div className="kpi-card"><div className="kpi-label">Грязная валовая</div><div className="kpi-value" style={{color:totDirty>=0?'var(--green)':'var(--red)'}}>{fmt(totDirty)}</div><div className="kpi-sub">{dirtyPct}% от нетто</div></div>
      <div className="kpi-card"><div className="kpi-label">Чистая валовая</div><div className="kpi-value" style={{color:totClean>=0?'var(--green)':'var(--red)'}}>{fmt(totClean)}</div><div className="kpi-sub">{cleanPct}% от нетто</div></div>
      <div className="kpi-card"><div className="kpi-label">ФОТ месячный</div><div className="kpi-value accent-c">{fmt(totalFOT)}</div><div className="kpi-sub">{persons.filter(p=>p.salary_monthly>0).length} сотрудников</div></div>
    </div>

    <div className="dash-section">
      <div className="dash-section-title">P&L по проектам</div>
      <div className="dash-card" style={{padding:10}}>
        <div style={{overflowX:'auto'}}><table style={{width:'100%',fontSize:11}}>
          <thead><tr style={{borderBottom:'2px solid var(--border)'}}>
            <th style={{textAlign:'left'}}>Код</th><th style={{textAlign:'left'}}>Название</th><th style={{textAlign:'right'}}>Нетто</th><th style={{textAlign:'right'}}>Косты C1-C4</th><th style={{textAlign:'right'}}>Накладные</th><th style={{textAlign:'right'}}>Грязная</th><th style={{textAlign:'right'}}>Грязн.%</th><th style={{textAlign:'right'}}>Косты C5</th><th style={{textAlign:'right'}}>Чистая</th><th style={{textAlign:'right'}}>Чист.%</th>
          </tr></thead>
          <tbody>
            {pnls.map(p=><tr key={p.id} className="clickable" onClick={()=>goProject(p.id)} style={{borderBottom:'1px solid var(--border)'}}>
              <td style={{color:'var(--accent2)',fontWeight:600}}>{p.code}</td>
              <td style={{maxWidth:180,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.name}</td>
              <td style={{textAlign:'right'}}>{fmt(p.pnl.revNet)}</td>
              <td style={{textAlign:'right',color:'var(--red)'}}>-{fmt(p.pnl.costProd)}</td>
              <td style={{textAlign:'right',color:'var(--violet)'}}>-{fmt(p.pnl.ohTotal)}</td>
              <td style={{textAlign:'right',fontWeight:600,color:p.pnl.dirtyProfit>=0?'var(--green)':'var(--red)'}}>{fmt(p.pnl.dirtyProfit)}</td>
              <td style={{textAlign:'right',color:p.pnl.dirtyPct>=75?'var(--green)':p.pnl.dirtyPct>=60?'var(--amber)':'var(--red)'}}>{p.pnl.dirtyPct}%</td>
              <td style={{textAlign:'right',color:'var(--amber)'}}>-{fmt(p.pnl.costC5)}</td>
              <td style={{textAlign:'right',fontWeight:600,color:p.pnl.cleanProfit>=0?'var(--green)':'var(--red)'}}>{fmt(p.pnl.cleanProfit)}</td>
              <td style={{textAlign:'right',color:p.pnl.cleanPct>=60?'var(--green)':'var(--red)'}}>{p.pnl.cleanPct}%</td>
            </tr>)}
            <tr style={{borderTop:'2px solid var(--accent)',fontWeight:700}}>
              <td colSpan={2}>ИТОГО</td>
              <td style={{textAlign:'right'}}>{fmt(totRevNet)}</td>
              <td style={{textAlign:'right',color:'var(--red)'}}>-{fmt(totCostProd)}</td>
              <td style={{textAlign:'right',color:'var(--violet)'}}>-{fmt(totOH)}</td>
              <td style={{textAlign:'right',color:totDirty>=0?'var(--green)':'var(--red)'}}>{fmt(totDirty)}</td>
              <td style={{textAlign:'right'}}>{dirtyPct}%</td>
              <td style={{textAlign:'right',color:'var(--amber)'}}>-{fmt(totCostC5)}</td>
              <td style={{textAlign:'right',color:totClean>=0?'var(--green)':'var(--red)'}}>{fmt(totClean)}</td>
              <td style={{textAlign:'right'}}>{cleanPct}%</td>
            </tr>
          </tbody>
        </table></div>
      </div>
    </div>

    <div className="dash-section">
      <div className="dash-section-title">ФОТ по грейдам</div>
      <div className="dash-card" style={{padding:10}}>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(160px,1fr))',gap:8}}>
          {Object.entries(gradeMap).sort((a,b)=>(a[0]>b[0]?1:-1)).map(([g,d])=><div key={g} style={{padding:'8px 12px',background:'var(--bg1)',borderRadius:8,fontSize:11}}>
            <div style={{fontWeight:600,marginBottom:4}}>{g} <span style={{color:'var(--text2)',fontWeight:400}}>({d.count})</span></div>
            <div style={{fontSize:14,fontWeight:700}}>{fmt(d.fot)} ₽</div>
            <div style={{fontSize:10,color:'var(--text2)'}}>{totalFOT>0?Math.round(d.fot/totalFOT*100):0}% от ФОТ</div>
          </div>)}
        </div>
        <div style={{marginTop:8,padding:'6px 12px',background:'var(--accent)',color:'#fff',borderRadius:6,display:'flex',justifyContent:'space-between',fontSize:13}}>
          <span>Итого ФОТ</span>
          <span style={{fontWeight:700}}>{fmt(totalFOT)} ₽/мес</span>
        </div>
      </div>
    </div>
  </React.Fragment>}

  {fmTab==='kb_budget'&&(()=>{
    /*
     * ══════════════════════════════════════════════════════════════════
     * МАРШРУТ ДАННЫХ КБ (УТВЕРЖДЕНО):
     * Единственный штатный маршрут внесения ФАКТА прочих расходов КБ:
     *   1. Создать операцию во вкладке «Общие накладные» (overhead_registry)
     *      с указанием rg='КБ', даты, суммы, категории, класса и т.д.
     *   2. Факт автоматически подтягивается в Бюджет КБ → Прочие расходы
     *      через подсчёт из overhead_registry (rg='КБ', scope='company').
     *   3. Ручная правка факта в Бюджете КБ допускается как исключение.
     * Никакие другие сценарии внесения в OCF факт не являются штатными.
     * ══════════════════════════════════════════════════════════════════
     */
    const kbItems=store.data.kb_budget||[];
    const kbPersons=persons.filter(p=>getPersonDepts(p).includes('Продажи и Маркетинг')&&(p.salary_monthly||0)>0);
    const kbPersonActive=(pe,m)=>{const hd=pe.hire_date||'';const fd=pe.fire_date||'';const ms=m+'-01';const me=m+'-31';if(hd&&hd>me)return false;if(fd&&fd<ms)return false;return true;};
    const salCfType=(pe)=>pe.is_investment_employee?'SALARY_ICF':'SALARY_OCF';
    const salPlanForMonth=(m,type)=>kbPersons.filter(pe=>kbPersonActive(pe,m)&&(type==='ICF'?!!pe.is_investment_employee:!pe.is_investment_employee)).reduce((s,pe)=>s+getPersonMonthSalary(pe,m),0);
    const salEffForMonth=(m,type)=>{const ct=type==='ICF'?'SALARY_ICF':'SALARY_OCF';return kbPersons.filter(pe=>kbPersonActive(pe,m)&&(type==='ICF'?!!pe.is_investment_employee:!pe.is_investment_employee)).reduce((s,pe)=>{const ovr=kbItems.find(x=>x.person_id===pe.id&&(x.month||'')===m&&x.cf_type===ct);return s+((ovr&&Number(ovr.amount_fact)>0)?Number(ovr.amount_fact):getPersonMonthSalary(pe,m));},0);};
    /* Expense items — exclude salary overrides and AHO/OFFICE (not KB) */
    const expItems=kbItems.filter(x=>!x.person_id&&x.cf_type!=='SALARY_OCF'&&x.cf_type!=='SALARY_ICF'&&x.cf_type!=='OFFICE'&&x.cf_type!=='AHO');
    /* Normalize category names — merge synonyms */
    const _catNorm={'ИТ-решения':'IT решения','ИТ решения':'IT решения','ит-решения':'IT решения','It решения':'IT решения'};
    const normCat=(nm)=>_catNorm[nm]||nm;
    /* Unique normalized names from kb_budget */
    const expNamesRaw=[...new Set(expItems.map(x=>x.name).filter(Boolean))];
    const expNames=[...new Set(expNamesRaw.map(normCat))];
    /* Find all kb_budget items matching a normalized name */
    const expItemsFor=(nm)=>expItems.filter(x=>normCat(x.name)===nm);
    const expCfType=(nm)=>{const it=expItemsFor(nm)[0];return it?(it.cf_type||'OCF'):'OCF';};
    /* Auto-spread plan: carry forward last known plan */
    const getExpPlan=(nm,m)=>{const items=expItemsFor(nm);const direct=items.find(x=>(x.month||'')===m);if(direct&&Number(direct.amount_plan)>0)return Number(direct.amount_plan);const prev=items.filter(x=>(x.month||'')<m&&Number(x.amount_plan)>0).sort((a,b)=>(b.month||'').localeCompare(a.month||''));return prev.length>0?Number(prev[0].amount_plan):0;};
    const getExpFact=(nm,m)=>{const it=expItemsFor(nm).find(x=>(x.month||'')===m);return it?Number(it.amount_fact)||0:0;};
    const getExpItem=(nm,m)=>expItemsFor(nm).find(x=>(x.month||'')===m);
    const saveExp=(nm,m,field,val)=>{const it=getExpItem(nm,m);if(it){store.updateKbBudgetItem(it.id,{[field]:Number(val)||0});}else if(Number(val)>0){store.addKbBudgetItem({name:nm,month:m,cf_type:expCfType(nm)||'OCF',amount_plan:field==='amount_plan'?Number(val):0,amount_fact:field==='amount_fact'?Number(val):0,notes:''});}};
    const expPlanMonth=(m,type)=>expNames.filter(nm=>expCfType(nm)===type).reduce((s,nm)=>s+getExpPlan(nm,m),0);
    /* Fact for expenses now comes from overhead_registry rg=КБ scope=company */
    const _ohReg=store.data.overhead_registry||[];
    const _kbRegComp=_ohReg.filter(e=>e.rg==='КБ'&&e.scope==='company');
    const expFactMonthReg=(m)=>Math.round(_kbRegComp.filter(e=>(e.date||'').startsWith(m)).reduce((s,e)=>s+Number(e.amount||0),0));
    const totOcfP=(m)=>salPlanForMonth(m,'OCF')+expPlanMonth(m,'OCF');
    const totOcfF=(m)=>salEffForMonth(m,'OCF')+expFactMonthReg(m);
    const totIcfP=(m)=>salPlanForMonth(m,'ICF')+expPlanMonth(m,'ICF');
    const totIcfF=(m)=>salEffForMonth(m,'ICF');
    const q3=(i)=>i%3===2;
    const _cs={v:{textAlign:'right',padding:'4px 5px',fontSize:11},t:{textAlign:'right',padding:'5px 6px',fontWeight:700,fontSize:11,background:'var(--bg2)'}};

    return <React.Fragment>
    <div className="dash-card" style={{padding:16,overflowX:'auto'}}>
      <div style={{fontSize:16,fontWeight:700,marginBottom:14}}>Бюджет КБ — {yr}</div>
      <table style={{width:'100%',fontSize:11,borderCollapse:'collapse'}}>
        <thead><tr style={{background:'var(--bg3)',borderBottom:'2px solid var(--border)'}}>
          <th style={{textAlign:'left',padding:'6px 8px',minWidth:180,fontSize:12}}>Показатель</th>
          {MFULL.map((m,i)=><th key={i} style={{textAlign:'right',padding:'5px 5px',minWidth:64,background:q3(i)?'var(--bg2)':'',fontSize:11}}>{MONTHS[i]}</th>)}
          <th style={{textAlign:'right',padding:'5px 6px',fontWeight:700,background:'var(--accent)',color:'#fff',minWidth:70}}>Итого</th>
        </tr></thead>
        <tbody>
          {/* ═══ SALARIES ═══ */}
          <tr><td colSpan={MFULL.length+2} style={{padding:'10px 8px 4px',fontWeight:700,fontSize:13,color:'var(--accent)',borderTop:'2px solid var(--accent)',letterSpacing:.5}}>ЗАРПЛАТЫ</td></tr>

          <tr><td style={{padding:'4px 8px',fontWeight:600,color:'var(--text2)',fontSize:11}}>ЗП OCF (план)</td>
            {MFULL.map((m,i)=>{const v=Math.round(salPlanForMonth(m,'OCF'));return <td key={i} style={{..._cs.v,color:'var(--text2)',fontSize:10,background:q3(i)?'var(--bg2)':''}}>{v>0?fmt(v):''}</td>;})}
            <td style={{..._cs.t,color:'var(--text2)'}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+salPlanForMonth(m,'OCF'),0)))}</td></tr>
          <tr style={{background:'rgba(0,200,100,.05)'}}><td style={{padding:'4px 8px',fontWeight:700,fontSize:12}}>ЗП OCF (факт)</td>
            {MFULL.map((m,i)=>{const vP=Math.round(salPlanForMonth(m,'OCF'));const vE=Math.round(salEffForMonth(m,'OCF'));const d=vE!==vP;return <td key={i} style={{..._cs.v,fontWeight:d?700:400,color:d?'var(--green)':'',background:q3(i)?'var(--bg2)':''}}>{vE>0?fmt(vE):''}</td>;})}
            <td style={_cs.t}>{fmt(Math.round(MFULL.reduce((s,m)=>s+salEffForMonth(m,'OCF'),0)))}</td></tr>
          {kbPersons.filter(pe=>!pe.is_investment_employee).map(pe=>{const ct='SALARY_OCF';return <tr key={pe.id} style={{background:'rgba(100,100,200,.02)'}}>
            <td style={{padding:'3px 8px',paddingLeft:20,fontSize:11,color:'var(--text2)'}}>{pe.name}{pe.hire_date&&<span style={{fontSize:9,marginLeft:4}}>с {pe.hire_date.slice(5)}</span>}</td>
            {MFULL.map((m,i)=>{const plan=kbPersonActive(pe,m)?Math.round(getPersonMonthSalary(pe,m)):0;const ovr=kbItems.find(x=>x.person_id===pe.id&&(x.month||'')===m&&x.cf_type===ct);const hf=ovr&&(Number(ovr.amount_fact)||0)>0;const fact=hf?Number(ovr.amount_fact):0;return <td key={i} style={{textAlign:'right',padding:'2px 4px',background:q3(i)?'var(--bg2)':'',verticalAlign:'top'}}>
              {plan>0&&<div><div style={{fontSize:9,color:'var(--text2)',textDecoration:hf?'line-through':'none',lineHeight:'13px'}}>{fmt(plan)}</div>
              <input type="number" key={ovr?ovr.id+'-'+(ovr.amount_fact||''):'e-'+pe.id+'-'+m} defaultValue={hf?fact:''} placeholder="—" style={{width:58,fontSize:10,padding:'2px 4px',border:'1px solid '+(hf?'var(--green)':'var(--border)'),borderRadius:3,textAlign:'right',background:hf?'rgba(0,200,100,.08)':'transparent',marginTop:1}} onBlur={e=>{const v=Number(e.target.value)||0;if(v>0){if(ovr){store.updateKbBudgetItem(ovr.id,{amount_fact:v});}else{store.addKbBudgetItem({name:'ЗП '+pe.name,person_id:pe.id,amount_plan:plan,amount_fact:v,month:m,cf_type:ct,notes:''});}}else if(ovr){store.deleteKbBudgetItem(ovr.id);}}} onKeyDown={e=>{if(e.key==='Enter')e.target.blur();}}/></div>}
            </td>;})}
            <td style={{..._cs.t,fontSize:10}}>{(()=>{let tP=0,tE=0;MFULL.forEach(m2=>{if(!kbPersonActive(pe,m2))return;const p2=getPersonMonthSalary(pe,m2);const o2=kbItems.find(x=>x.person_id===pe.id&&(x.month||'')===m2&&x.cf_type===ct);tP+=p2;tE+=(o2&&Number(o2.amount_fact)>0)?Number(o2.amount_fact):p2;});return tE!==Math.round(tP)?<span><span style={{textDecoration:'line-through',fontSize:8,color:'var(--text2)'}}>{fmt(Math.round(tP))}</span><br/>{fmt(Math.round(tE))}</span>:fmt(Math.round(tP));})()}</td>
          </tr>;})}

          {kbPersons.some(pe=>!!pe.is_investment_employee)&&<React.Fragment>
          <tr><td style={{padding:'4px 8px',fontWeight:600,color:'var(--sky)',fontSize:11}}>ЗП ICF (план)</td>
            {MFULL.map((m,i)=>{const v=Math.round(salPlanForMonth(m,'ICF'));return <td key={i} style={{..._cs.v,color:'var(--sky)',opacity:.7,fontSize:10,background:q3(i)?'var(--bg2)':''}}>{v>0?fmt(v):''}</td>;})}
            <td style={{..._cs.t,color:'var(--sky)',opacity:.7}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+salPlanForMonth(m,'ICF'),0)))}</td></tr>
          <tr style={{background:'rgba(0,150,255,.05)'}}><td style={{padding:'4px 8px',fontWeight:700,color:'var(--sky)',fontSize:12}}>ЗП ICF (факт)</td>
            {MFULL.map((m,i)=>{const vP=Math.round(salPlanForMonth(m,'ICF'));const vE=Math.round(salEffForMonth(m,'ICF'));const d=vE!==vP;return <td key={i} style={{..._cs.v,fontWeight:d?700:400,color:'var(--sky)',background:q3(i)?'var(--bg2)':''}}>{vE>0?fmt(vE):''}</td>;})}
            <td style={{..._cs.t,color:'var(--sky)'}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+salEffForMonth(m,'ICF'),0)))}</td></tr>
          {kbPersons.filter(pe=>!!pe.is_investment_employee).map(pe=>{const ct='SALARY_ICF';return <tr key={pe.id} style={{background:'rgba(100,150,255,.02)'}}>
            <td style={{padding:'3px 8px',paddingLeft:20,fontSize:11,color:'var(--sky)'}}>{pe.name}{pe.hire_date&&<span style={{fontSize:9,color:'var(--text2)',marginLeft:4}}>с {pe.hire_date.slice(5)}</span>}</td>
            {MFULL.map((m,i)=>{const plan=kbPersonActive(pe,m)?Math.round(getPersonMonthSalary(pe,m)):0;const ovr=kbItems.find(x=>x.person_id===pe.id&&(x.month||'')===m&&x.cf_type===ct);const hf=ovr&&(Number(ovr.amount_fact)||0)>0;const fact=hf?Number(ovr.amount_fact):0;return <td key={i} style={{textAlign:'right',padding:'2px 4px',background:q3(i)?'var(--bg2)':'',verticalAlign:'top'}}>
              {plan>0&&<div><div style={{fontSize:9,color:'var(--sky)',opacity:.6,textDecoration:hf?'line-through':'none',lineHeight:'13px'}}>{fmt(plan)}</div>
              <input type="number" key={ovr?ovr.id+'-'+(ovr.amount_fact||''):'e-'+pe.id+'-'+m} defaultValue={hf?fact:''} placeholder="—" style={{width:58,fontSize:10,padding:'2px 4px',border:'1px solid '+(hf?'var(--sky)':'var(--border)'),borderRadius:3,textAlign:'right',background:hf?'rgba(0,150,255,.08)':'transparent',marginTop:1}} onBlur={e=>{const v=Number(e.target.value)||0;if(v>0){if(ovr){store.updateKbBudgetItem(ovr.id,{amount_fact:v});}else{store.addKbBudgetItem({name:'ЗП '+pe.name,person_id:pe.id,amount_plan:plan,amount_fact:v,month:m,cf_type:ct,notes:''});}}else if(ovr){store.deleteKbBudgetItem(ovr.id);}}} onKeyDown={e=>{if(e.key==='Enter')e.target.blur();}}/></div>}
            </td>;})}
            <td style={{..._cs.t,fontSize:10,color:'var(--sky)'}}>{(()=>{let tP=0,tE=0;MFULL.forEach(m2=>{if(!kbPersonActive(pe,m2))return;const p2=getPersonMonthSalary(pe,m2);const o2=kbItems.find(x=>x.person_id===pe.id&&(x.month||'')===m2&&x.cf_type===ct);tP+=p2;tE+=(o2&&Number(o2.amount_fact)>0)?Number(o2.amount_fact):p2;});return tE!==Math.round(tP)?<span><span style={{textDecoration:'line-through',fontSize:8,opacity:.5}}>{fmt(Math.round(tP))}</span><br/>{fmt(Math.round(tE))}</span>:fmt(Math.round(tP));})()}</td>
          </tr>;})}
          </React.Fragment>}

          {/* ═══ EXPENSES — driven by overhead_registry rg=КБ ═══ */}
          <tr><td colSpan={MFULL.length+2} style={{padding:'12px 8px 4px',fontWeight:700,fontSize:13,color:'var(--violet)',borderTop:'2px solid var(--violet)',letterSpacing:.5}}>ПРОЧИЕ РАСХОДЫ</td></tr>
          {(()=>{
            const ohReg=store.data.overhead_registry||[];
            const kbReg=ohReg.filter(e=>e.rg==='КБ'&&e.scope==='company');
            const regCats=[...new Set(kbReg.map(e=>normCat(e.category)).filter(Boolean))].sort();
            /* Merge with expNames from kb_budget for plan rows that may not have registry entries yet */
            const allCats=[...new Set([...regCats,...expNames])].sort();
            const regFactByCat=(cat,m)=>Math.round(kbReg.filter(e=>normCat(e.category)===cat&&(e.date||'').startsWith(m)).reduce((s,e)=>s+Number(e.amount||0),0));
            const regFactByCatTotal=(cat)=>Math.round(MFULL.reduce((s,m)=>s+regFactByCat(cat,m),0));
            return <React.Fragment>
            {allCats.map(cat=>{
              const factTotal=regFactByCatTotal(cat);
              const planTotal=Math.round(MFULL.reduce((s,m)=>s+getExpPlan(cat,m),0));
              const isExpanded=kbDrillCat===cat;
              /* Classes within this category */
              const catClasses=[...new Set(kbReg.filter(e=>normCat(e.category)===cat).map(e=>e.cls).filter(Boolean))].sort();
              return <React.Fragment key={cat}>
                <tr style={{background:'rgba(100,100,200,.02)'}}>
                  <td style={{padding:'4px 8px',fontWeight:600,fontSize:11}}>
                    <span style={{cursor:'pointer',userSelect:'none'}} onClick={()=>setKbDrillCat(isExpanded?null:cat)} title="Раскрыть классы">{isExpanded?'▼':'▶'} {cat}</span>
                    <span style={{fontSize:9,marginLeft:4,opacity:.6}}>OCF</span>
                    {expNames.includes(cat)&&<span style={{fontSize:10,marginLeft:6,color:'var(--red)',cursor:'pointer',opacity:.4}} onClick={()=>{if(confirm('Удалить план «'+cat+'»?'))expItemsFor(cat).forEach(it=>store.deleteKbBudgetItem(it.id));}} title="Удалить план">✕</span>}
                  </td>
                  {MFULL.map((m,i)=>{
                    const plan=getExpPlan(cat,m);const fact=regFactByCat(cat,m);const it=getExpItem(cat,m);const isSpread=plan>0&&(!it||!Number(it.amount_plan));
                    return <td key={i} style={{textAlign:'right',padding:'2px 4px',background:q3(i)?'var(--bg2)':'',verticalAlign:'top'}}>
                      <div>
                        <input type="number" key={'p-'+cat+'-'+m+'-'+(it?it.amount_plan:'')} defaultValue={it&&Number(it.amount_plan)?Number(it.amount_plan):''} placeholder={plan>0?fmt(plan):'план'} title={isSpread?'Авто из предыдущего месяца':'Прямое значение'} style={{width:58,fontSize:9,padding:'1px 3px',border:'1px dashed var(--border)',borderRadius:3,textAlign:'right',background:'transparent',color:isSpread?'var(--text2)':'',fontStyle:isSpread?'italic':'normal'}} onBlur={e=>{saveExp(cat,m,'amount_plan',e.target.value);}} onKeyDown={e=>{if(e.key==='Enter')e.target.blur();}}/>
                        <div style={{fontSize:10,fontWeight:fact>0?600:400,color:fact>0?'var(--green)':'var(--text2)',padding:'2px 4px',textAlign:'right',marginTop:1,background:fact>0?'rgba(0,200,100,.08)':'transparent',borderRadius:3,minHeight:18}}>{fact>0?fmt(fact):'—'}</div>
                      </div>
                    </td>;
                  })}
                  <td style={_cs.t}><div style={{fontSize:9,color:'var(--text2)'}}>{planTotal>0?fmt(planTotal):'—'}</div><div style={{color:factTotal>0?'var(--green)':'var(--text2)'}}>{factTotal>0?fmt(factTotal):'—'}</div></td>
                </tr>
                {/* Drill-down: classes within category */}
                {isExpanded&&catClasses.map(cls=>{
                  const clsFact=(m2)=>Math.round(kbReg.filter(e=>normCat(e.category)===cat&&e.cls===cls&&(e.date||'').startsWith(m2)).reduce((s,e)=>s+Number(e.amount||0),0));
                  const clsTotal=Math.round(MFULL.reduce((s,m2)=>s+clsFact(m2),0));
                  return <tr key={cat+'-'+cls} style={{background:'rgba(156,39,176,0.04)'}}>
                    <td style={{padding:'2px 8px 2px 28px',fontSize:10,color:'var(--text2)',fontStyle:'italic'}}>↳ {cls}</td>
                    {MFULL.map((m2,i2)=>{const v=clsFact(m2);return <td key={i2} style={{textAlign:'right',padding:'2px 4px',fontSize:10,color:v>0?'var(--violet)':'var(--text2)',background:q3(i2)?'var(--bg2)':''}}>{v>0?fmt(v):'—'}</td>;})}
                    <td style={{..._cs.t,fontSize:10,color:'var(--violet)'}}>{clsTotal>0?fmt(clsTotal):'—'}</td>
                  </tr>;
                })}
                {isExpanded&&catClasses.length===0&&<tr><td colSpan={MFULL.length+2} style={{padding:'3px 28px',fontSize:10,color:'var(--text2)',fontStyle:'italic'}}>Нет данных по классам в реестре</td></tr>}
              </React.Fragment>;
            })}
            {/* Σ Total fact from registry КБ only */}
            <tr style={{borderTop:'2px solid var(--violet)',background:'rgba(156,39,176,0.06)'}}>
              <td style={{padding:'5px 8px',fontWeight:700,fontSize:12,color:'var(--violet)'}}>Σ Прочие расходы КБ (факт)</td>
              {MFULL.map((m,i)=>{const v=Math.round(kbReg.filter(e=>(e.date||'').startsWith(m)).reduce((s,e)=>s+Number(e.amount||0),0));return <td key={i} style={{textAlign:'right',padding:'5px 5px',fontWeight:700,fontSize:11,color:v>0?'var(--violet)':'var(--text2)',background:q3(i)?'var(--bg2)':''}}>{v>0?fmt(v):'—'}</td>;})}
              <td style={{..._cs.t,color:'var(--violet)',fontSize:12}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+kbReg.filter(e=>(e.date||'').startsWith(m)).reduce((s2,e)=>s2+Number(e.amount||0),0),0)))}</td>
            </tr>
            </React.Fragment>;
          })()}
          <tr><td colSpan={MFULL.length+2} style={{padding:'8px 8px'}}>
            <div style={{display:'flex',gap:8,alignItems:'center'}}>
              <input value={kbForm.name} onChange={e=>setKbForm(f=>({...f,name:e.target.value}))} style={{fontSize:12,padding:'5px 10px',border:'1px solid var(--border)',borderRadius:5,width:180}} placeholder="Новая статья расходов..."/>
              <select value={kbForm.cf_type} onChange={e=>setKbForm(f=>({...f,cf_type:e.target.value}))} style={{fontSize:12,padding:'5px 8px',border:'1px solid var(--border)',borderRadius:5}}>
                <option value="OCF">OCF</option><option value="ICF">ICF</option>
              </select>
              <input type="number" value={kbForm.amount_plan} onChange={e=>setKbForm(f=>({...f,amount_plan:e.target.value}))} style={{fontSize:12,padding:'5px 10px',border:'1px solid var(--border)',borderRadius:5,width:100}} placeholder="План/мес"/>
              <button className="btn btn-primary btn-sm" style={{padding:'5px 16px',fontSize:12}} onClick={()=>{if(!kbForm.name.trim())return;store.addKbBudgetItem({name:kbForm.name.trim(),month:MFULL[0],cf_type:kbForm.cf_type,amount_plan:Number(kbForm.amount_plan)||0,amount_fact:0,notes:''});setKbForm(f=>({...f,name:'',amount_plan:''}));}}>+ Добавить</button>
            </div>
          </td></tr>

          {/* ═══ TOTALS ═══ */}
          <tr><td colSpan={MFULL.length+2} style={{height:3,background:'var(--border)'}}></td></tr>
          <tr><td style={{padding:'4px 8px',fontWeight:600,color:'var(--text2)',fontSize:11}}>Итого OCF (план)</td>
            {MFULL.map((m,i)=>{const v=Math.round(totOcfP(m));return <td key={i} style={{..._cs.v,color:'var(--text2)',fontSize:10,background:q3(i)?'var(--bg2)':''}}>{v>0?fmt(v):''}</td>;})}
            <td style={{..._cs.t,color:'var(--text2)'}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+totOcfP(m),0)))}</td></tr>
          <tr style={{background:'rgba(0,200,100,.06)'}}><td style={{padding:'5px 8px',fontWeight:700,fontSize:12}}>Итого OCF (факт)</td>
            {MFULL.map((m,i)=>{const p2=Math.round(totOcfP(m));const f2=Math.round(totOcfF(m));const d=f2!==p2;return <td key={i} style={{..._cs.v,fontWeight:600,color:d?'var(--green)':'',background:q3(i)?'var(--bg2)':''}}>{f2>0?fmt(f2):''}</td>;})}
            <td style={_cs.t}>{fmt(Math.round(MFULL.reduce((s,m)=>s+totOcfF(m),0)))}</td></tr>
          <tr><td style={{padding:'4px 8px',fontWeight:600,color:'var(--sky)',fontSize:11,opacity:.7}}>Итого ICF (план)</td>
            {MFULL.map((m,i)=>{const v=Math.round(totIcfP(m));return <td key={i} style={{..._cs.v,color:'var(--sky)',opacity:.7,fontSize:10,background:q3(i)?'var(--bg2)':''}}>{v>0?fmt(v):''}</td>;})}
            <td style={{..._cs.t,color:'var(--sky)',opacity:.7}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+totIcfP(m),0)))}</td></tr>
          <tr style={{background:'rgba(0,150,255,.06)'}}><td style={{padding:'5px 8px',fontWeight:700,color:'var(--sky)',fontSize:12}}>Итого ICF (факт)</td>
            {MFULL.map((m,i)=>{const p2=Math.round(totIcfP(m));const f2=Math.round(totIcfF(m));const d=f2!==p2;return <td key={i} style={{..._cs.v,fontWeight:600,color:'var(--sky)',background:q3(i)?'var(--bg2)':''}}>{f2>0?fmt(f2):''}</td>;})}
            <td style={{..._cs.t,color:'var(--sky)'}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+totIcfF(m),0)))}</td></tr>
          <tr style={{background:'var(--bg3)',borderTop:'2px solid var(--border)'}}><td style={{padding:'7px 8px',fontWeight:700,fontSize:14}}>ВСЕГО КБ</td>
            {MFULL.map((m,i)=>{const v=Math.round(totOcfF(m)+totIcfF(m));return <td key={i} style={{textAlign:'right',padding:'7px 6px',fontWeight:700,fontSize:12,background:q3(i)?'var(--bg2)':''}}>{v>0?fmt(v):''}</td>;})}
            <td style={{textAlign:'right',padding:'7px 6px',fontWeight:700,fontSize:13,background:'var(--accent)',color:'#fff'}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+totOcfF(m)+totIcfF(m),0)))}</td></tr>
        </tbody>
      </table>
    </div>
    </React.Fragment>;
  })()}

  {fmTab==='hr_budget'&&(()=>{
    /*
     * ══════════════════════════════════════════════════════════════════
     * БЮДЖЕТ HR
     * МАРШРУТ ДАННЫХ HR (УТВЕРЖДЕНО):
     * Единственный штатный маршрут внесения ФАКТА прочих расходов HR:
     *   1. Создать операцию во вкладке «Общие накладные» (overhead_registry)
     *      с указанием rg='HR', даты, суммы, категории, класса и т.д.
     *   2. Факт автоматически подтягивается в Бюджет HR → Прочие расходы
     *      через подсчёт из overhead_registry (rg='HR', scope='company').
     * ══════════════════════════════════════════════════════════════════
     */
    const hrItems=store.data.hr_budget||[];
    const hrPersons=persons.filter(p=>getPersonDepts(p).includes('HR')&&(p.salary_monthly||0)>0);
    const hrPersonActive=(pe,m)=>{const hd=pe.hire_date||'';const fd=pe.fire_date||'';const ms=m+'-01';const me=m+'-31';if(hd&&hd>me)return false;if(fd&&fd<ms)return false;return true;};
    const hrSalPlan=(m)=>hrPersons.filter(pe=>hrPersonActive(pe,m)).reduce((s,pe)=>s+getPersonMonthSalary(pe,m),0);
    const hrSalFact=(m)=>hrPersons.filter(pe=>hrPersonActive(pe,m)).reduce((s,pe)=>{const ovr=hrItems.find(x=>x.person_id===pe.id&&(x.month||'')===m&&x.cf_type==='SALARY_OCF');return s+((ovr&&Number(ovr.amount_fact)>0)?Number(ovr.amount_fact):getPersonMonthSalary(pe,m));},0);
    /* Expense items — exclude salary overrides */
    const hrExpItems=hrItems.filter(x=>!x.person_id&&x.cf_type!=='SALARY_OCF');
    const hrExpNames=[...new Set(hrExpItems.map(x=>x.name).filter(Boolean))];
    const hrExpItemsFor=(nm)=>hrExpItems.filter(x=>x.name===nm);
    const getHrExpPlan=(nm,m)=>{const items=hrExpItemsFor(nm);const direct=items.find(x=>(x.month||'')===m);if(direct&&Number(direct.amount_plan)>0)return Number(direct.amount_plan);const prev=items.filter(x=>(x.month||'')<m&&Number(x.amount_plan)>0).sort((a,b)=>(b.month||'').localeCompare(a.month||''));return prev.length>0?Number(prev[0].amount_plan):0;};
    const getHrExpItem=(nm,m)=>hrExpItemsFor(nm).find(x=>(x.month||'')===m);
    const saveHrExp=(nm,m,field,val)=>{const it=getHrExpItem(nm,m);if(it){store.updateHrBudgetItem(it.id,{[field]:Number(val)||0});}else if(Number(val)>0){store.addHrBudgetItem({name:nm,month:m,cf_type:'OCF',amount_plan:field==='amount_plan'?Number(val):0,amount_fact:field==='amount_fact'?Number(val):0,notes:''});}};
    const hrExpPlanMonth=(m)=>hrExpNames.reduce((s,nm)=>s+getHrExpPlan(nm,m),0);
    /* Fact for expenses from overhead_registry rg=HR */
    const _ohReg=store.data.overhead_registry||[];
    const _hrRegComp=_ohReg.filter(e=>e.rg==='HR'&&e.scope==='company');
    const hrExpFactMonthReg=(m)=>Math.round(_hrRegComp.filter(e=>(e.date||'').startsWith(m)).reduce((s,e)=>s+Number(e.amount||0),0));
    const hrTotP=(m)=>hrSalPlan(m)+hrExpPlanMonth(m);
    const hrTotF=(m)=>hrSalFact(m)+hrExpFactMonthReg(m);
    const q3=(i)=>i%3===2;
    const _cs={v:{textAlign:'right',padding:'4px 5px',fontSize:11},t:{textAlign:'right',padding:'5px 6px',fontWeight:700,fontSize:11,background:'var(--bg2)'}};

    return <React.Fragment>
    <div className="dash-card" style={{padding:16,overflowX:'auto'}}>
      <div style={{fontSize:16,fontWeight:700,marginBottom:14}}>Бюджет HR — {yr}</div>
      <table style={{width:'100%',fontSize:11,borderCollapse:'collapse'}}>
        <thead><tr style={{background:'var(--bg3)',borderBottom:'2px solid var(--border)'}}>
          <th style={{textAlign:'left',padding:'6px 8px',minWidth:180,fontSize:12}}>Показатель</th>
          {MFULL.map((m,i)=><th key={i} style={{textAlign:'right',padding:'5px 5px',minWidth:64,background:q3(i)?'var(--bg2)':'',fontSize:11}}>{MONTHS[i]}</th>)}
          <th style={{textAlign:'right',padding:'5px 6px',fontWeight:700,background:'var(--emerald)',color:'#fff',minWidth:70}}>Итого</th>
        </tr></thead>
        <tbody>
          {/* ═══ SALARIES ═══ */}
          <tr><td colSpan={MFULL.length+2} style={{padding:'10px 8px 4px',fontWeight:700,fontSize:13,color:'var(--emerald)',borderTop:'2px solid var(--emerald)',letterSpacing:.5}}>ЗАРПЛАТЫ HR</td></tr>

          <tr><td style={{padding:'4px 8px',fontWeight:600,color:'var(--text2)',fontSize:11}}>ЗП HR (план)</td>
            {MFULL.map((m,i)=>{const v=Math.round(hrSalPlan(m));return <td key={i} style={{..._cs.v,color:'var(--text2)',fontSize:10,background:q3(i)?'var(--bg2)':''}}>{v>0?fmt(v):''}</td>;})}
            <td style={{..._cs.t,color:'var(--text2)'}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+hrSalPlan(m),0)))}</td></tr>
          <tr style={{background:'rgba(0,200,100,.05)'}}><td style={{padding:'4px 8px',fontWeight:700,fontSize:12}}>ЗП HR (факт)</td>
            {MFULL.map((m,i)=>{const vP=Math.round(hrSalPlan(m));const vE=Math.round(hrSalFact(m));const d=vE!==vP;return <td key={i} style={{..._cs.v,fontWeight:d?700:400,color:d?'var(--green)':'',background:q3(i)?'var(--bg2)':''}}>{vE>0?fmt(vE):''}</td>;})}
            <td style={_cs.t}>{fmt(Math.round(MFULL.reduce((s,m)=>s+hrSalFact(m),0)))}</td></tr>
          {hrPersons.map(pe=>{const ct='SALARY_OCF';return <tr key={pe.id} style={{background:'rgba(100,100,200,.02)'}}>
            <td style={{padding:'3px 8px',paddingLeft:20,fontSize:11,color:'var(--text2)'}}>{pe.name}{pe.hire_date&&<span style={{fontSize:9,marginLeft:4}}>с {pe.hire_date.slice(5)}</span>}</td>
            {MFULL.map((m,i)=>{const plan=hrPersonActive(pe,m)?Math.round(getPersonMonthSalary(pe,m)):0;const ovr=hrItems.find(x=>x.person_id===pe.id&&(x.month||'')===m&&x.cf_type===ct);const hf=ovr&&(Number(ovr.amount_fact)||0)>0;const fact=hf?Number(ovr.amount_fact):0;return <td key={i} style={{textAlign:'right',padding:'2px 4px',background:q3(i)?'var(--bg2)':'',verticalAlign:'top'}}>
              {plan>0&&<div><div style={{fontSize:9,color:'var(--text2)',textDecoration:hf?'line-through':'none',lineHeight:'13px'}}>{fmt(plan)}</div>
              <input type="number" key={ovr?ovr.id+'-'+(ovr.amount_fact||''):'e-'+pe.id+'-'+m} defaultValue={hf?fact:''} placeholder="—" style={{width:58,fontSize:10,padding:'2px 4px',border:'1px solid '+(hf?'var(--green)':'var(--border)'),borderRadius:3,textAlign:'right',background:hf?'rgba(0,200,100,.08)':'transparent',marginTop:1}} onBlur={e=>{const v=Number(e.target.value)||0;if(v>0){if(ovr){store.updateHrBudgetItem(ovr.id,{amount_fact:v});}else{store.addHrBudgetItem({name:'ЗП '+pe.name,person_id:pe.id,amount_plan:plan,amount_fact:v,month:m,cf_type:ct,notes:''});}}else if(ovr){store.deleteHrBudgetItem(ovr.id);}}} onKeyDown={e=>{if(e.key==='Enter')e.target.blur();}}/></div>}
            </td>;})}
            <td style={{..._cs.t,fontSize:10}}>{(()=>{let tP=0,tE=0;MFULL.forEach(m2=>{if(!hrPersonActive(pe,m2))return;const p2=getPersonMonthSalary(pe,m2);const o2=hrItems.find(x=>x.person_id===pe.id&&(x.month||'')===m2&&x.cf_type===ct);tP+=p2;tE+=(o2&&Number(o2.amount_fact)>0)?Number(o2.amount_fact):p2;});return tE!==Math.round(tP)?<span><span style={{textDecoration:'line-through',fontSize:8,color:'var(--text2)'}}>{fmt(Math.round(tP))}</span><br/>{fmt(Math.round(tE))}</span>:fmt(Math.round(tP));})()}</td>
          </tr>;})}

          {/* ═══ EXPENSES — driven by overhead_registry rg=HR ═══ */}
          <tr><td colSpan={MFULL.length+2} style={{padding:'12px 8px 4px',fontWeight:700,fontSize:13,color:'var(--violet)',borderTop:'2px solid var(--violet)',letterSpacing:.5}}>ПРОЧИЕ РАСХОДЫ HR</td></tr>
          {(()=>{
            const ohReg=store.data.overhead_registry||[];
            const hrReg=ohReg.filter(e=>e.rg==='HR'&&e.scope==='company');
            const regCats=[...new Set(hrReg.map(e=>e.category).filter(Boolean))].sort();
            const allCats=[...new Set([...regCats,...hrExpNames])].sort();
            const regFactByCat=(cat,m)=>Math.round(hrReg.filter(e=>e.category===cat&&(e.date||'').startsWith(m)).reduce((s,e)=>s+Number(e.amount||0),0));
            const regFactByCatTotal=(cat)=>Math.round(MFULL.reduce((s,m)=>s+regFactByCat(cat,m),0));
            return <React.Fragment>
            {allCats.map(cat=>{
              const factTotal=regFactByCatTotal(cat);
              const planTotal=Math.round(MFULL.reduce((s,m)=>s+getHrExpPlan(cat,m),0));
              const isExpanded=hrDrillCat===cat;
              const catClasses=[...new Set(hrReg.filter(e=>e.category===cat).map(e=>e.cls).filter(Boolean))].sort();
              return <React.Fragment key={cat}>
                <tr style={{background:'rgba(100,100,200,.02)'}}>
                  <td style={{padding:'4px 8px',fontWeight:600,fontSize:11}}>
                    <span style={{cursor:'pointer',userSelect:'none'}} onClick={()=>setHrDrillCat(isExpanded?null:cat)} title="Раскрыть классы">{isExpanded?'▼':'▶'} {cat}</span>
                    <span style={{fontSize:9,marginLeft:4,opacity:.6}}>OCF</span>
                    {hrExpNames.includes(cat)&&<span style={{fontSize:10,marginLeft:6,color:'var(--red)',cursor:'pointer',opacity:.4}} onClick={()=>{if(confirm('Удалить план «'+cat+'»?'))hrExpItemsFor(cat).forEach(it=>store.deleteHrBudgetItem(it.id));}} title="Удалить план">✕</span>}
                  </td>
                  {MFULL.map((m,i)=>{
                    const plan=getHrExpPlan(cat,m);const fact=regFactByCat(cat,m);const it=getHrExpItem(cat,m);const isSpread=plan>0&&(!it||!Number(it.amount_plan));
                    return <td key={i} style={{textAlign:'right',padding:'2px 4px',background:q3(i)?'var(--bg2)':'',verticalAlign:'top'}}>
                      <div>
                        <input type="number" key={'p-'+cat+'-'+m+'-'+(it?it.amount_plan:'')} defaultValue={it&&Number(it.amount_plan)?Number(it.amount_plan):''} placeholder={plan>0?fmt(plan):'план'} title={isSpread?'Авто из предыдущего месяца':'Прямое значение'} style={{width:58,fontSize:9,padding:'1px 3px',border:'1px dashed var(--border)',borderRadius:3,textAlign:'right',background:'transparent',color:isSpread?'var(--text2)':'',fontStyle:isSpread?'italic':'normal'}} onBlur={e=>{saveHrExp(cat,m,'amount_plan',e.target.value);}} onKeyDown={e=>{if(e.key==='Enter')e.target.blur();}}/>
                        <div style={{fontSize:10,fontWeight:fact>0?600:400,color:fact>0?'var(--green)':'var(--text2)',padding:'2px 4px',textAlign:'right',marginTop:1,background:fact>0?'rgba(0,200,100,.08)':'transparent',borderRadius:3,minHeight:18}}>{fact>0?fmt(fact):'—'}</div>
                      </div>
                    </td>;
                  })}
                  <td style={_cs.t}><div style={{fontSize:9,color:'var(--text2)'}}>{planTotal>0?fmt(planTotal):'—'}</div><div style={{color:factTotal>0?'var(--green)':'var(--text2)'}}>{factTotal>0?fmt(factTotal):'—'}</div></td>
                </tr>
                {isExpanded&&catClasses.map(cls=>{
                  const clsFact=(m2)=>Math.round(hrReg.filter(e=>e.category===cat&&e.cls===cls&&(e.date||'').startsWith(m2)).reduce((s,e)=>s+Number(e.amount||0),0));
                  const clsTotal=Math.round(MFULL.reduce((s,m2)=>s+clsFact(m2),0));
                  return <tr key={cat+'-'+cls} style={{background:'rgba(16,185,129,0.04)'}}>
                    <td style={{padding:'2px 8px 2px 28px',fontSize:10,color:'var(--text2)',fontStyle:'italic'}}>↳ {cls}</td>
                    {MFULL.map((m2,i2)=>{const v=clsFact(m2);return <td key={i2} style={{textAlign:'right',padding:'2px 4px',fontSize:10,color:v>0?'var(--emerald)':'var(--text2)',background:q3(i2)?'var(--bg2)':''}}>{v>0?fmt(v):'—'}</td>;})}
                    <td style={{..._cs.t,fontSize:10,color:'var(--emerald)'}}>{clsTotal>0?fmt(clsTotal):'—'}</td>
                  </tr>;
                })}
                {isExpanded&&catClasses.length===0&&<tr><td colSpan={MFULL.length+2} style={{padding:'3px 28px',fontSize:10,color:'var(--text2)',fontStyle:'italic'}}>Нет данных по классам в реестре</td></tr>}
              </React.Fragment>;
            })}
            {/* Σ Total fact from registry HR only */}
            <tr style={{borderTop:'2px solid var(--emerald)',background:'rgba(16,185,129,0.06)'}}>
              <td style={{padding:'5px 8px',fontWeight:700,fontSize:12,color:'var(--emerald)'}}>Σ Прочие расходы HR (факт)</td>
              {MFULL.map((m,i)=>{const v=Math.round(hrReg.filter(e=>(e.date||'').startsWith(m)).reduce((s,e)=>s+Number(e.amount||0),0));return <td key={i} style={{textAlign:'right',padding:'5px 5px',fontWeight:700,fontSize:11,color:v>0?'var(--emerald)':'var(--text2)',background:q3(i)?'var(--bg2)':''}}>{v>0?fmt(v):'—'}</td>;})}
              <td style={{..._cs.t,color:'var(--emerald)',fontSize:12}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+hrReg.filter(e=>(e.date||'').startsWith(m)).reduce((s2,e)=>s2+Number(e.amount||0),0),0)))}</td>
            </tr>
            </React.Fragment>;
          })()}
          <tr><td colSpan={MFULL.length+2} style={{padding:'8px 8px'}}>
            <div style={{display:'flex',gap:8,alignItems:'center'}}>
              <input value={hrForm.name} onChange={e=>setHrForm(f=>({...f,name:e.target.value}))} style={{fontSize:12,padding:'5px 10px',border:'1px solid var(--border)',borderRadius:5,width:180}} placeholder="Новая статья расходов HR..."/>
              <input type="number" value={hrForm.amount_plan} onChange={e=>setHrForm(f=>({...f,amount_plan:e.target.value}))} style={{fontSize:12,padding:'5px 10px',border:'1px solid var(--border)',borderRadius:5,width:100}} placeholder="План/мес"/>
              <button className="btn btn-primary btn-sm" style={{padding:'5px 16px',fontSize:12,background:'var(--emerald)'}} onClick={()=>{if(!hrForm.name.trim())return;store.addHrBudgetItem({name:hrForm.name.trim(),month:MFULL[0],cf_type:'OCF',amount_plan:Number(hrForm.amount_plan)||0,amount_fact:0,notes:''});setHrForm(f=>({...f,name:'',amount_plan:''}));}}>+ Добавить</button>
            </div>
          </td></tr>

          {/* ═══ TOTALS ═══ */}
          <tr><td colSpan={MFULL.length+2} style={{height:3,background:'var(--border)'}}></td></tr>
          <tr><td style={{padding:'4px 8px',fontWeight:600,color:'var(--text2)',fontSize:11}}>Итого HR (план)</td>
            {MFULL.map((m,i)=>{const v=Math.round(hrTotP(m));return <td key={i} style={{..._cs.v,color:'var(--text2)',fontSize:10,background:q3(i)?'var(--bg2)':''}}>{v>0?fmt(v):''}</td>;})}
            <td style={{..._cs.t,color:'var(--text2)'}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+hrTotP(m),0)))}</td></tr>
          <tr style={{background:'rgba(16,185,129,.06)'}}><td style={{padding:'5px 8px',fontWeight:700,fontSize:12,color:'var(--emerald)'}}>Итого HR (факт)</td>
            {MFULL.map((m,i)=>{const p2=Math.round(hrTotP(m));const f2=Math.round(hrTotF(m));const d=f2!==p2;return <td key={i} style={{..._cs.v,fontWeight:600,color:d?'var(--emerald)':'',background:q3(i)?'var(--bg2)':''}}>{f2>0?fmt(f2):''}</td>;})}
            <td style={{..._cs.t,color:'var(--emerald)'}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+hrTotF(m),0)))}</td></tr>
          <tr style={{background:'var(--bg3)',borderTop:'2px solid var(--border)'}}><td style={{padding:'7px 8px',fontWeight:700,fontSize:14}}>ВСЕГО HR</td>
            {MFULL.map((m,i)=>{const v=Math.round(hrTotF(m));return <td key={i} style={{textAlign:'right',padding:'7px 6px',fontWeight:700,fontSize:12,background:q3(i)?'var(--bg2)':''}}>{v>0?fmt(v):''}</td>;})}
            <td style={{textAlign:'right',padding:'7px 6px',fontWeight:700,fontSize:13,background:'var(--emerald)',color:'#fff'}}>{fmt(Math.round(MFULL.reduce((s,m)=>s+hrTotF(m),0)))}</td></tr>
        </tbody>
      </table>
    </div>
    </React.Fragment>;
  })()}

  {fmTab==='overheads'&&(()=>{
    /* ===== НАКЛАДНЫЕ — сводная таблица всех расходов по месяцам ===== */
    const _kb=store.data.kb_budget||[];
    const ohMonths=Array.from({length:12},(_,i)=>yr+'-'+String(i+1).padStart(2,'0'));

    /* --- ВСЕ категории расходов (сводка) --- */
    const allExpCategories=[
      {id:'fot',label:'ФОТ Производство',color:'var(--sky)',group:'salary',
        calc:m=>{let s=0;persons.filter(p=>p.grade!=='C5'&&!p.is_investment_employee&&getPersonDepts(p).includes('Производство')&&(p.salary_monthly||0)>0).forEach(p=>{s+=getPersonMonthSalary(p,m);});return Math.round(s);}},
      {id:'salaryKB',label:'ЗП КБ (Продажи и Маркетинг)',color:'var(--sky)',group:'salary',
        calc:m=>{let s=0;const ocfOv=_kb.filter(x=>x.cf_type==='SALARY_OCF'&&(x.month||'')===m);persons.filter(p=>!p.is_investment_employee&&getPersonDepts(p).includes('Продажи и Маркетинг')&&(p.salary_monthly||0)>0).forEach(p=>{const ov=ocfOv.find(x=>x.person_id===p.id);s+=(ov&&Number(ov.amount_fact)>0)?Number(ov.amount_fact):getPersonMonthSalary(p,m);});return Math.round(s);}},
      {id:'salaryHR',label:'ЗП HR',color:'var(--sky)',group:'salary',
        calc:m=>{let s=0;persons.filter(p=>getPersonDepts(p).includes('HR')&&(p.salary_monthly||0)>0).forEach(p=>{s+=getPersonMonthSalary(p,m);});return Math.round(s);}},
      {id:'salaryInvest',label:'ЗП инвест. сотрудники (ICF)',color:'var(--amber)',group:'salary',
        calc:m=>{let s=0;const icfOv=_kb.filter(x=>x.cf_type==='SALARY_ICF'&&(x.month||'')===m);persons.filter(p=>!!p.is_investment_employee&&getPersonDepts(p).includes('Продажи и Маркетинг')&&(p.salary_monthly||0)>0).forEach(p=>{const ov=icfOv.find(x=>x.person_id===p.id);s+=(ov&&Number(ov.amount_fact)>0)?Number(ov.amount_fact):getPersonMonthSalary(p,m);});return Math.round(s);}},
      {id:'costC5',label:'Косты C5 (партнёры)',color:'var(--red)',group:'salary',
        calc:m=>{let s=0;projects.filter(p=>p.project_type!=='ФК').forEach(p=>{(p.time_entries||[]).forEach(te=>{if((te.date||'').startsWith(m)){const per=persons.find(x=>x.id===te.person_id);if(per&&per.grade==='C5'){const oh=Number(per.office_hours)||8;const rate=oh>0?getPersonSalaryAtDate(per,te.date||m+'-15')/(oh*4.33):0;s+=rate*(Number(te.hours)||0);}}});});return Math.round(s);}},
      {id:'ohProj',label:'Накладные проектов (IB)',color:'var(--violet)',group:'overhead',
        calc:m=>{let s=0;const _or=store.data.overhead_registry||[];projects.filter(p=>p.project_type!=='ФК').forEach(p=>{(p.overheads||[]).forEach(x=>{if((x.date||'').startsWith(m)){const _regE=_or.find(r=>r.synced_oh_id===x.id);if(_regE&&_regE.prior_year)return;s+=(Number(x.amount)||0);}});});return Math.round(s);}},
      {id:'ohFK',label:'Накладные ФК',color:'var(--violet)',group:'overhead',
        calc:m=>{let s=0;const _or=store.data.overhead_registry||[];projects.filter(p=>p.project_type==='ФК').forEach(p=>{(p.overheads||[]).forEach(x=>{if((x.date||'').startsWith(m)){const _regE=_or.find(r=>r.synced_oh_id===x.id);if(_regE&&_regE.prior_year)return;s+=(Number(x.amount)||0);}});});return Math.round(s);}},
      {id:'expKB',label:'Расходы КБ (OCF)',color:'var(--amber)',group:'overhead',
        calc:m=>{const _or=store.data.overhead_registry||[];return Math.round(_or.filter(e=>e.rg==='КБ'&&e.scope==='company'&&!e.prior_year&&(e.date||'').startsWith(m)).reduce((s,e)=>s+Number(e.amount||0),0));}},
      {id:'officeRent',label:'Офис (аренда)',color:'var(--amber)',group:'overhead',
        calc:m=>{const _rentOvr=_kb.find(x=>x.cf_type==='OFFICE'&&(x.month||'')===m&&!x.person_id);return _rentOvr&&Number(_rentOvr.amount_plan)>0?Math.round(Number(_rentOvr.amount_plan)):1200000;}},
      {id:'aho',label:'АХО',color:'var(--teal)',group:'overhead',
        calc:m=>{const _or=store.data.overhead_registry||[];return Math.round(_or.filter(e=>e.rg==='АХО'&&e.scope==='company'&&!e.prior_year&&(e.date||'').startsWith(m)).reduce((s,e)=>s+Number(e.amount||0),0));}},
      {id:'expHR',label:'Расходы HR',color:'var(--emerald)',group:'overhead',
        calc:m=>{const _or=store.data.overhead_registry||[];return Math.round(_or.filter(e=>e.rg==='HR'&&e.scope==='company'&&!e.prior_year&&(e.date||'').startsWith(m)).reduce((s,e)=>s+Number(e.amount||0),0));}},
    ];
    const ohCategories=allExpCategories.filter(c=>c.group==='overhead');

    /* Вычисляем данные — ВСЕ расходы */
    const allData=allExpCategories.map(cat=>{
      const monthly=ohMonths.map(m=>cat.calc(m));
      const total=monthly.reduce((s,v)=>s+v,0);
      return {id:cat.id,label:cat.label,color:cat.color,group:cat.group,monthly,total};
    });
    const allGrandMonthly=ohMonths.map((_,i)=>allData.reduce((s,c)=>s+c.monthly[i],0));
    const allGrandTotal=allGrandMonthly.reduce((s,v)=>s+v,0);

    /* Только overheads */
    const ohData=allData.filter(c=>c.group==='overhead');
    const ohGrandMonthly=ohMonths.map((_,i)=>ohData.reduce((s,c)=>s+c.monthly[i],0));
    const ohGrandTotal=ohGrandMonthly.reduce((s,v)=>s+v,0);

    /* Drill-down helper */
    const ohDrillDown=(catId,monthIdx)=>{
      const mPfx=ohMonths[monthIdx];const lbl=allExpCategories.find(c=>c.id===catId)?.label||catId;
      openDrill(catId,lbl+' — '+MONTHS[monthIdx],[mPfx]);
    };

    /* Render table helper */
    const renderOhTable=(data,grandM,grandT,title,subtitle)=><div className="dash-card" style={{padding:12,overflowX:'auto',marginBottom:16}}>
      <div style={{fontSize:14,fontWeight:700,marginBottom:4,color:'var(--accent2)'}}>{title} — {yr}</div>
      {subtitle&&<div style={{fontSize:11,color:'var(--text2)',marginBottom:10}}>{subtitle}</div>}
      <table style={{width:'100%',fontSize:11,borderCollapse:'collapse'}}>
        <thead><tr style={{background:'var(--bg3)'}}>
          <th style={{textAlign:'left',padding:'5px 8px',minWidth:200,fontSize:12}}>Категория</th>
          <th style={{textAlign:'right',padding:'5px 6px',fontWeight:700,background:'var(--accent)',color:'#fff',fontSize:11}}>Итого</th>
          {ohMonths.map((m,i)=><th key={i} style={{textAlign:'right',padding:'5px 4px',fontSize:10}}>{MONTHS[i]}</th>)}
        </tr></thead>
        <tbody>
          {data.map((cat,ci)=><tr key={cat.id} style={ci%2===0?{background:'var(--bg1)'}:{}}>
            <td style={{padding:'4px 8px',fontWeight:500,color:cat.color,whiteSpace:'nowrap'}}>
              <span style={{display:'inline-block',width:8,height:8,borderRadius:'50%',background:cat.color,marginRight:6,verticalAlign:'middle'}}></span>
              {cat.label}
            </td>
            <td style={{textAlign:'right',padding:'4px 6px',fontWeight:700,background:'var(--bg3)',cursor:'pointer'}} onClick={()=>openDrill(cat.id,cat.label+' — Итого',ohMonths)}>{fmt(cat.total)}</td>
            {cat.monthly.map((v,i)=><td key={i} style={{textAlign:'right',padding:'4px 4px',color:v>0?'':'var(--text2)',cursor:v>0?'pointer':'default'}} onClick={()=>{if(v>0)ohDrillDown(cat.id,i);}}>{v>0?fmt(v):'—'}</td>)}
          </tr>)}
          <tr style={{borderTop:'2px solid var(--accent2)',fontWeight:700,background:'var(--bg3)'}}>
            <td style={{padding:'5px 8px',fontSize:12}}>ИТОГО</td>
            <td style={{textAlign:'right',padding:'5px 6px',fontSize:12,color:'var(--red)'}}>{fmt(grandT)}</td>
            {grandM.map((v,i)=><td key={i} style={{textAlign:'right',padding:'5px 4px',color:'var(--red)'}}>{fmt(v)}</td>)}
          </tr>
        </tbody>
      </table>
    </div>;

    return <div>
      {renderOhTable(allData,allGrandMonthly,allGrandTotal,'СВОДКА ВСЕХ РАСХОДОВ','Все виды расходов компании: зарплаты + накладные. Кликните на ячейку для детализации.')}

      <div style={{marginTop:4,padding:10,background:'var(--bg1)',borderRadius:8,border:'1px solid var(--border)',marginBottom:16}}>
        <div style={{fontSize:12,fontWeight:600,color:'var(--accent2)',marginBottom:6}}>Структура расходов</div>
        <div style={{display:'flex',gap:16,flexWrap:'wrap',fontSize:11}}>
          {allData.filter(c=>c.total>0).sort((a,b)=>b.total-a.total).map(c=><div key={c.id} style={{display:'flex',alignItems:'center',gap:4}}>
            <span style={{display:'inline-block',width:10,height:10,borderRadius:2,background:c.color}}></span>
            <span>{c.label}:</span>
            <span style={{fontWeight:600}}>{fmt(c.total)}</span>
            <span style={{color:'var(--text2)'}}>({allGrandTotal>0?Math.round(c.total/allGrandTotal*100):0}%)</span>
          </div>)}
        </div>
      </div>

      {renderOhTable(ohData,ohGrandMonthly,ohGrandTotal,'ТОЛЬКО НАКЛАДНЫЕ (OVERHEADS)','Без ФОТ и зарплат — только операционные расходы.')}
    </div>;
  })()}

  {/* Вкладки oh_check и oh_comp удалены — задача выполнена */}



  {fmTab==='oh_registry'&&(()=>{
    /*
     * ===== ОБЩИЕ НАКЛАДНЫЕ — ЕДИНЫЙ РЕЕСТР =====
     * Это единая точка входа для ВСЕХ накладных расходов.
     * МАРШРУТ КБ: новая операция создаётся ЗДЕСЬ → факт автоматически
     * попадает в Бюджет КБ (по категории + месяц, rg='КБ').
     * Штатный сценарий: Реестр → Бюджет КБ (авто). Обратный — исключение.
     */
    const registry=store.data.overhead_registry||[];
    const activeProjects=(store.data.projects||[]).filter(p=>p.status==='ACTIVE');
    const RG_OPTS=['РГ1','РГ2','ФК','КБ','АХО','HR','НД','PP','РГ6'];
    const CAT_OPTS=['Подрядчики','IT решения','Промо','АХО','Логистика','Зарплата ФК','Найм','Авансированная прибыль','Прочее'];
    const CLS_OPTS=['поддержка сайта','софт','билеты','для офиса','оборудование','дизайн','копирайтинг','монтаж','обработка данных','программирование','аналитика','найм','медиапартнерства','опросы','сбор данных','аренда помещения','прочее'];
    const FMT_OPTS=['счет','нал','карта ИП'];
    const CF_MAP={'КБ':'OCF','АХО':'AHO','HR':'OCF','НД':'OCF','PP':'OCF','РГ6':'ICF'};
    const rgC={'РГ1':'var(--accent2)','РГ2':'var(--teal)','IB':'var(--accent2)','ФК':'var(--sky)','КБ':'var(--sky)','АХО':'var(--amber)','HR':'var(--emerald)','НД':'var(--green)','PP':'var(--violet)','РГ6':'var(--sky)'};

    /* Filters */
    const f=ohRegFilter;
    const filtered=registry.filter(e=>{
      if(f.month&&!(e.date||'').startsWith(f.month))return false;
      if(f.rg&&e.rg!==f.rg)return false;
      if(f.scope&&e.scope!==f.scope)return false;
      if(f.verified==='yes'&&!e.verified)return false;
      if(f.verified==='no'&&e.verified)return false;
      if(f.source&&e.source!==f.source)return false;
      /* prior_year filter: 'hide' (default) hides them, 'show' shows only prior_year, '' shows all */
      if((f.prior_year||'hide')==='hide'&&e.prior_year)return false;
      if(f.prior_year==='show'&&!e.prior_year)return false;
      return true;
    }).sort((a,b)=>(a.date||'').localeCompare(b.date||'')||(b.amount||0)-(a.amount||0));

    const priorYearCount=registry.filter(e=>e.prior_year).length;
    const priorYearAmt=registry.filter(e=>e.prior_year).reduce((s,e)=>s+Number(e.amount||0),0);
    const totalAmt=filtered.reduce((s,e)=>s+Number(e.amount),0);
    const verifiedN=filtered.filter(e=>e.verified).length;
    const syncedN=filtered.filter(e=>e.synced_oh_id||e.synced_kb_id).length;
    const projN=filtered.filter(e=>e.scope==='project').length;
    const compN=filtered.filter(e=>e.scope==='company').length;

    /* Current user session for role-based buttons */
    const _ohSess=(()=>{try{return JSON.parse(sessionStorage.getItem('pp_auth_session'));}catch(x){return null;}})();
    const _ohRoles=_ohSess?_getUserRoles(_ohSess):['admin'];
    const _ohIsApprover=_ohRoles.includes('admin')||_ohRoles.includes('partner');
    const _ohIsFinance=_ohRoles.includes('finance')||_ohRoles.includes('partner')||_ohRoles.includes('admin');
    const _ohUserName=_ohSess?(_ohSess.name||_ohSess.login||'Илья'):'Илья';

    /* Import function */
    const doImport=()=>{
      const appProjects=store.data.projects||[];
      const appClients=store.data.clients||[];
      const norm=s=>(s||'').toLowerCase().replace(/[^а-яёa-z0-9\s]/gi,'').replace(/\s+/g,' ').trim();
      const fuzzyMatch=(a,b)=>{if(!a||!b)return false;return a===b||a.includes(b)||b.includes(a);};
      const matchProj=(fName)=>{
        const fn=norm(fName);
        let m=activeProjects.find(p=>fuzzyMatch(norm(p.code),fn)||fuzzyMatch(norm(p.name),fn));
        if(m)return m;
        m=activeProjects.find(p=>fuzzyMatch(norm(p.client_name),fn));
        if(m)return m;
        const cl=appClients.find(c=>fuzzyMatch(norm(c.name),fn));
        if(cl){m=activeProjects.find(p=>p.client_id===cl.id);if(m)return m;}
        const parts=fn.split(/[\s,]+/).filter(x=>x.length>2);
        if(parts.length>1){m=activeProjects.find(p=>{const pc=norm(p.code);const pn=norm(p.name);const pcl=norm(p.client_name);return parts.every(pt=>pc.includes(pt)||pn.includes(pt)||pcl.includes(pt));});if(m)return m;const fw=parts[0];if(fw.length>=3){m=activeProjects.find(p=>norm(p.code).includes(fw)||norm(p.name).includes(fw)||norm(p.client_name).includes(fw));}if(m)return m;}
        return null;
      };

      const entries=[];
      /* Project-level expenses from file */
      const projFile=[
        {proj:'Абрау Дюрсо',rg:'IB',jan:106000,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Сибур, продвижение',rg:'ФК',jan:95700,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'ФЦК',rg:'IB',jan:85900,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Сантерра',rg:'IB',jan:0,feb:53275,cat:'Подрядчики',cls:'прочее'},
        {proj:'Дзорт',rg:'IB',jan:0,feb:48054,cat:'Подрядчики',cls:'прочее'},
        {proj:'Ольга Лукина',rg:'ФК',jan:14500,feb:28000,cat:'Подрядчики',cls:'прочее'},
        {proj:'АДГ, исследование',rg:'IB',jan:0,feb:35702,cat:'Подрядчики',cls:'прочее'},
        {proj:'Х5 Транспорт',rg:'IB',jan:35600,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Аюна',rg:'IB',jan:27840,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'ОЗЭУ',rg:'IB',jan:0,feb:27830,cat:'Подрядчики',cls:'прочее'},
        {proj:'Венеция Стоун',rg:'IB',jan:27633,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Фудкорт',rg:'IB',jan:0,feb:24960,cat:'Подрядчики',cls:'прочее'},
        {proj:'Сибур, Полилаб',rg:'ФК',jan:4648,feb:17000,cat:'Подрядчики',cls:'прочее'},
        {proj:'Севенком',rg:'IB',jan:16000,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Термекс',rg:'IB',jan:15983,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Квант',rg:'IB',jan:15000,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Шатим',rg:'IB',jan:15000,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'НИЦ',rg:'IB',jan:14999,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Медцентр 21 век',rg:'IB',jan:0,feb:10880,cat:'Подрядчики',cls:'прочее'},
        {proj:'ИЗТТ',rg:'IB',jan:10500,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Авалон',rg:'IB',jan:0,feb:10000,cat:'Подрядчики',cls:'прочее'},
        {proj:'Рокада',rg:'IB',jan:0,feb:9368,cat:'Подрядчики',cls:'прочее'},
        {proj:'Финго',rg:'IB',jan:0,feb:6550,cat:'Подрядчики',cls:'прочее'},
        {proj:'Вастэко',rg:'IB',jan:5033,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Полюс',rg:'IB',jan:5000,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Олсо',rg:'IB',jan:3001,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Бизон',rg:'IB',jan:3000,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Теплопоток',rg:'IB',jan:2990,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Полимакс',rg:'IB',jan:0,feb:2700,cat:'Подрядчики',cls:'прочее'},
        {proj:'АДГ, СРМ',rg:'ФК',jan:2400,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Куликовский',rg:'IB',jan:1000,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Румяный каравай',rg:'IB',jan:1000,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'Фитнес формула',rg:'IB',jan:1000,feb:0,cat:'Подрядчики',cls:'прочее'},
        {proj:'0.75',rg:'IB',jan:200,feb:0,cat:'Подрядчики',cls:'прочее'},
        /* ФК подрядчики */
        {proj:'Сибур, Полилаб',rg:'ФК',jan:100000,feb:123000,cat:'Зарплата ФК',cls:'подрядчики'},
        {proj:'Сибур, продвижение',rg:'ФК',jan:85000,feb:124000,cat:'Зарплата ФК',cls:'подрядчики'},
        {proj:'АДГ, СРМ',rg:'ФК',jan:130100,feb:130100,cat:'Зарплата ФК',cls:'подрядчики'},
        /* IB общие */
        {proj:'Paper Planes',rg:'IB',jan:25639,feb:0,cat:'Подрядчики',cls:'прочее'},
      ];
      projFile.forEach(pf=>{
        const matched=matchProj(pf.proj);
        ['jan','feb'].forEach((mon,mi)=>{
          if(pf[mon]>0){
            entries.push({date:yr+'-0'+(mi+1)+'-15',amount:pf[mon],rg:pf.rg,category:pf.cat,cls:pf.cls,format:'счет',responsible:'',comment:pf.proj,project_id:matched?matched.id:null,scope:matched?'project':'company',cf_type:'OCF',source:'file'});
          }
        });
      });

      /* Company-level expenses from file (already detailed) */
      const compFile=[
        {rg:'КБ',date:'2026-01-20',amount:140000,category:'Подрядчики',cls:'поддержка сайта',format:'счет',responsible:'Шипулин Дмитрий',comment:'ИП Маркелов / SEO'},
        {rg:'КБ',date:'2026-02-11',amount:45000,category:'Промо',cls:'медиапартнерства',format:'счет',responsible:'Пак Александр',comment:'HR-КУХНЯ'},
        {rg:'КБ',date:'2026-01-20',amount:40000,category:'Подрядчики',cls:'поддержка сайта',format:'счет',responsible:'Шипулин Дмитрий',comment:'ИП Маркелов / SEO'},
        {rg:'КБ',date:'2026-02-09',amount:15000,category:'Подрядчики',cls:'дизайн',format:'нал',responsible:'Шипулин Дмитрий',comment:'дизайнер'},
        {rg:'КБ',date:'2026-01-18',amount:7641,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'NIC RU PP'},
        {rg:'КБ',date:'2026-01-05',amount:6653,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'Adobe'},
        {rg:'КБ',date:'2026-01-17',amount:5889,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'Salebot'},
        {rg:'КБ',date:'2026-01-19',amount:4866,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'NIC RU'},
        {rg:'КБ',date:'2026-01-17',amount:4000,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'Unisender'},
        {rg:'КБ',date:'2026-01-18',amount:2832,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'NIC RU'},
        {rg:'КБ',date:'2026-01-18',amount:2237,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'NIC RU'},
        {rg:'КБ',date:'2026-01-19',amount:2160,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'NIC RU'},
        {rg:'КБ',date:'2026-01-12',amount:2083,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'Tilda'},
        {rg:'КБ',date:'2026-02-12',amount:2083,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'Tilda'},
        {rg:'КБ',date:'2026-02-13',amount:2000,category:'IT решения',cls:'сбор данных',format:'нал',responsible:'Шипулин Дмитрий',comment:'Бот контактов'},
        {rg:'КБ',date:'2026-02-09',amount:1000,category:'Подрядчики',cls:'монтаж',format:'нал',responsible:'Шипулин Дмитрий',comment:'рилсмейкер'},
        {rg:'КБ',date:'2026-02-09',amount:1000,category:'Подрядчики',cls:'копирайтинг',format:'нал',responsible:'Шипулин Дмитрий',comment:'копирайтер'},
        {rg:'КБ',date:'2026-01-12',amount:960,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'Tilda доп'},
        {rg:'КБ',date:'2026-01-18',amount:640,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Шипулин Дмитрий',comment:'Unisender'},
        {rg:'КБ',date:'2026-02-11',amount:400,category:'Подрядчики',cls:'опросы',format:'нал',responsible:'Новицкий Александр',comment:'Анкета Сантерра'},
        {rg:'АХО',date:'2026-01-26',amount:55622,category:'АХО',cls:'аренда помещения',format:'счет',responsible:'Иутин Игорь',comment:'переменная офис'},
        {rg:'АХО',date:'2026-01-13',amount:50000,category:'Промо',cls:'найм',format:'счет',responsible:'Иутин Игорь',comment:'ХХ'},
        {rg:'АХО',date:'2026-01-20',amount:50000,category:'Промо',cls:'найм',format:'счет',responsible:'Иутин Игорь',comment:'ХХ'},
        {rg:'АХО',date:'2026-02-09',amount:50000,category:'Промо',cls:'найм',format:'счет',responsible:'Винникова Дарья',comment:'ХХ'},
        {rg:'АХО',date:'2026-01-05',amount:16000,category:'АХО',cls:'оборудование',format:'нал',responsible:'Шипулин Дмитрий',comment:'Батареи и компы'},
        {rg:'АХО',date:'2026-02-02',amount:14124,category:'АХО',cls:'для офиса',format:'счет',responsible:'Володина Ксения',comment:'Интернет'},
        {rg:'АХО',date:'2026-01-13',amount:5602,category:'АХО',cls:'для офиса',format:'карта ИП',responsible:'Иутин Игорь',comment:'Хозтовары'},
        {rg:'АХО',date:'2026-01-27',amount:3721,category:'АХО',cls:'для офиса',format:'карта ИП',responsible:'Иутин Игорь',comment:'Хозтовары'},
        {rg:'АХО',date:'2026-01-13',amount:3551,category:'АХО',cls:'для офиса',format:'карта ИП',responsible:'Иутин Игорь',comment:'Хозтовары'},
        {rg:'АХО',date:'2026-01-13',amount:1600,category:'АХО',cls:'для офиса',format:'карта ИП',responsible:'Иутин Игорь',comment:'Связь'},
        {rg:'АХО',date:'2026-01-13',amount:1046,category:'АХО',cls:'для офиса',format:'нал',responsible:'Иутин Игорь',comment:'Связь'},
        {rg:'АХО',date:'2026-01-05',amount:990,category:'АХО',cls:'для офиса',format:'карта ИП',responsible:'Иутин Игорь',comment:'Книга'},
        {rg:'НД',date:'2026-01-20',amount:43891,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Алматы–Мск'},
        {rg:'НД',date:'2026-02-09',amount:35007,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Барнаул–Мск'},
        {rg:'НД',date:'2026-01-23',amount:24395,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Мск–Барнаул'},
        {rg:'НД',date:'2026-01-21',amount:24049,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Ростов–Адлер'},
        {rg:'НД',date:'2026-01-21',amount:22903,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Мск–Краснодар'},
        {rg:'НД',date:'2026-01-21',amount:19802,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Сочи–Мск'},
        {rg:'НД',date:'2026-01-21',amount:17911,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Мск–Краснодар'},
        {rg:'НД',date:'2026-01-21',amount:17911,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Краснодар–Мск'},
        {rg:'НД',date:'2026-01-26',amount:5877,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Мск–СПб'},
        {rg:'НД',date:'2026-01-27',amount:4857,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Мск–СПб'},
        {rg:'НД',date:'2026-01-27',amount:4592,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'СПб–Мск'},
        {rg:'НД',date:'2026-01-21',amount:2520,category:'Логистика',cls:'билеты',format:'карта ИП',responsible:'Пак Александр',comment:'Краснодар–Ростов'},
        {rg:'PP',date:'2026-02-02',amount:16000,category:'Подрядчики',cls:'программирование',format:'нал',responsible:'Адамова Юлия',comment:'Солобай'},
        {rg:'PP',date:'2026-02-09',amount:15813,category:'IT решения',cls:'аналитика',format:'карта ИП',responsible:'Мельник Дмитрий',comment:'mpstats'},
        {rg:'HR',date:'2026-01-17',amount:11060,category:'Подрядчики',cls:'обработка данных',format:'нал',responsible:'Иутин Игорь',comment:'ЦЕС'},
        {rg:'HR',date:'2026-01-17',amount:10025,category:'Подрядчики',cls:'обработка данных',format:'нал',responsible:'Иутин Игорь',comment:'ЦЕС'},
        {rg:'HR',date:'2026-01-31',amount:8800,category:'Подрядчики',cls:'обработка данных',format:'нал',responsible:'Иутин Игорь',comment:'ЦЕС'},
        {rg:'PP',date:'2026-01-22',amount:3900,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Стажер',comment:'spywords'},
        {rg:'PP',date:'2026-01-23',amount:1490,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Володина Ксения',comment:'Докити'},
        {rg:'PP',date:'2026-01-27',amount:1000,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Стажер',comment:'pr-cy'},
        {rg:'PP',date:'2026-01-10',amount:940,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Стажер',comment:'Руспрофайл'},
        {rg:'PP',date:'2026-01-19',amount:990,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Иутин Игорь',comment:'ВПН'},
        {rg:'PP',date:'2026-01-22',amount:990,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Иутин Игорь',comment:'ВПН'},
        {rg:'PP',date:'2026-01-22',amount:990,category:'IT решения',cls:'софт',format:'карта ИП',responsible:'Иутин Игорь',comment:'ВПН'},
      ];
      compFile.forEach(cf=>{
        entries.push({...cf,project_id:null,scope:'company',cf_type:CF_MAP[cf.rg]||'OCF',source:'file'});
      });

      store.bulkImportOhRegistry(entries);
    };

    /* Pull all system data: project overheads + kb_budget into registry */
    const pullFromSystem=()=>{
      const reg=store.data.overhead_registry||[];
      const allProjects=store.data.projects||[];
      const kbItems=store.data.kb_budget||[];
      const entries=[];
      /* 1) Overheads from ALL projects (2026) */
      allProjects.forEach(pr=>{
        (pr.overheads||[]).forEach(oh=>{
          if(!oh.date||!oh.date.startsWith(yr))return;
          const alreadyLinked=reg.some(r=>r.synced_oh_id===oh.id);
          if(alreadyLinked)return;
          const dupKey=oh.date+'|'+oh.amount+'|'+(oh.name||'').toLowerCase();
          const hasDup=reg.some(r=>r.date===oh.date&&r.amount===oh.amount&&(r.comment||'').toLowerCase()===(oh.name||'').toLowerCase()&&r.project_id===pr.id);
          if(hasDup)return;
          const _prRg=pr.project_type==='ФК'?'ФК':(pr.work_group==='РГ2'?'РГ2':'РГ1');
          entries.push({date:oh.date,amount:Number(oh.amount)||0,rg:_prRg,category:guessCategory(oh.name,oh.notes),cls:guessCls(oh.name,oh.notes),format:guessFormat(oh.notes),responsible:guessResp(oh.notes),comment:oh.name||'',project_id:pr.id,scope:'project',cf_type:'OCF',source:'system_proj',synced_oh_id_pre:oh.id});
        });
      });
      /* 2) KB budget items (2026) */
      kbItems.forEach(kb=>{
        if(!kb.month||!kb.month.startsWith(yr))return;
        const alreadyLinked=reg.some(r=>r.synced_kb_id===kb.id);
        if(alreadyLinked)return;
        const amt=Number(kb.amount_plan)||Number(kb.amount_fact)||0;
        if(!amt)return;
        const hasDup=reg.some(r=>r.date&&r.date.startsWith(kb.month)&&r.amount===amt&&(r.comment||'').toLowerCase()===(kb.name||'').toLowerCase()&&r.scope==='company');
        if(hasDup)return;
        const rgGuess=cfToRg(kb.cf_type);
        entries.push({date:kb.month+'-15',amount:amt,rg:rgGuess,category:guessCategory(kb.name,kb.notes),cls:guessCls(kb.name,kb.notes),format:guessFormat(kb.notes),responsible:guessResp(kb.notes),comment:kb.name||'',project_id:null,scope:'company',cf_type:kb.cf_type||'OCF',source:'system_kb',synced_kb_id_pre:kb.id});
      });
      if(!entries.length){showToast('Нет новых записей для импорта');return;}
      /* Bulk add with pre-linked ids */
      const newEntries=entries.map(e=>{
        const ne={id:uuid(),date:e.date||now().slice(0,10),amount:e.amount,rg:e.rg||'КБ',category:e.category||'',cls:e.cls||'',format:e.format||'счет',responsible:e.responsible||'',comment:e.comment||'',project_id:e.project_id||null,scope:e.scope||(e.project_id?'project':'company'),cf_type:e.cf_type||'OCF',verified:false,synced_oh_id:e.synced_oh_id_pre||null,synced_kb_id:e.synced_kb_id_pre||null,source:e.source||'system',created_at:now()};
        return ne;
      });
      setData(d=>({...d,overhead_registry:[...(d.overhead_registry||[]),...newEntries]}));
      showToast(newEntries.length+' записей подтянуто из системы');
    };
    /* Helper: map cf_type back to RG */
    const cfToRg=(cf)=>({'OCF':'КБ','ICF':'КБ','SALARY_OCF':'КБ','SALARY_ICF':'КБ','AHO':'АХО','OFFICE':'АХО'}[cf]||'КБ');
    /* Helper: guess category from name/notes */
    const guessCategory=(name,notes)=>{const s=((name||'')+' '+(notes||'')).toLowerCase();if(s.includes('подряд')||s.includes('подрядчик'))return'Подрядчики';if(s.includes('it ')||s.includes('софт')||s.includes('впн')||s.includes('аналитик'))return'IT решения';if(s.includes('промо')||s.includes('найм')||s.includes('хх'))return'Промо';if(s.includes('ахо')||s.includes('аренда')||s.includes('офис')||s.includes('хозтовар'))return'АХО';if(s.includes('логист')||s.includes('билет')||s.includes('перелет')||s.includes('мск'))return'Логистика';if(s.includes('зп')||s.includes('зарплат'))return'Зарплата ФК';return'Прочее';};
    const guessCls=(name,notes)=>{const s=((name||'')+' '+(notes||'')).toLowerCase();if(s.includes('сайт')||s.includes('seo'))return'поддержка сайта';if(s.includes('софт')||s.includes('tilda')||s.includes('adobe'))return'софт';if(s.includes('билет')||s.includes('мск'))return'билеты';if(s.includes('аренда'))return'аренда помещения';if(s.includes('офис')||s.includes('хозтов')||s.includes('интернет')||s.includes('связь'))return'для офиса';if(s.includes('оборудов'))return'оборудование';if(s.includes('дизайн'))return'дизайн';if(s.includes('програм'))return'программирование';return'прочее';};
    const guessFormat=(notes)=>{const s=(notes||'').toLowerCase();if(s.includes('нал'))return'нал';if(s.includes('карта')||s.includes('ип'))return'карта ИП';return'счет';};
    const guessResp=(notes)=>{const s=(notes||'');const m=s.match(/\]\s*(.*?)\s*\|/);return m?m[1]:'';};

    /* Edit form helpers */
    const openNew=()=>setOhRegEdit({date:now().slice(0,10),amount:'',rg:'КБ',category:'',cls:'',format:'счет',responsible:'',comment:'',project_id:'',scope:'company',cf_type:'OCF',_isNew:true});
    const openEdit=(e)=>setOhRegEdit({...e,_isNew:false});
    const saveEdit=()=>{
      if(!ohRegEdit)return;
      const d={...ohRegEdit};delete d._isNew;
      d.amount=Number(d.amount)||0;
      d.project_id=d.project_id||null;
      d.scope=d.project_id?'project':d.scope;
      /* Автоопределение RG из проекта если РГ1/РГ2/ФК */
      if(d.project_id&&['РГ1','РГ2','ФК'].includes(d.rg)){
        const _pr=activeProjects.find(p=>p.id===d.project_id);
        if(_pr){
          if(_pr.project_type==='ФК')d.rg='ФК';
          else d.rg=_pr.work_group==='РГ2'?'РГ2':'РГ1';
        }
      }
      if(ohRegEdit._isNew){
        const newEntry=store.addOhRegistryItem(d);
        /* Авто-синхронизация в проект для проектных записей */
        if(d.project_id&&newEntry){
          setTimeout(()=>{store.syncOhToProject(newEntry.id);},50);
        }
        showToast('Запись добавлена'+(d.project_id?' + синхронизирована в проект':''));
      }else{
        store.updateOhRegistryItem(d.id,d);
        if(d.project_id)setTimeout(()=>{store.syncOhToProject(d.id);},50);
      }
      setOhRegEdit(null);
      /* Принудительный double-check после сохранения */
      setTimeout(()=>{const w=store.runFkDoubleCheck();if(w)setFkWarnings(new Map(w));},200);
    };

    return <div>
      <div className="dash-card" style={{padding:12,overflowX:'auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
          <div style={{fontSize:14,fontWeight:700,color:'var(--accent2)'}}>ОБЩИЕ НАКЛАДНЫЕ — ЕДИНЫЙ РЕЕСТР ({yr})</div>
          <div style={{display:'flex',gap:8}}>
            {/* Import button removed — registry is now populated only via chat requests and manual entries */}
            {/* Pull from system button removed — registry entries come from chat overhead requests */}
            <button className="btn" style={{fontSize:11,padding:'4px 12px',background:'var(--accent2)',color:'#fff',border:'none',borderRadius:6,cursor:'pointer'}} onClick={openNew}>+ Новая запись</button>
            <button className="btn" style={{fontSize:11,padding:'4px 12px',background:'var(--amber)',color:'#000',border:'none',borderRadius:6,cursor:'pointer'}} onClick={()=>{const w=store.runFkDoubleCheck();if(w)setFkWarnings(new Map(w));}} title="Сопоставить ФК-записи с накладными проектов">🔍 Проверить ФК</button>
            <button className="btn" style={{fontSize:11,padding:'4px 12px',background:'var(--red)',color:'#fff',border:'none',borderRadius:6,cursor:'pointer',opacity:0.8}} onClick={()=>store.clearOverheadRegistry()} title="Полная очистка реестра (ручная)">🗑 Очистить реестр</button>
            <button className="btn" style={{fontSize:11,padding:'4px 12px',background:'var(--violet)',color:'#fff',border:'none',borderRadius:6,cursor:'pointer'}} onClick={()=>{
              /* Генерация диагностического отчёта: project.overheads vs overhead_registry */
              const _reg=store.data.overhead_registry||[];
              const _prjs=store.data.projects||[];
              const _months=['2026-01','2026-02','2026-03','2026-04','2026-05','2026-06','2026-07','2026-08','2026-09','2026-10','2026-11','2026-12'];
              const _rgs=['РГ1','РГ2','ФК','КБ','АХО','HR','НД','PP'];
              const rows=[];
              /* A) Per-RG per-month comparison */
              const rgSummary=_rgs.map(rg=>{
                const regTotal=_reg.filter(e=>e.rg===rg&&!e.prior_year).reduce((s,e)=>s+Number(e.amount||0),0);
                const regByMonth=_months.map(m=>Math.round(_reg.filter(e=>e.rg===rg&&!e.prior_year&&(e.date||'').startsWith(m)).reduce((s,e)=>s+Number(e.amount||0),0)));
                /* project-side: for project-linked RGs (РГ1/РГ2/ФК), sum project.overheads */
                const projByMonth=_months.map(m=>{
                  if(!['РГ1','РГ2','ФК'].includes(rg))return 0;
                  return Math.round(_prjs.filter(p=>{
                    if(rg==='ФК')return p.project_type==='ФК';
                    return p.project_type!=='ФК'&&(p.work_group||'')===(rg==='РГ2'?'РГ2':'РГ1');
                  }).reduce((s,p)=>s+(p.overheads||[]).filter(x=>(x.date||'').startsWith(m)).reduce((a,x)=>a+Number(x.amount||0),0),0));
                });
                const diff=_months.map((_,i)=>regByMonth[i]-projByMonth[i]);
                return {rg,regByMonth,projByMonth,diff,regTotal:Math.round(regTotal)};
              });
              /* B) Per-project detail: entries in registry vs project.overheads */
              const projDetail=[];
              const _projRgs=['РГ1','РГ2','ФК'];
              _prjs.forEach(p=>{
                const pOhs=p.overheads||[];
                const pRegEntries=_reg.filter(e=>e.project_id===p.id&&!e.prior_year);
                const pOhTotal=pOhs.reduce((s,x)=>s+Number(x.amount||0),0);
                const pRegTotal=pRegEntries.reduce((s,e)=>s+Number(e.amount||0),0);
                if(Math.round(pOhTotal)!==Math.round(pRegTotal)||pOhs.length!==pRegEntries.length){
                  /* Find unmatched in registry */
                  const regOnly=pRegEntries.filter(e=>!e.synced_oh_id||!pOhs.find(oh=>oh.id===e.synced_oh_id));
                  /* Find unmatched in project */
                  const projOnly=pOhs.filter(oh=>!pRegEntries.find(e=>e.synced_oh_id===oh.id));
                  projDetail.push({id:p.id,code:p.code,name:p.name,rg:p.project_type==='ФК'?'ФК':(p.work_group||'РГ1'),projCount:pOhs.length,regCount:pRegEntries.length,projTotal:Math.round(pOhTotal),regTotal:Math.round(pRegTotal),diff:Math.round(pRegTotal-pOhTotal),regOnly:regOnly.map(e=>({date:e.date,amount:e.amount,comment:e.comment,source:e.source})),projOnly:projOnly.map(oh=>({date:oh.date,amount:oh.amount,name:oh.name}))});
                }
              });
              /* C) Registry entries with no project_id (orphaned project-scoped) */
              const orphaned=_reg.filter(e=>_projRgs.includes(e.rg)&&!e.project_id&&!e.prior_year);
              setOhDiagReport({rgSummary,projDetail,orphaned,months:_months});
            }} title="Сравнить project.overheads с реестром">🔬 Диагностика</button>
          </div>
        </div>

        {/* Filters */}
        <div style={{display:'flex',gap:8,marginBottom:10,flexWrap:'wrap',fontSize:11}}>
          <select value={f.month} onChange={e=>setOhRegFilter(p=>({...p,month:e.target.value}))} style={{padding:'4px 8px',borderRadius:6,border:'1px solid var(--border)',fontSize:11}}>
            <option value="">Все месяцы</option>
            {[1,2,3,4,5,6,7,8,9,10,11,12].map(m=><option key={m} value={yr+'-'+String(m).padStart(2,'0')}>{String(m).padStart(2,'0')}/{yr}</option>)}
          </select>
          <select value={f.rg} onChange={e=>setOhRegFilter(p=>({...p,rg:e.target.value}))} style={{padding:'4px 8px',borderRadius:6,border:'1px solid var(--border)',fontSize:11}}>
            <option value="">Все РГ</option>
            {RG_OPTS.map(r=><option key={r} value={r}>{r}</option>)}
          </select>
          <select value={f.scope} onChange={e=>setOhRegFilter(p=>({...p,scope:e.target.value}))} style={{padding:'4px 8px',borderRadius:6,border:'1px solid var(--border)',fontSize:11}}>
            <option value="">Все уровни</option>
            <option value="project">Проект</option>
            <option value="company">Общефирм.</option>
          </select>
          <select value={f.verified} onChange={e=>setOhRegFilter(p=>({...p,verified:e.target.value}))} style={{padding:'4px 8px',borderRadius:6,border:'1px solid var(--border)',fontSize:11}}>
            <option value="">Все</option>
            <option value="yes">Проверено</option>
            <option value="no">Не проверено</option>
          </select>
          <select value={f.source} onChange={e=>setOhRegFilter(p=>({...p,source:e.target.value}))} style={{padding:'4px 8px',borderRadius:6,border:'1px solid var(--border)',fontSize:11}}>
            <option value="">Все источники</option>
            <option value="file">Файл</option>
            <option value="system_proj">Из проектов</option>
            <option value="system_kb">Из бюджета</option>
            <option value="manual">Ручные</option>
          </select>
          <select value={f.prior_year||'hide'} onChange={e=>setOhRegFilter(p=>({...p,prior_year:e.target.value}))} style={{padding:'4px 8px',borderRadius:6,border:'1px solid var(--border)',fontSize:11,background:f.prior_year==='show'?'rgba(255,152,0,0.15)':''}}>
            <option value="hide">Без прошлого года</option>
            <option value="">Все (вкл. прошлый год)</option>
            <option value="show">Только прошлый год{priorYearCount>0?' ('+priorYearCount+')':''}</option>
          </select>
          <span style={{fontSize:10,color:'var(--text2)',alignSelf:'center'}}>{filtered.length} из {registry.length} записей{priorYearCount>0?' · 🕐 '+priorYearCount+' прош.г. ('+fmt(Math.round(priorYearAmt))+')':''}</span>
        </div>

        {/* KPIs */}
        <div style={{display:'flex',gap:12,marginBottom:12,flexWrap:'wrap'}}>
          {[
            {label:'Всего',value:filtered.length,color:'var(--text1)'},
            {label:'Сумма',value:fmt(Math.round(totalAmt)),color:'var(--accent2)'},
            {label:'Проверено',value:verifiedN+'/'+filtered.length,color:'var(--green)'},
            {label:'Синхр.',value:syncedN,color:'var(--sky)'},
            {label:'Проектные',value:projN,color:'var(--accent2)'},
            {label:'Общефирм.',value:compN,color:'var(--violet)'},
          ].map((k,i)=><div key={i} style={{padding:'6px 12px',background:'var(--bg1)',borderRadius:8,border:'1px solid var(--bg3)'}}>
            <div style={{fontSize:9,color:'var(--text2)'}}>{k.label}</div>
            <div style={{fontSize:15,fontWeight:700,color:k.color}}>{k.value}</div>
          </div>)}
        </div>

        {/* Main table */}
        <table style={{width:'100%',fontSize:10,borderCollapse:'collapse'}}>
          <thead><tr style={{background:'var(--bg3)',fontSize:9}}>
            <th style={{padding:'4px 3px',width:26,textAlign:'center'}}>✓</th>
            <th style={{textAlign:'left',padding:'4px 4px',width:76}}>Дата</th>
            <th style={{textAlign:'right',padding:'4px 4px',width:70}}>Сумма</th>
            <th style={{textAlign:'left',padding:'4px 4px',width:32}}>РГ</th>
            <th style={{textAlign:'left',padding:'4px 4px',width:80}}>Категория</th>
            <th style={{textAlign:'left',padding:'4px 4px',width:80}}>Класс</th>
            <th style={{textAlign:'left',padding:'4px 4px',width:50}}>Формат</th>
            <th style={{textAlign:'left',padding:'4px 4px',width:100}}>Ответств.</th>
            <th style={{textAlign:'left',padding:'4px 4px'}}>Описание</th>
            <th style={{textAlign:'left',padding:'4px 4px',width:100}}>Проект</th>
            <th style={{textAlign:'center',padding:'4px 3px',width:42}}>Источн.</th>
            <th style={{textAlign:'center',padding:'4px 3px',width:30}}>⚡</th>
            <th style={{textAlign:'center',padding:'4px 3px',width:30}} title="Double-Check ФК">ДЧ</th>
            <th style={{textAlign:'center',padding:'4px 3px',width:60}}>Статус</th>
            <th style={{textAlign:'center',padding:'4px 3px',width:80}}>Действ.</th>
          </tr></thead>
          <tbody>
            {filtered.map(e=>{
              const proj=e.project_id?activeProjects.find(p=>p.id===e.project_id):null;
              const isSynced=!!(e.synced_oh_id||e.synced_kb_id);
              const _fkW=fkWarnings.get(e.id);
              const _hasFkWarn=!!_fkW&&['ФК','РГ1','РГ2'].includes(e.rg);
              return <tr key={e.id} style={{borderBottom:'1px solid var(--bg2)',background:e.prior_year?'rgba(255,152,0,0.06)':_hasFkWarn?'rgba(255,193,7,0.08)':e.verified?'rgba(76,175,80,0.05)':'',opacity:e.prior_year?0.55:(e.verified&&!_hasFkWarn?0.7:1),borderLeft:e.prior_year?'3px solid var(--amber)':_hasFkWarn?'3px solid var(--amber)':'none'}}>
                <td style={{textAlign:'center',padding:'3px 3px'}}><input type="checkbox" checked={!!e.verified} onChange={()=>store.toggleOhRegistryVerified(e.id)} style={{cursor:'pointer',accentColor:'var(--green)'}}/></td>
                <td style={{padding:'3px 4px',color:'var(--text2)'}}>{e.prior_year&&<span title="Расход прошлого года — не учитывается в 2026" style={{fontSize:10,cursor:'help',marginRight:2}}>🕐</span>}{e.date}</td>
                <td style={{textAlign:'right',padding:'3px 4px',fontWeight:600}}>{fmt(e.amount)}</td>
                <td style={{padding:'3px 4px'}}><span style={{color:rgC[e.rg]||'var(--text1)',fontWeight:600,fontSize:9}}>{e.rg}</span></td>
                <td style={{padding:'3px 4px',fontSize:9}}>{e.category}</td>
                <td style={{padding:'3px 4px',fontSize:9,color:'var(--text2)'}}>{e.cls}</td>
                <td style={{padding:'3px 4px',fontSize:8}}><span style={{background:'var(--bg3)',padding:'1px 3px',borderRadius:3}}>{e.format}</span></td>
                <td style={{padding:'3px 4px',fontSize:9,color:'var(--text2)'}}>{e.responsible}</td>
                <td style={{padding:'3px 4px',fontSize:9,maxWidth:140,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',textDecoration:e.verified?'line-through':'none'}} title={e.comment}>{e.comment}</td>
                <td style={{padding:'3px 4px',fontSize:9,color:proj?'var(--accent2)':'var(--text2)',cursor:proj?'pointer':'default'}} onClick={()=>{if(proj)goProject(proj.id);}}>{proj?proj.code:(e.scope==='company'?'Общефирм.':'—')}</td>
                <td style={{textAlign:'center',padding:'3px 3px',fontSize:8}}><span style={{background:e.source==='file'?'var(--bg3)':e.source==='system_proj'?'rgba(33,150,243,0.12)':e.source==='system_kb'?'rgba(156,39,176,0.12)':'rgba(255,152,0,0.12)',padding:'1px 4px',borderRadius:3,color:e.source==='file'?'var(--text2)':e.source==='system_proj'?'#1976d2':e.source==='system_kb'?'#7b1fa2':'#e65100'}}>{e.source==='file'?'Файл':e.source==='system_proj'?'Проект':e.source==='system_kb'?'Бюджет':'Руч.'}</span></td>
                <td style={{textAlign:'center',padding:'3px 3px'}}>{isSynced?<span title="Синхронизировано" style={{color:'var(--green)',fontSize:12}}>✅</span>:<span title="Синхронизировать" style={{cursor:'pointer',fontSize:12}} onClick={()=>{if(e.scope==='project'&&e.project_id)store.syncOhToProject(e.id);else if(e.scope==='company')store.syncOhToKbBudget(e.id);}}>⚡</span>}</td>
                <td style={{textAlign:'center',padding:'3px 3px'}}>{['ФК','РГ1','РГ2'].includes(e.rg)&&e.project_id?(_hasFkWarn?<span title={_fkW.message} style={{cursor:'help',fontSize:14,color:'var(--amber)'}}>⚠️</span>:(e.verified?<span title="Проверено — совпадает с проектом" style={{fontSize:12,color:'var(--green)'}}>✅</span>:<span style={{fontSize:10,color:'var(--text2)'}}>—</span>)):''}</td>
                <td style={{textAlign:'center',padding:'3px 3px',whiteSpace:'nowrap'}}>{(()=>{
                    const st=e.disbursed?'DISBURSED':(e.oh_status||'');
                    const stC={PENDING:{bg:'rgba(255,152,0,.12)',c:'#e65100',l:'⏳'},APPROVED:{bg:'rgba(76,175,80,.12)',c:'var(--green)',l:'✅'},REJECTED:{bg:'rgba(244,67,54,.12)',c:'var(--red)',l:'❌'},DISBURSED:{bg:'rgba(59,130,246,.12)',c:'var(--sky)',l:'💸'}};
                    const sc=stC[st];
                    if(!sc)return <span style={{fontSize:9,color:'var(--text2)'}}>—</span>;
                    return <span title={st==='DISBURSED'?'Выдана: '+(e.disbursed_by||'')+' '+(e.disbursed_at||'').slice(0,10):st==='APPROVED'?'Подтв: '+(e.oh_approved_by||''):st} style={{fontSize:9,padding:'1px 4px',borderRadius:3,background:sc.bg,color:sc.c,fontWeight:600}}>{sc.l}</span>;
                  })()}</td>
                <td style={{textAlign:'center',padding:'3px 3px',whiteSpace:'nowrap'}}>
                  {e.oh_status==='PENDING'&&_ohIsApprover&&<><span style={{cursor:'pointer',fontSize:11,color:'var(--green)',marginRight:3}} onClick={()=>{if(confirm('Подтвердить накладную?')){const msgs=(store.data.chat_messages||[]);const linked=msgs.find(m=>m.overhead_request&&m.overhead_request.reg_id===e.id);if(linked)store.approveOhRequest(linked.id,_ohUserName);else{store.updateOhRegistryItem(e.id,{oh_status:'APPROVED',oh_approved_by:_ohUserName,oh_approved_at:new Date().toISOString(),verified:true});}}}} title="Подтвердить">✅</span><span style={{cursor:'pointer',fontSize:11,color:'var(--red)',marginRight:3}} onClick={()=>{if(confirm('Отклонить накладную?')){const msgs=(store.data.chat_messages||[]);const linked=msgs.find(m=>m.overhead_request&&m.overhead_request.reg_id===e.id);if(linked)store.rejectOhRequest(linked.id,_ohUserName);else{store.updateOhRegistryItem(e.id,{oh_status:'REJECTED',oh_approved_by:_ohUserName,oh_approved_at:new Date().toISOString()});}}}} title="Отклонить">❌</span></>}
                  {e.oh_status==='APPROVED'&&!e.disbursed&&_ohIsFinance&&<span style={{cursor:'pointer',fontSize:11,color:'var(--sky)',marginRight:3}} onClick={()=>{if(confirm('Отметить как выданную?'))store.markOhDisbursed(e.id,_ohUserName);}} title="Выдать">💸</span>}
                  <span style={{cursor:'pointer',fontSize:11,marginRight:3}} onClick={()=>openEdit(e)} title="Редактировать">✎</span>
                  <span style={{cursor:'pointer',fontSize:11,color:'var(--red)'}} onClick={()=>{if(confirm('Удалить?'))store.deleteOhRegistryItem(e.id);}} title="Удалить">✕</span>
                </td>
              </tr>;
            })}
          </tbody>
          <tfoot><tr style={{borderTop:'2px solid var(--accent2)',fontWeight:700,background:'var(--bg3)'}}>
            <td colSpan={2} style={{padding:'5px 4px'}}>ИТОГО</td>
            <td style={{textAlign:'right',padding:'5px 4px'}}>{fmt(Math.round(totalAmt))}</td>
            <td colSpan={12}></td>
          </tr></tfoot>
        </table>
      </div>

      {/* Edit modal */}
      {ohRegEdit&&(()=>{
        const _allPersons=(store.data.persons||[]).filter(p=>p.name);
        const _activePersons=_allPersons.filter(p=>!p.fire_date||p.fire_date>now().slice(0,10));
        const _fs={label:{fontSize:11,fontWeight:600,color:'#555',marginBottom:2},input:{padding:'6px 8px',borderRadius:6,border:'1px solid #ccc',fontSize:12,background:'#fff',color:'#222'},row:{marginBottom:10}};
        return <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999}} onClick={()=>setOhRegEdit(null)}>
        <div style={{background:'#ffffff',borderRadius:14,padding:24,width:560,maxHeight:'88vh',overflowY:'auto',boxShadow:'0 24px 80px rgba(0,0,0,0.4)',color:'#222'}} onClick={ev=>ev.stopPropagation()}>
          <div style={{fontSize:16,fontWeight:700,marginBottom:16,color:'#4361ee',borderBottom:'2px solid #4361ee',paddingBottom:8}}>{ohRegEdit._isNew?'Новая накладная':'Редактирование накладной'}</div>

          {/* Row 1: Дата + Сумма */}
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
            <div style={_fs.row}><div style={_fs.label}>Дата</div><input type="date" value={ohRegEdit.date||''} onChange={e=>setOhRegEdit(p=>({...p,date:e.target.value}))} style={{..._fs.input,width:'100%'}}/></div>
            <div style={_fs.row}><div style={_fs.label}>Сумма, руб.</div><input type="number" value={ohRegEdit.amount||''} onChange={e=>setOhRegEdit(p=>({...p,amount:e.target.value}))} placeholder="0" style={{..._fs.input,width:'100%',fontWeight:600}}/></div>
          </div>

          {/* Row 2: РГ + Категория + Класс */}
          <div style={{display:'grid',gridTemplateColumns:'80px 1fr 1fr',gap:12}}>
            <div style={_fs.row}><div style={_fs.label}>РГ</div><select value={ohRegEdit.rg||'КБ'} onChange={e=>{const rg=e.target.value;const upd={rg};if(rg==='РГ6'){upd.cf_type='ICF';upd.scope='company';}else if(CF_MAP[rg]){upd.cf_type=CF_MAP[rg];}setOhRegEdit(p=>({...p,...upd}));}} style={{..._fs.input,width:'100%'}}>{RG_OPTS.map(r=><option key={r} value={r}>{r==='РГ6'?'ШЕСТЁРКА':r}</option>)}</select></div>
            <div style={_fs.row}><div style={_fs.label}>Категория</div><select value={ohRegEdit.category||''} onChange={e=>setOhRegEdit(p=>({...p,category:e.target.value}))} style={{..._fs.input,width:'100%'}}><option value="">— выбрать —</option>{CAT_OPTS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
            <div style={_fs.row}><div style={_fs.label}>Класс</div><select value={ohRegEdit.cls||''} onChange={e=>setOhRegEdit(p=>({...p,cls:e.target.value}))} style={{..._fs.input,width:'100%'}}><option value="">— выбрать —</option>{CLS_OPTS.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
          </div>

          {/* Row 3: Формат + Ответственный */}
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
            <div style={_fs.row}><div style={_fs.label}>Формат оплаты</div><select value={ohRegEdit.format||'счет'} onChange={e=>setOhRegEdit(p=>({...p,format:e.target.value}))} style={{..._fs.input,width:'100%'}}>{FMT_OPTS.map(f_=><option key={f_} value={f_}>{f_}</option>)}</select></div>
            <div style={_fs.row}><div style={_fs.label}>Ответственный</div><select value={ohRegEdit.responsible||''} onChange={e=>setOhRegEdit(p=>({...p,responsible:e.target.value}))} style={{..._fs.input,width:'100%'}}><option value="">— выбрать —</option>{_activePersons.map(pe=><option key={pe.id} value={pe.name}>{pe.name}</option>)}{ohRegEdit.responsible&&!_activePersons.find(pe=>pe.name===ohRegEdit.responsible)&&<option value={ohRegEdit.responsible}>{ohRegEdit.responsible} (не в списке)</option>}</select></div>
          </div>

          {/* Row 4: Уровень + Проект/cf_type */}
          {(()=>{
            const _projRgs=['РГ1','РГ2','ФК'];
            const _isProjRg=_projRgs.includes(ohRegEdit.rg);
            const _effectiveScope=_isProjRg?'project':(ohRegEdit.scope||'company');
            const _filteredProjects=_isProjRg?activeProjects.filter(p=>{
              if(ohRegEdit.rg==='ФК')return p.project_type==='ФК';
              if(ohRegEdit.rg==='РГ1')return p.project_type!=='ФК'&&(p.work_group||'')==='РГ1';
              if(ohRegEdit.rg==='РГ2')return p.project_type!=='ФК'&&(p.work_group||'')==='РГ2';
              return true;
            }):activeProjects;
            return <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
              <div style={_fs.row}><div style={_fs.label}>Уровень</div>{_isProjRg?<div style={{..._fs.input,background:'#f0f0f0',color:'#888'}}>Проект (авто по {ohRegEdit.rg})</div>:<select value={_effectiveScope} onChange={e=>setOhRegEdit(p=>({...p,scope:e.target.value,project_id:e.target.value==='company'?'':p.project_id}))} style={{..._fs.input,width:'100%'}}><option value="project">Проект</option><option value="company">Общефирм.</option></select>}</div>
              {_effectiveScope==='project'?<div style={_fs.row}><div style={_fs.label}>Проект{_isProjRg?' ('+ohRegEdit.rg+')':' (ACTIVE)'}</div><select value={ohRegEdit.project_id||''} onChange={e=>{const pid=e.target.value||null;setOhRegEdit(p=>({...p,project_id:pid,scope:pid?'project':p.scope}));}} style={{..._fs.input,width:'100%'}}><option value="">— выбрать —</option>{_filteredProjects.map(p=><option key={p.id} value={p.id}>{p.code} — {p.name}</option>)}</select></div>
              :<div style={_fs.row}><div style={_fs.label}>Тип расхода</div><select value={ohRegEdit.cf_type||'OCF'} onChange={e=>setOhRegEdit(p=>({...p,cf_type:e.target.value}))} style={{..._fs.input,width:'100%'}}><option value="OCF">OCF</option><option value="AHO">AHO</option><option value="OFFICE">OFFICE</option><option value="ICF">ICF</option></select></div>}
            </div>;
          })()}

          {/* Row 4b: Расходы инвестпроектов (только при cf_type=ICF) */}
          {(ohRegEdit.cf_type==='ICF')&&<div style={{background:'#f0f8ff',border:'1px solid #cce0ff',borderRadius:8,padding:10,marginBottom:10}}>
            <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:ohRegEdit.icf_project?8:0}}><input type="checkbox" checked={!!ohRegEdit.icf_project} onChange={e=>{if(e.target.checked)setOhRegEdit(p=>({...p,icf_project:'Стрела'}));else setOhRegEdit(p=>({...p,icf_project:''}));}} style={{accentColor:'var(--sky)'}}/><label style={{margin:0,fontSize:12,color:'#336',fontWeight:600}}>Расходы инвестпроектов</label><span style={{fontSize:10,color:'#888',marginLeft:4}}>(атрибутировать на конкретный инвестпроект)</span></div>
            {!!ohRegEdit.icf_project&&<div style={{marginLeft:22}}><select value={ohRegEdit.icf_project||''} onChange={e=>setOhRegEdit(p=>({...p,icf_project:e.target.value}))} style={{..._fs.input,width:'100%',fontWeight:600,color:'var(--sky)'}}>{['Стрела','Moove','Клуб ЧТД','Консорциум ЧТД','Скрытые Чемпионы','IAM'].map(n=><option key={n} value={n}>{n}</option>)}</select></div>}
          </div>}

          {/* Row 5: Комментарий */}
          <div style={_fs.row}><div style={_fs.label}>Комментарий / описание</div><textarea value={ohRegEdit.comment||''} onChange={e=>setOhRegEdit(p=>({...p,comment:e.target.value}))} rows={2} style={{..._fs.input,width:'100%',resize:'vertical',fontFamily:'inherit'}}/></div>

          {/* Row 6: Prior year */}
          <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:10}}><input type="checkbox" checked={!!ohRegEdit.prior_year} onChange={e=>setOhRegEdit(p=>({...p,prior_year:e.target.checked}))}/><label style={{margin:0,fontSize:12,color:'#666'}}>🕐 Расход прошлого года (не учитывать в текущем году)</label></div>

          {/* Actions */}
          <div style={{display:'flex',gap:10,marginTop:16,justifyContent:'flex-end',borderTop:'1px solid #ddd',paddingTop:12}}>
            <button style={{padding:'8px 20px',borderRadius:8,border:'1px solid #ccc',background:'#f5f5f5',cursor:'pointer',fontSize:12,color:'#555'}} onClick={()=>setOhRegEdit(null)}>Отмена</button>
            <button style={{padding:'8px 24px',borderRadius:8,border:'none',background:'#4361ee',color:'#fff',cursor:'pointer',fontSize:13,fontWeight:700,boxShadow:'0 2px 8px rgba(67,97,238,0.3)'}} onClick={saveEdit}>Сохранить</button>
          </div>
        </div>
      </div>;
      })()}

      {/* Diagnostic report modal */}
      {ohDiagReport&&(()=>{
        const dr=ohDiagReport;
        const mLabels=['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
        const _s={th:{padding:'4px 6px',fontSize:9,textAlign:'right',borderBottom:'1px solid #ddd'},td:{padding:'3px 6px',fontSize:9,textAlign:'right'},tdL:{padding:'3px 6px',fontSize:9,textAlign:'left'}};
        return <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.55)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999}} onClick={()=>setOhDiagReport(null)}>
          <div style={{background:'#fff',borderRadius:14,padding:20,width:'92vw',maxWidth:1100,maxHeight:'88vh',overflowY:'auto',boxShadow:'0 24px 80px rgba(0,0,0,0.4)',color:'#222'}} onClick={ev=>ev.stopPropagation()}>
            <div style={{fontSize:16,fontWeight:700,color:'var(--violet)',marginBottom:12,borderBottom:'2px solid var(--violet)',paddingBottom:6}}>🔬 Диагностика: project.overheads vs overhead_registry</div>

            {/* Section 1: RG Summary */}
            <div style={{fontSize:12,fontWeight:700,color:'var(--accent2)',marginBottom:6}}>1. Итоги по РГ и месяцам</div>
            <table style={{width:'100%',borderCollapse:'collapse',marginBottom:16}}>
              <thead><tr style={{background:'#f0f0f5'}}>
                <th style={{..._s.th,textAlign:'left',width:60}}>РГ</th>
                <th style={{..._s.th,textAlign:'left',width:70}}>Источник</th>
                {mLabels.map((ml,i)=><th key={i} style={_s.th}>{ml}</th>)}
                <th style={{..._s.th,fontWeight:700}}>Итого</th>
              </tr></thead>
              <tbody>{dr.rgSummary.filter(r=>r.regTotal>0||r.projByMonth.some(v=>v>0)).map(r=><React.Fragment key={r.rg}>
                <tr style={{background:'#fafafa'}}>
                  <td rowSpan={3} style={{..._s.tdL,fontWeight:700,color:rgC[r.rg],verticalAlign:'middle',borderRight:'1px solid #ddd'}}>{r.rg}</td>
                  <td style={{..._s.tdL,color:'#888'}}>Реестр</td>
                  {r.regByMonth.map((v,i)=><td key={i} style={{..._s.td,fontWeight:v>0?600:400}}>{v>0?fmt(v):''}</td>)}
                  <td style={{..._s.td,fontWeight:700}}>{fmt(r.regByMonth.reduce((a,b)=>a+b,0))}</td>
                </tr>
                <tr>
                  <td style={{..._s.tdL,color:'#888'}}>Проекты</td>
                  {r.projByMonth.map((v,i)=><td key={i} style={{..._s.td}}>{v>0?fmt(v):''}</td>)}
                  <td style={{..._s.td,fontWeight:600}}>{fmt(r.projByMonth.reduce((a,b)=>a+b,0))}</td>
                </tr>
                <tr style={{borderBottom:'2px solid #eee'}}>
                  <td style={{..._s.tdL,color:r.diff.some(v=>v!==0)?'var(--red)':'var(--green)',fontWeight:600}}>Δ</td>
                  {r.diff.map((v,i)=><td key={i} style={{..._s.td,color:v>0?'var(--red)':v<0?'var(--amber)':'var(--green)',fontWeight:v!==0?700:400,background:v!==0?'rgba(255,0,0,0.04)':''}}>{v!==0?(v>0?'+':'')+fmt(v):'✓'}</td>)}
                  <td style={{..._s.td,fontWeight:700,color:r.diff.reduce((a,b)=>a+b,0)!==0?'var(--red)':'var(--green)'}}>{(()=>{const t=r.diff.reduce((a,b)=>a+b,0);return t!==0?(t>0?'+':'')+fmt(t):'✓';})()}</td>
                </tr>
              </React.Fragment>)}</tbody>
            </table>

            {/* Section 2: Per-project detail */}
            <div style={{fontSize:12,fontWeight:700,color:'var(--accent2)',marginBottom:6}}>2. Расхождения по проектам ({dr.projDetail.length} проектов с разницей)</div>
            {dr.projDetail.length===0?<div style={{fontSize:11,color:'var(--green)',marginBottom:12}}>Расхождений не найдено ✓</div>:
            <table style={{width:'100%',borderCollapse:'collapse',marginBottom:16}}>
              <thead><tr style={{background:'#f0f0f5'}}>
                <th style={{..._s.th,textAlign:'left'}}>Проект</th>
                <th style={_s.th}>РГ</th>
                <th style={_s.th}>Проект OH (шт)</th>
                <th style={_s.th}>Реестр (шт)</th>
                <th style={_s.th}>Проект ₽</th>
                <th style={_s.th}>Реестр ₽</th>
                <th style={_s.th}>Δ ₽</th>
                <th style={{..._s.th,textAlign:'left'}}>Только в реестре</th>
                <th style={{..._s.th,textAlign:'left'}}>Только в проекте</th>
              </tr></thead>
              <tbody>{dr.projDetail.sort((a,b)=>Math.abs(b.diff)-Math.abs(a.diff)).map(pd=><tr key={pd.id} style={{borderBottom:'1px solid #eee',background:Math.abs(pd.diff)>0?'rgba(255,0,0,0.03)':''}}>
                <td style={{..._s.tdL,fontWeight:600}}>{pd.code} — {pd.name}</td>
                <td style={{..._s.td,color:rgC[pd.rg]}}>{pd.rg}</td>
                <td style={_s.td}>{pd.projCount}</td>
                <td style={_s.td}>{pd.regCount}</td>
                <td style={_s.td}>{fmt(pd.projTotal)}</td>
                <td style={_s.td}>{fmt(pd.regTotal)}</td>
                <td style={{..._s.td,fontWeight:700,color:pd.diff>0?'var(--red)':pd.diff<0?'var(--amber)':'var(--green)'}}>{pd.diff!==0?(pd.diff>0?'+':'')+fmt(pd.diff):'✓'}</td>
                <td style={{..._s.tdL,fontSize:8,maxWidth:160}}>{pd.regOnly.length>0?pd.regOnly.map((r,i)=><div key={i}>{r.date} {fmt(r.amount)} ({r.source})</div>):''}</td>
                <td style={{..._s.tdL,fontSize:8,maxWidth:160}}>{pd.projOnly.length>0?pd.projOnly.map((r,i)=><div key={i}>{r.date} {fmt(r.amount)} {r.name}</div>):''}</td>
              </tr>)}</tbody>
            </table>}

            {/* Section 3: Orphaned registry entries */}
            <div style={{fontSize:12,fontWeight:700,color:'var(--accent2)',marginBottom:6}}>3. Записи реестра (РГ1/РГ2/ФК) без привязки к проекту ({dr.orphaned.length})</div>
            {dr.orphaned.length===0?<div style={{fontSize:11,color:'var(--green)',marginBottom:12}}>Нет «сиротских» записей ✓</div>:
            <table style={{width:'100%',borderCollapse:'collapse',marginBottom:16}}>
              <thead><tr style={{background:'#fff0f0'}}>
                <th style={{..._s.th,textAlign:'left'}}>Дата</th>
                <th style={_s.th}>Сумма</th>
                <th style={_s.th}>РГ</th>
                <th style={{..._s.th,textAlign:'left'}}>Описание</th>
                <th style={{..._s.th,textAlign:'left'}}>Источник</th>
              </tr></thead>
              <tbody>{dr.orphaned.map((e,i)=><tr key={i} style={{borderBottom:'1px solid #eee'}}>
                <td style={_s.tdL}>{e.date}</td>
                <td style={{..._s.td,fontWeight:600}}>{fmt(e.amount)}</td>
                <td style={{..._s.td,color:rgC[e.rg]}}>{e.rg}</td>
                <td style={{..._s.tdL,maxWidth:200,overflow:'hidden',textOverflow:'ellipsis'}} title={e.comment}>{e.comment}</td>
                <td style={_s.tdL}>{e.source}</td>
              </tr>)}</tbody>
            </table>}

            <div style={{display:'flex',justifyContent:'flex-end',paddingTop:10,borderTop:'1px solid #ddd'}}>
              <button style={{padding:'8px 24px',borderRadius:8,border:'none',background:'var(--violet)',color:'#fff',cursor:'pointer',fontSize:12,fontWeight:600}} onClick={()=>setOhDiagReport(null)}>Закрыть</button>
            </div>
          </div>
        </div>;
      })()}
    </div>;
  })()}

  {fmTab==='invest_proj'&&(()=>{
    const ICF_PROJECTS=['Стрела','Moove','Клуб ЧТД','Консорциум ЧТД','Скрытые Чемпионы','IAM'];
    const _or=store.data.overhead_registry||[];
    const MONTHS_S=['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
    const curProj=investProjTab;
    /* Все операции текущего инвестпроекта за yr */
    const projOps=_or.filter(e=>e.scope==='company'&&(e.cf_type||'')==='ICF'&&e.icf_project===curProj&&(e.date||'').startsWith(yr+'')).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
    const totalAmt=projOps.reduce((s,e)=>s+Number(e.amount||0),0);
    /* Помесячные суммы */
    const monthTotals=Array.from({length:12},(_,i)=>{
      const pfx=yr+'-'+String(i+1).padStart(2,'0');
      return projOps.filter(e=>(e.date||'').startsWith(pfx)).reduce((s,e)=>s+Number(e.amount||0),0);
    });
    /* Итого по всем инвестпроектам для сводки */
    const allProjSummary=ICF_PROJECTS.map(pn=>{
      const ops=_or.filter(e=>e.scope==='company'&&(e.cf_type||'')==='ICF'&&e.icf_project===pn&&(e.date||'').startsWith(yr+''));
      const tot=ops.reduce((s,e)=>s+Number(e.amount||0),0);
      const byMonth=Array.from({length:12},(_,i)=>{
        const pfx=yr+'-'+String(i+1).padStart(2,'0');
        return ops.filter(e=>(e.date||'').startsWith(pfx)).reduce((s,e)=>s+Number(e.amount||0),0);
      });
      return {name:pn,total:tot,byMonth,count:ops.length};
    });
    const grandTotal=allProjSummary.reduce((s,x)=>s+x.total,0);

    return <div>
      {/* Подвкладки инвестпроектов */}
      <div style={{display:'flex',gap:4,marginBottom:12,flexWrap:'wrap'}}>
        {ICF_PROJECTS.map(pn=><div key={pn} style={{padding:'5px 12px',borderRadius:8,fontSize:11,fontWeight:investProjTab===pn?700:400,cursor:'pointer',background:investProjTab===pn?'var(--accent)':'var(--bg3)',color:investProjTab===pn?'#fff':'var(--text1)',border:investProjTab===pn?'none':'1px solid var(--border)',transition:'all .15s'}} onClick={()=>setInvestProjTab(pn)}>{pn}</div>)}
      </div>

      {/* Сводная таблица по всем инвестпроектам */}
      <div className="dash-card" style={{padding:10,marginBottom:16}}>
        <div style={{fontSize:13,fontWeight:700,marginBottom:8,color:'var(--sky)'}}>Сводка расходов инвестпроектов — {yr}</div>
        <table style={{width:'100%',fontSize:10,borderCollapse:'collapse'}}>
          <thead><tr style={{background:'var(--bg3)'}}>
            <th style={{textAlign:'left',padding:'4px 6px',minWidth:140}}>Проект</th>
            <th style={{textAlign:'right',padding:'4px 4px',fontWeight:700,background:'var(--accent)',color:'#fff'}}>Итого</th>
            {MONTHS_S.map((m,i)=><th key={i} style={{textAlign:'right',padding:'4px 4px'}}>{m}</th>)}
          </tr></thead>
          <tbody>
            {allProjSummary.map((ps,ri)=><tr key={ps.name} style={{borderBottom:'1px solid var(--bg3)',background:ps.name===curProj?'rgba(67,97,238,0.06)':'',cursor:'pointer'}} onClick={()=>setInvestProjTab(ps.name)}>
              <td style={{padding:'3px 6px',fontWeight:ps.name===curProj?700:400,color:ps.name===curProj?'var(--accent)':'var(--text1)'}}>{ps.name}{ps.count>0&&<span style={{fontSize:8,color:'var(--text2)',marginLeft:4}}>({ps.count})</span>}</td>
              <td style={{textAlign:'right',padding:'3px 4px',fontWeight:700,background:'var(--bg3)'}}>{fmt(ps.total)}</td>
              {ps.byMonth.map((v,i)=><td key={i} style={{textAlign:'right',padding:'3px 4px',color:v>0?'var(--red)':'var(--text2)'}}>{v>0?fmt(v):'—'}</td>)}
            </tr>)}
            <tr style={{borderTop:'2px solid var(--accent)',fontWeight:700,background:'var(--bg3)'}}>
              <td style={{padding:'4px 6px'}}>ИТОГО</td>
              <td style={{textAlign:'right',padding:'4px 4px',fontWeight:700}}>{fmt(grandTotal)}</td>
              {Array.from({length:12},(_,i)=>{const v=allProjSummary.reduce((s,ps)=>s+(ps.byMonth[i]||0),0);return <td key={i} style={{textAlign:'right',padding:'3px 4px'}}>{v>0?fmt(v):'—'}</td>;})}
            </tr>
          </tbody>
        </table>
      </div>

      {/* ===== ДАШБОРД ИНВЕСТПРОЕКТА ===== */}
      {(()=>{
        const _allDeals=(store.data.icf_deals||[]).filter(d=>d.icf_project===curProj&&((d.date||'').startsWith(yr+'')||(!d.date&&!!d.is_forecast)));
        const _deals=_allDeals.filter(d=>!d.is_forecast);
        const _foreDeals=_allDeals.filter(d=>!!d.is_forecast);
        const _expOps=projOps;/* overhead entries with icf_project=curProj, already filtered by yr */

        /* --- Revenue KPIs (факт) --- */
        const revenue=_deals.reduce((s,d)=>s+(Number(d.cost)||0),0);
        const totalCommission=_deals.reduce((s,d)=>s+(Number(d.commission)||0),0);
        const totalReceived=_deals.reduce((s,d)=>s+(Number(d.received)||0),0);
        const totalTaxD=_deals.reduce((s,d)=>s+(Number(d.tax_amount)||0),0);
        const totalEarned=_deals.reduce((s,d)=>s+(Number(d.earned)||0),0);
        const payCount=_deals.length;
        const uniqueClients=[...new Set(_deals.map(d=>(d.company||d.user_name||'').toLowerCase()).filter(x=>x&&x!=='-'))];
        const clientCount=uniqueClients.length;
        const avgLTV=clientCount>0?Math.round(revenue/clientCount):0;
        const avgPayment=payCount>0?Math.round(revenue/payCount):0;
        const payPerClient=clientCount>0?(payCount/clientCount).toFixed(2):'0';

        /* --- Revenue KPIs (факт+прогноз) --- */
        const fRevenue=revenue+_foreDeals.reduce((s,d)=>s+(Number(d.cost)||0),0);
        const fCommission=totalCommission+_foreDeals.reduce((s,d)=>s+(Number(d.commission)||0),0);
        const fReceived=totalReceived+_foreDeals.reduce((s,d)=>s+(Number(d.received)||0),0);
        const fTaxD=totalTaxD+_foreDeals.reduce((s,d)=>s+(Number(d.tax_amount)||0),0);
        const fEarned=totalEarned+_foreDeals.reduce((s,d)=>s+(Number(d.earned)||0),0);
        const fPayCount=_allDeals.length;
        const fUniqueClients=[...new Set(_allDeals.map(d=>(d.company||d.user_name||'').toLowerCase()).filter(x=>x&&x!=='-'))];
        const fClientCount=fUniqueClients.length;
        const fAvgLTV=fClientCount>0?Math.round(fRevenue/fClientCount):0;
        const fAvgPayment=fPayCount>0?Math.round(fRevenue/fPayCount):0;
        const fPayPerClient=fClientCount>0?(fPayCount/fClientCount).toFixed(2):'0';
        const hasFore=_foreDeals.length>0;

        /* --- Overhead: авансированная прибыль (отдельно, не расход) --- */
        const _catLow=(e)=>(e.category||'').toLowerCase()+(e.cls||'').toLowerCase()+(e.comment||'').toLowerCase();
        const advProfitExp=_expOps.filter(e=>{const c=_catLow(e);return c.includes('аванс')&&c.includes('прибыл');}).reduce((s,e)=>s+(Number(e.amount)||0),0);

        /* --- Опер.расходы = налоги + комиссия ПС + 5% комм.персоналу --- */
        const commStaff5=Math.round(totalEarned*0.05);
        const operExp=totalTaxD+totalCommission+commStaff5;
        /* Прогнозные опер.расходы */
        const fCommStaff5=Math.round(fEarned*0.05);
        const fOperExp=fTaxD+fCommission+fCommStaff5;

        /* --- Будущая авансированная прибыль: 500К/мес март–декабрь (минус уже занесённые) --- */
        let futAdvTotal=0;
        for(let m=3;m<=12;m++){
          const pfx2=yr+'-'+String(m).padStart(2,'0');
          const already=_expOps.filter(e=>(e.date||'').startsWith(pfx2)&&_catLow(e).includes('аванс')&&_catLow(e).includes('прибыл')).reduce((s,e)=>s+(Number(e.amount)||0),0);
          if(already<500000)futAdvTotal+=(500000-already);
        }
        const totalAdvAll=advProfitExp+futAdvTotal;/* вся аванс.прибыль (факт + прогноз) */

        /* --- Доля Дарьи Лавшук в 5% комиссии --- */
        const lavshukEarned=_deals.filter(d=>(d.seller||'').toLowerCase().includes('лавшук')).reduce((s,d)=>s+(Number(d.earned)||0),0);
        const lavshuk5=Math.round(lavshukEarned*0.05);
        const fLavshukEarned=_allDeals.filter(d=>(d.seller||'').toLowerCase().includes('лавшук')).reduce((s,d)=>s+(Number(d.earned)||0),0);
        const fLavshuk5=Math.round(fLavshukEarned*0.05);

        /* --- Общий P&L ---
           Прибыль всех партнёров = Выручка − Опер.расходы */
        const profit=revenue-operExp;
        const profitNoAdv=profit-advProfitExp;/* без факт.авансированной прибыли — базис */
        const profitIlya=Math.round(profitNoAdv*0.66);
        const profitAndrey=Math.round(profitNoAdv*0.34)-advProfitExp;
        const margin=revenue>0?((profit/revenue)*100).toFixed(1):'0';
        /* Красная скобка: прибыль за вычетом ВСЕЙ аванс.прибыли (факт + будущая) */
        const profitMinusAllAdv=profit-totalAdvAll;
        const profitNoAdvAll=profitMinusAllAdv;/* без всей аванс.прибыли */
        const profitIlyaAll=Math.round(profitNoAdvAll*0.66);
        const profitAndreyAll=Math.round(profitNoAdvAll*0.34)-totalAdvAll;
        const fProfit=fRevenue-fOperExp;
        const fProfitNoAdv=fProfit-advProfitExp;
        const fProfitIlya=Math.round(fProfitNoAdv*0.66);
        const fProfitAndrey=Math.round(fProfitNoAdv*0.34)-advProfitExp;
        const fProfitMinusAllAdv=fProfit-totalAdvAll;
        const fProfitNoAdvAll=fProfitMinusAllAdv;
        const fProfitIlyaAll=Math.round(fProfitNoAdvAll*0.66);
        const fProfitAndreyAll=Math.round(fProfitNoAdvAll*0.34)-totalAdvAll;
        const fMargin=fRevenue>0?((fProfit/fRevenue)*100).toFixed(1):'0';

        /* --- Нормативная прибыль Ильи ---
           = max(12.5М, 12.5М + 2×прибыль Андрея), не ниже 12.5М ни при каких обстоятельствах */
        const NORM_FLOOR=12500000;
        const normProfitIlya=Math.max(NORM_FLOOR,NORM_FLOOR+2*profitAndrey);
        /* Целевая выручка: normProfitIlya = 0.66 × (targetRev×marginDec − advProfitExp)
           → targetProfit = normProfitIlya/0.66 + advProfitExp
           → targetRev = targetProfit / marginDec */
        const marginDec=revenue>0?profit/revenue:0;
        const targetProfitTotal=Math.round(normProfitIlya/0.66)+advProfitExp;
        const targetRevenue_=marginDec>0?Math.round(targetProfitTotal/marginDec):0;
        const remainingRev=Math.max(0,targetRevenue_-revenue);
        /* forecast version */
        const fNormProfitIlya=Math.max(NORM_FLOOR,NORM_FLOOR+2*fProfitAndrey);
        const fMarginDec=fRevenue>0?fProfit/fRevenue:0;
        const fTargetProfitTotal=Math.round(fNormProfitIlya/0.66)+advProfitExp;
        const fTargetRevenue_=fMarginDec>0?Math.round(fTargetProfitTotal/fMarginDec):0;
        const fRemainingRev=Math.max(0,fTargetRevenue_-fRevenue);

        /* --- Помесячные данные --- */
        const byMonth=Array.from({length:12},(_,i)=>{
          const pfx=yr+'-'+String(i+1).padStart(2,'0');
          const mDeals=_deals.filter(d=>(d.date||'').startsWith(pfx));
          const mExp=_expOps.filter(e=>(e.date||'').startsWith(pfx));
          const mRev=mDeals.reduce((s,d)=>s+(Number(d.cost)||0),0);
          const mRecv=mDeals.reduce((s,d)=>s+(Number(d.received)||0),0);
          const mTax=mDeals.reduce((s,d)=>s+(Number(d.tax_amount)||0),0);
          const mEarn=mDeals.reduce((s,d)=>s+(Number(d.earned)||0),0);
          const mComm5=Math.round(mEarn*0.05);/* 5% комм.персоналу */
          const mCommPS=mDeals.reduce((s,d)=>s+(Number(d.commission)||0),0);
          const mOperExp=mTax+mCommPS+mComm5;/* опер.расходы = налоги + комиссии ПС + 5% */
          const mAdvProf=mExp.filter(e=>{const c=_catLow(e);return c.includes('аванс')&&c.includes('прибыл');}).reduce((s,e)=>s+(Number(e.amount)||0),0);
          const mClients=[...new Set(mDeals.map(d=>(d.company||d.user_name||'').toLowerCase()).filter(x=>x&&x!=='-'))].length;
          const mPays=mDeals.length;
          const mProfit=mRev-mOperExp;
          return {rev:mRev,recv:mRecv,tax:mTax,earn:mEarn,operExp:mOperExp,comm5:mComm5,commPS:mCommPS,advProf:mAdvProf,clients:mClients,pays:mPays,profit:mProfit,margin:mRev>0?(mProfit/mRev*100).toFixed(0):0,avgPay:mPays>0?Math.round(mRev/mPays):0};
        });

        /* --- Helper: format short --- */
        const fmtS=(v)=>Math.abs(v)>=1e6?(v/1e6).toFixed(2)+' млн':Math.abs(v)>=1e3?(v/1e3).toFixed(1)+' тыс.':v+'';
        const _kpi=(label,val,color,sub,foreVal,redVal)=><div style={{background:'var(--bg0)',border:'1px solid var(--border)',borderRadius:8,padding:'8px 10px',minWidth:110,flex:'1 1 120px'}}>
          <div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>{label}</div>
          <div style={{fontSize:16,fontWeight:700,color:color||'var(--text1)'}}>{val}{foreVal!==undefined&&hasFore&&<span style={{fontSize:11,fontWeight:500,color:'var(--violet)',marginLeft:3}}>({foreVal})</span>}{redVal!==undefined&&<span style={{fontSize:10,fontWeight:600,color:'var(--red)',marginLeft:3}}>[{redVal}]</span>}</div>
          {sub&&<div style={{fontSize:8,color:'var(--text2)',marginTop:1}}>{sub}</div>}
        </div>;

        /* --- Breakdown helper --- */
        const _breakdown=(groupField)=>{
          const map={};
          _deals.forEach(d=>{const k=d[groupField]||'Не указано';if(!map[k])map[k]={rev:0,clients:new Set(),pays:0,avgPay:0};map[k].rev+=Number(d.cost)||0;map[k].clients.add((d.company||d.user_name||'').toLowerCase());map[k].pays++;});
          return Object.entries(map).map(([k,v])=>({name:k,rev:v.rev,pctRev:revenue>0?((v.rev/revenue)*100).toFixed(1):'0',clients:v.clients.size,ltv:v.clients.size>0?Math.round(v.rev/v.clients.size):0,payPerCl:v.clients.size>0?(v.pays/v.clients.size).toFixed(2):'0',avgPay:v.pays>0?Math.round(v.rev/v.pays):0,pays:v.pays})).sort((a,b)=>b.rev-a.rev);
        };

        const _barH=50;
        const _bar=(data,maxV,color)=>data.map((v,i)=>{const h=maxV>0?Math.max(1,v/maxV*_barH):1;return <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-end',height:_barH+14}}>
          {v>0&&<div style={{fontSize:7,color:'var(--text2)',marginBottom:1}}>{fmtS(v)}</div>}
          <div style={{width:'80%',background:v>0?color:'var(--bg3)',borderRadius:2,height:h+'px'}}/>
          <div style={{fontSize:7,color:'var(--text2)',marginTop:1}}>{MONTHS_S[i]}</div>
        </div>;});

        const _tbl=(rows)=><table style={{width:'100%',fontSize:10,borderCollapse:'collapse'}}>
          <thead><tr style={{borderBottom:'1px solid var(--border)',background:'var(--bg3)'}}>
            <th style={{textAlign:'left',padding:'3px 5px'}}>Название</th>
            <th style={{textAlign:'right',padding:'3px 5px'}}>Выручка</th>
            <th style={{textAlign:'right',padding:'3px 5px'}}>%</th>
            <th style={{textAlign:'right',padding:'3px 5px'}}>Клиенты</th>
            <th style={{textAlign:'right',padding:'3px 5px'}}>LTV</th>
            <th style={{textAlign:'right',padding:'3px 5px'}}>Опл/кл</th>
            <th style={{textAlign:'right',padding:'3px 5px'}}>Ср.опл</th>
            <th style={{textAlign:'right',padding:'3px 5px'}}>Оплат</th>
          </tr></thead>
          <tbody>{rows.map((r,i)=><tr key={i} style={{borderBottom:'1px solid var(--bg3)'}}>
            <td style={{padding:'2px 5px',fontWeight:500,maxWidth:150,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{r.name}</td>
            <td style={{padding:'2px 5px',textAlign:'right',fontWeight:600}}>{fmt(r.rev)}</td>
            <td style={{padding:'2px 5px',textAlign:'right',color:'var(--text2)'}}>{r.pctRev}%</td>
            <td style={{padding:'2px 5px',textAlign:'right'}}>{r.clients}</td>
            <td style={{padding:'2px 5px',textAlign:'right'}}>{fmt(r.ltv)}</td>
            <td style={{padding:'2px 5px',textAlign:'right',color:'var(--text2)'}}>{r.payPerCl}</td>
            <td style={{padding:'2px 5px',textAlign:'right'}}>{fmt(r.avgPay)}</td>
            <td style={{padding:'2px 5px',textAlign:'right'}}>{r.pays}</td>
          </tr>)}</tbody>
        </table>;

        return <div className="dash-card" style={{padding:12,marginBottom:16}}>
          <div style={{fontSize:14,fontWeight:700,marginBottom:10,color:'var(--accent)'}}>{curProj} — Дашборд {yr}</div>

          {/* KPI Cards Row 1 — Прибыль и распределение */}
          <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:8}}>
            {_kpi('Прибыль всех партнёров',fmtS(profit),profit>=0?'var(--emerald)':'var(--red)','В т.ч. аванс.прибыль: '+fmtS(advProfitExp),fmtS(fProfit),fmtS(profitMinusAllAdv))}
            {_kpi('Без аванс. прибыли',fmtS(profitNoAdv),profitNoAdv>=0?'var(--emerald)':'var(--red)','Базис для распределения',fmtS(fProfitNoAdv),fmtS(profitNoAdvAll))}
            {_kpi('Прибыль Ильи (66%)',fmtS(profitIlya),'var(--sky)','Норматив: '+fmtS(normProfitIlya),fmtS(fProfitIlya),fmtS(profitIlyaAll))}
            {_kpi('Прибыль Андрея (34%−аванс)',fmtS(profitAndrey),'var(--amber)','34% = '+fmtS(Math.round(profitNoAdv*0.34))+' − аванс '+fmtS(advProfitExp),fmtS(fProfitAndrey),fmtS(profitAndreyAll))}
            {_kpi('Норм. прибыль Ильи',fmtS(normProfitIlya),'var(--sky)','min 12.5М или 12.5М + 2×Андрей',fmtS(fNormProfitIlya))}
            {_kpi('Целевая выручка',fmtS(targetRevenue_),remainingRev>0?'var(--amber)':'var(--emerald)','Осталось: '+fmtS(remainingRev)+' (маржа '+margin+'%)',fmtS(fTargetRevenue_))}
          </div>
          {/* KPI Cards Row 2 — Выручка и опер.расходы */}
          <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:8}}>
            {_kpi('Выручка',fmtS(revenue),'var(--emerald)',null,fmtS(fRevenue))}
            {_kpi('Опер. расходы',fmtS(operExp),'var(--red)','Налоги + Комиссии ПС + 5% комм.',fmtS(fOperExp))}
            {_kpi('Маржинальность',margin+'%',Number(margin)>=40?'var(--emerald)':Number(margin)>=20?'var(--amber)':'var(--red)',null,fMargin+'%')}
            {_kpi('Налоги',fmtS(totalTaxD),'var(--red)',null,fmtS(fTaxD))}
            {_kpi('Комиссии ПС',fmtS(totalCommission),'var(--amber)',null,fmtS(fCommission))}
            {_kpi('5% комм.персоналу',fmtS(commStaff5),'var(--amber)','от заработанного, в т.ч. Д.Лавшук: '+fmtS(lavshuk5),fmtS(fCommStaff5))}
          </div>
          {/* KPI Cards Row 3 — Клиенты и аванс */}
          <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:14}}>
            {_kpi('Кол-во клиентов',clientCount,'var(--sky)',null,fClientCount)}
            {_kpi('Средний LTV',fmtS(avgLTV),'var(--accent)',null,fmtS(fAvgLTV))}
            {_kpi('Кол-во оплат',payCount,'var(--text1)',null,fPayCount)}
            {_kpi('Оплат на клиента',payPerClient,'var(--text1)',null,fPayPerClient)}
            {_kpi('Ср. сумма оплаты',fmtS(avgPayment),'var(--accent)',null,fmtS(fAvgPayment))}
            {_kpi('Аванс. прибыль',fmtS(advProfitExp),'var(--violet)',advProfitExp===0?'Нет данных':'Выплачена Андрею, не в расходах',null,fmtS(totalAdvAll))}
          </div>

          {/* CHARTS */}
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:14}}>
            {/* Выручка vs Расходы */}
            <div style={{background:'var(--bg1)',borderRadius:8,padding:8,border:'1px solid var(--border)'}}>
              <div style={{fontSize:10,fontWeight:600,marginBottom:6}}>Выручка vs Расходы</div>
              <div style={{display:'flex',gap:1,alignItems:'flex-end'}}>
                {(()=>{const maxV=Math.max(...byMonth.map(m=>Math.max(m.rev,m.exp)),1);return byMonth.map((m,i)=><div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-end',height:64}}>
                  <div style={{display:'flex',gap:1,alignItems:'flex-end',width:'100%',justifyContent:'center'}}>
                    <div style={{width:'40%',background:m.rev>0?'var(--emerald)':'var(--bg3)',borderRadius:2,height:Math.max(1,m.rev/maxV*50)+'px'}} title={'Выручка: '+fmt(m.rev)}/>
                    <div style={{width:'40%',background:m.exp>0?'var(--red)':'var(--bg3)',borderRadius:2,height:Math.max(1,m.exp/maxV*50)+'px'}} title={'Расходы: '+fmt(m.exp)}/>
                  </div>
                  <div style={{fontSize:7,color:'var(--text2)',marginTop:2}}>{MONTHS_S[i]}</div>
                </div>);})()}
              </div>
              <div style={{display:'flex',gap:8,justifyContent:'center',marginTop:4}}><span style={{fontSize:8}}><span style={{display:'inline-block',width:8,height:8,background:'var(--emerald)',borderRadius:2,marginRight:2,verticalAlign:'middle'}}/> Выручка</span><span style={{fontSize:8}}><span style={{display:'inline-block',width:8,height:8,background:'var(--red)',borderRadius:2,marginRight:2,verticalAlign:'middle'}}/> Расходы</span></div>
            </div>

            {/* Прибыль по месяцам */}
            <div style={{background:'var(--bg1)',borderRadius:8,padding:8,border:'1px solid var(--border)'}}>
              <div style={{fontSize:10,fontWeight:600,marginBottom:6}}>Прибыль по месяцам</div>
              <div style={{display:'flex',gap:1,alignItems:'flex-end'}}>
                {(()=>{const vals=byMonth.map(m=>m.profit);const maxA=Math.max(...vals.map(Math.abs),1);return vals.map((v,i)=><div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-end',height:64}}>
                  {v!==0&&<div style={{fontSize:7,color:v>=0?'var(--emerald)':'var(--red)',marginBottom:1}}>{fmtS(v)}</div>}
                  <div style={{width:'70%',background:v>=0?'var(--emerald)':'var(--red)',borderRadius:2,height:Math.max(1,Math.abs(v)/maxA*44)+'px'}}/>
                  <div style={{fontSize:7,color:'var(--text2)',marginTop:2}}>{MONTHS_S[i]}</div>
                </div>);})()}
              </div>
            </div>

            {/* Маржинальность */}
            <div style={{background:'var(--bg1)',borderRadius:8,padding:8,border:'1px solid var(--border)'}}>
              <div style={{fontSize:10,fontWeight:600,marginBottom:6}}>Маржинальность, %</div>
              <div style={{display:'flex',gap:1,alignItems:'flex-end'}}>
                {(()=>{return byMonth.map((m,i)=>{const mg=Number(m.margin)||0;return <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-end',height:64}}>
                  {mg!==0&&<div style={{fontSize:7,color:mg>=40?'var(--emerald)':mg>=20?'var(--amber)':'var(--red)',marginBottom:1}}>{mg}%</div>}
                  <div style={{width:'70%',background:mg>=40?'var(--emerald)':mg>=20?'var(--amber)':'var(--red)',borderRadius:2,height:Math.max(1,Math.abs(mg)/100*44)+'px',opacity:mg===0?0.2:1}}/>
                  <div style={{fontSize:7,color:'var(--text2)',marginTop:2}}>{MONTHS_S[i]}</div>
                </div>;});})()}
              </div>
            </div>

            {/* Кол-во клиентов */}
            <div style={{background:'var(--bg1)',borderRadius:8,padding:8,border:'1px solid var(--border)'}}>
              <div style={{fontSize:10,fontWeight:600,marginBottom:6}}>Кол-во клиентов / оплат</div>
              <div style={{display:'flex',gap:1,alignItems:'flex-end'}}>
                {(()=>{const maxV=Math.max(...byMonth.map(m=>Math.max(m.clients,m.pays)),1);return byMonth.map((m,i)=><div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-end',height:64}}>
                  <div style={{display:'flex',gap:1,alignItems:'flex-end',width:'100%',justifyContent:'center'}}>
                    <div style={{width:'40%',background:m.clients>0?'var(--sky)':'var(--bg3)',borderRadius:2,height:Math.max(1,m.clients/maxV*44)+'px'}} title={'Клиенты: '+m.clients}/>
                    <div style={{width:'40%',background:m.pays>0?'var(--accent2)':'var(--bg3)',borderRadius:2,height:Math.max(1,m.pays/maxV*44)+'px'}} title={'Оплаты: '+m.pays}/>
                  </div>
                  <div style={{fontSize:7,color:'var(--text2)',marginTop:2}}>{MONTHS_S[i]}</div>
                </div>);})()}
              </div>
              <div style={{display:'flex',gap:8,justifyContent:'center',marginTop:4}}><span style={{fontSize:8}}><span style={{display:'inline-block',width:8,height:8,background:'var(--sky)',borderRadius:2,marginRight:2,verticalAlign:'middle'}}/> Клиенты</span><span style={{fontSize:8}}><span style={{display:'inline-block',width:8,height:8,background:'var(--accent2)',borderRadius:2,marginRight:2,verticalAlign:'middle'}}/> Оплаты</span></div>
            </div>

            {/* Средняя сумма оплаты */}
            <div style={{background:'var(--bg1)',borderRadius:8,padding:8,border:'1px solid var(--border)'}}>
              <div style={{fontSize:10,fontWeight:600,marginBottom:6}}>Средняя сумма оплаты</div>
              <div style={{display:'flex',gap:1,alignItems:'flex-end'}}>
                {(()=>{const vals=byMonth.map(m=>m.avgPay);const maxV=Math.max(...vals,1);return _bar(vals,maxV,'var(--accent)');})()}
              </div>
            </div>

            {/* Расходы breakdown */}
            <div style={{background:'var(--bg1)',borderRadius:8,padding:8,border:'1px solid var(--border)'}}>
              <div style={{fontSize:10,fontWeight:600,marginBottom:6}}>Структура расходов</div>
              <div style={{display:'flex',gap:1,alignItems:'flex-end'}}>
                {(()=>{
                  return byMonth.map((m,i)=>{
                    const mTax=m.tax;
                    const mC5=m.comm5;
                    const mCPS=m.commPS||0;
                    const tot=mTax+mCPS+mC5;
                    const maxT=Math.max(...byMonth.map(mm=>mm.operExp||0),1);
                    return <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-end',height:64}}>
                      <div style={{width:'80%',display:'flex',flexDirection:'column-reverse',height:Math.max(1,tot/maxT*50)+'px'}}>
                        {mC5>0&&<div style={{width:'100%',background:'#f59e0b',height:(mC5/tot*100)+'%'}} title={'5% комм: '+fmt(mC5)}/>}
                        {mCPS>0&&<div style={{width:'100%',background:'#8b5cf6',height:(mCPS/tot*100)+'%'}} title={'Комиссии ПС: '+fmt(mCPS)}/>}
                        {mTax>0&&<div style={{width:'100%',background:'#ef4444',height:(mTax/tot*100)+'%'}} title={'Налоги: '+fmt(mTax)}/>}
                      </div>
                      <div style={{fontSize:7,color:'var(--text2)',marginTop:2}}>{MONTHS_S[i]}</div>
                    </div>;
                  });
                })()}
              </div>
              <div style={{display:'flex',gap:6,justifyContent:'center',marginTop:4,flexWrap:'wrap'}}>
                <span style={{fontSize:7}}><span style={{display:'inline-block',width:7,height:7,background:'#ef4444',borderRadius:1,marginRight:2,verticalAlign:'middle'}}/> Налоги</span>
                <span style={{fontSize:7}}><span style={{display:'inline-block',width:7,height:7,background:'#8b5cf6',borderRadius:1,marginRight:2,verticalAlign:'middle'}}/> Комиссии ПС</span>
                <span style={{fontSize:7}}><span style={{display:'inline-block',width:7,height:7,background:'#f59e0b',borderRadius:1,marginRight:2,verticalAlign:'middle'}}/> 5% комм.</span>
              </div>
            </div>
          </div>

          {/* BREAKDOWN TABLES */}
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10}}>
            <div style={{background:'var(--bg1)',borderRadius:8,padding:8,border:'1px solid var(--border)'}}>
              <div style={{fontSize:10,fontWeight:600,marginBottom:4}}>По продукту</div>
              {_tbl(_breakdown('product'))}
            </div>
            <div style={{background:'var(--bg1)',borderRadius:8,padding:8,border:'1px solid var(--border)'}}>
              <div style={{fontSize:10,fontWeight:600,marginBottom:4}}>По продавцу</div>
              {_tbl(_breakdown('seller'))}
            </div>
            <div style={{background:'var(--bg1)',borderRadius:8,padding:8,border:'1px solid var(--border)'}}>
              <div style={{fontSize:10,fontWeight:600,marginBottom:4}}>По платёжной системе</div>
              {_tbl(_breakdown('pay_system'))}
            </div>
          </div>
        </div>;
      })()}

      {/* Детализация расходов инвестпроекта */}
      <div className="dash-card" style={{padding:10}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
          <div style={{fontSize:13,fontWeight:700,color:'var(--accent2)'}}>{curProj} — Расходы</div>
          <div style={{fontSize:11,color:'var(--text2)'}}>Операций: {projOps.length} | Итого: <b style={{color:'var(--red)'}}>{fmt(totalAmt)} ₽</b></div>
        </div>

        {/* Мини-бар по месяцам */}
        <div style={{display:'flex',gap:2,marginBottom:12,alignItems:'flex-end',height:40}}>
          {monthTotals.map((v,i)=>{const maxV=Math.max(...monthTotals,1);return <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:2}}>
            <div style={{width:'100%',background:v>0?'var(--red)':'var(--bg3)',borderRadius:3,height:Math.max(2,v/maxV*36)+'px',transition:'height .3s'}}/>
            <div style={{fontSize:7,color:'var(--text2)'}}>{MONTHS_S[i]}</div>
          </div>;})}
        </div>

        {projOps.length===0?<div style={{fontSize:12,color:'var(--text2)',padding:20,textAlign:'center'}}>Нет операций для «{curProj}» за {yr} год</div>
        :<div style={{maxHeight:300,overflowY:'auto'}}>
          <table style={{width:'100%',fontSize:11,borderCollapse:'collapse'}}>
            <thead><tr style={{borderBottom:'1px solid var(--border)',background:'var(--bg3)'}}>
              <th style={{textAlign:'left',padding:'3px 6px'}}>Дата</th>
              <th style={{textAlign:'right',padding:'3px 6px'}}>Сумма</th>
              <th style={{textAlign:'left',padding:'3px 6px'}}>Категория</th>
              <th style={{textAlign:'left',padding:'3px 6px'}}>Комментарий</th>
              <th style={{textAlign:'left',padding:'3px 6px',fontSize:9}}>Ответственный</th>
              <th style={{textAlign:'center',padding:'3px 4px',fontSize:9}}>✓</th>
              <th style={{textAlign:'center',padding:'3px 4px',fontSize:9}}></th>
            </tr></thead>
            <tbody>{projOps.map(e=><tr key={e.id} style={{borderBottom:'1px solid var(--bg3)'}}>
              <td style={{padding:'3px 6px',whiteSpace:'nowrap',fontSize:10}}>{e.date}</td>
              <td style={{padding:'3px 6px',textAlign:'right',fontWeight:600,color:'var(--red)'}}>{fmt(Number(e.amount)||0)}</td>
              <td style={{padding:'3px 6px',color:'var(--text2)'}}>{e.category}{e.cls&&<span style={{color:'var(--text2)',fontSize:9}}> / {e.cls}</span>}</td>
              <td style={{padding:'3px 6px',color:'var(--text2)',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{e.comment||'—'}</td>
              <td style={{padding:'3px 6px',fontSize:9,color:'var(--text2)'}}>{e.responsible||'—'}</td>
              <td style={{padding:'3px 4px',textAlign:'center'}}><input type="checkbox" checked={!!e.verified} onChange={()=>store.toggleOhRegistryVerified(e.id)} style={{cursor:'pointer',accentColor:'var(--green)'}}/></td>
              <td style={{padding:'3px 2px',textAlign:'center'}}><button style={{fontSize:9,padding:'1px 4px',border:'1px solid var(--red)',borderRadius:3,background:'transparent',color:'var(--red)',cursor:'pointer',lineHeight:1}} title="Удалить" onClick={()=>{if(confirm('Удалить операцию?'))store.deleteOhRegistryItem(e.id);}}>✕</button></td>
            </tr>)}
            <tr style={{borderTop:'2px solid var(--accent2)',fontWeight:700,background:'var(--bg3)'}}>
              <td style={{padding:'4px 6px'}}>Итого факт</td>
              <td style={{padding:'4px 6px',textAlign:'right',color:'var(--red)'}}>{fmt(totalAmt)} ₽</td>
              <td colSpan={5}></td>
            </tr>
            {/* Прогнозный расход: авансированная прибыль Андрея 500К/мес март–декабрь */}
            {(()=>{
              const futAdvMonths=[];for(let m=3;m<=12;m++){const pfx=yr+'-'+String(m).padStart(2,'0');const already=projOps.filter(e=>(e.date||'').startsWith(pfx)&&(e.category||'').toLowerCase().includes('аванс')&&(e.category||'').toLowerCase().includes('прибыл')).reduce((s,e)=>s+(Number(e.amount)||0),0);if(already<500000)futAdvMonths.push({m,pfx,amt:500000-already});}
              const futAdvTotal=futAdvMonths.reduce((s,x)=>s+x.amt,0);
              if(futAdvTotal<=0)return null;
              return <React.Fragment>
                <tr><td colSpan={7} style={{padding:'4px 6px',fontSize:10,fontWeight:700,color:'var(--violet)',background:'rgba(139,92,246,0.06)',borderTop:'2px dashed var(--violet)'}}>ПРОГНОЗ: Авансированная прибыль Андрея (500 тыс./мес, март–дек)</td></tr>
                {futAdvMonths.map(x=><tr key={x.pfx} style={{background:'rgba(139,92,246,0.04)'}}>
                  <td style={{padding:'2px 6px',fontSize:10,color:'var(--violet)'}}>{x.pfx}</td>
                  <td style={{padding:'2px 6px',textAlign:'right',fontWeight:600,color:'var(--violet)'}}>{fmt(x.amt)}</td>
                  <td style={{padding:'2px 6px',color:'var(--violet)',fontSize:10}}>Авансированная прибыль</td>
                  <td style={{padding:'2px 6px',color:'var(--text2)',fontSize:10}}>Прогноз выплаты А.Муравьёву</td>
                  <td colSpan={3}></td>
                </tr>)}
                <tr style={{fontWeight:700,background:'rgba(139,92,246,0.08)'}}>
                  <td style={{padding:'4px 6px',color:'var(--violet)'}}>Итого прогноз аванс.</td>
                  <td style={{padding:'4px 6px',textAlign:'right',color:'var(--violet)'}}>{fmt(futAdvTotal)} ₽</td>
                  <td colSpan={5}></td>
                </tr>
                <tr style={{fontWeight:700,background:'var(--bg3)',borderTop:'2px solid var(--red)'}}>
                  <td style={{padding:'4px 6px',color:'var(--red)'}}>ИТОГО факт + прогноз</td>
                  <td style={{padding:'4px 6px',textAlign:'right',color:'var(--red)',fontWeight:700}}>{fmt(totalAmt+futAdvTotal)} ₽</td>
                  <td colSpan={5}></td>
                </tr>
              </React.Fragment>;
            })()}
            </tbody>
          </table>
        </div>}
      </div>

      {/* ===== СДЕЛКИ ИНВЕСТПРОЕКТА (Доходы) с потоками ===== */}
      {(()=>{
        const _allProjDeals=(store.data.icf_deals||[]).filter(d=>d.icf_project===curProj).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
        const _clients=store.data.clients||[];
        const PRODUCTS=['Интенсив Офлайн','Интенсив ZOOM','Обучение + Интенсив','Обучение','Обучение(помодульно)','Обучение(частичная)','Тариф Индивидуальный','Запись 1-2'];
        const PAY_SYSTEMS=['Геткурс','Карта БИА','Карта SLO','ИП БИА/счет Т-банк','ИПБИА'];
        const TAX_RATES=[{v:0,l:'0%'},{v:11,l:'11%'},{v:20,l:'20%'},{v:22,l:'22%'}];
        const STREAM_OPTS=[1,2,3,4,5,6,7,8,9,10];
        /* Субвкладка потока: 0 = «Все потоки», -1 = «Разовые покупки» (не-студенты) */
        /* curStream hoisted to top */
        /* groupByUser hoisted to top */
        /* Не-студенты для текущего проекта */
        const _nonStudents=(store.data.icf_non_students||{})[curProj]||[];
        const _isNS=(name)=>_nonStudents.includes(name);
        /* Студенческие (обычные) и разовые сделки */
        const _studentDeals=_allProjDeals.filter(d=>!_isNS(d.user_name));
        const _oneTimeDeals=_allProjDeals.filter(d=>_isNS(d.user_name));
        /* Определяем какие потоки реально используются (только студенты) */
        const usedStreams=[...new Set(_studentDeals.map(d=>Number(d.stream_number)||1))].sort((a,b)=>a-b);
        /* Фильтруем сделки по потоку */
        const _icfDeals=curStream===-1?_oneTimeDeals:curStream===0?_studentDeals:_studentDeals.filter(d=>(Number(d.stream_number)||1)===curStream);
        const factDeals=_icfDeals.filter(d=>!d.is_forecast);
        const foreDeals=_icfDeals.filter(d=>!!d.is_forecast);
        /* Суммы — факт */
        const totalCost=factDeals.reduce((s,d)=>s+(Number(d.cost)||0),0);
        const totalComm=factDeals.reduce((s,d)=>s+(Number(d.commission)||0),0);
        const totalReceived=factDeals.reduce((s,d)=>s+(Number(d.received)||0),0);
        const totalTax=factDeals.reduce((s,d)=>s+(Number(d.tax_amount)||0),0);
        const totalEarned=factDeals.reduce((s,d)=>s+(Number(d.earned)||0),0);
        /* Суммы — прогноз */
        const foreCost=foreDeals.reduce((s,d)=>s+(Number(d.cost)||0),0);
        const foreReceived=foreDeals.reduce((s,d)=>s+(Number(d.received)||0),0);
        const foreEarned=foreDeals.reduce((s,d)=>s+(Number(d.earned)||0),0);
        /* Уникальные клиенты */
        const uniqClients=new Set(_icfDeals.map(d=>d.user_name).filter(Boolean));

        /* Группировка по пользователю */
        const grouped=(()=>{
          if(!groupByUser)return null;
          const m={};
          _icfDeals.forEach(d=>{const k=d.user_name||'—';if(!m[k])m[k]=[];m[k].push(d);});
          return Object.entries(m).sort((a,b)=>a[0].localeCompare(b[0]));
        })();

        /* === Helpers === */
        const _is={border:'none',background:'transparent',fontSize:10,padding:'2px 3px',width:'100%',outline:'none'};
        const _isn={..._is,textAlign:'right'};
        const _upd=(id,field,val)=>{
          const upd={[field]:val};
          const deal=_allProjDeals.find(x=>x.id===id);
          if(deal){
            const cost=field==='cost'?Number(val)||0:Number(deal.cost)||0;
            const comm=field==='commission'?Number(val)||0:Number(deal.commission)||0;
            if(field==='cost'||field==='commission'){upd.received=cost-comm;}
            const r=(upd.received!==undefined)?upd.received:(field==='received'?Number(val)||0:Number(deal.received)||0);
            const tPct=_effTax(deal.tax_rate);
            if(field==='cost'||field==='commission'||field==='received'){upd.tax_amount=Math.round(r*tPct/100);upd.earned=r-upd.tax_amount;}
            if(field==='tax_amount'){const t=Number(val)||0;upd.earned=r-t;}
          }
          store.updateIcfDeal(id,upd);
        };

        /* Уникальные продавцы */
        const _sellers=[...new Set(_allProjDeals.map(d=>d.seller).filter(Boolean))].sort();

        /* Рендер строки сделки */
        const renderDealRow=(d)=>{
          const recv=Number(d.received)||0;const cost=Number(d.cost)||0;const earned=Number(d.earned)||0;
          const isFore=!!d.is_forecast;
          const rowBg=isFore?'rgba(139,92,246,0.06)':recv>=cost&&cost>0?'rgba(16,185,129,0.07)':recv>0?'rgba(245,158,11,0.07)':cost>0?'rgba(239,68,68,0.05)':'';
          return <tr key={d.id} style={{borderBottom:'1px solid var(--bg3)',background:rowBg}}>
            <td style={{padding:'1px 2px'}}><input type="date" defaultValue={d.date||''} onBlur={e=>_upd(d.id,'date',e.target.value)} style={{..._is,width:90,fontSize:9}}/></td>
            <td style={{padding:'1px 2px'}}><input defaultValue={d.user_name||''} onBlur={e=>_upd(d.id,'user_name',e.target.value)} style={{..._is,fontWeight:500}}/></td>
            <td style={{padding:'1px 2px'}}><input defaultValue={d.company||''} onBlur={e=>_upd(d.id,'company',e.target.value)} style={{..._is,color:'var(--text2)'}}/></td>
            <td style={{padding:'1px 2px'}}><select defaultValue={d.product||''} onChange={e=>_upd(d.id,'product',e.target.value)} style={{..._is,fontSize:9,color:'var(--accent2)',padding:'1px 0'}}><option value="">—</option>{PRODUCTS.map(p=><option key={p} value={p}>{p}</option>)}</select></td>
            <td style={{padding:'1px 2px'}}><input type="number" defaultValue={cost||''} onBlur={e=>_upd(d.id,'cost',Number(e.target.value)||0)} style={{..._isn,fontWeight:600}}/></td>
            <td style={{padding:'1px 2px'}}><input type="number" defaultValue={Number(d.commission)||''} onBlur={e=>_upd(d.id,'commission',Number(e.target.value)||0)} style={{..._isn,color:'var(--amber)'}}/></td>
            <td style={{padding:'1px 2px'}}><input key={d.id+'r'+recv} type="number" defaultValue={recv||''} onBlur={e=>_upd(d.id,'received',Number(e.target.value)||0)} style={{..._isn,fontWeight:600,color:'var(--emerald)'}}/></td>
            <td style={{padding:'1px 2px'}}><input key={d.id+'t'+(Number(d.tax_amount)||0)} type="number" defaultValue={Number(d.tax_amount)||''} onBlur={e=>_upd(d.id,'tax_amount',Number(e.target.value)||0)} style={{..._isn,color:'var(--red)',fontSize:9}}/></td>
            <td style={{padding:'2px 5px',textAlign:'right',fontWeight:700,color:isFore?'var(--violet)':'var(--sky)'}}>{earned>0?fmt(earned):'—'}</td>
            <td style={{padding:'1px 2px'}}><select defaultValue={d.seller||''} onChange={e=>{if(e.target.value==='__NEW__'){const v=prompt('Новый продавец:');if(v)_upd(d.id,'seller',v);else e.target.value=d.seller||'';}else _upd(d.id,'seller',e.target.value);}} style={{..._is,fontSize:9,color:'var(--text2)',padding:'1px 0'}}><option value="">—</option>{_sellers.map(s=><option key={s} value={s}>{s}</option>)}<option value="__NEW__">+ Новый…</option></select></td>
            <td style={{padding:'1px 2px'}}><select defaultValue={d.pay_system||''} onChange={e=>_upd(d.id,'pay_system',e.target.value)} style={{..._is,fontSize:9,color:'var(--text2)',padding:'1px 0'}}><option value="">—</option>{PAY_SYSTEMS.map(p=><option key={p} value={p}>{p}</option>)}</select></td>
            <td style={{padding:'1px 2px'}}><select defaultValue={Number(d.stream_number)||1} onChange={e=>_upd(d.id,'stream_number',Number(e.target.value))} style={{..._is,fontSize:9,width:38,textAlign:'center'}}>{STREAM_OPTS.map(n=><option key={n} value={n}>{n}</option>)}</select></td>
            <td style={{padding:'2px 2px',textAlign:'center',whiteSpace:'nowrap'}}>
              {isFore?<button title="Превратить в факт" onClick={()=>store.updateIcfDeal(d.id,{is_forecast:false})} style={{fontSize:8,padding:'1px 5px',background:'var(--emerald)',color:'#fff',border:'none',borderRadius:3,cursor:'pointer',marginRight:2}}>Факт</button>:null}
              <button style={{fontSize:9,padding:'1px 4px',border:'1px solid var(--red)',borderRadius:3,background:'transparent',color:'var(--red)',cursor:'pointer',lineHeight:1}} title="Удалить" onClick={()=>{if(confirm('Удалить сделку?'))store.deleteIcfDeal(d.id);}}>✕</button>
            </td>
          </tr>;
        };

        /* Заголовок таблицы */
        const renderTHead=()=><thead><tr style={{borderBottom:'2px solid var(--border)',background:'var(--bg3)'}}>
          <th style={{textAlign:'left',padding:'4px 5px',width:90}}>Дата</th>
          <th style={{textAlign:'left',padding:'4px 5px',minWidth:110}}>Пользователь</th>
          <th style={{textAlign:'left',padding:'4px 5px',minWidth:110}}>Компания</th>
          <th style={{textAlign:'left',padding:'4px 5px',width:120}}>Продукт</th>
          <th style={{textAlign:'right',padding:'4px 5px',width:80}}>Стоимость</th>
          <th style={{textAlign:'right',padding:'4px 5px',width:72}}>Комиссия</th>
          <th style={{textAlign:'right',padding:'4px 5px',width:80}}>Получено</th>
          <th style={{textAlign:'right',padding:'4px 5px',width:68}}>Налог</th>
          <th style={{textAlign:'right',padding:'4px 5px',width:78}}>Заработано</th>
          <th style={{textAlign:'left',padding:'4px 5px',width:100}}>Продавец</th>
          <th style={{textAlign:'left',padding:'4px 5px',width:100}}>Платёж. сист.</th>
          <th style={{textAlign:'center',padding:'4px 3px',width:38}}>Поток</th>
          <th style={{textAlign:'center',padding:'4px 3px',width:50}}></th>
        </tr></thead>;

        return <div className="dash-card" style={{padding:10,marginTop:16}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
            <div style={{fontSize:13,fontWeight:700,color:'var(--emerald)'}}>Сделки (доходы) — {curProj}</div>
            <div style={{fontSize:11,color:'var(--text2)'}}>Факт: {factDeals.length} | Стоимость: <b style={{color:'var(--emerald)'}}>{fmt(totalCost)} ₽</b> | Заработано: <b style={{color:'var(--sky)'}}>{fmt(totalEarned)} ₽</b>{foreDeals.length>0&&<span> | Прогноз: <b style={{color:'var(--violet)'}}>{foreDeals.length} ({fmt(foreCost)} ₽)</b></span>}</div>
          </div>

          {/* Субвкладки потоков */}
          <div style={{display:'flex',gap:4,marginBottom:10,flexWrap:'wrap',alignItems:'center'}}>
            <div onClick={()=>setCurStream(0)} style={{fontSize:10,padding:'3px 10px',borderRadius:12,cursor:'pointer',fontWeight:curStream===0?700:400,background:curStream===0?'var(--accent)':'var(--bg3)',color:curStream===0?'#fff':'var(--text2)',border:'1px solid '+(curStream===0?'var(--accent)':'var(--border)')}}>Все потоки</div>
            {(usedStreams.length>0?usedStreams:[1]).map(n=><div key={n} onClick={()=>setCurStream(n)} style={{fontSize:10,padding:'3px 10px',borderRadius:12,cursor:'pointer',fontWeight:curStream===n?700:400,background:curStream===n?'var(--emerald)':'var(--bg3)',color:curStream===n?'#fff':'var(--text2)',border:'1px solid '+(curStream===n?'var(--emerald)':'var(--border)')}}>Поток {n}</div>)}
            {_oneTimeDeals.length>0&&<div onClick={()=>setCurStream(-1)} style={{fontSize:10,padding:'3px 10px',borderRadius:12,cursor:'pointer',fontWeight:curStream===-1?700:400,background:curStream===-1?'var(--amber)':'var(--bg3)',color:curStream===-1?'#fff':'var(--text2)',border:'1px solid '+(curStream===-1?'var(--amber)':'var(--border)')}}>Разовые покупки ({_oneTimeDeals.length})</div>}
          </div>

          {/* ==== Вкладка «Все потоки» — суммарная статистика ==== */}
          {curStream===0&&<div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(140px,1fr))',gap:8,marginBottom:12}}>
              {[['Клиентов',uniqClients.size,'var(--accent)'],['Оплат (факт)',factDeals.length,'var(--emerald)'],['Прогнозов',foreDeals.length,'var(--violet)'],['Стоимость',fmt(totalCost)+' ₽','var(--text)'],['Получено',fmt(totalReceived)+' ₽','var(--emerald)'],['Налоги',fmt(totalTax)+' ₽','var(--red)'],['Заработано',fmt(totalEarned)+' ₽','var(--sky)'],['Комиссии',fmt(totalComm)+' ₽','var(--amber)'],['Прогноз стоим.',fmt(foreCost)+' ₽','var(--violet)'],['Прогноз зараб.',fmt(foreEarned)+' ₽','var(--violet)']].map(([lbl,val,clr])=><div key={lbl} style={{background:'var(--bg1)',border:'1px solid var(--border)',borderRadius:8,padding:'8px 10px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>{lbl}</div><div style={{fontSize:14,fontWeight:700,color:clr}}>{val}</div></div>)}
            </div>
            {/* Сводка по потокам */}
            <table style={{width:'100%',fontSize:11,borderCollapse:'collapse'}}>
              <thead><tr style={{borderBottom:'2px solid var(--border)',background:'var(--bg3)'}}>
                <th style={{textAlign:'left',padding:'4px 8px'}}>Поток</th>
                <th style={{textAlign:'right',padding:'4px 8px'}}>Факт</th>
                <th style={{textAlign:'right',padding:'4px 8px'}}>Прогноз</th>
                <th style={{textAlign:'right',padding:'4px 8px'}}>Клиентов</th>
                <th style={{textAlign:'right',padding:'4px 8px'}}>Стоимость</th>
                <th style={{textAlign:'right',padding:'4px 8px'}}>Получено</th>
                <th style={{textAlign:'right',padding:'4px 8px'}}>Заработано</th>
              </tr></thead>
              <tbody>{usedStreams.map(sn=>{
                const sd=_studentDeals.filter(d=>(Number(d.stream_number)||1)===sn);
                const sf=sd.filter(d=>!d.is_forecast);const sp=sd.filter(d=>!!d.is_forecast);
                const sCl=new Set(sd.map(d=>d.user_name).filter(Boolean)).size;
                return <tr key={sn} className="clickable" onClick={()=>setCurStream(sn)} style={{borderBottom:'1px solid var(--bg3)'}}>
                  <td style={{padding:'4px 8px',fontWeight:600,color:'var(--emerald)'}}>Поток {sn}</td>
                  <td style={{padding:'4px 8px',textAlign:'right'}}>{sf.length}</td>
                  <td style={{padding:'4px 8px',textAlign:'right',color:'var(--violet)'}}>{sp.length}</td>
                  <td style={{padding:'4px 8px',textAlign:'right'}}>{sCl}</td>
                  <td style={{padding:'4px 8px',textAlign:'right'}}>{fmt(sf.reduce((s,d)=>s+(Number(d.cost)||0),0))} ₽</td>
                  <td style={{padding:'4px 8px',textAlign:'right',color:'var(--emerald)'}}>{fmt(sf.reduce((s,d)=>s+(Number(d.received)||0),0))} ₽</td>
                  <td style={{padding:'4px 8px',textAlign:'right',color:'var(--sky)'}}>{fmt(sf.reduce((s,d)=>s+(Number(d.earned)||0),0))} ₽</td>
                </tr>;
              })}</tbody>
            </table>
          </div>}

          {/* ==== Конкретный поток или Разовые покупки — форма + таблица ==== */}
          {(curStream>0||curStream===-1)&&<div>
          {/* Форма новой сделки */}
          {(()=>{
            /* _def hoisted as _icfDealDef */
            /* nf hoisted to top */
            /* sellerCustom hoisted to top */
            const _sellers=[...new Set(_allProjDeals.map(d=>d.seller).filter(Boolean))].sort();
            const updNf=(k,v)=>setNf(p=>{
              const n={...p,[k]:v};
              const cost=Number(k==='cost'?v:n.cost)||0;
              const comm=Number(k==='commission'?v:n.commission)||0;
              const recv0=Number(n.received)||0;
              if(k==='cost'||k==='commission'){n.received=cost>0?cost-comm:recv0;}
              const recv=Number(n.received)||0;
              const tPct=_effTax(k==='tax_rate'?v:n.tax_rate);
              if(k==='cost'||k==='commission'||k==='received'||k==='tax_rate'){
                n.tax_amount=Math.round(recv*tPct/100);
                n.earned=recv-n.tax_amount;
              }
              return n;
            });
            const _matchCo=nf.company.length>0?_clients.filter(c=>c.name.toLowerCase().includes(nf.company.toLowerCase())).slice(0,5):[];
            const submitDeal=()=>{
              if(!nf.user_name||!nf.cost)return;
              let cid=nf.company_id;
              if(nf.company&&!cid){
                const existing=_clients.find(c=>c.name.toLowerCase()===nf.company.toLowerCase());
                if(existing){cid=existing.id;}else{const nc=store.addClient({name:nf.company,industry:''});cid=nc.id;}
              }
              const cost=Number(nf.cost)||0;const comm=Number(nf.commission)||0;const recv=Number(nf.received)||0;
              const taxPct=_effTax(nf.tax_rate);const taxAmt=Number(nf.tax_amount)||Math.round(recv*taxPct/100);const earned=Number(nf.earned)||(recv-taxAmt);
              store.addIcfDeal({icf_project:curProj,stream_number:curStream>0?curStream:1,is_forecast:!!nf.is_forecast,date:nf.date||'',user_name:nf.user_name,company:nf.company||'',company_id:cid||'',product:nf.product||'',cost,commission:comm,received:recv,tax_rate:Number(nf.tax_rate)||0,tax_amount:taxAmt,earned,pay_system:nf.pay_system||'',seller:nf.seller||''});
              setNf({..._icfDealDef});
            };
            return <div style={{background:'var(--bg1)',border:'1px solid var(--border)',borderRadius:8,padding:10,marginBottom:10}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
                <span style={{fontSize:11,fontWeight:600,color:curStream===-1?'var(--amber)':'var(--emerald)'}}>+ Новая сделка ({curStream===-1?'Разовые покупки':'Поток '+curStream})</span>
                <label style={{fontSize:10,color:'var(--violet)',cursor:'pointer',display:'flex',alignItems:'center',gap:3}}><input type="checkbox" checked={!!nf.is_forecast} onChange={e=>updNf('is_forecast',e.target.checked)}/> Прогноз</label>
              </div>
              <div style={{display:'flex',gap:5,flexWrap:'wrap',alignItems:'flex-end'}}>
                <div style={{flex:'0 0 110px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Дата *</div><input type="date" value={nf.date} onChange={e=>updNf('date',e.target.value)} style={{width:'100%',fontSize:11,padding:'4px 4px',border:'1px solid var(--border)',borderRadius:4}}/></div>
                <div style={{flex:'1 1 130px',minWidth:110}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Пользователь *</div><input value={nf.user_name} onChange={e=>updNf('user_name',e.target.value)} placeholder="ФИО..." style={{width:'100%',fontSize:11,padding:'4px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
                <div style={{flex:'1 1 130px',minWidth:110,position:'relative'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Компания</div><input value={nf.company} onChange={e=>{updNf('company',e.target.value);updNf('company_id','');}} placeholder="Компания..." style={{width:'100%',fontSize:11,padding:'4px 6px',border:'1px solid var(--border)',borderRadius:4}}/>
                  {_matchCo.length>0&&!nf.company_id&&<div style={{position:'absolute',top:'100%',left:0,right:0,background:'var(--bg0)',border:'1px solid var(--border)',borderRadius:4,zIndex:10,maxHeight:100,overflowY:'auto',boxShadow:'0 4px 12px rgba(0,0,0,.15)'}}>{_matchCo.map(c=><div key={c.id} style={{padding:'3px 8px',fontSize:11,cursor:'pointer',borderBottom:'1px solid var(--bg3)'}} onClick={()=>{updNf('company',c.name);updNf('company_id',c.id);}} onMouseEnter={e=>e.target.style.background='var(--bg3)'} onMouseLeave={e=>e.target.style.background=''}>{c.name}</div>)}</div>}
                </div>
                <div style={{flex:'0 0 140px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Продукт</div><select value={nf.product} onChange={e=>updNf('product',e.target.value)} style={{width:'100%',fontSize:11,padding:'4px 4px',border:'1px solid var(--border)',borderRadius:4}}><option value="">— Продукт —</option>{PRODUCTS.map(p=><option key={p} value={p}>{p}</option>)}</select></div>
                <div style={{flex:'0 0 90px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Стоимость *</div><input type="number" value={nf.cost} onChange={e=>updNf('cost',e.target.value)} placeholder="0" style={{width:'100%',fontSize:11,padding:'4px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
                <div style={{flex:'0 0 80px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Комиссия (₽)</div><input type="number" value={nf.commission} onChange={e=>updNf('commission',e.target.value)} placeholder="0" style={{width:'100%',fontSize:11,padding:'4px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
                <div style={{flex:'0 0 90px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Получено (₽)</div><input type="number" value={nf.received} onChange={e=>updNf('received',e.target.value)} placeholder="0" style={{width:'100%',fontSize:11,padding:'4px 6px',border:'1px solid var(--border)',borderRadius:4,background:'rgba(16,185,129,0.06)'}}/></div>
                <div style={{flex:'0 0 70px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Налог %</div><select value={nf.tax_rate} onChange={e=>updNf('tax_rate',e.target.value)} style={{width:'100%',fontSize:11,padding:'4px 4px',border:'1px solid var(--border)',borderRadius:4}}>{TAX_RATES.map(r=><option key={r.v} value={r.v}>{r.l}</option>)}</select></div>
                <div style={{flex:'0 0 75px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Налог ₽</div><div style={{fontSize:11,padding:'4px 6px',background:'var(--bg3)',borderRadius:4,textAlign:'right',color:'var(--red)'}}>{nf.tax_amount||0}</div></div>
                <div style={{flex:'0 0 85px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Заработано</div><div style={{fontSize:11,padding:'4px 6px',background:'var(--bg3)',borderRadius:4,textAlign:'right',fontWeight:700,color:'var(--sky)'}}>{nf.earned||0}</div></div>
                <div style={{flex:'0 0 130px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Продавец</div>{!sellerCustom?<select value={nf.seller} onChange={e=>{if(e.target.value==='__NEW__'){setSellerCustom(true);updNf('seller','');}else updNf('seller',e.target.value);}} style={{width:'100%',fontSize:11,padding:'4px 4px',border:'1px solid var(--border)',borderRadius:4}}><option value="">— Продавец —</option>{_sellers.map(s=><option key={s} value={s}>{s}</option>)}<option value="__NEW__">+ Новый…</option></select>:<div style={{display:'flex',gap:2}}><input value={nf.seller} onChange={e=>updNf('seller',e.target.value)} placeholder="Новый продавец…" autoFocus style={{flex:1,fontSize:11,padding:'4px 6px',border:'1px solid var(--border)',borderRadius:4}}/><button onClick={()=>setSellerCustom(false)} style={{fontSize:9,border:'1px solid var(--border)',borderRadius:4,background:'var(--bg1)',cursor:'pointer',padding:'0 4px'}}>↩</button></div>}</div>
                <div style={{flex:'0 0 140px'}}><div style={{fontSize:9,color:'var(--text2)',marginBottom:2}}>Платёжная система</div><select value={nf.pay_system} onChange={e=>updNf('pay_system',e.target.value)} style={{width:'100%',fontSize:11,padding:'4px 4px',border:'1px solid var(--border)',borderRadius:4}}><option value="">— Система —</option>{PAY_SYSTEMS.map(p=><option key={p} value={p}>{p}</option>)}</select></div>
                <div style={{flex:'0 0 auto'}}><button onClick={submitDeal} disabled={!nf.user_name||!nf.cost} style={{fontSize:11,padding:'5px 14px',background:(!nf.user_name||!nf.cost)?'var(--bg3)':nf.is_forecast?'var(--violet)':'var(--emerald)',color:'#fff',border:'none',borderRadius:6,cursor:(!nf.user_name||!nf.cost)?'default':'pointer',fontWeight:600}}>{nf.is_forecast?'Прогноз':'Добавить'}</button></div>
              </div>
            </div>;
          })()}

          {/* Кнопка группировки */}
          <div style={{display:'flex',justifyContent:'flex-end',marginBottom:6}}>
            <button onClick={()=>setGroupByUser(g=>!g)} style={{fontSize:10,padding:'3px 10px',borderRadius:6,border:'1px solid var(--border)',background:groupByUser?'var(--accent)':'var(--bg1)',color:groupByUser?'#fff':'var(--text2)',cursor:'pointer'}}>{groupByUser?'Разгруппировать':'Группировать по пользователю'}</button>
          </div>

          {/* Таблица сделок */}
          {_icfDeals.length===0?<div style={{fontSize:12,color:'var(--text2)',padding:16,textAlign:'center'}}>{curStream===-1?'Нет разовых покупок':'Нет сделок в потоке '+curStream} для «{curProj}»</div>
          :<div style={{overflowX:'auto'}}>
            {!groupByUser?<table style={{width:'100%',fontSize:10,borderCollapse:'collapse',minWidth:1080}}>
              {renderTHead()}
              <tbody>
              {factDeals.map(d=>renderDealRow(d))}
              {foreDeals.length>0&&<tr><td colSpan={13} style={{padding:'6px 5px',fontSize:10,fontWeight:700,color:'var(--violet)',background:'rgba(139,92,246,0.08)',borderTop:'2px dashed var(--violet)'}}>ПРОГНОЗ ({foreDeals.length})</td></tr>}
              {foreDeals.map(d=>renderDealRow(d))}
              <tr style={{borderTop:'2px solid var(--accent)',fontWeight:700,background:'var(--bg3)'}}>
                <td colSpan={4} style={{padding:'4px 5px'}}>ИТОГО факт</td>
                <td style={{padding:'4px 5px',textAlign:'right'}}>{fmt(totalCost)}</td>
                <td style={{padding:'4px 5px',textAlign:'right',color:'var(--amber)'}}>{fmt(totalComm)}</td>
                <td style={{padding:'4px 5px',textAlign:'right',color:'var(--emerald)'}}>{fmt(totalReceived)}</td>
                <td style={{padding:'4px 5px',textAlign:'right',color:'var(--red)'}}>{fmt(totalTax)}</td>
                <td style={{padding:'4px 5px',textAlign:'right',color:'var(--sky)'}}>{fmt(totalEarned)}</td>
                <td colSpan={4}></td>
              </tr>
              {foreDeals.length>0&&<tr style={{fontWeight:700,background:'rgba(139,92,246,0.06)'}}>
                <td colSpan={4} style={{padding:'4px 5px',color:'var(--violet)'}}>ИТОГО факт + прогноз</td>
                <td style={{padding:'4px 5px',textAlign:'right',color:'var(--violet)'}}>{fmt(totalCost+foreCost)}</td>
                <td style={{padding:'4px 5px',textAlign:'right',color:'var(--violet)'}}>{fmt(totalComm+foreDeals.reduce((s,d)=>s+(Number(d.commission)||0),0))}</td>
                <td style={{padding:'4px 5px',textAlign:'right',color:'var(--violet)'}}>{fmt(totalReceived+foreReceived)}</td>
                <td style={{padding:'4px 5px',textAlign:'right',color:'var(--violet)'}}>{fmt(totalTax+foreDeals.reduce((s,d)=>s+(Number(d.tax_amount)||0),0))}</td>
                <td style={{padding:'4px 5px',textAlign:'right',color:'var(--violet)'}}>{fmt(totalEarned+foreEarned)}</td>
                <td colSpan={4}></td>
              </tr>}
              </tbody>
            </table>
            :<div>{/* Grouped by user */}
              {grouped.map(([userName,deals])=>{
                const gFact=deals.filter(d=>!d.is_forecast);const gFore=deals.filter(d=>!!d.is_forecast);
                const gCost=gFact.reduce((s,d)=>s+(Number(d.cost)||0),0);
                const gRecv=gFact.reduce((s,d)=>s+(Number(d.received)||0),0);
                const gEarn=gFact.reduce((s,d)=>s+(Number(d.earned)||0),0);
                return <div key={userName} style={{marginBottom:10}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,padding:'4px 6px',background:_isNS(userName)?'rgba(245,158,11,0.1)':'var(--bg3)',borderRadius:6,marginBottom:2}}>
                    <label style={{fontSize:9,color:'var(--amber)',cursor:'pointer',display:'flex',alignItems:'center',gap:2,whiteSpace:'nowrap'}} title="Не-студент → Разовые покупки"><input type="checkbox" checked={_isNS(userName)} onChange={()=>store.toggleNonStudent(curProj,userName)} style={{accentColor:'var(--amber)'}}/> не-студент</label>
                    <span style={{fontSize:11,fontWeight:700}}>{userName}</span>
                    <span style={{fontSize:10,color:'var(--text2)'}}>Факт: {gFact.length} оплат</span>
                    <span style={{fontSize:10,color:'var(--emerald)'}}>Стоим: {fmt(gCost)} ₽</span>
                    <span style={{fontSize:10,color:'var(--sky)'}}>Получено: {fmt(gRecv)} ₽</span>
                    <span style={{fontSize:10,color:'var(--accent)'}}>Заработано: {fmt(gEarn)} ₽</span>
                    {gFore.length>0&&<span style={{fontSize:10,color:'var(--violet)'}}>Прогноз: {gFore.length}</span>}
                  </div>
                  <table style={{width:'100%',fontSize:10,borderCollapse:'collapse',minWidth:1080}}>{renderTHead()}<tbody>{deals.map(d=>renderDealRow(d))}</tbody></table>
                </div>;
              })}
            </div>}
          </div>}
          </div>}

          {/* Коммерческие отчисления — placeholder */}
          <div style={{marginTop:10,padding:8,background:'var(--bg3)',borderRadius:6,border:'1px dashed var(--amber)'}}>
            <div style={{fontSize:11,fontWeight:600,color:'var(--amber)',marginBottom:2}}>Коммерческие отчисления</div>
            <div style={{fontSize:10,color:'var(--text2)'}}>Итого комиссий (факт): <b style={{color:'var(--amber)'}}>{fmt(totalComm)} ₽</b> — детализация будет добавлена позже</div>
          </div>
        </div>;
      })()}

    </div>;
  })()}

  {fmTab==='cash_flow'&&(()=>{
    /* ===== CASH FLOW ENGINE — 13-week rolling forecast ===== */
    const today=new Date();
    const yr=today.getFullYear();
    const _allProjects=store.data.projects||[];
    const _persons=store.data.persons||[];
    const _kbBudget=store.data.kb_budget||[];
    const _ohReg=store.data.overhead_registry||[];

    /* Generate 13 weeks starting from current Monday */
    const _getMonday=(d)=>{const dd=new Date(d);const day=dd.getDay();const diff=dd.getDate()-day+(day===0?-6:1);dd.setDate(diff);dd.setHours(0,0,0,0);return dd;};
    const startMon=_getMonday(today);
    const weeks=Array.from({length:13},(_,i)=>{
      const wStart=new Date(startMon);wStart.setDate(wStart.getDate()+i*7);
      const wEnd=new Date(wStart);wEnd.setDate(wEnd.getDate()+6);
      return {idx:i,start:wStart,end:wEnd,
        startStr:wStart.toISOString().slice(0,10),
        endStr:wEnd.toISOString().slice(0,10),
        label:'Н'+(i+1)+' ('+wStart.getDate()+'.'+(wStart.getMonth()+1)+')',
        monthPfx:wStart.getFullYear()+'-'+String(wStart.getMonth()+1).padStart(2,'0')};
    });

    /* === INFLOWS: planned payments by expected_week_monday or planned_date === */
    const inflows=weeks.map(w=>{
      let planned=0,factPaid=0;
      _allProjects.forEach(p=>{(p.payments||[]).forEach(pm=>{
        if(pm.prior_year)return;
        const amt=Number(pm.amount)||0;
        /* planned: use expected_week_monday first, then planned_date */
        const planD=pm.expected_week_monday||pm.planned_date||pm.payment_date||'';
        if(planD>=w.startStr&&planD<=w.endStr){planned+=amt;}
        /* fact: PAID by actual_date in this week */
        if(pm.status==='PAID'&&(pm.actual_date||'').slice(0,10)>=w.startStr&&(pm.actual_date||'').slice(0,10)<=w.endStr){factPaid+=amt;}
      });});
      return {planned:Math.round(planned),fact:Math.round(factPaid)};
    });

    /* === OUTFLOWS: fixed costs distributed weekly === */
    const outflows=weeks.map(w=>{
      const mPfx=w.monthPfx;
      /* FOT production — monthly / 4.33 */
      let fotW=0;
      _persons.filter(p=>p.grade!=='C5'&&!p.is_investment_employee&&getPersonDepts(p).includes('Производство')&&(p.salary_monthly||0)>0).forEach(p=>{
        if(p.fire_date&&p.fire_date<w.startStr)return;
        if((p.hire_date||'')>w.endStr)return;
        fotW+=getPersonSalaryAtDate(p,w.startStr)/4.33;
      });
      /* Salary KB */
      let salKBW=0;
      _persons.filter(p=>!p.is_investment_employee&&getPersonDepts(p).includes('Продажи и Маркетинг')&&(p.salary_monthly||0)>0).forEach(p=>{
        if(p.fire_date&&p.fire_date<w.startStr)return;
        salKBW+=getPersonSalaryAtDate(p,w.startStr)/4.33;
      });
      /* Salary HR */
      let salHRW=0;
      _persons.filter(p=>getPersonDepts(p).includes('HR')&&(p.salary_monthly||0)>0).forEach(p=>{
        if(p.fire_date&&p.fire_date<w.startStr)return;
        salHRW+=getPersonSalaryAtDate(p,w.startStr)/4.33;
      });
      /* HR adjustments */
      const _hrAdj=_kbBudget.filter(x=>x.cf_type==='SALARY_HR_ADJ'&&(x.month||'')===mPfx);
      _hrAdj.forEach(a=>{salHRW+=Number(a.amount_fact||a.amount_plan||0)/4.33;});
      /* Salary Acct */
      let salAcctW=0;
      _persons.filter(p=>getPersonDepts(p).includes('Финансы')&&p.grade!=='C5'&&(p.salary_monthly||0)>0).forEach(p=>{
        if(p.fire_date&&p.fire_date<w.startStr)return;
        salAcctW+=getPersonSalaryAtDate(p,w.startStr)/4.33;
      });
      /* Office rent */
      const _rentOvr=_kbBudget.find(x=>x.cf_type==='OFFICE'&&(x.month||'')===mPfx&&!x.person_id);
      const officeW=(_rentOvr?Number(_rentOvr.amount_plan):1200000)/4.33;
      /* AHO from registry */
      const ahoW=_ohReg.filter(e=>e.rg==='АХО'&&e.scope==='company'&&(e.date||'').startsWith(mPfx)).reduce((s,e)=>s+Number(e.amount||0),0)/4.33;
      /* KB expenses from registry */
      const expKBW=_ohReg.filter(e=>e.rg==='КБ'&&e.scope==='company'&&(e.date||'').startsWith(mPfx)).reduce((s,e)=>s+Number(e.amount||0),0)/4.33;
      /* HR expenses from registry */
      const expHRW=_ohReg.filter(e=>e.rg==='HR'&&e.scope==='company'&&(e.date||'').startsWith(mPfx)).reduce((s,e)=>s+Number(e.amount||0),0)/4.33;
      /* PP expenses */
      const expPPW=_ohReg.filter(e=>e.rg==='PP'&&!e.prior_year&&!e.currency_ops&&(e.date||'').startsWith(mPfx)).reduce((s,e)=>s+Number(e.amount||0),0)/4.33;
      /* FX ops */
      const _fxOvr=_kbBudget.find(x=>x.cf_type==='FX_OPS'&&(x.month||'')===mPfx&&!x.person_id);
      const fxW=(_fxOvr?Number(_fxOvr.amount_plan):0)/4.33;
      /* Bank fees + extra tax */
      const _bfOvr=_kbBudget.find(x=>x.cf_type==='BANK_FEES'&&(x.month||'')===mPfx&&!x.person_id);
      const bfW=(_bfOvr?Number(_bfOvr.amount_plan):0)/4.33;
      const _etOvr=_kbBudget.find(x=>x.cf_type==='EXTRA_TAX'&&(x.month||'')===mPfx&&!x.person_id);
      const etW=(_etOvr?Number(_etOvr.amount_plan):0)/4.33;
      /* Project overheads */
      let ohW=0;
      _allProjects.filter(p=>p.project_type!=='ФК').forEach(p=>{(p.overheads||[]).forEach(x=>{
        if((x.date||'').startsWith(mPfx))ohW+=Number(x.amount||0)/4.33;
      });});

      const total=fotW+salKBW+salHRW+salAcctW+officeW+ahoW+expKBW+expHRW+expPPW+fxW+bfW+etW+ohW;
      return {fot:Math.round(fotW),salKB:Math.round(salKBW),salHR:Math.round(salHRW),salAcct:Math.round(salAcctW),
        office:Math.round(officeW),aho:Math.round(ahoW),expKB:Math.round(expKBW),expHR:Math.round(expHRW),
        expPP:Math.round(expPPW),fx:Math.round(fxW),bankFees:Math.round(bfW),extraTax:Math.round(etW),
        oh:Math.round(ohW),total:Math.round(total)};
    });

    /* === STARTING BALANCE (editable) === */
    const _cfStart=_kbBudget.find(x=>x.cf_type==='CF_START_BALANCE'&&!x.person_id);
    const startBalance=_cfStart?Number(_cfStart.amount_plan)||0:0;

    /* === Running balance === */
    let runBal=startBalance;
    const balances=weeks.map((w,i)=>{
      const net=inflows[i].planned-outflows[i].total;
      runBal+=net;
      return {net:Math.round(net),balance:Math.round(runBal)};
    });

    /* === Alerts === */
    const alerts=[];
    balances.forEach((b,i)=>{
      if(b.balance<0)alerts.push({week:i,type:'danger',msg:'Кассовый разрыв '+weeks[i].label+': '+fmt(b.balance)+' ₽'});
      else if(b.balance<500000)alerts.push({week:i,type:'warning',msg:'Низкий остаток '+weeks[i].label+': '+fmt(b.balance)+' ₽'});
    });

    /* === Edit start balance === */
    /* editBal hoisted to top */
    const saveBal=(val)=>{
      const v=Number(val)||0;
      const kb=store.data.kb_budget||[];
      const ex=kb.find(x=>x.cf_type==='CF_START_BALANCE'&&!x.person_id);
      if(ex){store.updateKbBudgetItem(ex.id,{amount_plan:v});}
      else{store.addKbBudgetItem({name:'Стартовый остаток CF',amount_plan:v,month:'2026-01',cf_type:'CF_START_BALANCE'});}
      setEditBal(null);
    };

    /* Detail toggle */
    /* showDetail hoisted to top */

    return <div>
      <div className="dash-card" style={{padding:12}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
          <div style={{fontSize:14,fontWeight:700}}>CASH FLOW FORECAST — 13 недель</div>
          <div style={{display:'flex',gap:8,alignItems:'center'}}>
            <span style={{fontSize:11,color:'var(--text2)'}}>Стартовый остаток:</span>
            {editBal!==null?<input type="number" style={{width:100,fontSize:11,padding:'2px 6px',border:'1px solid var(--accent)',borderRadius:4}} autoFocus value={editBal} onChange={e=>setEditBal(e.target.value)} onBlur={()=>saveBal(editBal)} onKeyDown={e=>{if(e.key==='Enter')saveBal(editBal);if(e.key==='Escape')setEditBal(null);}}/>
            :<span style={{fontWeight:700,cursor:'pointer',color:'var(--accent)'}} onDoubleClick={()=>setEditBal(String(startBalance))} title="2× клик — изменить">{fmt(startBalance)} ₽</span>}
          </div>
        </div>

        {/* Alerts */}
        {alerts.length>0&&<div style={{marginBottom:10}}>
          {alerts.map((a,i)=><div key={i} style={{padding:'4px 10px',marginBottom:4,borderRadius:6,fontSize:11,fontWeight:600,
            background:a.type==='danger'?'rgba(239,68,68,.12)':'rgba(245,158,11,.12)',
            color:a.type==='danger'?'var(--red)':'var(--amber)',
            border:'1px solid '+(a.type==='danger'?'rgba(239,68,68,.3)':'rgba(245,158,11,.3)')}}>
            {a.type==='danger'?'🔴':'🟡'} {a.msg}
          </div>)}
        </div>}
        {alerts.length===0&&<div style={{padding:'4px 10px',marginBottom:10,borderRadius:6,fontSize:11,fontWeight:600,background:'rgba(34,197,94,.1)',color:'var(--green)',border:'1px solid rgba(34,197,94,.3)'}}>✅ Кассовых разрывов не прогнозируется на горизонте 13 недель</div>}

        {/* Summary table */}
        <div style={{overflowX:'auto'}}>
          <table style={{width:'100%',fontSize:10,borderCollapse:'collapse'}}>
            <thead><tr style={{background:'var(--bg3)'}}>
              <th style={{textAlign:'left',padding:'4px 6px',minWidth:130,position:'sticky',left:0,background:'var(--bg3)',zIndex:1}}>Показатель</th>
              {weeks.map((w,i)=><th key={i} style={{textAlign:'right',padding:'4px 4px',minWidth:70,whiteSpace:'nowrap',
                background:alerts.some(a=>a.week===i&&a.type==='danger')?'rgba(239,68,68,.15)':alerts.some(a=>a.week===i)?'rgba(245,158,11,.1)':'var(--bg3)'}}>{w.label}</th>)}
            </tr></thead>
            <tbody>
              <tr style={{background:'var(--bg1)'}}><td style={{padding:'3px 6px',fontWeight:600,position:'sticky',left:0,background:'var(--bg1)',zIndex:1}}>📥 Приход план</td>
                {inflows.map((inf,i)=><td key={i} style={{textAlign:'right',padding:'3px 4px',color:'var(--green)'}}>{fmt(inf.planned)}</td>)}</tr>
              <tr><td style={{padding:'3px 6px',fontWeight:600,position:'sticky',left:0,background:'#fff',zIndex:1}}>📤 Расход план</td>
                {outflows.map((out,i)=><td key={i} style={{textAlign:'right',padding:'3px 4px',color:'var(--red)'}}>{fmt(out.total)}</td>)}</tr>
              <tr style={{borderTop:'2px solid var(--accent)',fontWeight:700}}><td style={{padding:'3px 6px',position:'sticky',left:0,background:'#fff',zIndex:1}}>Нетто</td>
                {balances.map((b,i)=><td key={i} style={{textAlign:'right',padding:'3px 4px',color:b.net>=0?'var(--green)':'var(--red)'}}>{fmt(b.net)}</td>)}</tr>
              <tr style={{fontWeight:700,background:'var(--bg1)'}}><td style={{padding:'3px 6px',position:'sticky',left:0,background:'var(--bg1)',zIndex:1}}>💰 Остаток</td>
                {balances.map((b,i)=><td key={i} style={{textAlign:'right',padding:'3px 4px',fontWeight:700,
                  color:b.balance<0?'#fff':b.balance<500000?'var(--amber)':'var(--green)',
                  background:b.balance<0?'var(--red)':b.balance<500000?'rgba(245,158,11,.1)':'transparent'}}>{fmt(b.balance)}</td>)}</tr>
            </tbody>
          </table>
        </div>

        {/* Detail toggle */}
        <div style={{marginTop:10}}>
          <span style={{fontSize:11,cursor:'pointer',color:'var(--accent)',userSelect:'none'}} onClick={()=>setShowDetail(p=>!p)}>{showDetail?'▼':'▶'} Детализация расходов</span>
          {showDetail&&<div style={{overflowX:'auto',marginTop:6}}>
            <table style={{width:'100%',fontSize:9,borderCollapse:'collapse'}}>
              <thead><tr style={{background:'var(--bg3)'}}>
                <th style={{textAlign:'left',padding:'3px 6px',position:'sticky',left:0,background:'var(--bg3)',zIndex:1}}>Статья</th>
                {weeks.map((w,i)=><th key={i} style={{textAlign:'right',padding:'3px 4px'}}>{w.label}</th>)}
              </tr></thead>
              <tbody>
                {[
                  {label:'ФОТ производство',key:'fot',clr:'var(--sky)'},
                  {label:'ЗП КБ',key:'salKB',clr:'var(--sky)'},
                  {label:'ЗП HR',key:'salHR',clr:'var(--sky)'},
                  {label:'ЗП бухгалтерии',key:'salAcct',clr:'var(--emerald)'},
                  {label:'Офис (аренда)',key:'office',clr:'var(--amber)'},
                  {label:'АХО',key:'aho',clr:'var(--amber)'},
                  {label:'Расходы КБ',key:'expKB',clr:'var(--amber)'},
                  {label:'Расходы HR',key:'expHR',clr:'var(--emerald)'},
                  {label:'Расходы PP',key:'expPP',clr:'var(--violet)'},
                  {label:'Валютные',key:'fx',clr:'var(--amber)'},
                  {label:'Комиссии банков',key:'bankFees',clr:'var(--red)'},
                  {label:'Доп. налоги',key:'extraTax',clr:'var(--red)'},
                  {label:'Накладные проектов',key:'oh',clr:'var(--violet)'},
                ].map((row,ri)=><tr key={ri} style={ri%2===0?{background:'var(--bg1)'}:{}}>
                  <td style={{padding:'2px 6px',whiteSpace:'nowrap',color:row.clr,position:'sticky',left:0,background:ri%2===0?'var(--bg1)':'#fff',zIndex:1}}>{row.label}</td>
                  {outflows.map((out,i)=><td key={i} style={{textAlign:'right',padding:'2px 4px',color:'var(--text2)'}}>{out[row.key]>0?fmt(out[row.key]):'-'}</td>)}
                </tr>)}
              </tbody>
            </table>
          </div>}
        </div>

        {/* Inflow detail */}
        <div style={{marginTop:6}}>
          <span style={{fontSize:11,cursor:'pointer',color:'var(--accent)',userSelect:'none'}} onClick={()=>{
            const el=document.getElementById('cf-inflow-detail');if(el)el.style.display=el.style.display==='none'?'block':'none';
          }}>{'>>'} Детализация приходов по проектам</span>
          <div id="cf-inflow-detail" style={{display:'none',overflowX:'auto',marginTop:6}}>
            <table style={{width:'100%',fontSize:9,borderCollapse:'collapse'}}>
              <thead><tr style={{background:'var(--bg3)'}}>
                <th style={{textAlign:'left',padding:'3px 6px',position:'sticky',left:0,background:'var(--bg3)',zIndex:1}}>Проект</th>
                {weeks.map((w,i)=><th key={i} style={{textAlign:'right',padding:'3px 4px'}}>{w.label}</th>)}
              </tr></thead>
              <tbody>{_allProjects.filter(p=>(p.payments||[]).some(pm=>!pm.prior_year&&pm.status!=='PAID')).map((p,pi)=>{
                const pws=weeks.map(w=>{
                  let s=0;(p.payments||[]).forEach(pm=>{
                    if(pm.prior_year||pm.status==='PAID')return;
                    const d=pm.expected_week_monday||pm.planned_date||'';
                    if(d>=w.startStr&&d<=w.endStr)s+=Number(pm.amount)||0;
                  });return Math.round(s);
                });
                if(pws.every(v=>v===0))return null;
                return <tr key={p.id} style={pi%2===0?{background:'var(--bg1)'}:{}}>
                  <td style={{padding:'2px 6px',whiteSpace:'nowrap',position:'sticky',left:0,background:pi%2===0?'var(--bg1)':'#fff',zIndex:1}}>{(p.name||'').slice(0,25)}</td>
                  {pws.map((v,i)=><td key={i} style={{textAlign:'right',padding:'2px 4px',color:v>0?'var(--green)':'var(--text2)'}}>{v>0?fmt(v):'-'}</td>)}
                </tr>;
              })}</tbody>
            </table>
          </div>
        </div>
      </div>
    </div>;
  })()}

  {/* Карта метрик — см. ProjectDetail tab==='metrics_map' */}
  {false/*fmTab==='metrics_map'*/&&(()=>{

    /* === Импорт JSON === */
    const [showImport,setShowImport]=React.useState(false);
    const [jsonText,setJsonText]=React.useState('');
    /* _extractJson2 - та же логика что _extractJson в ProjectDetail */
    const _extractJson2=(raw)=>{
      const _normLinks=(arr)=>{if(!Array.isArray(arr)||arr.length===0)return arr;if(Array.isArray(arr[0]))return arr.map(a=>({from:a[0],to:a[1]}));return arr;};
      try{const d=JSON.parse(raw);if(d.nodes&&d.links)return{nodes:d.nodes,links:_normLinks(d.links)};}catch(_){}
      const _jsToJson=(s)=>{let r=s;r=r.replace(/,\s*([\]}])/g,'$1');r=r.replace(/(["'])?([a-zA-Z_]\w*)\s*:/g,(m,q,k)=>q?m:'"'+k+'":');r=r.replace(/'([^'\\]*(\\.[^'\\]*)*)'/g,'"$1"');return r;};
      const _findArr=(name)=>{const re=new RegExp('\\b'+name+'\\s*=\\s*\\[','g');let m;while((m=re.exec(raw))!==null){const start=m.index+m[0].length-1;let dep=0;let end=-1;for(let i=start;i<raw.length;i++){if(raw[i]==='[')dep++;if(raw[i]===']')dep--;if(dep===0){end=i;break;}}if(end<0||end-start<3)continue;const s=raw.slice(start,end+1);try{const a=JSON.parse(s);if(Array.isArray(a)&&a.length>0)return a;}catch(_2){try{const a=JSON.parse(_jsToJson(s));if(Array.isArray(a)&&a.length>0)return a;}catch(_3){}}}return null;};
      const nArr=_findArr('nodes');const lArr=_findArr('linksData')||_findArr('links');
      if(nArr&&Array.isArray(nArr)&&nArr.length>0&&lArr&&Array.isArray(lArr))return{nodes:nArr,links:_normLinks(lArr)};
      return null;
    };
    const doImport=()=>{const d=_extractJson2(jsonText);if(d){store.setMetricsMap(mmProj,{nodes:d.nodes,links:d.links});setShowImport(false);setJsonText('');}else{alert('Не удалось найти данные метрик (nodes + links)');}};

    /* === Добавление ноды === */
    const [showAddNode,setShowAddNode]=React.useState(false);
    const [nn,setNn]=React.useState({id:'',label:'',group:'finance',fact:'',target:'',tip:'',comment:''});
    const doAddNode=()=>{if(!nn.id||!nn.label)return;store.addMetricsNode(mmProj,{...nn});setNn({id:'',label:'',group:'finance',fact:'',target:'',tip:'',comment:''});setShowAddNode(false);};

    /* === Добавление связи === */
    const [showAddLink,setShowAddLink]=React.useState(false);
    const [nl,setNl]=React.useState({from:'',to:'',group:''});
    const doAddLink=()=>{if(!nl.from||!nl.to)return;store.addMetricsLink(mmProj,{from:nl.from,to:nl.to});setNl({from:'',to:'',group:''});setShowAddLink(false);};

    /* === Редактирование ноды === */
    const [editNode,setEditNode]=React.useState(null);

    /* === SVG Layout: группы в колонках, ноды стекаются вертикально === */
    const NODE_W=180,NODE_H=70,PAD_X=40,PAD_Y=20,TOP=60;
    const groupCols={};
    groups.forEach((g,i)=>{groupCols[g]=i;});
    const groupNodeIdx={};
    const nodePos={};
    nodes.forEach(n=>{
      const g=n.group||'_';
      if(!groupNodeIdx[g])groupNodeIdx[g]=0;
      const col=groupCols[g]!==undefined?groupCols[g]:groups.length;
      const row=groupNodeIdx[g]++;
      nodePos[n.id]={x:PAD_X+col*(NODE_W+PAD_X),y:TOP+row*(NODE_H+PAD_Y)};
    });
    const svgW=Math.max(600,(groups.length||1)*(NODE_W+PAD_X)+PAD_X);
    const maxRow=Math.max(1,...Object.values(groupNodeIdx));
    const svgH=Math.max(400,TOP+maxRow*(NODE_H+PAD_Y)+PAD_Y);

    return <div>
      {/* Выбор проекта */}
      <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:10,alignItems:'center'}}>
        <span style={{fontSize:12,fontWeight:600,color:'var(--text2)'}}>Проект:</span>
        {allProjs.map(pn=><div key={pn} onClick={()=>setMmProj(pn)} style={{fontSize:10,padding:'3px 10px',borderRadius:12,cursor:'pointer',fontWeight:mmProj===pn?700:400,background:mmProj===pn?'var(--accent)':'var(--bg3)',color:mmProj===pn?'#fff':'var(--text2)',border:'1px solid '+(mmProj===pn?'var(--accent)':'var(--border)')}}>{pn}</div>)}
      </div>

      {/* Тулбар */}
      <div style={{display:'flex',gap:6,marginBottom:10,flexWrap:'wrap'}}>
        <button onClick={()=>setShowImport(s=>!s)} style={{fontSize:10,padding:'4px 12px',borderRadius:6,border:'1px solid var(--border)',background:showImport?'var(--accent)':'var(--bg1)',color:showImport?'#fff':'var(--text2)',cursor:'pointer'}}>Импорт JSON</button>
        <button onClick={()=>setShowAddNode(s=>!s)} style={{fontSize:10,padding:'4px 12px',borderRadius:6,border:'1px solid var(--emerald)',background:showAddNode?'var(--emerald)':'var(--bg1)',color:showAddNode?'#fff':'var(--emerald)',cursor:'pointer'}}>+ Метрика</button>
        <button onClick={()=>setShowAddLink(s=>!s)} style={{fontSize:10,padding:'4px 12px',borderRadius:6,border:'1px solid var(--violet)',background:showAddLink?'var(--violet)':'var(--bg1)',color:showAddLink?'#fff':'var(--violet)',cursor:'pointer'}}>+ Связь</button>
        <button onClick={()=>{const j=JSON.stringify({nodes,links},null,2);navigator.clipboard.writeText(j);}} style={{fontSize:10,padding:'4px 12px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg1)',color:'var(--text2)',cursor:'pointer'}}>Копировать JSON</button>
        <span style={{fontSize:10,color:'var(--text2)',alignSelf:'center'}}>Метрик: {nodes.length} | Связей: {links.length}</span>
      </div>

      {/* Импорт JSON */}
      {showImport&&<div style={{marginBottom:10,padding:10,background:'var(--bg3)',borderRadius:8}}>
        <div style={{fontSize:11,fontWeight:600,marginBottom:4}}>Вставьте JSON с nodes и links:</div>
        <textarea value={jsonText} onChange={e=>setJsonText(e.target.value)} rows={6} style={{width:'100%',fontSize:10,fontFamily:'monospace',border:'1px solid var(--border)',borderRadius:4,padding:6,resize:'vertical'}}/>
        <div style={{display:'flex',gap:6,marginTop:4}}>
          <button onClick={doImport} style={{fontSize:10,padding:'3px 12px',borderRadius:4,background:'var(--accent)',color:'#fff',border:'none',cursor:'pointer'}}>Импортировать</button>
          <button onClick={()=>setShowImport(false)} style={{fontSize:10,padding:'3px 12px',borderRadius:4,background:'var(--bg1)',border:'1px solid var(--border)',cursor:'pointer'}}>Отмена</button>
        </div>
      </div>}

      {/* Добавить метрику */}
      {showAddNode&&<div style={{marginBottom:10,padding:10,background:'var(--bg3)',borderRadius:8}}>
        <div style={{fontSize:11,fontWeight:600,marginBottom:4}}>Новая метрика:</div>
        <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:4}}>
          <input placeholder="ID (лат.)" value={nn.id} onChange={e=>setNn(p=>({...p,id:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,width:100}}/>
          <input placeholder="Название" value={nn.label} onChange={e=>setNn(p=>({...p,label:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,width:160}}/>
          <select value={nn.group} onChange={e=>setNn(p=>({...p,group:e.target.value}))} style={{fontSize:10,padding:'3px 4px',border:'1px solid var(--border)',borderRadius:4}}>
            {GROUP_ORDER.map(g=><option key={g} value={g}>{gLabel(g)}</option>)}
          </select>
          <input placeholder="Факт" value={nn.fact} onChange={e=>setNn(p=>({...p,fact:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,width:80}}/>
          <input placeholder="Цель" value={nn.target} onChange={e=>setNn(p=>({...p,target:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,width:80}}/>
        </div>
        <div style={{display:'flex',gap:6,marginBottom:4}}>
          <input placeholder="Подсказка (tip)" value={nn.tip} onChange={e=>setNn(p=>({...p,tip:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,flex:1}}/>
          <input placeholder="Комментарий" value={nn.comment} onChange={e=>setNn(p=>({...p,comment:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,flex:1}}/>
        </div>
        <button onClick={doAddNode} disabled={!nn.id||!nn.label} style={{fontSize:10,padding:'3px 12px',borderRadius:4,background:(!nn.id||!nn.label)?'var(--bg2)':'var(--emerald)',color:'#fff',border:'none',cursor:(!nn.id||!nn.label)?'default':'pointer'}}>Добавить</button>
      </div>}

      {/* Добавить связь */}
      {showAddLink&&<div style={{marginBottom:10,padding:10,background:'var(--bg3)',borderRadius:8}}>
        <div style={{fontSize:11,fontWeight:600,marginBottom:4}}>Новая связь:</div>
        <div style={{display:'flex',gap:6,alignItems:'center'}}>
          <select value={nl.from} onChange={e=>setNl(p=>({...p,from:e.target.value}))} style={{fontSize:10,padding:'3px 4px',border:'1px solid var(--border)',borderRadius:4}}>
            <option value="">— От —</option>{nodes.map(n=><option key={n.id} value={n.id}>{n.label} ({n.id})</option>)}
          </select>
          <span style={{fontSize:12}}>→</span>
          <select value={nl.to} onChange={e=>setNl(p=>({...p,to:e.target.value}))} style={{fontSize:10,padding:'3px 4px',border:'1px solid var(--border)',borderRadius:4}}>
            <option value="">— К —</option>{nodes.map(n=><option key={n.id} value={n.id}>{n.label} ({n.id})</option>)}
          </select>
          <input placeholder="Группа связи" value={nl.group} onChange={e=>setNl(p=>({...p,group:e.target.value}))} style={{fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4,width:100}}/>
          <button onClick={doAddLink} disabled={!nl.from||!nl.to} style={{fontSize:10,padding:'3px 12px',borderRadius:4,background:(!nl.from||!nl.to)?'var(--bg2)':'var(--violet)',color:'#fff',border:'none',cursor:(!nl.from||!nl.to)?'default':'pointer'}}>Добавить</button>
        </div>
      </div>}

      {/* === Граф SVG === */}
      {nodes.length===0?<div style={{padding:40,textAlign:'center',color:'var(--text2)',fontSize:13}}>Нет метрик. Импортируйте JSON или добавьте вручную.</div>
      :<div className="dash-card" style={{padding:12,overflowX:'auto'}}>
        {/* Легенда групп */}
        <div style={{display:'flex',gap:10,marginBottom:8,flexWrap:'wrap'}}>
          {groups.map(g=><span key={g} style={{fontSize:10,display:'flex',alignItems:'center',gap:3}}><span style={{width:10,height:10,borderRadius:3,background:gColor(g),display:'inline-block'}}/>{gLabel(g)}</span>)}
        </div>
        <svg width={svgW} height={svgH} style={{background:'var(--bg1)',borderRadius:8,border:'1px solid var(--border)'}}>
          {/* Заголовки колонок */}
          {groups.map((g,i)=><text key={g} x={PAD_X+i*(NODE_W+PAD_X)+NODE_W/2} y={24} textAnchor="middle" style={{fontSize:12,fontWeight:700,fill:gColor(g)}}>{gLabel(g)}</text>)}
          {/* Линии связей */}
          {links.map((l,i)=>{
            const from=nodePos[l.from||l[0]];const to=nodePos[l.to||l[1]];
            if(!from||!to)return null;
            const x1=from.x+NODE_W;const y1=from.y+NODE_H/2;
            const x2=to.x;const y2=to.y+NODE_H/2;
            const dx=Math.abs(x2-x1)/2;
            return <g key={i}>
              <path d={'M'+x1+','+y1+' C'+(x1+dx)+','+y1+' '+(x2-dx)+','+y2+' '+x2+','+y2} fill="none" stroke="var(--border)" strokeWidth={1.5} strokeDasharray={l[2]?'':'4,3'} markerEnd="url(#arrowhead)"/>
            </g>;
          })}
          {/* Стрелка маркер */}
          <defs><marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="var(--text2)"/></marker></defs>
          {/* Ноды */}
          {nodes.map(n=>{
            const pos=nodePos[n.id];if(!pos)return null;
            const gc=gColor(n.group);
            return <g key={n.id} style={{cursor:'pointer'}} onClick={()=>setEditNode(editNode===n.id?null:n.id)}>
              <rect x={pos.x} y={pos.y} width={NODE_W} height={NODE_H} rx={8} fill="var(--bg0)" stroke={editNode===n.id?'var(--accent)':gc} strokeWidth={editNode===n.id?2.5:1.5}/>
              <rect x={pos.x} y={pos.y} width={6} height={NODE_H} rx={3} fill={gc}/>
              <text x={pos.x+14} y={pos.y+16} style={{fontSize:11,fontWeight:700,fill:'var(--text1)'}}>{n.label}</text>
              {n.fact&&<text x={pos.x+14} y={pos.y+32} style={{fontSize:9,fill:'var(--emerald)'}}>Факт: {n.fact}</text>}
              {n.target&&<text x={pos.x+14} y={pos.y+44} style={{fontSize:9,fill:'var(--violet)'}}>Цель: {n.target}</text>}
              {n.tip&&<text x={pos.x+14} y={pos.y+56} style={{fontSize:8,fill:'var(--text2)'}}>{n.tip.length>28?n.tip.slice(0,28)+'…':n.tip}</text>}
            </g>;
          })}
        </svg>

        {/* Панель редактирования выбранной ноды */}
        {editNode&&(()=>{
          const n=nodes.find(x=>x.id===editNode);if(!n)return null;
          const _lf2=(l)=>l.from||l[0];const _lt2=(l)=>l.to||l[1];const nodeLinks=links.filter(l=>_lf2(l)===n.id||_lt2(l)===n.id);
          return <div style={{marginTop:10,padding:10,background:'var(--bg3)',borderRadius:8,border:'2px solid var(--accent)'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
              <span style={{fontSize:12,fontWeight:700,color:'var(--accent)'}}>{n.label} <span style={{fontSize:9,color:'var(--text2)'}}>({n.id})</span></span>
              <div style={{display:'flex',gap:4}}>
                <button onClick={()=>{store.deleteMetricsNode(mmProj,n.id);setEditNode(null);}} style={{fontSize:9,padding:'2px 8px',borderRadius:4,background:'var(--red)',color:'#fff',border:'none',cursor:'pointer'}}>Удалить</button>
                <button onClick={()=>setEditNode(null)} style={{fontSize:9,padding:'2px 8px',borderRadius:4,background:'var(--bg1)',border:'1px solid var(--border)',cursor:'pointer'}}>✕</button>
              </div>
            </div>
            <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:6}}>
              <div style={{flex:'1 1 150px'}}><div style={{fontSize:9,color:'var(--text2)'}}>Факт</div><input defaultValue={n.fact||''} onBlur={e=>store.updateMetricsNode(mmProj,n.id,{fact:e.target.value})} style={{width:'100%',fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
              <div style={{flex:'1 1 150px'}}><div style={{fontSize:9,color:'var(--text2)'}}>Цель</div><input defaultValue={n.target||''} onBlur={e=>store.updateMetricsNode(mmProj,n.id,{target:e.target.value})} style={{width:'100%',fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
              <div style={{flex:'1 1 200px'}}><div style={{fontSize:9,color:'var(--text2)'}}>Подсказка</div><input defaultValue={n.tip||''} onBlur={e=>store.updateMetricsNode(mmProj,n.id,{tip:e.target.value})} style={{width:'100%',fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
              <div style={{flex:'1 1 200px'}}><div style={{fontSize:9,color:'var(--text2)'}}>Комментарий</div><input defaultValue={n.comment||''} onBlur={e=>store.updateMetricsNode(mmProj,n.id,{comment:e.target.value})} style={{width:'100%',fontSize:10,padding:'3px 6px',border:'1px solid var(--border)',borderRadius:4}}/></div>
            </div>
            {n.comment&&<div style={{fontSize:10,color:'var(--text2)',padding:'4px 0',fontStyle:'italic'}}>{n.comment}</div>}
            {nodeLinks.length>0&&<div style={{marginTop:4}}>
              <div style={{fontSize:9,fontWeight:600,color:'var(--text2)',marginBottom:2}}>Связи:</div>
              {nodeLinks.map((l,i)=>{
                const other=_lf2(l)===n.id?_lt2(l):_lf2(l);const dir=_lf2(l)===n.id?'→':'←';
                const oNode=nodes.find(x=>x.id===other);
                return <div key={i} style={{fontSize:10,display:'flex',alignItems:'center',gap:4,padding:'1px 0'}}>
                  <span>{dir} {oNode?oNode.label:other}</span>
                  <button onClick={()=>store.deleteMetricsLink(mmProj,_lf2(l),_lt2(l))} style={{fontSize:8,padding:'0 4px',borderRadius:3,background:'var(--red)',color:'#fff',border:'none',cursor:'pointer'}}>✕</button>
                </div>;
              })}
            </div>}
          </div>;
        })()}
      </div>}

      {/* Таблица метрик */}
      {nodes.length>0&&<div className="dash-card" style={{padding:12,marginTop:10}}>
        <div style={{fontSize:12,fontWeight:700,marginBottom:6}}>Все метрики — {mmProj}</div>
        <table style={{width:'100%',fontSize:10,borderCollapse:'collapse'}}>
          <thead><tr style={{borderBottom:'2px solid var(--border)',background:'var(--bg3)'}}>
            <th style={{textAlign:'left',padding:'4px 6px'}}>ID</th>
            <th style={{textAlign:'left',padding:'4px 6px'}}>Метрика</th>
            <th style={{textAlign:'left',padding:'4px 6px'}}>Группа</th>
            <th style={{textAlign:'right',padding:'4px 6px'}}>Факт</th>
            <th style={{textAlign:'right',padding:'4px 6px'}}>Цель</th>
            <th style={{textAlign:'left',padding:'4px 6px'}}>Подсказка</th>
            <th style={{textAlign:'left',padding:'4px 6px'}}>Комментарий</th>
          </tr></thead>
          <tbody>{nodes.map(n=><tr key={n.id} style={{borderBottom:'1px solid var(--bg3)',cursor:'pointer',background:editNode===n.id?'rgba(99,102,241,0.08)':''}} onClick={()=>setEditNode(editNode===n.id?null:n.id)}>
            <td style={{padding:'3px 6px',fontFamily:'monospace',color:'var(--text2)'}}>{n.id}</td>
            <td style={{padding:'3px 6px',fontWeight:600}}><span style={{display:'inline-block',width:8,height:8,borderRadius:2,background:gColor(n.group),marginRight:4}}/>{n.label}</td>
            <td style={{padding:'3px 6px',color:gColor(n.group)}}>{n.group}</td>
            <td style={{padding:'3px 6px',textAlign:'right',color:'var(--emerald)'}}>{n.fact||'—'}</td>
            <td style={{padding:'3px 6px',textAlign:'right',color:'var(--violet)'}}>{n.target||'—'}</td>
            <td style={{padding:'3px 6px',color:'var(--text2)',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{n.tip||''}</td>
            <td style={{padding:'3px 6px',color:'var(--text2)',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{n.comment||''}</td>
          </tr>)}</tbody>
        </table>
      </div>}
    </div>;
  })()}

  </div>;
  } catch(_fmError) {
    console.error('FinanceMachineView error:', _fmError);
    return <div style={{padding:20,margin:20,background:'#fff0f0',border:'2px solid red',borderRadius:8}}>
      <h3 style={{color:'red',margin:'0 0 8px'}}>Ошибка в FinMashina</h3>
      <pre style={{whiteSpace:'pre-wrap',fontSize:12,color:'#333'}}>{String(_fmError)}</pre>
      <pre style={{whiteSpace:'pre-wrap',fontSize:10,color:'#888',marginTop:8}}>{_fmError&&_fmError.stack}</pre>
    </div>;
  }
}

function SalesMarketingView({store,goProject}){
  const projects=store.data.projects;
  const clients=store.data.clients||[];
  const persons=store.data.persons.filter(p=>getPersonDepts(p).includes('Продажи и маркетинг'));
  const SALES_SECTIONS=['Обработка заявок и КП','Контент и дистрибуция','ABM','Работа с партнерами','Вводные услуги'];

  /* client stats */
  const clientStats=clients.map(cl=>{
    const cProj=projects.filter(p=>p.client_id===cl.id||p.client_name===cl.name);
    const totalRev=cProj.reduce((s,p)=>s+(Number(p.total_contract_value)||0),0);
    const activeCount=cProj.filter(p=>p.status==='ACTIVE').length;
    return {...cl,projCount:cProj.length,activeCount,totalRev};
  }).sort((a,b)=>b.totalRev-a.totalRev);

  /* pipeline */
  const draftProj=projects.filter(p=>p.status==='DRAFT');
  const activeProj=projects.filter(p=>p.status==='ACTIVE');
  const completedProj=projects.filter(p=>p.status==='COMPLETED');

  const [salesTab,_setSalesTab]=useState(()=>localStorage.getItem('pp_salesTab')||'overview');
  const setSalesTab=(t)=>{localStorage.setItem('pp_salesTab',t);_setSalesTab(t);};
  const [sfQtrView,setSfQtrView]=useState(Math.floor(new Date().getMonth()/3));
  const [sfDrill,setSfDrill]=useState(null); /* {rowKey,month,items} */
  const [showGrpExpenses,setShowGrpExpenses]=useState(false);
  const [showFiredInRg,setShowFiredInRg]=useState(false);
  const [editRgPerson,setEditRgPerson]=useState(null);
  const [crmDrag,setCrmDrag]=useState(null);
  const [crmNew,setCrmNew]=useState(null);
  const [crmEdit,setCrmEdit]=useState(null);
  /* === Hoisted hooks from notion_verify IIFE === */
  const [nvFilter,setNvFilter]=useState('');
  const [nvStageFilter,setNvStageFilter]=useState('all');
  const [nvSelected,setNvSelected]=useState(new Set());
  const [nvEditId,setNvEditId]=useState(null);
  const [nvSort,setNvSort]=useState('name');
  const [rgPopup,setRgPopup]=useState(null); /* {items:[{id,code,name,amount}], x, y} */
  const yr=new Date().getFullYear();
  const MONTHS=['2026-01','2026-02','2026-03','2026-04','2026-05','2026-06','2026-07','2026-08','2026-09','2026-10','2026-11','2026-12'];
  const MNAMES=['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
  const b2cProjects=projects.filter(p=>(p.work_group||'').includes('\u0420\u04132')||p.code?.startsWith('B2C'));
  const getPlannedForMonth=(proj,month)=>(proj.payments||[]).filter(pm=>!pm.prior_year&&pm.payment_type==='PLANNED'&&pm.planned_date===month).reduce((s,x)=>s+(Number(x.amount)||0),0);
  const getFactForMonth=(proj,month)=>(proj.payments||[]).filter(pm=>!pm.prior_year&&pm.status==='PAID'&&(pm.actual_date||pm.planned_date||'').startsWith(month)).reduce((s,x)=>s+(Number(x.amount)||0),0);
  /* Group aggregation helpers */
  const grpProj=(g)=>projects.filter(p=>(p.work_group||'')===g&&p.status!=='CANCELLED');
  const grpPlanCF=(g,m)=>grpProj(g).reduce((s,p)=>s+(p.payments||[]).filter(pm=>!pm.prior_year&&(pm.expected_week_monday||pm.planned_date||pm.payment_date||'').startsWith(m)).reduce((a,x)=>a+(Number(x.amount)||0),0),0);
  const grpFactCF=(g,m)=>grpProj(g).reduce((s,p)=>s+(p.payments||[]).filter(pm=>!pm.prior_year&&pm.status==='PAID'&&(pm.actual_date||'').startsWith(m)).reduce((a,x)=>a+(Number(x.amount)||0),0),0);
  const grpPlanPNL=(g,m)=>grpPlanCF(g,m);
  const grpFactPNL=(g,m)=>grpProj(g).reduce((s,p)=>s+(p.payments||[]).filter(pm=>{
    if(pm.prior_year)return false;
    if(pm.status==='ACCRUED')return(pm.accrued_date||'').startsWith(m);
    if(pm.status==='PAID')return(pm.actual_date||'').startsWith(m);
    return false;
  }).reduce((a,x)=>a+(Number(x.amount)||0),0),0);
  const pnlOvr=store.data.pnl_overrides||[];
  const grpOvr=(g,m)=>pnlOvr.filter(o=>o.work_group===g&&o.month===m).reduce((s,x)=>s+(Number(x.amount)||0),0);
  const qSum=(fn,g,qi)=>[MONTHS[qi*3],MONTHS[qi*3+1],MONTHS[qi*3+2]].reduce((s,m)=>s+fn(g,m),0);
  const yrSum=(fn,g)=>MONTHS.reduce((s,m)=>s+fn(g,m),0);
  const getEffTCV=(p)=>(p.project_type==='New Delivery'||p.project_type==='ФК')?(p.payments||[]).filter(x=>!x.prior_year).reduce((s,x)=>s+(Number(x.amount)||0),0):(Number(p.total_contract_value)||0);
  const WORK_GROUPS=[...new Set(projects.map(p=>p.work_group||'').filter(Boolean))].sort();
  const getQtr=(arr,qi)=>[arr[qi*3],arr[qi*3+1],arr[qi*3+2]].reduce((s,x)=>s+(x||0),0);
  return <div>
    <h2 className="page-title">Продажи и маркетинг</h2>
    <div className="oc-tabs" style={{marginBottom:12}}>
      <div className={'oc-tab'+(salesTab==='overview'?' active':'')} onClick={()=>setSalesTab('overview')}>Обзор</div>
      {WORK_GROUPS.map(g=><div key={g} className={'oc-tab'+(salesTab===g?' active':'')} onClick={()=>setSalesTab(g)}>{g}</div>)}
      <div className={'oc-tab'+(salesTab==='crm'?' active':'')} onClick={()=>setSalesTab('crm')}>CRM осн.</div>
      <div className={'oc-tab'+(salesTab==='forecast'?' active':'')} onClick={()=>setSalesTab('forecast')}>Прогноз продаж</div>
      <div className={'oc-tab'+(salesTab==='import'?' active':'')} onClick={()=>setSalesTab('import')}>Импорт</div>
      <div className={'oc-tab'+(salesTab==='notion_verify'?' active':'')} onClick={()=>setSalesTab('notion_verify')} style={{background:salesTab==='notion_verify'?'var(--amber)':'',color:salesTab==='notion_verify'?'#000':''}}>📋 Notion CRM</div>
    </div>
    {WORK_GROUPS.includes(salesTab)&&(()=>{
      const g=salesTab;const gp=grpProj(g);
      const showExpenses=showGrpExpenses;const setShowExpenses=setShowGrpExpenses;
      /* overhead per month for group — из project.overheads[] (до решения по синхронизации) */
      const grpOhMonth=(m)=>gp.reduce((s,p)=>s+(p.overheads||[]).filter(x=>(x.date||'').startsWith(m)).reduce((a,x)=>a+(Number(x.amount)||0),0),0);
      /* salary per month: production persons in this work_group who were active in that month */
      const allPersons=store.data.persons;
      const grpPersons=allPersons.filter(pe=>pe.work_group===g&&pe.grade!=='C5'&&!pe.is_investment_employee&&getPersonDepts(pe).includes('Производство')&&(pe.salary_monthly||0)>0);
      const gradeRank=(gr)=>{const map={'C1':1,'C2':2,'C3':3,'C4':4,'Стажёр':5};return map[gr]||4;};
      const activePersons=grpPersons.filter(pe=>!pe.fire_date).sort((a,b)=>gradeRank(a.grade)-gradeRank(b.grade));
      const firedPersons=grpPersons.filter(pe=>!!pe.fire_date).sort((a,b)=>gradeRank(a.grade)-gradeRank(b.grade));
      const personActiveInMonth=(pe,m)=>{const hd=pe.hire_date||'';const fd=pe.fire_date||'';const mStart=m+'-01';const mEnd=m+'-31';if(hd&&hd>mEnd)return false;if(fd&&fd<mStart)return false;return true;};
      const grpSalMonth=(m)=>grpPersons.filter(pe=>personActiveInMonth(pe,m)).reduce((s,pe)=>s+getPersonMonthSalary(pe,m),0);
      const grpExpMonth=(m)=>grpOhMonth(m)+grpSalMonth(m);
      /* tooltip builders — return arrays of {id,code,name,amount} */
      const ttCF=(m)=>gp.map(p=>{const v=(p.payments||[]).filter(pm=>!pm.prior_year&&(pm.expected_week_monday||pm.planned_date||pm.payment_date||'').startsWith(m)).reduce((a,x)=>a+(Number(x.amount)||0),0);return v>0?{id:p.id,code:p.code,name:p.name||p.code,amount:v}:null;}).filter(Boolean);
      const ttFactCF=(m)=>gp.map(p=>{const v=(p.payments||[]).filter(pm=>!pm.prior_year&&pm.status==='PAID'&&(pm.actual_date||'').startsWith(m)).reduce((a,x)=>a+(Number(x.amount)||0),0);return v>0?{id:p.id,code:p.code,name:p.name||p.code,amount:v}:null;}).filter(Boolean);
      const ttFactPNL=(m)=>gp.map(p=>{const v=(p.payments||[]).filter(pm=>{if(pm.prior_year)return false;if(pm.status==='ACCRUED')return(pm.accrued_date||'').startsWith(m);if(pm.status==='PAID')return(pm.actual_date||'').startsWith(m);return false;}).reduce((a,x)=>a+(Number(x.amount)||0),0);return v>0?{id:p.id,code:p.code,name:p.name||p.code,amount:v}:null;}).filter(Boolean);
      const ttOh=(m)=>gp.map(p=>{const v=(p.overheads||[]).filter(x=>(x.date||'').startsWith(m)).reduce((a,x)=>a+(Number(x.amount)||0),0);return v>0?{id:p.id,code:p.code,name:p.name||p.code,amount:v}:null;}).filter(Boolean);
      const ttSal=(m)=>grpPersons.filter(pe=>personActiveInMonth(pe,m)).map(pe=>({id:pe.id,code:'',name:pe.name,amount:getPersonMonthSalary(pe,m),isPerson:true}));
      const openPop=(e,items)=>{if(!items||!items.length)return;const r=e.currentTarget.getBoundingClientRect();setRgPopup({items,x:r.left,y:r.bottom+4});};
      return <div>
        <div style={{fontSize:11,color:'var(--text2)',marginBottom:8}}>Проектов: {gp.length} | Контрактов: {fmt(gp.reduce((s,p)=>s+getEffTCV(p),0))} \u20bd | Производство: {grpPersons.length} чел.</div>
        <div className="card" style={{padding:12,overflowX:'auto'}}>
          <table style={{fontSize:10,minWidth:1200}}>
            <thead><tr><th style={{minWidth:140}}>Показатель</th>{MNAMES.map((mn,i)=><th key={i} style={{textAlign:'right',minWidth:62,background:i%3===2?'var(--bg1)':''}}>{mn}</th>)}{['I кв','II кв','III кв','IV кв'].map(q=><th key={q} style={{textAlign:'right',fontWeight:700,background:'var(--bg1)',minWidth:70}}>{q}</th>)}<th style={{textAlign:'right',fontWeight:700}}>Итого</th></tr></thead>
            <tbody>
              <tr style={{background:'var(--bg1)'}}><td style={{fontWeight:600}}>План CF</td>{MONTHS.map((m,i)=>{const v=grpPlanCF(g,m);const tt=ttCF(m);return <td key={i} style={{textAlign:'right',background:i%3===2?'var(--bg2)':'',cursor:tt.length?'pointer':''}} onClick={e=>openPop(e,tt)}>{v>0?fmt(v):''}</td>;})}{[0,1,2,3].map(qi=><td key={qi} style={{textAlign:'right',fontWeight:600,background:'var(--bg2)'}}>{fmt(qSum(grpPlanCF,g,qi))}</td>)}<td style={{textAlign:'right',fontWeight:700}}>{fmt(yrSum(grpPlanCF,g))}</td></tr>
              <tr><td style={{fontWeight:600,color:'var(--green)'}}>Факт CF</td>{MONTHS.map((m,i)=>{const v=grpFactCF(g,m);const tt=ttFactCF(m);return <td key={i} style={{textAlign:'right',color:v>0?'var(--green)':'',background:i%3===2?'var(--bg2)':'',cursor:tt.length?'pointer':''}} onClick={e=>openPop(e,tt)}>{v>0?fmt(v):''}</td>;})}{[0,1,2,3].map(qi=><td key={qi} style={{textAlign:'right',color:'var(--green)',background:'var(--bg2)'}}>{fmt(qSum(grpFactCF,g,qi))}</td>)}<td style={{textAlign:'right',fontWeight:700,color:'var(--green)'}}>{fmt(yrSum(grpFactCF,g))}</td></tr>
              <tr style={{background:'var(--bg1)'}}><td style={{fontWeight:600}}>План P&L</td>{MONTHS.map((m,i)=>{const v=grpPlanPNL(g,m);const tt=ttCF(m);return <td key={i} style={{textAlign:'right',background:i%3===2?'var(--bg2)':'',cursor:tt.length?'pointer':''}} onClick={e=>openPop(e,tt)}>{v>0?fmt(v):''}</td>;})}{[0,1,2,3].map(qi=><td key={qi} style={{textAlign:'right',fontWeight:600,background:'var(--bg2)'}}>{fmt(qSum(grpPlanPNL,g,qi))}</td>)}<td style={{textAlign:'right',fontWeight:700}}>{fmt(yrSum(grpPlanPNL,g))}</td></tr>
              <tr><td style={{fontWeight:600,color:'var(--emerald)'}}>Факт P&L</td>{MONTHS.map((m,i)=>{const v=grpFactPNL(g,m);const tt=ttFactPNL(m);return <td key={i} style={{textAlign:'right',color:v>0?'var(--emerald)':'',background:i%3===2?'var(--bg2)':'',cursor:tt.length?'pointer':''}} onClick={e=>openPop(e,tt)}>{v>0?fmt(v):''}</td>;})}{[0,1,2,3].map(qi=><td key={qi} style={{textAlign:'right',color:'var(--emerald)',background:'var(--bg2)'}}>{fmt(qSum(grpFactPNL,g,qi))}</td>)}<td style={{textAlign:'right',fontWeight:700,color:'var(--emerald)'}}>{fmt(yrSum(grpFactPNL,g))}</td></tr>
              <tr style={{borderTop:'1px solid var(--border)'}}>
                <td style={{fontWeight:600,color:'var(--red)',cursor:'pointer'}} onClick={()=>setShowExpenses(!showExpenses)}>{showExpenses?'▼':'▶'} Расходы группы</td>
                {MONTHS.map((m,i)=>{const v=grpExpMonth(m);return <td key={i} title={v>0?'Накл: '+fmt(grpOhMonth(m))+' / ЗП: '+fmt(grpSalMonth(m)):''} style={{textAlign:'right',color:v>0?'var(--red)':'',background:i%3===2?'var(--bg2)':''}}>{v>0?'−'+fmt(v):''}</td>;})}
                {[0,1,2,3].map(qi=>{const v=[MONTHS[qi*3],MONTHS[qi*3+1],MONTHS[qi*3+2]].reduce((s,m)=>s+grpExpMonth(m),0);return <td key={qi} style={{textAlign:'right',color:'var(--red)',fontWeight:600,background:'var(--bg2)'}}>{v>0?'−'+fmt(v):''}</td>;})}
                <td style={{textAlign:'right',fontWeight:700,color:'var(--red)'}}>{(()=>{const t=MONTHS.reduce((s,m)=>s+grpExpMonth(m),0);return t>0?'−'+fmt(t):'';})()}</td>
              </tr>
              {showExpenses&&<React.Fragment>
                <tr style={{background:'rgba(255,100,100,.04)'}}><td style={{paddingLeft:20,fontSize:9,color:'var(--text2)'}}>↳ Накладные</td>{MONTHS.map((m,i)=>{const v=grpOhMonth(m);const tt=ttOh(m);return <td key={i} style={{textAlign:'right',fontSize:9,color:v>0?'var(--red)':'',background:i%3===2?'var(--bg2)':'',cursor:tt.length?'pointer':''}} onClick={e=>openPop(e,tt)}>{v>0?'−'+fmt(v):''}</td>;})}
                  {[0,1,2,3].map(qi=>{const v=[MONTHS[qi*3],MONTHS[qi*3+1],MONTHS[qi*3+2]].reduce((s,m)=>s+grpOhMonth(m),0);return <td key={qi} style={{textAlign:'right',fontSize:9,color:'var(--red)',background:'var(--bg2)'}}>{v>0?'−'+fmt(v):''}</td>;})}
                  <td style={{textAlign:'right',fontSize:9,fontWeight:600,color:'var(--red)'}}>{(()=>{const t=MONTHS.reduce((s,m)=>s+grpOhMonth(m),0);return t>0?'−'+fmt(t):'';})()}</td></tr>
                <tr style={{background:'rgba(255,100,100,.04)'}}><td style={{paddingLeft:20,fontSize:9,color:'var(--text2)'}}>↳ Зарплаты ({grpPersons.length})</td>{MONTHS.map((m,i)=>{const v=grpSalMonth(m);const tt=ttSal(m);return <td key={i} style={{textAlign:'right',fontSize:9,color:v>0?'var(--amber)':'',background:i%3===2?'var(--bg2)':'',cursor:tt.length?'pointer':''}} onClick={e=>openPop(e,tt)}>{v>0?'−'+fmt(v):''}</td>;})}
                  {[0,1,2,3].map(qi=>{const v=[MONTHS[qi*3],MONTHS[qi*3+1],MONTHS[qi*3+2]].reduce((s,m)=>s+grpSalMonth(m),0);return <td key={qi} style={{textAlign:'right',fontSize:9,color:'var(--amber)',background:'var(--bg2)'}}>{v>0?'−'+fmt(v):''}</td>;})}
                  <td style={{textAlign:'right',fontSize:9,fontWeight:600,color:'var(--amber)'}}>{(()=>{const t=MONTHS.reduce((s,m)=>s+grpSalMonth(m),0);return t>0?'−'+fmt(t):'';})()}</td></tr>
                {activePersons.map(pe=><tr key={pe.id} style={{background:'rgba(255,100,100,.02)'}}><td style={{paddingLeft:32,fontSize:9,color:'var(--text2)'}}><span className="clickable" style={{color:'var(--accent)',textDecoration:'underline'}} onClick={()=>setEditRgPerson(pe)}>{pe.name}</span>{pe.grade&&<span style={{fontSize:8,color:'var(--accent2)',marginLeft:4,fontWeight:600}}>{pe.grade}</span>}{pe.hire_date&&<span style={{fontSize:8,color:'var(--text2)',marginLeft:4}}>с {pe.hire_date.slice(5)}</span>}</td>{MONTHS.map((m,i)=>{const sal=Math.round(getPersonMonthSalary(pe,m));return <td key={i} style={{textAlign:'right',fontSize:9,color:sal>0?'var(--text2)':'',background:i%3===2?'var(--bg2)':''}}>{sal>0?fmt(sal):''}</td>;})}
                  {[0,1,2,3].map(qi=>{const v=Math.round([MONTHS[qi*3],MONTHS[qi*3+1],MONTHS[qi*3+2]].reduce((s,m)=>s+getPersonMonthSalary(pe,m),0));return <td key={qi} style={{textAlign:'right',fontSize:9,background:'var(--bg2)'}}>{v>0?fmt(v):''}</td>;})}
                  <td style={{textAlign:'right',fontSize:9,fontWeight:600}}>{fmt(Math.round(MONTHS.reduce((s,m)=>s+getPersonMonthSalary(pe,m),0)))}</td></tr>)}
                {firedPersons.length>0&&<tr style={{background:'rgba(255,80,80,.06)'}}><td colSpan={MONTHS.length+5+1} style={{paddingLeft:28,fontSize:9,color:'var(--red)',cursor:'pointer',fontWeight:600}} onClick={()=>setShowFiredInRg(!showFiredInRg)}>{showFiredInRg?'▼':'▶'} Уволенные ({firedPersons.length})</td></tr>}
                {showFiredInRg&&firedPersons.map(pe=><tr key={pe.id} style={{background:'rgba(255,80,80,.04)'}}><td style={{paddingLeft:32,fontSize:9,color:'var(--text2)',opacity:.7}}><span className="clickable" style={{color:'var(--accent)',textDecoration:'underline'}} onClick={()=>setEditRgPerson(pe)}>{pe.name}</span>{pe.grade&&<span style={{fontSize:8,color:'var(--accent2)',marginLeft:4,fontWeight:600}}>{pe.grade}</span>}<span style={{color:'var(--red)',fontSize:8,marginLeft:4}}>уволен{pe.fire_date?' '+pe.fire_date.slice(5):''}</span>{pe.hire_date&&<span style={{fontSize:8,color:'var(--text2)',marginLeft:4}}>с {pe.hire_date.slice(5)}</span>}</td>{MONTHS.map((m,i)=>{const sal=Math.round(getPersonMonthSalary(pe,m));return <td key={i} style={{textAlign:'right',fontSize:9,color:sal>0?'var(--text2)':'',background:i%3===2?'var(--bg2)':'',opacity:.7}}>{sal>0?fmt(sal):''}</td>;})}
                  {[0,1,2,3].map(qi=>{const v=Math.round([MONTHS[qi*3],MONTHS[qi*3+1],MONTHS[qi*3+2]].reduce((s,m)=>s+getPersonMonthSalary(pe,m),0));return <td key={qi} style={{textAlign:'right',fontSize:9,background:'var(--bg2)',opacity:.7}}>{v>0?fmt(v):''}</td>;})}
                  <td style={{textAlign:'right',fontSize:9,fontWeight:600,opacity:.7}}>{fmt(Math.round(MONTHS.reduce((s,m)=>s+getPersonMonthSalary(pe,m),0)))}</td></tr>)}
              </React.Fragment>}
              <tr style={{background:'var(--bg1)',borderTop:'1px solid var(--border)'}}><td style={{fontWeight:600,color:'var(--violet)'}}>Правки P&L</td>{MONTHS.map((m,i)=>{const v=grpOvr(g,m);return <td key={i} style={{textAlign:'right',color:v!==0?'var(--violet)':'',background:i%3===2?'var(--bg2)':''}}>{v!==0?fmt(v):''}</td>;})}{[0,1,2,3].map(qi=><td key={qi} style={{textAlign:'right',color:'var(--violet)',background:'var(--bg2)'}}>{fmt(qSum(grpOvr,g,qi))}</td>)}<td style={{textAlign:'right',fontWeight:700,color:'var(--violet)'}}>{fmt(yrSum(grpOvr,g))}</td></tr>
              <tr style={{borderTop:'2px solid var(--accent)',fontWeight:700}}><td>Итого факт (P&L+правки)</td>{MONTHS.map((m,i)=>{const v=grpFactPNL(g,m)+grpOvr(g,m);return <td key={i} style={{textAlign:'right',background:i%3===2?'var(--bg2)':''}}>{v!==0?fmt(v):''}</td>;})}{[0,1,2,3].map(qi=><td key={qi} style={{textAlign:'right',background:'var(--bg2)'}}>{fmt(qSum(grpFactPNL,g,qi)+qSum(grpOvr,g,qi))}</td>)}<td style={{textAlign:'right'}}>{fmt(yrSum(grpFactPNL,g)+yrSum(grpOvr,g))}</td></tr>
              <tr style={{borderTop:'2px solid var(--red)',fontWeight:700,color:'var(--emerald)'}}><td>Маржа (факт − расходы)</td>{MONTHS.map((m,i)=>{const rev=grpFactPNL(g,m)+grpOvr(g,m);const exp=grpExpMonth(m);const v=rev-exp;return <td key={i} style={{textAlign:'right',color:v>=0?'var(--emerald)':'var(--red)',background:i%3===2?'var(--bg2)':''}}>{v!==0?fmt(v):''}</td>;})}{[0,1,2,3].map(qi=>{const rev=qSum(grpFactPNL,g,qi)+qSum(grpOvr,g,qi);const exp=[MONTHS[qi*3],MONTHS[qi*3+1],MONTHS[qi*3+2]].reduce((s,m)=>s+grpExpMonth(m),0);const v=rev-exp;return <td key={qi} style={{textAlign:'right',color:v>=0?'var(--emerald)':'var(--red)',background:'var(--bg2)'}}>{fmt(v)}</td>;})}
                <td style={{textAlign:'right'}}>{(()=>{const rev=yrSum(grpFactPNL,g)+yrSum(grpOvr,g);const exp=MONTHS.reduce((s,m)=>s+grpExpMonth(m),0);const v=rev-exp;return <span style={{color:v>=0?'var(--emerald)':'var(--red)'}}>{fmt(v)}</span>;})()}</td></tr>
            </tbody>
          </table>
        </div>
        <div className="card" style={{marginTop:12,padding:12}}>
          <div className="card-title">Проекты {g} ({gp.length})</div>
          <table style={{fontSize:10,width:'100%'}}><thead><tr><th style={{textAlign:'left'}}>Проект</th><th>Тип</th><th style={{textAlign:'right'}}>Контракт</th><th style={{textAlign:'right'}}>Оплачено</th><th style={{textAlign:'right'}}>Признано</th><th>Статус</th></tr></thead>
          <tbody>{gp.map(pr=>{const paid=(pr.payments||[]).filter(x=>!x.prior_year&&x.status==='PAID').reduce((s,x)=>s+(Number(x.amount)||0),0);const acc=(pr.payments||[]).filter(x=>!x.prior_year&&x.status==='ACCRUED').reduce((s,x)=>s+(Number(x.amount)||0),0);return <tr key={pr.id}><td style={{fontWeight:600}}>{goProject?<span className="clickable" style={{color:'var(--accent)',textDecoration:'underline',cursor:'pointer'}} onClick={()=>goProject(pr.id)}>{pr.name||pr.code}</span>:(pr.name||pr.code)}</td><td>{pr.project_type==='New Delivery'?'НД':'ОД'}</td><td style={{textAlign:'right'}}>{fmt(getEffTCV(pr))}</td><td style={{textAlign:'right',color:'var(--green)'}}>{paid>0?fmt(paid):''}</td><td style={{textAlign:'right',color:'var(--amber)'}}>{acc>0?fmt(acc):''}</td><td>{SB(pr.status)}</td></tr>;})}</tbody></table>
        </div>
      </div>;
    })()}
    {salesTab==='forecast'&&(()=>{
      /* === ПРОГНОЗ ПРОДАЖ === */
      const sfMonths=['01','02','03','04','05','06','07','08','09','10','11','12'];
      const sfMonthNames=['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
      const sfQuarters=[[0,1,2,'1 кв'],[3,4,5,'2 кв'],[6,7,8,'3 кв'],[9,10,11,'4 кв']];
      const sfRows=[
        {key:'sale_od',label:'Продажа ОД',editable:true,type:'data'},
        {key:'sale_nd',label:'Продажа НД',editable:true,type:'data'},
        {key:'sale_upsell1',label:'Продажа Допродажи 1',editable:true,type:'data'},
        {key:'sale_upsell2',label:'Продажа Допродажи 2',editable:true,type:'data'},
        {key:'subtotal1',label:'ИТОГО',editable:false,type:'subtotal'},
        {key:'intro_services',label:'Вводные услуги',editable:true,type:'data'},
        {key:'cut2',label:'2 срез',editable:false,type:'cut'},
        {key:'strategy_dept',label:'Отдел стратегий',editable:true,type:'data'},
        {key:'cut3',label:'3 срез',editable:false,type:'cut'},
      ];
      /* 5 колонок на месяц: plan_static, plan_roll, expected, fact, remaining */
      const sfCols=[
        {key:'plan_static',label:'План стат.'},
        {key:'plan_roll',label:'План Roll'},
        {key:'expected',label:'Ожидание'},
        {key:'fact',label:'Факт'},
        {key:'remaining',label:'Остаток'},
      ];
      const colCount=sfCols.length;
      const _sfBudget=store.data.kb_budget||[];
      const _allProjects=store.data.projects||[];
      /* Собираем 1-е транши (PAID или ACCRUED) по месяцам для Факта */
      const _firstTranches=[];
      /* Не-первые транши (tranche_number > 1) для Отдела стратегий */
      const _laterTranches=[];
      /* Не-первые транши (tranche>1), PLANNED — для Ожидания отдела стратегий */
      const _laterPlanned=[];
      _allProjects.forEach(proj=>{
        if(proj.status==='CANCELLED'||proj.project_type==='ФК')return;
        const _sWg=proj.sales_group||proj.work_group||'';
        (proj.payments||[]).filter(pm=>!pm.prior_year).forEach(pm=>{
          const tn=Number(pm.tranche_number)||0;
          const isPaidOrAccrued=pm.status==='PAID'||pm.status==='ACCRUED';
          if(isPaidOrAccrued){
            const pmMonth=(pm.status==='PAID'?(pm.actual_date||pm.planned_date):(pm.accrued_date||pm.planned_date))||'';
            const mPfx=pmMonth.slice(0,7);
            const entry={projId:proj.id,projCode:proj.code,projName:proj.name,projType:proj.project_type,wg:_sWg,origWg:proj.work_group||'',amount:Number(pm.amount)||0,month:mPfx,status:pm.status,is_upsell:!!pm.is_upsell,pmId:pm.id,trancheNum:pm.tranche_number};
            if(tn===1) _firstTranches.push(entry);
            else if(tn>1) _laterTranches.push(entry);
          } else if(tn>1){
            /* PLANNED / не оплачен — ожидание по planned_date */
            const mPfx=(pm.planned_date||'').slice(0,7);
            _laterPlanned.push({projId:proj.id,projCode:proj.code,projName:proj.name,projType:proj.project_type,wg:_sWg,origWg:proj.work_group||'',amount:Number(pm.amount)||0,month:mPfx,status:pm.status||'PLANNED',is_upsell:!!pm.is_upsell,pmId:pm.id,trancheNum:pm.tranche_number});
          }
        });
      });
      /* Факт авторасчёт: sale_od, sale_nd, sale_upsell1, sale_upsell2, strategy_dept */
      const sfFactAuto=(rowKey,monthPfx)=>{
        const items=_firstTranches.filter(t=>t.month===monthPfx);
        if(rowKey==='sale_od') return items.filter(t=>t.projType==='Old Delivery'&&!t.is_upsell).reduce((s,t)=>s+t.amount,0);
        if(rowKey==='sale_nd') return items.filter(t=>t.projType==='New Delivery'&&!t.is_upsell).reduce((s,t)=>s+t.amount,0);
        if(rowKey==='sale_upsell1') return items.filter(t=>t.is_upsell&&t.wg!=='РГ2').reduce((s,t)=>s+t.amount,0);
        if(rowKey==='sale_upsell2') return items.filter(t=>t.is_upsell&&t.wg==='РГ2').reduce((s,t)=>s+t.amount,0);
        if(rowKey==='strategy_dept'){const li=_laterTranches.filter(t=>t.month===monthPfx);return li.reduce((s,t)=>s+t.amount,0);}
        return 0;
      };
      /* Drill-down: получить список оплат для ячейки факта */
      const sfFactItems=(rowKey,monthPfx)=>{
        const items=_firstTranches.filter(t=>t.month===monthPfx);
        if(rowKey==='sale_od') return items.filter(t=>t.projType==='Old Delivery'&&!t.is_upsell);
        if(rowKey==='sale_nd') return items.filter(t=>t.projType==='New Delivery'&&!t.is_upsell);
        if(rowKey==='sale_upsell1') return items.filter(t=>t.is_upsell&&t.wg!=='РГ2');
        if(rowKey==='sale_upsell2') return items.filter(t=>t.is_upsell&&t.wg==='РГ2');
        if(rowKey==='strategy_dept') return _laterTranches.filter(t=>t.month===monthPfx);
        return [];
      };
      /* Ожидание авторасчёт: strategy_dept — сумма не-первых траншей PLANNED по planned_date */
      const sfExpAuto=(rowKey,monthPfx)=>{
        if(rowKey==='strategy_dept') return _laterPlanned.filter(t=>t.month===monthPfx).reduce((s,t)=>s+t.amount,0);
        return null;
      };
      const sfExpItems=(rowKey,monthPfx)=>{
        if(rowKey==='strategy_dept') return _laterPlanned.filter(t=>t.month===monthPfx);
        return null;
      };
      const sfVal=(rowKey,monthPfx,colKey)=>{
        if(colKey==='fact'){
          if(['sale_od','sale_nd','sale_upsell1','sale_upsell2','strategy_dept'].includes(rowKey)){
            return sfFactAuto(rowKey,monthPfx);
          }
        }
        if(colKey==='expected'){
          const autoExp=sfExpAuto(rowKey,monthPfx);
          if(autoExp!==null) return autoExp;
        }
        const cfType='SF_'+rowKey.toUpperCase()+'_'+colKey.toUpperCase();
        const entry=_sfBudget.find(x=>x.cf_type===cfType&&(x.month||'')===monthPfx&&!x.person_id);
        return entry?Number(entry.amount_plan)||0:0;
      };
      /* Rolling Forecast: авторасчёт с набегающим итогом.
         Roll[0] = PlanStatic[0]
         Roll[i] = PlanStatic[i] + carry, где carry накапливается:
           после месяца i: delta = Roll[i] - Fact[i]
           carry_per_month = delta / (12 - i - 1)  — размазывается на оставшиеся месяцы */
      const _rollCache={};
      const sfRollRow=(rowKey)=>{
        if(_rollCache[rowKey])return _rollCache[rowKey];
        const result=new Array(12).fill(0);
        let carry=0;
        for(let i=0;i<12;i++){
          const mPfx=allSfMonths[i];
          const planS=sfVal(rowKey,mPfx,'plan_static');
          result[i]=planS+carry;
          const fact=sfVal(rowKey,mPfx,'fact');
          const delta=result[i]-fact;
          const remaining=12-i-1;
          carry=remaining>0?delta/remaining:0;
        }
        _rollCache[rowKey]=result;
        return result;
      };
      const allSfMonths=sfMonths.map(m=>yr+'-'+m);
      const sfCalc=(rowKey,monthPfx,colKey)=>{
        const dataKeys=['sale_od','sale_nd','sale_upsell1','sale_upsell2'];
        if(rowKey==='subtotal1') return dataKeys.reduce((s,k)=>s+sfCalc(k,monthPfx,colKey),0);
        if(rowKey==='cut2') return sfCalc('subtotal1',monthPfx,colKey)+sfCalc('intro_services',monthPfx,colKey);
        if(rowKey==='cut3') return sfCalc('cut2',monthPfx,colKey)+sfCalc('strategy_dept',monthPfx,colKey);
        if(colKey==='plan_roll'){
          const idx=allSfMonths.indexOf(monthPfx);
          if(idx<0)return 0;
          return Math.round(sfRollRow(rowKey)[idx]);
        }
        return sfVal(rowKey,monthPfx,colKey);
      };
      const sfQtr=(rowKey,qIdx,colKey)=>{
        const q=sfQuarters[qIdx];
        return [yr+'-'+sfMonths[q[0]],yr+'-'+sfMonths[q[1]],yr+'-'+sfMonths[q[2]]].reduce((s,m)=>s+sfCalc(rowKey,m,colKey),0);
      };
      const _saveSfOne=(rowKey,monthPfx,colKey,val)=>{
        const cfType='SF_'+rowKey.toUpperCase()+'_'+colKey.toUpperCase();
        const existing=_sfBudget.find(x=>x.cf_type===cfType&&(x.month||'')===monthPfx&&!x.person_id);
        if(existing){store.updateKbBudgetItem(existing.id,{amount_plan:Number(val)||0});}
        else if(Number(val)>0){store.addKbBudgetItem({name:'SF '+rowKey+' '+colKey,amount_plan:Number(val)||0,month:monthPfx,cf_type:cfType});}
      };
      const saveSfCell=(rowKey,monthPfx,colKey,val)=>{
        _saveSfOne(rowKey,monthPfx,colKey,val);
        /* Автозаполнение: при вводе Plan Static — каскад на последующие месяцы */
        if(colKey==='plan_static'){
          const idx=allSfMonths.indexOf(monthPfx);
          if(idx>=0){
            const nv=Number(val)||0;
            for(let i=idx+1;i<12;i++){
              const futureM=allSfMonths[i];
              const futureCf='SF_'+rowKey.toUpperCase()+'_PLAN_STATIC';
              const futureEntry=_sfBudget.find(x=>x.cf_type===futureCf&&(x.month||'')===futureM&&!x.person_id);
              const futureVal=futureEntry?Number(futureEntry.amount_plan)||0:0;
              /* Перезаписываем, только если ячейка пустая ИЛИ равна предыдущему каскадному значению */
              if(futureVal===0||futureVal===sfVal(rowKey,allSfMonths[idx],'plan_static')){
                _saveSfOne(rowKey,futureM,'plan_static',nv);
              } else {
                break; /* Встретили ручное значение — останавливаемся */
              }
            }
          }
        }
      };
      const visQ=sfQuarters[sfQtrView];
      const visMonths=[yr+'-'+sfMonths[visQ[0]],yr+'-'+sfMonths[visQ[1]],yr+'-'+sfMonths[visQ[2]]];
      const visMonthNames=[sfMonthNames[visQ[0]],sfMonthNames[visQ[1]],sfMonthNames[visQ[2]]];
      const qLabel=visQ[3];
      const cellSt={padding:'3px 5px',textAlign:'right',fontSize:10,borderRight:'1px solid var(--bg3)'};
      const hdSt={padding:'4px 5px',textAlign:'center',fontSize:9,fontWeight:600,borderRight:'1px solid var(--bg3)',background:'var(--bg2)'};
      const subSt={background:'rgba(33,150,243,0.06)',fontWeight:700};
      const cutSt={background:'rgba(76,175,80,0.08)',fontWeight:700};
      return <div>
        <div className="dash-card" style={{padding:12,overflowX:'auto'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
            <div style={{fontSize:14,fontWeight:700,color:'var(--accent2)'}}>ПРОГНОЗ ПРОДАЖ — {yr}</div>
            <div style={{display:'flex',gap:6}}>
              {sfQuarters.map((q,i)=><button key={i} className="btn" style={{fontSize:10,padding:'3px 10px',background:sfQtrView===i?'var(--accent2)':'var(--bg3)',color:sfQtrView===i?'#fff':'var(--text1)',border:'none',borderRadius:5,cursor:'pointer'}} onClick={()=>setSfQtrView(i)}>{q[3]}</button>)}
            </div>
          </div>
          <table style={{width:'100%',fontSize:10,borderCollapse:'collapse',border:'1px solid var(--bg3)'}}>
            <thead>
              <tr style={{background:'var(--bg2)'}}>
                <th style={{...hdSt,textAlign:'left',width:170,position:'sticky',left:0,background:'var(--bg2)',zIndex:2}} rowSpan={2}>Показатель</th>
                {visMonthNames.map((mn,i)=><th key={i} style={{...hdSt,borderBottom:'none'}} colSpan={colCount}>{mn}</th>)}
                <th style={{...hdSt,borderBottom:'none',background:'rgba(33,150,243,0.1)'}} colSpan={colCount}>{qLabel}</th>
              </tr>
              <tr style={{background:'var(--bg2)'}}>
                {[...visMonthNames,qLabel].map((_,gi)=>sfCols.map((c,ci)=><th key={gi+'_'+ci} style={{...hdSt,fontSize:8,padding:'2px 3px',background:gi===3?'rgba(33,150,243,0.1)':'var(--bg2)'}}>{c.label}</th>))}
              </tr>
            </thead>
            <tbody>
              {sfRows.map(row=>{
                const isCalc=!row.editable;
                const rowStyle=row.type==='subtotal'?subSt:row.type==='cut'?cutSt:{};
                return <tr key={row.key} style={{...rowStyle,borderBottom:'1px solid var(--bg3)'}}>
                  <td style={{padding:'4px 6px',fontWeight:isCalc?700:400,fontSize:10,position:'sticky',left:0,background:row.type==='subtotal'?'rgba(33,150,243,0.06)':row.type==='cut'?'rgba(76,175,80,0.08)':'var(--bg1)',zIndex:1,borderRight:'2px solid var(--bg3)'}}>{row.label}</td>
                  {visMonths.map((mPfx,mi)=>sfCols.map((col,ci)=>{
                    const isRemaining=col.key==='remaining';
                    if(isRemaining){
                      /* Остаток = План Roll - Факт */
                      const rv=sfCalc(row.key,mPfx,'plan_roll')-sfCalc(row.key,mPfx,'fact');
                      return <td key={mi+'_'+ci} style={{...cellSt,fontWeight:isCalc?600:400,color:rv<0?'var(--red)':rv>0?'var(--green)':'var(--text2)',background:'rgba(255,152,0,0.04)'}}>{rv?fmt(Math.round(rv)):''}</td>;
                    }
                    const v=sfCalc(row.key,mPfx,col.key);
                    const isRoll=col.key==='plan_roll';
                    const isFact=col.key==='fact';
                    const isAutoFact=isFact&&['sale_od','sale_nd','sale_upsell1','sale_upsell2','strategy_dept'].includes(row.key);
                    if(isAutoFact){
                      const items=sfFactItems(row.key,mPfx);
                      return <td key={mi+'_'+ci} style={{...cellSt,fontWeight:600,color:v>0?'var(--green)':'var(--text2)',cursor:v>0?'pointer':'default',background:'rgba(76,175,80,0.04)'}} title={items.length>0?items.map(t=>t.projCode+': '+fmt(Math.round(t.amount))).join(', '):''} onClick={()=>{if(items.length>0)setSfDrill({rowKey:row.key,month:mPfx,items});}}>{v?fmt(Math.round(v)):''}</td>;
                    }
                    const isExp=col.key==='expected';
                    const isAutoExp=isExp&&sfExpItems(row.key,mPfx)!==null;
                    if(isAutoExp){
                      const items=sfExpItems(row.key,mPfx);
                      return <td key={mi+'_'+ci} style={{...cellSt,fontWeight:600,color:v>0?'var(--amber)':'var(--text2)',cursor:v>0?'pointer':'default',background:'rgba(255,152,0,0.04)'}} title={items.length>0?items.map(t=>t.projCode+': '+fmt(Math.round(t.amount))).join(', '):''} onClick={()=>{if(items.length>0)setSfDrill({rowKey:row.key+'_exp',month:mPfx,items});}}>{v?fmt(Math.round(v)):''}</td>;
                    }
                    if(row.editable&&!isRoll&&!isFact){
                      return <td key={mi+'_'+ci} style={{...cellSt,padding:0}}>
                        <input type="number" defaultValue={v||''} style={{width:'100%',background:'transparent',border:'none',textAlign:'right',fontSize:10,padding:'3px 5px',color:'var(--text1)'}}
                          onBlur={e=>{const nv=Number(e.target.value)||0;if(nv!==v)saveSfCell(row.key,mPfx,col.key,nv);}}
                          onKeyDown={e=>{if(e.key==='Enter')e.target.blur();}}/>
                      </td>;
                    }
                    if(row.editable&&isFact){
                      return <td key={mi+'_'+ci} style={{...cellSt,padding:0}}>
                        <input type="number" defaultValue={v||''} style={{width:'100%',background:'transparent',border:'none',textAlign:'right',fontSize:10,padding:'3px 5px',color:'var(--text1)'}}
                          onBlur={e=>{const nv=Number(e.target.value)||0;if(nv!==v)saveSfCell(row.key,mPfx,col.key,nv);}}
                          onKeyDown={e=>{if(e.key==='Enter')e.target.blur();}}/>
                      </td>;
                    }
                    return <td key={mi+'_'+ci} style={{...cellSt,fontWeight:isCalc||isRoll?700:400,color:isRoll?'var(--violet)':'var(--text1)',background:isRoll?'rgba(139,92,246,0.04)':''}}>{v?fmt(Math.round(v)):''}</td>;
                  }))}
                  {sfCols.map((col,ci)=>{
                    const isRemaining=col.key==='remaining';
                    if(isRemaining){
                      const rv=sfQtr(row.key,sfQtrView,'plan_roll')-sfQtr(row.key,sfQtrView,'fact');
                      return <td key={'q_'+ci} style={{...cellSt,fontWeight:700,background:'rgba(33,150,243,0.06)',color:rv<0?'var(--red)':rv>0?'var(--green)':'var(--accent2)'}}>{rv?fmt(Math.round(rv)):''}</td>;
                    }
                    const qv=sfQtr(row.key,sfQtrView,col.key);
                    return <td key={'q_'+ci} style={{...cellSt,fontWeight:700,background:'rgba(33,150,243,0.06)',color:'var(--accent2)'}}>{qv?fmt(Math.round(qv)):''}</td>;
                  })}
                </tr>;
              })}
            </tbody>
          </table>
        </div>
        {/* Drill-down popup */}
        {sfDrill&&<div className="dash-card" style={{padding:12,marginTop:10,border:'2px solid var(--accent2)',borderRadius:8}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
            <div style={{fontSize:12,fontWeight:700,color:'var(--accent2)'}}>Детализация: {sfRows.find(r=>r.key===sfDrill.rowKey)?.label||sfDrill.rowKey} — {sfDrill.month}</div>
            <span style={{cursor:'pointer',fontSize:14,color:'var(--text2)'}} onClick={()=>setSfDrill(null)}>✕</span>
          </div>
          <table style={{width:'100%',fontSize:11,borderCollapse:'collapse'}}>
            <thead><tr style={{borderBottom:'1px solid var(--border)',background:'var(--bg2)'}}>
              <th style={{textAlign:'left',padding:'4px 6px'}}>Проект</th>
              <th style={{textAlign:'left',padding:'4px 6px'}}>Тип</th>
              <th style={{textAlign:'left',padding:'4px 6px'}}>РГ</th>
              <th style={{textAlign:'left',padding:'4px 6px'}}>Гр. продаж</th>
              <th style={{textAlign:'center',padding:'4px 6px'}}>Статус</th>
              <th style={{textAlign:'center',padding:'4px 6px',width:50}}>Транш</th>
              <th style={{textAlign:'right',padding:'4px 6px'}}>Сумма</th>
              <th style={{textAlign:'center',padding:'4px 6px'}}>Допродажа</th>
            </tr></thead>
            <tbody>{sfDrill.items.map((it,i)=><tr key={i} style={{borderBottom:'1px solid var(--bg3)',background:it.is_upsell?'rgba(255,152,0,0.06)':''}}>
              <td style={{padding:'4px 6px',cursor:'pointer',color:'var(--accent)'}} onClick={()=>goProject(it.projId)}>{it.projCode} — {it.projName}</td>
              <td style={{padding:'4px 6px',fontSize:10}}>{it.projType}</td>
              <td style={{padding:'4px 6px',fontSize:10}}>{it.origWg}</td>
              <td style={{padding:'2px 4px'}}><select value={it.wg} style={{fontSize:10,padding:'1px 2px',width:56,border:'1px solid var(--bg3)',borderRadius:4,background:it.wg!==it.origWg?'rgba(99,102,241,0.15)':'var(--bg1)',color:'var(--text1)'}} onChange={e=>{const nv=e.target.value;store.updateProject(it.projId,{sales_group:nv});setSfDrill(d=>({...d,items:d.items.map((x,j)=>j===i?{...x,wg:nv}:x)}));}}><option value="">= РГ</option><option value="РГ1">РГ1</option><option value="РГ2">РГ2</option></select></td>
              <td style={{textAlign:'center',padding:'2px 4px'}}><select value={it.status} style={{fontSize:10,padding:'1px 2px',width:80,border:'1px solid var(--bg3)',borderRadius:4,color:'var(--text1)',background:it.status==='PAID'?'rgba(76,175,80,0.15)':it.status==='ACCRUED'?'rgba(33,150,243,0.15)':'rgba(255,152,0,0.10)'}} onChange={e=>{const nv=e.target.value;const upd={status:nv};const today=new Date().toISOString();if(nv==='PAID'&&!it.status!=='PAID')upd.actual_date=today;if(nv==='ACCRUED')upd.accrued_date=today;store.updatePayment(it.projId,it.pmId,upd);setSfDrill(d=>({...d,items:d.items.map((x,j)=>j===i?{...x,status:nv}:x)}));}}><option value="PLANNED">запланирован</option><option value="ACCRUED">по актам</option><option value="PAID">оплачен</option></select></td>
              <td style={{textAlign:'center',padding:'2px 4px'}}><select value={it.trancheNum||1} style={{fontSize:10,padding:'1px 2px',width:42,border:'1px solid var(--bg3)',borderRadius:4,background:it.trancheNum!==1?'rgba(255,152,0,0.15)':'var(--bg1)',color:'var(--text1)'}} onChange={e=>{const nv=Number(e.target.value);store.updatePayment(it.projId,it.pmId,{tranche_number:nv,is_upsell:nv===1?it.is_upsell:false});if(nv!==1){store.showToast(it.projCode+': транш → #'+nv+' (убран из 1-х траншей)');setSfDrill(d=>{const next=d.items.filter((_,j)=>j!==i);return next.length>0?{...d,items:next}:null;});}else{setSfDrill(d=>({...d,items:d.items.map((x,j)=>j===i?{...x,trancheNum:nv}:x)}));}}}>{[1,2,3,4,5,6,7,8,9,10].map(n=><option key={n} value={n}>{n}</option>)}</select></td>
              <td style={{textAlign:'right',padding:'2px 4px'}}><input type="number" defaultValue={it.amount} style={{width:90,textAlign:'right',fontSize:11,padding:'2px 4px',border:'1px solid var(--bg3)',borderRadius:4,background:'var(--bg1)',color:'var(--text1)'}} onBlur={e=>{const nv=Number(e.target.value)||0;if(nv!==it.amount){store.updatePayment(it.projId,it.pmId,{amount:nv});setSfDrill(d=>({...d,items:d.items.map((x,j)=>j===i?{...x,amount:nv}:x)}));}}}/></td>
              <td style={{textAlign:'center',padding:'4px 6px'}}><input type="checkbox" checked={!!it.is_upsell} style={{accentColor:'var(--amber)',cursor:'pointer'}} onChange={e=>{const nv=e.target.checked;store.updatePayment(it.projId,it.pmId,{is_upsell:nv});setSfDrill(d=>({...d,items:d.items.map((x,j)=>j===i?{...x,is_upsell:nv}:x)}));}}/></td>
            </tr>)}</tbody>
            <tfoot><tr style={{borderTop:'2px solid var(--accent2)',fontWeight:700}}>
              <td colSpan={6} style={{padding:'4px 6px'}}>Итого</td>
              <td style={{textAlign:'right',padding:'4px 6px'}}>{fmt(Math.round(sfDrill.items.reduce((s,t)=>s+t.amount,0)))}</td>
              <td></td>
            </tr></tfoot>
          </table>
        </div>}
      {/* ===== ВИТРИНЫ ДАННЫХ ===== */}
      <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(280px,1fr))',gap:12,marginTop:16}}>
        {/* 1. Воронка: План vs Факт по месяцам (3 срез) */}
        {(()=>{
          const qMonths=allSfMonths.slice(sfQtrView*3,sfQtrView*3+3);
          const planData=qMonths.map(m=>sfCalc('cut3',m,'plan_static'));
          const factData=qMonths.map(m=>sfCalc('cut3',m,'fact'));
          const rollData=qMonths.map(m=>sfCalc('cut3',m,'plan_roll'));
          const maxV=Math.max(...planData,...factData,...rollData,1);
          const mLabels=qMonths.map(m=>{const d=new Date(m+'-01');return d.toLocaleString('ru',{month:'short'});});
          return <div className="dash-card" style={{padding:12}}>
            <div style={{fontSize:12,fontWeight:700,marginBottom:8,color:'var(--text1)'}}>📊 3-й срез: План / Роллинг / Факт</div>
            {mLabels.map((ml,i)=><div key={i} style={{marginBottom:6}}>
              <div style={{fontSize:10,color:'var(--text2)',marginBottom:2}}>{ml}</div>
              <div style={{display:'flex',gap:4,alignItems:'center'}}>
                <div style={{height:8,borderRadius:4,background:'var(--accent)',opacity:0.3,width:(planData[i]/maxV*100)+'%',minWidth:2}} title={'План: '+fmt(Math.round(planData[i]))}/>
              </div>
              <div style={{display:'flex',gap:4,alignItems:'center'}}>
                <div style={{height:8,borderRadius:4,background:'var(--violet)',width:(rollData[i]/maxV*100)+'%',minWidth:2}} title={'Роллинг: '+fmt(Math.round(rollData[i]))}/>
              </div>
              <div style={{display:'flex',gap:4,alignItems:'center'}}>
                <div style={{height:10,borderRadius:4,background:'var(--green)',width:(factData[i]/maxV*100)+'%',minWidth:2}} title={'Факт: '+fmt(Math.round(factData[i]))}/>
                <span style={{fontSize:9,color:'var(--text2)'}}>{fmt(Math.round(factData[i]))}</span>
              </div>
            </div>)}
            <div style={{display:'flex',gap:10,fontSize:9,marginTop:6,color:'var(--text2)'}}>
              <span>▪ <span style={{color:'var(--accent)'}}>План</span></span>
              <span>▪ <span style={{color:'var(--violet)'}}>Роллинг</span></span>
              <span>▪ <span style={{color:'var(--green)'}}>Факт</span></span>
            </div>
          </div>;
        })()}

        {/* 2. Выполнение плана (% от 3 среза за год) */}
        {(()=>{
          const yrPlan=allSfMonths.reduce((s,m)=>s+sfCalc('cut3',m,'plan_static'),0);
          const yrFact=allSfMonths.reduce((s,m)=>s+sfCalc('cut3',m,'fact'),0);
          const pct=yrPlan>0?Math.round(yrFact/yrPlan*100):0;
          const yrRoll=allSfMonths.reduce((s,m)=>s+sfCalc('cut3',m,'plan_roll'),0);
          return <div className="dash-card" style={{padding:12,textAlign:'center'}}>
            <div style={{fontSize:12,fontWeight:700,marginBottom:8,color:'var(--text1)'}}>🎯 Выполнение годового плана</div>
            <div style={{position:'relative',width:100,height:100,margin:'0 auto'}}>
              <svg viewBox="0 0 36 36" style={{width:100,height:100}}>
                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--bg3)" strokeWidth="3"/>
                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke={pct>=100?'var(--green)':pct>=50?'var(--amber)':'var(--red)'} strokeWidth="3" strokeDasharray={Math.min(pct,100)+', 100'}/>
              </svg>
              <div style={{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%)',fontSize:20,fontWeight:700,color:pct>=100?'var(--green)':pct>=50?'var(--amber)':'var(--red)'}}>{pct}%</div>
            </div>
            <div style={{fontSize:10,color:'var(--text2)',marginTop:6}}>Факт: {fmt(Math.round(yrFact))} / План: {fmt(Math.round(yrPlan))}</div>
            <div style={{fontSize:9,color:'var(--violet)',marginTop:2}}>Роллинг: {fmt(Math.round(yrRoll))}</div>
          </div>;
        })()}

        {/* 3. Топ-5 проектов по факту продаж */}
        {(()=>{
          const projMap={};
          [..._firstTranches,..._laterTranches].forEach(t=>{projMap[t.projId]=projMap[t.projId]||{name:t.projCode,amount:0};projMap[t.projId].amount+=t.amount;});
          const top5=Object.values(projMap).sort((a,b)=>b.amount-a.amount).slice(0,5);
          const maxA=top5[0]?.amount||1;
          return <div className="dash-card" style={{padding:12}}>
            <div style={{fontSize:12,fontWeight:700,marginBottom:8,color:'var(--text1)'}}>🏆 Топ-5 проектов по факту</div>
            {top5.map((p,i)=><div key={i} style={{marginBottom:4}}>
              <div style={{display:'flex',justifyContent:'space-between',fontSize:10}}><span style={{fontWeight:600}}>{p.name}</span><span style={{color:'var(--green)'}}>{fmt(Math.round(p.amount))}</span></div>
              <div style={{height:6,borderRadius:3,background:'var(--bg3)',overflow:'hidden'}}><div style={{height:'100%',borderRadius:3,background:'linear-gradient(90deg,var(--accent),var(--green))',width:(p.amount/maxA*100)+'%'}}/></div>
            </div>)}
            {top5.length===0&&<div style={{fontSize:10,color:'var(--text2)',textAlign:'center'}}>Нет данных</div>}
          </div>;
        })()}

        {/* 4. Разбивка по строкам (pie-like) */}
        {(()=>{
          const dataRows=['sale_od','sale_nd','sale_upsell1','sale_upsell2','strategy_dept'];
          const labels={'sale_od':'ОД','sale_nd':'НД','sale_upsell1':'Допрод.1','sale_upsell2':'Допрод.2','strategy_dept':'Стратегии'};
          const colors=['#5c6bc0','#42a5f5','#ffca28','#ff7043','#66bb6a'];
          const totals=dataRows.map(r=>allSfMonths.reduce((s,m)=>s+sfCalc(r,m,'fact'),0));
          const grand=totals.reduce((s,v)=>s+v,0)||1;
          return <div className="dash-card" style={{padding:12}}>
            <div style={{fontSize:12,fontWeight:700,marginBottom:8,color:'var(--text1)'}}>📈 Структура факта продаж</div>
            <div style={{display:'flex',height:18,borderRadius:6,overflow:'hidden',marginBottom:8}}>
              {totals.map((v,i)=>v>0?<div key={i} style={{width:(v/grand*100)+'%',background:colors[i]}} title={labels[dataRows[i]]+': '+fmt(Math.round(v))}/>:null)}
            </div>
            {dataRows.map((r,i)=><div key={r} style={{display:'flex',justifyContent:'space-between',fontSize:10,marginBottom:2}}>
              <span><span style={{display:'inline-block',width:8,height:8,borderRadius:2,background:colors[i],marginRight:4}}/>{labels[r]}</span>
              <span style={{fontWeight:600}}>{fmt(Math.round(totals[i]))} <span style={{color:'var(--text2)',fontWeight:400}}>({Math.round(totals[i]/grand*100)}%)</span></span>
            </div>)}
          </div>;
        })()}

        {/* 5. Ожидаемые поступления (ближ. 3 мес.) */}
        {(()=>{
          const now=new Date();const upcoming=[];
          for(let i=0;i<3;i++){const d=new Date(now.getFullYear(),now.getMonth()+i,1);const m=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
            const exp=allSfMonths.includes(m)?sfCalc('cut3',m,'expected'):0;
            const fact=allSfMonths.includes(m)?sfCalc('cut3',m,'fact'):0;
            upcoming.push({month:m,label:d.toLocaleString('ru',{month:'long'}),exp,fact});}
          return <div className="dash-card" style={{padding:12}}>
            <div style={{fontSize:12,fontWeight:700,marginBottom:8,color:'var(--text1)'}}>📅 Ожидаемые поступления (3 мес.)</div>
            {upcoming.map((u,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'4px 0',borderBottom:i<2?'1px solid var(--bg3)':'none'}}>
              <span style={{fontSize:11,fontWeight:500,textTransform:'capitalize'}}>{u.label}</span>
              <div style={{textAlign:'right'}}>
                <div style={{fontSize:11,fontWeight:600,color:'var(--amber)'}}>{fmt(Math.round(u.exp))} ₽</div>
                {u.fact>0&&<div style={{fontSize:9,color:'var(--green)'}}>факт: {fmt(Math.round(u.fact))}</div>}
              </div>
            </div>)}
          </div>;
        })()}

        {/* 6. Остаток до плана по месяцам (sparkline) */}
        {(()=>{
          const remainings=allSfMonths.map(m=>sfCalc('cut3',m,'plan_roll')-sfCalc('cut3',m,'fact'));
          const maxR=Math.max(...remainings.map(Math.abs),1);
          return <div className="dash-card" style={{padding:12}}>
            <div style={{fontSize:12,fontWeight:700,marginBottom:8,color:'var(--text1)'}}>📉 Остаток до роллинг-плана</div>
            <div style={{display:'flex',alignItems:'flex-end',gap:2,height:60}}>
              {remainings.map((r,i)=>{const h=Math.abs(r)/maxR*50;return <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center'}}>
                <div style={{width:'100%',height:h,borderRadius:2,background:r>0?'var(--amber)':'var(--green)',opacity:0.8}}/>
                <div style={{fontSize:7,color:'var(--text2)',marginTop:2}}>{(i+1)}</div>
              </div>;})}
            </div>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:9,color:'var(--text2)',marginTop:4}}>
              <span>▪ <span style={{color:'var(--amber)'}}>Недовып.</span></span>
              <span>▪ <span style={{color:'var(--green)'}}>Перевып.</span></span>
            </div>
          </div>;
        })()}

        {/* 7. Конверсия: 1-е транши → не-первые (динамика) */}
        {(()=>{
          const qMonths=allSfMonths.slice(sfQtrView*3,sfQtrView*3+3);
          const mLabels=qMonths.map(m=>{const d=new Date(m+'-01');return d.toLocaleString('ru',{month:'short'});});
          const first=qMonths.map(m=>_firstTranches.filter(t=>t.month===m).length);
          const later=qMonths.map(m=>_laterTranches.filter(t=>t.month===m).length);
          return <div className="dash-card" style={{padding:12}}>
            <div style={{fontSize:12,fontWeight:700,marginBottom:8,color:'var(--text1)'}}>🔄 1-е vs не-первые транши</div>
            {mLabels.map((ml,i)=><div key={i} style={{marginBottom:6}}>
              <div style={{fontSize:10,color:'var(--text2)',marginBottom:2}}>{ml}</div>
              <div style={{display:'flex',gap:8,fontSize:10}}>
                <span style={{color:'var(--accent)'}}>1-е: <b>{first[i]}</b> ({fmt(_firstTranches.filter(t=>t.month===qMonths[i]).reduce((s,t)=>s+t.amount,0))})</span>
                <span style={{color:'var(--violet)'}}>Повт: <b>{later[i]}</b> ({fmt(_laterTranches.filter(t=>t.month===qMonths[i]).reduce((s,t)=>s+t.amount,0))})</span>
              </div>
            </div>)}
          </div>;
        })()}

        {/* 8. Средний чек по типам */}
        {(()=>{
          const types={'Old Delivery':'ОД','New Delivery':'НД'};
          const stats=Object.entries(types).map(([k,label])=>{
            const items=_firstTranches.filter(t=>t.projType===k);
            const cnt=items.length||1;const total=items.reduce((s,t)=>s+t.amount,0);
            return {label,count:items.length,avg:Math.round(total/cnt),total};
          });
          return <div className="dash-card" style={{padding:12}}>
            <div style={{fontSize:12,fontWeight:700,marginBottom:8,color:'var(--text1)'}}>💰 Средний чек (1-й транш)</div>
            {stats.map((s,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:i<stats.length-1?'1px solid var(--bg3)':'none'}}>
              <div><div style={{fontSize:11,fontWeight:600}}>{s.label}</div><div style={{fontSize:9,color:'var(--text2)'}}>{s.count} сделок</div></div>
              <div style={{textAlign:'right'}}><div style={{fontSize:13,fontWeight:700,color:'var(--accent)'}}>{fmt(s.avg)} ₽</div><div style={{fontSize:9,color:'var(--text2)'}}>всего: {fmt(s.total)}</div></div>
            </div>)}
          </div>;
        })()}

        {/* 9. РГ1 vs РГ2 — факт продаж */}
        {(()=>{
          const rg1=_firstTranches.filter(t=>t.wg==='РГ1').reduce((s,t)=>s+t.amount,0);
          const rg2=_firstTranches.filter(t=>t.wg==='РГ2').reduce((s,t)=>s+t.amount,0);
          const total=rg1+rg2||1;
          return <div className="dash-card" style={{padding:12}}>
            <div style={{fontSize:12,fontWeight:700,marginBottom:8,color:'var(--text1)'}}>⚡ РГ1 vs РГ2 (факт продаж)</div>
            <div style={{display:'flex',height:24,borderRadius:6,overflow:'hidden',marginBottom:6}}>
              <div style={{width:(rg1/total*100)+'%',background:'var(--accent)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:700,color:'#fff'}}>{rg1>0?Math.round(rg1/total*100)+'%':''}</div>
              <div style={{width:(rg2/total*100)+'%',background:'var(--violet)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:700,color:'#fff'}}>{rg2>0?Math.round(rg2/total*100)+'%':''}</div>
            </div>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:11}}>
              <span><b style={{color:'var(--accent)'}}>РГ1:</b> {fmt(Math.round(rg1))} ₽</span>
              <span><b style={{color:'var(--violet)'}}>РГ2:</b> {fmt(Math.round(rg2))} ₽</span>
            </div>
          </div>;
        })()}

        {/* 10. Допродажи — доля в общих продажах */}
        {(()=>{
          const upsellTotal=_firstTranches.filter(t=>t.is_upsell).reduce((s,t)=>s+t.amount,0);
          const newSales=_firstTranches.filter(t=>!t.is_upsell).reduce((s,t)=>s+t.amount,0);
          const total=upsellTotal+newSales||1;
          const pct=Math.round(upsellTotal/total*100);
          return <div className="dash-card" style={{padding:12}}>
            <div style={{fontSize:12,fontWeight:700,marginBottom:8,color:'var(--text1)'}}>🔁 Допродажи vs Новые</div>
            <div style={{display:'flex',alignItems:'center',gap:12}}>
              <div style={{position:'relative',width:70,height:70}}>
                <svg viewBox="0 0 36 36" style={{width:70,height:70}}>
                  <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--bg3)" strokeWidth="4"/>
                  <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--amber)" strokeWidth="4" strokeDasharray={pct+', 100'}/>
                </svg>
                <div style={{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%)',fontSize:14,fontWeight:700,color:'var(--amber)'}}>{pct}%</div>
              </div>
              <div>
                <div style={{fontSize:10,marginBottom:4}}><span style={{color:'var(--amber)',fontWeight:600}}>Допродажи:</span> {fmt(Math.round(upsellTotal))} ₽</div>
                <div style={{fontSize:10}}><span style={{color:'var(--accent)',fontWeight:600}}>Новые:</span> {fmt(Math.round(newSales))} ₽</div>
              </div>
            </div>
          </div>;
        })()}
      </div>

      </div>;
    })()}

    {salesTab==='crm'&&(()=>{
      const CRM_STAGES=[
        {id:'nakopan_6',label:'Накопан в 6-ке',color:'#e8eaf6'},
        {id:'nakopan_bm',label:'Накопан в БМ/ивент',color:'#e8eaf6'},
        {id:'mql_call',label:'MQL назначен созвон',color:'#e3f2fd'},
        {id:'sql_call',label:'SQL назначен созвон',color:'#e3f2fd'},
        {id:'sql_warmup',label:'SQL треб. прогрев',color:'#fff3e0'},
        {id:'writing_kp',label:'Пишем КП',color:'#fff8e1'},
        {id:'kp_sent',label:'КП выслано',color:'#fff8e1'},
        {id:'defense_discuss',label:'Защита обсужд.',color:'#fce4ec'},
        {id:'defense_set',label:'Защита поставлена',color:'#fce4ec'},
        {id:'push',label:'Дожим',color:'#f3e5f5'},
        {id:'send_materials',label:'Дослать материалы',color:'#e8eaf6'},
        {id:'come_back',label:'Вернуться позже',color:'#efebe9'},
        {id:'no_answer',label:'Нет ответа',color:'#efebe9'},
        {id:'verbal_yes',label:'Устное да',color:'#e8f5e9'},
        {id:'contract_done',label:'Договор сделан',color:'#e8f5e9'},
        {id:'invoices_sent',label:'Счета выставлены',color:'#e8f5e9'},
        {id:'won',label:'Выиграно',color:'#c8e6c9'},
        {id:'won_past',label:'Выигр. прошл. пер.',color:'#c8e6c9'},
        {id:'twww_call',label:'Созвон TWWW',color:'#e0f7fa'},
        {id:'lost',label:'Проиграно',color:'#ffcdd2'},
        {id:'refresh_won',label:'Refresh выиграно',color:'#dcedc8'},
        {id:'re_need',label:'Реингейдж: потребн.',color:'#f0f4c3'},
        {id:'re_kp',label:'Реингейдж: КП высл.',color:'#f0f4c3'},
        {id:'re_defense',label:'Реингейдж: защита',color:'#f0f4c3'},
        {id:'re_invoice',label:'Реингейдж: счёт',color:'#f0f4c3'},
        {id:'re_won',label:'Реингейдж: выигр.',color:'#dcedc8'},
        {id:'re_won_past',label:'Реинг. выигр. пр.п.',color:'#dcedc8'},
        {id:'re_lost',label:'Реингейдж: проигр.',color:'#ffcdd2'},
      ];
      /* 4 линии */
      const CRM_LINES=[
        {name:'Рич',accent:'#5c6bc0',stages:CRM_STAGES.slice(0,3)},
        {name:'Реакт',accent:'#ff9800',stages:CRM_STAGES.slice(3,16),stages2:CRM_STAGES.slice(16,19)},
        {name:'Рефреш',accent:'#f44336',stages:CRM_STAGES.slice(19,21)},
        {name:'Реингейдж',accent:'#8bc34a',stages:CRM_STAGES.slice(21,28)},
      ];
      const deals=(store.data.crm_deals||[]);
      const stageDeals=(sid)=>deals.filter(d=>d.stage===sid);
      const onDrop=(stageId,e)=>{e.preventDefault();if(crmDrag){store.updateCrmDeal(crmDrag,{stage:stageId});setCrmDrag(null);}};
      const clients=store.data.clients||[];
      const lineDealsCount=(line)=>{const ids=[...line.stages,...(line.stages2||[])].map(s=>s.id);return deals.filter(d=>ids.includes(d.stage));};
      const renderCol=(st)=>{
        const sd=stageDeals(st.id);
        const stTotal=sd.reduce((s,d)=>s+(Number(d.amount)||0),0);
        return <div key={st.id} style={{minWidth:155,flex:'0 0 155px',background:st.color,borderRadius:8,padding:7,display:'flex',flexDirection:'column'}}
          onDragOver={e=>e.preventDefault()} onDrop={e=>onDrop(st.id,e)}>
          <div style={{fontSize:9,fontWeight:700,marginBottom:3,color:'#333',textAlign:'center',lineHeight:1.2}}>{st.label}</div>
          <div style={{fontSize:8,color:'#666',textAlign:'center',marginBottom:5}}>{sd.length}{stTotal>0?' | '+fmt(stTotal):''}</div>
          <div style={{flex:1,display:'flex',flexDirection:'column',gap:3,minHeight:36}}>
            {sd.map(d=>{
              const cl=clients.find(c=>c.id===d.client_id);
              const prColor=d.priority==='Высокий'?'var(--red)':d.priority==='Средний'?'var(--amber)':'var(--accent)';
              const fmtD=(v)=>{if(!v)return'';const p=v.split('-');return p[2]+'.'+p[1];};
              const dates=[[d.date_kp_sent,'КП'],[d.date_kp_defense,'Защ'],[d.date_push,'Пуш'],[d.date_won,'Win']].filter(x=>x[0]);
              return <div key={d.id} draggable onDragStart={()=>setCrmDrag(d.id)} onDragEnd={()=>setCrmDrag(null)}
                style={{background:'#fff',borderRadius:5,padding:'5px 6px',cursor:'grab',boxShadow:'0 1px 2px rgba(0,0,0,.1)',borderLeft:'3px solid '+prColor,fontSize:9}}
                onClick={()=>setCrmEdit({...d})}>
                <div style={{fontWeight:600,color:'#333'}}>{d.name}</div>
                {cl&&<div style={{fontSize:8,color:'#888'}}>{cl.name}</div>}
                {(d.amount>0||d.first_payment>0)&&<div style={{fontSize:8,fontWeight:600,color:'var(--accent)',marginTop:1}}>{d.amount>0?fmt(Number(d.amount)):''}{d.first_payment>0?' / '+fmt(Number(d.first_payment))+' 1оп':''}</div>}
                {(d.request_type||d.responsible)&&<div style={{fontSize:7,color:'#999',marginTop:1}}>{d.request_type?d.request_type.replace('Продажи ',''):''}{d.request_type&&d.responsible?' • ':''}{d.responsible||''}</div>}
                {dates.length>0&&<div style={{fontSize:7,color:'#888',marginTop:1}}>{'📅 '}{dates.map(x=>x[1]+':'+fmtD(x[0])).join(' → ')}</div>}
              </div>;
            })}
          </div>
        </div>;
      };
      return <div>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
          <span style={{fontSize:13,color:'var(--text2)'}}>Всего сделок: <b>{deals.length}</b> | Сумма: <b>{fmt(deals.reduce((s,d)=>s+(Number(d.amount)||0),0))}</b> ₽</span>
          <button className="btn btn-primary btn-sm" onClick={()=>setCrmNew({name:'',client_id:'',amount:'',first_payment:'',stage:CRM_STAGES[0].id,notes:'',responsible:'',priority:'',request_type:'',contact_person:'',contact_email:'',contact_phone:'',chat_link:'',source:'',date_first_call:'',date_kp_sent:'',date_kp_defense:'',date_push:'',date_won:''})}>+ Сделка</button>
        </div>
        {CRM_LINES.map((line,li)=>{
          const ld=lineDealsCount(line);
          const ldTotal=ld.reduce((s,d)=>s+(Number(d.amount)||0),0);
          return <div key={li} style={{marginBottom:14}}>
            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
              <div style={{background:line.accent,color:'#fff',fontSize:11,fontWeight:700,padding:'2px 10px',borderRadius:12}}>{line.name}</div>
              <span style={{fontSize:10,color:'var(--text2)'}}>{ld.length} сделок{ldTotal>0?' | '+fmt(ldTotal)+' ₽':''}</span>
            </div>
            <div style={{overflowX:'auto',display:'flex',gap:6,paddingBottom:4}}>
              {line.stages.map(st=>renderCol(st))}
            </div>
            {line.stages2&&line.stages2.length>0&&<div style={{overflowX:'auto',display:'flex',gap:6,paddingBottom:4,marginTop:6}}>
              {line.stages2.map(st=>renderCol(st))}
            </div>}
          </div>;
        })}
        {/* New deal modal */}
        {crmNew&&<Modal onClose={()=>setCrmNew(null)}><div style={{maxHeight:'80vh',overflowY:'auto',padding:'0 2px'}}><h3 style={{marginTop:0}}>Новая сделка</h3>
          <div className="form-group"><label>Название</label><input value={crmNew.name} onChange={e=>setCrmNew(p=>({...p,name:e.target.value}))}/></div>
          <div className="form-row"><div className="form-group"><label>Клиент</label><select value={crmNew.client_id} onChange={e=>setCrmNew(p=>({...p,client_id:e.target.value}))}><option value="">—</option>{clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
          <div className="form-group"><label>Этап</label><select value={crmNew.stage} onChange={e=>setCrmNew(p=>({...p,stage:e.target.value}))}>{CRM_STAGES.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select></div>
          <div className="form-group"><label>Приоритет</label><select value={crmNew.priority||''} onChange={e=>setCrmNew(p=>({...p,priority:e.target.value}))}><option value="">—</option><option>Высокий</option><option>Средний</option><option>Низкий</option></select></div></div>
          <div style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginTop:10,marginBottom:4}}>Финансы</div>
          <div className="form-row"><div className="form-group"><label>Контракт (₽)</label><input type="number" value={crmNew.amount} onChange={e=>setCrmNew(p=>({...p,amount:e.target.value}))}/></div>
          <div className="form-group"><label>1-я оплата (₽)</label><input type="number" value={crmNew.first_payment||''} onChange={e=>setCrmNew(p=>({...p,first_payment:e.target.value}))}/></div></div>
          <div style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginTop:10,marginBottom:4}}>Контакты</div>
          <div className="form-row"><div className="form-group"><label>Контактное лицо</label><input value={crmNew.contact_person||''} onChange={e=>setCrmNew(p=>({...p,contact_person:e.target.value}))}/></div>
          <div className="form-group"><label>Email</label><input value={crmNew.contact_email||''} onChange={e=>setCrmNew(p=>({...p,contact_email:e.target.value}))}/></div></div>
          <div className="form-row"><div className="form-group"><label>Телефон</label><input value={crmNew.contact_phone||''} onChange={e=>setCrmNew(p=>({...p,contact_phone:e.target.value}))}/></div>
          <div className="form-group"><label>Чат (Telegram)</label><input value={crmNew.chat_link||''} onChange={e=>setCrmNew(p=>({...p,chat_link:e.target.value}))}/></div></div>
          <div style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginTop:10,marginBottom:4}}>Даты</div>
          <div className="form-row"><div className="form-group"><label>1 созвон</label><input type="date" value={crmNew.date_first_call||''} onChange={e=>setCrmNew(p=>({...p,date_first_call:e.target.value}))}/></div>
          <div className="form-group"><label>КП отправлено</label><input type="date" value={crmNew.date_kp_sent||''} onChange={e=>setCrmNew(p=>({...p,date_kp_sent:e.target.value}))}/></div>
          <div className="form-group"><label>Защита КП</label><input type="date" value={crmNew.date_kp_defense||''} onChange={e=>setCrmNew(p=>({...p,date_kp_defense:e.target.value}))}/></div></div>
          <div className="form-row"><div className="form-group"><label>Пуш</label><input type="date" value={crmNew.date_push||''} onChange={e=>setCrmNew(p=>({...p,date_push:e.target.value}))}/></div>
          <div className="form-group"><label>Дата выигрыша</label><input type="date" value={crmNew.date_won||''} onChange={e=>setCrmNew(p=>({...p,date_won:e.target.value}))}/></div></div>
          <div style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginTop:10,marginBottom:4}}>Прочее</div>
          <div className="form-row"><div className="form-group"><label>Тип запроса</label><select value={crmNew.request_type||''} onChange={e=>setCrmNew(p=>({...p,request_type:e.target.value}))}><option value="">—</option><option>Продажи основных</option><option>Продажи сессий</option><option>Продажи корп. обучений</option><option>Допродажи</option><option>Продажи абонентки</option></select></div>
          <div className="form-group"><label>Ответственный</label><input value={crmNew.responsible||''} onChange={e=>setCrmNew(p=>({...p,responsible:e.target.value}))}/></div></div>
          <div className="form-group"><label>Источник</label><input value={crmNew.source||''} onChange={e=>setCrmNew(p=>({...p,source:e.target.value}))}/></div>
          <div className="form-group"><label>Заметки</label><textarea rows={2} value={crmNew.notes||''} onChange={e=>setCrmNew(p=>({...p,notes:e.target.value}))}/></div>
          <button className="btn btn-primary" onClick={()=>{if(!crmNew.name)return;store.addCrmDeal({name:crmNew.name,client_id:crmNew.client_id,amount:Number(crmNew.amount)||0,first_payment:Number(crmNew.first_payment)||0,stage:crmNew.stage,request_type:crmNew.request_type||'',priority:crmNew.priority||'',notes:crmNew.notes||'',responsible:crmNew.responsible||'',contact_person:crmNew.contact_person||'',contact_email:crmNew.contact_email||'',contact_phone:crmNew.contact_phone||'',chat_link:crmNew.chat_link||'',source:crmNew.source||'',date_first_call:crmNew.date_first_call||'',date_kp_sent:crmNew.date_kp_sent||'',date_kp_defense:crmNew.date_kp_defense||'',date_push:crmNew.date_push||'',date_won:crmNew.date_won||''});setCrmNew(null);}}>Создать</button>
        </div></Modal>}
        {/* Edit deal modal */}
        {crmEdit&&<Modal onClose={()=>setCrmEdit(null)}><div style={{maxHeight:'80vh',overflowY:'auto',padding:'0 2px'}}><h3 style={{marginTop:0}}>Редактировать сделку</h3>
          <div className="form-group"><label>Название</label><input value={crmEdit.name} onChange={e=>setCrmEdit(p=>({...p,name:e.target.value}))}/></div>
          <div className="form-row"><div className="form-group"><label>Клиент</label><select value={crmEdit.client_id||''} onChange={e=>setCrmEdit(p=>({...p,client_id:e.target.value}))}><option value="">—</option>{clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
          <div className="form-group"><label>Этап</label><select value={crmEdit.stage} onChange={e=>setCrmEdit(p=>({...p,stage:e.target.value}))}>{CRM_STAGES.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select></div>
          <div className="form-group"><label>Приоритет</label><select value={crmEdit.priority||''} onChange={e=>setCrmEdit(p=>({...p,priority:e.target.value}))}><option value="">—</option><option>Высокий</option><option>Средний</option><option>Низкий</option></select></div></div>
          <div style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginTop:10,marginBottom:4}}>Финансы</div>
          <div className="form-row"><div className="form-group"><label>Контракт (₽)</label><input type="number" value={crmEdit.amount} onChange={e=>setCrmEdit(p=>({...p,amount:e.target.value}))}/></div>
          <div className="form-group"><label>1-я оплата (₽)</label><input type="number" value={crmEdit.first_payment||''} onChange={e=>setCrmEdit(p=>({...p,first_payment:e.target.value}))}/></div></div>
          <div style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginTop:10,marginBottom:4}}>Контакты</div>
          <div className="form-row"><div className="form-group"><label>Контактное лицо</label><input value={crmEdit.contact_person||''} onChange={e=>setCrmEdit(p=>({...p,contact_person:e.target.value}))}/></div>
          <div className="form-group"><label>Email</label><input value={crmEdit.contact_email||''} onChange={e=>setCrmEdit(p=>({...p,contact_email:e.target.value}))}/></div></div>
          <div className="form-row"><div className="form-group"><label>Телефон</label><input value={crmEdit.contact_phone||''} onChange={e=>setCrmEdit(p=>({...p,contact_phone:e.target.value}))}/></div>
          <div className="form-group"><label>Чат (Telegram)</label><input value={crmEdit.chat_link||''} onChange={e=>setCrmEdit(p=>({...p,chat_link:e.target.value}))}/></div></div>
          <div style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginTop:10,marginBottom:4}}>Даты</div>
          <div className="form-row"><div className="form-group"><label>1 созвон</label><input type="date" value={crmEdit.date_first_call||''} onChange={e=>setCrmEdit(p=>({...p,date_first_call:e.target.value}))}/></div>
          <div className="form-group"><label>КП отправлено</label><input type="date" value={crmEdit.date_kp_sent||''} onChange={e=>setCrmEdit(p=>({...p,date_kp_sent:e.target.value}))}/></div>
          <div className="form-group"><label>Защита КП</label><input type="date" value={crmEdit.date_kp_defense||''} onChange={e=>setCrmEdit(p=>({...p,date_kp_defense:e.target.value}))}/></div></div>
          <div className="form-row"><div className="form-group"><label>Пуш</label><input type="date" value={crmEdit.date_push||''} onChange={e=>setCrmEdit(p=>({...p,date_push:e.target.value}))}/></div>
          <div className="form-group"><label>Дата выигрыша</label><input type="date" value={crmEdit.date_won||''} onChange={e=>setCrmEdit(p=>({...p,date_won:e.target.value}))}/></div></div>
          <div style={{fontSize:11,fontWeight:600,color:'var(--text2)',marginTop:10,marginBottom:4}}>Прочее</div>
          <div className="form-row"><div className="form-group"><label>Тип запроса</label><select value={crmEdit.request_type||''} onChange={e=>setCrmEdit(p=>({...p,request_type:e.target.value}))}><option value="">—</option><option>Продажи основных</option><option>Продажи сессий</option><option>Продажи корп. обучений</option><option>Допродажи</option><option>Продажи абонентки</option></select></div>
          <div className="form-group"><label>Ответственный</label><input value={crmEdit.responsible||''} onChange={e=>setCrmEdit(p=>({...p,responsible:e.target.value}))}/></div></div>
          <div className="form-group"><label>Источник</label><input value={crmEdit.source||''} onChange={e=>setCrmEdit(p=>({...p,source:e.target.value}))}/></div>
          <div className="form-group"><label>Заметки</label><textarea rows={2} value={crmEdit.notes||''} onChange={e=>setCrmEdit(p=>({...p,notes:e.target.value}))}/></div>
          <div style={{display:'flex',gap:8}}>
            <button className="btn btn-primary" onClick={()=>{store.updateCrmDeal(crmEdit.id,{name:crmEdit.name,client_id:crmEdit.client_id||'',amount:Number(crmEdit.amount)||0,first_payment:Number(crmEdit.first_payment)||0,stage:crmEdit.stage,request_type:crmEdit.request_type||'',priority:crmEdit.priority||'',notes:crmEdit.notes||'',responsible:crmEdit.responsible||'',contact_person:crmEdit.contact_person||'',contact_email:crmEdit.contact_email||'',contact_phone:crmEdit.contact_phone||'',chat_link:crmEdit.chat_link||'',source:crmEdit.source||'',date_first_call:crmEdit.date_first_call||'',date_kp_sent:crmEdit.date_kp_sent||'',date_kp_defense:crmEdit.date_kp_defense||'',date_push:crmEdit.date_push||'',date_won:crmEdit.date_won||''});setCrmEdit(null);}}>Сохранить</button>
            <button className="btn btn-sm" style={{background:'var(--red)',color:'#fff'}} onClick={()=>{if(confirm('Удалить сделку?')){store.deleteCrmDeal(crmEdit.id);setCrmEdit(null);}}}>Удалить</button>
          </div>
        </div></Modal>}
      </div>;
    })()}

    {salesTab==='import'&&<div className="card" style={{padding:16}}>
      <h3 style={{marginTop:0}}>Импорт проектов B2C (РГ2)</h3>
      <p style={{color:'var(--text2)',fontSize:12}}>Загрузит 40 проектов из таблицы B2C. Существующие проекты будут сопоставлены по названию. Недостающие будут созданы с плановыми поступлениями.</p>
      <button className="btn btn-primary" onClick={()=>importB2CProjects()}>Запустить импорт</button>
    </div>}
    {/* B2C tab removed */}

    {salesTab==='notion_verify'&&(()=>{
      const staging=(store.data.notion_crm_staging||[]);
      const NOTION_STAGES=['','Накопан в академии','Накопан в клубе','Накопан у Бодрейшего','Накопан в ABM','Накопан на ивенте или партнером','MQL назначен созвон','SQL назначен созвон','SQL требуется прогрев','Пишем КП','КП выслано','Защита обсуждается','Защита поставлена','Дожим','Дослать материалы','Вернуться позже','Нет ответа','Устное Да','Договор сделан','Счета выставлены','Выиграно','Прошел созвон по TWWW','Выиграно в прошл. периоды','Проиграно RFR','RFR Выслана матрица','RFR Матрица презентована','RFR Выиграно','RNG Написать кейс','RNG Выявлена потребность','RNG КП выслано','RNG Защита проведена','RNG Проиграно','RNG Выиграно','RNG Кейс написан','RNG Выиграно в прош. периоды','RNG Счета выставлены'];
      const REQ_TYPES=['','Продажи основных','Продажи сессий','Продажи корп. обучений','Допродажи','Продажи абонентки'];
      const PRIORITIES=['','Высокий','Средний','Низкий'];
      /* const [nvFilter,setNvFilter] hoisted to top */
      /* const [nvStageFilter,setNvStageFilter] hoisted to top */
      /* const [nvSelected,setNvSelected] hoisted to top */
      /* const [nvEditId,setNvEditId] hoisted to top */
      /* const [nvSort,setNvSort] hoisted to top */
      const filtered=staging.filter(d=>{
        if(nvFilter&&!d.name.toLowerCase().includes(nvFilter.toLowerCase()))return false;
        if(nvStageFilter==='filled')return d.notion_stage;
        if(nvStageFilter==='empty')return !d.notion_stage;
        if(nvStageFilter!=='all')return d.notion_stage===nvStageFilter;
        return true;
      }).sort((a,b)=>{
        if(nvSort==='name')return(a.name||'').localeCompare(b.name||'');
        if(nvSort==='contract')return(Number(b.contract)||0)-(Number(a.contract)||0);
        if(nvSort==='stage')return(a.notion_stage||'').localeCompare(b.notion_stage||'');
        return 0;
      });
      const totalContract=filtered.reduce((s,d)=>s+(Number(d.contract)||0),0);
      const toggleAll=()=>{if(nvSelected.size===filtered.length){setNvSelected(new Set());}else{setNvSelected(new Set(filtered.map(d=>d.id)));}};
      const toggleOne=(id)=>{const s=new Set(nvSelected);if(s.has(id))s.delete(id);else s.add(id);setNvSelected(s);};
      const stageColor=(st)=>{if(!st)return 'var(--text2)';if(st.includes('Выиграно')||st.includes('RNG Выиграно'))return'var(--green)';if(st.includes('Проиграно')||st==='RNG Проиграно')return'var(--red)';if(st.includes('Дожим')||st.includes('Дослать'))return'var(--amber)';if(st.includes('КП'))return'var(--sky)';if(st.includes('SQL')||st.includes('MQL'))return'var(--violet)';if(st.includes('Накопан'))return'var(--text2)';return'var(--text)';};
      return <div>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10,flexWrap:'wrap',gap:8}}>
          <div>
            <span style={{fontSize:14,fontWeight:700}}>📋 Проверка сделок из Notion CRM</span>
            <span style={{fontSize:11,color:'var(--text2)',marginLeft:8}}>Всего: {staging.length} | Показано: {filtered.length} | Сумма: {fmt(totalContract)} ₽</span>
          </div>
          <div style={{display:'flex',gap:6,alignItems:'center'}}>
            {nvSelected.size>0&&<button className="btn btn-primary btn-sm" onClick={()=>{if(confirm('Перенести '+nvSelected.size+' сделок в CRM осн.?')){store.transferStagingToCrm([...nvSelected]);setNvSelected(new Set());}}}>Перенести {nvSelected.size} в CRM →</button>}
            {nvSelected.size>0&&<button className="btn btn-sm" style={{background:'var(--red)',color:'#fff'}} onClick={()=>{if(confirm('Удалить '+nvSelected.size+' записей?')){[...nvSelected].forEach(id=>store.deleteStagingDeal(id));setNvSelected(new Set());}}}>Удалить {nvSelected.size}</button>}
            <button className="btn btn-sm" onClick={()=>{const name=prompt('Название сделки:');if(name)store.addStagingDeal({name,contract:0,first_payment:0,notion_stage:'',request_type:'',priority:'',responsible:'',comment:''});}}>+ Добавить</button>
          </div>
        </div>
        <div style={{display:'flex',gap:8,marginBottom:10,flexWrap:'wrap',alignItems:'center'}}>
          <input placeholder="Поиск по названию..." value={nvFilter} onChange={e=>setNvFilter(e.target.value)} style={{width:200,fontSize:11,padding:'4px 8px'}}/>
          <select value={nvStageFilter} onChange={e=>setNvStageFilter(e.target.value)} style={{fontSize:11,padding:'4px 6px'}}>
            <option value="all">Все этапы</option>
            <option value="filled">С этапом</option>
            <option value="empty">Без этапа</option>
            {NOTION_STAGES.filter(Boolean).map(s=><option key={s} value={s}>{s}</option>)}
          </select>
          <select value={nvSort} onChange={e=>setNvSort(e.target.value)} style={{fontSize:11,padding:'4px 6px'}}>
            <option value="name">По названию</option>
            <option value="contract">По сумме ↓</option>
            <option value="stage">По этапу</option>
          </select>
        </div>
        <div className="card" style={{padding:0,overflowX:'auto'}}>
          <table style={{width:'100%',fontSize:11,borderCollapse:'collapse'}}>
            <thead><tr style={{background:'var(--bg1)',borderBottom:'2px solid var(--border)'}}>
              <th style={{width:28,padding:'6px 4px'}}><input type="checkbox" checked={nvSelected.size===filtered.length&&filtered.length>0} onChange={toggleAll}/></th>
              <th style={{padding:'6px 8px',textAlign:'left',minWidth:180,cursor:'pointer'}} onClick={()=>setNvSort('name')}>Название {nvSort==='name'?'▲':''}</th>
              <th style={{padding:'6px 8px',textAlign:'left',minWidth:140}}>Этап Notion</th>
              <th style={{padding:'6px 8px',textAlign:'right',minWidth:100,cursor:'pointer'}} onClick={()=>setNvSort('contract')}>Контракт {nvSort==='contract'?'▼':''}</th>
              <th style={{padding:'6px 8px',textAlign:'right',minWidth:80}}>1 оплата</th>
              <th style={{padding:'6px 8px',textAlign:'left',minWidth:120}}>Тип</th>
              <th style={{padding:'6px 8px',textAlign:'left',minWidth:80}}>Приоритет</th>
              <th style={{padding:'6px 8px',textAlign:'left',minWidth:120}}>Ответственный</th>
              <th style={{padding:'6px 8px',textAlign:'left',minWidth:100}}>Комментарий</th>
              <th style={{width:60,padding:'6px 4px'}}>Действия</th>
            </tr></thead>
            <tbody>
              {filtered.map((d,i)=>{
                const isEditing=nvEditId===d.id;
                if(isEditing)return <tr key={d.id} style={{background:'rgba(99,102,241,.06)'}}>
                  <td style={{padding:'4px'}}><input type="checkbox" checked={nvSelected.has(d.id)} onChange={()=>toggleOne(d.id)}/></td>
                  <td style={{padding:'2px 4px'}}><input value={d.name} onChange={e=>store.updateStagingDeal(d.id,{name:e.target.value})} style={{width:'100%',fontSize:11,fontWeight:600}}/></td>
                  <td style={{padding:'2px 4px'}}><select value={d.notion_stage||''} onChange={e=>store.updateStagingDeal(d.id,{notion_stage:e.target.value})} style={{fontSize:10,width:'100%'}}>{NOTION_STAGES.map(s=><option key={s} value={s}>{s||'— не указан —'}</option>)}</select></td>
                  <td style={{padding:'2px 4px'}}><input type="number" value={d.contract||''} onChange={e=>store.updateStagingDeal(d.id,{contract:Number(e.target.value)||0})} style={{width:'100%',fontSize:11,textAlign:'right'}}/></td>
                  <td style={{padding:'2px 4px'}}><input type="number" value={d.first_payment||''} onChange={e=>store.updateStagingDeal(d.id,{first_payment:Number(e.target.value)||0})} style={{width:'100%',fontSize:11,textAlign:'right'}}/></td>
                  <td style={{padding:'2px 4px'}}><select value={d.request_type||''} onChange={e=>store.updateStagingDeal(d.id,{request_type:e.target.value})} style={{fontSize:10,width:'100%'}}>{REQ_TYPES.map(s=><option key={s} value={s}>{s||'—'}</option>)}</select></td>
                  <td style={{padding:'2px 4px'}}><select value={d.priority||''} onChange={e=>store.updateStagingDeal(d.id,{priority:e.target.value})} style={{fontSize:10,width:'100%'}}>{PRIORITIES.map(s=><option key={s} value={s}>{s||'—'}</option>)}</select></td>
                  <td style={{padding:'2px 4px'}}><input value={d.responsible||''} onChange={e=>store.updateStagingDeal(d.id,{responsible:e.target.value})} style={{width:'100%',fontSize:11}}/></td>
                  <td style={{padding:'2px 4px'}}><input value={d.comment||''} onChange={e=>store.updateStagingDeal(d.id,{comment:e.target.value})} style={{width:'100%',fontSize:11}}/></td>
                  <td style={{padding:'2px 4px',textAlign:'center'}}><span onClick={()=>setNvEditId(null)} style={{cursor:'pointer',fontSize:14,color:'var(--green)'}}>✓</span></td>
                </tr>;
                return <tr key={d.id} style={{borderBottom:'1px solid var(--bg2)',background:i%2===0?'':'var(--bg1)',opacity:!d.notion_stage?.7:1}}>
                  <td style={{padding:'5px 4px',textAlign:'center'}}><input type="checkbox" checked={nvSelected.has(d.id)} onChange={()=>toggleOne(d.id)}/></td>
                  <td style={{padding:'5px 8px',fontWeight:600}}>{d.name}</td>
                  <td style={{padding:'5px 8px'}}><span style={{fontSize:10,color:stageColor(d.notion_stage),fontWeight:d.notion_stage?600:400}}>{d.notion_stage||'—'}</span></td>
                  <td style={{padding:'5px 8px',textAlign:'right',fontWeight:600,color:d.contract>0?'var(--accent)':'var(--text2)'}}>{d.contract>0?fmt(d.contract):''}</td>
                  <td style={{padding:'5px 8px',textAlign:'right',color:'var(--text2)'}}>{d.first_payment>0?fmt(d.first_payment):''}</td>
                  <td style={{padding:'5px 8px',fontSize:10,color:'var(--text2)'}}>{d.request_type||''}</td>
                  <td style={{padding:'5px 8px',fontSize:10}}><span style={{color:d.priority==='Высокий'?'var(--red)':d.priority==='Средний'?'var(--amber)':'var(--text2)'}}>{d.priority||''}</span></td>
                  <td style={{padding:'5px 8px',fontSize:10,color:'var(--text2)'}}>{d.responsible||''}</td>
                  <td style={{padding:'5px 8px',fontSize:10,color:'var(--text2)'}}>{d.comment||''}</td>
                  <td style={{padding:'3px 4px',textAlign:'center'}}>
                    <span onClick={()=>setNvEditId(d.id)} style={{cursor:'pointer',fontSize:12,marginRight:4}} title="Редактировать">✏️</span>
                    <span onClick={()=>{if(confirm('Удалить «'+d.name+'»?'))store.deleteStagingDeal(d.id);}} style={{cursor:'pointer',fontSize:12,color:'var(--red)'}} title="Удалить">✕</span>
                  </td>
                </tr>;
              })}
              {filtered.length===0&&<tr><td colSpan={10} style={{textAlign:'center',padding:20,color:'var(--text2)'}}>Нет записей{staging.length>0?' (попробуйте сбросить фильтры)':''}</td></tr>}
            </tbody>
          </table>
        </div>
        <div style={{marginTop:12,padding:10,background:'var(--bg1)',borderRadius:8,fontSize:11,color:'var(--text2)'}}>
          <b>Как пользоваться:</b> Просмотрите сделки из Notion. Отредактируйте (✏️) или удалите (✕) неактуальные. Заполните пустые поля. Затем выберите галочками нужные и нажмите «Перенести в CRM →» — они появятся в канбане CRM осн.
        </div>
      </div>;
    })()}
    {salesTab==='overview'&&<React.Fragment>

    <div className="kpi-row">
      <div className="kpi-card"><div className="kpi-label">Клиентов</div><div className="kpi-value accent-c">{clients.length}</div></div>
      <div className="kpi-card"><div className="kpi-label">В воронке</div><div className="kpi-value yellow-c">{draftProj.length}</div><div className="kpi-sub">Черновики</div></div>
      <div className="kpi-card"><div className="kpi-label">Активных</div><div className="kpi-value green-c">{activeProj.length}</div></div>
      <div className="kpi-card"><div className="kpi-label">Завершено</div><div className="kpi-value" style={{color:'var(--emerald)'}}>{completedProj.length}</div></div>
      <div className="kpi-card"><div className="kpi-label">Команда ПиМ</div><div className="kpi-value accent-c">{persons.length}</div></div>
    </div>

    <div className="dash-grid-2 dash-section">
      <div className="dash-card">
        <div className="dc-title">Клиенты</div>
        {clientStats.length===0?<div className="empty">Нет клиентов</div>:
        <table style={{width:'100%',fontSize:11}}><thead><tr><th style={{textAlign:'left'}}>Клиент</th><th>Проекты</th><th>Активн.</th><th style={{textAlign:'right'}}>Выручка</th></tr></thead>
        <tbody>{clientStats.slice(0,15).map(cl=><tr key={cl.id}>
          <td style={{fontWeight:600}}>{cl.name}</td>
          <td style={{textAlign:'center'}}>{cl.projCount}</td>
          <td style={{textAlign:'center',color:'var(--green)'}}>{cl.activeCount}</td>
          <td style={{textAlign:'right'}}>{fmt(cl.totalRev)} ₽</td>
        </tr>)}</tbody></table>}
      </div>
      <div className="dash-card">
        <div className="dc-title">Команда отдела</div>
        {persons.length===0?<div className="empty">Нет сотрудников в отделе</div>:
        <div style={{display:'grid',gap:6}}>
          {SALES_SECTIONS.map(sec=>{
            const secPersons=persons.filter(p=>p.sales_section===sec);
            return <div key={sec} style={{padding:'6px 10px',background:'var(--bg1)',borderRadius:6}}>
              <div style={{fontSize:11,fontWeight:600,marginBottom:2}}>{sec}</div>
              {secPersons.length===0?<div style={{fontSize:10,color:'var(--text2)'}}>—</div>:
              <div style={{display:'flex',flexWrap:'wrap',gap:4}}>{secPersons.map(p=><span key={p.id} style={{fontSize:10,padding:'1px 6px',background:'var(--bg2)',borderRadius:4}}>{p.name}</span>)}</div>}
            </div>;
          })}
        </div>}
      </div>
    </div>
  </React.Fragment>}
  {editRgPerson&&<EditPersonModal person={editRgPerson} store={store} onClose={()=>setEditRgPerson(null)}/>}
  {rgPopup&&<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,zIndex:998}} onClick={()=>setRgPopup(null)}/>}
  {rgPopup&&<div style={{position:'fixed',left:Math.min(rgPopup.x,window.innerWidth-280),top:rgPopup.y,zIndex:999,background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:8,boxShadow:'0 4px 16px rgba(0,0,0,.25)',padding:'8px 0',minWidth:220,maxWidth:320,maxHeight:300,overflowY:'auto'}}>
    {rgPopup.items.map((it,idx)=><div key={idx} style={{padding:'4px 12px',display:'flex',justifyContent:'space-between',alignItems:'center',gap:8,fontSize:11,cursor:it.isPerson?'default':'pointer',borderBottom:idx<rgPopup.items.length-1?'1px solid var(--bg2)':''}} onClick={()=>{if(!it.isPerson&&goProject){setRgPopup(null);goProject(it.id);}}} onMouseOver={e=>{if(!it.isPerson)e.currentTarget.style.background='var(--bg2)';}} onMouseOut={e=>{e.currentTarget.style.background='transparent';}}>
      <div style={{flex:1,minWidth:0}}>
        {it.code&&<span style={{fontWeight:700,color:'var(--accent2)',marginRight:4}}>{it.code}</span>}
        <span style={{color:it.isPerson?'var(--text2)':'var(--text1)'}}>{it.name}</span>
      </div>
      <span style={{fontWeight:600,whiteSpace:'nowrap'}}>{fmt(Math.round(it.amount))} ₽</span>
    </div>)}
  </div>}
  </div>;
}

/* ===== Overhead Request Form (separate component to avoid hooks-in-render) ===== */
function OhRequestFormModal({store,chatData,onClose}){
  const CAT_OPTS2=['Подрядчики','IT решения','Промо','АХО','Логистика','Зарплата ФК','Найм','Авансированная прибыль','Прочее'];
  const CLS_OPTS2=['поддержка сайта','софт','билеты','для офиса','оборудование','дизайн','копирайтинг','монтаж','обработка данных','программирование','аналитика','найм','медиапартнерства','опросы','сбор данных','аренда помещения','прочее'];
  const RG_OPTS2=['РГ1','РГ2','ФК','КБ','АХО','HR','НД','PP','РГ6'];
  const FMT_OPTS2=['счет','нал','карта ИП'];
  const CF_OPTS2=['OCF','AHO','OFFICE','ICF'];
  const [f,setF]=useState({date:new Date().toISOString().slice(0,10),amount:'',rg:'КБ',category:'Прочее',cls:'прочее',format:'счет',responsible:chatData.currentUser.name||'',comment:'',scope:'company',project_id:'',cf_type:'OCF',prior_year:false});
  const upd=(k,v)=>setF(p=>({...p,[k]:v}));
  const projList=(store.data.projects||[]).filter(p=>p.status==='ACTIVE');
  const submit=()=>{
    if(!f.amount||!f.category){alert('Укажите сумму и категорию');return;}
    const users=store.data.users||[];
    const approvers=users.filter(u=>u.is_active&&_isFinanceOrPartner(u)&&u.id!==chatData.currentUser.id);
    const mentions=approvers.map(u=>'@'+u.login);
    const mentionText=mentions.length>0?' '+mentions.join(' '):'';
    /* Create registry entry immediately with oh_status=PENDING */
    const regId=crypto.randomUUID?crypto.randomUUID():(Math.random().toString(36).slice(2)+Date.now().toString(36));
    const amt=Number(f.amount);
    store.addChatMessage({channel_id:'cashflow',cashflow_tab:'overhead_request',text:'📋 **Заявка на накладную**\nСумма: '+amt.toLocaleString('ru')+' ₽ | РГ: '+f.rg+' | '+f.category+' | '+f.cls+'\nОтветственный: '+f.responsible+'\n'+(f.comment||'')+mentionText,overhead_request:{...f,amount:amt,status:'PENDING',created_by:chatData.currentUser.name,created_at:new Date().toISOString(),reg_id:regId}});
    /* Add to overhead_registry as PENDING */
    store.addOhRegistryItem({id:regId,date:f.date,amount:amt,rg:f.rg,category:f.category,cls:f.cls,format:f.format,responsible:f.responsible,comment:f.comment,project_id:f.project_id||null,scope:f.scope||(f.project_id?'project':'company'),cf_type:f.cf_type||'OCF',source:'chat',prior_year:f.prior_year||false,oh_status:'PENDING',oh_created_by:chatData.currentUser.name});
    onClose();
  };
  const _fld={width:'100%',background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:6,padding:'5px 8px',color:'var(--text)',fontSize:12,boxSizing:'border-box'};
  const _lbl={fontSize:10,color:'var(--text2)',display:'block',marginBottom:2};
  return <Modal onClose={onClose}>
    <h3 style={{marginBottom:12}}>📋 Заявка на накладную</h3>
    <div style={{display:'flex',flexDirection:'column',gap:8,maxHeight:'60vh',overflowY:'auto'}}>
      <div style={{display:'flex',gap:8}}>
        <div style={{flex:1}}><label style={_lbl}>Дата</label><input type="date" value={f.date} onChange={e=>upd('date',e.target.value)} style={_fld}/></div>
        <div style={{flex:1}}><label style={_lbl}>Сумма ₽</label><input type="number" value={f.amount} onChange={e=>upd('amount',e.target.value)} style={_fld} placeholder="0"/></div>
      </div>
      <div style={{display:'flex',gap:8}}>
        <div style={{flex:1}}><label style={_lbl}>РГ</label><select value={f.rg} onChange={e=>upd('rg',e.target.value)} style={_fld}>{RG_OPTS2.map(o=><option key={o}>{o}</option>)}</select></div>
        <div style={{flex:1}}><label style={_lbl}>Категория</label><select value={f.category} onChange={e=>upd('category',e.target.value)} style={_fld}>{CAT_OPTS2.map(o=><option key={o}>{o}</option>)}</select></div>
        <div style={{flex:1}}><label style={_lbl}>Класс</label><select value={f.cls} onChange={e=>upd('cls',e.target.value)} style={_fld}>{CLS_OPTS2.map(o=><option key={o}>{o}</option>)}</select></div>
      </div>
      <div style={{display:'flex',gap:8}}>
        <div style={{flex:1}}><label style={_lbl}>Формат</label><select value={f.format} onChange={e=>upd('format',e.target.value)} style={_fld}>{FMT_OPTS2.map(o=><option key={o}>{o}</option>)}</select></div>
        <div style={{flex:1}}><label style={_lbl}>Ответственный</label><input value={f.responsible} onChange={e=>upd('responsible',e.target.value)} style={_fld}/></div>
      </div>
      <div style={{display:'flex',gap:8}}>
        <div style={{flex:1}}><label style={_lbl}>Уровень</label><select value={f.scope} onChange={e=>upd('scope',e.target.value)} style={_fld}><option value="company">Общефирм.</option><option value="project">Проект</option></select></div>
        {f.scope==='project'?<div style={{flex:2}}><label style={_lbl}>Проект</label><select value={f.project_id} onChange={e=>upd('project_id',e.target.value)} style={_fld}><option value="">-- выберите --</option>{projList.map(p=><option key={p.id} value={p.id}>{p.code||p.name}</option>)}</select></div>
        :<div style={{flex:2}}><label style={_lbl}>Тип CF</label><select value={f.cf_type} onChange={e=>upd('cf_type',e.target.value)} style={_fld}>{CF_OPTS2.map(o=><option key={o}>{o}</option>)}</select></div>}
      </div>
      <div><label style={_lbl}>Комментарий</label><textarea value={f.comment} onChange={e=>upd('comment',e.target.value)} style={{..._fld,minHeight:50,resize:'vertical'}} placeholder="Описание расхода..."/></div>
      <label style={{fontSize:11,color:'var(--text2)',display:'flex',alignItems:'center',gap:6}}><input type="checkbox" checked={f.prior_year} onChange={e=>upd('prior_year',e.target.checked)}/> Расход прошлого года</label>
      <div style={{display:'flex',gap:8,justifyContent:'flex-end',marginTop:4}}>
        <button onClick={onClose} style={{padding:'6px 14px',background:'var(--bg4)',color:'var(--text)',border:'none',borderRadius:6,cursor:'pointer',fontSize:12}}>Отмена</button>
        <button onClick={submit} style={{padding:'6px 14px',background:'var(--accent)',color:'#fff',border:'none',borderRadius:6,cursor:'pointer',fontSize:12,fontWeight:600}}>Создать заявку</button>
      </div>
    </div>
  </Modal>;
}

/* ===== Overhead Request Card (separate component to avoid hooks-in-render) ===== */
function OhRequestCard({m,req,store,chatData,isThread,sysTc,setThreadMsg,formatTime}){
  const [editing,setEditing]=useState(false);
  const [ef,setEf]=useState({...req});
  React.useEffect(()=>{setEf({...req});},[req.status,req.amount,req.category]);
  const st=req.disbursed?'DISBURSED':(req.status||'PENDING');
  const stColors={PENDING:{bg:'rgba(245,158,11,.1)',border:'var(--amber)',label:'⏳ Ожидает'},APPROVED:{bg:'rgba(16,185,129,.1)',border:'var(--green)',label:'✅ Подтверждена'},REJECTED:{bg:'rgba(239,68,68,.1)',border:'var(--red)',label:'❌ Отклонена'},DISBURSED:{bg:'rgba(59,130,246,.1)',border:'var(--sky)',label:'💸 Выдана'}};
  const stc=stColors[st]||stColors.PENDING;
  const curUser=chatData.currentUser;
  const _cn=(curUser.name||'').toLowerCase();const _ur=curUser.roles||[curUser.role||'user'];const isApprover=_ur.includes('admin')||_ur.includes('partner')||curUser.id==='__ADMIN__'||_cn.includes('балахнин')||_cn.includes('володина');
  const isFinance=_ur.includes('finance')||_ur.includes('partner')||_ur.includes('admin');
  const proj=req.project_id?(store.data.projects||[]).find(p=>p.id===req.project_id):null;
  const CAT_O=['Подрядчики','IT решения','Промо','АХО','Логистика','Зарплата ФК','Найм','Авансированная прибыль','Прочее'];
  const RG_O=['РГ1','РГ2','ФК','КБ','АХО','HR','НД','PP','РГ6'];
  return <div style={{margin:'6px 8px',padding:12,borderRadius:8,background:stc.bg,borderLeft:'3px solid '+stc.border}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
      <span style={{fontSize:13,fontWeight:700}}>📋 Заявка на накладную</span>
      <span style={{fontSize:10,padding:'2px 8px',borderRadius:10,background:stc.border,color:'#fff',fontWeight:600}}>{stc.label}</span>
    </div>
    {!editing?<div style={{fontSize:12,display:'grid',gridTemplateColumns:'1fr 1fr',gap:'4px 12px'}}>
      <div><b>Сумма:</b> {(req.amount||0).toLocaleString('ru')} ₽</div>
      <div><b>Дата:</b> {req.date}</div>
      <div><b>РГ:</b> {req.rg}</div>
      <div><b>Категория:</b> {req.category}</div>
      <div><b>Класс:</b> {req.cls}</div>
      <div><b>Формат:</b> {req.format}</div>
      <div><b>Ответственный:</b> {req.responsible}</div>
      <div><b>Уровень:</b> {req.scope==='project'?'Проект'+(proj?' ('+proj.code+')':''):'Общефирм.'}</div>
      {req.cf_type&&req.scope!=='project'&&<div><b>CF тип:</b> {req.cf_type}</div>}
      {req.comment&&<div style={{gridColumn:'1/-1'}}><b>Комментарий:</b> {req.comment}</div>}
      <div style={{gridColumn:'1/-1',fontSize:10,color:'var(--text2)'}}>Создал: {req.created_by} • {formatTime(req.created_at||m.created_at)}</div>
      {(st==='APPROVED'||st==='DISBURSED')&&req.approved_by&&<div style={{gridColumn:'1/-1',fontSize:10,color:'var(--green)'}}>Подтвердил: {req.approved_by} • {formatTime(req.approved_at)}</div>}
      {st==='DISBURSED'&&<div style={{gridColumn:'1/-1',fontSize:10,color:'var(--sky)'}}>Выдана: {req.disbursed_by} • {formatTime(req.disbursed_at)}</div>}
      {st==='REJECTED'&&<div style={{gridColumn:'1/-1',fontSize:10,color:'var(--red)'}}>Отклонил: {req.rejected_by} • {formatTime(req.rejected_at)}</div>}
    </div>
    :<div style={{fontSize:11,display:'flex',flexDirection:'column',gap:4}}>
      <div style={{display:'flex',gap:6}}><input type="number" value={ef.amount} onChange={e=>setEf(p=>({...p,amount:e.target.value}))} style={{flex:1,background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:4,padding:'3px 6px',color:'var(--text)',fontSize:11}}/><input type="date" value={ef.date} onChange={e=>setEf(p=>({...p,date:e.target.value}))} style={{flex:1,background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:4,padding:'3px 6px',color:'var(--text)',fontSize:11}}/></div>
      <div style={{display:'flex',gap:6}}><select value={ef.rg} onChange={e=>setEf(p=>({...p,rg:e.target.value}))} style={{flex:1,background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:4,padding:'3px 6px',color:'var(--text)',fontSize:11}}>{RG_O.map(o=><option key={o}>{o}</option>)}</select><select value={ef.category} onChange={e=>setEf(p=>({...p,category:e.target.value}))} style={{flex:1,background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:4,padding:'3px 6px',color:'var(--text)',fontSize:11}}>{CAT_O.map(o=><option key={o}>{o}</option>)}</select></div>
      <input value={ef.comment||''} onChange={e=>setEf(p=>({...p,comment:e.target.value}))} placeholder="Комментарий" style={{background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:4,padding:'3px 6px',color:'var(--text)',fontSize:11}}/>
      <div style={{display:'flex',gap:6}}><button onClick={()=>{store.updateOhRequest(m.id,{...ef,amount:Number(ef.amount)});setEditing(false);}} style={{padding:'3px 10px',background:'var(--accent)',color:'#fff',border:'none',borderRadius:4,fontSize:10,cursor:'pointer'}}>Сохранить</button><button onClick={()=>setEditing(false)} style={{padding:'3px 10px',background:'var(--bg4)',color:'var(--text)',border:'none',borderRadius:4,fontSize:10,cursor:'pointer'}}>Отмена</button></div>
    </div>}
    {st==='PENDING'&&<div style={{display:'flex',gap:6,marginTop:8}}>
      {isApprover&&<button onClick={()=>setEditing(!editing)} style={{padding:'4px 10px',background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:4,fontSize:11,cursor:'pointer',color:'var(--text)'}}>✏️ Редактировать</button>}
      {isApprover&&<button onClick={()=>store.approveOhRequest(m.id,curUser.name)} style={{padding:'4px 10px',background:'var(--green)',color:'#fff',border:'none',borderRadius:4,fontSize:11,cursor:'pointer',fontWeight:600}}>✅ Подтвердить</button>}
      {isApprover&&<button onClick={()=>{if(confirm('Отклонить заявку?'))store.rejectOhRequest(m.id,curUser.name);}} style={{padding:'4px 10px',background:'var(--red)',color:'#fff',border:'none',borderRadius:4,fontSize:11,cursor:'pointer'}}>❌ Отклонить</button>}
      {!isApprover&&m.author?.id===curUser.id&&<button onClick={()=>setEditing(!editing)} style={{padding:'4px 10px',background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:4,fontSize:11,cursor:'pointer',color:'var(--text)'}}>📝 Редактировать</button>}
    </div>}
    {st==='APPROVED'&&isFinance&&<div style={{display:'flex',gap:6,marginTop:8}}>
      <button onClick={()=>store.markOhRequestDisbursed(m.id,curUser.name)} style={{padding:'4px 12px',background:'var(--sky)',color:'#fff',border:'none',borderRadius:4,fontSize:11,cursor:'pointer',fontWeight:600}}>💸 Фактически выдана</button>
    </div>}
    {!isThread&&sysTc>0&&<div onClick={()=>setThreadMsg(m)} style={{display:'flex',alignItems:'center',gap:4,marginTop:6,cursor:'pointer',color:'var(--accent2)',fontSize:11,fontWeight:500}}><span>💬</span>{sysTc} {sysTc===1?'комментарий':sysTc<5?'комментария':'комментариев'}</div>}
    {!isThread&&sysTc===0&&<div onClick={()=>setThreadMsg(m)} style={{marginTop:4,cursor:'pointer',color:'var(--text2)',fontSize:10,opacity:.7}}>💬 Обсудить</div>}
  </div>;
}

/* ===== CHAT VIEW ===== */
function ChatView({store}){
  const chatData=(()=>{const d=store.data;const defaultCh=[{id:'general',name:'Общий',description:'Основной канал',type:'public',created_at:'',pinned:true},{id:'projects',name:'Проекты',description:'Обсуждение проектов',type:'public',created_at:'',pinned:true},{id:'random',name:'Разное',description:'Неформальное',type:'public',created_at:'',pinned:false},{id:'cashflow',name:'Денежный поток',description:'Поступления и запросы накладных',type:'system',icon:'💰',created_at:'',pinned:true}];const sess=(()=>{try{return JSON.parse(sessionStorage.getItem('pp_auth_session'));}catch(e){return null;}})();const curUser=sess?{id:sess.user_id,name:sess.name||sess.login,avatar:(sess.name||sess.login||'?')[0].toUpperCase(),role:sess.role||'user',roles:sess.roles||[sess.role||'user']}:(d.chat_current_user||{id:'me',name:'Илья',avatar:'И',role:'admin',roles:['admin']});const chs=d.chat_channels||defaultCh;const hasCF=chs.some(c=>c.id==='cashflow');const finalChs=hasCF?chs:[...chs,{id:'cashflow',name:'Денежный поток',description:'Поступления и запросы накладных',type:'system',icon:'💰',created_at:'',pinned:true}];return{channels:finalChs,messages:d.chat_messages||[],currentUser:curUser};})();

  const [activeCh,setActiveCh]=useState(()=>localStorage.getItem('pp_chatCh')||'general');
  /* Unread tracking: per-user lastRead timestamps */
  const _lrKey='pp_chat_last_read_'+(chatData.currentUser.id||'me');
  const [lastRead,setLastRead]=useState(()=>{try{return JSON.parse(localStorage.getItem(_lrKey))||{};}catch(e){return{};}});
  const _saveLastRead=(lr)=>{setLastRead(lr);localStorage.setItem(_lrKey,JSON.stringify(lr));};
  const getUnreadCount=(chId)=>{const ts=lastRead[chId]||'';return chatData.messages.filter(m=>m.channel_id===chId&&!m.thread_id&&(m.created_at||'')>ts&&m.author?.id!==chatData.currentUser.id).length;};
  const markChannelRead=(chId)=>{const lr={...lastRead,[chId]:new Date().toISOString()};_saveLastRead(lr);};
  const markAllRead=()=>{const lr={...lastRead};const ts=new Date().toISOString();const chIds=new Set(chatData.messages.map(m=>m.channel_id).filter(Boolean));chIds.forEach(id=>{lr[id]=ts;});chatData.channels.forEach(c=>{lr[c.id]=ts;});_saveLastRead(lr);};
  const selectCh=(id)=>{localStorage.setItem('pp_chatCh',id);setActiveCh(id);setThreadMsg(null);const lr={...lastRead,[id]:new Date().toISOString()};_saveLastRead(lr);};
  const [showNewCh,setShowNewCh]=useState(false);
  const [newChName,setNewChName]=useState('');
  const [newChDesc,setNewChDesc]=useState('');
  const [newChType,setNewChType]=useState('public');
  const [msgText,setMsgText]=useState('');
  const [threadMsg,setThreadMsg]=useState(null);
  const [threadText,setThreadText]=useState('');
  const [editMsg,setEditMsg]=useState(null);
  const [editText,setEditText]=useState('');
  const [showEmojiFor,setShowEmojiFor]=useState(null);
  const [searchQ,setSearchQ]=useState('');
  const [showMembers,setShowMembers]=useState(false);
  const [showPinned,setShowPinned]=useState(false);
  const [chatSidebar,setChatSidebar]=useState('channels');
  const [cashflowTab,setCashflowTab]=useState('income');
  const [showOhRequestForm,setShowOhRequestForm]=useState(false);
  const msgEndRef=React.useRef(null);
  const threadEndRef=React.useRef(null);

  const EMOJIS=['👍','👎','❤️','😂','🎉','🤔','👀','🔥','✅','❌','💯','🙏','😍','😢','🚀','⭐'];

  const persons=store.data.persons||[];
  const mentionUsers=(store.data.users||[]).filter(u=>u.is_active);

  /* @-mention autocomplete */
  const [mentionQuery,setMentionQuery]=useState('');
  const [mentionActive,setMentionActive]=useState(false);
  const [mentionIdx,setMentionIdx]=useState(0);
  const [mentionTarget,setMentionTarget]=useState('main'); /* 'main' | 'thread' */
  const mainInputRef=React.useRef(null);
  const threadInputRef=React.useRef(null);

  const mentionFiltered=mentionActive?mentionUsers.filter(u=>{
    const q=mentionQuery.toLowerCase();
    return (u.login||'').toLowerCase().includes(q)||(u.name||'').toLowerCase().includes(q);
  }).slice(0,8):[];

  const handleMentionInput=(e,target)=>{
    const val=e.target.value;
    if(target==='main')setMsgText(val); else setThreadText(val);
    /* Detect @ trigger */
    const pos=e.target.selectionStart;
    const before=val.slice(0,pos);
    const atMatch=before.match(/@([\w.]*)$/);
    if(atMatch){
      setMentionQuery(atMatch[1]);
      setMentionActive(true);
      setMentionIdx(0);
      setMentionTarget(target);
    } else {
      setMentionActive(false);
    }
  };

  const insertMention=(user,target)=>{
    const ref=target==='main'?mainInputRef:threadInputRef;
    const getText=target==='main'?msgText:threadText;
    const setText=target==='main'?setMsgText:setThreadText;
    const el=ref.current;
    if(!el)return;
    const pos=el.selectionStart;
    const before=getText.slice(0,pos);
    const after=getText.slice(pos);
    const newBefore=before.replace(/@[\w.]*$/,'@'+user.login+' ');
    setText(newBefore+after);
    setMentionActive(false);
    setTimeout(()=>{el.focus();el.selectionStart=el.selectionEnd=newBefore.length;},0);
  };

  const handleMentionKeyDown=(e,target)=>{
    if(!mentionActive||mentionFiltered.length===0)return;
    if(e.key==='ArrowDown'){e.preventDefault();setMentionIdx(i=>(i+1)%mentionFiltered.length);}
    else if(e.key==='ArrowUp'){e.preventDefault();setMentionIdx(i=>(i-1+mentionFiltered.length)%mentionFiltered.length);}
    else if(e.key==='Enter'&&mentionActive&&mentionFiltered.length>0){e.preventDefault();e.stopPropagation();insertMention(mentionFiltered[mentionIdx],target);}
    else if(e.key==='Escape'){setMentionActive(false);}
  };

  /* Project sub-channels — auto-generated for active projects */
  const activeProjects=(store.data.projects||[]).filter(p=>p.status==='ACTIVE');
  const projectChannels=activeProjects.map(p=>{
    const client=(store.data.clients||[]).find(c=>c.id===p.client_id);
    return {id:'proj_'+p.id,name:p.code||p.name,description:(client?client.name+(client.industry?' · '+client.industry:''):'')+(p.work_group?' | '+p.work_group:''),type:'project',project_id:p.id,client_name:client?.name||'',client_industry:client?.industry||'',client_contact:client?.contact_person||'',client_email:client?.email||'',client_phone:client?.phone||'',proj_name:p.name,proj_code:p.code||'',proj_type:p.project_type||'',proj_wg:p.work_group||'',proj_manager:(persons.find(x=>x.id===p.manager_id)||{}).name||''};
  });
  const allChannels=[...chatData.channels,...projectChannels];

  const channel=allChannels.find(c=>c.id===activeCh)||chatData.channels.find(c=>c.id===activeCh);
  const chMessages=chatData.messages.filter(m=>{if(m.thread_id)return false;if(m.channel_id!==activeCh)return false;if(activeCh==='cashflow'){return(m.cashflow_tab||'income')===cashflowTab;}return true;}).sort((a,b)=>(a.created_at||'').localeCompare(b.created_at||''));
  const threadMessages=threadMsg?chatData.messages.filter(m=>m.thread_id===threadMsg.id).sort((a,b)=>(a.created_at||'').localeCompare(b.created_at||'')):[];
  const getThreadCount=(msgId)=>chatData.messages.filter(m=>m.thread_id===msgId).length;
  const pinnedMessages=chatData.messages.filter(m=>m.channel_id===activeCh&&m.pinned);

  const filteredMessages=searchQ?chMessages.filter(m=>(m.text||'').toLowerCase().includes(searchQ.toLowerCase())||(m.author?.name||'').toLowerCase().includes(searchQ.toLowerCase())):chMessages;

  React.useEffect(()=>{if(msgEndRef.current)msgEndRef.current.scrollIntoView({behavior:'smooth'});},[chMessages.length]);
  React.useEffect(()=>{if(threadEndRef.current)threadEndRef.current.scrollIntoView({behavior:'smooth'});},[threadMessages.length]);

  const sendMessage=()=>{
    if(!msgText.trim())return;
    const extra=activeCh==='cashflow'?{cashflow_tab:cashflowTab}:{};
    store.addChatMessage({channel_id:activeCh,text:msgText.trim(),...extra});
    setMsgText('');
  };
  const sendThreadReply=()=>{
    if(!threadText.trim()||!threadMsg)return;
    store.addChatMessage({channel_id:activeCh,text:threadText.trim(),thread_id:threadMsg.id});
    setThreadText('');
  };
  const createChannel=()=>{
    if(!newChName.trim())return;
    store.addChatChannel({name:newChName.trim(),description:newChDesc.trim(),type:newChType});
    setNewChName('');setNewChDesc('');setNewChType('public');setShowNewCh(false);
  };
  const saveEdit=()=>{
    if(!editMsg||!editText.trim())return;
    store.updateChatMessage(editMsg.id,{text:editText.trim()});
    setEditMsg(null);setEditText('');
  };

  const formatTime=(ts)=>{if(!ts)return '';const d=new Date(ts);const now2=new Date();const diff=now2-d;if(diff<86400000)return d.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});if(diff<604800000)return d.toLocaleDateString('ru',{weekday:'short'})+' '+d.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});return d.toLocaleDateString('ru',{day:'numeric',month:'short'})+' '+d.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});};

  const formatText=(text)=>{
    if(!text)return '';
    let html=text
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>')
      .replace(/`(.+?)`/g,'<code style="background:var(--bg4);padding:1px 4px;border-radius:3px;font-size:12px">$1</code>')
      .replace(/\n/g,'<br/>');
    /* @mentions */
    html=html.replace(/@(\S+)/g,'<span style="color:var(--accent2);font-weight:600;cursor:pointer">@$1</span>');
    return html;
  };

  const groupByDate=(msgs)=>{
    const groups=[];
    let lastDate='';
    msgs.forEach(m=>{
      const d=m.created_at?(new Date(m.created_at)).toLocaleDateString('ru',{day:'numeric',month:'long',year:'numeric'}):'';
      if(d!==lastDate){groups.push({type:'date',label:d});lastDate=d;}
      groups.push({type:'msg',msg:m});
    });
    return groups;
  };

  /* Reusable task card renderer */
  const renderTaskCard=(tsk,projId,proj,opts)=>{
    const {msgId,createdAt,isThread:isTh,sysTc}=opts||{};
    const prioOpts=[{v:1,l:'🔴 Критич.'},{v:2,l:'🟠 Высокий'},{v:3,l:'🟡 Средний'},{v:4,l:'🟢 Низкий'},{v:5,l:'⚪ Миним.'}];
    const statusOpts=[{v:'TODO',l:'📋 К выполнению'},{v:'IN_PROGRESS',l:'🔄 В работе'},{v:'DONE',l:'✅ Выполнена'},{v:'BLOCKED',l:'🚧 Заблокирована'}];
    const statusColors={TODO:'rgba(136,136,170,.08)',IN_PROGRESS:'rgba(14,165,233,.1)',DONE:'rgba(34,197,94,.1)',BLOCKED:'rgba(239,68,68,.1)'};
    const statusBorder={TODO:'var(--bg4)',IN_PROGRESS:'var(--sky)',DONE:'var(--green)',BLOCKED:'var(--red)'};
    const selSt={background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:5,color:'var(--text)',fontSize:11,padding:'3px 6px',cursor:'pointer'};
    const dlDays=tsk.deadline?Math.ceil((new Date(tsk.deadline)-new Date())/(86400000)):null;
    const dlColor=dlDays===null?'var(--text2)':dlDays<0?'var(--red)':dlDays<=3?'var(--amber)':'var(--green)';
    const trk=proj?(proj.tracks||[]).find(x=>x.id===tsk.track_id):null;
    const cardMsg=msgId?chatData.messages.find(x=>x.id===msgId):null;
    return <div key={msgId||tsk.id} style={{margin:'4px 8px',padding:'12px 14px',background:statusColors[tsk.status]||'rgba(99,102,241,.03)',borderLeft:'3px solid '+(statusBorder[tsk.status]||'var(--accent)'),borderRadius:'0 8px 8px 0',transition:'background .2s'}}>
      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
        <span style={{fontSize:14}}>📝</span>
        <input value={tsk.title||''} onChange={e=>store.updateTask(projId,tsk.id,{title:e.target.value})} style={{flex:1,background:'transparent',border:'none',borderBottom:'1px dashed var(--border)',color:'var(--text)',fontWeight:700,fontSize:13,padding:'2px 0',outline:'none'}} placeholder="Название задачи"/>
        {createdAt&&<span style={{fontSize:9,color:'var(--text2)',whiteSpace:'nowrap'}}>{formatTime(createdAt)}</span>}
      </div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'6px 12px',marginBottom:6}}>
        <div style={{display:'flex',alignItems:'center',gap:4}}>
          <span style={{fontSize:10,color:'var(--text2)',minWidth:55}}>Статус:</span>
          <select value={tsk.status} onChange={e=>store.updateTaskStatus(projId,tsk.id,e.target.value)} style={selSt}>
            {statusOpts.map(o=><option key={o.v} value={o.v}>{o.l}</option>)}
          </select>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:4}}>
          <span style={{fontSize:10,color:'var(--text2)',minWidth:55}}>Приоритет:</span>
          <select value={tsk.priority||3} onChange={e=>store.updateTask(projId,tsk.id,{priority:Number(e.target.value)})} style={selSt}>
            {prioOpts.map(o=><option key={o.v} value={o.v}>{o.l}</option>)}
          </select>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:4}}>
          <span style={{fontSize:10,color:'var(--text2)',minWidth:55}}>Ответств.:</span>
          <select value={tsk.assigned_to_id||''} onChange={e=>store.updateTask(projId,tsk.id,{assigned_to_id:e.target.value||null})} style={{...selSt,maxWidth:130}}>
            <option value="">— нет —</option>
            {persons.filter(pp=>pp.is_active).map(pp=><option key={pp.id} value={pp.id}>{pp.name}</option>)}
          </select>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:4}}>
          <span style={{fontSize:10,color:'var(--text2)',minWidth:55}}>Дедлайн:</span>
          <input type="date" value={tsk.deadline||''} onChange={e=>store.updateTask(projId,tsk.id,{deadline:e.target.value})} style={{...selSt,width:115,color:dlColor}}/>
          {dlDays!==null&&<span style={{fontSize:9,fontWeight:600,color:dlColor}}>{dlDays<0?Math.abs(dlDays)+'д!':dlDays+'д'}</span>}
        </div>
        {trk&&<div style={{display:'flex',alignItems:'center',gap:4}}>
          <span style={{fontSize:10,color:'var(--text2)',minWidth:55}}>Трек:</span>
          <span style={{fontSize:11,background:'var(--bg3)',padding:'2px 8px',borderRadius:4}}>{trk.track_code}</span>
        </div>}
      </div>
      {!isTh&&msgId&&<div style={{display:'flex',alignItems:'center',gap:10,marginTop:4,paddingTop:4,borderTop:'1px solid rgba(255,255,255,.05)'}}>
        <span onClick={()=>setThreadMsg(cardMsg||{id:msgId,channel_id:'proj_'+projId,text:tsk.title,author:{id:'system',name:'Система',avatar:'⚙'},task_id:tsk.id,is_system:true,created_at:createdAt})} style={{fontSize:10,color:'var(--accent2)',cursor:'pointer',fontWeight:500}}>
          {(sysTc||0)>0?'💬 '+(sysTc)+' '+((sysTc)===1?'комментарий':(sysTc)<5?'комментария':'комментариев'):'💬 Обсудить'}
        </span>
      </div>}
    </div>;
  };

  const renderMessage=(m,isThread)=>{
    const isMe=m.author?.id===chatData.currentUser.id;
    const isSys=m.is_system||m.author?.id==='system';
    const tc=getThreadCount(m.id);
    /* Overhead request card — BEFORE isSys check because author is the requester, not system */
    if(m.overhead_request){
      const _ohTc=getThreadCount(m.id);
      return <OhRequestCard key={m.id} m={m} req={m.overhead_request} store={store} chatData={chatData} isThread={isThread} sysTc={_ohTc} setThreadMsg={setThreadMsg} formatTime={formatTime}/>;
    }
    if(isSys){const sysTc=getThreadCount(m.id);
      /* If message has task_id, render interactive task card ONLY for the first message of this task */
      if(m.task_id){
        const allTaskMsgs=chatData.messages.filter(x=>x.task_id===m.task_id&&x.channel_id===m.channel_id&&!x.thread_id).sort((a,b)=>(a.created_at||'').localeCompare(b.created_at||''));
        const isFirstTaskMsg=allTaskMsgs.length>0&&allTaskMsgs[0].id===m.id;
        if(isFirstTaskMsg){
          const projId=m.channel_id?.replace('proj_','');
          const proj=projId?(store.data.projects||[]).find(p=>p.id===projId):null;
          const tsk=proj?(proj.tasks||[]).find(t=>t.id===m.task_id):null;
          if(tsk) return renderTaskCard(tsk,projId,proj,{msgId:m.id,createdAt:m.created_at,isThread,sysTc});
        }
        /* Subsequent task messages → render as regular system log (fall through below) */
      }
      /* Default system message rendering */
      return <div key={m.id} style={{padding:'6px 16px',display:'flex',alignItems:'flex-start',gap:8,background:'rgba(99,102,241,.03)',borderLeft:'3px solid var(--bg4)',margin:'2px 8px',borderRadius:'0 6px 6px 0'}}>
      <span style={{fontSize:14,marginTop:1}}>⚙</span>
      <div style={{flex:1}}>
        <div style={{fontSize:12,color:'var(--text)',lineHeight:1.5}} dangerouslySetInnerHTML={{__html:formatText(m.text)}}/>
        <div style={{display:'flex',alignItems:'center',gap:10,marginTop:3}}>
          <span style={{fontSize:9,color:'var(--text2)'}}>{formatTime(m.created_at)}</span>
          {!isThread&&<span onClick={()=>setThreadMsg(m)} style={{fontSize:10,color:'var(--accent2)',cursor:'pointer',fontWeight:500}}>
            {sysTc>0?'💬 '+sysTc+' '+(sysTc===1?'комментарий':sysTc<5?'комментария':'комментариев'):'💬 Обсудить'}
          </span>}
        </div>
      </div>
    </div>;}
    return <div key={m.id} style={{display:'flex',gap:10,padding:'8px 16px',position:'relative',borderRadius:6,transition:'background .15s'}} className="chat-msg-row"
      onMouseEnter={e=>e.currentTarget.querySelector('.msg-actions')&&(e.currentTarget.querySelector('.msg-actions').style.display='flex')}
      onMouseLeave={e=>e.currentTarget.querySelector('.msg-actions')&&(e.currentTarget.querySelector('.msg-actions').style.display='none')}>
      <div style={{width:36,height:36,borderRadius:'50%',background:isMe?'var(--accent)':'var(--bg4)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,fontWeight:700,color:'#fff',flexShrink:0,marginTop:2}}>{(m.author?.avatar||m.author?.name?.[0]||'?')}</div>
      <div style={{flex:1,minWidth:0}}>
        <div style={{display:'flex',alignItems:'baseline',gap:8}}>
          <span style={{fontWeight:600,fontSize:13,color:isMe?'var(--accent2)':'var(--text)'}}>{m.author?.name||'Аноним'}</span>
          <span style={{fontSize:10,color:'var(--text2)'}}>{formatTime(m.created_at)}</span>
          {m.edited&&<span style={{fontSize:9,color:'var(--text2)',fontStyle:'italic'}}>(ред.)</span>}
          {m.pinned&&<span style={{fontSize:10}} title="Закреплено">📌</span>}
        </div>
        {editMsg&&editMsg.id===m.id?<div style={{marginTop:4}}>
          <textarea value={editText} onChange={e=>setEditText(e.target.value)} style={{width:'100%',background:'var(--bg3)',border:'1px solid var(--accent)',borderRadius:6,color:'var(--text)',padding:'6px 8px',fontSize:13,resize:'vertical',minHeight:40}} onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();saveEdit();}if(e.key==='Escape'){setEditMsg(null);}}}/>
          <div style={{display:'flex',gap:6,marginTop:4}}><button onClick={saveEdit} style={{padding:'3px 10px',background:'var(--accent)',color:'#fff',border:'none',borderRadius:4,fontSize:11,cursor:'pointer'}}>Сохранить</button><button onClick={()=>setEditMsg(null)} style={{padding:'3px 10px',background:'var(--bg4)',color:'var(--text)',border:'none',borderRadius:4,fontSize:11,cursor:'pointer'}}>Отмена</button></div>
        </div>:<div style={{fontSize:13,color:'var(--text)',lineHeight:1.5,marginTop:2}} dangerouslySetInnerHTML={{__html:formatText(m.text)}}/>}
        {/* Reactions */}
        {(m.reactions||[]).length>0&&<div style={{display:'flex',gap:4,flexWrap:'wrap',marginTop:6}}>
          {Object.entries((m.reactions||[]).reduce((acc,r)=>{acc[r.emoji]=(acc[r.emoji]||[]);acc[r.emoji].push(r.user_name);return acc;},{})).map(([emoji,users])=>{
            const myReaction=users.includes(chatData.currentUser.name);
            return <button key={emoji} onClick={()=>store.addChatReaction(m.id,emoji)} style={{display:'flex',alignItems:'center',gap:3,padding:'2px 6px',borderRadius:10,border:'1px solid '+(myReaction?'var(--accent)':'var(--border)'),background:myReaction?'rgba(99,102,241,.15)':'var(--bg3)',cursor:'pointer',fontSize:12}} title={users.join(', ')}>{emoji}<span style={{fontSize:10,color:'var(--text2)'}}>{users.length}</span></button>;
          })}
        </div>}
        {/* Thread indicator / thread link */}
        {!isThread&&tc>0&&<div onClick={()=>setThreadMsg(m)} style={{display:'flex',alignItems:'center',gap:4,marginTop:6,cursor:'pointer',color:'var(--accent2)',fontSize:11,fontWeight:500}}><span>💬</span>{tc} {tc===1?'ответ':tc<5?'ответа':'ответов'}</div>}
        {!isThread&&tc===0&&<div onClick={()=>setThreadMsg(m)} style={{display:'inline-flex',alignItems:'center',gap:3,marginTop:4,cursor:'pointer',color:'var(--text2)',fontSize:10,opacity:.7,transition:'opacity .15s'}} onMouseEnter={e=>e.currentTarget.style.opacity='1'} onMouseLeave={e=>e.currentTarget.style.opacity='.7'}>💬 В тред</div>}
        {/* Actions toolbar */}
        <div className="msg-actions" style={{display:'none',position:'absolute',top:-4,right:8,background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:6,padding:'2px 4px',gap:2,zIndex:10}}>
          {EMOJIS.slice(0,6).map(e=><button key={e} onClick={()=>store.addChatReaction(m.id,e)} style={{background:'none',border:'none',cursor:'pointer',fontSize:14,padding:'2px 3px',borderRadius:4}} title={e}>{e}</button>)}
          <button onClick={()=>setShowEmojiFor(showEmojiFor===m.id?null:m.id)} style={{background:'none',border:'none',cursor:'pointer',fontSize:12,padding:'2px 4px',color:'var(--text2)'}} title="Ещё">+</button>
          {!isThread&&<button onClick={()=>setThreadMsg(m)} style={{background:'none',border:'none',cursor:'pointer',fontSize:12,padding:'2px 4px',color:'var(--text2)'}} title="В тред">💬</button>}
          <button onClick={()=>store.pinChatMessage(m.id)} style={{background:'none',border:'none',cursor:'pointer',fontSize:12,padding:'2px 4px',color:m.pinned?'var(--amber)':'var(--text2)'}} title={m.pinned?'Открепить':'Закрепить'}>📌</button>
          {isMe&&<button onClick={()=>{setEditMsg(m);setEditText(m.text);}} style={{background:'none',border:'none',cursor:'pointer',fontSize:12,padding:'2px 4px',color:'var(--text2)'}} title="Редактировать">✏️</button>}
          {isMe&&<button onClick={()=>{if(confirm('Удалить сообщение?'))store.deleteChatMessage(m.id);}} style={{background:'none',border:'none',cursor:'pointer',fontSize:12,padding:'2px 4px',color:'var(--red)'}} title="Удалить">🗑️</button>}
        </div>
        {/* Expanded emoji picker */}
        {showEmojiFor===m.id&&<div style={{display:'flex',flexWrap:'wrap',gap:2,marginTop:4,padding:6,background:'var(--bg3)',borderRadius:8,border:'1px solid var(--border)',maxWidth:280}}>
          {EMOJIS.map(e=><button key={e} onClick={()=>{store.addChatReaction(m.id,e);setShowEmojiFor(null);}} style={{background:'none',border:'none',cursor:'pointer',fontSize:18,padding:4,borderRadius:4}}>{e}</button>)}
        </div>}
      </div>
    </div>;
  };

  const publicChannels=chatData.channels.filter(c=>c.type==='public'||c.type==='system');
  const privateChannels=chatData.channels.filter(c=>c.type==='private');
  const dmChannels=chatData.channels.filter(c=>c.type==='dm');
  const UnreadBadge=({chId})=>{const n=getUnreadCount(chId);if(!n)return null;return <span style={{marginLeft:'auto',background:'var(--red)',color:'#fff',borderRadius:10,fontSize:9,fontWeight:700,minWidth:18,height:18,display:'flex',alignItems:'center',justifyContent:'center',padding:'0 5px',flexShrink:0}}>{n>99?'99+':n}</span>;};

  const sideWidth=240;
  const threadWidth=360;

  return <div style={{display:'flex',height:'calc(100vh - 20px)',overflow:'hidden'}}>
    {/* Left sidebar — channels */}
    <div style={{width:sideWidth,flexShrink:0,background:'var(--bg2)',borderRight:'1px solid var(--border)',display:'flex',flexDirection:'column',overflow:'hidden'}}>
      <div style={{padding:'12px 14px 8px',borderBottom:'1px solid var(--border)'}}>
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
          <h2 style={{fontSize:15,fontWeight:700,margin:0}}>Чат</h2>
          <div style={{display:'flex',gap:4,alignItems:'center'}}>
            <button onClick={markAllRead} style={{background:'none',border:'none',color:'var(--text2)',cursor:'pointer',fontSize:13,padding:2,display:'flex',alignItems:'center'}} title="Отметить все как прочитанные">✓✓</button>
            <button onClick={()=>setShowNewCh(true)} style={{background:'var(--accent)',color:'#fff',border:'none',borderRadius:6,width:24,height:24,cursor:'pointer',fontSize:16,display:'flex',alignItems:'center',justifyContent:'center'}} title="Новый канал">+</button>
          </div>
        </div>
        <input value={searchQ} onChange={e=>setSearchQ(e.target.value)} placeholder="Поиск..." style={{width:'100%',background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:6,padding:'5px 8px',color:'var(--text)',fontSize:12}} />
      </div>
      <div style={{flex:1,overflowY:'auto',padding:'8px 0'}}>
        {/* Section tabs */}
        <div style={{display:'flex',gap:0,padding:'0 10px 8px',borderBottom:'1px solid var(--border)'}}>
          {[{k:'channels',l:'Каналы'},{k:'projects',l:'Проекты'},{k:'dm',l:'Личные'},{k:'members',l:'Участники'}].map(t=>
            <div key={t.k} onClick={()=>setChatSidebar(t.k)} style={{flex:1,textAlign:'center',padding:'4px 0',fontSize:10,fontWeight:chatSidebar===t.k?600:400,color:chatSidebar===t.k?'var(--accent2)':'var(--text2)',cursor:'pointer',borderBottom:chatSidebar===t.k?'2px solid var(--accent)':'2px solid transparent'}}>{t.l}</div>
          )}
        </div>

        {chatSidebar==='channels'&&<div>
          {publicChannels.length>0&&<div style={{padding:'6px 14px 2px',fontSize:10,color:'var(--text2)',fontWeight:600,textTransform:'uppercase',letterSpacing:'.5px'}}>Каналы</div>}
          {publicChannels.map(c=><div key={c.id} onClick={()=>selectCh(c.id)} style={{padding:'6px 14px',cursor:'pointer',display:'flex',alignItems:'center',gap:8,fontSize:13,color:activeCh===c.id?'var(--accent2)':'var(--text)',background:activeCh===c.id?'var(--bg3)':'transparent',borderLeft:activeCh===c.id?'3px solid var(--accent)':'3px solid transparent',fontWeight:activeCh===c.id?600:400}}>
            <span style={{fontSize:14}}>{c.icon||'#'}</span><span style={{overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}}>{c.name}</span>
            <UnreadBadge chId={c.id}/>
            {c.pinned&&!getUnreadCount(c.id)&&<span style={{fontSize:8}}>📌</span>}
          </div>)}
          {privateChannels.length>0&&<div style={{padding:'10px 14px 2px',fontSize:10,color:'var(--text2)',fontWeight:600,textTransform:'uppercase',letterSpacing:'.5px'}}>Приватные</div>}
          {privateChannels.map(c=><div key={c.id} onClick={()=>selectCh(c.id)} style={{padding:'6px 14px',cursor:'pointer',display:'flex',alignItems:'center',gap:8,fontSize:13,color:activeCh===c.id?'var(--accent2)':'var(--text)',background:activeCh===c.id?'var(--bg3)':'transparent',borderLeft:activeCh===c.id?'3px solid var(--accent)':'3px solid transparent',fontWeight:activeCh===c.id?600:400}}>
            <span style={{fontSize:14}}>🔒</span><span style={{overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}}>{c.name}</span>
            <UnreadBadge chId={c.id}/>
          </div>)}
        </div>}

        {chatSidebar==='projects'&&<div>
          <div style={{padding:'6px 14px 2px',fontSize:10,color:'var(--text2)',fontWeight:600,textTransform:'uppercase',letterSpacing:'.5px'}}>Активные проекты ({projectChannels.length})</div>
          {projectChannels.length===0&&<div style={{padding:'8px 14px',fontSize:11,color:'var(--text2)'}}>Нет активных проектов</div>}
          {projectChannels.map(c=>{const msgCount=chatData.messages.filter(m=>m.channel_id===c.id&&!m.thread_id).length;return <div key={c.id} onClick={()=>selectCh(c.id)} style={{padding:'6px 14px',cursor:'pointer',display:'flex',alignItems:'center',gap:8,fontSize:12,color:activeCh===c.id?'var(--accent2)':'var(--text)',background:activeCh===c.id?'var(--bg3)':'transparent',borderLeft:activeCh===c.id?'3px solid var(--accent)':'3px solid transparent',fontWeight:activeCh===c.id?600:400}}>
            <span style={{fontSize:13}}>📁</span>
            <div style={{flex:1,minWidth:0}}>
              <div style={{overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',fontSize:12}}>{c.proj_code||c.name}</div>
              <div style={{fontSize:9,color:'var(--text2)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{c.client_name}{c.proj_wg?' · '+c.proj_wg:''}</div>
            </div>
            {(()=>{const ur=getUnreadCount(c.id);return ur>0?<UnreadBadge chId={c.id}/>:msgCount>0?<span style={{fontSize:9,background:'var(--bg4)',borderRadius:8,padding:'1px 5px',color:'var(--text2)'}}>{msgCount}</span>:null;})()}
          </div>;})}
        </div>}

        {chatSidebar==='dm'&&<div>
          <div style={{padding:'6px 14px 2px',fontSize:10,color:'var(--text2)',fontWeight:600,textTransform:'uppercase',letterSpacing:'.5px'}}>Личные сообщения</div>
          {dmChannels.length===0&&<div style={{padding:'8px 14px',fontSize:11,color:'var(--text2)'}}>Нет личных чатов</div>}
          {dmChannels.map(c=><div key={c.id} onClick={()=>selectCh(c.id)} style={{padding:'6px 14px',cursor:'pointer',display:'flex',alignItems:'center',gap:8,fontSize:13,color:activeCh===c.id?'var(--accent2)':'var(--text)',background:activeCh===c.id?'var(--bg3)':'transparent',borderLeft:activeCh===c.id?'3px solid var(--accent)':'3px solid transparent'}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'var(--bg4)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,fontWeight:700,color:'var(--text)'}}>{(c.name||'?')[0]}</div><span style={{flex:1}}>{c.name}</span>
            <UnreadBadge chId={c.id}/>
          </div>)}
          <div style={{padding:'8px 14px'}}>
            <button onClick={()=>{
              const activePers=persons.filter(pp=>pp.is_active);
              const nameList=activePers.map((pp,i)=>(i+1)+'. '+pp.name).join('\n');
              const choice=prompt('Выберите номер собеседника:\n'+nameList);
              if(!choice)return;
              const idx=parseInt(choice,10)-1;
              if(idx>=0&&idx<activePers.length){
                const p=activePers[idx];
                const myId=chatData.currentUser.id;
                const dmId='dm_'+[myId,p.id].sort().join('_');
                const existing=chatData.channels.find(c=>c.id===dmId);
                if(existing){selectCh(existing.id);}else{store.addChatChannel({name:p.name,type:'dm',person_id:p.id});selectCh(dmId);}
              }
            }} style={{width:'100%',padding:'6px',background:'var(--bg3)',border:'1px dashed var(--border)',borderRadius:6,color:'var(--text2)',fontSize:11,cursor:'pointer'}}>+ Новый личный чат</button>
          </div>
        </div>}

        {chatSidebar==='members'&&<div>
          <div style={{padding:'6px 14px 2px',fontSize:10,color:'var(--text2)',fontWeight:600,textTransform:'uppercase',letterSpacing:'.5px'}}>Участники ({persons.filter(p=>p.is_active).length+1})</div>
          <div onClick={()=>{}} style={{padding:'5px 14px',display:'flex',alignItems:'center',gap:8,fontSize:12}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'var(--accent)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,fontWeight:700,color:'#fff'}}>{chatData.currentUser.avatar||'И'}</div>
            <span style={{fontWeight:600,color:'var(--accent2)'}}>{chatData.currentUser.name} (вы)</span>
          </div>
          {persons.filter(p=>p.is_active).slice(0,50).map(p=>{
            const myId=chatData.currentUser.id;
            const dmId='dm_'+[myId,p.id].sort().join('_');
            const existing=chatData.channels.find(c=>c.id===dmId)||dmChannels.find(c=>c.person_id===p.id);
            return <div key={p.id} style={{padding:'5px 14px',display:'flex',alignItems:'center',gap:8,fontSize:12,cursor:'pointer'}} onClick={()=>{
              if(existing){selectCh(existing.id);}else{store.addChatChannel({name:p.name,type:'dm',person_id:p.id});selectCh(dmId);}}}>
              <div style={{width:24,height:24,borderRadius:'50%',background:'var(--bg4)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,fontWeight:700,color:'var(--text)'}}>{(p.name||'?')[0]}</div>
              <span style={{color:'var(--text)'}}>{p.name}</span>
              {existing&&<span style={{fontSize:8,color:'var(--accent2)',marginLeft:2}}>●</span>}
              <span style={{fontSize:10,color:'var(--text2)',marginLeft:'auto'}}>{(p.departments||[p.department]).filter(Boolean).join(', ')}</span>
            </div>;})}

        </div>}
      </div>
    </div>

    {/* Main chat area */}
    <div style={{flex:1,display:'flex',flexDirection:'column',minWidth:0,background:'var(--bg)'}}>
      {/* Channel header */}
      {channel&&<div style={{padding:'10px 16px',borderBottom:'1px solid var(--border)',display:'flex',alignItems:'center',gap:10,flexShrink:0}}>
        <span style={{fontSize:16}}>{channel.icon||({dm:'',project:'📁',system:'💰'}[channel.type]||'#')}</span>
        <div style={{flex:1,minWidth:0}}>
          <div style={{fontWeight:600,fontSize:14}}>{channel.type==='project'?(channel.proj_code||channel.proj_name):channel.name}</div>
          {channel.type==='project'?<div style={{display:'flex',gap:8,alignItems:'center',flexWrap:'wrap',marginTop:2}}>
            {channel.proj_name&&<span style={{fontSize:11,color:'var(--text2)'}}>{channel.proj_name}</span>}
            {channel.client_name&&<span style={{fontSize:10,padding:'1px 6px',background:'rgba(99,102,241,.12)',borderRadius:6,color:'var(--accent2)'}}>👤 {channel.client_name}</span>}
            {channel.client_industry&&<span style={{fontSize:10,padding:'1px 6px',background:'var(--bg3)',borderRadius:6,color:'var(--text2)'}}>{channel.client_industry}</span>}
            {channel.proj_type&&<span style={{fontSize:10,padding:'1px 6px',background:'var(--bg3)',borderRadius:6,color:'var(--text2)'}}>{channel.proj_type}</span>}
            {channel.proj_wg&&<span style={{fontSize:10,padding:'1px 6px',background:'var(--bg3)',borderRadius:6,color:'var(--text2)'}}>{channel.proj_wg}</span>}
            {channel.proj_manager&&<span style={{fontSize:10,color:'var(--text2)'}}>PM: {channel.proj_manager}</span>}
            {channel.client_contact&&<span style={{fontSize:10,color:'var(--text2)'}}>Контакт: {channel.client_contact}</span>}
            {channel.client_email&&<span style={{fontSize:10,color:'var(--text2)'}}>{channel.client_email}</span>}
          </div>:channel.description&&<div style={{fontSize:11,color:'var(--text2)'}}>{channel.description}</div>}
        </div>
        {getUnreadCount(activeCh)>0&&<button onClick={()=>markChannelRead(activeCh)} style={{background:'none',border:'1px solid var(--border)',borderRadius:6,cursor:'pointer',fontSize:11,color:'var(--accent2)',padding:'3px 8px'}} title="Отметить прочитанными">✓ Прочитано</button>}
        <button onClick={()=>setShowPinned(!showPinned)} style={{background:'none',border:'none',cursor:'pointer',fontSize:14,color:showPinned?'var(--amber)':'var(--text2)'}} title="Закреплённые">📌 {pinnedMessages.length>0?pinnedMessages.length:''}</button>
        {channel.type!=='dm'&&channel.type!=='project'&&channel.id!=='general'&&channel.type!=='system'&&<button onClick={()=>{if(confirm('Удалить канал "'+channel.name+'"?')){store.deleteChatChannel(channel.id);selectCh('general');}}} style={{background:'none',border:'none',cursor:'pointer',fontSize:12,color:'var(--red)'}} title="Удалить канал">🗑️</button>}
      </div>}

      {/* Pinned messages panel */}
      {showPinned&&pinnedMessages.length>0&&<div style={{padding:'8px 16px',borderBottom:'1px solid var(--border)',background:'rgba(245,158,11,.05)',maxHeight:200,overflowY:'auto'}}>
        <div style={{fontSize:10,fontWeight:600,color:'var(--amber)',marginBottom:6}}>📌 Закреплённые сообщения</div>
        {pinnedMessages.map(m=><div key={m.id} style={{padding:'4px 0',fontSize:12,borderBottom:'1px solid var(--border)'}}>
          <span style={{fontWeight:600,fontSize:11}}>{m.author?.name}</span>: <span style={{color:'var(--text)'}}>{(m.text||'').slice(0,100)}{(m.text||'').length>100?'...':''}</span>
          <span style={{fontSize:10,color:'var(--text2)',marginLeft:6}}>{formatTime(m.created_at)}</span>
        </div>)}
      </div>}

      {/* Cashflow tabs */}
      {activeCh==='cashflow'&&<div style={{display:'flex',gap:0,borderBottom:'1px solid var(--border)',flexShrink:0}}>
        {[{k:'income',l:'💵 Поток поступлений'},{k:'overhead_request',l:'📋 Запрос накладных'}].map(t=>
          <div key={t.k} onClick={()=>setCashflowTab(t.k)} style={{flex:1,textAlign:'center',padding:'8px 0',fontSize:12,fontWeight:cashflowTab===t.k?600:400,color:cashflowTab===t.k?'var(--accent2)':'var(--text2)',cursor:'pointer',borderBottom:cashflowTab===t.k?'2px solid var(--accent)':'2px solid transparent',background:cashflowTab===t.k?'rgba(99,102,241,.04)':'transparent'}}>{t.l}</div>)}
      </div>}

      {/* Messages area */}
      <div style={{flex:1,overflowY:'auto',padding:'8px 0'}}>
        {/* Overhead request button */}
        {activeCh==='cashflow'&&cashflowTab==='overhead_request'&&<div style={{padding:'8px 16px'}}>
          <button onClick={()=>setShowOhRequestForm(true)} style={{padding:'6px 14px',background:'var(--accent)',color:'#fff',border:'none',borderRadius:6,fontSize:12,cursor:'pointer',fontWeight:600}}>+ Заявка на накладную</button>
        </div>}

        {/* For project channels: show task cards for tasks without chat messages */}
        {channel&&channel.type==='project'&&(()=>{
          const projId=channel.project_id;
          const proj=(store.data.projects||[]).find(p=>p.id===projId);
          if(!proj)return null;
          const tasksWithMsg=new Set(chatData.messages.filter(m=>m.channel_id===activeCh&&m.task_id).map(m=>m.task_id));
          const orphanTasks=(proj.tasks||[]).filter(t=>!tasksWithMsg.has(t.id));
          if(orphanTasks.length===0)return null;
          return <div style={{padding:'8px 8px 0'}}>
            <div style={{fontSize:10,color:'var(--text2)',fontWeight:600,padding:'4px 8px',textTransform:'uppercase',letterSpacing:'.5px'}}>📋 Задачи проекта ({(proj.tasks||[]).length})</div>
            {orphanTasks.map(tsk=>renderTaskCard(tsk,projId,proj,{msgId:null,createdAt:tsk.created_at,isThread:false,sysTc:0}))}
          </div>;
        })()}

        {/* Project channel: add task button */}
        {channel&&channel.type==='project'&&<div style={{padding:'4px 16px 8px'}}>
          <button onClick={()=>{const title=prompt('Название задачи:');if(title){const projId=channel.project_id;store.addTask(projId,{title,priority:3});}}} style={{background:'var(--bg3)',border:'1px dashed var(--border)',borderRadius:6,color:'var(--accent2)',fontSize:11,padding:'5px 12px',cursor:'pointer'}}>+ Новая задача</button>
        </div>}

        {filteredMessages.length===0&&(!channel||channel.type!=='project')&&<div style={{textAlign:'center',padding:40,color:'var(--text2)'}}>
          <div style={{fontSize:40,marginBottom:12}}>💬</div>
          <div style={{fontSize:14}}>Пока нет сообщений</div>
          <div style={{fontSize:12,marginTop:4}}>Начните обсуждение!</div>
        </div>}
        {groupByDate(filteredMessages).map((item,i)=>{
          if(item.type==='date')return <div key={'d'+i} style={{textAlign:'center',padding:'12px 16px 4px'}}><span style={{fontSize:10,color:'var(--text2)',background:'var(--bg2)',padding:'2px 10px',borderRadius:10}}>{item.label}</span></div>;
          return renderMessage(item.msg,false);
        })}
        <div ref={msgEndRef}/>
      </div>

      {/* Message input */}
      <div style={{padding:'8px 16px 12px',borderTop:'1px solid var(--border)',flexShrink:0}}>
        <div style={{fontSize:9,color:'var(--text2)',marginBottom:4}}>**жирный** *курсив* `код` @упоминание | Shift+Enter — новая строка</div>
        <div style={{display:'flex',gap:8,alignItems:'flex-end'}}>
          <div style={{flex:1,position:'relative'}}>
            <textarea ref={mainInputRef} value={msgText} onChange={e=>handleMentionInput(e,'main')} placeholder={channel?(channel.type==='project'?'Сообщение по проекту '+channel.proj_code+'...':'Сообщение в #'+channel.name+'...'):'Выберите канал'} style={{width:'100%',background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:8,padding:'8px 12px',color:'var(--text)',fontSize:13,resize:'none',minHeight:40,maxHeight:120,fontFamily:'inherit',boxSizing:'border-box'}} onKeyDown={e=>{handleMentionKeyDown(e,'main');if(e.key==='Enter'&&!e.shiftKey&&!mentionActive){e.preventDefault();sendMessage();}}} rows={1}/>
            {mentionActive&&mentionTarget==='main'&&mentionFiltered.length>0&&<div style={{position:'absolute',bottom:'100%',left:0,right:0,maxHeight:200,overflowY:'auto',background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:8,boxShadow:'0 -4px 16px rgba(0,0,0,.3)',zIndex:100,marginBottom:4}}>
              {mentionFiltered.map((u,i)=><div key={u.id} onClick={()=>insertMention(u,'main')} onMouseEnter={()=>setMentionIdx(i)} style={{padding:'8px 12px',cursor:'pointer',display:'flex',alignItems:'center',gap:8,background:i===mentionIdx?'var(--bg4)':'transparent',borderBottom:'1px solid var(--border)'}}>
                <div style={{width:28,height:28,borderRadius:'50%',background:'var(--accent)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:700,color:'#fff',flexShrink:0}}>{(u.name||u.login||'?')[0].toUpperCase()}</div>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{fontSize:12,fontWeight:600,color:'var(--text)'}}>{u.name||u.login}</div>
                  <div style={{fontSize:10,color:'var(--text2)'}}>@{u.login}</div>
                </div>
                {_getUserRoles(u).map(r=><span key={r} style={{fontSize:9,color:r==='admin'?'var(--amber)':r==='partner'?'#a855f7':r==='finance'?'#06b6d4':'#6366f1',fontWeight:600,marginRight:3}}>{r}</span>)}
              </div>)}
            </div>}
          </div>
          <button onClick={sendMessage} disabled={!msgText.trim()} style={{padding:'8px 16px',background:msgText.trim()?'var(--accent)':'var(--bg4)',color:'#fff',border:'none',borderRadius:8,cursor:msgText.trim()?'pointer':'default',fontSize:13,fontWeight:600,whiteSpace:'nowrap',height:40}}>↑</button>
        </div>
      </div>
    </div>

    {/* Thread panel */}
    {threadMsg&&<div style={{width:threadWidth,flexShrink:0,borderLeft:'1px solid var(--border)',background:'var(--bg2)',display:'flex',flexDirection:'column',overflow:'hidden'}}>
      <div style={{padding:'10px 14px',borderBottom:'1px solid var(--border)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
        <div style={{fontWeight:600,fontSize:13}}>Тред</div>
        <button onClick={()=>setThreadMsg(null)} style={{background:'none',border:'none',color:'var(--text2)',cursor:'pointer',fontSize:16}}>×</button>
      </div>
      {/* Original message */}
      <div style={{borderBottom:'1px solid var(--border)',padding:'4px 0'}}>
        {renderMessage(threadMsg,true)}
      </div>
      {/* Thread replies */}
      <div style={{flex:1,overflowY:'auto',padding:'4px 0'}}>
        {threadMessages.length>0&&<div style={{padding:'4px 16px',fontSize:10,color:'var(--text2)'}}>{threadMessages.length} {threadMessages.length===1?'ответ':threadMessages.length<5?'ответа':'ответов'}</div>}
        {threadMessages.map(m=>renderMessage(m,true))}
        <div ref={threadEndRef}/>
      </div>
      {/* Thread input */}
      <div style={{padding:'8px 14px 12px',borderTop:'1px solid var(--border)'}}>
        <div style={{display:'flex',gap:6,alignItems:'flex-end'}}>
          <div style={{flex:1,position:'relative'}}>
            <textarea ref={threadInputRef} value={threadText} onChange={e=>handleMentionInput(e,'thread')} placeholder="Ответить в треде..." style={{width:'100%',background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:8,padding:'6px 10px',color:'var(--text)',fontSize:12,resize:'none',minHeight:36,maxHeight:80,fontFamily:'inherit',boxSizing:'border-box'}} onKeyDown={e=>{handleMentionKeyDown(e,'thread');if(e.key==='Enter'&&!e.shiftKey&&!mentionActive){e.preventDefault();sendThreadReply();}}} rows={1}/>
            {mentionActive&&mentionTarget==='thread'&&mentionFiltered.length>0&&<div style={{position:'absolute',bottom:'100%',left:0,right:0,maxHeight:180,overflowY:'auto',background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:8,boxShadow:'0 -4px 16px rgba(0,0,0,.3)',zIndex:100,marginBottom:4}}>
              {mentionFiltered.map((u,i)=><div key={u.id} onClick={()=>insertMention(u,'thread')} onMouseEnter={()=>setMentionIdx(i)} style={{padding:'6px 10px',cursor:'pointer',display:'flex',alignItems:'center',gap:6,background:i===mentionIdx?'var(--bg4)':'transparent',borderBottom:'1px solid var(--border)'}}>
                <div style={{width:24,height:24,borderRadius:'50%',background:'var(--accent)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:700,color:'#fff',flexShrink:0}}>{(u.name||u.login||'?')[0].toUpperCase()}</div>
                <div><div style={{fontSize:11,fontWeight:600,color:'var(--text)'}}>{u.name||u.login}</div><div style={{fontSize:9,color:'var(--text2)'}}>@{u.login}</div></div>
              </div>)}
            </div>}
          </div>
          <button onClick={sendThreadReply} disabled={!threadText.trim()} style={{padding:'6px 12px',background:threadText.trim()?'var(--accent)':'var(--bg4)',color:'#fff',border:'none',borderRadius:6,cursor:threadText.trim()?'pointer':'default',fontSize:12,height:36}}>↑</button>
        </div>
      </div>
    </div>}

    {/* New channel modal */}
    {showNewCh&&<Modal onClose={()=>setShowNewCh(false)}>
      <h3 style={{marginBottom:12}}>Новый канал</h3>
      <div style={{display:'flex',flexDirection:'column',gap:10}}>
        <div>
          <label style={{fontSize:11,color:'var(--text2)',display:'block',marginBottom:3}}>Название</label>
          <input value={newChName} onChange={e=>setNewChName(e.target.value)} style={{width:'100%',background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:6,padding:'6px 10px',color:'var(--text)',fontSize:13}} placeholder="напр. маркетинг" autoFocus/>
        </div>
        <div>
          <label style={{fontSize:11,color:'var(--text2)',display:'block',marginBottom:3}}>Описание</label>
          <input value={newChDesc} onChange={e=>setNewChDesc(e.target.value)} style={{width:'100%',background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:6,padding:'6px 10px',color:'var(--text)',fontSize:13}} placeholder="Необязательно"/>
        </div>
        <div>
          <label style={{fontSize:11,color:'var(--text2)',display:'block',marginBottom:3}}>Тип</label>
          <select value={newChType} onChange={e=>setNewChType(e.target.value)} style={{width:'100%',background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:6,padding:'6px 10px',color:'var(--text)',fontSize:13}}>
            <option value="public">Публичный</option>
            <option value="private">Приватный</option>
          </select>
        </div>
        <div style={{display:'flex',gap:8,justifyContent:'flex-end'}}>
          <button onClick={()=>setShowNewCh(false)} style={{padding:'6px 14px',background:'var(--bg4)',color:'var(--text)',border:'none',borderRadius:6,cursor:'pointer',fontSize:12}}>Отмена</button>
          <button onClick={createChannel} disabled={!newChName.trim()} style={{padding:'6px 14px',background:newChName.trim()?'var(--accent)':'var(--bg4)',color:'#fff',border:'none',borderRadius:6,cursor:newChName.trim()?'pointer':'default',fontSize:12}}>Создать</button>
        </div>
      </div>
    </Modal>}

    {/* Overhead Request Form Modal — separate component */}
    {showOhRequestForm&&<OhRequestFormModal store={store} chatData={chatData} onClose={()=>setShowOhRequestForm(false)}/>}
  </div>;
}

/* ===== Supabase Config Modal ===== */
function SupabaseConfigModal({onConnect,onSkip}){
  const cfg=_getSbCfg();
  const [url,setUrl]=useState(cfg?cfg.url:'');
  const [key,setKey]=useState(cfg?cfg.key:'');
  const [testing,setTesting]=useState(false);
  const [err,setErr]=useState('');
  const doConnect=async()=>{
    if(!url.trim()||!key.trim()){setErr('Заполните оба поля');return;}
    setTesting(true);setErr('');
    try{
      const client=window.supabase.createClient(url.trim(),key.trim());
      const {data:row,error}=await client.from('app_data').select('id').eq('id',1).single();
      if(error)throw error;
      _saveSbCfg(url.trim(),key.trim());
      onConnect();
    }catch(e){
      setErr('Ошибка подключения: '+(e.message||e.details||'проверьте URL и ключ'));
    }
    setTesting(false);
  };
  return <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.7)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10000}}>
    <div style={{background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:16,padding:32,maxWidth:480,width:'100%',color:'var(--text)'}}>
      <h2 style={{fontSize:18,fontWeight:700,marginBottom:4}}>Подключение к Supabase</h2>
      <p style={{fontSize:12,color:'var(--text2)',marginBottom:20}}>Для работы с общей базой данных укажите реквизиты проекта Supabase. Без подключения данные хранятся только локально в браузере.</p>
      <div style={{marginBottom:12}}>
        <label style={{fontSize:11,color:'var(--text2)',display:'block',marginBottom:4}}>Supabase URL</label>
        <input value={url} onChange={e=>setUrl(e.target.value)} placeholder="https://xxxxx.supabase.co" style={{width:'100%',padding:'8px 12px',fontSize:13,borderRadius:8,border:'1px solid var(--border)',background:'var(--bg3)',color:'var(--text)'}}/>
      </div>
      <div style={{marginBottom:16}}>
        <label style={{fontSize:11,color:'var(--text2)',display:'block',marginBottom:4}}>Anon Key (публичный)</label>
        <input value={key} onChange={e=>setKey(e.target.value)} placeholder="eyJhbGciOi..." style={{width:'100%',padding:'8px 12px',fontSize:13,borderRadius:8,border:'1px solid var(--border)',background:'var(--bg3)',color:'var(--text)'}}/>
      </div>
      {err&&<div style={{color:'var(--red)',fontSize:11,marginBottom:10}}>{err}</div>}
      <div style={{display:'flex',gap:8}}>
        <button onClick={doConnect} disabled={testing} style={{flex:1,padding:'10px 0',borderRadius:8,background:'var(--accent)',color:'#fff',border:'none',cursor:'pointer',fontWeight:600,fontSize:13,opacity:testing?0.6:1}}>{testing?'Проверяю...':'Подключить'}</button>
        <button onClick={onSkip} style={{padding:'10px 16px',borderRadius:8,background:'var(--bg3)',color:'var(--text2)',border:'1px solid var(--border)',cursor:'pointer',fontSize:12}}>Работать локально</button>
      </div>
    </div>
  </div>;
}

function TestPage({store}) {
  const d = store.data || {};
  const projects = d.projects || [];
  const clients = d.clients || [];
  const persons = d.persons || [];
  let wp=0, wo=0, wt=0, totalH=0;
  projects.forEach(p => {
    if ((p.payments||[]).length) wp++;
    if ((p.project_overheads||[]).length) wo++;
    if ((p.time_entries||[]).length) { wt++; p.time_entries.forEach(t => totalH += (t.hours||0)); }
  });
  return <div style={{padding:24}}>
    <h2 style={{marginBottom:16}}>🧪 Тестовая страница</h2>
    <p style={{color:'var(--text2)',marginBottom:24}}>Эта страница добавлена для проверки процесса обновления кода без потери данных.</p>
    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:16,marginBottom:24}}>
      <div style={{background:'var(--bg3)',borderRadius:12,padding:16}}>
        <div style={{fontSize:28,fontWeight:800}}>{projects.length}</div>
        <div style={{fontSize:12,color:'var(--text2)'}}>Проектов</div>
      </div>
      <div style={{background:'var(--bg3)',borderRadius:12,padding:16}}>
        <div style={{fontSize:28,fontWeight:800}}>{clients.length}</div>
        <div style={{fontSize:12,color:'var(--text2)'}}>Клиентов</div>
      </div>
      <div style={{background:'var(--bg3)',borderRadius:12,padding:16}}>
        <div style={{fontSize:28,fontWeight:800}}>{persons.length}</div>
        <div style={{fontSize:12,color:'var(--text2)'}}>Сотрудников</div>
      </div>
      <div style={{background:'var(--bg3)',borderRadius:12,padding:16}}>
        <div style={{fontSize:28,fontWeight:800}}>{wp}</div>
        <div style={{fontSize:12,color:'var(--text2)'}}>С траншами</div>
      </div>
      <div style={{background:'var(--bg3)',borderRadius:12,padding:16}}>
        <div style={{fontSize:28,fontWeight:800}}>{wo}</div>
        <div style={{fontSize:12,color:'var(--text2)'}}>С накладными</div>
      </div>
      <div style={{background:'var(--bg3)',borderRadius:12,padding:16}}>
        <div style={{fontSize:28,fontWeight:800}}>{totalH.toFixed(0)}ч</div>
        <div style={{fontSize:12,color:'var(--text2)'}}>Часов трекинга</div>
      </div>
    </div>
    <div style={{background:'var(--bg3)',borderRadius:12,padding:16}}>
      <h3 style={{marginBottom:8}}>Статус синхронизации</h3>
      <p>Supabase: <strong>{store.sbStatus}</strong></p>
      <p>CODE_VERSION: <strong>{typeof CODE_VERSION!=='undefined'?CODE_VERSION:'не определён'}</strong></p>
      <p style={{marginTop:8,fontSize:12,color:'var(--text2)'}}>Если вы видите эту страницу и данные выше — обновление кода прошло успешно, данные на месте.</p>
    </div>
  </div>;
}

function LoginScreen({onLogin,store}){
  const [login,setLogin]=useState('');
  const [pwd,setPwd]=useState('');
  const [err,setErr]=useState('');
  const [loading,setLoading]=useState(false);
  const handleSubmit=async(e)=>{
    e.preventDefault();setErr('');setLoading(true);
    try{
      const user=await store.validateLogin(login.trim(),pwd);
      if(user){
        const session={user_id:user.id,login:user.login,name:user.name,role:user.role||_getUserRoles(user)[0],roles:_getUserRoles(user),person_id:user.person_id,login_time:new Date().toISOString()};
        sessionStorage.setItem('pp_auth_session',JSON.stringify(session));
        onLogin(session);
      } else {
        setErr('Неверный логин или пароль');
      }
    }catch(ex){setErr('Ошибка: '+ex.message);}
    setLoading(false);
  };
  return <div style={{position:'fixed',inset:0,display:'flex',alignItems:'center',justifyContent:'center',background:'linear-gradient(135deg,#0f0f23 0%,#1a1a3e 50%,#0f0f23 100%)',fontFamily:'-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif'}}>
    <form onSubmit={handleSubmit} style={{background:'rgba(255,255,255,0.05)',backdropFilter:'blur(20px)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:16,padding:'40px 36px',width:380,boxShadow:'0 20px 60px rgba(0,0,0,0.5)'}}>
      <div style={{textAlign:'center',marginBottom:28}}>
        <div style={{fontSize:28,fontWeight:700,color:'#fff',marginBottom:4}}>Portfolio System</div>
        <div style={{fontSize:13,color:'#8888aa'}}>Double Diamond — Paper Planes</div>
      </div>
      <div style={{marginBottom:16}}>
        <label style={{display:'block',fontSize:11,color:'#8888aa',marginBottom:4,textTransform:'uppercase',letterSpacing:1}}>Логин</label>
        <input value={login} onChange={e=>setLogin(e.target.value)} autoFocus placeholder="username" style={{width:'100%',padding:'10px 14px',background:'rgba(255,255,255,0.07)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:8,color:'#fff',fontSize:14,outline:'none',boxSizing:'border-box'}}/>
      </div>
      <div style={{marginBottom:20}}>
        <label style={{display:'block',fontSize:11,color:'#8888aa',marginBottom:4,textTransform:'uppercase',letterSpacing:1}}>Пароль</label>
        <input value={pwd} onChange={e=>setPwd(e.target.value)} type="password" placeholder="••••••" style={{width:'100%',padding:'10px 14px',background:'rgba(255,255,255,0.07)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:8,color:'#fff',fontSize:14,outline:'none',boxSizing:'border-box'}}/>
      </div>
      {err&&<div style={{color:'#ef4444',fontSize:12,marginBottom:12,padding:'8px 12px',background:'rgba(239,68,68,0.1)',borderRadius:6}}>{err}</div>}
      <button type="submit" disabled={loading||!login||!pwd} style={{width:'100%',padding:'11px 0',background:loading?'#555':'linear-gradient(135deg,#4361ee,#7c3aed)',color:'#fff',border:'none',borderRadius:8,fontSize:14,fontWeight:600,cursor:loading?'wait':'pointer',opacity:(loading||!login||!pwd)?0.6:1}}>{loading?'Вход...':'Войти'}</button>
    </form>
  </div>;
}

function App(){
  const store=useStore();
  const [session,setSession]=useState(()=>{try{return JSON.parse(sessionStorage.getItem('pp_auth_session'));}catch(e){return null;}});
  const handleLogin=(s)=>setSession(s);
  const handleLogout=()=>{sessionStorage.removeItem('pp_auth_session');setSession(null);};
  const [showNotifPanel,setShowNotifPanel]=useState(false);
  useEffect(()=>{window.__ppAPI={addRecs:(recs)=>store.addRecommendationsBatch(recs),getData:()=>store.data};},[store]);
  useEffect(()=>{
    const recs=store.data.recommendations||[];
    if(!recs.find(r=>r.title&&r.title.includes('Казахстан'))){
      store.addRecommendation({category:'finance',title:'Налоговый режим Казахстана — требует уточнения',description:'Для проектов с оплатами через Казахстан применяется отдельная форма налогообложения: 20% от прибыли проекта. Вопросы к проработке: 1) Как именно считать базу для 20% — от валовой прибыли или от чистой? 2) Применяется ли налог ко всей сумме контракта или только к прибыли? 3) Какие документы/акты необходимы для казахстанского налогового режима? 4) Нужно ли учитывать НДС Казахстана отдельно от российского? 5) Как корректно отразить двойное налогообложение (РФ + КЗ) в P&L? 6) Какие проекты подпадают — только с клиентами из КЗ, или любые с оплатой через КЗ? После уточнений — реализовать автоматический расчёт налога КЗ в FinMashina и P&L проектов.'});
    }
  },[]);
  const [showSbConfig,setShowSbConfig]=useState(false);
  const [page,_setPage]=useState(()=>localStorage.getItem('pp_page')||'dashboard');
  const setPage=(p)=>{localStorage.setItem('pp_page',p);_setPage(p);};
  const [selProjId,_setSelProjId]=useState(()=>localStorage.getItem('pp_selProjId')||null);
  const setSelProjId=(id)=>{if(id)localStorage.setItem('pp_selProjId',id);else localStorage.removeItem('pp_selProjId');_setSelProjId(id);};
  const [projFilters,setProjFilters]=useState({fWG:'',fType:'',fStat:'_active',fSeg:'',sortBy:'buffer'});
  const [projInitTab,setProjInitTab]=useState(null);
  const goProject=(id,initTab)=>{setSelProjId(id);setProjInitTab(initTab||null);setPage('project-detail');};
  const backToProjects=()=>{setSelProjId(null);setPage('projects');};
  const selProject=useMemo(()=>store.data.projects.find(p=>p.id===selProjId),[selProjId,store.data.projects]);

  const _sbDot={online:'#22c55e',saved:'#22c55e',saving:'#eab308',loading:'#0ea5e9',error:'#ef4444',offline:'#6b7280'};
  const _isLH=window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1';
  const _modeLabel=_isLH?' (локальный)':' (master)';
  const _sbLabel={online:'Online'+_modeLabel,saved:'Сохранено ✓',saving:'Сохраняю...',loading:'Загрузка...',error:'Ошибка',offline:'Локально'+_modeLabel};

  /* Loading screen while Supabase data loads */
  if(!store.sbLoaded) return <div style={{position:'fixed',inset:0,display:'flex',alignItems:'center',justifyContent:'center',background:'var(--bg)',color:'var(--text)',flexDirection:'column',gap:12}}>
    <div style={{width:40,height:40,border:'3px solid var(--border)',borderTopColor:'var(--accent)',borderRadius:'50%',animation:'spin .8s linear infinite'}}/>
    <div style={{fontSize:14}}>Загрузка из Supabase...</div>
    <style>{'@keyframes spin{to{transform:rotate(360deg)}}'}</style>
  </div>;

  /* Auth gate — after all hooks, before main render */
  const hasUsers=(store.data.users||[]).length>0;
  if(!session&&hasUsers) return <LoginScreen onLogin={handleLogin} store={store}/>;

  return <div className="app">
    <div className="sidebar">
      <div className="sidebar-header"><h1>Portfolio System</h1><p>Double Diamond</p></div>
      {NAV.map(n=><div key={n.id} className={`nav-item ${page===n.id||(page==='project-detail'&&n.id==='projects')?'active':''}`} onClick={()=>{setPage(n.id);setSelProjId(null);}}><span style={{width:18,textAlign:'center',fontSize:14}}>{n.icon}</span>{n.label}</div>)}
      {/* User info + Logout */}
      {session&&<div style={{position:'absolute',bottom:52,left:12,right:12,display:'flex',flexDirection:'column',gap:4}}>
        <div style={{fontSize:10,color:'#8888aa',padding:'0 2px',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}} title={session.name||session.login}>{(session.roles||[session.role]).includes('admin')?'👑':(session.roles||[session.role]).includes('partner')?'💎':(session.roles||[session.role]).includes('finance')?'💳':'👤'} {session.name||session.login}</div>
        {(()=>{
          const myNotifs=(store.data.notifications||[]).filter(n=>n.user_id===session.user_id);
          const unreadCount=myNotifs.filter(n=>!n.read).length;
          return <div onClick={()=>setShowNotifPanel(v=>!v)} style={{padding:'6px 10px',borderRadius:6,background:unreadCount>0?'rgba(99,102,241,0.15)':'rgba(255,255,255,0.05)',cursor:'pointer',display:'flex',alignItems:'center',gap:6,fontSize:11,color:unreadCount>0?'var(--accent2)':'#8888aa',border:'1px solid '+(unreadCount>0?'rgba(99,102,241,0.3)':'rgba(255,255,255,0.08)'),position:'relative'}}>
            <span>🔔</span>
            <span>Уведомления</span>
            {unreadCount>0&&<span style={{marginLeft:'auto',background:'var(--accent)',color:'#fff',borderRadius:10,padding:'1px 6px',fontSize:10,fontWeight:700,minWidth:16,textAlign:'center'}}>{unreadCount}</span>}
          </div>;
        })()}
        <div onClick={handleLogout} style={{padding:'6px 10px',borderRadius:6,background:'rgba(239,68,68,0.15)',cursor:'pointer',display:'flex',alignItems:'center',gap:6,fontSize:11,color:'#ef4444',border:'1px solid rgba(239,68,68,0.2)'}} onMouseOver={e=>e.currentTarget.style.background='rgba(239,68,68,0.25)'} onMouseOut={e=>e.currentTarget.style.background='rgba(239,68,68,0.15)'}>
          <span>🚪</span><span>Выход</span>
        </div>
      </div>}
      {/* Supabase status indicator */}
      <div onClick={()=>setShowSbConfig(true)} style={{position:'absolute',bottom:12,left:12,right:12,padding:'8px 10px',borderRadius:8,background:'rgba(255,255,255,0.05)',cursor:'pointer',display:'flex',alignItems:'center',gap:8,fontSize:11,color:'#b0b0cc'}}>
        <span style={{width:8,height:8,borderRadius:'50%',background:_sbDot[store.sbStatus]||'#6b7280',flexShrink:0}}/>
        <span>{_sbLabel[store.sbStatus]||store.sbStatus}</span>
      </div>
    </div>
    <div className="main">
      {page==='dashboard'&&<Dashboard store={store} goProject={goProject}/>}
      {page==='projects'&&<ProjectList store={store} goProject={goProject} filters={projFilters} setFilters={setProjFilters}/>}
      {page==='project-detail'&&selProject&&<ErrorBoundary><ProjectDetail project={selProject} store={store} onBack={backToProjects} initialTab={projInitTab} goProject={goProject}/></ErrorBoundary>}
      {page==='triage'&&<TriageView store={store} goProject={goProject}/>}
      {page==='people'&&<PeopleView store={store}/>}
      {page==='knowledge'&&<KnowledgeView store={store} goProject={goProject}/>}
    {page==='clients'&&<ClientsView store={store} goProject={goProject}/>}
      {page==='finance_machine'&&<ErrorBoundary><FinanceMachineView store={store} goProject={goProject}/></ErrorBoundary>}
      {page==='sales_marketing'&&<ErrorBoundary><SalesMarketingView store={store} goProject={goProject}/></ErrorBoundary>}
      {page==='chat'&&<ErrorBoundary><ChatView store={store}/></ErrorBoundary>}
      {page==='settings'&&<SettingsView store={store}/>}
      {page==='test'&&<TestPage store={store}/>}
    </div>
    {/* Notification panel */}
    {showNotifPanel&&session&&(()=>{
      const myNotifs=(store.data.notifications||[]).filter(n=>n.user_id===session.user_id).sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||''));
      const unread=myNotifs.filter(n=>!n.read);
      const allChannels2=[...(store.data.chat_channels||[{id:'general',name:'Общий'}]),...(store.data.projects||[]).filter(pp=>pp.status==='ACTIVE').map(pp=>({id:'proj_'+pp.id,name:pp.code||pp.name,type:'project',project_id:pp.id}))];
      const getChName=(chId)=>{const ch=allChannels2.find(c=>c.id===chId);return ch?(ch.type==='project'?'📁 '+(ch.name):'#'+ch.name):chId;};
      const fmtTime=(ts)=>{if(!ts)return '';const d=new Date(ts);const diff=Date.now()-d;if(diff<3600000)return Math.floor(diff/60000)+'м назад';if(diff<86400000)return Math.floor(diff/3600000)+'ч назад';return d.toLocaleDateString('ru',{day:'numeric',month:'short'})+' '+d.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});};
      return <div style={{position:'fixed',inset:0,zIndex:9998}} onClick={()=>setShowNotifPanel(false)}>
        <div onClick={e=>e.stopPropagation()} style={{position:'fixed',bottom:52,left:12,width:360,maxHeight:480,background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:12,boxShadow:'0 8px 32px rgba(0,0,0,.4)',display:'flex',flexDirection:'column',overflow:'hidden',zIndex:9999}}>
          <div style={{padding:'12px 16px',borderBottom:'1px solid var(--border)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
            <div style={{fontWeight:700,fontSize:14}}>🔔 Уведомления</div>
            <div style={{display:'flex',gap:6}}>
              {unread.length>0&&<button onClick={()=>store.markAllNotificationsRead(session.user_id)} style={{background:'var(--bg4)',border:'none',borderRadius:6,padding:'3px 8px',fontSize:10,color:'var(--accent2)',cursor:'pointer'}}>Прочитать все</button>}
              <button onClick={()=>setShowNotifPanel(false)} style={{background:'none',border:'none',color:'var(--text2)',cursor:'pointer',fontSize:16}}>×</button>
            </div>
          </div>
          <div style={{flex:1,overflowY:'auto',maxHeight:400}}>
            {myNotifs.length===0&&<div style={{padding:24,textAlign:'center',color:'var(--text2)',fontSize:13}}>Нет уведомлений</div>}
            {myNotifs.map(n=><div key={n.id} onClick={()=>{store.markNotificationRead(n.id);if(n.channel_id){setPage('chat');localStorage.setItem('pp_chatCh',n.channel_id);setShowNotifPanel(false);}}} style={{padding:'10px 16px',borderBottom:'1px solid var(--border)',cursor:'pointer',background:n.read?'transparent':'rgba(99,102,241,.06)',transition:'background .15s'}} onMouseOver={e=>{if(!n.read)e.currentTarget.style.background='rgba(99,102,241,.1)';}} onMouseOut={e=>{e.currentTarget.style.background=n.read?'transparent':'rgba(99,102,241,.06)';}}>
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4}}>
                {!n.read&&<span style={{width:6,height:6,borderRadius:'50%',background:'var(--accent)',flexShrink:0}}/>}
                <span style={{fontSize:11,fontWeight:600,color:'var(--text)'}}>{n.from_user_name||'?'}</span>
                <span style={{fontSize:10,color:'var(--text2)'}}>упомянул вас</span>
                <span style={{fontSize:9,color:'var(--text2)',marginLeft:'auto'}}>{fmtTime(n.created_at)}</span>
              </div>
              <div style={{fontSize:11,color:'var(--text2)',marginBottom:4,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{n.message_text||''}</div>
              <div style={{fontSize:9,color:'var(--accent2)'}}>{getChName(n.channel_id)}</div>
            </div>)}
          </div>
        </div>
      </div>;
    })()}
    {store.toast&&<div className="toast">{store.toast}</div>}
    {showSbConfig&&<SupabaseConfigModal onConnect={()=>{store.reconnectSb();setShowSbConfig(false);}} onSkip={()=>setShowSbConfig(false)}/>}
  </div>;
}

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
// Global API for automation
window.__ppAPI={addRecs:null};
</script>
</body>
</html>
